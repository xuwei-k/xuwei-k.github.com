<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>org/specs2/analysis/CompilerDependencyFinder.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> org.specs2
<span class="keyword">package</span> analysis

<span class="keyword">import</span> org.specs2.io.fs
<span class="keyword">import</span> scala.collection.mutable.<span class="delimiter">{</span>Map, HashMap<span class="delimiter">}</span>
<span class="keyword">import</span> scala.tools.nsc._
<span class="keyword">import</span> interactive._
<span class="keyword">import</span> io._
<span class="keyword">import</span> java.net.URLClassLoader
<span class="keyword">import</span> java.net.URLDecoder
<span class="keyword">import</span> reflect.<a href="../reflect/PackageName.scala.html#11887" title="object org.specs2.reflect.PackageName">PackageName</a>._

<span class="comment">/**
 * Implementation of the DependencyFinder trait using the compiler dependency analysis
 */</span>
<span class="keyword">trait</span> <a title="trait CompilerDependencyFinder extends java.lang.Object with org.specs2.analysis.DependencyFinder with ScalaObject" id="9834">CompilerDependencyFinder</a> <span title="ScalaObject" class="keyword">extends</span> <a href="DependencyFinder.scala.html#9849" title="org.specs2.analysis.DependencyFinder">DependencyFinder</a> <span class="delimiter">{</span>

  <span class="comment">/**
   * @return the class depending on the classes of a given package
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(packageName: String, sourceDir: String, targetDir: String)Seq[org.specs2.analysis.Dependency]" id="71966">getPackageDependents</a><span class="delimiter">(</span><a title="String" id="74741">packageName</a>: <span title="String">String</span>, <a title="String" id="74742">sourceDir</a>: <span title="String">String</span>, <a title="String" id="74743">targetDir</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Seq[org.specs2.analysis.Dependency]">Seq</span><span class="delimiter">[</span>Dependency<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="comment">// load all dependencies for this source directory (compiles all files)</span>
    <span class="keyword">val</span> <a title="scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies" id="74745">dependencies</a> = <a href="#71968" title="(sourceDir: String)scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies">sourceDependencies</a><span class="delimiter">(</span><a href="#74742" title="String">sourceDir</a><span class="delimiter">)</span>
    <span class="comment">// for each file in the package directory, get its dependencies</span>
    <a href="#71976" title="(packageName: String, sourceDir: String)scala.tools.nsc.io.PlainDirectory">packageDirectory</a><span class="delimiter">(</span><a href="#74741" title="String">packageName</a>, <a href="#74742" title="String">sourceDir</a><span class="delimiter">)</span>.<span title="=&gt; Iterator[scala.tools.nsc.io.PlainFile]">iterator</span>.<span title="(p: scala.tools.nsc.io.PlainFile =&gt; Boolean)Iterator[scala.tools.nsc.io.PlainFile]">filter</span><span class="delimiter">(</span><a href="#88982" title="scala.tools.nsc.io.PlainFile">_</a>.<span title="=&gt; String">path</span>.<span title="(x$1: java.lang.String)Boolean">endsWith</span><span class="delimiter">(</span><span title="java.lang.String(&quot;.scala&quot;)" class="string">&quot;.scala&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Seq[scala.tools.nsc.io.PlainFile]">toSeq</span> <span title="(f: scala.tools.nsc.io.PlainFile =&gt; scala.collection.GenTraversableOnce[org.specs2.analysis.Dependency])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[scala.tools.nsc.io.PlainFile],org.specs2.analysis.Dependency,Seq[org.specs2.analysis.Dependency]])Seq[org.specs2.analysis.Dependency]">flatMap</span> <span class="delimiter">{</span> <span class="delimiter">(</span>file: <span title="scala.tools.nsc.io.AbstractFile">AbstractFile</span><span class="delimiter">)</span> =&gt;
      <a href="#74745" title="scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies">dependencies</a>.<span title="(depth: Int, changed: scala.collection.Set[scala.tools.nsc.io.AbstractFile])scala.collection.Set[scala.tools.nsc.io.AbstractFile]">dependentFiles</span><span class="delimiter">(</span>depth = <span title="Int(1)" class="int">1</span>, <span title="(elems: scala.tools.nsc.io.AbstractFile*)scala.collection.immutable.Set[scala.tools.nsc.io.AbstractFile]">Set</span><span class="delimiter">(</span><a href="#89028" title="scala.tools.nsc.io.AbstractFile">file</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: scala.tools.nsc.io.AbstractFile =&gt; org.specs2.analysis.Dependency)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[scala.tools.nsc.io.AbstractFile],org.specs2.analysis.Dependency,scala.collection.Set[org.specs2.analysis.Dependency]])scala.collection.Set[org.specs2.analysis.Dependency]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,org.specs2.analysis.Dependency,scala.collection.Set[org.specs2.analysis.Dependency]]" class="delimiter">{</span> <a title="scala.tools.nsc.io.AbstractFile" id="89441">dependent</a> =&gt;
        <a href="Dependency.scala.html#67893" title="(file: scala.tools.nsc.io.AbstractFile, dependent: scala.tools.nsc.io.AbstractFile, sourceDir: String)org.specs2.analysis.Dependency">Dependency</a><span class="delimiter">(</span><a href="#89028" title="scala.tools.nsc.io.AbstractFile">file</a>, <a href="#89441" title="scala.tools.nsc.io.AbstractFile">dependent</a>, <a href="#74742" title="String">sourceDir</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return a seq of all scala files in the source directory
   */</span>
  <span class="keyword">def</span> <a title="(sourceDir: String)Seq[String]" id="71967">selectFiles</a><span class="delimiter">(</span><a title="String" id="89741">sourceDir</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../io/FileSystem.scala.html#10482" title="object org.specs2.io.fs">fs</a>.<a href="../io/FileSystem.scala.html#52495" title="(basePath: String, path: String, verbose: Boolean)Seq[String]">filePaths</a><span class="delimiter">(</span><a href="#89741" title="String">sourceDir</a>, <span title="java.lang.String(&quot;**/*.scala&quot;)" class="string">&quot;**/*.scala&quot;</span><span class="delimiter">)</span>

  <span class="comment">/** @return all the dependencies of source files in a given source directory by compiling them */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(sourceDir: String)scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies" id="71968">sourceDependencies</a><span class="delimiter">(</span><a title="String" id="74746">sourceDir</a>: <span title="String">String</span><span class="delimiter">)</span> =
    <span title="object scala.tools.nsc.io.NullPrintStream">NullPrintStream</span>.<span title="(body: =&gt; scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies)scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies">sinkingOutAndErr</span> <span class="delimiter">{</span>
      <a href="#71971" title="(sourceDir: String)scala.tools.nsc.interactive.SimpleBuildManager">buildManager</a><span class="delimiter">(</span><a href="#74746" title="String">sourceDir</a><span class="delimiter">)</span>.<span title="=&gt; scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal">compiler</span>.<span title="object scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis">dependencyAnalysis</span>.<span title="=&gt; scala.tools.nsc.interactive.SimpleBuildManager#BuilderGlobal#dependencyAnalysis#FileDependencies">dependencies</span>
    <span class="delimiter">}</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.collection.mutable.Map[String,scala.tools.nsc.interactive.SimpleBuildManager]" id="71970">managers</a>: <span title="scala.collection.mutable.Map[String,scala.tools.nsc.interactive.SimpleBuildManager]">Map</span><span class="delimiter">[</span>String, SimpleBuildManager<span class="delimiter">]</span> = <span title="()scala.collection.mutable.HashMap[String,scala.tools.nsc.interactive.SimpleBuildManager]" class="keyword">new</span> <span title="scala.collection.mutable.HashMap[String,scala.tools.nsc.interactive.SimpleBuildManager]">HashMap</span><span class="delimiter">[</span>String, SimpleBuildManager<span class="delimiter">]</span>.<span title="(d: String =&gt; scala.tools.nsc.interactive.SimpleBuildManager)scala.collection.mutable.Map[String,scala.tools.nsc.interactive.SimpleBuildManager]">withDefault</span> <span class="delimiter">{</span> <a title="String" id="90019">sourceDir</a> =&gt;
    <span class="keyword">val</span> <a title="scala.tools.nsc.interactive.SimpleBuildManager" id="90020">manager</a> = <span title="scala.tools.nsc.interactive.SimpleBuildManager" class="keyword">new</span> <span title="scala.tools.nsc.interactive.SimpleBuildManager">SimpleBuildManager</span><span class="delimiter">(</span><a href="#71972" title="=&gt; scala.tools.nsc.Settings">newSettings</a><span class="delimiter">)</span>
    <a href="#90020" title="scala.tools.nsc.interactive.SimpleBuildManager">manager</a>.<span title="(files: scala.collection.Set[scala.tools.nsc.io.AbstractFile])Unit">addSourceFiles</span><span class="delimiter">(</span><a href="#71967" title="(sourceDir: String)Seq[String]">selectFiles</a><span class="delimiter">(</span><a href="#90019" title="String">sourceDir</a><span class="delimiter">)</span>.<span title="(f: String =&gt; scala.tools.nsc.io.PlainFile)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],scala.tools.nsc.io.PlainFile,Seq[scala.tools.nsc.io.PlainFile]])Seq[scala.tools.nsc.io.PlainFile]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,scala.tools.nsc.io.PlainFile,Seq[scala.tools.nsc.io.PlainFile]]" class="delimiter">(</span><a title="String" id="90040">f</a> =&gt; <span title="scala.tools.nsc.io.PlainFile" class="keyword">new</span> <span title="scala.tools.nsc.io.PlainFile">PlainFile</span><span class="delimiter">(</span><a href="#90040" title="implicit scala.tools.nsc.io.Path.string2path : (s: String)scala.tools.nsc.io.Path">f</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[scala.tools.nsc.io.AbstractFile]">toSet</span><span class="delimiter">)</span>
    <a href="#71969" title="=&gt; scala.collection.mutable.Map[String,scala.tools.nsc.interactive.SimpleBuildManager]">managers</a>.<span title="(key: String, value: scala.tools.nsc.interactive.SimpleBuildManager)Option[scala.tools.nsc.interactive.SimpleBuildManager]">put</span><span class="delimiter">(</span><a href="#90019" title="String">sourceDir</a>, <a href="#90020" title="scala.tools.nsc.interactive.SimpleBuildManager">manager</a><span class="delimiter">)</span>
    <a href="#90020" title="scala.tools.nsc.interactive.SimpleBuildManager">manager</a>
  <span class="delimiter">}</span>
  <span class="comment">/**
   * @return a new `BuildManager` for scala files in a source directory
   * the managers are memoized per sourceDir
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(sourceDir: String)scala.tools.nsc.interactive.SimpleBuildManager" id="71971">buildManager</a><span class="delimiter">(</span><a title="String" id="74893">sourceDir</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="#71969" title="(key: String)scala.tools.nsc.interactive.SimpleBuildManager">managers</a><span class="delimiter">(</span><a href="#74893" title="String">sourceDir</a><span class="delimiter">)</span>

  <span class="comment">/**
   * @return a new Settings object for doing dependency analysis. It adds the current classpath and set-up a new directory for
   * adding the generated classes
   */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="scala.tools.nsc.Settings" id="71973">newSettings</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="scala.tools.nsc.Settings" id="72056">settings</a> = <span title="()scala.tools.nsc.Settings" class="keyword">new</span> <span title="scala.tools.nsc.Settings">Settings</span>

    <span class="comment">// the analysis output directory needs to be built before we run the analysis</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>.<span title="=&gt; settings.PathSetting">classpath</span>.<span title="(arg: settings.classpath.T)Unit">value</span>      = <a href="#71974" title="=&gt; Seq[String]">classPath</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span>java.io.<span title="object java.io.File">File</span>.<span title="java.lang.String">pathSeparator</span><span class="delimiter">)</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>.<span title="=&gt; settings.ChoiceSetting">make</span>.<span title="(arg: settings.make.T)Unit">value</span>           = <span title="java.lang.String(&quot;transitive&quot;)" class="string">&quot;transitive&quot;</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>.<span title="=&gt; settings.PhasesSetting">stopAfter</span>.<span title="(arg: settings.stopAfter.T)Unit">value</span>      = <span title="(xs: java.lang.String*)List[java.lang.String]">List</span><span class="delimiter">(</span><span title="java.lang.String(&quot;dependencyAnalysis&quot;)" class="string">&quot;dependencyAnalysis&quot;</span><span class="delimiter">)</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>.<span title="=&gt; settings.PhasesSetting">skip</span>.<span title="(arg: settings.skip.T)Unit">value</span>           = <span title="(xs: java.lang.String*)List[java.lang.String]">List</span><span class="delimiter">(</span><span title="java.lang.String(&quot;flatten&quot;)" class="string">&quot;flatten&quot;</span>, <span title="java.lang.String(&quot;liftcode&quot;)" class="string">&quot;liftcode&quot;</span>, <span title="java.lang.String(&quot;jvm&quot;)" class="string">&quot;jvm&quot;</span><span class="delimiter">)</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>.<span title="=&gt; settings.StringSetting">dependencyfile</span>.<span title="(arg: settings.dependencyfile.T)Unit">value</span> = <span title="java.lang.String(&quot;xxx/the dependency file must not be saved&quot;)" class="string">&quot;xxx/the dependency file must not be saved&quot;</span>
    <a href="#72056" title="scala.tools.nsc.Settings">settings</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @return the current classPath as used by the current application
   */</span>
  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Seq[String]" id="71975">classPath</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.lang.ClassLoader" id="73115">cl</a> = <span title="object java.lang.Thread">Thread</span>.<span title="()java.lang.Thread">currentThread</span>.<span title="()java.lang.ClassLoader">getContextClassLoader</span>
    <span title="Seq[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#73115" title="java.lang.ClassLoader">cl</a>.<span title="[T0]=&gt; Boolean">isInstanceOf</span><span title="Boolean" class="delimiter">[</span><span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.net.URLClassLoader" id="74057">ucl</a> = <a href="#73115" title="java.lang.ClassLoader">cl</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="java.net.URLClassLoader" class="delimiter">[</span><span title="java.net.URLClassLoader">URLClassLoader</span><span class="delimiter">]</span>
      <a href="#74057" title="java.net.URLClassLoader">ucl</a>.<span title="(xs: Array[java.net.URL])scala.collection.mutable.ArrayOps[java.net.URL]">getURLs</span>.<span title="(z: Seq[String])(op: (Seq[String], java.net.URL) =&gt; Seq[String])Seq[String]">foldLeft</span><span class="delimiter">(</span><span title="[A](elems: A*)Seq[A]">Seq</span><span title="(elems: String*)Seq[String]" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="delimiter">(</span><a title="Seq[String]" id="74535">res</a>, <a title="java.net.URL" id="74536">url</a><span class="delimiter">)</span> =&gt;
        <span title="Seq[String]" class="keyword">if</span> <span class="delimiter">(</span><a href="#74536" title="java.net.URL">url</a>.<span title="()java.lang.String">getProtocol</span>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><span title="java.lang.String(&quot;file&quot;)" class="string">&quot;file&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#74535" title="Seq[String]">res</a> <span title="(elem: String)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],String,Seq[String]])Seq[String]">:+</span> <span title="java.io.File" class="keyword">new</span> java.io.<span title="java.io.File">File</span><span class="delimiter">(</span><span title="object java.net.URLDecoder">URLDecoder</span>.<span title="(x$1: java.lang.String, x$2: java.lang.String)java.lang.String">decode</span><span class="delimiter">(</span><a href="#74536" title="java.net.URL">url</a>.<span title="()java.lang.String">getPath</span>, <span title="java.lang.String(&quot;UTF-8&quot;)" class="string">&quot;UTF-8&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="()java.io.File">getCanonicalFile</span>.<span title="()java.lang.String">getAbsolutePath</span>
        <span class="keyword">else</span>                                <a href="#74535" title="Seq[String]">res</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span title="[A](elems: A*)Seq[A]">Seq</span><span title="(elems: String*)Seq[String]" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="comment">/**
   * @return a new package directory object from a source directory and a package name
   */</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(packageName: String, sourceDir: String)scala.tools.nsc.io.PlainDirectory" id="71976">packageDirectory</a><span class="delimiter">(</span><a title="String" id="88732">packageName</a>: <span title="String">String</span>, <a title="String" id="88733">sourceDir</a>: <span title="String">String</span><span class="delimiter">)</span> =
    <span title="scala.tools.nsc.io.PlainDirectory" class="keyword">new</span> <span title="scala.tools.nsc.io.PlainDirectory">PlainDirectory</span><span class="delimiter">(</span><span title="scala.tools.nsc.io.Directory" class="keyword">new</span> <span title="scala.tools.nsc.io.Directory">Directory</span><span class="delimiter">(</span><span title="java.io.File" class="keyword">new</span> java.io.<span title="java.io.File">File</span><span class="delimiter">(</span><a href="#88733" title="String">sourceDir</a><span title="(x$1: Any)java.lang.String">+</span><a href="../reflect/PackageName.scala.html#71960" title="implicit org.specs2.reflect.PackageName.toPackageNameToDirectoryPath : (name: String)org.specs2.reflect.PackageName.PackageName">packageName</a>.<a href="../reflect/PackageName.scala.html#88956" title="=&gt; java.lang.String">toPath</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>