<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scala/tools/partest/nest/DiffPrint.java</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>

<span class="keyword">package</span> scala.tools.partest.nest;

<span class="keyword">import</span> java.io.*;
<span class="keyword">import</span> java.util.Vector;
<span class="keyword">import</span> java.util.Date;
//import com.objectspace.jgl.predicates.UnaryPredicate;

interface <a title="scala.tools.partest.nest.UnaryPredicate.type" id="50789">UnaryPredicate</a> <span class="delimiter">{</span>
  boolean execute<span class="delimiter">(</span>Object obj<span class="delimiter">)</span>;
<span class="delimiter">}</span>

/** A simple framework for printing change lists produced by &lt;code&gt;Diff&lt;/code&gt;.
    @see bmsi.util.Diff
    @author Stuart D. Gathman
    Copyright (C) 2000 Business Management Systems, Inc.
&lt;p&gt;
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 1, or (at your option)
    any later version.
&lt;p&gt;
    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.
&lt;p&gt;
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
 */
public <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.type" id="50792">DiffPrint</a> <span class="delimiter">{</span>
  /** A Base class for printing edit scripts produced by Diff.
      This class divides the change list into &quot;hunks&quot;, and calls
      &lt;code&gt;print_hunk&lt;/code&gt; for each hunk.  Various utility methods
      are provided as well.
   */
  public static <span class="keyword">abstract</span> <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.Base.type" id="1164607">Base</a> <span class="delimiter">{</span>
    <span class="keyword">protected</span> Base<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> a,Object<span class="delimiter">[</span><span class="delimiter">]</span> b, Writer w<span class="delimiter">)</span> <span class="delimiter">{</span>
      outfile = <span class="keyword">new</span> PrintWriter<span class="delimiter">(</span>w<span class="delimiter">)</span>;
      file0 = a;
      file1 = b;
    <span class="delimiter">}</span>
    /** Set to ignore certain kinds of lines when printing
	an edit script.  For example, ignoring blank lines or comments.
     */
    <span class="keyword">protected</span> <a href="#50789" title="scala.tools.partest.nest.UnaryPredicate">UnaryPredicate</a> <a title="scala.tools.partest.nest.UnaryPredicate" id="1164697">ignore</a> = <span class="keyword">null</span>;

    /** Set to the lines of the files being compared.
     */
    <span class="keyword">protected</span> Object<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="Array[Object]" id="1164698">file0</a>, file1;

    /** Divide SCRIPT into pieces by calling HUNKFUN and
       print each piece with PRINTFUN.
       Both functions take one arg, an edit script.

       PRINTFUN takes a subscript which belongs together (with a null
       link at the end) and prints it.  */
    public void <a title="(script: scala.tools.partest.nest.Diff.change)Unit" id="1164700">print_script</a><span class="delimiter">(</span><a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="scala.tools.partest.nest.Diff.change" id="1164719">script</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      Diff.change next = script;

      <span class="keyword">while</span> <span class="delimiter">(</span>next != <span class="keyword">null</span><span class="delimiter">)</span>
	<span class="delimiter">{</span>
	  Diff.change t, end;

	  /* Find a set of changes that belong together.  */
	  t = next;
	  end = hunkfun<span class="delimiter">(</span>next<span class="delimiter">)</span>;

	  /* Disconnect them from the rest of the changes,
	     making them a hunk, and remember the rest for next iteration.  */
	  next = end.link;
	  end.link = <span class="keyword">null</span>;
	  //if (DEBUG)
	  //  debug_script(t);

	  /* Print this hunk.  */
	  print_hunk<span class="delimiter">(</span>t<span class="delimiter">)</span>;

	  /* Reconnect the script so it will all be freed properly.  */
	  end.link = next;
	<span class="delimiter">}</span>
	outfile.flush<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    /** Called with the tail of the script
       and returns the last link that belongs together with the start
       of the tail. */

    <span class="keyword">protected</span> <a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="(hunk: scala.tools.partest.nest.Diff.change)scala.tools.partest.nest.Diff.change" id="1164701">hunkfun</a><span class="delimiter">(</span><a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="scala.tools.partest.nest.Diff.change" id="3426927">hunk</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> hunk;
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> int <a title="Int" id="1164702">first0</a>, last0, first1, last1, deletes, inserts;
    <span class="keyword">protected</span> PrintWriter <a title="java.io.PrintWriter" id="1164708">outfile</a>;

    /** Look at a hunk of edit script and report the range of lines in each file
      that it applies to.  HUNK is the start of the hunk, which is a chain
      of `struct change'.  The first and last line numbers of file 0 are stored
      in *FIRST0 and *LAST0, and likewise for file 1 in *FIRST1 and *LAST1.
      Note that these are internal line numbers that count from 0.

      If no lines from file 0 are deleted, then FIRST0 is LAST0+1.

      Also set *DELETES nonzero if any lines of file 0 are deleted
      and set *INSERTS nonzero if any lines of file 1 are inserted.
      If only ignorable lines are inserted or deleted, both are
      set to 0.  */

    <span class="keyword">protected</span> void <a title="(hunk: scala.tools.partest.nest.Diff.change)Unit" id="1164709">analyze_hunk</a><span class="delimiter">(</span><a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="scala.tools.partest.nest.Diff.change" id="3426928">hunk</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      int f0, l0 = <span class="int">0</span>, f1, l1 = <span class="int">0</span>, show_from = <span class="int">0</span>, show_to = <span class="int">0</span>;
      int i;
      Diff.change next;
      boolean nontrivial = <span class="delimiter">(</span>ignore == <span class="keyword">null</span><span class="delimiter">)</span>;

      show_from = show_to = <span class="int">0</span>;

      f0 = hunk.line0;
      f1 = hunk.line1;

      <span class="keyword">for</span> <span class="delimiter">(</span>next = hunk; next != <span class="keyword">null</span>; next = next.link<span class="delimiter">)</span>
	<span class="delimiter">{</span>
	  l0 = next.line0 + next.deleted - <span class="int">1</span>;
	  l1 = next.line1 + next.inserted - <span class="int">1</span>;
	  show_from += next.deleted;
	  show_to += next.inserted;
	  <span class="keyword">for</span> <span class="delimiter">(</span>i = next.line0; i &lt;= l0 &amp;&amp; ! nontrivial; i++<span class="delimiter">)</span>
	    <span class="keyword">if</span> <span class="delimiter">(</span>!ignore.execute<span class="delimiter">(</span>file0<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
	      nontrivial = <span class="keyword">true</span>;
	  <span class="keyword">for</span> <span class="delimiter">(</span>i = next.line1; i &lt;= l1 &amp;&amp; ! nontrivial; i++<span class="delimiter">)</span>
	    <span class="keyword">if</span> <span class="delimiter">(</span>!ignore.execute<span class="delimiter">(</span>file1<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
	      nontrivial = <span class="keyword">true</span>;
	<span class="delimiter">}</span>

      first0 = f0;
      last0 = l0;
      first1 = f1;
      last1 = l1;

      /* If all inserted or deleted lines are ignorable,
	 tell the caller to ignore this hunk.  */

      <span class="keyword">if</span> <span class="delimiter">(</span>!nontrivial<span class="delimiter">)</span>
	show_from = show_to = <span class="int">0</span>;

      deletes = show_from;
      inserts = show_to;
    <span class="delimiter">}</span>

    /** Print the script header which identifies the files compared. */
    <span class="keyword">protected</span> void <a title="(filea: String, fileb: String)Unit" id="1164710">print_header</a><span class="delimiter">(</span>String <a title="String" id="3426929">filea</a>, String <a title="String" id="3426930">fileb</a><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="delimiter">}</span>

    <span class="keyword">protected</span> <span class="keyword">abstract</span> void <a title="(hunk: scala.tools.partest.nest.Diff.change)Unit" id="1164711">print_hunk</a><span class="delimiter">(</span><a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="scala.tools.partest.nest.Diff.change" id="3426931">hunk</a><span class="delimiter">)</span>;

    <span class="keyword">protected</span> void <a title="(pre: String, linbuf: Any)Unit" id="1164712">print_1_line</a><span class="delimiter">(</span>String <a title="String" id="3426932">pre</a>,Object <a title="Any" id="3426933">linbuf</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      outfile.println<span class="delimiter">(</span>pre + linbuf.toString<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    /** Print a pair of line numbers with SEPCHAR, translated for file FILE.
       If the two numbers are identical, print just one number.

       Args A and B are internal line numbers.
       We print the translated (real) line numbers.  */

    <span class="keyword">protected</span> void <a title="(sepchar: Char, a: Int, b: Int)Unit" id="1164713">print_number_range</a> <span class="delimiter">(</span>char <a title="Char" id="3426934">sepchar</a>, int <a title="Int" id="3426935">a</a>, int <a title="Int" id="3426936">b</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      /* Note: we can have B &lt; A in the case of a range of no lines.
	 In this case, we should print the line number before the range,
	 which is B.  */
      <span class="keyword">if</span> <span class="delimiter">(</span>++b &gt; ++a<span class="delimiter">)</span>
	outfile.print<span class="delimiter">(</span><span class="string">&quot;&quot;</span> + a + sepchar + b<span class="delimiter">)</span>;
      <span class="keyword">else</span>
	outfile.print<span class="delimiter">(</span>b<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public static char <a title="(inserts: Int, deletes: Int)Char" id="1164721">change_letter</a><span class="delimiter">(</span>int <a title="Int" id="3426925">inserts</a>, int <a title="Int" id="3426926">deletes</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">if</span> <span class="delimiter">(</span>inserts == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span> <span class="char">'d'</span>;
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>deletes == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span> <span class="char">'a'</span>;
      <span class="keyword">else</span>
	<span class="keyword">return</span> <span class="char">'c'</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  /** Print a change list in the standard diff format.
   */
  public static <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.NormalPrint.type" id="1164610">NormalPrint</a> <span class="keyword">extends</span> Base <span class="delimiter">{</span>

    public NormalPrint<a href="#1164610" title="scala.tools.partest.nest.DiffPrint.NormalPrint" class="delimiter">(</a>Object<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="Array[Object]" id="1164716">a</a>,Object<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="Array[Object]" id="1164717">b</a>, Writer <a title="java.io.Writer" id="1164718">w</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">super</span><span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    /** Print a hunk of a normal diff.
       This is a contiguous portion of a complete edit script,
       describing changes in consecutive lines.  */

    <span class="keyword">protected</span> void <a title="(hunk: scala.tools.partest.nest.Diff.change)Unit" id="1164715">print_hunk</a> <span class="delimiter">(</span><a href="Diff.java.html#50780" title="scala.tools.partest.nest.Diff.type">Diff</a>.<a href="Diff.java.html#1164685" title="scala.tools.partest.nest.Diff.change">change</a> <a title="scala.tools.partest.nest.Diff.change" id="3426938">hunk</a><span class="delimiter">)</span> <span class="delimiter">{</span>

      /* Determine range of line numbers involved in each file.  */
      analyze_hunk<span class="delimiter">(</span>hunk<span class="delimiter">)</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>deletes == <span class="int">0</span> &amp;&amp; inserts == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span>;

      /* Print out the line number header for this hunk */
      print_number_range <span class="delimiter">(</span><span class="char">','</span>, first0, last0<span class="delimiter">)</span>;
      outfile.print<span class="delimiter">(</span>change_letter<span class="delimiter">(</span>inserts, deletes<span class="delimiter">)</span><span class="delimiter">)</span>;
      print_number_range <span class="delimiter">(</span><span class="char">','</span>, first1, last1<span class="delimiter">)</span>;
      outfile.println<span class="delimiter">(</span><span class="delimiter">)</span>;

      /* Print the lines that the first file has.  */
      <span class="keyword">if</span> <span class="delimiter">(</span>deletes != <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">for</span> <span class="delimiter">(</span>int i = first0; i &lt;= last0; i++<span class="delimiter">)</span>
	  print_1_line <span class="delimiter">(</span><span class="string">&quot;&lt; &quot;</span>, file0<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>;

      <span class="keyword">if</span> <span class="delimiter">(</span>inserts != <span class="int">0</span> &amp;&amp; deletes != <span class="int">0</span><span class="delimiter">)</span>
	outfile.println<span class="delimiter">(</span><span class="string">&quot;---&quot;</span><span class="delimiter">)</span>;

      /* Print the lines that the second file has.  */
      <span class="keyword">if</span> <span class="delimiter">(</span>inserts != <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">for</span> <span class="delimiter">(</span>int i = first1; i &lt;= last1; i++<span class="delimiter">)</span>
	  print_1_line <span class="delimiter">(</span><span class="string">&quot;&gt; &quot;</span>, file1<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  /** Prints an edit script in a format suitable for input to &lt;code&gt;ed&lt;/code&gt;.
      The edit script must be generated with the reverse option to
      be useful as actual &lt;code&gt;ed&lt;/code&gt; input.
   */
  public static <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.EdPrint.type" id="1164613">EdPrint</a> <span class="keyword">extends</span> Base <span class="delimiter">{</span>

    public EdPrint<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> a,Object<span class="delimiter">[</span><span class="delimiter">]</span> b, Writer w<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">super</span><span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    /** Print a hunk of an ed diff */
    <span class="keyword">protected</span> void print_hunk<span class="delimiter">(</span>Diff.change hunk<span class="delimiter">)</span> <span class="delimiter">{</span>

      /* Determine range of line numbers involved in each file.  */
      analyze_hunk <span class="delimiter">(</span>hunk<span class="delimiter">)</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>deletes == <span class="int">0</span> &amp;&amp; inserts == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span>;

      /* Print out the line number header for this hunk */
      print_number_range <span class="delimiter">(</span><span class="char">','</span>, first0, last0<span class="delimiter">)</span>;
      outfile.println<span class="delimiter">(</span>change_letter<span class="delimiter">(</span>inserts, deletes<span class="delimiter">)</span><span class="delimiter">)</span>;

      /* Print new/changed lines from second file, if needed */
      <span class="keyword">if</span> <span class="delimiter">(</span>inserts != <span class="int">0</span><span class="delimiter">)</span>
	<span class="delimiter">{</span>
	  boolean inserting = <span class="keyword">true</span>;
	  <span class="keyword">for</span> <span class="delimiter">(</span>int i = first1; i &lt;= last1; i++<span class="delimiter">)</span>
	    <span class="delimiter">{</span>
	      /* Resume the insert, if we stopped.  */
	      <span class="keyword">if</span> <span class="delimiter">(</span>! inserting<span class="delimiter">)</span>
		outfile.println<span class="delimiter">(</span>i - first1 + first0 + <span class="string">&quot;a&quot;</span><span class="delimiter">)</span>;
	      inserting = <span class="keyword">true</span>;

	      /* If the file's line is just a dot, it would confuse `ed'.
		 So output it with a double dot, and set the flag LEADING_DOT
		 so that we will output another ed-command later
		 to change the double dot into a single dot.  */

	      <span class="keyword">if</span> <span class="delimiter">(</span><span class="string">&quot;.&quot;</span>.equals<span class="delimiter">(</span>file1<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span>
		<span class="delimiter">{</span>
		  outfile.println<span class="delimiter">(</span><span class="string">&quot;..&quot;</span><span class="delimiter">)</span>;
		  outfile.println<span class="delimiter">(</span><span class="string">&quot;.&quot;</span><span class="delimiter">)</span>;
		  /* Now change that double dot to the desired single dot.  */
		  outfile.println<span class="delimiter">(</span>i - first1 + first0 + <span class="int">1</span> + <span class="string">&quot;s/^\\.\\././&quot;</span><span class="delimiter">)</span>;
		  inserting = <span class="keyword">false</span>;
		<span class="delimiter">}</span>
	      <span class="keyword">else</span>
		/* Line is not `.', so output it unmodified.  */
		print_1_line <span class="delimiter">(</span><span class="string">&quot;&quot;</span>, file1<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>;
	    <span class="delimiter">}</span>

	  /* End insert mode, if we are still in it.  */
	  <span class="keyword">if</span> <span class="delimiter">(</span>inserting<span class="delimiter">)</span>
	    outfile.println<span class="delimiter">(</span><span class="string">&quot;.&quot;</span><span class="delimiter">)</span>;
	<span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  /** Prints an edit script in context diff format.  This and its
    'unified' variation is used for source code patches.
   */
  public static <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.ContextPrint.type" id="1164616">ContextPrint</a> <span class="keyword">extends</span> Base <span class="delimiter">{</span>

    <span class="keyword">protected</span> int context = <span class="int">3</span>;

    public ContextPrint<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> a,Object<span class="delimiter">[</span><span class="delimiter">]</span> b, Writer w<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">super</span><span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> void print_context_label <span class="delimiter">(</span>String mark, File inf, String label<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">if</span> <span class="delimiter">(</span>label != <span class="keyword">null</span><span class="delimiter">)</span>
	outfile.println<span class="delimiter">(</span>mark + <span class="char">' '</span> + label<span class="delimiter">)</span>;
      <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>inf.lastModified<span class="delimiter">(</span><span class="delimiter">)</span> &gt; <span class="int">0</span><span class="delimiter">)</span>
        // FIXME: use DateFormat to get precise format needed.
	outfile.println<span class="delimiter">(</span>
	  mark + <span class="char">' '</span> + inf.getPath<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="char">'\t'</span> + <span class="keyword">new</span> Date<span class="delimiter">(</span>inf.lastModified<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
	<span class="delimiter">)</span>;
      <span class="keyword">else</span>
	/* Don't pretend that standard input is ancient.  */
	outfile.println<span class="delimiter">(</span>mark + <span class="char">' '</span> + inf.getPath<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public void print_header<span class="delimiter">(</span>String filea,String fileb<span class="delimiter">)</span> <span class="delimiter">{</span>
      print_context_label <span class="delimiter">(</span><span class="string">&quot;***&quot;</span>, <span class="keyword">new</span> File<span class="delimiter">(</span>filea<span class="delimiter">)</span>, filea<span class="delimiter">)</span>;
      print_context_label <span class="delimiter">(</span><span class="string">&quot;---&quot;</span>, <span class="keyword">new</span> File<span class="delimiter">(</span>fileb<span class="delimiter">)</span>, fileb<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    /** If function_regexp defined, search for start of function. */
    <span class="keyword">private</span> String find_function<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> lines, int start<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">return</span> <span class="keyword">null</span>;
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> void print_function<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> file,int start<span class="delimiter">)</span> <span class="delimiter">{</span>
      String function = find_function <span class="delimiter">(</span>file0, first0<span class="delimiter">)</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>function != <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	outfile.print<span class="delimiter">(</span><span class="string">&quot; &quot;</span><span class="delimiter">)</span>;
	outfile.print<span class="delimiter">(</span>
	  <span class="delimiter">(</span>function.length<span class="delimiter">(</span><span class="delimiter">)</span> &lt; <span class="int">40</span><span class="delimiter">)</span> ? function : function.substring<span class="delimiter">(</span><span class="int">0</span>,<span class="int">40</span><span class="delimiter">)</span>
	<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> void print_hunk<span class="delimiter">(</span>Diff.change hunk<span class="delimiter">)</span> <span class="delimiter">{</span>

      /* Determine range of line numbers involved in each file.  */

      analyze_hunk <span class="delimiter">(</span>hunk<span class="delimiter">)</span>;

      <span class="keyword">if</span> <span class="delimiter">(</span>deletes == <span class="int">0</span> &amp;&amp; inserts == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span>;

      /* Include a context's width before and after.  */

      first0 = Math.max<span class="delimiter">(</span>first0 - context, <span class="int">0</span><span class="delimiter">)</span>;
      first1 = Math.max<span class="delimiter">(</span>first1 - context, <span class="int">0</span><span class="delimiter">)</span>;
      last0 = Math.min<span class="delimiter">(</span>last0 + context, file0.length - <span class="int">1</span><span class="delimiter">)</span>;
      last1 = Math.min<span class="delimiter">(</span>last1 + context, file1.length - <span class="int">1</span><span class="delimiter">)</span>;


      outfile.print<span class="delimiter">(</span><span class="string">&quot;***************&quot;</span><span class="delimiter">)</span>;

      /* If we looked for and found a function this is part of,
	 include its name in the header of the diff section.  */
      print_function <span class="delimiter">(</span>file0, first0<span class="delimiter">)</span>;

      outfile.println<span class="delimiter">(</span><span class="delimiter">)</span>;
      outfile.print<span class="delimiter">(</span><span class="string">&quot;*** &quot;</span><span class="delimiter">)</span>;
      print_number_range <span class="delimiter">(</span><span class="char">','</span>, first0, last0<span class="delimiter">)</span>;
      outfile.println<span class="delimiter">(</span><span class="string">&quot; ****&quot;</span><span class="delimiter">)</span>;

      <span class="keyword">if</span> <span class="delimiter">(</span>deletes != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	Diff.change next = hunk;

	<span class="keyword">for</span> <span class="delimiter">(</span>int i = first0; i &lt;= last0; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
	  /* Skip past changes that apply (in file 0)
	     only to lines before line I.  */

	  <span class="keyword">while</span> <span class="delimiter">(</span>next != <span class="keyword">null</span> &amp;&amp; next.line0 + next.deleted &lt;= i<span class="delimiter">)</span>
	    next = next.link;

	  /* Compute the marking for line I.  */

	  String prefix = <span class="string">&quot; &quot;</span>;
	  <span class="keyword">if</span> <span class="delimiter">(</span>next != <span class="keyword">null</span> &amp;&amp; next.line0 &lt;= i<span class="delimiter">)</span>
	    /* The change NEXT covers this line.
	       If lines were inserted here in file 1, this is &quot;changed&quot;.
	       Otherwise it is &quot;deleted&quot;.  */
	    prefix = <span class="delimiter">(</span>next.inserted &gt; <span class="int">0</span><span class="delimiter">)</span> ? <span class="string">&quot;!&quot;</span> : <span class="string">&quot;-&quot;</span>;

	  print_1_line <span class="delimiter">(</span>prefix, file0<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>;
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>

      outfile.print<span class="delimiter">(</span><span class="string">&quot;--- &quot;</span><span class="delimiter">)</span>;
      print_number_range <span class="delimiter">(</span><span class="char">','</span>, first1, last1<span class="delimiter">)</span>;
      outfile.println<span class="delimiter">(</span><span class="string">&quot; ----&quot;</span><span class="delimiter">)</span>;

      <span class="keyword">if</span> <span class="delimiter">(</span>inserts != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	Diff.change next = hunk;

	<span class="keyword">for</span> <span class="delimiter">(</span>int i = first1; i &lt;= last1; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
	  /* Skip past changes that apply (in file 1)
	     only to lines before line I.  */

	  <span class="keyword">while</span> <span class="delimiter">(</span>next != <span class="keyword">null</span> &amp;&amp; next.line1 + next.inserted &lt;= i<span class="delimiter">)</span>
	    next = next.link;

	  /* Compute the marking for line I.  */

	  String prefix = <span class="string">&quot; &quot;</span>;
	  <span class="keyword">if</span> <span class="delimiter">(</span>next != <span class="keyword">null</span> &amp;&amp; next.line1 &lt;= i<span class="delimiter">)</span>
	    /* The change NEXT covers this line.
	       If lines were deleted here in file 0, this is &quot;changed&quot;.
	       Otherwise it is &quot;inserted&quot;.  */
	    prefix = <span class="delimiter">(</span>next.deleted &gt; <span class="int">0</span><span class="delimiter">)</span> ? <span class="string">&quot;!&quot;</span> : <span class="string">&quot;+&quot;</span>;

	  print_1_line <span class="delimiter">(</span>prefix, file1<span class="delimiter">[</span>i<span class="delimiter">]</span><span class="delimiter">)</span>;
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  /** Prints an edit script in context diff format.  This and its
    'unified' variation is used for source code patches.
   */
  public static <span class="keyword">class</span> <a title="scala.tools.partest.nest.DiffPrint.UnifiedPrint.type" id="1164619">UnifiedPrint</a> <span class="keyword">extends</span> ContextPrint <span class="delimiter">{</span>

    public UnifiedPrint<span class="delimiter">(</span>Object<span class="delimiter">[</span><span class="delimiter">]</span> a,Object<span class="delimiter">[</span><span class="delimiter">]</span> b, Writer w<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">super</span><span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    public void print_header<span class="delimiter">(</span>String filea,String fileb<span class="delimiter">)</span> <span class="delimiter">{</span>
      print_context_label <span class="delimiter">(</span><span class="string">&quot;---&quot;</span>, <span class="keyword">new</span> File<span class="delimiter">(</span>filea<span class="delimiter">)</span>, filea<span class="delimiter">)</span>;
      print_context_label <span class="delimiter">(</span><span class="string">&quot;+++&quot;</span>, <span class="keyword">new</span> File<span class="delimiter">(</span>fileb<span class="delimiter">)</span>, fileb<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="keyword">private</span> void print_number_range <span class="delimiter">(</span>int a, int b<span class="delimiter">)</span> <span class="delimiter">{</span>
      //translate_range (file, a, b, &amp;trans_a, &amp;trans_b);

      /* Note: we can have B &lt; A in the case of a range of no lines.
	 In this case, we should print the line number before the range,
	 which is B.  */
      <span class="keyword">if</span> <span class="delimiter">(</span>b &lt; a<span class="delimiter">)</span>
	outfile.print<span class="delimiter">(</span>b + <span class="string">&quot;,0&quot;</span><span class="delimiter">)</span>;
      <span class="keyword">else</span>
        <span class="keyword">super</span>.print_number_range<span class="delimiter">(</span><span class="char">','</span>,a,b<span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="keyword">protected</span> void print_hunk<span class="delimiter">(</span>Diff.change hunk<span class="delimiter">)</span> <span class="delimiter">{</span>
      /* Determine range of line numbers involved in each file.  */
      analyze_hunk <span class="delimiter">(</span>hunk<span class="delimiter">)</span>;

      <span class="keyword">if</span> <span class="delimiter">(</span>deletes == <span class="int">0</span> &amp;&amp; inserts == <span class="int">0</span><span class="delimiter">)</span>
	<span class="keyword">return</span>;

      /* Include a context's width before and after.  */

      first0 = Math.max<span class="delimiter">(</span>first0 - context, <span class="int">0</span><span class="delimiter">)</span>;
      first1 = Math.max<span class="delimiter">(</span>first1 - context, <span class="int">0</span><span class="delimiter">)</span>;
      last0 = Math.min<span class="delimiter">(</span>last0 + context, file0.length - <span class="int">1</span><span class="delimiter">)</span>;
      last1 = Math.min<span class="delimiter">(</span>last1 + context, file1.length - <span class="int">1</span><span class="delimiter">)</span>;



      outfile.print<span class="delimiter">(</span><span class="string">&quot;@@ -&quot;</span><span class="delimiter">)</span>;
      print_number_range <span class="delimiter">(</span>first0, last0<span class="delimiter">)</span>;
      outfile.print<span class="delimiter">(</span><span class="string">&quot; +&quot;</span><span class="delimiter">)</span>;
      print_number_range <span class="delimiter">(</span>first1, last1<span class="delimiter">)</span>;
      outfile.print<span class="delimiter">(</span><span class="string">&quot; @@&quot;</span><span class="delimiter">)</span>;

      /* If we looked for and found a function this is part of,
	 include its name in the header of the diff section.  */
      print_function<span class="delimiter">(</span>file0,first0<span class="delimiter">)</span>;

      outfile.println<span class="delimiter">(</span><span class="delimiter">)</span>;

      Diff.change next = hunk;
      int i = first0;
      int j = first1;

      <span class="keyword">while</span> <span class="delimiter">(</span>i &lt;= last0 || j &lt;= last1<span class="delimiter">)</span> <span class="delimiter">{</span>

	/* If the line isn't a difference, output the context from file 0. */

	<span class="keyword">if</span> <span class="delimiter">(</span>next == <span class="keyword">null</span> || i &lt; next.line0<span class="delimiter">)</span> <span class="delimiter">{</span>
	  outfile.print<span class="delimiter">(</span><span class="char">' '</span><span class="delimiter">)</span>;
	  print_1_line <span class="delimiter">(</span><span class="string">&quot;&quot;</span>, file0<span class="delimiter">[</span>i++<span class="delimiter">]</span><span class="delimiter">)</span>;
	  j++;
	<span class="delimiter">}</span>
	<span class="keyword">else</span> <span class="delimiter">{</span>
	  /* For each difference, first output the deleted part. */

	  int k = next.deleted;
	  <span class="keyword">while</span> <span class="delimiter">(</span>k-- &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    outfile.print<span class="delimiter">(</span><span class="char">'-'</span><span class="delimiter">)</span>;
	    print_1_line <span class="delimiter">(</span><span class="string">&quot;&quot;</span>, file0<span class="delimiter">[</span>i++<span class="delimiter">]</span><span class="delimiter">)</span>;
	  <span class="delimiter">}</span>

	  /* Then output the inserted part. */

	  k = next.inserted;
	  <span class="keyword">while</span> <span class="delimiter">(</span>k-- &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	    outfile.print<span class="delimiter">(</span><span class="char">'+'</span><span class="delimiter">)</span>;
	    print_1_line <span class="delimiter">(</span><span class="string">&quot;&quot;</span>, file1<span class="delimiter">[</span>j++<span class="delimiter">]</span><span class="delimiter">)</span>;
	  <span class="delimiter">}</span>

	  /* We're done with this hunk, so on to the next! */

	  next = next.link;
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>


  /** Read a text file into an array of String.  This provides basic diff
     functionality.  A more advanced diff utility will use specialized
     objects to represent the text lines, with options to, for example,
     convert sequences of whitespace to a single space for comparison
     purposes.
   */
  static String<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="(file: String)Array[String]" id="1164620">slurp</a><span class="delimiter">(</span>String <a title="String" id="3426942">file</a><span class="delimiter">)</span> throws IOException <span class="delimiter">{</span>
    BufferedReader rdr = <span class="keyword">new</span> BufferedReader<span class="delimiter">(</span><span class="keyword">new</span> FileReader<span class="delimiter">(</span>file<span class="delimiter">)</span><span class="delimiter">)</span>;
    Vector&lt;String&gt; s = <span class="keyword">new</span> Vector&lt;String&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
    <span class="keyword">for</span> <span class="delimiter">(</span>;;<span class="delimiter">)</span> <span class="delimiter">{</span>
      String line = rdr.readLine<span class="delimiter">(</span><span class="delimiter">)</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>line == <span class="keyword">null</span><span class="delimiter">)</span> break;
      s.addElement<span class="delimiter">(</span>line<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
    String<span class="delimiter">[</span><span class="delimiter">]</span> a = <span class="keyword">new</span> String<span class="delimiter">[</span>s.size<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">]</span>;
    s.copyInto<span class="delimiter">(</span>a<span class="delimiter">)</span>;
    <span class="keyword">return</span> a;
  <span class="delimiter">}</span>

  public static void <a title="(argv: Array[String])Unit" id="1164621">main</a><span class="delimiter">(</span>String<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="Array[String]" id="3426943">argv</a><span class="delimiter">)</span> throws IOException <span class="delimiter">{</span>
    String filea = argv<span class="delimiter">[</span>argv.length - <span class="int">2</span><span class="delimiter">]</span>;
    String fileb = argv<span class="delimiter">[</span>argv.length - <span class="int">1</span><span class="delimiter">]</span>;
    String<span class="delimiter">[</span><span class="delimiter">]</span> a = slurp<span class="delimiter">(</span>filea<span class="delimiter">)</span>;
    String<span class="delimiter">[</span><span class="delimiter">]</span> b = slurp<span class="delimiter">(</span>fileb<span class="delimiter">)</span>;
    Diff d = <span class="keyword">new</span> Diff<span class="delimiter">(</span>a,b<span class="delimiter">)</span>;
    char style = <span class="char">'n'</span>;
    <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; argv.length - <span class="int">2</span>; ++i<span class="delimiter">)</span> <span class="delimiter">{</span>
      String f = argv<span class="delimiter">[</span>i<span class="delimiter">]</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>f.startsWith<span class="delimiter">(</span><span class="string">&quot;-&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span>int j = <span class="int">1</span>; j &lt; f.length<span class="delimiter">(</span><span class="delimiter">)</span>; ++j<span class="delimiter">)</span> <span class="delimiter">{</span>
	  switch <span class="delimiter">(</span>f.charAt<span class="delimiter">(</span>j<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <span class="keyword">case</span> <span class="char">'e'</span>:	// Ed style
	    style = <span class="char">'e'</span>; break;
	  <span class="keyword">case</span> <span class="char">'c'</span>:	// Context diff
	    style = <span class="char">'c'</span>; break;
	  <span class="keyword">case</span> <span class="char">'u'</span>:
	    style = <span class="char">'u'</span>; break;
	  <span class="delimiter">}</span>
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    boolean reverse = style == <span class="char">'e'</span>;
    Diff.change script = d.diff_2<span class="delimiter">(</span>reverse<span class="delimiter">)</span>;
    <span class="keyword">if</span> <span class="delimiter">(</span>script == <span class="keyword">null</span><span class="delimiter">)</span>
      System.err.println<span class="delimiter">(</span><span class="string">&quot;No differences&quot;</span><span class="delimiter">)</span>;
    <span class="keyword">else</span> <span class="delimiter">{</span>
      Base p;
      Writer w = <span class="keyword">new</span> OutputStreamWriter<span class="delimiter">(</span>System.out<span class="delimiter">)</span>;
      switch <span class="delimiter">(</span>style<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span class="char">'e'</span>:
        p = <span class="keyword">new</span> EdPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      <span class="keyword">case</span> <span class="char">'c'</span>:
        p = <span class="keyword">new</span> ContextPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      <span class="keyword">case</span> <span class="char">'u'</span>:
        p = <span class="keyword">new</span> UnifiedPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      default:
        p = <span class="keyword">new</span> NormalPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
      p.print_header<span class="delimiter">(</span>filea,fileb<span class="delimiter">)</span>;
      p.print_script<span class="delimiter">(</span>script<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  public static void <a title="(argv: Array[String], w: java.io.Writer)Unit" id="1164622">doDiff</a><span class="delimiter">(</span>String<span class="delimiter">[</span><a href="../../../Array.scala.html#174" title="Array" class="delimiter">]</a> <a title="Array[String]" id="1164623">argv</a>, Writer <a title="java.io.Writer" id="1164624">w</a><span class="delimiter">)</span> throws IOException <span class="delimiter">{</span>
    String filea = argv<span class="delimiter">[</span>argv.length - <span class="int">2</span><span class="delimiter">]</span>;
    String fileb = argv<span class="delimiter">[</span>argv.length - <span class="int">1</span><span class="delimiter">]</span>;
    String<span class="delimiter">[</span><span class="delimiter">]</span> a = slurp<span class="delimiter">(</span>filea<span class="delimiter">)</span>;
    String<span class="delimiter">[</span><span class="delimiter">]</span> b = slurp<span class="delimiter">(</span>fileb<span class="delimiter">)</span>;
    Diff d = <span class="keyword">new</span> Diff<span class="delimiter">(</span>a,b<span class="delimiter">)</span>;
    char style = <span class="char">'n'</span>;
    <span class="keyword">for</span> <span class="delimiter">(</span>int i = <span class="int">0</span>; i &lt; argv.length - <span class="int">2</span>; ++i<span class="delimiter">)</span> <span class="delimiter">{</span>
      String f = argv<span class="delimiter">[</span>i<span class="delimiter">]</span>;
      <span class="keyword">if</span> <span class="delimiter">(</span>f.startsWith<span class="delimiter">(</span><span class="string">&quot;-&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">for</span> <span class="delimiter">(</span>int j = <span class="int">1</span>; j &lt; f.length<span class="delimiter">(</span><span class="delimiter">)</span>; ++j<span class="delimiter">)</span> <span class="delimiter">{</span>
	  switch <span class="delimiter">(</span>f.charAt<span class="delimiter">(</span>j<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
	  <span class="keyword">case</span> <span class="char">'e'</span>:	// Ed style
	    style = <span class="char">'e'</span>; break;
	  <span class="keyword">case</span> <span class="char">'c'</span>:	// Context diff
	    style = <span class="char">'c'</span>; break;
	  <span class="keyword">case</span> <span class="char">'u'</span>:
	    style = <span class="char">'u'</span>; break;
	  <span class="delimiter">}</span>
	<span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    boolean reverse = style == <span class="char">'e'</span>;
    Diff.change script = d.diff_2<span class="delimiter">(</span>reverse<span class="delimiter">)</span>;
    <span class="keyword">if</span> <span class="delimiter">(</span>script == <span class="keyword">null</span><span class="delimiter">)</span>
      w.write<span class="delimiter">(</span><span class="string">&quot;No differences\n&quot;</span><span class="delimiter">)</span>;
    <span class="keyword">else</span> <span class="delimiter">{</span>
      Base p;
      switch <span class="delimiter">(</span>style<span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span class="char">'e'</span>:
        p = <span class="keyword">new</span> EdPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      <span class="keyword">case</span> <span class="char">'c'</span>:
        p = <span class="keyword">new</span> ContextPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      <span class="keyword">case</span> <span class="char">'u'</span>:
        p = <span class="keyword">new</span> UnifiedPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>; break;
      default:
        p = <span class="keyword">new</span> NormalPrint<span class="delimiter">(</span>a,b,w<span class="delimiter">)</span>;
      <span class="delimiter">}</span>
      p.print_header<span class="delimiter">(</span>filea,fileb<span class="delimiter">)</span>;
      p.print_script<span class="delimiter">(</span>script<span class="delimiter">)</span>;
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>