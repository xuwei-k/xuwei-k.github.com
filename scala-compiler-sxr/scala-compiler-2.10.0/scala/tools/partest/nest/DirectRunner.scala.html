<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>scala/tools/partest/nest/DirectRunner.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
/* NEST (New Scala Test)
 * Copyright 2007-2013 LAMP/EPFL
 * @author Philipp Haller
 */

// $Id$

<span class="keyword">package</span> scala.tools.partest
<span class="keyword">package</span> nest

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> scala.util.<a href="../../../util/Properties.scala.html#7130" title="scala.util.Properties.type">Properties</a>.setProp
<span class="keyword">import</span> scala.tools.nsc.util.ScalaClassLoader
<span class="keyword">import</span> scala.tools.nsc.io.Path
<span class="keyword">import</span> scala.collection.<span class="delimiter">{</span> mutable, immutable <span class="delimiter">}</span>
<span class="keyword">import</span> java.util.concurrent._
<span class="keyword">import</span> scala.collection.convert.<a href="../../../collection/convert/package.scala.html#55319" title="=&gt; scala.collection.convert.DecorateAsJava with scala.collection.convert.DecorateAsScala">decorateAll</a>._

case <span class="keyword">class</span> <a title="class TestRunParams extends AnyRef with Product with Serializable" id="1164566">TestRunParams</a><a href="../../../Product.scala.html#186" title="Product" class="delimiter">(</a><span class="keyword">val</span> <a title="scala.tools.nsc.util.ScalaClassLoader" id="1164387">scalaCheckParentClassLoader</a>: <a href="../../nsc/util/ScalaClassLoader.scala.html#50233" title="scala.tools.nsc.util.ScalaClassLoader">ScalaClassLoader</a><span class="delimiter">)</span>

<span class="keyword">trait</span> <a title="trait DirectRunner extends Object" id="50806">DirectRunner</a> <a href="../../../Unit.scala.html#1515" title="Unit" class="delimiter">{</a>
  <span class="keyword">def</span> <a title="=&gt; scala.tools.partest.nest.FileManager" id="1150573">fileManager</a>: <a href="FileManager.scala.html#50818" title="scala.tools.partest.nest.FileManager">FileManager</a>

  <span class="keyword">import</span> <a href="../PartestDefaults.scala.html#50614" title="scala.tools.partest.PartestDefaults.type">PartestDefaults</a>.numThreads

  <span class="keyword">def</span> <a title="(arg: String)Boolean" id="1150575">denotesTestFile</a><span class="delimiter">(</span><a title="String" id="1163145">arg</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../../../reflect/io/Path.scala.html#531017" title="(path: String)scala.reflect.io.Path">Path</a><span class="delimiter">(</span><a href="#1163145" title="String">arg</a><span class="delimiter">)</span>.<a href="../../../reflect/io/Path.scala.html#530896" title="(ext: String, exts: String*)Boolean">hasExtension</a><span class="delimiter">(</span><span title="String(&quot;scala&quot;)" class="string">&quot;scala&quot;</span>, <span title="String(&quot;res&quot;)" class="string">&quot;res&quot;</span>, <span title="String(&quot;xml&quot;)" class="string">&quot;xml&quot;</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(arg: String)Boolean" id="1150576">denotesTestDir</a><span class="delimiter">(</span><a title="String" id="1163127">arg</a>: <span title="String">String</span><span class="delimiter">)</span>  = <a href="../../../reflect/io/Path.scala.html#531017" title="(path: String)scala.reflect.io.Path">Path</a><span class="delimiter">(</span><a href="#1163127" title="String">arg</a><span class="delimiter">)</span>.<a href="../../../reflect/io/Path.scala.html#530903" title="(f: scala.reflect.io.Directory =&gt; Boolean)Option[Boolean]">ifDirectory</a><span class="delimiter">(</span><a href="#1163139" title="scala.reflect.io.Directory">_</a>.<a href="../../../reflect/io/Directory.scala.html#531531" title="=&gt; Iterator[scala.reflect.io.File]">files</a>.<a href="../../../collection/TraversableOnce.scala.html#58191" title="=&gt; Boolean">nonEmpty</a><span class="delimiter">)</span> <a href="../../../Option.scala.html#62882" title="(p: Boolean =&gt; Boolean)Boolean">exists</a> <span class="delimiter">(</span><a title="Boolean" id="1163144">x</a> =&gt; <a href="#1163144" title="Boolean">x</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(arg: String)Boolean" id="1150577">denotesTestPath</a><span class="delimiter">(</span><a title="String" id="1163126">arg</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="#1150576" title="(arg: String)Boolean">denotesTestDir</a><span class="delimiter">(</span><a href="#1163126" title="String">arg</a><span class="delimiter">)</span> <a href="../../../Boolean.scala.html#57825" title="(x: Boolean)Boolean">||</a> <a href="#1150575" title="(arg: String)Boolean">denotesTestFile</a><span class="delimiter">(</span><a href="#1163126" title="String">arg</a><span class="delimiter">)</span>

  /** No duplicate, no empty directories, don't mess with this unless
   *  you like partest hangs.
   */
  <span class="keyword">def</span> <a title="[T](args: List[T])List[T]" id="1150578">onlyValidTestPaths</a><span class="delimiter">[</span><a title="" id="1150580">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="List[T]" id="1163098">args</a>: <a href="../../../collection/immutable/List.scala.html#11952" title="List[T]">List</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="../../../collection/immutable/List.scala.html#11952" title="List[T]">List</a><span class="delimiter">[</span>T<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#1163098" title="List[T]">args</a>.<a href="../../../collection/SeqLike.scala.html#58839" title="=&gt; List[T]">distinct</a> <a href="../../../collection/TraversableLike.scala.html#58073" title="(p: T =&gt; Boolean)List[T]">filter</a> <span class="delimiter">(</span><a title="T" id="1164229">arg</a> =&gt; <a href="#1150577" title="(arg: String)Boolean">denotesTestPath</a><span class="delimiter">(</span><span title="String(&quot;&quot;)" class="string">&quot;&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#1164229" title="T">arg</a><span class="delimiter">)</span> <a href="../../../Boolean.scala.html#57825" title="(x: Boolean)Boolean">||</a> <span class="delimiter">{</span>
      <a href="NestUI.scala.html#50828" title="scala.tools.partest.nest.NestUI.type">NestUI</a>.<a href="NestUI.scala.html#1147219" title="(msg: String)Unit">warning</a><span class="delimiter">(</span><a href="../../../Predef.scala.html#7604" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Discarding invalid test path '%s'\n&quot;</a> <a href="../../../collection/immutable/StringLike.scala.html#59882" title="(args: Any*)String">format</a> <a href="#1164229" title="T">arg</a><span class="delimiter">)</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="(_kindFiles: List[java.io.File], kind: String)scala.collection.immutable.Map[String,scala.tools.partest.TestState]" id="1150581">runTestsForFiles</a><span class="delimiter">(</span><a title="List[java.io.File]" id="1151160">_kindFiles</a>: <a href="../../../collection/immutable/List.scala.html#11952" title="List[java.io.File]">List</a><span class="delimiter">[</span>File<span class="delimiter">]</span>, <a title="String" id="1151161">kind</a>: <span title="String">String</span><span class="delimiter">)</span>: immutable.<a href="../../../collection/immutable/Map.scala.html#11241" title="scala.collection.immutable.Map[String,scala.tools.partest.TestState]">Map</a><span class="delimiter">[</span>String, TestState<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span title="System.type">System</span>.<span title="(x$1: String, x$2: String)String">setProperty</span><span class="delimiter">(</span><span title="String(&quot;line.separator&quot;)" class="string">&quot;line.separator&quot;</span>, <span title="String(&quot;\n&quot;)" class="string">&quot;\n&quot;</span><span class="delimiter">)</span>

    // @partest maintainer: we cannot create a fresh file manager here
    // since the FM must respect --buildpath and --classpath from the command line
    // for example, see how it's done in ReflectiveRunner
    //val consFM = new ConsoleFileManager
    //import consFM.{ latestCompFile, latestLibFile, latestPartestFile }
    <span class="keyword">val</span> <a title="java.io.File" id="1164245">latestCompFile</a>    = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>.<a href="FileManager.scala.html#1150600" title="=&gt; String">LATEST_COMP</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.File" id="1164246">latestReflectFile</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>.<a href="FileManager.scala.html#1150598" title="=&gt; String">LATEST_REFLECT</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.File" id="1164247">latestLibFile</a>     = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>.<a href="FileManager.scala.html#1150596" title="=&gt; String">LATEST_LIB</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.File" id="1164248">latestPartestFile</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>.<a href="FileManager.scala.html#1150602" title="=&gt; String">LATEST_PARTEST</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.File" id="1164249">latestActorsFile</a>  = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>.<a href="FileManager.scala.html#1150604" title="=&gt; String">LATEST_ACTORS</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.net.URL" id="1164250">scalacheckURL</a>     = <a href="PathSettings.scala.html#50838" title="scala.tools.partest.nest.PathSettings.type">PathSettings</a>.<a href="PathSettings.scala.html#1150806" title="=&gt; scala.tools.nsc.io.File">scalaCheck</a>.<a href="../../../reflect/io/Path.scala.html#530878" title="=&gt; java.net.URL">toURL</a>
    <span class="keyword">val</span> <a title="scala.tools.nsc.util.ScalaClassLoader.URLClassLoader" id="1164251">scalaCheckParentClassLoader</a> = <a href="../../nsc/util/ScalaClassLoader.scala.html#50234" title="scala.tools.nsc.util.ScalaClassLoader.type">ScalaClassLoader</a>.<a href="../../nsc/util/ScalaClassLoader.scala.html#594241" title="(urls: Seq[java.net.URL], parent: ClassLoader)scala.tools.nsc.util.ScalaClassLoader.URLClassLoader">fromURLs</a><span class="delimiter">(</span>
      <a href="#1164250" title="java.net.URL">scalacheckURL</a> <a href="../../../collection/immutable/List.scala.html#62685" title="(x: java.net.URL)List[java.net.URL]">::</a> <span class="delimiter">(</span><a href="../../../collection/immutable/List.scala.html#62451" title="(xs: java.io.File*)List[java.io.File]">List</a><span class="delimiter">(</span><a href="#1164245" title="java.io.File">latestCompFile</a>, <a href="#1164246" title="java.io.File">latestReflectFile</a>, <a href="#1164247" title="java.io.File">latestLibFile</a>, <a href="#1164249" title="java.io.File">latestActorsFile</a>, <a href="#1164248" title="java.io.File">latestPartestFile</a><span class="delimiter">)</span>.<a href="../../../collection/TraversableLike.scala.html#58063" title="(f: java.io.File =&gt; java.net.URL)(implicit bf: scala.collection.generic.CanBuildFrom[List[java.io.File],java.net.URL,List[java.net.URL]])List[java.net.URL]">map</a><a href="../../../collection/immutable/List.scala.html#62442" title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.List.Coll,java.net.URL,List[java.net.URL]]" class="delimiter">(</a><a href="#1164303" title="java.io.File">_</a>.<span title="()java.net.URI">toURI</span>.<span title="()java.net.URL">toURL</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="List[java.io.File]" id="1164252">kindFiles</a> = <a href="#1150578" title="(args: List[java.io.File])List[java.io.File]">onlyValidTestPaths</a><span class="delimiter">(</span><a href="#1151160" title="List[java.io.File]">_kindFiles</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.ExecutorService" id="1164253">pool</a>      = <span title="java.util.concurrent.Executors.type">Executors</span>.<span title="(x$1: Int)java.util.concurrent.ExecutorService">newFixedThreadPool</span><span class="delimiter">(</span><a href="../PartestDefaults.scala.html#1143296" title="=&gt; Int">numThreads</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.tools.partest.nest.RunnerManager" id="1164254">manager</a>   = <span title="scala.tools.partest.nest.RunnerManager" class="keyword">new</span> <a href="RunnerManager.scala.html#50875" title="scala.tools.partest.nest.RunnerManager">RunnerManager</a><span class="delimiter">(</span><a href="#1151161" title="String">kind</a>, <a href="#1150573" title="=&gt; scala.tools.partest.nest.FileManager">fileManager</a>, <a href="#1164566" title="(scalaCheckParentClassLoader: scala.tools.nsc.util.ScalaClassLoader)scala.tools.partest.nest.TestRunParams">TestRunParams</a><span class="delimiter">(</span><a href="#1164251" title="scala.tools.nsc.util.ScalaClassLoader.URLClassLoader">scalaCheckParentClassLoader</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="scala.collection.immutable.Map[java.io.File,java.util.concurrent.Future[scala.tools.partest.TestState]]" id="1164255">futures</a>   = <a href="#1164252" title="List[java.io.File]">kindFiles</a> <a href="../../../collection/TraversableLike.scala.html#58063" title="(f: java.io.File =&gt; (java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState]))(implicit bf: scala.collection.generic.CanBuildFrom[List[java.io.File],(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState]),List[(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState])]])List[(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState])]">map</a> <span class="delimiter">(</span><a title="java.io.File" id="1164406">f</a> =&gt; <a href="../../../Tuple2.scala.html#62849" title="(_1: java.io.File, _2: java.util.concurrent.Future[scala.tools.partest.TestState])(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState])" class="delimiter">(</a><a href="#1164406" title="java.io.File">f</a>, <a href="#1164253" title="java.util.concurrent.ExecutorService">pool</a> <span title="(x$1: java.util.concurrent.Callable[scala.tools.partest.TestState])java.util.concurrent.Future[scala.tools.partest.TestState]">submit</span> <a href="../package.scala.html#55899" title="(body: =&gt; scala.tools.partest.TestState)java.util.concurrent.Callable[scala.tools.partest.TestState]">callable</a><span class="delimiter">(</span><a href="#1164254" title="scala.tools.partest.nest.RunnerManager">manager</a> <a href="RunnerManager.scala.html#1164376" title="(testFile: java.io.File)scala.tools.partest.TestState">runTest</a> <a href="#1164406" title="java.io.File">f</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../collection/TraversableOnce.scala.html#58277" title="(implicit ev: &lt;:&lt;[(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState]),(java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState])])scala.collection.immutable.Map[java.io.File,java.util.concurrent.Future[scala.tools.partest.TestState]]">toMap</a>

    <a href="#1164253" title="java.util.concurrent.ExecutorService">pool</a>.<span title="()Unit">shutdown</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">try</span> <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="../../../Boolean.scala.html#57822" title="=&gt; Boolean">!</a><a href="#1164253" title="java.util.concurrent.ExecutorService">pool</a>.<span title="(x$1: Long, x$2: java.util.concurrent.TimeUnit)Boolean">awaitTermination</span><span class="delimiter">(</span><span title="Long(4L)" class="int">4</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(HOURS)">HOURS</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="NestUI.scala.html#50828" title="scala.tools.partest.nest.NestUI.type">NestUI</a>.<a href="NestUI.scala.html#1147219" title="(msg: String)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Thread pool timeout elapsed before all tests were complete!&quot;)" class="string">&quot;Thread pool timeout elapsed before all tests were complete!&quot;</span><span class="delimiter">)</span>
    <span class="keyword">catch</span> <span class="delimiter">{</span> <span class="keyword">case</span> <a title="Unit" id="1164474">t</a>: <span title="InterruptedException">InterruptedException</span> =&gt;
      <a href="NestUI.scala.html#50828" title="scala.tools.partest.nest.NestUI.type">NestUI</a>.<a href="NestUI.scala.html#1147219" title="(msg: String)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Thread pool was interrupted&quot;)" class="string">&quot;Thread pool was interrupted&quot;</span><span class="delimiter">)</span>
      <a href="#1164474" title="InterruptedException">t</a>.<span title="()Unit">printStackTrace</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a href="../../../Tuple2.scala.html#60635" title="java.io.File" id="1164499">file</a>, <a href="../../../Tuple2.scala.html#60637" title="java.util.concurrent.Future[scala.tools.partest.TestState]" id="1164500">future</a><span class="delimiter">)</span> &lt;- <a href="../../../collection/TraversableLike.scala.html#58063" title="(f: ((java.io.File, java.util.concurrent.Future[scala.tools.partest.TestState])) =&gt; (String, scala.tools.partest.TestState))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[java.io.File,java.util.concurrent.Future[scala.tools.partest.TestState]],(String, scala.tools.partest.TestState),scala.collection.immutable.Map[String,scala.tools.partest.TestState]])scala.collection.immutable.Map[String,scala.tools.partest.TestState]">futures</a><span class="delimiter">)</span> <span class="keyword">yield</span> <a href="#3376988" title="(x: (String, scala.tools.partest.TestState))(String, scala.tools.partest.TestState)" class="delimiter">{</a>
      <span class="keyword">val</span> <a title="scala.tools.partest.TestState" id="1164501">state</a> = <span title="scala.tools.partest.TestState" class="keyword">if</span> <span class="delimiter">(</span><a href="#1164500" title="java.util.concurrent.Future[scala.tools.partest.TestState]">future</a>.<span title="()Boolean">isCancelled</span><span class="delimiter">)</span> <a href="../package.scala.html#50946" title="scala.tools.partest.TestState.type">TestState</a>.<a href="../package.scala.html#1151265" title="=&gt; scala.tools.partest.TestState">Timeout</a> <span class="keyword">else</span> <a href="#1164500" title="java.util.concurrent.Future[scala.tools.partest.TestState]">future</a>.<span title="()scala.tools.partest.TestState">get</span>
      <a href="../../../Tuple2.scala.html#62849" title="(_1: String, _2: scala.tools.partest.TestState)(String, scala.tools.partest.TestState)" class="delimiter">(</a><a href="#1164499" title="java.io.File">file</a>.<span title="()String">getAbsolutePath</span>, <a href="#1164501" title="scala.tools.partest.TestState">state</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>