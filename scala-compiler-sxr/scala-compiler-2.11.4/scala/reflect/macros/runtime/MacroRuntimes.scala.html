<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>scala/reflect/macros/runtime/MacroRuntimes.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package scala.reflect.macros
package runtime

import scala.reflect.internal.<a href="../../internal/Flags.scala.html#scala.reflect.internal.Flags" title="scala.reflect.internal.Flags.type">Flags</a>._
import scala.reflect.runtime.ReflectionUtils

trait <a title="trait MacroRuntimes extends AnyRef with scala.reflect.macros.runtime.JavaReflectionRuntimes" id="scala.reflect.macros.runtime;MacroRuntimes">MacroRuntimes</a> extends <a href="JavaReflectionRuntimes.scala.html#scala.reflect.macros.runtime;JavaReflectionRuntimes" title="scala.reflect.macros.runtime.JavaReflectionRuntimes">JavaReflectionRuntimes</a> <span class="delimiter">{</span>
  self: scala.tools.nsc.typechecker.Analyzer =&gt;

  import <a href="../../../tools/nsc/typechecker/Analyzer.scala.html#scala.tools.nsc.typechecker;Analyzer.global" title="=&gt; scala.tools.nsc.Global">global</a>._
  import <a href="../../internal/Definitions.scala.html#scala.reflect.internal;Definitions.definitions" title="MacroRuntimes.this.global.definitions.type">definitions</a>._

  <span class="comment">/** Produces a function that can be used to invoke macro implementation for a given macro definition:
   *    1) Looks up macro implementation symbol in this universe.
   *    2) Loads its enclosing class from the macro classloader.
   *    3) Loads the companion of that enclosing class from the macro classloader.
   *    4) Resolves macro implementation within the loaded companion.
   *
   *  @return Requested runtime if macro implementation can be loaded successfully from either of the mirrors,
   *          `null` otherwise.
   */</span>
  def <a title="(expandee: MacroRuntimes.this.global.Tree)MacroRuntimes.this.MacroRuntime" id="scala.reflect.macros.runtime;MacroRuntimes.macroRuntime">macroRuntime</a><span class="delimiter">(</span><a title="MacroRuntimes.this.global.Tree" id="scala.reflect.macros.runtime;MacroRuntimes.macroRuntime.expandee">expandee</a>: <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree" title="MacroRuntimes.this.global.Tree">Tree</a><span class="delimiter">)</span>: <a href="../../../Function1.scala.html#scala;Function1" title="MacroRuntimes.this.MacroRuntime">MacroRuntime</a> = <a href="../../../tools/nsc/typechecker/AnalyzerPlugins.scala.html#scala.tools.nsc.typechecker;AnalyzerPlugins.pluginsMacroRuntime" title="(expandee: MacroRuntimes.this.global.Tree)MacroRuntimes.this.MacroRuntime">pluginsMacroRuntime</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.macroRuntime.expandee" title="MacroRuntimes.this.global.Tree">expandee</a><span class="delimiter">)</span>

  <span class="comment">/** Default implementation of `macroRuntime`.
   *  Can be overridden by analyzer plugins (see AnalyzerPlugins.pluginsMacroRuntime for more details)
   */</span>
  private val <a title="scala.collection.mutable.WeakHashMap[MacroRuntimes.this.global.Symbol,MacroRuntimes.this.MacroRuntime]" id="scala.reflect.macros.runtime;MacroRuntimes.macroRuntimesCache">macroRuntimesCache</a> = <a href="../../internal/SymbolTable.scala.html#scala.reflect.internal;SymbolTable.perRunCaches" title="MacroRuntimes.this.global.perRunCaches.type">perRunCaches</a>.<a href="../../internal/SymbolTable.scala.html#scala.reflect.internal;SymbolTable.perRunCaches.newWeakMap" title="[K, V]()scala.collection.mutable.WeakHashMap[K,V]">newWeakMap</a><span title="()scala.collection.mutable.WeakHashMap[MacroRuntimes.this.global.Symbol,MacroRuntimes.this.MacroRuntime]" class="delimiter">[</span><a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;Symbol" title="MacroRuntimes.this.global.Symbol">Symbol</a>, <a href="../../../Function1.scala.html#scala;Function1" title="MacroRuntimes.this.MacroRuntime">MacroRuntime</a><span class="delimiter">]</span>
  def <a title="(expandee: MacroRuntimes.this.global.Tree)MacroRuntimes.this.MacroRuntime" id="scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime">standardMacroRuntime</a><span class="delimiter">(</span><a title="MacroRuntimes.this.global.Tree" id="scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.expandee">expandee</a>: <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree" title="MacroRuntimes.this.global.Tree">Tree</a><span class="delimiter">)</span>: <a href="../../../Function1.scala.html#scala;Function1" title="MacroRuntimes.this.MacroRuntime">MacroRuntime</a> = <span class="delimiter">{</span>
    val <a title="MacroRuntimes.this.global.Symbol" id="scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef">macroDef</a> = <a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.expandee" title="MacroRuntimes.this.global.Tree">expandee</a>.<a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree.symbol" title="=&gt; MacroRuntimes.this.global.Symbol">symbol</a>
    <a href="../util/Traces.scala.html#scala.reflect.macros.util;Traces.macroLogVerbose" title="(msg: =&gt; Any)Unit">macroLogVerbose</a><span class="delimiter">(</span><a href="../../../StringContext.scala.html#scala;StringContext.s" title="(args: Any*)String">s</a>&quot;<span title="String(&quot;looking for macro implementation: &quot;)">looking for macro implementation: $</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef" title="MacroRuntimes.this.global.Symbol">macroDef</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
    if <span class="delimiter">(</span><a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros.fastTrack" title="=&gt; scala.tools.reflect.FastTrack[MacroRuntimes.this.type]">fastTrack</a> <a href="../../../tools/reflect/FastTrack.scala.html#scala.tools.reflect;FastTrack.contains" title="(symbol: MacroRuntimes.this.fastTrack.macros.global.Symbol)Boolean">contains</a> <a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef" title="MacroRuntimes.this.global.Symbol">macroDef</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../util/Traces.scala.html#scala.reflect.macros.util;Traces.macroLogVerbose" title="(msg: =&gt; Any)Unit">macroLogVerbose</a><span class="delimiter">(</span><span title="String(&quot;macro expansion is serviced by a fast track&quot;)" class="string">&quot;macro expansion is serviced by a fast track&quot;</span><span class="delimiter">)</span>
      <a href="../../../tools/reflect/FastTrack.scala.html#scala.tools.reflect;FastTrack.apply" title="(symbol: MacroRuntimes.this.fastTrack.macros.global.Symbol)MacroRuntimes.this.fastTrack.FastTrackEntry">fastTrack</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef" title="MacroRuntimes.this.global.Symbol">macroDef</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> else <span class="delimiter">{</span>
      <a href="#scala.reflect.macros.runtime;MacroRuntimes.macroRuntimesCache" title="=&gt; scala.collection.mutable.WeakHashMap[MacroRuntimes.this.global.Symbol,MacroRuntimes.this.MacroRuntime]">macroRuntimesCache</a>.<a href="../../../collection/mutable/MapLike.scala.html#scala.collection.mutable;MapLike.getOrElseUpdate" title="(key: MacroRuntimes.this.global.Symbol, op: =&gt; MacroRuntimes.this.MacroRuntime)MacroRuntimes.this.MacroRuntime">getOrElseUpdate</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef" title="MacroRuntimes.this.global.Symbol">macroDef</a>, new <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver" title="MacroRuntimes.this.MacroRuntimeResolver">MacroRuntimeResolver</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.standardMacroRuntime.macroDef" title="MacroRuntimes.this.global.Symbol">macroDef</a><span class="delimiter">)</span>.<a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime" title="()MacroRuntimes.this.MacroRuntime">resolveRuntime</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** Macro classloader that is used to resolve and run macro implementations.
   *  Loads classes from from -cp (aka the library classpath).
   *  Is also capable of detecting REPL and reusing its classloader.
   *
   *  When -Xmacro-jit is enabled, we sometimes fallback to on-the-fly compilation of macro implementations,
   *  which compiles implementations into a virtual directory (very much like REPL does) and then conjures
   *  a classloader mapped to that virtual directory.
   */</span>
  lazy val <a title="ClassLoader" id="scala.reflect.macros.runtime;MacroRuntimes.defaultMacroClassloader">defaultMacroClassloader</a>: <span title="ClassLoader">ClassLoader</span> = <a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros.findMacroClassLoader" title="()ClassLoader">findMacroClassLoader</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/** Abstracts away resolution of macro runtimes.
   */</span>
  type <a title="MacroRuntimes.this.MacroArgs =&gt; Any" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntime">MacroRuntime</a> = MacroArgs =&gt; Any
  class <a title="class MacroRuntimeResolver extends AnyRef with MacroRuntimes.this.JavaReflectionResolvers" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver">MacroRuntimeResolver</a><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver" title="MacroRuntimes.this.MacroRuntimeResolver" class="delimiter">(</a>val <a title="MacroRuntimes.this.global.Symbol" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.macroDef">macroDef</a>: <a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;Symbol" title="MacroRuntimes.this.global.Symbol">Symbol</a><span class="delimiter">)</span> extends <a href="JavaReflectionRuntimes.scala.html#scala.reflect.macros.runtime;JavaReflectionRuntimes;JavaReflectionResolvers" title="MacroRuntimes.this.JavaReflectionResolvers">JavaReflectionResolvers</a> <span class="delimiter">{</span>
    val <a title="MacroRuntimes.this.MacroImplBinding" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.binding">binding</a> = <a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros.loadMacroImplBinding" title="(macroDef: MacroRuntimes.this.global.Symbol)Option[MacroRuntimes.this.MacroImplBinding]">loadMacroImplBinding</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.macroDef" title="=&gt; MacroRuntimes.this.global.Symbol">macroDef</a><span class="delimiter">)</span>.<a href="../../../Option.scala.html#scala;Option.get" title="=&gt; MacroRuntimes.this.MacroImplBinding">get</a>
    val <a title="Boolean" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.isBundle">isBundle</a> = <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.binding" title="=&gt; MacroRuntimes.this.MacroImplBinding">binding</a>.<a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros;MacroImplBinding.isBundle" title="=&gt; Boolean">isBundle</a>
    val <a title="String" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.className">className</a> = <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.binding" title="=&gt; MacroRuntimes.this.MacroImplBinding">binding</a>.<a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros;MacroImplBinding.className" title="=&gt; String">className</a>
    val <a title="String" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.methName">methName</a> = <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.binding" title="=&gt; MacroRuntimes.this.MacroImplBinding">binding</a>.<a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros;MacroImplBinding.methName" title="=&gt; String">methName</a>

    def <a title="()MacroRuntimes.this.MacroRuntime" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime">resolveRuntime</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="../../../Function1.scala.html#scala;Function1" title="MacroRuntimes.this.MacroRuntime">MacroRuntime</a> = <span class="delimiter">{</span>
      if <span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.className" title="=&gt; String">className</a> <span title="(x$1: Any)Boolean">==</span> <a href="../../internal/Definitions.scala.html#scala.reflect.internal;Definitions;DefinitionsClass.Predef_???" title="=&gt; MacroRuntimes.this.global.TermSymbol">Predef_???</a>.<a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;Symbol.owner" title="=&gt; MacroRuntimes.this.global.Symbol">owner</a>.<a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;Symbol.javaClassName" title="=&gt; String">javaClassName</a> <a href="../../../Boolean.scala.html#scala;Boolean.&&" title="(x: Boolean)Boolean">&amp;&amp;</a> <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.methName" title="=&gt; String">methName</a> <span title="(x$1: Any)Boolean">==</span> <a href="../../internal/Definitions.scala.html#scala.reflect.internal;Definitions;DefinitionsClass.Predef_???" title="=&gt; MacroRuntimes.this.global.TermSymbol">Predef_???</a>.<a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;TermSymbol.name" title="=&gt; MacroRuntimes.this.global.TermName">name</a>.<a href="../../internal/Names.scala.html#scala.reflect.internal;Names;Name.encoded" title="=&gt; String">encoded</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a title="MacroRuntimes.this.MacroArgs" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime.$anonfun.args">args</a> =&gt; throw new <a href="AbortMacroException.scala.html#scala.reflect.macros.runtime;AbortMacroException" title="scala.reflect.macros.runtime.AbortMacroException">AbortMacroException</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime.$anonfun.args" title="MacroRuntimes.this.MacroArgs">args</a>.<a href="../../../tools/nsc/typechecker/Macros.scala.html#scala.tools.nsc.typechecker;Macros;MacroArgs.c" title="=&gt; MacroRuntimes.this.MacroContext">c</a>.<a href="../contexts/Enclosures.scala.html#scala.reflect.macros.contexts;Enclosures.enclosingPosition" title="=&gt; args.c.Position">enclosingPosition</a>, <span title="String(&quot;macro implementation is missing&quot;)" class="string">&quot;macro implementation is missing&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        try <span class="delimiter">{</span>
          <a href="../util/Traces.scala.html#scala.reflect.macros.util;Traces.macroLogVerbose" title="(msg: =&gt; Any)Unit">macroLogVerbose</a><span class="delimiter">(</span><a href="../../../StringContext.scala.html#scala;StringContext.s" title="(args: Any*)String">s</a>&quot;<span title="String(&quot;resolving macro implementation as &quot;)">resolving macro implementation as $</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.className" title="=&gt; String">className</a><span title="String(&quot;.&quot;)">.$</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.methName" title="=&gt; String">methName</a><span title="String(&quot; (isBundle = &quot;)"> (isBundle = $</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.isBundle" title="=&gt; Boolean">isBundle</a><span title="String(&quot;)&quot;)" class="string">)&quot;</span><span class="delimiter">)</span>
          <a href="../util/Traces.scala.html#scala.reflect.macros.util;Traces.macroLogVerbose" title="(msg: =&gt; Any)Unit">macroLogVerbose</a><span class="delimiter">(</span><a href="../../../StringContext.scala.html#scala;StringContext.s" title="(args: Any*)String">s</a>&quot;<span title="String(&quot;classloader is: &quot;)">classloader is: $</span><span class="delimiter">{</span><a href="../../runtime/ReflectionUtils.scala.html#scala.reflect.runtime.ReflectionUtils" title="scala.reflect.runtime.ReflectionUtils.type">ReflectionUtils</a>.<a href="../../runtime/ReflectionUtils.scala.html#scala.reflect.runtime.ReflectionUtils.show" title="(cl: ClassLoader)String">show</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.defaultMacroClassloader" title="=&gt; ClassLoader">defaultMacroClassloader</a><span class="delimiter">)</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
          <a href="JavaReflectionRuntimes.scala.html#scala.reflect.macros.runtime;JavaReflectionRuntimes;JavaReflectionResolvers.resolveJavaReflectionRuntime" title="(classLoader: ClassLoader)MacroRuntimes.this.MacroRuntime">resolveJavaReflectionRuntime</a><span class="delimiter">(</span><a href="#scala.reflect.macros.runtime;MacroRuntimes.defaultMacroClassloader" title="=&gt; ClassLoader">defaultMacroClassloader</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <a title="Exception" id="scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime.ex">ex</a>: <span title="Exception">Exception</span> =&gt;
            <a href="../util/Traces.scala.html#scala.reflect.macros.util;Traces.macroLogVerbose" title="(msg: =&gt; Any)Unit">macroLogVerbose</a><span class="delimiter">(</span><a href="../../../StringContext.scala.html#scala;StringContext.s" title="(args: Any*)String">s</a>&quot;<span title="String(&quot;macro runtime failed to load: &quot;)">macro runtime failed to load: $</span><span class="delimiter">{</span><a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.resolveRuntime.ex" title="Exception">ex</a>.<span title="()String">toString</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
            <a href="#scala.reflect.macros.runtime;MacroRuntimes;MacroRuntimeResolver.macroDef" title="=&gt; MacroRuntimes.this.global.Symbol">macroDef</a> <a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols;Symbol.setFlag" title="(mask: Long)MacroRuntimeResolver.this.macroDef.type">setFlag</a> <span title="Long(4294967296L)">IS_ERROR</span>
            null
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>
