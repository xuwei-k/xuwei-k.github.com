<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>scala/reflect/reify/phases/Metalevels.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package scala.reflect.reify
package phases

import scala.collection.<span class="delimiter">{</span> mutable <span class="delimiter">}</span>

trait <a title="trait Metalevels extends AnyRef" id="scala.reflect.reify.phases;Metalevels">Metalevels</a> <a href="../../../Unit.scala.html#scala;Unit" title="Unit" class="delimiter">{</a>
  self: Reifier =&gt;

  import <a href="../Reifier.scala.html#scala.reflect.reify;Reifier.global" title="=&gt; scala.tools.nsc.Global">global</a>._

  <span class="comment">/**
   *  Makes sense of cross-stage bindings.
   *
   *  ----------------
   *
   *  Analysis of cross-stage bindings becomes convenient if we introduce the notion of metalevels.
   *  Metalevel of a tree is a number that gets incremented every time you reify something and gets decremented when you splice something.
   *  Metalevel of a symbol is equal to the metalevel of its definition.
   *
   *  Example 1. Consider the following snippet:
   *
   *    reify {
   *      val x = 2             // metalevel of symbol x is 1, because it's declared inside reify
   *      val y = reify{x}      // metalevel of symbol y is 1, because it's declared inside reify
   *                            // metalevel of Ident(x) is 2, because it's inside two reifies
   *      y.splice              // metalevel of Ident(y) is 0, because it's inside a designator of a splice
   *    }
   *
   *  Cross-stage bindings are introduced when symbol.metalevel != curr_metalevel.
   *  Both bindings introduced in Example 1 are cross-stage.
   *
   *  Depending on what side of the inequality is greater, the following situations might occur:
   *
   *  1) symbol.metalevel &lt; curr_metalevel. In this case reifier will generate a free variable
   *  that captures both the name of the symbol (to be compiled successfully) and its value (to be run successfully).
   *  For example, x in Example 1 will be reified as follows: Ident(newFreeVar(&quot;x&quot;, IntTpe, x))
   *
   *  2) symbol.metalevel &gt; curr_metalevel. This leads to a metalevel breach that violates intuitive perception of splicing.
   *  As defined in macro spec, splicing takes a tree and inserts it into another tree - as simple as that.
   *  However, how exactly do we do that in the case of y.splice? In this very scenario we can use dataflow analysis and inline it,
   *  but what if y were a var, and what if it were calculated randomly at runtime?
   *
   *  This question has a genuinely simple answer. Sure, we cannot resolve such splices statically (i.e. during macro expansion of `reify`),
   *  but now we have runtime toolboxes, so noone stops us from picking up that reified tree and evaluating it at runtime
   *  (in fact, this is something that `Expr.splice` does transparently).
   *
   *  This is akin to early vs late binding dilemma.
   *  The prior is faster, plus, the latter (implemented with reflection) might not work because of visibility issues or might be not available on all platforms.
   *  But the latter still has its uses, so I'm allowing metalevel breaches, but introducing the -Xlog-runtime-evals to log them.
   *
   *  upd. We no longer do that. In case of a runaway `splice` inside a `reify`, one will get a static error.
   *  Why? Unfortunately, the cute idea of transparently converting between static and dynamic splices has failed.
   *  1) Runtime eval that services dynamic splices requires scala-compiler.jar, which might not be on library classpath
   *  2) Runtime eval incurs a severe performance penalty, so it'd better to be explicit about it
   *
   *  ----------------
   *
   *  As we can see, the only problem is the fact that lhs'es of `splice` can be code blocks that can capture variables from the outside.
   *  Code inside the lhs of an `splice` is not reified, while the code from the enclosing reify is.
   *
   *  Hence some bindings become cross-stage, which is not bad per se (in fact, some cross-stage bindings have sane semantics, as in the example above).
   *  However this affects freevars, since they are delicate inter-dimensional beings that refer to both current and next planes of existence.
   *  When splicing tears the fabric of the reality apart, some freevars have to go single-dimensional to retain their sanity.
   *
   *  Example 2. Consider the following snippet:
   *
   *    reify {
   *      val x = 2
   *      reify{x}.splice
   *    }
   *
   *  Since the result of the inner reify is wrapped in a splice, it won't be reified
   *  together with the other parts of the outer reify, but will be inserted into that result verbatim.
   *
   *  The inner reify produces an Expr[Int] that wraps Ident(freeVar(&quot;x&quot;, IntTpe, x)).
   *  However the freevar the reification points to will vanish when the compiler processes the outer reify.
   *  That's why we need to replace that freevar with a regular symbol that will point to reified x.
   *
   *  Example 3. Consider the following fragment:
   *
   *    reify {
   *      val x = 2
   *      val y = reify{x}
   *      y.splice
   *    }
   *
   *  In this case the inner reify doesn't appear next to splice, so it will be reified together with x.
   *  This means that no special processing is needed here.
   *
   *  Example 4. Consider the following fragment:
   *
   *    reify {
   *      val x = 2
   *      {
   *        val y = 2
   *        val z = reify{reify{x + y}}
   *        z.splice
   *      }.splice
   *    }
   *
   *  The reasoning from Example 2 still holds here - we do need to inline the freevar that refers to x.
   *  However, we must not touch anything inside the splice'd block, because it's not getting reified.
   */</span>
  val <a title="&lt;refinement of Metalevels.this.global.Transformer&gt; extends Metalevels.this.global.Transformer" id="scala.reflect.reify.phases;Metalevels.metalevels">metalevels</a> = new <a href="../../../tools/nsc/ast/Trees.scala.html#scala.tools.nsc.ast;Trees;Transformer" title="&lt;$anon: Metalevels.this.global.Transformer&gt; extends Metalevels.this.global.Transformer" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon">Transformer</a> <span class="delimiter">{</span>
    var <a title="Boolean" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.insideSplice_=">insideSplice</a> = false
    val <a title="scala.collection.mutable.Map[Metalevels.this.global.TermName,Metalevels.this.global.Tree]" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.inlineableBindings">inlineableBindings</a> = mutable.<a href="../../../collection/generic/GenMapFactory.scala.html#scala.collection.generic;GenMapFactory.apply" title="[A, B](elems: (A, B)*)scala.collection.mutable.Map[A,B]">Map</a><span title="(elems: (Metalevels.this.global.TermName, Metalevels.this.global.Tree)*)scala.collection.mutable.Map[Metalevels.this.global.TermName,Metalevels.this.global.Tree]" class="delimiter">[</span><a href="../../internal/Names.scala.html#scala.reflect.internal;Names;TermName" title="Metalevels.this.global.TermName">TermName</a>, <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree" title="Metalevels.this.global.Tree">Tree</a><span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>

    def <a title="[T](op: =&gt; T)T" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice">withinSplice</a><span class="delimiter">[</span><a title="" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="=&gt; T" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice.op">op</a>: =&gt; T<span class="delimiter">)</span> = <span class="delimiter">{</span>
      val <a title="Boolean" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice.old">old</a> = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.insideSplice_=" title="=&gt; Boolean">insideSplice</a>
      <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.insideSplice_=" title="(x$1: Boolean)Unit">insideSplice</a> = true
      try <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice.op" title="=&gt; T">op</a>
      finally <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.insideSplice_=" title="(x$1: Boolean)Unit">insideSplice</a> = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice.old" title="Boolean">old</a>
    <span class="delimiter">}</span>

    <span class="comment">// Q: here we deal with all sorts of reified trees. what about ReifiedType(_, _, _, _, _, _)?</span>
    <span class="comment">// A: nothing. reified trees give us problems because they sometimes create dimensional rifts as described above</span>
    <span class="comment">//    to the contrast, reified types (i.e. synthetic typetags materialized by Implicits.scala) always stay on the same metalevel as their enclosing code</span>
    override def <a title="(tree: Metalevels.this.global.Tree)Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform">transform</a><span class="delimiter">(</span><a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree">tree</a>: <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree" title="Metalevels.this.global.Tree">Tree</a><span class="delimiter">)</span>: <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree" title="Metalevels.this.global.Tree">Tree</a> = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a> match <span class="delimiter">{</span>
      case <a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.TreeSplice.unapply" title="(tree: Metalevels.this.global.Tree)Option[Metalevels.this.global.Tree]">TreeSplice</a><span class="delimiter">(</span><a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.ReifiedTree.unapply" title="(tree: Metalevels.this.global.Tree)Option[(Metalevels.this.global.Tree, Metalevels.this.global.Tree, Metalevels.this.SymbolTable, Metalevels.this.global.Tree, Metalevels.this.global.Type, Metalevels.this.global.Tree, Boolean)]">ReifiedTree</a><span class="delimiter">(</span><a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.universe">universe</a>, <a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.mirror">mirror</a>, <a title="Metalevels.this.SymbolTable" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab">symtab</a>, <a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.rtree">rtree</a>, <a title="Metalevels.this.global.Type" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tpe">tpe</a>, <a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.rtpe">rtpe</a>, <a title="Boolean" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.concrete">concrete</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><span title="String(&quot;entering inlineable splice: &quot;)" class="string">&quot;entering inlineable splice: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a><span class="delimiter">)</span>
        val inlinees = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab" title="Metalevels.this.SymbolTable">symtab</a>.<a href="../utils/SymbolTables.scala.html#scala.reflect.reify.utils;SymbolTables;SymbolTable.syms" title="=&gt; List[Metalevels.this.global.Symbol]">syms</a> <a href="../../../collection/TraversableLike.scala.html#scala.collection;TraversableLike.filter" title="List[Metalevels.this.global.Symbol]" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlinees">filter</a> <span class="delimiter">(</span><a href="Calculate.scala.html#scala.reflect.reify.phases;Calculate.RichCalculateSymbol" title="implicit scala.reflect.reify.phases.Calculate.RichCalculateSymbol : (sym: Metalevels.this.global.Symbol)Metalevels.this.RichCalculateSymbol">_</a>.<a href="Calculate.scala.html#scala.reflect.reify.phases;Calculate;RichCalculateSymbol.isLocalToReifee" title="=&gt; Boolean">isLocalToReifee</a><span class="delimiter">)</span>
        <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlinees" title="List[Metalevels.this.global.Symbol]">inlinees</a> <a href="../../../collection/immutable/List.scala.html#scala.collection.immutable;List.foreach" title="(f: Metalevels.this.global.Symbol =&gt; Unit)Unit">foreach</a> <span class="delimiter">(</span><span title="Metalevels.this.global.Symbol">inlinee</span> =&gt; <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab" title="Metalevels.this.SymbolTable">symtab</a>.<a href="../utils/SymbolTables.scala.html#scala.reflect.reify.utils;SymbolTables;SymbolTable.symAliases" title="(sym: Metalevels.this.global.Symbol)List[Metalevels.this.global.TermName]">symAliases</a><span class="delimiter">(</span><span title="Metalevels.this.global.Symbol">inlinee</span><span class="delimiter">)</span> <a href="../../../collection/immutable/List.scala.html#scala.collection.immutable;List.foreach" title="(f: Metalevels.this.global.TermName =&gt; Unit)Unit">foreach</a> <span class="delimiter">(</span><a title="Metalevels.this.global.TermName" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.$anonfun.$anonfun.alias">alias</a> =&gt; <a href="../../../collection/mutable/MapLike.scala.html#scala.collection.mutable;MapLike.update" title="(key: Metalevels.this.global.TermName, value: Metalevels.this.global.Tree)Unit">inlineableBindings</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.$anonfun.$anonfun.alias" title="Metalevels.this.global.TermName">alias</a><span class="delimiter">)</span> = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab" title="Metalevels.this.SymbolTable">symtab</a>.<a href="../utils/SymbolTables.scala.html#scala.reflect.reify.utils;SymbolTables;SymbolTable.symBinding" title="(sym: Metalevels.this.global.Symbol)Metalevels.this.global.Tree">symBinding</a><span class="delimiter">(</span><span title="Metalevels.this.global.Symbol">inlinee</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        val symtab1 = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab" title="Metalevels.this.SymbolTable">symtab</a> <a href="../utils/SymbolTables.scala.html#scala.reflect.reify.utils;SymbolTables;SymbolTable.--(d604bca617)" title="Metalevels.this.SymbolTable" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab1">--</a> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlinees" title="List[Metalevels.this.global.Symbol]">inlinees</a>
        if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><a href="../../../Predef.scala.html#scala.Predef.augmentString" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;trimmed %s inlineable free defs from its symbol table: %s&quot;</a>.<a href="../../../collection/immutable/StringLike.scala.html#scala.collection.immutable;StringLike.format" title="(args: Any*)String">format</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlinees" title="List[Metalevels.this.global.Symbol]">inlinees</a>.<a href="../../../collection/LinearSeqOptimized.scala.html#scala.collection;LinearSeqOptimized.length" title="=&gt; Int">length</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlinees" title="List[Metalevels.this.global.Symbol]">inlinees</a> <a href="../../../collection/immutable/List.scala.html#scala.collection.immutable;List.map" title="(f: Metalevels.this.global.Symbol =&gt; Metalevels.this.global.TermName)(implicit bf: scala.collection.generic.CanBuildFrom[List[Metalevels.this.global.Symbol],Metalevels.this.global.TermName,List[Metalevels.this.global.TermName]])List[Metalevels.this.global.TermName]">map</a> <span class="delimiter">(</span><span title="Metalevels.this.global.Symbol">inlinee</span> =&gt; <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab" title="Metalevels.this.SymbolTable">symtab</a>.<a href="../utils/SymbolTables.scala.html#scala.reflect.reify.utils;SymbolTables;SymbolTable.symName" title="(sym: Metalevels.this.global.Symbol)Metalevels.this.global.TermName">symName</a><span class="delimiter">(</span><span title="Metalevels.this.global.Symbol">inlinee</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../collection/TraversableOnce.scala.html#scala.collection;TraversableOnce.mkString(f5d728d244)" title="(sep: String)String">mkString</a><span class="delimiter">(</span><span title="String(&quot;, &quot;)" class="string">&quot;, &quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice" title="(op: =&gt; Metalevels.this.global.Tree)Metalevels.this.global.Tree">withinSplice</a> <span class="delimiter">{</span> super.<a href="../../api/Trees.scala.html#scala.reflect.api;Trees;Transformer.transform" title="(tree: Metalevels.this.global.Tree)Metalevels.this.global.Tree">transform</a><span class="delimiter">(</span><a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.TreeSplice.apply" title="(splicee: Metalevels.this.global.Tree)Metalevels.this.global.Tree">TreeSplice</a><span class="delimiter">(</span><a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.ReifiedTree.apply" title="(universe: Metalevels.this.global.Tree, mirror: Metalevels.this.global.Tree, symtab: Metalevels.this.SymbolTable, rtree: Metalevels.this.global.Tree, tpe: Metalevels.this.global.Type, rtpe: Metalevels.this.global.Tree, concrete: Boolean)Metalevels.this.global.Tree">ReifiedTree</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.universe" title="Metalevels.this.global.Tree">universe</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.mirror" title="Metalevels.this.global.Tree">mirror</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.symtab1" title="Metalevels.this.SymbolTable">symtab1</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.rtree" title="Metalevels.this.global.Tree">rtree</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tpe" title="Metalevels.this.global.Type">tpe</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.rtpe" title="Metalevels.this.global.Tree">rtpe</a>, <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.concrete" title="Boolean">concrete</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      case <a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.TreeSplice.unapply" title="(tree: Metalevels.this.global.Tree)Option[Metalevels.this.global.Tree]">TreeSplice</a><span class="delimiter">(</span><a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.splicee">splicee</a><span class="delimiter">)</span> =&gt;
        if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><span title="String(&quot;entering splice: &quot;)" class="string">&quot;entering splice: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.splicee" title="Metalevels.this.global.Tree">splicee</a><span class="delimiter">)</span>
        val breaches = <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.splicee" title="Metalevels.this.global.Tree">splicee</a> <a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;TreeContextApiImpl.filter" title="List[Metalevels.this.global.Tree]" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches">filter</a> <span class="delimiter">(</span><a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches.$anonfun.sub">sub</a> =&gt; <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches.$anonfun.sub" title="Metalevels.this.global.Tree">sub</a>.<a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree.hasSymbolField" title="=&gt; Boolean">hasSymbolField</a> <a href="../../../Boolean.scala.html#scala;Boolean.&&" title="(x: Boolean)Boolean">&amp;&amp;</a> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches.$anonfun.sub" title="Metalevels.this.global.Tree">sub</a>.<a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree.symbol" title="=&gt; Metalevels.this.global.Symbol">symbol</a> <span title="(x$1: Any)Boolean">!=</span> <a href="../../internal/Symbols.scala.html#scala.reflect.internal;Symbols.NoSymbol" title="=&gt; Metalevels.this.global.NoSymbol">NoSymbol</a> <a href="../../../Boolean.scala.html#scala;Boolean.&&" title="(x: Boolean)Boolean">&amp;&amp;</a> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches.$anonfun.sub" title="Metalevels.this.global.Tree">sub</a>.<a href="Calculate.scala.html#scala.reflect.reify.phases;Calculate.RichCalculateSymbol" title="implicit scala.reflect.reify.phases.Calculate.RichCalculateSymbol : (sym: Metalevels.this.global.Symbol)Metalevels.this.RichCalculateSymbol">symbol</a>.<a href="Calculate.scala.html#scala.reflect.reify.phases;Calculate;RichCalculateSymbol.metalevel" title="=&gt; Int">metalevel</a> <a href="../../../Int.scala.html#scala;Int.>(5f58a84eb3)" title="(x: Int)Boolean">&gt;</a> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        if <span class="delimiter">(</span><a href="../../../Boolean.scala.html#scala;Boolean.unary_!" title="=&gt; Boolean">!</a><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.insideSplice_=" title="=&gt; Boolean">insideSplice</a> <a href="../../../Boolean.scala.html#scala;Boolean.&&" title="(x: Boolean)Boolean">&amp;&amp;</a> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches" title="List[Metalevels.this.global.Tree]">breaches</a>.<a href="../../../collection/TraversableOnce.scala.html#scala.collection;TraversableOnce.nonEmpty" title="=&gt; Boolean">nonEmpty</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// we used to convert dynamic splices into runtime evals transparently, but we no longer do that</span>
          <span class="comment">// why? see comments above</span>
          <span class="comment">// if (settings.logRuntimeSplices.value) reporter.echo(tree.pos, &quot;this splice cannot be resolved statically&quot;)</span>
          <span class="comment">// withinSplice { super.transform(tree) }</span>
          if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><a href="../../../Predef.scala.html#scala.Predef.augmentString" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;metalevel breach in %s: %s&quot;</a>.<a href="../../../collection/immutable/StringLike.scala.html#scala.collection.immutable;StringLike.format" title="(args: Any*)String">format</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a>, <span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.breaches" title="List[Metalevels.this.global.Tree]">breaches</a> <a href="../../../collection/immutable/List.scala.html#scala.collection.immutable;List.map" title="(f: Metalevels.this.global.Tree =&gt; Metalevels.this.global.Symbol)(implicit bf: scala.collection.generic.CanBuildFrom[List[Metalevels.this.global.Tree],Metalevels.this.global.Symbol,List[Metalevels.this.global.Symbol]])List[Metalevels.this.global.Symbol]">map</a> <span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.$anonfun.x$2" title="Metalevels.this.global.Tree">_</a>.<a href="../../internal/Trees.scala.html#scala.reflect.internal;Trees;Tree.symbol" title="=&gt; Metalevels.this.global.Symbol">symbol</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="../../../collection/SeqLike.scala.html#scala.collection;SeqLike.distinct" title="=&gt; List[Metalevels.this.global.Symbol]">distinct</a> <a href="../../../collection/TraversableOnce.scala.html#scala.collection;TraversableOnce.mkString(f5d728d244)" title="(sep: String)String">mkString</a> <span title="String(&quot;, &quot;)" class="string">&quot;, &quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="../Errors.scala.html#scala.reflect.reify;Errors.CannotReifyRuntimeSplice" title="(tree: Metalevels.this.global.Tree)Nothing">CannotReifyRuntimeSplice</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> else <span class="delimiter">{</span>
          <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.withinSplice" title="(op: =&gt; Metalevels.this.global.Tree)Metalevels.this.global.Tree">withinSplice</a> <span class="delimiter">{</span> super.<a href="../../api/Trees.scala.html#scala.reflect.api;Trees;Transformer.transform" title="(tree: Metalevels.this.global.Tree)Metalevels.this.global.Tree">transform</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a><span class="delimiter">)</span> <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="comment">// todo. also inline usages of `inlineableBindings` in the symtab itself</span>
      <span class="comment">// e.g. a free$Foo can well use free$x, if Foo is path-dependent w.r.t x</span>
      <span class="comment">// FreeRef(_, _) check won't work, because metalevels of symbol table and body are different, hence, freerefs in symbol table look different from freerefs in body</span>
      case <a href="../utils/Extractors.scala.html#scala.reflect.reify.utils;Extractors.FreeRef.unapply" title="(tree: Metalevels.this.global.Tree)Option[(Metalevels.this.global.Tree, Metalevels.this.global.TermName)]">FreeRef</a><span class="delimiter">(</span>_, <a title="Metalevels.this.global.TermName" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.name">name</a><span class="delimiter">)</span> if <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.inlineableBindings" title="=&gt; scala.collection.mutable.Map[Metalevels.this.global.TermName,Metalevels.this.global.Tree]">inlineableBindings</a> <a href="../../../collection/MapLike.scala.html#scala.collection;MapLike.contains" title="(key: Metalevels.this.global.TermName)Boolean">contains</a> <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.name" title="Metalevels.this.global.TermName">name</a> =&gt;
        if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><a href="../../../Predef.scala.html#scala.Predef.augmentString" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;inlineable free ref: %s in %s&quot;</a>.<a href="../../../collection/immutable/StringLike.scala.html#scala.collection.immutable;StringLike.format" title="(args: Any*)String">format</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.name" title="Metalevels.this.global.TermName">name</a>, <a href="../../api/Printers.scala.html#scala.reflect.api;Printers.showRaw(6f64b10ccf)" title="(any: Any, printTypes: Metalevels.this.global.BooleanFlag, printIds: Metalevels.this.global.BooleanFlag, printOwners: Metalevels.this.global.BooleanFlag, printKinds: Metalevels.this.global.BooleanFlag, printMirrors: Metalevels.this.global.BooleanFlag, printPositions: Metalevels.this.global.BooleanFlag)String">showRaw</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        val <a title="Metalevels.this.global.Tree" id="scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlined">inlined</a> = <a href="Reify.scala.html#scala.reflect.reify.phases;Reify.reify" title="(reifee: Any)Metalevels.this.global.Tree">reify</a><span class="delimiter">(</span><a href="../../../collection/MapLike.scala.html#scala.collection;MapLike.apply" title="(key: Metalevels.this.global.TermName)Metalevels.this.global.Tree">inlineableBindings</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.name" title="Metalevels.this.global.TermName">name</a><span class="delimiter">)</span><span class="delimiter">)</span>
        if <span class="delimiter">(</span><a href="../utils/Utils.scala.html#scala.reflect.reify.utils;Utils.reifyDebug" title="=&gt; Boolean">reifyDebug</a><span class="delimiter">)</span> <a href="../../../Predef.scala.html#scala.Predef.println(b0c81b2e65)" title="(x: Any)Unit">println</a><span class="delimiter">(</span><a href="../../../Predef.scala.html#scala.Predef.augmentString" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;verdict: inlined as %s&quot;</a>.<a href="../../../collection/immutable/StringLike.scala.html#scala.collection.immutable;StringLike.format" title="(args: Any*)String">format</a><span class="delimiter">(</span><a href="../../api/Printers.scala.html#scala.reflect.api;Printers.showRaw(6f64b10ccf)" title="(any: Any, printTypes: Metalevels.this.global.BooleanFlag, printIds: Metalevels.this.global.BooleanFlag, printOwners: Metalevels.this.global.BooleanFlag, printKinds: Metalevels.this.global.BooleanFlag, printMirrors: Metalevels.this.global.BooleanFlag, printPositions: Metalevels.this.global.BooleanFlag)String">showRaw</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlined" title="Metalevels.this.global.Tree">inlined</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.inlined" title="Metalevels.this.global.Tree">inlined</a>
      case _ =&gt;
        super.<a href="../../api/Trees.scala.html#scala.reflect.api;Trees;Transformer.transform" title="(tree: Metalevels.this.global.Tree)Metalevels.this.global.Tree">transform</a><span class="delimiter">(</span><a href="#scala.reflect.reify.phases;Metalevels.metalevels;$anon.transform.tree" title="Metalevels.this.global.Tree">tree</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
