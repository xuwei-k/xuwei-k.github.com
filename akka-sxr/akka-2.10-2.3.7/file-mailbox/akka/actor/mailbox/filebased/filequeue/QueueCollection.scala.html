<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>file-mailbox/akka/actor/mailbox/filebased/filequeue/QueueCollection.scala</title>
        <script type="text/javascript" src="../../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright 2009 Twitter, Inc.
 * Copyright 2009 Robey Pointer &lt;robeypointer@gmail.com&gt;
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may
 * not use this file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

<span class="keyword">package</span> akka.actor.mailbox.filebased.filequeue

<span class="keyword">import</span> java.io.File
<span class="keyword">import</span> java.util.concurrent.CountDownLatch
<span class="keyword">import</span> scala.collection.mutable
<span class="keyword">import</span> akka.event.LoggingAdapter
<span class="keyword">import</span> akka.actor.mailbox.filebased.FileBasedMailboxSettings

<span class="keyword">class</span> <a title="class InaccessibleQueuePath extends Exception" id="akka.actor.mailbox.filebased.filequeue;InaccessibleQueuePath">InaccessibleQueuePath</a> <a href="#akka.actor.mailbox.filebased.filequeue;InaccessibleQueuePath" title="akka.actor.mailbox.filebased.filequeue.InaccessibleQueuePath" class="keyword">extends</a> <span title="Exception">Exception</span><span class="delimiter">(</span><span title="String(&quot;Inaccessible queue path: Must be a directory and writable&quot;)" class="string">&quot;Inaccessible queue path: Must be a directory and writable&quot;</span><span class="delimiter">)</span>
@deprecated<span class="delimiter">(</span><span class="string">&quot;durable mailboxes are superseded by akka-persistence&quot;</span>, <span class="string">&quot;2.3&quot;</span><span class="delimiter">)</span>
<span class="keyword">class</span> <a title="class QueueCollection extends AnyRef" id="akka.actor.mailbox.filebased.filequeue;QueueCollection">QueueCollection</a><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="akka.actor.mailbox.filebased.filequeue.QueueCollection" class="delimiter">(</a><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queueFolder">queueFolder</a>: <span title="String">String</span>, <a title="akka.actor.mailbox.filebased.FileBasedMailboxSettings" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.settings">settings</a>: <a href="../FileBasedMailboxSettings.scala.html#akka.actor.mailbox.filebased;FileBasedMailboxSettings" title="akka.actor.mailbox.filebased.FileBasedMailboxSettings">FileBasedMailboxSettings</a>, <a title="akka.event.LoggingAdapter" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.log">log</a>: <a href="../../../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter" title="akka.event.LoggingAdapter">LoggingAdapter</a><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.io.File" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.path">path</a> = <span title="java.io.File" class="keyword">new</span> <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queueFolder" title="String">queueFolder</a><span class="delimiter">)</span>

  <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()Boolean">isDirectory</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()Boolean">mkdirs</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()Boolean">isDirectory</span> <span title="(x: Boolean)Boolean">||</span> <span title="=&gt; Boolean">!</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()Boolean">canWrite</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="Nothing" class="keyword">throw</span> <span title="akka.actor.mailbox.filebased.filequeue.InaccessibleQueuePath" class="keyword">new</span> <a href="#akka.actor.mailbox.filebased.filequeue;InaccessibleQueuePath" title="akka.actor.mailbox.filebased.filequeue.InaccessibleQueuePath">InaccessibleQueuePath</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queues">queues</a> = <span title="()scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">HashMap</span><span class="delimiter">[</span>String, PersistentQueue<span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.fanout_queues">fanout_queues</a> = <span title="()scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]">HashMap</span><span class="delimiter">[</span>String, mutable.HashSet<span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">]</span>
  <span class="keyword">private</span> <span class="keyword">var</span> <a title="Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=">shuttingDown</a> = <span title="Boolean(false)" class="keyword">false</span>

  <span class="comment">// total items added since the server started up.</span>
  <span class="keyword">val</span> <a title="akka.actor.mailbox.filebased.filequeue.Counter" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.totalAdded">totalAdded</a> = <span title="akka.actor.mailbox.filebased.filequeue.Counter" class="keyword">new</span> <a href="Counter.scala.html#akka.actor.mailbox.filebased.filequeue;Counter" title="akka.actor.mailbox.filebased.filequeue.Counter">Counter</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">// hits/misses on removing items from the queue</span>
  <span class="keyword">val</span> <a title="akka.actor.mailbox.filebased.filequeue.Counter" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queueHits">queueHits</a> = <span title="akka.actor.mailbox.filebased.filequeue.Counter" class="keyword">new</span> <a href="Counter.scala.html#akka.actor.mailbox.filebased.filequeue;Counter" title="akka.actor.mailbox.filebased.filequeue.Counter">Counter</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="akka.actor.mailbox.filebased.filequeue.Counter" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queueMisses">queueMisses</a> = <span title="akka.actor.mailbox.filebased.filequeue.Counter" class="keyword">new</span> <a href="Counter.scala.html#akka.actor.mailbox.filebased.filequeue;Counter" title="akka.actor.mailbox.filebased.filequeue.Counter">Counter</a><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">// preload any queues</span>
  <span class="keyword">def</span> <a title="()Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.loadQueues">loadQueues</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()Array[String]">list</span><span title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]" class="delimiter">(</span><span class="delimiter">)</span> <span title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]">filter</span> <span class="delimiter">{</span> <a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.loadQueues.$anonfun.name">name</a> ⇒ <span title="=&gt; Boolean">!</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.loadQueues.$anonfun.name" title="String">name</a> <span title="(x$1: CharSequence)Boolean">contains</span> <span title="String(&quot;~~&quot;)" class="string">&quot;~~&quot;</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(f: String =&gt; Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue])(implicit bf: scala.collection.generic.CanBuildFrom[Array[String],Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue],Any])Any">map</span> <span class="delimiter">{</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.loadQueues.$anonfun.x$1" title="String">_</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; List[String]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queueNames">queueNames</a>: <span title="List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: List[String])List[String]">synchronized</a> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="=&gt; Iterable[String]">keys</span>.<span title="=&gt; List[String]">toList</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="=&gt; Long" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.currentItems">currentItems</a> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="=&gt; Iterable[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">values</span>.<span title="(z: Long)(op: (Long, akka.actor.mailbox.filebased.filequeue.PersistentQueue) =&gt; Long)Long">foldLeft</span><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.currentItems.$anonfun.x$2" title="Long">_</a> <span title="(x: Long)Long">+</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.currentItems.$anonfun.x$3" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">_</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.length" title="=&gt; Long">length</a> <span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="=&gt; Long" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.currentBytes">currentBytes</a> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="=&gt; Iterable[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">values</span>.<span title="(z: Long)(op: (Long, akka.actor.mailbox.filebased.filequeue.PersistentQueue) =&gt; Long)Long">foldLeft</span><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span> <span class="delimiter">{</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.currentBytes.$anonfun.x$4" title="Long">_</a> <span title="(x: Long)Long">+</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.currentBytes.$anonfun.x$5" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">_</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.bytes" title="=&gt; Long">bytes</a> <span class="delimiter">}</span>

  <span class="comment">/**
   * Get a named queue, creating it if necessary.
   * Exposed only to unit tests.
   */</span>
  <span class="keyword">private</span><span class="delimiter">[</span>akka<span class="delimiter">]</span> <span class="keyword">def</span> <a title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queue">queue</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">Option</span><span class="delimiter">[</span>PersistentQueue<span class="delimiter">]</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue])Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">synchronized</a> <span class="delimiter">{</span>
    <span title="Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=" title="=&gt; Boolean">shuttingDown</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="None.type">None</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span title="(x: akka.actor.mailbox.filebased.filequeue.PersistentQueue)Some[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">Some</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="(key: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">get</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a><span class="delimiter">)</span> <span title="(default: =&gt; akka.actor.mailbox.filebased.filequeue.PersistentQueue)akka.actor.mailbox.filebased.filequeue.PersistentQueue">getOrElse</span> <span class="delimiter">{</span>
        <span class="comment">// only happens when creating a queue for the first time.</span>
        <span class="keyword">val</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q">q</a> = <span title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">name</a> <span title="(elem: Any)Boolean">contains</span> <span title="Char('+')" class="char">'+'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q.master">master</a> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">name</a>.<span title="(separator: Char)Array[String]">split</span><span title="(i: Int)String" class="delimiter">(</span><span title="Char('+')" class="char">'+'</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.fanout_queues" title="=&gt; scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]">fanout_queues</a>.<span title="(key: String, op: =&gt; scala.collection.mutable.HashSet[String])scala.collection.mutable.HashSet[String]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q.master" title="String">master</a>, <span title="()scala.collection.mutable.HashSet[String]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashSet[String]">HashSet</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span title="(elem: String)scala.collection.mutable.HashSet[String]">+=</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.log" title="akka.event.LoggingAdapter">log</a>.<a href="../../../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.debug(2f488eb77c)" title="(template: String, arg1: Any, arg2: Any)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Fanout queue {} added to {}&quot;)" class="string">&quot;Fanout queue {} added to {}&quot;</span>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q.master" title="String">master</a><span class="delimiter">)</span>
          <span title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" class="keyword">new</span> <a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">PersistentQueue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()String">getPath</span>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.settings" title="akka.actor.mailbox.filebased.FileBasedMailboxSettings">settings</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.log" title="akka.event.LoggingAdapter">log</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <span title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" class="keyword">new</span> <a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">PersistentQueue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.path" title="=&gt; java.io.File">path</a>.<span title="()String">getPath</span>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.settings" title="akka.actor.mailbox.filebased.FileBasedMailboxSettings">settings</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.log" title="akka.event.LoggingAdapter">log</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.setup" title="()Unit">setup</a>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="(key: String, value: akka.actor.mailbox.filebased.filequeue.PersistentQueue)Unit">queues</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.name" title="String">name</a><span class="delimiter">)</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Add an item to a named queue. Will not return until the item has been
   * synchronously added and written to the queue journal file.
   *
   * @return true if the item was added; false if the server is shutting
   *     down
   */</span>
  <span class="keyword">def</span> <a title="(key: String, item: Array[Byte], expiry: Int)Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85)">add</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).key">key</a>: <span title="String">String</span>, <a title="Array[Byte]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).item">item</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span>, <a title="Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry">expiry</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><a title="scala.collection.mutable.HashSet[String]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).$anonfun.fanouts">fanouts</a> ← <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.fanout_queues" title="=&gt; scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]">fanout_queues</a>.<span title="(key: String)Option[scala.collection.mutable.HashSet[String]]">get</span><span title="(f: scala.collection.mutable.HashSet[String] =&gt; Unit)Unit" class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).key" title="String">key</a><span class="delimiter">)</span>; <a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).$anonfun.$anonfun.name">name</a> ← <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).$anonfun.fanouts" title="(f: String =&gt; Boolean)Unit">fanouts</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85)" title="(key: String, item: Array[Byte], expiry: Int)Boolean">add</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).$anonfun.$anonfun.name" title="String">name</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).item" title="Array[Byte]">item</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry" title="Int">expiry</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).key" title="String">key</a><span class="delimiter">)</span> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="None.type">None</span> ⇒ <span title="Boolean(false)" class="keyword">false</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).q">q</a><span class="delimiter">)</span> ⇒
        <span class="keyword">val</span> <a title="Long" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).now">now</a> = <span title="System.type">System</span>.<span title="()Long">currentTimeMillis</span>
        <span class="keyword">val</span> <a title="Long" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).normalizedExpiry">normalizedExpiry</a>: <span title="Long">Long</span> = <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry" title="Int">expiry</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="Long(0L)" class="int">0</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry" title="Int">expiry</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(1000000)" class="int">1000000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).now" title="Long">now</a> <span title="(x: Int)Long">+</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry" title="Int">expiry</a>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).expiry" title="=&gt; Long">expiry</a>
        <span class="delimiter">}</span>
        <span class="keyword">val</span> <a title="Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).result">result</a> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.add(1c714acb54)" title="(value: Array[Byte], expiry: Long)Boolean">add</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).item" title="Array[Byte]">item</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).normalizedExpiry" title="Long">normalizedExpiry</a><span class="delimiter">)</span>
        <span title="AnyVal" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).result" title="Boolean">result</a><span class="delimiter">)</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.totalAdded" title="=&gt; akka.actor.mailbox.filebased.filequeue.Counter">totalAdded</a>.<a href="Counter.scala.html#akka.actor.mailbox.filebased.filequeue;Counter.incr(8800fc39c7)" title="()Long">incr</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85).result" title="Boolean">result</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String, item: Array[Byte])Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(3e79b601c1)">add</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(3e79b601c1).key">key</a>: <span title="String">String</span>, <a title="Array[Byte]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.add(3e79b601c1).item">item</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(bea353dd85)" title="(key: String, item: Array[Byte], expiry: Int)Boolean">add</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(3e79b601c1).key" title="String">key</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.add(3e79b601c1).item" title="Array[Byte]">item</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Retrieve an item from a queue and pass it to a continuation. If no item is available within
   * the requested time, or the server is shutting down, None is passed.
   */</span>
  <span class="keyword">def</span> <a title="(key: String, timeout: Int, transaction: Boolean, peek: Boolean)(f: Option[akka.actor.mailbox.filebased.filequeue.QItem] =&gt; Unit)Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove">remove</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.key">key</a>: <span title="String">String</span>, <a title="Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.timeout">timeout</a>: <span title="Int">Int</span>, <a title="Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.transaction">transaction</a>: <span title="Boolean">Boolean</span>, <a title="Boolean" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.peek">peek</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="Option[akka.actor.mailbox.filebased.filequeue.QItem] =&gt; Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.f">f</a>: Option<span class="delimiter">[</span>QItem<span class="delimiter">]</span> ⇒ Unit<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.key" title="String">key</a><span class="delimiter">)</span> <span title="Unit" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="None.type">None</span> ⇒
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queueMisses" title="=&gt; akka.actor.mailbox.filebased.filequeue.Counter">queueMisses</a>.<a href="Counter.scala.html#akka.actor.mailbox.filebased.filequeue;Counter.incr(8800fc39c7)" title="()Long">incr</a>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.f" title="(v1: Option[akka.actor.mailbox.filebased.filequeue.QItem])Unit">f</a><span class="delimiter">(</span><span title="None.type">None</span><span class="delimiter">)</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.q">q</a><span class="delimiter">)</span> ⇒
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.peek" title="Boolean">peek</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.f" title="(v1: Option[akka.actor.mailbox.filebased.filequeue.QItem])Unit">f</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.peek" title="()Option[akka.actor.mailbox.filebased.filequeue.QItem]">peek</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.remove(9f103a3f28)" title="()Option[akka.actor.mailbox.filebased.filequeue.QItem]">remove</a>
          <span class="comment">/*          q.removeReact(if (timeout == 0) timeout else System.currentTimeMillis + timeout, transaction) {
            case None =&gt;
              queueMisses.incr
              f(None)
            case Some(item) =&gt;
              queueHits.incr
              f(Some(item))
          }
*/</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">// for testing.</span>
  <span class="keyword">def</span> <a title="(key: String)Option[Array[Byte]]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.receive">receive</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.key">key</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">var</span> <a title="Option[Array[Byte]]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.rv">rv</a>: <span title="Option[Array[Byte]]">Option</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span> = <span title="None.type">None</span>
    <span class="keyword">val</span> <a title="java.util.concurrent.CountDownLatch" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.latch">latch</a> = <span title="java.util.concurrent.CountDownLatch" class="keyword">new</span> <span title="java.util.concurrent.CountDownLatch">CountDownLatch</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.remove" title="(key: String, timeout: Int, transaction: Boolean, peek: Boolean)(f: Option[akka.actor.mailbox.filebased.filequeue.QItem] =&gt; Unit)Unit">remove</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.key" title="String">key</a>, <span title="Int(0)" class="int">0</span>, <span title="Boolean(false)" class="keyword">false</span>, <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.$anonfun.x0$1" title="Unit" class="delimiter">{</a>
      <span class="keyword">case</span> <span title="None.type">None</span> ⇒
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.rv" title="Option[Array[Byte]]">rv</a> = <span title="None.type">None</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.latch" title="java.util.concurrent.CountDownLatch">latch</a>.<span title="()Unit">countDown</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="akka.actor.mailbox.filebased.filequeue.QItem" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.$anonfun.v">v</a><span class="delimiter">)</span> ⇒
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.rv" title="Option[Array[Byte]]">rv</a> = <span title="(x: Array[Byte])Some[Array[Byte]]">Some</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.$anonfun.v" title="akka.actor.mailbox.filebased.filequeue.QItem">v</a>.<a href="QItem.scala.html#akka.actor.mailbox.filebased.filequeue;QItem.data" title="=&gt; Array[Byte]">data</a><span class="delimiter">)</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.latch" title="java.util.concurrent.CountDownLatch">latch</a>.<span title="()Unit">countDown</span>
    <span class="delimiter">}</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.latch" title="java.util.concurrent.CountDownLatch">latch</a>.<span title="()Unit">await</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.receive.rv" title="Option[Array[Byte]]">rv</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String, xid: Int)Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove">unremove</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.key">key</a>: <span title="String">String</span>, <a title="Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.xid">xid</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.key" title="String">key</a><span class="delimiter">)</span> <span title="(f: akka.actor.mailbox.filebased.filequeue.PersistentQueue =&gt; Unit)Option[Unit]">map</span> <span class="delimiter">{</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.$anonfun.q">q</a> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.unremove" title="(xid: Int)Unit">unremove</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.unremove.xid" title="Int">xid</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String, xid: Int)Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove">confirmRemove</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.key">key</a>: <span title="String">String</span>, <a title="Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.xid">xid</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.key" title="String">key</a><span class="delimiter">)</span> <span title="(f: akka.actor.mailbox.filebased.filequeue.PersistentQueue =&gt; Unit)Option[Unit]">map</span> <span class="delimiter">{</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.$anonfun.q">q</a> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.confirmRemove" title="(xid: Int)Unit">confirmRemove</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.confirmRemove.xid" title="Int">xid</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String)Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flush">flush</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flush.key">key</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flush.key" title="String">key</a><span class="delimiter">)</span> <span title="(f: akka.actor.mailbox.filebased.filequeue.PersistentQueue =&gt; Unit)Option[Unit]">map</span> <span class="delimiter">{</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flush.$anonfun.q">q</a> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flush.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.flush" title="()Unit">flush</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(name: String)Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.delete">delete</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=" title="=&gt; Boolean">shuttingDown</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="(key: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">get</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="String">name</a><span class="delimiter">)</span> <span title="(f: akka.actor.mailbox.filebased.filequeue.PersistentQueue =&gt; Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue])Option[Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]]">map</span> <span class="delimiter">{</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.$anonfun.q">q</a> ⇒
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.close" title="()Unit">close</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.destroyJournal" title="()Unit">destroyJournal</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="(key: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">remove</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="String">name</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">name</a> <span title="(elem: Any)Boolean">contains</span> <span title="Char('+')" class="char">'+'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">val</span> <a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.master">master</a> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">name</a>.<span title="(separator: Char)Array[String]">split</span><span title="(i: Int)String" class="delimiter">(</span><span title="Char('+')" class="char">'+'</span><span class="delimiter">)</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.fanout_queues" title="=&gt; scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]">fanout_queues</a>.<span title="(key: String, op: =&gt; scala.collection.mutable.HashSet[String])scala.collection.mutable.HashSet[String]">getOrElseUpdate</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.master" title="String">master</a>, <span title="()scala.collection.mutable.HashSet[String]" class="keyword">new</span> mutable.<span title="scala.collection.mutable.HashSet[String]">HashSet</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span title="(elem: String)scala.collection.mutable.HashSet[String]">-=</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="String">name</a>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.log" title="akka.event.LoggingAdapter">log</a>.<a href="../../../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.debug(2f488eb77c)" title="(template: String, arg1: Any, arg2: Any)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Fanout queue {} dropped from {}&quot;)" class="string">&quot;Fanout queue {} dropped from {}&quot;</span>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.name" title="String">name</a>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.delete.master" title="String">master</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(name: String)Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired">flushExpired</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired.name">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: Int)Int">synchronized</a> <span class="delimiter">{</span>
    <span title="Int" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=" title="=&gt; Boolean">shuttingDown</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired.name" title="String">name</a><span class="delimiter">)</span> <span title="(f: akka.actor.mailbox.filebased.filequeue.PersistentQueue =&gt; Int)Option[Int]">map</span> <span class="delimiter">{</span> <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired.$anonfun.q">q</a> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.discardExpired" title="()Int">discardExpired</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span> <span title="(default: =&gt; Int)Int">getOrElse</span> <span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="()Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushAllExpired">flushAllExpired</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: Int)Int">synchronized</a> <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queueNames" title="=&gt; List[String]">queueNames</a>.<span title="(z: Int)(f: (Int, String) =&gt; Int)Int">foldLeft</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="delimiter">(</span><a title="Int" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushAllExpired.$anonfun.sum">sum</a>, <a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.flushAllExpired.$anonfun.qName">qName</a><span class="delimiter">)</span> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flushAllExpired.$anonfun.sum" title="Int">sum</a> <span title="(x: Int)Int">+</span> <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flushExpired" title="(name: String)Int">flushExpired</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.flushAllExpired.$anonfun.qName" title="String">qName</a><span class="delimiter">)</span> <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String)Array[(String, String)]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.stats">stats</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.key">key</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Array[(String, String)]">Array</span><span class="delimiter">[</span><span class="delimiter">(</span>String, String<span class="delimiter">)</span><span class="delimiter">]</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.key" title="String">key</a><span class="delimiter">)</span> <span title="Array[(String, String)]" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> <span title="None.type">None</span> ⇒ <span title="[T](xs: T*)(implicit evidence$2: scala.reflect.ClassTag[T])Array[T]">Array</span><span title="(xs: (String, String)*)(implicit evidence$2: scala.reflect.ClassTag[(String, String)])Array[(String, String)]" class="delimiter">[</span><span title="(String, String)" class="delimiter">(</span>String, String<span class="delimiter">)</span><span class="delimiter">]</span><span title="(runtimeClass1: Class[_])scala.reflect.ClassTag[(String, String)]" class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.q">q</a><span class="delimiter">)</span> ⇒
      <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.dumpStats" title="()Array[(String, String)]">dumpStats</a><span title="(xs: Array[(String, String)])scala.collection.mutable.ArrayOps[(String, String)]" class="delimiter">(</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[(String, String)])(implicit bf: scala.collection.generic.CanBuildFrom[Array[(String, String)],(String, String),Array[(String, String)]])Array[(String, String)]">++</span>
        <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.fanout_queues" title="=&gt; scala.collection.mutable.HashMap[String,scala.collection.mutable.HashSet[String]]">fanout_queues</a>.<span title="(key: String)Option[scala.collection.mutable.HashSet[String]]">get</span><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.key" title="String">key</a><span class="delimiter">)</span>.<span title="(f: scala.collection.mutable.HashSet[String] =&gt; (String, String))Option[(String, String)]">map</span> <span class="delimiter">{</span> <a title="scala.collection.mutable.HashSet[String]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.$anonfun.qset">qset</a> ⇒ <span title="(_1: String, _2: String)(String, String)" class="delimiter">(</span><span title="String(&quot;children&quot;)" class="string">&quot;children&quot;</span>, <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.stats.$anonfun.qset" title="scala.collection.mutable.HashSet[String]">qset</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>.<span title="=&gt; List[(String, String)]">toList</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(key: String)Array[String]" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.dumpConfig">dumpConfig</a><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.dumpConfig.key">key</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queue" title="(name: String)Option[akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queue</a><span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.dumpConfig.key" title="String">key</a><span class="delimiter">)</span> <span title="Array[String]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span title="None.type">None</span>    ⇒ <span title="(xs: String*)(implicit evidence$2: scala.reflect.ClassTag[String])Array[String]">Array</span><span title="(runtimeClass1: Class[_])scala.reflect.ClassTag[String]" class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.dumpConfig.q">q</a><span class="delimiter">)</span> ⇒ <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.dumpConfig.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.dumpConfig" title="()Array[String]">dumpConfig</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Shutdown this queue collection. All actors are asked to exit, and
   * any future queue requests will fail.
   */</span>
  <span class="keyword">def</span> <a title="=&gt; Unit" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.shutdown">shutdown</a>: <span title="Unit">Unit</span> = <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection" title="(x$1: Unit)Unit">synchronized</a> <span class="delimiter">{</span>
    <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=" title="=&gt; Boolean">shuttingDown</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Nothing" class="keyword">return</span>
    <span class="delimiter">}</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shuttingDown_=" title="(x$1: Boolean)Unit">shuttingDown</a> = <span title="Boolean(true)" class="keyword">true</span>
    <span class="keyword">for</span> <span class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.shutdown.$anonfun.name">name</a>, <a title="akka.actor.mailbox.filebased.filequeue.PersistentQueue" id="akka.actor.mailbox.filebased.filequeue;QueueCollection.shutdown.$anonfun.q">q</a><span class="delimiter">)</span> ← <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="(f: ((String, akka.actor.mailbox.filebased.filequeue.PersistentQueue)) =&gt; Unit)Unit">queues</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// synchronous, so the journals are all officially closed before we return.</span>
      <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.shutdown.$anonfun.q" title="akka.actor.mailbox.filebased.filequeue.PersistentQueue">q</a>.<a href="PersistentQueue.scala.html#akka.actor.mailbox.filebased.filequeue;PersistentQueue.close" title="()Unit">close</a>
    <span class="delimiter">}</span>
    <a href="#akka.actor.mailbox.filebased.filequeue;QueueCollection.queues" title="=&gt; scala.collection.mutable.HashMap[String,akka.actor.mailbox.filebased.filequeue.PersistentQueue]">queues</a>.<span title="()Unit">clear</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
