<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>akka-actor/routing/SmallestMailbox.scala</title>
        <script type="text/javascript" src="../../jquery-all.js"></script>
        <script type="text/javascript" src="../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2009-2014 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>
<span class="keyword">package</span> akka.routing

<span class="keyword">import</span> scala.annotation.tailrec
<span class="keyword">import</span> scala.collection.immutable
<span class="keyword">import</span> scala.concurrent.forkjoin.ThreadLocalRandom
<span class="keyword">import</span> com.typesafe.config.Config
<span class="keyword">import</span> akka.actor.ActorCell
<span class="keyword">import</span> akka.actor.ActorRefWithCell
<span class="keyword">import</span> akka.actor.SupervisorStrategy
<span class="keyword">import</span> akka.dispatch.Dispatchers
<span class="keyword">import</span> akka.japi.<a href="../japi/JavaAPI.scala.html#akka.japi.Util" title="akka.japi.Util.type">Util</a>.immutableSeq
<span class="keyword">import</span> akka.actor.ActorSystem
<span class="keyword">import</span> akka.actor.Props

<span class="keyword">object</span> <a title="akka.routing.SmallestMailboxRoutingLogic.type" id="akka.routing.SmallestMailboxRoutingLogic">SmallestMailboxRoutingLogic</a> <a href="#akka.routing.SmallestMailboxRoutingLogic" title="akka.routing.SmallestMailboxRoutingLogic.type" class="delimiter">{</a>
  <span class="keyword">def</span> <a title="()akka.routing.SmallestMailboxRoutingLogic" id="akka.routing.SmallestMailboxRoutingLogic.apply">apply</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#akka.routing;SmallestMailboxRoutingLogic" title="akka.routing.SmallestMailboxRoutingLogic">SmallestMailboxRoutingLogic</a> = <span title="akka.routing.SmallestMailboxRoutingLogic" class="keyword">new</span> <a href="#akka.routing;SmallestMailboxRoutingLogic" title="akka.routing.SmallestMailboxRoutingLogic">SmallestMailboxRoutingLogic</a>
<span class="delimiter">}</span>

<span class="comment">/**
 * Tries to send to the non-suspended routee with fewest messages in mailbox.
 * The selection is done in this order:
 * &lt;ul&gt;
 * &lt;li&gt;pick any idle routee (not processing message) with empty mailbox&lt;/li&gt;
 * &lt;li&gt;pick any routee with empty mailbox&lt;/li&gt;
 * &lt;li&gt;pick routee with fewest pending messages in mailbox&lt;/li&gt;
 * &lt;li&gt;pick any remote routee, remote actors are consider lowest priority,
 *     since their mailbox size is unknown&lt;/li&gt;
 * &lt;/ul&gt;
 */</span>
@SerialVersionUID<span class="delimiter">(</span><span class="long">1L</span><span class="delimiter">)</span>
<span class="keyword">class</span> <a title="class SmallestMailboxRoutingLogic extends AnyRef with akka.routing.RoutingLogic" id="akka.routing;SmallestMailboxRoutingLogic">SmallestMailboxRoutingLogic</a> <a href="#akka.routing;SmallestMailboxRoutingLogic" title="akka.routing.SmallestMailboxRoutingLogic" class="keyword">extends</a> <a href="Router.scala.html#akka.routing;RoutingLogic" title="akka.routing.RoutingLogic">RoutingLogic</a> <span class="delimiter">{</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(message: Any, routees: scala.collection.immutable.IndexedSeq[akka.routing.Routee])akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.select">select</a><span class="delimiter">(</span><a title="Any" id="akka.routing;SmallestMailboxRoutingLogic.select.message">message</a>: <span title="Any">Any</span>, <a title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]" id="akka.routing;SmallestMailboxRoutingLogic.select.routees">routees</a>: immutable.<span title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">IndexedSeq</span><span class="delimiter">[</span>Routee<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a> =
    <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.select.routees" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">routees</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="Router.scala.html#akka.routing.NoRoutee" title="akka.routing.NoRoutee.type">NoRoutee</a>
    <span class="keyword">else</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext" title="(targets: scala.collection.immutable.IndexedSeq[akka.routing.Routee], proposedTarget: akka.routing.Routee, currentScore: Long, at: Int, deep: Boolean)akka.routing.Routee">selectNext</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.select.routees" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">routees</a><span class="delimiter">)</span>

  <span class="comment">// Worst-case a 2-pass inspection with mailbox size checking done on second pass, and only until no one empty is found.</span>
  <span class="comment">// Lowest score wins, score 0 is autowin</span>
  <span class="comment">// If no actor with score 0 is found, it will return that, or if it is terminated, a random of the entire set.</span>
  <span class="comment">//   Why? Well, in case we had 0 viable actors and all we got was the default, which is the DeadLetters, anything else is better.</span>
  <span class="comment">// Order of interest, in ascending priority:</span>
  <span class="comment">// 1. The NoRoutee</span>
  <span class="comment">// 2. A Suspended ActorRef</span>
  <span class="comment">// 3. An ActorRef with unknown mailbox size but with one message being processed</span>
  <span class="comment">// 4. An ActorRef with unknown mailbox size that isn't processing anything</span>
  <span class="comment">// 5. An ActorRef with a known mailbox size</span>
  <span class="comment">// 6. An ActorRef without any messages</span>
  @tailrec <span class="keyword">private</span> <span class="keyword">def</span> <a title="(targets: scala.collection.immutable.IndexedSeq[akka.routing.Routee], proposedTarget: akka.routing.Routee, currentScore: Long, at: Int, deep: Boolean)akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.selectNext">selectNext</a><span class="delimiter">(</span><a title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]" id="akka.routing;SmallestMailboxRoutingLogic.selectNext.targets">targets</a>: immutable.<span title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">IndexedSeq</span><span class="delimiter">[</span>Routee<span class="delimiter">]</span>,
                                  <a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.selectNext$default$2">proposedTarget</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a> = <a href="Router.scala.html#akka.routing.NoRoutee" title="akka.routing.NoRoutee.type">NoRoutee</a>,
                                  <a title="Long" id="akka.routing;SmallestMailboxRoutingLogic.selectNext$default$3">currentScore</a>: <span title="Long">Long</span> = Long.<span title="Long(9223372036854775807L)">MaxValue</span>,
                                  <a title="Int" id="akka.routing;SmallestMailboxRoutingLogic.selectNext$default$4">at</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span>,
                                  <a title="Boolean" id="akka.routing;SmallestMailboxRoutingLogic.selectNext$default$5">deep</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a> = <span class="delimiter">{</span>
    <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span>
      <a href="Router.scala.html#akka.routing.NoRoutee" title="akka.routing.NoRoutee.type">NoRoutee</a>
    <span class="keyword">else</span> <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$4" title="Int">at</a> <span title="(x: Int)Boolean">&gt;=</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$5" title="Boolean">deep</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.isTerminated" title="(a: akka.routing.Routee)Boolean">isTerminated</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$2" title="akka.routing.Routee">proposedTarget</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="(idx: Int)akka.routing.Routee">targets</a><span class="delimiter">(</span><span title="scala.concurrent.forkjoin.ThreadLocalRandom.type">ThreadLocalRandom</span>.<span title="()scala.concurrent.forkjoin.ThreadLocalRandom">current</span>.<span title="(x$1: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="keyword">else</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$2" title="akka.routing.Routee">proposedTarget</a>
      <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext" title="(targets: scala.collection.immutable.IndexedSeq[akka.routing.Routee], proposedTarget: akka.routing.Routee, currentScore: Long, at: Int, deep: Boolean)akka.routing.Routee">selectNext</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$2" title="akka.routing.Routee">proposedTarget</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$3" title="Long">currentScore</a>, <span title="Int(0)" class="int">0</span>, deep = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.selectNext.target">target</a> = <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="(idx: Int)akka.routing.Routee">targets</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$4" title="Int">at</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="Long" id="akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore">newScore</a>: <span title="Long">Long</span> =
        <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.isSuspended" title="(a: akka.routing.Routee)Boolean">isSuspended</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a><span class="delimiter">)</span><span class="delimiter">)</span> Long.MaxValue <span title="Long(9223372036854775806L)">-</span> <span class="int">1</span> <span class="keyword">else</span> <span class="delimiter">{</span> <span class="comment">//Just about better than the DeadLetters</span>
          <span class="delimiter">(</span><span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage" title="(a: akka.routing.Routee)Boolean">isProcessingMessage</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Long(1L)" class="long">1l</span> <span class="keyword">else</span> <span title="Long(0L)" class="long">0l</span><span class="delimiter">)</span> <span title="(x: Long)Long">+</span>
            <span class="delimiter">(</span><span title="Long" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.routing;SmallestMailboxRoutingLogic.hasMessages" title="(a: akka.routing.Routee)Boolean">hasMessages</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="Long(0L)" class="long">0l</span> <span class="keyword">else</span> <span class="delimiter">{</span> <span class="comment">//Race between hasMessages and numberOfMessages here, unfortunate the numberOfMessages returns 0 if unknown</span>
              <span class="keyword">val</span> <a title="Long" id="akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore.noOfMsgs">noOfMsgs</a>: <span title="Long">Long</span> = <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$5" title="Boolean">deep</a><span class="delimiter">)</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.numberOfMessages" title="(a: akka.routing.Routee)Int">numberOfMessages</a><span title="=&gt; Long" class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a><span class="delimiter">)</span> <span class="keyword">else</span> <span title="Long(0L)" class="int">0</span>
              <span title="Long" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore.noOfMsgs" title="Long">noOfMsgs</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore.noOfMsgs" title="Long">noOfMsgs</a> <span class="keyword">else</span> Long.MaxValue <span title="Long(9223372036854775804L)">-</span> <span class="int">3</span> <span class="comment">//Just better than a suspended actorref</span>
            <span class="delimiter">}</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

      <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore" title="Long">newScore</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a>
      <span class="keyword">else</span> <span title="akka.routing.Routee" class="keyword">if</span> <span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore" title="Long">newScore</a> <span title="(x: Int)Boolean">&lt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">||</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore" title="Long">newScore</a> <span title="(x: Long)Boolean">&gt;=</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$3" title="Long">currentScore</a><span class="delimiter">)</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext" title="(targets: scala.collection.immutable.IndexedSeq[akka.routing.Routee], proposedTarget: akka.routing.Routee, currentScore: Long, at: Int, deep: Boolean)akka.routing.Routee">selectNext</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$2" title="akka.routing.Routee">proposedTarget</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$3" title="Long">currentScore</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$4" title="Int">at</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$5" title="Boolean">deep</a><span class="delimiter">)</span>
      <span class="keyword">else</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext" title="(targets: scala.collection.immutable.IndexedSeq[akka.routing.Routee], proposedTarget: akka.routing.Routee, currentScore: Long, at: Int, deep: Boolean)akka.routing.Routee">selectNext</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.targets" title="scala.collection.immutable.IndexedSeq[akka.routing.Routee]">targets</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.target" title="akka.routing.Routee">target</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext.newScore" title="Long">newScore</a>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$4" title="Int">at</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.routing;SmallestMailboxRoutingLogic.selectNext$default$5" title="Boolean">deep</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(a: akka.routing.Routee)Boolean" id="akka.routing;SmallestMailboxRoutingLogic.isTerminated">isTerminated</a><span class="delimiter">(</span><a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.isTerminated.a">a</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#akka.routing;SmallestMailboxRoutingLogic.isTerminated.a" title="akka.routing.Routee">a</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> ActorRefRoutee<span class="delimiter">(</span><a title="akka.actor.ActorRef" id="akka.routing;SmallestMailboxRoutingLogic.isTerminated.ref">ref</a><span class="delimiter">)</span> ⇒ <a href="#akka.routing;SmallestMailboxRoutingLogic.isTerminated.ref" title="akka.actor.ActorRef">ref</a>.<a href="../actor/ActorRef.scala.html#akka.actor;ActorRef.isTerminated" title="=&gt; Boolean">isTerminated</a>
    <span class="keyword">case</span> _                   ⇒ <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns true if the actor is currently processing a message.
   * It will always return false for remote actors.
   * Method is exposed to subclasses to be able to implement custom
   * routers based on mailbox and actor internal state.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(a: akka.routing.Routee)Boolean" id="akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage">isProcessingMessage</a><span class="delimiter">(</span><a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.a">a</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.a" title="akka.routing.Routee">a</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> ActorRefRoutee<span class="delimiter">(</span><a title="akka.actor.ActorRefWithCell" id="akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.x">x</a>: <a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell" title="akka.actor.ActorRefWithCell">ActorRefWithCell</a><span class="delimiter">)</span> ⇒
      <a href="#akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.x" title="akka.actor.ActorRefWithCell">x</a>.<a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell.underlying" title="=&gt; akka.actor.Cell">underlying</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="akka.actor.ActorCell" id="akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.cell">cell</a>: <a href="../actor/ActorCell.scala.html#akka.actor;ActorCell" title="akka.actor.ActorCell">ActorCell</a> ⇒ <a href="#akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.cell" title="akka.actor.ActorCell">cell</a>.<a href="../actor/dungeon/Dispatch.scala.html#akka.actor.dungeon;Dispatch.mailbox" title="=&gt; akka.dispatch.Mailbox">mailbox</a>.<a href="../dispatch/Mailbox.scala.html#akka.dispatch;Mailbox.isScheduled" title="=&gt; Boolean">isScheduled</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.routing;SmallestMailboxRoutingLogic.isProcessingMessage.cell" title="akka.actor.ActorCell">cell</a>.<a href="../actor/ActorCell.scala.html#akka.actor;ActorCell.currentMessage" title="=&gt; akka.dispatch.Envelope">currentMessage</a> <span title="(x$1: AnyRef)Boolean">!=</span> <span title="Null(null)" class="keyword">null</span>
        <span class="keyword">case</span> _               ⇒ <span title="Boolean(false)" class="keyword">false</span>
      <span class="delimiter">}</span>
    <span class="keyword">case</span> _ ⇒ <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns true if the actor currently has any pending messages
   * in the mailbox, i.e. the mailbox is not empty.
   * It will always return false for remote actors.
   * Method is exposed to subclasses to be able to implement custom
   * routers based on mailbox and actor internal state.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(a: akka.routing.Routee)Boolean" id="akka.routing;SmallestMailboxRoutingLogic.hasMessages">hasMessages</a><span class="delimiter">(</span><a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.hasMessages.a">a</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#akka.routing;SmallestMailboxRoutingLogic.hasMessages.a" title="akka.routing.Routee">a</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> ActorRefRoutee<span class="delimiter">(</span><a title="akka.actor.ActorRefWithCell" id="akka.routing;SmallestMailboxRoutingLogic.hasMessages.x">x</a>: <a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell" title="akka.actor.ActorRefWithCell">ActorRefWithCell</a><span class="delimiter">)</span> ⇒ <a href="#akka.routing;SmallestMailboxRoutingLogic.hasMessages.x" title="akka.actor.ActorRefWithCell">x</a>.<a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell.underlying" title="=&gt; akka.actor.Cell">underlying</a>.<a href="../actor/ActorCell.scala.html#akka.actor;Cell.hasMessages" title="=&gt; Boolean">hasMessages</a>
    <span class="keyword">case</span> _                                   ⇒ <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns true if the actor is currently suspended.
   * It will always return false for remote actors.
   * Method is exposed to subclasses to be able to implement custom
   * routers based on mailbox and actor internal state.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(a: akka.routing.Routee)Boolean" id="akka.routing;SmallestMailboxRoutingLogic.isSuspended">isSuspended</a><span class="delimiter">(</span><a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.isSuspended.a">a</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <a href="#akka.routing;SmallestMailboxRoutingLogic.isSuspended.a" title="akka.routing.Routee">a</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> ActorRefRoutee<span class="delimiter">(</span><a title="akka.actor.ActorRefWithCell" id="akka.routing;SmallestMailboxRoutingLogic.isSuspended.x">x</a>: <a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell" title="akka.actor.ActorRefWithCell">ActorRefWithCell</a><span class="delimiter">)</span> ⇒
      <a href="#akka.routing;SmallestMailboxRoutingLogic.isSuspended.x" title="akka.actor.ActorRefWithCell">x</a>.<a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell.underlying" title="=&gt; akka.actor.Cell">underlying</a> <span title="Boolean" class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> <a title="akka.actor.ActorCell" id="akka.routing;SmallestMailboxRoutingLogic.isSuspended.cell">cell</a>: <a href="../actor/ActorCell.scala.html#akka.actor;ActorCell" title="akka.actor.ActorCell">ActorCell</a> ⇒ <a href="#akka.routing;SmallestMailboxRoutingLogic.isSuspended.cell" title="akka.actor.ActorCell">cell</a>.<a href="../actor/dungeon/Dispatch.scala.html#akka.actor.dungeon;Dispatch.mailbox" title="=&gt; akka.dispatch.Mailbox">mailbox</a>.<a href="../dispatch/Mailbox.scala.html#akka.dispatch;Mailbox.isSuspended" title="=&gt; Boolean">isSuspended</a>
        <span class="keyword">case</span> _               ⇒ <span title="Boolean(true)" class="keyword">true</span>
      <span class="delimiter">}</span>
    <span class="keyword">case</span> _ ⇒ <span title="Boolean(false)" class="keyword">false</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns the number of pending messages in the mailbox of the actor.
   * It will always return 0 for remote actors.
   * Method is exposed to subclasses to be able to implement custom
   * routers based on mailbox and actor internal state.
   */</span>
  <span class="keyword">protected</span> <span class="keyword">def</span> <a title="(a: akka.routing.Routee)Int" id="akka.routing;SmallestMailboxRoutingLogic.numberOfMessages">numberOfMessages</a><span class="delimiter">(</span><a title="akka.routing.Routee" id="akka.routing;SmallestMailboxRoutingLogic.numberOfMessages.a">a</a>: <a href="Router.scala.html#akka.routing;Routee" title="akka.routing.Routee">Routee</a><span class="delimiter">)</span>: <span title="Int">Int</span> = <a href="#akka.routing;SmallestMailboxRoutingLogic.numberOfMessages.a" title="akka.routing.Routee">a</a> <span title="Int" class="keyword">match</span> <span class="delimiter">{</span>
    <span class="keyword">case</span> ActorRefRoutee<span class="delimiter">(</span><a title="akka.actor.ActorRefWithCell" id="akka.routing;SmallestMailboxRoutingLogic.numberOfMessages.x">x</a>: <a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell" title="akka.actor.ActorRefWithCell">ActorRefWithCell</a><span class="delimiter">)</span> ⇒ <a href="#akka.routing;SmallestMailboxRoutingLogic.numberOfMessages.x" title="akka.actor.ActorRefWithCell">x</a>.<a href="../actor/ActorRef.scala.html#akka.actor;ActorRefWithCell.underlying" title="=&gt; akka.actor.Cell">underlying</a>.<a href="../actor/ActorCell.scala.html#akka.actor;Cell.numberOfMessages" title="=&gt; Int">numberOfMessages</a>
    <span class="keyword">case</span> _                                   ⇒ <span title="Int(0)" class="int">0</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * A router pool that tries to send to the non-suspended routee with fewest messages in mailbox.
 * The selection is done in this order:
 * &lt;ul&gt;
 * &lt;li&gt;pick any idle routee (not processing message) with empty mailbox&lt;/li&gt;
 * &lt;li&gt;pick any routee with empty mailbox&lt;/li&gt;
 * &lt;li&gt;pick routee with fewest pending messages in mailbox&lt;/li&gt;
 * &lt;li&gt;pick any remote routee, remote actors are consider lowest priority,
 *     since their mailbox size is unknown&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * The configuration parameter trumps the constructor arguments. This means that
 * if you provide `nrOfInstances` during instantiation they will be ignored if
 * the router is defined in the configuration file for the actor being used.
 *
 * &lt;h1&gt;Supervision Setup&lt;/h1&gt;
 *
 * Any routees that are created by a router will be created as the router's children.
 * The router is therefore also the children's supervisor.
 *
 * The supervision strategy of the router actor can be configured with
 * [[#withSupervisorStrategy]]. If no strategy is provided, routers default to
 * a strategy of “always escalate”. This means that errors are passed up to the
 * router's supervisor for handling.
 *
 * The router's supervisor will treat the error as an error with the router itself.
 * Therefore a directive to stop or restart will cause the router itself to stop or
 * restart. The router, in turn, will cause its children to stop and restart.
 *
 * @param nrOfInstances initial number of routees in the pool
 *
 * @param resizer optional resizer that dynamically adjust the pool size
 *
 * @param supervisorStrategy strategy for supervising the routees, see 'Supervision Setup'
 *
 * @param routerDispatcher dispatcher to use for the router head actor, which handles
 *   supervision, death watch and router management messages
 */</span>
@SerialVersionUID<span class="delimiter">(</span><span class="long">1L</span><span class="delimiter">)</span>
<span class="keyword">final</span> <span class="keyword">case class</span> <a title="class SmallestMailboxPool extends AnyRef with akka.routing.Pool with akka.routing.PoolOverrideUnsetConfig[akka.routing.SmallestMailboxPool] with Product with Serializable" id="akka.routing.SmallestMailboxPool.readResolve">SmallestMailboxPool</a><a href="#akka.routing.SmallestMailboxPool.readResolve" title="Product" class="delimiter">(</a>
  <span class="keyword">override</span> <span class="keyword">val</span> <a title="Int" id="akka.routing;SmallestMailboxPool.nrOfInstances">nrOfInstances</a>: <span title="Int">Int</span>, <span class="keyword">override</span> <span class="keyword">val</span> <a title="Option[akka.routing.Resizer]" id="akka.routing.SmallestMailboxPool.apply$default$2">resizer</a>: <span title="Option[akka.routing.Resizer]">Option</span><span class="delimiter">[</span>Resizer<span class="delimiter">]</span> = <span title="None.type">None</span>,
  <span class="keyword">override</span> <span class="keyword">val</span> <a title="akka.actor.SupervisorStrategy" id="akka.routing.SmallestMailboxPool.apply$default$3">supervisorStrategy</a>: <a href="../actor/FaultHandling.scala.html#akka.actor;SupervisorStrategy" title="akka.actor.SupervisorStrategy">SupervisorStrategy</a> = <a href="RouterConfig.scala.html#akka.routing.Pool" title="akka.routing.Pool.type">Pool</a>.<a href="RouterConfig.scala.html#akka.routing.Pool.defaultSupervisorStrategy" title="=&gt; akka.actor.SupervisorStrategy">defaultSupervisorStrategy</a>,
  <span class="keyword">override</span> <span class="keyword">val</span> <a title="String" id="akka.routing.SmallestMailboxPool.apply$default$4">routerDispatcher</a>: <span title="String">String</span> = Dispatchers.<span title="String(&quot;akka.actor.default-dispatcher&quot;)">DefaultDispatcherId</span>,
  <span class="keyword">override</span> <span class="keyword">val</span> <a title="Boolean" id="akka.routing.SmallestMailboxPool.apply$default$5">usePoolDispatcher</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> <a href="RouterConfig.scala.html#akka.routing;Pool" title="akka.routing.Pool">Pool</a> <span class="keyword">with</span> <a href="RouterConfig.scala.html#akka.routing;PoolOverrideUnsetConfig" title="akka.routing.PoolOverrideUnsetConfig[akka.routing.SmallestMailboxPool]">PoolOverrideUnsetConfig</a><span class="delimiter">[</span>SmallestMailboxPool<span class="delimiter">]</span> <span class="delimiter">{</span>

  <span class="keyword">def</span> <a title="(config: com.typesafe.config.Config)akka.routing.SmallestMailboxPool" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1)" class="keyword">this</a><span class="delimiter">(</span><a title="com.typesafe.config.Config" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1).config">config</a>: <span title="com.typesafe.config.Config">Config</span><span class="delimiter">)</span> =
    <a href="#akka.routing.SmallestMailboxPool.apply$default$3" title="akka.actor.SupervisorStrategy" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1).x$5" class="keyword">this</a><span class="delimiter">(</span>
      nrOfInstances = <a href="#akka.routing;SmallestMailboxPool.<init>(641010dcb1).config" title="com.typesafe.config.Config">config</a>.<span title="(x$1: String)Int">getInt</span><a title="Int" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1).x$1" class="delimiter">(</a><span title="String(&quot;nr-of-instances&quot;)" class="string">&quot;nr-of-instances&quot;</span><span class="delimiter">)</span>,
      resizer = <a href="Resizer.scala.html#akka.routing.DefaultResizer" title="akka.routing.DefaultResizer.type">DefaultResizer</a>.<a href="Resizer.scala.html#akka.routing.DefaultResizer.fromConfig" title="(resizerConfig: com.typesafe.config.Config)Option[akka.routing.DefaultResizer]">fromConfig</a><a title="Option[akka.routing.DefaultResizer]" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1).x$2" class="delimiter">(</a><a href="#akka.routing;SmallestMailboxPool.<init>(641010dcb1).config" title="com.typesafe.config.Config">config</a><span class="delimiter">)</span>,
      usePoolDispatcher = <a href="#akka.routing;SmallestMailboxPool.<init>(641010dcb1).config" title="com.typesafe.config.Config">config</a>.<span title="(x$1: String)Boolean">hasPath</span><a title="Boolean" id="akka.routing;SmallestMailboxPool.<init>(641010dcb1).x$3" class="delimiter">(</a><span title="String(&quot;pool-dispatcher&quot;)" class="string">&quot;pool-dispatcher&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Java API
   * @param nr initial number of routees in the pool
   */</span>
  <span class="keyword">def</span> <a title="(nr: Int)akka.routing.SmallestMailboxPool" id="akka.routing;SmallestMailboxPool.<init>(47eae50795)" class="keyword">this</a><span class="delimiter">(</span><a title="Int" id="akka.routing;SmallestMailboxPool.<init>(47eae50795).nr">nr</a>: <span title="Int">Int</span><span class="delimiter">)</span> = <a href="#akka.routing.SmallestMailboxPool.readResolve" title="SmallestMailboxPool.this.type" class="keyword">this</a><span class="delimiter">(</span>nrOfInstances = <a href="#akka.routing;SmallestMailboxPool.<init>(47eae50795).nr" title="Int">nr</a><span class="delimiter">)</span>

  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(system: akka.actor.ActorSystem)akka.routing.Router" id="akka.routing;SmallestMailboxPool.createRouter">createRouter</a><span class="delimiter">(</span><a title="akka.actor.ActorSystem" id="akka.routing;SmallestMailboxPool.createRouter.system">system</a>: <a href="../actor/ActorSystem.scala.html#akka.actor;ActorSystem" title="akka.actor.ActorSystem">ActorSystem</a><span class="delimiter">)</span>: <a href="Router.scala.html#akka.routing;Router" title="akka.routing.Router">Router</a> = <a href="Router.scala.html#akka.routing;Router.<init>(e072339920)" title="(logic: akka.routing.RoutingLogic)akka.routing.Router" class="keyword">new</a> <a href="Router.scala.html#akka.routing;Router" title="akka.routing.Router">Router</a><span class="delimiter">(</span><a href="#akka.routing.SmallestMailboxRoutingLogic.apply" title="()akka.routing.SmallestMailboxRoutingLogic">SmallestMailboxRoutingLogic</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Setting the supervisor strategy to be used for the “head” Router actor.
   */</span>
  <span class="keyword">def</span> <a title="(strategy: akka.actor.SupervisorStrategy)akka.routing.SmallestMailboxPool" id="akka.routing;SmallestMailboxPool.withSupervisorStrategy">withSupervisorStrategy</a><span class="delimiter">(</span><a title="akka.actor.SupervisorStrategy" id="akka.routing;SmallestMailboxPool.withSupervisorStrategy.strategy">strategy</a>: <a href="../actor/FaultHandling.scala.html#akka.actor;SupervisorStrategy" title="akka.actor.SupervisorStrategy">SupervisorStrategy</a><span class="delimiter">)</span>: <a href="#akka.routing.SmallestMailboxPool.readResolve" title="akka.routing.SmallestMailboxPool">SmallestMailboxPool</a> = <a href="#akka.routing;SmallestMailboxPool.nrOfInstances" title="Int" id="akka.routing;SmallestMailboxPool.withSupervisorStrategy.x$10">copy</a><span class="delimiter">(</span>supervisorStrategy = <a href="#akka.routing;SmallestMailboxPool.withSupervisorStrategy.strategy" title="akka.actor.SupervisorStrategy" id="akka.routing;SmallestMailboxPool.withSupervisorStrategy.x$6">strategy</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Setting the resizer to be used.
   */</span>
  <span class="keyword">def</span> <a title="(resizer: akka.routing.Resizer)akka.routing.SmallestMailboxPool" id="akka.routing;SmallestMailboxPool.withResizer">withResizer</a><span class="delimiter">(</span><a title="akka.routing.Resizer" id="akka.routing;SmallestMailboxPool.withResizer.resizer">resizer</a>: <a href="Resizer.scala.html#akka.routing;Resizer" title="akka.routing.Resizer">Resizer</a><span class="delimiter">)</span>: <a href="#akka.routing.SmallestMailboxPool.readResolve" title="akka.routing.SmallestMailboxPool">SmallestMailboxPool</a> = <a href="#akka.routing;SmallestMailboxPool.nrOfInstances" title="Int" id="akka.routing;SmallestMailboxPool.withResizer.x$15">copy</a><span class="delimiter">(</span>resizer = <span title="(x: akka.routing.Resizer)Some[akka.routing.Resizer]">Some</span><a title="Some[akka.routing.Resizer]" id="akka.routing;SmallestMailboxPool.withResizer.x$11" class="delimiter">(</a><a href="#akka.routing;SmallestMailboxPool.withResizer.resizer" title="akka.routing.Resizer">resizer</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Setting the dispatcher to be used for the router head actor,  which handles
   * supervision, death watch and router management messages.
   */</span>
  <span class="keyword">def</span> <a title="(dispatcherId: String)akka.routing.SmallestMailboxPool" id="akka.routing;SmallestMailboxPool.withDispatcher">withDispatcher</a><span class="delimiter">(</span><a title="String" id="akka.routing;SmallestMailboxPool.withDispatcher.dispatcherId">dispatcherId</a>: <span title="String">String</span><span class="delimiter">)</span>: <a href="#akka.routing.SmallestMailboxPool.readResolve" title="akka.routing.SmallestMailboxPool">SmallestMailboxPool</a> = <a href="#akka.routing;SmallestMailboxPool.nrOfInstances" title="Int" id="akka.routing;SmallestMailboxPool.withDispatcher.x$20">copy</a><span class="delimiter">(</span>routerDispatcher = <a href="#akka.routing;SmallestMailboxPool.withDispatcher.dispatcherId" title="String" id="akka.routing;SmallestMailboxPool.withDispatcher.x$16">dispatcherId</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Uses the resizer and/or the supervisor strategy of the given Routerconfig
   * if this RouterConfig doesn't have one, i.e. the resizer defined in code is used if
   * resizer was not defined in config.
   */</span>
  <span class="keyword">override</span> <span class="keyword">def</span> <a title="(other: akka.routing.RouterConfig)akka.routing.RouterConfig" id="akka.routing;SmallestMailboxPool.withFallback">withFallback</a><span class="delimiter">(</span><a title="akka.routing.RouterConfig" id="akka.routing;SmallestMailboxPool.withFallback.other">other</a>: <a href="RouterConfig.scala.html#akka.routing;RouterConfig" title="akka.routing.RouterConfig">RouterConfig</a><span class="delimiter">)</span>: <a href="RouterConfig.scala.html#akka.routing;RouterConfig" title="akka.routing.RouterConfig">RouterConfig</a> = <a href="#akka.routing.SmallestMailboxPool.readResolve" title="SmallestMailboxPool.this.type" class="keyword">this</a>.<a href="RouterConfig.scala.html#akka.routing;PoolOverrideUnsetConfig.overrideUnsetConfig" title="(other: akka.routing.RouterConfig)akka.routing.RouterConfig">overrideUnsetConfig</a><span class="delimiter">(</span><a href="#akka.routing;SmallestMailboxPool.withFallback.other" title="akka.routing.RouterConfig">other</a><span class="delimiter">)</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
