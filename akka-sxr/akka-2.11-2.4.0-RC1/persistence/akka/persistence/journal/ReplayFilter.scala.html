<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>persistence/akka/persistence/journal/ReplayFilter.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2015 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>
package akka.persistence.journal

import akka.actor.ActorRef
import akka.actor.Actor
import akka.persistence.JournalProtocol
import java.util.LinkedList
import akka.actor.Props
import akka.actor.ActorLogging
import scala.collection.mutable.LinkedHashSet

<span class="comment">/**
 * INTERNAL API
 *
 * Detect corrupt event stream during replay. It uses the the writerUuid and the
 * sequenceNr in the replayed events to find events emitted by overlapping writers.
 */</span>
private<span class="delimiter">[</span>akka<span class="delimiter">]</span> object <a title="akka.persistence.journal.ReplayFilter.type" id="akka.persistence.journal.ReplayFilter">ReplayFilter</a> <a href="#akka.persistence.journal.ReplayFilter" title="akka.persistence.journal.ReplayFilter.type" class="delimiter">{</a>
  def <a title="(persistentActor: akka.actor.ActorRef, mode: akka.persistence.journal.ReplayFilter.Mode, windowSize: Int, maxOldWriters: Int)akka.actor.Props" id="akka.persistence.journal.ReplayFilter.props">props</a><span class="delimiter">(</span>
    <a title="akka.actor.ActorRef" id="akka.persistence.journal.ReplayFilter.props.persistentActor">persistentActor</a>: <a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef" title="akka.actor.ActorRef">ActorRef</a>,
    <a title="akka.persistence.journal.ReplayFilter.Mode" id="akka.persistence.journal.ReplayFilter.props.mode">mode</a>: <a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>,
    <a title="Int" id="akka.persistence.journal.ReplayFilter.props.windowSize">windowSize</a>: <span title="Int">Int</span>,
    <a title="Int" id="akka.persistence.journal.ReplayFilter.props.maxOldWriters">maxOldWriters</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="../../../../actor/akka/actor/Props.scala.html#akka.actor;Props" title="akka.actor.Props">Props</a> = <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#akka.persistence.journal.ReplayFilter.props.windowSize" title="Int">windowSize</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span>, <span title="String(&quot;windowSize must be &gt; 0&quot;)" class="string">&quot;windowSize must be &gt; 0&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#akka.persistence.journal.ReplayFilter.props.maxOldWriters" title="Int">maxOldWriters</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span>, <span title="String(&quot;maxOldWriters must be &gt; 0&quot;)" class="string">&quot;maxOldWriters must be &gt; 0&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#akka.persistence.journal.ReplayFilter.props.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#akka.persistence.journal.ReplayFilter.Disabled.readResolve" title="akka.persistence.journal.ReplayFilter.Disabled.type">Disabled</a>, <span title="String(&quot;mode must not be Disabled&quot;)" class="string">&quot;mode must not be Disabled&quot;</span><span class="delimiter">)</span>
    <a href="../../../../actor/akka/actor/Props.scala.html#akka.actor.Props.apply(b09a6a316b)" title="(creator: =&gt; akka.persistence.journal.ReplayFilter)(implicit evidence$2: scala.reflect.ClassTag[akka.persistence.journal.ReplayFilter])akka.actor.Props">Props</a><span title="(runtimeClass1: Class[_])scala.reflect.ClassTag[akka.persistence.journal.ReplayFilter]" class="delimiter">(</span>new <a href="#akka.persistence.journal;ReplayFilter" title="akka.persistence.journal.ReplayFilter">ReplayFilter</a><span class="delimiter">(</span><a href="#akka.persistence.journal.ReplayFilter.props.persistentActor" title="akka.actor.ActorRef">persistentActor</a>, <a href="#akka.persistence.journal.ReplayFilter.props.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a>, <a href="#akka.persistence.journal.ReplayFilter.props.windowSize" title="Int">windowSize</a>, <a href="#akka.persistence.journal.ReplayFilter.props.maxOldWriters" title="Int">maxOldWriters</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  sealed trait <a title="trait Mode extends AnyRef" id="akka.persistence.journal.ReplayFilter;Mode">Mode</a>
  case object <a href="#akka.persistence.journal.ReplayFilter.Fail.productElement.x$1" title="akka.persistence.journal.ReplayFilter.Fail.type" id="akka.persistence.journal.ReplayFilter.Fail.readResolve">Fail</a> extends <a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>
  case object <a href="#akka.persistence.journal.ReplayFilter.Warn.productElement.x$1" title="akka.persistence.journal.ReplayFilter.Warn.type" id="akka.persistence.journal.ReplayFilter.Warn.readResolve">Warn</a> extends <a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>
  case object <a href="#akka.persistence.journal.ReplayFilter.RepairByDiscardOld.productElement.x$1" title="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.type" id="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.readResolve">RepairByDiscardOld</a> extends <a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>
  case object <a href="#akka.persistence.journal.ReplayFilter.Disabled.productElement.x$1" title="akka.persistence.journal.ReplayFilter.Disabled.type" id="akka.persistence.journal.ReplayFilter.Disabled.readResolve">Disabled</a> extends <a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>
<span class="delimiter">}</span>

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>akka<span class="delimiter">]</span> class <a title="class ReplayFilter extends AnyRef with akka.actor.Actor with akka.actor.ActorLogging" id="akka.persistence.journal;ReplayFilter">ReplayFilter</a><a href="#akka.persistence.journal;ReplayFilter" title="akka.persistence.journal.ReplayFilter" class="delimiter">(</a><a title="akka.actor.ActorRef" id="akka.persistence.journal;ReplayFilter.persistentActor">persistentActor</a>: <a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef" title="akka.actor.ActorRef">ActorRef</a>, <a title="akka.persistence.journal.ReplayFilter.Mode" id="akka.persistence.journal;ReplayFilter.mode">mode</a>: ReplayFilter.<a href="#akka.persistence.journal.ReplayFilter;Mode" title="akka.persistence.journal.ReplayFilter.Mode">Mode</a>,
                                 <a title="Int" id="akka.persistence.journal;ReplayFilter.windowSize">windowSize</a>: <span title="Int">Int</span>, <a title="Int" id="akka.persistence.journal;ReplayFilter.maxOldWriters">maxOldWriters</a>: <span title="Int">Int</span><span class="delimiter">)</span>
  extends <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor" title="akka.actor.Actor">Actor</a> with <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;ActorLogging" title="akka.actor.ActorLogging">ActorLogging</a> <span class="delimiter">{</span>
  import <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol" title="akka.persistence.JournalProtocol.type">JournalProtocol</a>._
  import <a href="#akka.persistence.journal.ReplayFilter" title="akka.persistence.journal.ReplayFilter.type">ReplayFilter</a>.<span class="delimiter">{</span> Warn, Fail, RepairByDiscardOld, Disabled <span class="delimiter">}</span>

  val <a title="java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]" id="akka.persistence.journal;ReplayFilter.buffer">buffer</a> = new <span title="java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">LinkedList</span><span class="delimiter">[</span>ReplayedMessage<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
  val <a title="scala.collection.mutable.LinkedHashSet[String]" id="akka.persistence.journal;ReplayFilter.oldWriters">oldWriters</a> = <span title="scala.collection.mutable.LinkedHashSet.type">LinkedHashSet</span>.<span title="[A]=&gt; scala.collection.mutable.LinkedHashSet[A]">empty</span><span title="scala.collection.mutable.LinkedHashSet[String]" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span>
  var <a title="String" id="akka.persistence.journal;ReplayFilter.writerUuid_=">writerUuid</a> = <span title="String(&quot;&quot;)" class="string">&quot;&quot;</span>
  var <a title="Long" id="akka.persistence.journal;ReplayFilter.seqNo_=">seqNo</a> = -<span title="Long(-1L)" class="long">1L</span>

  def <a title="=&gt; PartialFunction[Any,Unit]" id="akka.persistence.journal;ReplayFilter.receive">receive</a> = <a title="&lt;$anon: Any =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[Any,Unit] with Serializable" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
    case <a title="akka.persistence.JournalProtocol.ReplayedMessage" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r">r</a> @ ReplayedMessage<span class="delimiter">(</span><a title="akka.persistence.PersistentRepr" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.persistent">persistent</a><span class="delimiter">)</span> ⇒
      try <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()Int">size</span> <span title="(x: Int)Boolean">==</span> <a href="#akka.persistence.journal;ReplayFilter.windowSize" title="Int">windowSize</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          val <span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span> = <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()akka.persistence.JournalProtocol.ReplayedMessage">removeFirst</span><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#akka.persistence.journal;ReplayFilter.persistentActor" title="akka.actor.ActorRef">persistentActor</a>.<a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef.tell" title="(msg: Any, sender: akka.actor.ActorRef)Unit">tell</a><span class="delimiter">(</span><span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor" title="akka.actor.Actor.type">Actor</a>.<a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor.noSender" title="=&gt; akka.actor.ActorRef">noSender</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>

        if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a> <span title="(x$1: Any)Boolean">==</span> <a href="#akka.persistence.journal;ReplayFilter.writerUuid_=" title="=&gt; String">writerUuid</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// from same writer</span>
          if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a> <span title="(x: Long)Boolean">&lt;</span> <a href="#akka.persistence.journal;ReplayFilter.seqNo_=" title="=&gt; Long">seqNo</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            val errMsg = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Invalid replayed event [&quot;)">Invalid replayed event [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">}</span><span title="String(&quot;] in wrong order from &quot;)" class="string">] in wrong order from &quot;</span> <span title="String">+</span>
              <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;writer [&quot;)">writer [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a><span class="delimiter">}</span><span title="String(&quot;] with persistenceId [&quot;)">] with persistenceId [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">}</span><span title="String(&quot;]&quot;)" class="string">]&quot;</span>
            <a href="#akka.persistence.journal;ReplayFilter.logIssue" title="(errMsg: String)Unit">logIssue</a><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
            <a href="#akka.persistence.journal;ReplayFilter.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> match <span class="delimiter">{</span>
              case <a href="#akka.persistence.journal.ReplayFilter.RepairByDiscardOld.readResolve" title="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.type">RepairByDiscardOld</a> ⇒ <span class="comment">// discard</span>
              case <a href="#akka.persistence.journal.ReplayFilter.Fail.readResolve" title="akka.persistence.journal.ReplayFilter.Fail.type">Fail</a>               ⇒ throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
              case <a href="#akka.persistence.journal.ReplayFilter.Warn.readResolve" title="akka.persistence.journal.ReplayFilter.Warn.type">Warn</a>               ⇒ <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="(x$1: akka.persistence.JournalProtocol.ReplayedMessage)Boolean">add</span><span title="Unit" class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a><span class="delimiter">)</span>
              case <a href="#akka.persistence.journal.ReplayFilter.Disabled.readResolve" title="akka.persistence.journal.ReplayFilter.Disabled.type">Disabled</a>           ⇒ throw new <span title="IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="String(&quot;mode must not be Disabled&quot;)" class="string">&quot;mode must not be Disabled&quot;</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span> else <span class="delimiter">{</span>
            <span class="comment">// note that it is alright with == seqNo, since such may be emitted EventSeq</span>
            <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="(x$1: akka.persistence.JournalProtocol.ReplayedMessage)Boolean">add</span><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a><span class="delimiter">)</span>
            <a href="#akka.persistence.journal;ReplayFilter.seqNo_=" title="(x$1: Long)Unit">seqNo</a> = <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a>
          <span class="delimiter">}</span>

        <span class="delimiter">}</span> else if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.oldWriters" title="=&gt; scala.collection.mutable.LinkedHashSet[String]">oldWriters</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// from old writer</span>
          val errMsg = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Invalid replayed event [&quot;)">Invalid replayed event [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">}</span><span title="String(&quot;] from old &quot;)" class="string">] from old &quot;</span> <span title="String">+</span>
            <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;writer [&quot;)">writer [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a><span class="delimiter">}</span><span title="String(&quot;] with persistenceId [&quot;)">] with persistenceId [$</span><span class="delimiter">{</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">}</span><span title="String(&quot;]&quot;)" class="string">]&quot;</span>
          <a href="#akka.persistence.journal;ReplayFilter.logIssue" title="(errMsg: String)Unit">logIssue</a><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
          <a href="#akka.persistence.journal;ReplayFilter.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> match <span class="delimiter">{</span>
            case <a href="#akka.persistence.journal.ReplayFilter.RepairByDiscardOld.readResolve" title="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.type">RepairByDiscardOld</a> ⇒ <span class="comment">// discard</span>
            case <a href="#akka.persistence.journal.ReplayFilter.Fail.readResolve" title="akka.persistence.journal.ReplayFilter.Fail.type">Fail</a>               ⇒ throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
            case <a href="#akka.persistence.journal.ReplayFilter.Warn.readResolve" title="akka.persistence.journal.ReplayFilter.Warn.type">Warn</a>               ⇒ <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="(x$1: akka.persistence.JournalProtocol.ReplayedMessage)Boolean">add</span><span title="Unit" class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a><span class="delimiter">)</span>
            case <a href="#akka.persistence.journal.ReplayFilter.Disabled.readResolve" title="akka.persistence.journal.ReplayFilter.Disabled.type">Disabled</a>           ⇒ throw new <span title="IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="String(&quot;mode must not be Disabled&quot;)" class="string">&quot;mode must not be Disabled&quot;</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>

        <span class="delimiter">}</span> else <span class="delimiter">{</span>
          <span class="comment">// from new writer</span>
          if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.writerUuid_=" title="=&gt; String">writerUuid</a> <span title="(x$1: Any)Boolean">!=</span> <span title="String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>
            <a href="#akka.persistence.journal;ReplayFilter.oldWriters" title="=&gt; scala.collection.mutable.LinkedHashSet[String]">oldWriters</a>.<span title="(elem: String)Boolean">add</span><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.writerUuid_=" title="=&gt; String">writerUuid</a><span class="delimiter">)</span>
          if <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.oldWriters" title="=&gt; scala.collection.mutable.LinkedHashSet[String]">oldWriters</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <a href="#akka.persistence.journal;ReplayFilter.maxOldWriters" title="Int">maxOldWriters</a><span class="delimiter">)</span>
            <a href="#akka.persistence.journal;ReplayFilter.oldWriters" title="=&gt; scala.collection.mutable.LinkedHashSet[String]">oldWriters</a>.<span title="(elem: String)Boolean">remove</span><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.oldWriters" title="=&gt; scala.collection.mutable.LinkedHashSet[String]">oldWriters</a>.<span title="=&gt; String">head</span><span class="delimiter">)</span>

          <a href="#akka.persistence.journal;ReplayFilter.writerUuid_=" title="(x$1: String)Unit">writerUuid</a> = <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a>
          <a href="#akka.persistence.journal;ReplayFilter.seqNo_=" title="(x$1: Long)Unit">seqNo</a> = <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a>

          <span class="comment">// clear the buffer from messages from other writers with higher seqNo</span>
          val <a title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.iter">iter</a> = <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iterator</span><span class="delimiter">(</span><span class="delimiter">)</span>
          while <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.iter" title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.while$1" title="()Unit" class="delimiter">{</a>
            val <span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span> = <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.iter" title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iter</a>.<span title="()akka.persistence.JournalProtocol.ReplayedMessage">next</span><span class="delimiter">(</span><span class="delimiter">)</span>
            if <span class="delimiter">(</span><span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a> <span title="(x: Long)Boolean">&gt;=</span> <a href="#akka.persistence.journal;ReplayFilter.seqNo_=" title="=&gt; Long">seqNo</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              val errMsg = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Invalid replayed event [&quot;)">Invalid replayed event [$</span><span class="delimiter">{</span><span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">}</span><span title="String(&quot;] in buffer from old &quot;)" class="string">] in buffer from old &quot;</span> <span title="String">+</span>
                <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;writer [&quot;)">writer [$</span><span class="delimiter">{</span><span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.writerUuid" title="=&gt; String">writerUuid</a><span class="delimiter">}</span><span title="String(&quot;] with persistenceId [&quot;)">] with persistenceId [$</span><span class="delimiter">{</span><span title="akka.persistence.JournalProtocol.ReplayedMessage">msg</span>.<a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage.persistent" title="=&gt; akka.persistence.PersistentRepr">persistent</a>.<a href="../Persistent.scala.html#akka.persistence;PersistentRepr.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">}</span><span title="String(&quot;]&quot;)" class="string">]&quot;</span>
              <a href="#akka.persistence.journal;ReplayFilter.logIssue" title="(errMsg: String)Unit">logIssue</a><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
              <a href="#akka.persistence.journal;ReplayFilter.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> match <span class="delimiter">{</span>
                case <a href="#akka.persistence.journal.ReplayFilter.RepairByDiscardOld.readResolve" title="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.type">RepairByDiscardOld</a> ⇒ <a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.iter" title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iter</a>.<span title="()Unit">remove</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// discard</span>
                case <a href="#akka.persistence.journal.ReplayFilter.Fail.readResolve" title="akka.persistence.journal.ReplayFilter.Fail.type">Fail</a>               ⇒ throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String">errMsg</span><span class="delimiter">)</span>
                case <a href="#akka.persistence.journal.ReplayFilter.Warn.readResolve" title="akka.persistence.journal.ReplayFilter.Warn.type">Warn</a>               ⇒ <span class="comment">// keep</span>
                case <a href="#akka.persistence.journal.ReplayFilter.Disabled.readResolve" title="akka.persistence.journal.ReplayFilter.Disabled.type">Disabled</a>           ⇒ throw new <span title="IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="String(&quot;mode must not be Disabled&quot;)" class="string">&quot;mode must not be Disabled&quot;</span><span class="delimiter">)</span>
              <span class="delimiter">}</span>

            <span class="delimiter">}</span>
          <span class="delimiter">}</span>

          <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="(x$1: akka.persistence.JournalProtocol.ReplayedMessage)Boolean">add</span><span title="Unit" class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.r" title="akka.persistence.JournalProtocol.ReplayedMessage">r</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>

      <span class="delimiter">}</span> catch <span class="delimiter">{</span>
        case <a title="IllegalStateException" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.e">e</a>: <span title="IllegalStateException">IllegalStateException</span> if <a href="#akka.persistence.journal;ReplayFilter.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> <span title="(x$1: Any)Boolean">==</span> <a href="#akka.persistence.journal.ReplayFilter.Fail.readResolve" title="akka.persistence.journal.ReplayFilter.Fail.type">Fail</a> ⇒ <a href="#akka.persistence.journal;ReplayFilter.fail" title="(cause: IllegalStateException)Unit">fail</a><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.receive;$anonfun.applyOrElse.e" title="IllegalStateException">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>

    case <a title="Any" id="akka.persistence.journal;ReplayFilter.receive;$anonfun.isDefinedAt.msg">msg</a> @ <span class="delimiter">(</span>_: <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;RecoverySuccess" title="akka.persistence.JournalProtocol.RecoverySuccess">RecoverySuccess</a> | _: <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayMessagesFailure" title="akka.persistence.JournalProtocol.ReplayMessagesFailure">ReplayMessagesFailure</a><span class="delimiter">)</span> ⇒
      <a href="#akka.persistence.journal;ReplayFilter.sendBuffered" title="()Unit">sendBuffered</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#akka.persistence.journal;ReplayFilter.persistentActor" title="akka.actor.ActorRef">persistentActor</a>.<a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef.tell" title="(msg: Any, sender: akka.actor.ActorRef)Unit">tell</a><span class="delimiter">(</span><span title="Any">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor" title="akka.actor.Actor.type">Actor</a>.<a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor.noSender" title="=&gt; akka.actor.ActorRef">noSender</a><span class="delimiter">)</span>
      <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorRefProvider.scala.html#akka.actor;ActorRefFactory.stop" title="(actor: akka.actor.ActorRef)Unit">stop</a><span class="delimiter">(</span><a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="akka.persistence.journal;ReplayFilter.sendBuffered">sendBuffered</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    val <a title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]" id="akka.persistence.journal;ReplayFilter.sendBuffered.iter">iter</a> = <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iterator</span><span class="delimiter">(</span><span class="delimiter">)</span>
    while <span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.sendBuffered.iter" title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iter</a>.<span title="()Boolean">hasNext</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#akka.persistence.journal;ReplayFilter.persistentActor" title="akka.actor.ActorRef">persistentActor</a>.<a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef.tell" title="(msg: Any, sender: akka.actor.ActorRef)Unit">tell</a><a href="#akka.persistence.journal;ReplayFilter.sendBuffered.while$2" title="()Unit" class="delimiter">(</a><a href="#akka.persistence.journal;ReplayFilter.sendBuffered.iter" title="java.util.Iterator[akka.persistence.JournalProtocol.ReplayedMessage]">iter</a>.<span title="()akka.persistence.JournalProtocol.ReplayedMessage">next</span><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor" title="akka.actor.Actor.type">Actor</a>.<a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor.noSender" title="=&gt; akka.actor.ActorRef">noSender</a><span class="delimiter">)</span>
    <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(errMsg: String)Unit" id="akka.persistence.journal;ReplayFilter.logIssue">logIssue</a><span class="delimiter">(</span><a title="String" id="akka.persistence.journal;ReplayFilter.logIssue.errMsg">errMsg</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.persistence.journal;ReplayFilter.mode" title="akka.persistence.journal.ReplayFilter.Mode">mode</a> match <span class="delimiter">{</span>
    case <a href="#akka.persistence.journal.ReplayFilter.Warn.readResolve" title="akka.persistence.journal.ReplayFilter.Warn.type">Warn</a> | <a href="#akka.persistence.journal.ReplayFilter.RepairByDiscardOld.readResolve" title="akka.persistence.journal.ReplayFilter.RepairByDiscardOld.type">RepairByDiscardOld</a> ⇒ <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;ActorLogging.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(cc2e600322)" title="(message: String)Unit">warning</a><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.logIssue.errMsg" title="String">errMsg</a><span class="delimiter">)</span>
    case <a href="#akka.persistence.journal.ReplayFilter.Fail.readResolve" title="akka.persistence.journal.ReplayFilter.Fail.type">Fail</a>                      ⇒ <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;ActorLogging.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.error(cc2e600322)" title="(message: String)Unit">error</a><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.logIssue.errMsg" title="String">errMsg</a><span class="delimiter">)</span>
    case <a href="#akka.persistence.journal.ReplayFilter.Disabled.readResolve" title="akka.persistence.journal.ReplayFilter.Disabled.type">Disabled</a>                  ⇒ throw new <span title="IllegalArgumentException">IllegalArgumentException</span><span class="delimiter">(</span><span title="String(&quot;mode must not be Disabled&quot;)" class="string">&quot;mode must not be Disabled&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(cause: IllegalStateException)Unit" id="akka.persistence.journal;ReplayFilter.fail">fail</a><span class="delimiter">(</span><a title="IllegalStateException" id="akka.persistence.journal;ReplayFilter.fail.cause">cause</a>: <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence.journal;ReplayFilter.buffer" title="=&gt; java.util.LinkedList[akka.persistence.JournalProtocol.ReplayedMessage]">buffer</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#akka.persistence.journal;ReplayFilter.persistentActor" title="akka.actor.ActorRef">persistentActor</a>.<a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef.tell" title="(msg: Any, sender: akka.actor.ActorRef)Unit">tell</a><span class="delimiter">(</span><a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayMessagesFailure" title="(cause: Throwable)akka.persistence.JournalProtocol.ReplayMessagesFailure">ReplayMessagesFailure</a><span class="delimiter">(</span><a href="#akka.persistence.journal;ReplayFilter.fail.cause" title="IllegalStateException">cause</a><span class="delimiter">)</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor" title="akka.actor.Actor.type">Actor</a>.<a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor.Actor.noSender" title="=&gt; akka.actor.ActorRef">noSender</a><span class="delimiter">)</span>
    <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.become(07b70b901c)" title="(behavior: akka.actor.Actor.Receive)Unit">become</a> <a title="&lt;$anon: Any =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[Any,Unit] with Serializable" id="akka.persistence.journal;ReplayFilter.fail;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
      case _: <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage" title="akka.persistence.JournalProtocol.ReplayedMessage">ReplayedMessage</a> ⇒ <span class="comment">// discard</span>
      case <a title="Any" id="akka.persistence.journal;ReplayFilter.fail;$anonfun.isDefinedAt.msg">msg</a> @ <span class="delimiter">(</span>_: <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;RecoverySuccess" title="akka.persistence.JournalProtocol.RecoverySuccess">RecoverySuccess</a> | _: <a href="../JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayMessagesFailure" title="akka.persistence.JournalProtocol.ReplayMessagesFailure">ReplayMessagesFailure</a><span class="delimiter">)</span> ⇒
        <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorRefProvider.scala.html#akka.actor;ActorRefFactory.stop" title="(actor: akka.actor.ActorRef)Unit">stop</a><span title="Boolean(true)" class="delimiter">(</span><a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
