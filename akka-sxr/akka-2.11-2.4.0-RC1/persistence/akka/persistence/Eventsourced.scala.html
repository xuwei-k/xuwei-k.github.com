<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>persistence/akka/persistence/Eventsourced.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2009-2015 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>

package akka.persistence

import java.util.concurrent.atomic.AtomicInteger
import scala.collection.immutable
import scala.util.control.NonFatal
import akka.actor.Stash
import akka.actor.StashFactory
import akka.event.Logging
import akka.event.LoggingAdapter
import akka.actor.ActorRef
import java.util.UUID

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>persistence<span class="delimiter">]</span> object <a title="akka.persistence.Eventsourced.type" id="akka.persistence.Eventsourced">Eventsourced</a> <a href="#akka.persistence.Eventsourced" title="akka.persistence.Eventsourced.type" class="delimiter">{</a>
  <span class="comment">// ok to wrap around (2*Int.MaxValue restarts will not happen within a journal roundtrip)</span>
  private val <a title="java.util.concurrent.atomic.AtomicInteger" id="akka.persistence.Eventsourced.instanceIdCounter">instanceIdCounter</a> = new <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

  private sealed trait <a title="trait PendingHandlerInvocation extends AnyRef" id="akka.persistence.Eventsourced;PendingHandlerInvocation">PendingHandlerInvocation</a> <span class="delimiter">{</span>
    def <a title="=&gt; Any" id="akka.persistence.Eventsourced;PendingHandlerInvocation.evt">evt</a>: <span title="Any">Any</span>
    def <a title="=&gt; Any =&gt; Unit" id="akka.persistence.Eventsourced;PendingHandlerInvocation.handler">handler</a>: Any ⇒ Unit
  <span class="delimiter">}</span>
  <span class="comment">/** forces actor to stash incoming commands until all these invocations are handled */</span>
  private final case class <a title="class StashingHandlerInvocation extends AnyRef with akka.persistence.Eventsourced.PendingHandlerInvocation with Product with Serializable" id="akka.persistence.Eventsourced.StashingHandlerInvocation.readResolve">StashingHandlerInvocation</a><span title="Product" class="delimiter">(</span><a title="Any" id="akka.persistence.Eventsourced;StashingHandlerInvocation.evt">evt</a>: <span title="Any">Any</span>, <a title="Any =&gt; Unit" id="akka.persistence.Eventsourced;StashingHandlerInvocation.handler">handler</a>: Any ⇒ Unit<span class="delimiter">)</span> extends <a href="#akka.persistence.Eventsourced;PendingHandlerInvocation" title="akka.persistence.Eventsourced.PendingHandlerInvocation">PendingHandlerInvocation</a>
  <span class="comment">/** does not force the actor to stash commands; Originates from either `persistAsync` or `defer` calls */</span>
  private final case class <a title="class AsyncHandlerInvocation extends AnyRef with akka.persistence.Eventsourced.PendingHandlerInvocation with Product with Serializable" id="akka.persistence.Eventsourced.AsyncHandlerInvocation.readResolve">AsyncHandlerInvocation</a><span title="Product" class="delimiter">(</span><a title="Any" id="akka.persistence.Eventsourced;AsyncHandlerInvocation.evt">evt</a>: <span title="Any">Any</span>, <a title="Any =&gt; Unit" id="akka.persistence.Eventsourced;AsyncHandlerInvocation.handler">handler</a>: Any ⇒ Unit<span class="delimiter">)</span> extends <a href="#akka.persistence.Eventsourced;PendingHandlerInvocation" title="akka.persistence.Eventsourced.PendingHandlerInvocation">PendingHandlerInvocation</a>
<span class="delimiter">}</span>

<span class="comment">/**
 * INTERNAL API.
 *
 * Scala API and implementation details of [[PersistentActor]], [[AbstractPersistentActor]] and
 * [[UntypedPersistentActor]].
 */</span>
private<span class="delimiter">[</span>persistence<span class="delimiter">]</span> trait <a title="trait Eventsourced extends AnyRef with akka.persistence.Snapshotter with akka.actor.Stash with akka.actor.StashFactory with akka.persistence.PersistenceIdentity with akka.persistence.PersistenceRecovery" id="akka.persistence;Eventsourced">Eventsourced</a> extends <a href="Snapshotter.scala.html#akka.persistence;Snapshotter" title="akka.persistence.Snapshotter">Snapshotter</a> with <a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;Stash" title="akka.actor.Stash">Stash</a> with <a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashFactory" title="akka.actor.StashFactory">StashFactory</a> with <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity" title="akka.persistence.PersistenceIdentity">PersistenceIdentity</a> with <a href="Persistence.scala.html#akka.persistence;PersistenceRecovery" title="akka.persistence.PersistenceRecovery">PersistenceRecovery</a> <span class="delimiter">{</span>
  import <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol" title="akka.persistence.JournalProtocol.type">JournalProtocol</a>._
  import <a href="SnapshotProtocol.scala.html#akka.persistence.SnapshotProtocol" title="akka.persistence.SnapshotProtocol.type">SnapshotProtocol</a>.LoadSnapshotResult
  import <a href="#akka.persistence.Eventsourced" title="akka.persistence.Eventsourced.type">Eventsourced</a>._

  private val <a title="akka.persistence.Persistence" id="akka.persistence;Eventsourced.extension">extension</a> = <a href="../../../actor/akka/actor/Extension.scala.html#akka.actor;ExtensionId.apply" title="(system: akka.actor.ActorSystem)akka.persistence.Persistence">Persistence</a><span class="delimiter">(</span><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.system" title="=&gt; akka.actor.ActorSystem">system</a><span class="delimiter">)</span>

  private<span class="delimiter">[</span>persistence<span class="delimiter">]</span> lazy val <a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.journal">journal</a> = <a href="#akka.persistence;Eventsourced.extension" title="=&gt; akka.persistence.Persistence">extension</a>.<a href="Persistence.scala.html#akka.persistence;Persistence.journalFor" title="(journalPluginId: String)akka.actor.ActorRef">journalFor</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.journalPluginId" title="=&gt; String">journalPluginId</a><span class="delimiter">)</span>
  private<span class="delimiter">[</span>persistence<span class="delimiter">]</span> lazy val <a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.snapshotStore">snapshotStore</a> = <a href="#akka.persistence;Eventsourced.extension" title="=&gt; akka.persistence.Persistence">extension</a>.<a href="Persistence.scala.html#akka.persistence;Persistence.snapshotStoreFor" title="(snapshotPluginId: String)akka.actor.ActorRef">snapshotStoreFor</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.snapshotPluginId" title="=&gt; String">snapshotPluginId</a><span class="delimiter">)</span>

  private val <a title="Int" id="akka.persistence;Eventsourced.instanceId">instanceId</a>: <span title="Int">Int</span> = <a href="#akka.persistence.Eventsourced" title="akka.persistence.Eventsourced.type">Eventsourced</a>.<a href="#akka.persistence.Eventsourced.instanceIdCounter" title="=&gt; java.util.concurrent.atomic.AtomicInteger">instanceIdCounter</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">(</span><span class="delimiter">)</span>
  private val <a title="String" id="akka.persistence;Eventsourced.writerUuid">writerUuid</a> = <span title="java.util.UUID.type">UUID</span>.<span title="()java.util.UUID">randomUUID</span>.<span title="()String">toString</span>

  private var <a title="scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]" id="akka.persistence;Eventsourced.journalBatch_=">journalBatch</a> = <span title="=&gt; collection.immutable.Vector.type">Vector</span>.<span title="[A]=&gt; scala.collection.immutable.Vector[A]">empty</span><span title="scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]" class="delimiter">[</span><a href="Persistent.scala.html#akka.persistence;PersistentEnvelope" title="akka.persistence.PersistentEnvelope">PersistentEnvelope</a><span class="delimiter">]</span>
  private val <a title="Int" id="akka.persistence;Eventsourced.maxMessageBatchSize">maxMessageBatchSize</a> = <a href="#akka.persistence;Eventsourced.extension" title="=&gt; akka.persistence.Persistence">extension</a>.<a href="Persistence.scala.html#akka.persistence;Persistence.journalConfigFor" title="(journalPluginId: String)com.typesafe.config.Config">journalConfigFor</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.journalPluginId" title="=&gt; String">journalPluginId</a><span class="delimiter">)</span>.<span title="(x$1: String)Int">getInt</span><span class="delimiter">(</span><span title="String(&quot;max-message-batch-size&quot;)" class="string">&quot;max-message-batch-size&quot;</span><span class="delimiter">)</span>
  private var <a title="Boolean" id="akka.persistence;Eventsourced.writeInProgress_=">writeInProgress</a> = false
  private var <a title="Long" id="akka.persistence;Eventsourced.sequenceNr_=">sequenceNr</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="long">0L</span>
  private var <a title="Long" id="akka.persistence;Eventsourced._lastSequenceNr_=">_lastSequenceNr</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="long">0L</span>

  <span class="comment">// safely null because we initialize it with a proper `recoveryStarted` state in aroundPreStart before any real action happens</span>
  private var <a title="Eventsourced.this.State" id="akka.persistence;Eventsourced.currentState_=">currentState</a>: <a href="#akka.persistence;Eventsourced;State" title="Eventsourced.this.State">State</a> = null

  <span class="comment">// Used instead of iterating `pendingInvocations` in order to check if safe to revert to processing commands</span>
  private var <a title="Long" id="akka.persistence;Eventsourced.pendingStashingPersistInvocations_=">pendingStashingPersistInvocations</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="int">0</span>
  <span class="comment">// Holds user-supplied callbacks for persist/persistAsync calls</span>
  private val <a title="java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]" id="akka.persistence;Eventsourced.pendingInvocations">pendingInvocations</a> = new java.util.<span title="java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">LinkedList</span><span class="delimiter">[</span>PendingHandlerInvocation<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// we only append / isEmpty / get(0) on it</span>
  private var <a title="List[akka.persistence.PersistentEnvelope]" id="akka.persistence;Eventsourced.eventBatch_=">eventBatch</a>: <span title="List[akka.persistence.PersistentEnvelope]">List</span><span class="delimiter">[</span>PersistentEnvelope<span class="delimiter">]</span> = <span title="scala.collection.immutable.Nil.type">Nil</span>

  private val <a title="akka.actor.StashSupport" id="akka.persistence;Eventsourced.internalStash">internalStash</a> = <a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashFactory.createStash" title="()(implicit ctx: akka.actor.ActorContext, implicit ref: akka.actor.ActorRef)akka.actor.StashSupport">createStash</a><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext" class="delimiter">(</a><span class="delimiter">)</span>

  private val <a title="Any =&gt; Boolean" id="akka.persistence;Eventsourced.unstashFilterPredicate">unstashFilterPredicate</a>: Any ⇒ Boolean = <a href="#akka.persistence;Eventsourced.unstashFilterPredicate.$anonfun.x0$1" title="Boolean" class="delimiter">{</a>
    case _: <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol;WriteMessageSuccess" title="akka.persistence.JournalProtocol.WriteMessageSuccess">WriteMessageSuccess</a> ⇒ false
    case _: <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayedMessage" title="akka.persistence.JournalProtocol.ReplayedMessage">ReplayedMessage</a>     ⇒ false
    case _                      ⇒ true
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns `persistenceId`.
   */</span>
  override def <a title="=&gt; String" id="akka.persistence;Eventsourced.snapshotterId">snapshotterId</a>: <span title="String">String</span> = <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>

  <span class="comment">/**
   * Highest received sequence number so far or `0L` if this actor hasn't replayed
   * or stored any persistent events yet.
   */</span>
  def <a title="=&gt; Long" id="akka.persistence;Eventsourced.lastSequenceNr">lastSequenceNr</a>: <span title="Long">Long</span> = <a href="#akka.persistence;Eventsourced._lastSequenceNr_=" title="=&gt; Long">_lastSequenceNr</a>

  <span class="comment">/**
   * Returns `lastSequenceNr`.
   */</span>
  def <a title="=&gt; Long" id="akka.persistence;Eventsourced.snapshotSequenceNr">snapshotSequenceNr</a>: <span title="Long">Long</span> = <a href="#akka.persistence;Eventsourced.lastSequenceNr" title="=&gt; Long">lastSequenceNr</a>

  <span class="comment">/**
   * INTERNAL API.
   * Called whenever a message replay succeeds.
   * May be implemented by subclass.
   */</span>
  private<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="()Unit" id="akka.persistence;Eventsourced.onReplaySuccess">onReplaySuccess</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Called whenever a message replay fails. By default it logs the error.
   *
   * Subclass may override to customize logging.
   *
   * The actor is always stopped after this method has been invoked.
   *
   * @param cause failure cause.
   * @param event the event that was processed in `receiveRecover`, if the exception
   *   was thrown there
   */</span>
  protected def <a title="(cause: Throwable, event: Option[Any])Unit" id="akka.persistence;Eventsourced.onRecoveryFailure">onRecoveryFailure</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.onRecoveryFailure.cause">cause</a>: <span title="Throwable">Throwable</span>, <a title="Option[Any]" id="akka.persistence;Eventsourced.onRecoveryFailure.event">event</a>: <span title="Option[Any]">Option</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence;Eventsourced.onRecoveryFailure.event" title="Option[Any]">event</a> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="Any" id="akka.persistence;Eventsourced.onRecoveryFailure.evt">evt</a><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.error(3055b9c9d1)" title="(cause: Throwable, template: String, arg1: Any, arg2: Any, arg3: Any)Unit">error</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.onRecoveryFailure.cause" title="Throwable">cause</a>, <span class="string">&quot;Exception in receiveRecover when replaying event type [{}] with sequence number [{}] for &quot;</span> <span title="String(&quot;Exception in receiveRecover when replaying event type [{}] with sequence number [{}] for persistenceId [{}].&quot;)">+</span>
          <span class="string">&quot;persistenceId [{}].&quot;</span>, <a href="#akka.persistence;Eventsourced.onRecoveryFailure.evt" title="Any">evt</a>.<span title="()Class[_]">getClass</span>.<span title="()String">getName</span>, <a href="#akka.persistence;Eventsourced.lastSequenceNr" title="=&gt; Long">lastSequenceNr</a>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">)</span>
      case <span title="None.type">None</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.error(41f64575e3)" title="(cause: Throwable, template: String, arg1: Any, arg2: Any)Unit">error</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.onRecoveryFailure.cause" title="Throwable">cause</a>, <span class="string">&quot;Persistence failure when replaying events for persistenceId [{}]. &quot;</span> <span title="String(&quot;Persistence failure when replaying events for persistenceId [{}]. Last known sequence number [{}]&quot;)">+</span>
          <span class="string">&quot;Last known sequence number [{}]&quot;</span>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>, <a href="#akka.persistence;Eventsourced.lastSequenceNr" title="=&gt; Long">lastSequenceNr</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

  <span class="comment">/**
   * Called when persist fails. By default it logs the error.
   * Subclass may override to customize logging and for example send negative
   * acknowledgment to sender.
   *
   * The actor is always stopped after this method has been invoked.
   *
   * Note that the event may or may not have been saved, depending on the type of
   * failure.
   *
   * @param cause failure cause.
   * @param event the event that was to be persisted
   */</span>
  protected def <a title="(cause: Throwable, event: Any, seqNr: Long)Unit" id="akka.persistence;Eventsourced.onPersistFailure">onPersistFailure</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.onPersistFailure.cause">cause</a>: <span title="Throwable">Throwable</span>, <a title="Any" id="akka.persistence;Eventsourced.onPersistFailure.event">event</a>: <span title="Any">Any</span>, <a title="Long" id="akka.persistence;Eventsourced.onPersistFailure.seqNr">seqNr</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.error(3055b9c9d1)" title="(cause: Throwable, template: String, arg1: Any, arg2: Any, arg3: Any)Unit">error</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.onPersistFailure.cause" title="Throwable">cause</a>, <span title="String(&quot;Failed to persist event type [{}] with sequence number [{}] for persistenceId [{}].&quot;)" class="string">&quot;Failed to persist event type [{}] with sequence number [{}] for persistenceId [{}].&quot;</span>,
      <a href="#akka.persistence;Eventsourced.onPersistFailure.event" title="Any">event</a>.<span title="()Class[_]">getClass</span>.<span title="()String">getName</span>, <a href="#akka.persistence;Eventsourced.onPersistFailure.seqNr" title="Long">seqNr</a>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Called when the journal rejected `persist` of an event. The event was not
   * stored. By default this method logs the problem as a warning, and the actor continues.
   * The callback handler that was passed to the `persist` method will not be invoked.
   *
   * @param cause failure cause
   * @param event the event that was to be persisted
   */</span>
  protected def <a title="(cause: Throwable, event: Any, seqNr: Long)Unit" id="akka.persistence;Eventsourced.onPersistRejected">onPersistRejected</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.onPersistRejected.cause">cause</a>: <span title="Throwable">Throwable</span>, <a title="Any" id="akka.persistence;Eventsourced.onPersistRejected.event">event</a>: <span title="Any">Any</span>, <a title="Long" id="akka.persistence;Eventsourced.onPersistRejected.seqNr">seqNr</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(2f8315b3c9)" title="(template: String, arg1: Any, arg2: Any, arg3: Any, arg4: Any)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Rejected to persist event type [{}] with sequence number [{}] for persistenceId [{}] due to [{}].&quot;)" class="string">&quot;Rejected to persist event type [{}] with sequence number [{}] for persistenceId [{}] due to [{}].&quot;</span>,
      <a href="#akka.persistence;Eventsourced.onPersistRejected.event" title="Any">event</a>.<span title="()Class[_]">getClass</span>.<span title="()String">getName</span>, <a href="#akka.persistence;Eventsourced.onPersistRejected.seqNr" title="Long">seqNr</a>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>, <a href="#akka.persistence;Eventsourced.onPersistRejected.cause" title="Throwable">cause</a>.<span title="()String">getMessage</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="(recovery: akka.persistence.Recovery)Unit" id="akka.persistence;Eventsourced.startRecovery">startRecovery</a><span class="delimiter">(</span><a title="akka.persistence.Recovery" id="akka.persistence;Eventsourced.startRecovery.recovery">recovery</a>: <a href="PersistentActor.scala.html#akka.persistence;Recovery" title="akka.persistence.Recovery">Recovery</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.changeState" title="(state: Eventsourced.this.State)Unit">changeState</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted" title="(replayMax: Long)Eventsourced.this.State">recoveryStarted</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.startRecovery.recovery" title="akka.persistence.Recovery">recovery</a>.<a href="PersistentActor.scala.html#akka.persistence;Recovery.replayMax" title="=&gt; Long">replayMax</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="Snapshotter.scala.html#akka.persistence;Snapshotter.loadSnapshot" title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria, toSequenceNr: Long)Unit">loadSnapshot</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.snapshotterId" title="=&gt; String">snapshotterId</a>, <a href="#akka.persistence;Eventsourced.startRecovery.recovery" title="akka.persistence.Recovery">recovery</a>.<a href="PersistentActor.scala.html#akka.persistence;Recovery.fromSnapshot" title="=&gt; akka.persistence.SnapshotSelectionCriteria">fromSnapshot</a>, <a href="#akka.persistence;Eventsourced.startRecovery.recovery" title="akka.persistence.Recovery">recovery</a>.<a href="PersistentActor.scala.html#akka.persistence;Recovery.toSequenceNr" title="=&gt; Long">toSequenceNr</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** INTERNAL API. */</span>
  override protected<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced.aroundReceive">aroundReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.aroundReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced.aroundReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence;Eventsourced.currentState_=" title="=&gt; Eventsourced.this.State">currentState</a>.<a href="#akka.persistence;Eventsourced;State.stateReceive" title="(receive: Eventsourced.this.Receive, message: Any)Unit">stateReceive</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundReceive.receive" title="Eventsourced.this.Receive">receive</a>, <a href="#akka.persistence;Eventsourced.aroundReceive.message" title="Any">message</a><span class="delimiter">)</span>

  <span class="comment">/** INTERNAL API. */</span>
  override protected<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="()Unit" id="akka.persistence;Eventsourced.aroundPreStart">aroundPreStart</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <span class="comment">// Fail fast on missing plugins.</span>
    val <a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.aroundPreStart.j">j</a> = <a href="#akka.persistence;Eventsourced.journal" title="=&gt; akka.actor.ActorRef">journal</a>; val <a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.aroundPreStart.s">s</a> = <a href="#akka.persistence;Eventsourced.snapshotStore" title="=&gt; akka.actor.ActorRef">snapshotStore</a>
    <a href="#akka.persistence;Eventsourced.startRecovery" title="(recovery: akka.persistence.Recovery)Unit">startRecovery</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceRecovery.recovery" title="=&gt; akka.persistence.Recovery">recovery</a><span class="delimiter">)</span>
    super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPreStart" title="()Unit">aroundPreStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** INTERNAL API. */</span>
  override protected<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="(reason: Throwable, message: Option[Any])Unit" id="akka.persistence;Eventsourced.aroundPreRestart">aroundPreRestart</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.aroundPreRestart.reason">reason</a>: <span title="Throwable">Throwable</span>, <a title="Option[Any]" id="akka.persistence;Eventsourced.aroundPreRestart.message">message</a>: <span title="Option[Any]">Option</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(aa97cb1b3d)" title="()Unit">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(11538b75a6)" title="(filterPredicate: Any =&gt; Boolean)Unit">unstashAll</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.unstashFilterPredicate" title="=&gt; Any =&gt; Boolean">unstashFilterPredicate</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> finally <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.aroundPreRestart.message" title="Option[Any]">message</a> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span>WriteMessageSuccess<span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">m</span>, _<span class="delimiter">)</span><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
          super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPreRestart" title="(reason: Throwable, message: Option[Any])Unit">aroundPreRestart</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundPreRestart.reason" title="Throwable">reason</a>, <span title="(x: akka.persistence.PersistentRepr)Some[akka.persistence.PersistentRepr]">Some</span><span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">m</span><span class="delimiter">)</span><span class="delimiter">)</span>
        case Some<span class="delimiter">(</span>LoopMessageSuccess<span class="delimiter">(</span><span title="Any">m</span>, _<span class="delimiter">)</span><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
          super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPreRestart" title="(reason: Throwable, message: Option[Any])Unit">aroundPreRestart</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundPreRestart.reason" title="Throwable">reason</a>, <span title="(x: Any)Some[Any]">Some</span><span class="delimiter">(</span><span title="Any">m</span><span class="delimiter">)</span><span class="delimiter">)</span>
        case Some<span class="delimiter">(</span>ReplayedMessage<span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">m</span><span class="delimiter">)</span><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
          super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPreRestart" title="(reason: Throwable, message: Option[Any])Unit">aroundPreRestart</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundPreRestart.reason" title="Throwable">reason</a>, <span title="(x: akka.persistence.PersistentRepr)Some[akka.persistence.PersistentRepr]">Some</span><span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">m</span><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a title="Option[Any]" id="akka.persistence;Eventsourced.aroundPreRestart.mo">mo</a> ⇒
          <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
          super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPreRestart" title="(reason: Throwable, message: Option[Any])Unit">aroundPreRestart</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundPreRestart.reason" title="Throwable">reason</a>, <span title="None.type">None</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/** INTERNAL API. */</span>
  override protected<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="(reason: Throwable)Unit" id="akka.persistence;Eventsourced.aroundPostRestart">aroundPostRestart</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.aroundPostRestart.reason">reason</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.startRecovery" title="(recovery: akka.persistence.Recovery)Unit">startRecovery</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceRecovery.recovery" title="=&gt; akka.persistence.Recovery">recovery</a><span class="delimiter">)</span>
    super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPostRestart" title="(reason: Throwable)Unit">aroundPostRestart</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.aroundPostRestart.reason" title="Throwable">reason</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/** INTERNAL API. */</span>
  override protected<span class="delimiter">[</span>akka<span class="delimiter">]</span> def <a title="()Unit" id="akka.persistence;Eventsourced.aroundPostStop">aroundPostStop</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    try <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(aa97cb1b3d)" title="()Unit">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(11538b75a6)" title="(filterPredicate: Any =&gt; Boolean)Unit">unstashAll</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.unstashFilterPredicate" title="=&gt; Any =&gt; Boolean">unstashFilterPredicate</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> finally super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundPostStop" title="()Unit">aroundPostStop</a><span class="delimiter">(</span><span class="delimiter">)</span>

  override def <a title="(message: Any)Unit" id="akka.persistence;Eventsourced.unhandled">unhandled</a><span class="delimiter">(</span><a title="Any" id="akka.persistence;Eventsourced.unhandled.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.unhandled.message" title="Any">message</a> match <span class="delimiter">{</span>
      case <a href="PersistentActor.scala.html#akka.persistence.RecoveryCompleted" title="akka.persistence.RecoveryCompleted.type">RecoveryCompleted</a> ⇒ <span class="comment">// mute</span>
      case SaveSnapshotFailure<span class="delimiter">(</span><span title="akka.persistence.SnapshotMetadata">m</span>, <span title="Throwable">e</span><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(6c666e4343)" title="(template: String, arg1: Any, arg2: Any, arg3: Any)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Failed to saveSnapshot given metadata [{}] due to: [{}: {}]&quot;)" class="string">&quot;Failed to saveSnapshot given metadata [{}] due to: [{}: {}]&quot;</span>, <span title="akka.persistence.SnapshotMetadata">m</span>, <span title="Throwable">e</span>.<span title="()Class[_]">getClass</span>.<span title="()String">getCanonicalName</span>, <span title="Throwable">e</span>.<span title="()String">getMessage</span><span class="delimiter">)</span>
      case DeleteSnapshotFailure<span class="delimiter">(</span><span title="akka.persistence.SnapshotMetadata">m</span>, <span title="Throwable">e</span><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(6c666e4343)" title="(template: String, arg1: Any, arg2: Any, arg3: Any)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Failed to deleteSnapshot given metadata [{}] due to: [{}: {}]&quot;)" class="string">&quot;Failed to deleteSnapshot given metadata [{}] due to: [{}: {}]&quot;</span>, <span title="akka.persistence.SnapshotMetadata">m</span>, <span title="Throwable">e</span>.<span title="()Class[_]">getClass</span>.<span title="()String">getCanonicalName</span>, <span title="Throwable">e</span>.<span title="()String">getMessage</span><span class="delimiter">)</span>
      case DeleteSnapshotsFailure<span class="delimiter">(</span><a title="akka.persistence.SnapshotSelectionCriteria" id="akka.persistence;Eventsourced.unhandled.c">c</a>, <span title="Throwable">e</span><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(6c666e4343)" title="(template: String, arg1: Any, arg2: Any, arg3: Any)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Failed to deleteSnapshots given criteria [{}] due to: [{}: {}]&quot;)" class="string">&quot;Failed to deleteSnapshots given criteria [{}] due to: [{}: {}]&quot;</span>, <a href="#akka.persistence;Eventsourced.unhandled.c" title="akka.persistence.SnapshotSelectionCriteria">c</a>, <span title="Throwable">e</span>.<span title="()Class[_]">getClass</span>.<span title="()String">getCanonicalName</span>, <span title="Throwable">e</span>.<span title="()String">getMessage</span><span class="delimiter">)</span>
      case DeleteMessagesFailure<span class="delimiter">(</span><span title="Throwable">e</span>, <a title="Long" id="akka.persistence;Eventsourced.unhandled.toSequenceNr">toSequenceNr</a><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.warning(2f8315b3c9)" title="(template: String, arg1: Any, arg2: Any, arg3: Any, arg4: Any)Unit">warning</a><span class="delimiter">(</span><span title="String(&quot;Failed to deleteMessages toSequenceNr [{}] for persistenceId [{}] due to [{}: {}].&quot;)" class="string">&quot;Failed to deleteMessages toSequenceNr [{}] for persistenceId [{}] due to [{}: {}].&quot;</span>,
          <a href="#akka.persistence;Eventsourced.unhandled.toSequenceNr" title="Long">toSequenceNr</a>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>, <span title="Throwable">e</span>.<span title="()Class[_]">getClass</span>.<span title="()String">getCanonicalName</span>, <span title="Throwable">e</span>.<span title="()String">getMessage</span><span class="delimiter">)</span>
      case <span title="Any">m</span> ⇒ super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.unhandled" title="(message: Any)Unit">unhandled</a><span class="delimiter">(</span><span title="Any">m</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(state: Eventsourced.this.State)Unit" id="akka.persistence;Eventsourced.changeState">changeState</a><span class="delimiter">(</span><a title="Eventsourced.this.State" id="akka.persistence;Eventsourced.changeState.state">state</a>: <a href="#akka.persistence;Eventsourced;State" title="Eventsourced.this.State">State</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.currentState_=" title="(x$1: Eventsourced.this.State)Unit">currentState</a> = <a href="#akka.persistence;Eventsourced.changeState.state" title="Eventsourced.this.State">state</a>
  <span class="delimiter">}</span>

  private def <a title="(persistent: akka.persistence.PersistentRepr)Unit" id="akka.persistence;Eventsourced.updateLastSequenceNr">updateLastSequenceNr</a><span class="delimiter">(</span><a title="akka.persistence.PersistentRepr" id="akka.persistence;Eventsourced.updateLastSequenceNr.persistent">persistent</a>: <a href="Persistent.scala.html#akka.persistence;PersistentRepr" title="akka.persistence.PersistentRepr">PersistentRepr</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.updateLastSequenceNr.persistent" title="akka.persistence.PersistentRepr">persistent</a>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a> <span title="(x: Long)Boolean">&gt;</span> <a href="#akka.persistence;Eventsourced._lastSequenceNr_=" title="=&gt; Long">_lastSequenceNr</a><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced._lastSequenceNr_=" title="(x$1: Long)Unit">_lastSequenceNr</a> = <a href="#akka.persistence;Eventsourced.updateLastSequenceNr.persistent" title="akka.persistence.PersistentRepr">persistent</a>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a>

  private def <a title="(value: Long)Unit" id="akka.persistence;Eventsourced.setLastSequenceNr">setLastSequenceNr</a><span class="delimiter">(</span><a title="Long" id="akka.persistence;Eventsourced.setLastSequenceNr.value">value</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence;Eventsourced._lastSequenceNr_=" title="(x$1: Long)Unit">_lastSequenceNr</a> = <a href="#akka.persistence;Eventsourced.setLastSequenceNr.value" title="Long">value</a>

  private def <a title="()Long" id="akka.persistence;Eventsourced.nextSequenceNr">nextSequenceNr</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.sequenceNr_=" title="(x$1: Long)Unit">sequenceNr</a> <span title="(x: Long)Long">+=</span> <span title="Long(1L)" class="long">1L</span>
    <a href="#akka.persistence;Eventsourced.sequenceNr_=" title="=&gt; Long">sequenceNr</a>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="akka.persistence;Eventsourced.flushJournalBatch">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../../../actor/akka/actor/package.scala.html#akka.actor.package.actorRef2Scala" title="implicit akka.actor.package.actorRef2Scala : (ref: akka.actor.ActorRef)akka.actor.ScalaActorRef">journal</a> <a href="../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ScalaActorRef.!" title="(message: Any)(implicit sender: akka.actor.ActorRef)Unit">!</a> <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol;WriteMessages" title="(messages: scala.collection.immutable.Seq[akka.persistence.PersistentEnvelope], persistentActor: akka.actor.ActorRef, actorInstanceId: Int)akka.persistence.JournalProtocol.WriteMessages">WriteMessages</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.journalBatch_=" title="=&gt; scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">journalBatch</a>, <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a>, <a href="#akka.persistence;Eventsourced.instanceId" title="=&gt; Int">instanceId</a><span class="delimiter">)</span>
    <a href="#akka.persistence;Eventsourced.journalBatch_=" title="(x$1: scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope])Unit">journalBatch</a> = <span title="=&gt; collection.immutable.Vector.type">Vector</span>.<span title="scala.collection.immutable.Vector[Nothing]">empty</span>
    <a href="#akka.persistence;Eventsourced.writeInProgress_=" title="(x$1: Boolean)Unit">writeInProgress</a> = true
  <span class="delimiter">}</span>

  private def <a title="=&gt; akka.event.LoggingAdapter" id="akka.persistence;Eventsourced.log">log</a>: <a href="../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter" title="akka.event.LoggingAdapter">LoggingAdapter</a> = <a href="../../../actor/akka/event/Logging.scala.html#akka.event.Logging.apply(882ba4a885)" title="(system: akka.actor.ActorSystem, logSource: akka.persistence.Eventsourced)(implicit evidence$3: akka.event.LogSource[akka.persistence.Eventsourced])akka.event.LoggingAdapter">Logging</a><a href="../../../actor/akka/event/Logging.scala.html#akka.event.LogSource.fromActor" title="=&gt; akka.event.LogSource[akka.actor.Actor]" class="delimiter">(</a><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.system" title="=&gt; akka.actor.ActorSystem">system</a>, this<span class="delimiter">)</span>

  <span class="comment">/**
   * Recovery handler that receives persisted events during recovery. If a state snapshot
   * has been captured and saved, this handler will receive a [[SnapshotOffer]] message
   * followed by events that are younger than the offered snapshot.
   *
   * This handler must not have side-effects other than changing persistent actor state i.e. it
   * should not perform actions that may fail, such as interacting with external services,
   * for example.
   *
   * If there is a problem with recovering the state of the actor from the journal, the error
   * will be logged and the actor will be stopped.
   *
   * @see [[Recovery]]
   */</span>
  def <a title="=&gt; Eventsourced.this.Receive" id="akka.persistence;Eventsourced.receiveRecover">receiveRecover</a>: <span title="Eventsourced.this.Receive">Receive</span>

  <span class="comment">/**
   * Command handler. Typically validates commands against current state (and/or by
   * communication with other actors). On successful validation, one or more events are
   * derived from a command and these events are then persisted by calling `persist`.
   */</span>
  def <a title="=&gt; Eventsourced.this.Receive" id="akka.persistence;Eventsourced.receiveCommand">receiveCommand</a>: <span title="Eventsourced.this.Receive">Receive</span>

  <span class="comment">/**
   * Asynchronously persists `event`. On successful persistence, `handler` is called with the
   * persisted event. It is guaranteed that no new commands will be received by a persistent actor
   * between a call to `persist` and the execution of its `handler`. This also holds for
   * multiple `persist` calls per received command. Internally, this is achieved by stashing new
   * commands and unstashing them when the `event` has been persisted and handled. The stash used
   * for that is an internal stash which doesn't interfere with the inherited user stash.
   *
   * An event `handler` may close over persistent actor state and modify it. The `sender` of a persisted
   * event is the sender of the corresponding command. This means that one can reply to a command
   * sender within an event `handler`.
   *
   * Within an event handler, applications usually update persistent actor state using persisted event
   * data, notify listeners and reply to command senders.
   *
   * If persistence of an event fails, [[#onPersistFailure]] will be invoked and the actor will
   * unconditionally be stopped. The reason that it cannot resume when persist fails is that it
   * is unknown if the even was actually persisted or not, and therefore it is in an inconsistent
   * state. Restarting on persistent failures will most likely fail anyway, since the journal
   * is probably unavailable. It is better to stop the actor and after a back-off timeout start
   * it again.
   *
   * @param event event to be persisted
   * @param handler handler for each persisted `event`
   */</span>
  def <a title="[A](event: A)(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persist(aa368cf4a0)">persist</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persist(aa368cf4a0);A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="akka.persistence;Eventsourced.persist(aa368cf4a0).event">event</a>: <a href="#akka.persistence;Eventsourced.persist(aa368cf4a0);A" title="A">A</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persist(aa368cf4a0).handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="(x$1: Long)Unit">pendingStashingPersistInvocations</a> <span title="(x: Int)Long">+=</span> <span title="Int(1)" class="int">1</span>
    <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a> <span title="(x$1: akka.persistence.Eventsourced.PendingHandlerInvocation)Unit">addLast</span> <a href="#akka.persistence.Eventsourced.StashingHandlerInvocation.readResolve" title="(evt: Any, handler: Any =&gt; Unit)akka.persistence.Eventsourced.StashingHandlerInvocation">StashingHandlerInvocation</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persist(aa368cf4a0).event" title="A">event</a>, <a href="#akka.persistence;Eventsourced.persist(aa368cf4a0).handler" title="A =&gt; Unit">handler</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Any =&gt; Unit" class="delimiter">[</span>Any ⇒ Unit<span class="delimiter">]</span><span class="delimiter">)</span>
    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <a href="Persistent.scala.html#akka.persistence.AtomicWrite.apply(befb501313)" title="(event: akka.persistence.PersistentRepr)akka.persistence.AtomicWrite">AtomicWrite</a><span class="delimiter">(</span><a href="Persistent.scala.html#akka.persistence.PersistentRepr.apply$default$2" title="Long" id="akka.persistence;Eventsourced.persist(aa368cf4a0).x$1.x$15">PersistentRepr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persist(aa368cf4a0).event" title="A" id="akka.persistence;Eventsourced.persist(aa368cf4a0).x$1.x$9">event</a>, sender = <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.sender" title="()akka.actor.ActorRef">sender</a><a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.persist(aa368cf4a0).x$1.x$10" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.persist(aa368cf4a0).x$1" title="(x: akka.persistence.PersistentEnvelope)List[akka.persistence.PersistentEnvelope]">::</a> <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Asynchronously persists `events` in specified order. This is equivalent to calling
   * `persist[A](event: A)(handler: A =&gt; Unit)` multiple times with the same `handler`,
   * except that `events` are persisted atomically with this method.
   *
   * @param events events to be persisted
   * @param handler handler for each persisted `events`
   */</span>
  def <a title="[A](events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persistAll">persistAll</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persistAll;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[A]" id="akka.persistence;Eventsourced.persistAll.events">events</a>: immutable.<span title="scala.collection.immutable.Seq[A]">Seq</span><span class="delimiter">[</span>A<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persistAll.handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.persistAll.events" title="scala.collection.immutable.Seq[A]">events</a>.<span title="(f: A =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="A" id="akka.persistence;Eventsourced.persistAll.$anonfun.event">event</a> ⇒
      <a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="(x$1: Long)Unit">pendingStashingPersistInvocations</a> <span title="(x: Int)Long">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a> <span title="(x$1: akka.persistence.Eventsourced.PendingHandlerInvocation)Unit">addLast</span> <a href="#akka.persistence.Eventsourced.StashingHandlerInvocation.readResolve" title="(evt: Any, handler: Any =&gt; Unit)akka.persistence.Eventsourced.StashingHandlerInvocation">StashingHandlerInvocation</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAll.$anonfun.event" title="A">event</a>, <a href="#akka.persistence;Eventsourced.persistAll.handler" title="A =&gt; Unit">handler</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Any =&gt; Unit" class="delimiter">[</span>Any ⇒ Unit<span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <a href="Persistent.scala.html#akka.persistence;AtomicWrite" title="(payload: scala.collection.immutable.Seq[akka.persistence.PersistentRepr])akka.persistence.AtomicWrite">AtomicWrite</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAll.events" title="scala.collection.immutable.Seq[A]">events</a>.<span title="(f: A =&gt; akka.persistence.PersistentRepr)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[A],akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]])scala.collection.immutable.Seq[akka.persistence.PersistentRepr]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq.Coll,akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]]" class="delimiter">(</span><a href="Persistent.scala.html#akka.persistence.PersistentRepr" title="akka.persistence.PersistentRepr.type">PersistentRepr</a>.<a href="Persistent.scala.html#akka.persistence.PersistentRepr.apply$default$2" title="Long" id="akka.persistence;Eventsourced.persistAll.x$3.$anonfun.x$22">apply</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAll.x$3.$anonfun.x$2" title="A" id="akka.persistence;Eventsourced.persistAll.x$3.$anonfun.x$16">_</a>, sender = <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.sender" title="()akka.actor.ActorRef">sender</a><a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.persistAll.x$3.$anonfun.x$17" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.persistAll.x$3" title="(x: akka.persistence.PersistentEnvelope)List[akka.persistence.PersistentEnvelope]">::</a> <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>
  <span class="delimiter">}</span>

  @deprecated<span class="delimiter">(</span><span class="string">&quot;use persistAll instead&quot;</span>, <span class="string">&quot;2.4&quot;</span><span class="delimiter">)</span>
  def <a title="[A](events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persist(3ec6a93aa7)">persist</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persist(3ec6a93aa7);A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[A]" id="akka.persistence;Eventsourced.persist(3ec6a93aa7).events">events</a>: immutable.<span title="scala.collection.immutable.Seq[A]">Seq</span><span class="delimiter">[</span>A<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persist(3ec6a93aa7).handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence;Eventsourced.persistAll" title="(events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit">persistAll</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persist(3ec6a93aa7).events" title="scala.collection.immutable.Seq[A]">events</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persist(3ec6a93aa7).handler" title="A =&gt; Unit">handler</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Asynchronously persists `event`. On successful persistence, `handler` is called with the
   * persisted event.
   *
   * Unlike `persist` the persistent actor will continue to receive incoming commands between the
   * call to `persist` and executing it's `handler`. This asynchronous, non-stashing, version of
   * of persist should be used when you favor throughput over the &quot;command-2 only processed after
   * command-1 effects' have been applied&quot; guarantee, which is provided by the plain [[persist]] method.
   *
   * An event `handler` may close over persistent actor state and modify it. The `sender` of a persisted
   * event is the sender of the corresponding command. This means that one can reply to a command
   * sender within an event `handler`.
   *
   * If persistence of an event fails, [[#onPersistFailure]] will be invoked and the actor will
   * unconditionally be stopped. The reason that it cannot resume when persist fails is that it
   * is unknown if the even was actually persisted or not, and therefore it is in an inconsistent
   * state. Restarting on persistent failures will most likely fail anyway, since the journal
   * is probably unavailable. It is better to stop the actor and after a back-off timeout start
   * it again.
   *
   * @param event event to be persisted
   * @param handler handler for each persisted `event`
   */</span>
  def <a title="[A](event: A)(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0)">persistAsync</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0);A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0).event">event</a>: <a href="#akka.persistence;Eventsourced.persistAsync(aa368cf4a0);A" title="A">A</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0).handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a> <span title="(x$1: akka.persistence.Eventsourced.PendingHandlerInvocation)Unit">addLast</span> <a href="#akka.persistence.Eventsourced.AsyncHandlerInvocation.readResolve" title="(evt: Any, handler: Any =&gt; Unit)akka.persistence.Eventsourced.AsyncHandlerInvocation">AsyncHandlerInvocation</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAsync(aa368cf4a0).event" title="A">event</a>, <a href="#akka.persistence;Eventsourced.persistAsync(aa368cf4a0).handler" title="A =&gt; Unit">handler</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Any =&gt; Unit" class="delimiter">[</span>Any ⇒ Unit<span class="delimiter">]</span><span class="delimiter">)</span>
    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <a href="Persistent.scala.html#akka.persistence.AtomicWrite.apply(befb501313)" title="(event: akka.persistence.PersistentRepr)akka.persistence.AtomicWrite">AtomicWrite</a><span class="delimiter">(</span><a href="Persistent.scala.html#akka.persistence.PersistentRepr.apply$default$2" title="Long" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0).x$4.x$29">PersistentRepr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAsync(aa368cf4a0).event" title="A" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0).x$4.x$23">event</a>, sender = <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.sender" title="()akka.actor.ActorRef">sender</a><a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.persistAsync(aa368cf4a0).x$4.x$24" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.persistAsync(aa368cf4a0).x$4" title="(x: akka.persistence.PersistentEnvelope)List[akka.persistence.PersistentEnvelope]">::</a> <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Asynchronously persists `events` in specified order. This is equivalent to calling
   * `persistAsync[A](event: A)(handler: A =&gt; Unit)` multiple times with the same `handler`,
   * except that `events` are persisted atomically with this method.
   *
   * @param events events to be persisted
   * @param handler handler for each persisted `events`
   */</span>
  def <a title="[A](events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persistAllAsync">persistAllAsync</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persistAllAsync;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[A]" id="akka.persistence;Eventsourced.persistAllAsync.events">events</a>: immutable.<span title="scala.collection.immutable.Seq[A]">Seq</span><span class="delimiter">[</span>A<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persistAllAsync.handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence;Eventsourced.persistAllAsync.events" title="scala.collection.immutable.Seq[A]">events</a>.<span title="(f: A =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="A" id="akka.persistence;Eventsourced.persistAllAsync.$anonfun.event">event</a> ⇒
      <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a> <span title="(x$1: akka.persistence.Eventsourced.PendingHandlerInvocation)Unit">addLast</span> <a href="#akka.persistence.Eventsourced.AsyncHandlerInvocation.readResolve" title="(evt: Any, handler: Any =&gt; Unit)akka.persistence.Eventsourced.AsyncHandlerInvocation">AsyncHandlerInvocation</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAllAsync.$anonfun.event" title="A">event</a>, <a href="#akka.persistence;Eventsourced.persistAllAsync.handler" title="A =&gt; Unit">handler</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Any =&gt; Unit" class="delimiter">[</span>Any ⇒ Unit<span class="delimiter">]</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <a href="Persistent.scala.html#akka.persistence;AtomicWrite" title="(payload: scala.collection.immutable.Seq[akka.persistence.PersistentRepr])akka.persistence.AtomicWrite">AtomicWrite</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAllAsync.events" title="scala.collection.immutable.Seq[A]">events</a>.<span title="(f: A =&gt; akka.persistence.PersistentRepr)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[A],akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]])scala.collection.immutable.Seq[akka.persistence.PersistentRepr]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq.Coll,akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]]" class="delimiter">(</span><a href="Persistent.scala.html#akka.persistence.PersistentRepr" title="akka.persistence.PersistentRepr.type">PersistentRepr</a>.<a href="Persistent.scala.html#akka.persistence.PersistentRepr.apply$default$2" title="Long" id="akka.persistence;Eventsourced.persistAllAsync.x$6.$anonfun.x$36">apply</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAllAsync.x$6.$anonfun.x$5" title="A" id="akka.persistence;Eventsourced.persistAllAsync.x$6.$anonfun.x$30">_</a>, sender = <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.sender" title="()akka.actor.ActorRef">sender</a><a title="akka.actor.ActorRef" id="akka.persistence;Eventsourced.persistAllAsync.x$6.$anonfun.x$31" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.persistAllAsync.x$6" title="(x: akka.persistence.PersistentEnvelope)List[akka.persistence.PersistentEnvelope]">::</a> <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>
  <span class="delimiter">}</span>

  @deprecated<span class="delimiter">(</span><span class="string">&quot;use persistAllAsync instead&quot;</span>, <span class="string">&quot;2.4&quot;</span><span class="delimiter">)</span>
  def <a title="[A](events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.persistAsync(3ec6a93aa7)">persistAsync</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.persistAsync(3ec6a93aa7);A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[A]" id="akka.persistence;Eventsourced.persistAsync(3ec6a93aa7).events">events</a>: immutable.<span title="scala.collection.immutable.Seq[A]">Seq</span><span class="delimiter">[</span>A<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.persistAsync(3ec6a93aa7).handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence;Eventsourced.persistAllAsync" title="(events: scala.collection.immutable.Seq[A])(handler: A =&gt; Unit)Unit">persistAllAsync</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAsync(3ec6a93aa7).events" title="scala.collection.immutable.Seq[A]">events</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistAsync(3ec6a93aa7).handler" title="A =&gt; Unit">handler</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Defer the handler execution until all pending handlers have been executed.
   * Allows to define logic within the actor, which will respect the invocation-order-guarantee
   * in respect to `persistAsync` calls. That is, if `persistAsync` was invoked before `deferAsync`,
   * the corresponding handlers will be invoked in the same order as they were registered in.
   *
   * This call will NOT result in `event` being persisted, use `persist` or `persistAsync` instead
   * if the given event should possible to replay.
   *
   * If there are no pending persist handler calls, the handler will be called immediately.
   *
   * If persistence of an earlier event fails, the persistent actor will stop, and the `handler`
   * will not be run.
   *
   * @param event event to be handled in the future, when preceding persist operations have been processes
   * @param handler handler for the given `event`
   */</span>
  def <a title="[A](event: A)(handler: A =&gt; Unit)Unit" id="akka.persistence;Eventsourced.deferAsync">deferAsync</a><span class="delimiter">[</span><a title="" id="akka.persistence;Eventsourced.deferAsync;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="akka.persistence;Eventsourced.deferAsync.event">event</a>: <a href="#akka.persistence;Eventsourced.deferAsync;A" title="A">A</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="A =&gt; Unit" id="akka.persistence;Eventsourced.deferAsync.handler">handler</a>: A ⇒ Unit<span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a>.<span title="()Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.deferAsync.handler" title="(v1: A)Unit">handler</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.deferAsync.event" title="A">event</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> else <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a> <span title="(x$1: akka.persistence.Eventsourced.PendingHandlerInvocation)Unit">addLast</span> <a href="#akka.persistence.Eventsourced.AsyncHandlerInvocation.readResolve" title="(evt: Any, handler: Any =&gt; Unit)akka.persistence.Eventsourced.AsyncHandlerInvocation">AsyncHandlerInvocation</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.deferAsync.event" title="A">event</a>, <a href="#akka.persistence;Eventsourced.deferAsync.handler" title="A =&gt; Unit">handler</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Any =&gt; Unit" class="delimiter">[</span>Any ⇒ Unit<span class="delimiter">]</span><span class="delimiter">)</span>
      <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <a href="Persistent.scala.html#akka.persistence;NonPersistentRepr" title="(payload: Any, sender: akka.actor.ActorRef)akka.persistence.NonPersistentRepr">NonPersistentRepr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.deferAsync.event" title="A">event</a>, <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.sender" title="()akka.actor.ActorRef">sender</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.deferAsync.x$7" title="(x: akka.persistence.PersistentEnvelope)List[akka.persistence.PersistentEnvelope]">::</a> <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Permanently deletes all persistent messages with sequence numbers less than or equal `toSequenceNr`.
   *
   * If the delete is successful a [[DeleteMessagesSuccess]] will be sent to the actor.
   * If the delete fails a [[DeleteMessagesFailure]] will be sent to the actor.
   *
   * @param toSequenceNr upper sequence number bound of persistent messages to be deleted.
   */</span>
  def <a title="(toSequenceNr: Long)Unit" id="akka.persistence;Eventsourced.deleteMessages">deleteMessages</a><span class="delimiter">(</span><a title="Long" id="akka.persistence;Eventsourced.deleteMessages.toSequenceNr">toSequenceNr</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="../../../actor/akka/actor/package.scala.html#akka.actor.package.actorRef2Scala" title="implicit akka.actor.package.actorRef2Scala : (ref: akka.actor.ActorRef)akka.actor.ScalaActorRef">journal</a> <a href="../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ScalaActorRef.!" title="(message: Any)(implicit sender: akka.actor.ActorRef)Unit">!</a> <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol;DeleteMessagesTo" title="(persistenceId: String, toSequenceNr: Long, persistentActor: akka.actor.ActorRef)akka.persistence.JournalProtocol.DeleteMessagesTo">DeleteMessagesTo</a><span class="delimiter">(</span><a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>, <a href="#akka.persistence;Eventsourced.deleteMessages.toSequenceNr" title="Long">toSequenceNr</a>, <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Returns `true` if this persistent actor is currently recovering.
   */</span>
  def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span> = <a href="#akka.persistence;Eventsourced.currentState_=" title="=&gt; Eventsourced.this.State">currentState</a>.<a href="#akka.persistence;Eventsourced;State.recoveryRunning" title="=&gt; Boolean">recoveryRunning</a>

  <span class="comment">/**
   * Returns `true` if this persistent actor has successfully finished recovery.
   */</span>
  def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.recoveryFinished">recoveryFinished</a>: <span title="Boolean">Boolean</span> = <span title="=&gt; Boolean">!</span><a href="#akka.persistence;Eventsourced.recoveryRunning" title="=&gt; Boolean">recoveryRunning</a>

  override def <a title="()Unit" id="akka.persistence;Eventsourced.unstashAll(aa97cb1b3d)">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// Internally, all messages are processed by unstashing them from</span>
    <span class="comment">// the internal stash one-by-one. Hence, an unstashAll() from the</span>
    <span class="comment">// user stash must be prepended to the internal stash.</span>
    <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.prepend" title="(others: scala.collection.immutable.Seq[akka.dispatch.Envelope])Unit">prepend</a><span class="delimiter">(</span><a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.clearStash" title="()Vector[akka.dispatch.Envelope]">clearStash</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private trait <a title="trait State extends AnyRef" id="akka.persistence;Eventsourced;State">State</a> <span class="delimiter">{</span>
    def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced;State.stateReceive">stateReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced;State.stateReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced;State.stateReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>
    def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced;State.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Processes a loaded snapshot, if any. A loaded snapshot is offered with a `SnapshotOffer`
   * message to the actor's `receiveRecover`. Then initiates a message replay, either starting
   * from the loaded snapshot or from scratch, and switches to `recoveryStarted` state.
   * All incoming messages are stashed.
   *
   * @param replayMax maximum number of messages to replay.
   */</span>
  private def <a title="(replayMax: Long)Eventsourced.this.State" id="akka.persistence;Eventsourced.recoveryStarted">recoveryStarted</a><span class="delimiter">(</span><a title="Long" id="akka.persistence;Eventsourced.recoveryStarted.replayMax">replayMax</a>: <span title="Long">Long</span><span class="delimiter">)</span> = new <a title="&lt;$anon: Eventsourced.this.State&gt; extends AnyRef with Eventsourced.this.State" id="akka.persistence;Eventsourced.recoveryStarted;$anon">State</a> <span class="delimiter">{</span>

    private val <a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior">recoveryBehavior</a>: <span title="Eventsourced.this.Receive">Receive</span> = <span class="delimiter">{</span>
      val <a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover">_receiveRecover</a> = <a href="#akka.persistence;Eventsourced.receiveRecover" title="=&gt; Eventsourced.this.Receive">receiveRecover</a>

      <a title="&lt;$anon: Any =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[Any,Unit] with Serializable" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
        case <a href="Persistent.scala.html#akka.persistence.PersistentRepr.unapply" title="(persistent: akka.persistence.PersistentRepr)Option[(Any, Long)]">PersistentRepr</a><span class="delimiter">(</span><a title="Any" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.payload">payload</a>, _<span class="delimiter">)</span> if <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryRunning" title="=&gt; Boolean">recoveryRunning</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="Eventsourced.this.Receive">_receiveRecover</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.payload" title="Any">payload</a><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="(v1: Any)Unit">_receiveRecover</a><span title="Boolean(true)" class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.payload" title="Any">payload</a><span class="delimiter">)</span>
        case <a title="akka.persistence.SnapshotOffer" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.s">s</a>: <a href="SnapshotProtocol.scala.html#akka.persistence;SnapshotOffer" title="akka.persistence.SnapshotOffer">SnapshotOffer</a> if <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="Eventsourced.this.Receive">_receiveRecover</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.s" title="akka.persistence.SnapshotOffer">s</a><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="(v1: Any)Unit">_receiveRecover</a><span title="Boolean(true)" class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior;$anonfun.isDefinedAt.s" title="akka.persistence.SnapshotOffer">s</a><span class="delimiter">)</span>
        case <a href="PersistentActor.scala.html#akka.persistence.RecoveryCompleted" title="akka.persistence.RecoveryCompleted.type">RecoveryCompleted</a> if <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="Eventsourced.this.Receive">_receiveRecover</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="PersistentActor.scala.html#akka.persistence.RecoveryCompleted" title="akka.persistence.RecoveryCompleted.type">RecoveryCompleted</a><span class="delimiter">)</span> ⇒
          <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior._receiveRecover" title="(v1: Any)Unit">_receiveRecover</a><span title="Boolean(true)" class="delimiter">(</span><a href="PersistentActor.scala.html#akka.persistence.RecoveryCompleted" title="akka.persistence.RecoveryCompleted.type">RecoveryCompleted</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    override def <a title="()String" id="akka.persistence;Eventsourced.recoveryStarted;$anon.toString">toString</a>: <span title="String">String</span> = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;recovery started (replayMax = [&quot;)">recovery started (replayMax = [$</span><a href="#akka.persistence;Eventsourced.recoveryStarted.replayMax" title="Long">replayMax</a><span title="String(&quot;])&quot;)" class="string">])&quot;</span>
    override def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span> = true

    override def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive">stateReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span> = <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.message" title="Any">message</a> match <span class="delimiter">{</span>
      case LoadSnapshotResult<span class="delimiter">(</span><a title="Option[akka.persistence.SelectedSnapshot]" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.sso">sso</a>, <a title="Long" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.toSnr">toSnr</a><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.sso" title="Option[akka.persistence.SelectedSnapshot]">sso</a>.<span title="(f: akka.persistence.SelectedSnapshot =&gt; Unit)Unit">foreach</span> <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.x0$2" title="Unit" class="delimiter">{</a>
          case SelectedSnapshot<span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.metadata">metadata</a>, <a title="Any" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.snapshot">snapshot</a><span class="delimiter">)</span> ⇒
            <a href="#akka.persistence;Eventsourced.setLastSequenceNr" title="(value: Long)Unit">setLastSequenceNr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>.<a href="SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">)</span>
            <span class="comment">// Since we are recovering we can ignore the receive behavior from the stack</span>
            <a href="#akka.persistence;Eventsourced" title="akka.persistence.Eventsourced">Eventsourced</a>.super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundReceive" title="(receive: akka.actor.Actor.Receive, msg: Any)Unit">aroundReceive</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior" title="=&gt; Eventsourced.this.Receive">recoveryBehavior</a>, <a href="SnapshotProtocol.scala.html#akka.persistence;SnapshotOffer" title="(metadata: akka.persistence.SnapshotMetadata, snapshot: Any)akka.persistence.SnapshotOffer">SnapshotOffer</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>, <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.$anonfun.snapshot" title="Any">snapshot</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#akka.persistence;Eventsourced.changeState" title="(state: Eventsourced.this.State)Unit">changeState</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering" title="(recoveryBehavior: Eventsourced.this.Receive)Eventsourced.this.State">recovering</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.recoveryBehavior" title="=&gt; Eventsourced.this.Receive">recoveryBehavior</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="../../../actor/akka/actor/package.scala.html#akka.actor.package.actorRef2Scala" title="implicit akka.actor.package.actorRef2Scala : (ref: akka.actor.ActorRef)akka.actor.ScalaActorRef">journal</a> <a href="../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ScalaActorRef.!" title="(message: Any)(implicit sender: akka.actor.ActorRef)Unit">!</a> <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol;ReplayMessages" title="(fromSequenceNr: Long, toSequenceNr: Long, max: Long, persistenceId: String, persistentActor: akka.actor.ActorRef)akka.persistence.JournalProtocol.ReplayMessages">ReplayMessages</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.lastSequenceNr" title="=&gt; Long">lastSequenceNr</a> <span title="(x: Long)Long">+</span> <span title="Long(1L)" class="long">1L</span>, <a href="#akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.toSnr" title="Long">toSnr</a>, <a href="#akka.persistence;Eventsourced.recoveryStarted.replayMax" title="Long">replayMax</a>, <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="=&gt; String">persistenceId</a>, <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
      case <a title="Any" id="akka.persistence;Eventsourced.recoveryStarted;$anon.stateReceive.other">other</a> ⇒ <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.stash" title="()Unit">stash</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Processes replayed messages, if any. The actor's `receiveRecover` is invoked with the replayed
   * events.
   *
   * If replay succeeds it got highest stored sequence number response from the journal and then switches
   * to `processingCommands` state. Otherwise the actor is stopped.
   * If replay succeeds the `onReplaySuccess` callback method is called, otherwise `onRecoveryFailure`.
   *
   * All incoming messages are stashed.
   */</span>
  private def <a title="(recoveryBehavior: Eventsourced.this.Receive)Eventsourced.this.State" id="akka.persistence;Eventsourced.recovering">recovering</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.recovering.recoveryBehavior">recoveryBehavior</a>: <span title="Eventsourced.this.Receive">Receive</span><span class="delimiter">)</span> = new <a title="&lt;$anon: Eventsourced.this.State&gt; extends AnyRef with Eventsourced.this.State" id="akka.persistence;Eventsourced.recovering;$anon">State</a> <span class="delimiter">{</span>
    override def <a title="()String" id="akka.persistence;Eventsourced.recovering;$anon.toString">toString</a>: <span title="String">String</span> = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;replay started&quot;)" class="string">replay started&quot;</span>
    override def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.recovering;$anon.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span> = true

    override def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive">stateReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span> = <a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.message" title="Any">message</a> match <span class="delimiter">{</span>
      case ReplayedMessage<span class="delimiter">(</span><a title="akka.persistence.PersistentRepr" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.p">p</a><span class="delimiter">)</span> ⇒
        try <span class="delimiter">{</span>
          <a href="#akka.persistence;Eventsourced.updateLastSequenceNr" title="(persistent: akka.persistence.PersistentRepr)Unit">updateLastSequenceNr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.p" title="akka.persistence.PersistentRepr">p</a><span class="delimiter">)</span>
          <a href="#akka.persistence;Eventsourced" title="akka.persistence.Eventsourced">Eventsourced</a>.super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundReceive" title="(receive: akka.actor.Actor.Receive, msg: Any)Unit">aroundReceive</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering.recoveryBehavior" title="Eventsourced.this.Receive">recoveryBehavior</a>, <a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.p" title="akka.persistence.PersistentRepr">p</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.<unapply-selector>" title="(t: Throwable)Option[Throwable]">NonFatal</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.t">t</a><span class="delimiter">)</span> ⇒
            try <a href="#akka.persistence;Eventsourced.onRecoveryFailure" title="(cause: Throwable, event: Option[Any])Unit">onRecoveryFailure</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.t" title="Throwable">t</a>, <span title="(x: Any)Some[Any]">Some</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.p" title="akka.persistence.PersistentRepr">p</a>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.payload" title="=&gt; Any">payload</a><span class="delimiter">)</span><span class="delimiter">)</span> finally <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../actor/akka/actor/ActorRefProvider.scala.html#akka.actor;ActorRefFactory.stop" title="(actor: akka.actor.ActorRef)Unit">stop</a><span class="delimiter">(</span><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      case RecoverySuccess<span class="delimiter">(</span><a title="Long" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.highestSeqNr">highestSeqNr</a><span class="delimiter">)</span> ⇒
        <a href="#akka.persistence;Eventsourced.onReplaySuccess" title="()Unit">onReplaySuccess</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// callback for subclass implementation</span>
        <a href="#akka.persistence;Eventsourced.changeState" title="(state: Eventsourced.this.State)Unit">changeState</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands" title="=&gt; Eventsourced.this.State">processingCommands</a><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.sequenceNr_=" title="(x$1: Long)Unit">sequenceNr</a> = <a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.highestSeqNr" title="Long">highestSeqNr</a>
        <a href="#akka.persistence;Eventsourced.setLastSequenceNr" title="(value: Long)Unit">setLastSequenceNr</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.highestSeqNr" title="Long">highestSeqNr</a><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(aa97cb1b3d)" title="()Unit">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced" title="akka.persistence.Eventsourced">Eventsourced</a>.super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundReceive" title="(receive: akka.actor.Actor.Receive, msg: Any)Unit">aroundReceive</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering.recoveryBehavior" title="Eventsourced.this.Receive">recoveryBehavior</a>, <a href="PersistentActor.scala.html#akka.persistence.RecoveryCompleted" title="akka.persistence.RecoveryCompleted.type">RecoveryCompleted</a><span class="delimiter">)</span>
      case ReplayMessagesFailure<span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.cause">cause</a><span class="delimiter">)</span> ⇒
        try <a href="#akka.persistence;Eventsourced.onRecoveryFailure" title="(cause: Throwable, event: Option[Any])Unit">onRecoveryFailure</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.recovering;$anon.stateReceive.cause" title="Throwable">cause</a>, event = <span title="None.type">None</span><span class="delimiter">)</span> finally <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../actor/akka/actor/ActorRefProvider.scala.html#akka.actor;ActorRefFactory.stop" title="(actor: akka.actor.ActorRef)Unit">stop</a><span class="delimiter">(</span><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
      case <a title="Any" id="akka.persistence;Eventsourced.recovering;$anon.stateReceive.other">other</a> ⇒
        <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.stash" title="()Unit">stash</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="akka.persistence;Eventsourced.flushBatch">flushBatch</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    def <a title="(p: akka.persistence.PersistentEnvelope)Unit" id="akka.persistence;Eventsourced.flushBatch.addToBatch">addToBatch</a><span class="delimiter">(</span><a title="akka.persistence.PersistentEnvelope" id="akka.persistence;Eventsourced.flushBatch.addToBatch.p">p</a>: <a href="Persistent.scala.html#akka.persistence;PersistentEnvelope" title="akka.persistence.PersistentEnvelope">PersistentEnvelope</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.persistence;Eventsourced.flushBatch.addToBatch.p" title="akka.persistence.PersistentEnvelope">p</a> match <span class="delimiter">{</span>
      case <a title="akka.persistence.AtomicWrite" id="akka.persistence;Eventsourced.flushBatch.addToBatch.a">a</a>: <a href="Persistent.scala.html#akka.persistence;AtomicWrite" title="akka.persistence.AtomicWrite">AtomicWrite</a> ⇒
        <a href="#akka.persistence;Eventsourced.journalBatch_=" title="(x$1: scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope])Unit">journalBatch</a> <span title="(elem: akka.persistence.PersistentEnvelope)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope],akka.persistence.PersistentEnvelope,scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]])scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">:+=</span> <a href="#akka.persistence;Eventsourced.flushBatch.addToBatch.a" title="akka.persistence.AtomicWrite">a</a>.<a href="Persistent.scala.html#akka.persistence;AtomicWrite.copy" title="(payload: scala.collection.immutable.Seq[akka.persistence.PersistentRepr])akka.persistence.AtomicWrite">copy</a><span class="delimiter">(</span>payload =
          <a href="#akka.persistence;Eventsourced.flushBatch.addToBatch.a" title="akka.persistence.AtomicWrite">a</a>.<a href="Persistent.scala.html#akka.persistence;AtomicWrite.payload" title="=&gt; scala.collection.immutable.Seq[akka.persistence.PersistentRepr]">payload</a>.<span title="(f: akka.persistence.PersistentRepr =&gt; akka.persistence.PersistentRepr)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[akka.persistence.PersistentRepr],akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]])scala.collection.immutable.Seq[akka.persistence.PersistentRepr]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq.Coll,akka.persistence.PersistentRepr,scala.collection.immutable.Seq[akka.persistence.PersistentRepr]]" class="delimiter">(</span><a href="#akka.persistence;Eventsourced.flushBatch.addToBatch.$anonfun.x$8" title="akka.persistence.PersistentRepr">_</a>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.update$default$3" title="Boolean" id="akka.persistence;Eventsourced.flushBatch.addToBatch.$anonfun.x$41">update</a><span class="delimiter">(</span>persistenceId = <a href="Persistence.scala.html#akka.persistence;PersistenceIdentity.persistenceId" title="String" id="akka.persistence;Eventsourced.flushBatch.addToBatch.$anonfun.x$37">persistenceId</a>, sequenceNr = <a href="#akka.persistence;Eventsourced.nextSequenceNr" title="()Long">nextSequenceNr</a><a title="Long" id="akka.persistence;Eventsourced.flushBatch.addToBatch.$anonfun.x$38" class="delimiter">(</a><span class="delimiter">)</span>, writerUuid = <a href="#akka.persistence;Eventsourced.writerUuid" title="String" id="akka.persistence;Eventsourced.flushBatch.addToBatch.$anonfun.x$39">writerUuid</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      case <a title="akka.persistence.PersistentEnvelope" id="akka.persistence;Eventsourced.flushBatch.addToBatch.r">r</a>: <a href="Persistent.scala.html#akka.persistence;PersistentEnvelope" title="akka.persistence.PersistentEnvelope">PersistentEnvelope</a> ⇒
        <a href="#akka.persistence;Eventsourced.journalBatch_=" title="(x$1: scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope])Unit">journalBatch</a> <span title="(elem: akka.persistence.PersistentEnvelope)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope],akka.persistence.PersistentEnvelope,scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]])scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">:+=</span> <a href="#akka.persistence;Eventsourced.flushBatch.addToBatch.r" title="akka.persistence.PersistentEnvelope">r</a>
    <span class="delimiter">}</span>

    def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.flushBatch.maxBatchSizeReached">maxBatchSizeReached</a>: <span title="Boolean">Boolean</span> =
      <a href="#akka.persistence;Eventsourced.journalBatch_=" title="=&gt; scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">journalBatch</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;=</span> <a href="#akka.persistence;Eventsourced.maxMessageBatchSize" title="=&gt; Int">maxMessageBatchSize</a>

    <span class="comment">// When using only `persistAsync` and `defer` max throughput is increased by using</span>
    <span class="comment">// batching, but when using `persist` we want to use one atomic WriteMessages</span>
    <span class="comment">// for the emitted events.</span>
    <span class="comment">// Flush previously collected events, if any, separately from the `persist` batch</span>
    if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="=&gt; Long">pendingStashingPersistInvocations</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.persistence;Eventsourced.journalBatch_=" title="=&gt; scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">journalBatch</a>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span>
      <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>.<span title="=&gt; List[akka.persistence.PersistentEnvelope]">reverse</span>.<span title="(f: akka.persistence.PersistentEnvelope =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="akka.persistence.PersistentEnvelope" id="akka.persistence;Eventsourced.flushBatch.$anonfun.p">p</a> ⇒
      <a href="#akka.persistence;Eventsourced.flushBatch.addToBatch" title="(p: akka.persistence.PersistentEnvelope)Unit">addToBatch</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.flushBatch.$anonfun.p" title="akka.persistence.PersistentEnvelope">p</a><span class="delimiter">)</span>
      if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.persistence;Eventsourced.writeInProgress_=" title="=&gt; Boolean">writeInProgress</a> <span title="(x: Boolean)Boolean">||</span> <a href="#akka.persistence;Eventsourced.flushBatch.maxBatchSizeReached" title="=&gt; Boolean">maxBatchSizeReached</a><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#akka.persistence;Eventsourced.eventBatch_=" title="(x$1: List[akka.persistence.PersistentEnvelope])Unit">eventBatch</a> = <span title="scala.collection.immutable.Nil.type">Nil</span>
  <span class="delimiter">}</span>

  private def <a title="(payload: Any)Unit" id="akka.persistence;Eventsourced.peekApplyHandler">peekApplyHandler</a><span class="delimiter">(</span><a title="Any" id="akka.persistence;Eventsourced.peekApplyHandler.payload">payload</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    val <a title="Int" id="akka.persistence;Eventsourced.peekApplyHandler.batchSizeBeforeApply">batchSizeBeforeApply</a> = <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>.<span title="=&gt; Int">size</span>
    try <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a>.<span title="()akka.persistence.Eventsourced.PendingHandlerInvocation">peek</span><span class="delimiter">(</span><span class="delimiter">)</span>.<a href="#akka.persistence.Eventsourced;PendingHandlerInvocation.handler" title="(v1: Any)Unit">handler</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.peekApplyHandler.payload" title="Any">payload</a><span class="delimiter">)</span>
    finally <span class="delimiter">{</span>
      val <a title="Int" id="akka.persistence;Eventsourced.peekApplyHandler.batchSizeAfterApply">batchSizeAfterApply</a> = <a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>.<span title="=&gt; Int">size</span>

      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.peekApplyHandler.batchSizeAfterApply" title="Int">batchSizeAfterApply</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#akka.persistence;Eventsourced.peekApplyHandler.batchSizeBeforeApply" title="Int">batchSizeBeforeApply</a><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.flushBatch" title="()Unit">flushBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Common receive handler for processingCommands and persistingEvents
   */</span>
  private abstract class <a title="class ProcessingState extends AnyRef with Eventsourced.this.State" id="akka.persistence;Eventsourced;ProcessingState">ProcessingState</a> extends <a href="#akka.persistence;Eventsourced;State" title="Eventsourced.this.State">State</a> <span class="delimiter">{</span>
    val <a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced;ProcessingState.common">common</a>: <span title="Eventsourced.this.Receive">Receive</span> = <a title="&lt;$anon: Any =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[Any,Unit] with Serializable" id="akka.persistence;Eventsourced;ProcessingState.common;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
      case WriteMessageSuccess<span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span>, <span title="Int">id</span><span class="delimiter">)</span> ⇒
        <span class="comment">// instanceId mismatch can happen for persistAsync and defer in case of actor restart</span>
        <span class="comment">// while message is in flight, in that case we ignore the call to the handler</span>
        if <span class="delimiter">(</span><span title="Int">id</span> <span title="(x: Int)Boolean">==</span> <a href="#akka.persistence;Eventsourced.instanceId" title="=&gt; Int">instanceId</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.persistence;Eventsourced.updateLastSequenceNr" title="(persistent: akka.persistence.PersistentRepr)Unit">updateLastSequenceNr</a><span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span><span class="delimiter">)</span>
          try <span class="delimiter">{</span>
            <a href="#akka.persistence;Eventsourced.peekApplyHandler" title="(payload: Any)Unit">peekApplyHandler</a><span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.payload" title="=&gt; Any">payload</a><span class="delimiter">)</span>
            <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = false<span class="delimiter">)</span>
          <span class="delimiter">}</span> catch <span class="delimiter">{</span> case <a href="#akka.persistence;Eventsourced;ProcessingState.common;$anonfun.applyOrElse.<unapply-selector>" title="(t: Throwable)Option[Throwable]">NonFatal</a><span class="delimiter">(</span><span title="Throwable">e</span><span class="delimiter">)</span> ⇒ <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = true<span class="delimiter">)</span>; throw <span title="Throwable">e</span> <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      case WriteMessageRejected<span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span>, <span title="Throwable">cause</span>, <span title="Int">id</span><span class="delimiter">)</span> ⇒
        <span class="comment">// instanceId mismatch can happen for persistAsync and defer in case of actor restart</span>
        <span class="comment">// while message is in flight, in that case the handler has already been discarded</span>
        if <span class="delimiter">(</span><span title="Int">id</span> <span title="(x: Int)Boolean">==</span> <a href="#akka.persistence;Eventsourced.instanceId" title="=&gt; Int">instanceId</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.persistence;Eventsourced.updateLastSequenceNr" title="(persistent: akka.persistence.PersistentRepr)Unit">updateLastSequenceNr</a><span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span><span class="delimiter">)</span>
          <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = false<span class="delimiter">)</span>
          <a href="#akka.persistence;Eventsourced.onPersistRejected" title="(cause: Throwable, event: Any, seqNr: Long)Unit">onPersistRejected</a><span class="delimiter">(</span><span title="Throwable">cause</span>, <span title="akka.persistence.PersistentRepr">p</span>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.payload" title="=&gt; Any">payload</a>, <span title="akka.persistence.PersistentRepr">p</span>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      case WriteMessageFailure<span class="delimiter">(</span><span title="akka.persistence.PersistentRepr">p</span>, <span title="Throwable">cause</span>, <span title="Int">id</span><span class="delimiter">)</span> ⇒
        <span class="comment">// instanceId mismatch can happen for persistAsync and defer in case of actor restart</span>
        <span class="comment">// while message is in flight, in that case the handler has already been discarded</span>
        if <span class="delimiter">(</span><span title="Int">id</span> <span title="(x: Int)Boolean">==</span> <a href="#akka.persistence;Eventsourced.instanceId" title="=&gt; Int">instanceId</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = false<span class="delimiter">)</span>
          try <a href="#akka.persistence;Eventsourced.onPersistFailure" title="(cause: Throwable, event: Any, seqNr: Long)Unit">onPersistFailure</a><span class="delimiter">(</span><span title="Throwable">cause</span>, <span title="akka.persistence.PersistentRepr">p</span>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.payload" title="=&gt; Any">payload</a>, <span title="akka.persistence.PersistentRepr">p</span>.<a href="Persistent.scala.html#akka.persistence;PersistentRepr.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">)</span> finally <a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../actor/akka/actor/ActorRefProvider.scala.html#akka.actor;ActorRefFactory.stop" title="(actor: akka.actor.ActorRef)Unit">stop</a><span class="delimiter">(</span><a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.self" title="=&gt; akka.actor.ActorRef">self</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      case LoopMessageSuccess<span class="delimiter">(</span><a title="Any" id="akka.persistence;Eventsourced;ProcessingState.common;$anonfun.isDefinedAt.l">l</a>, <span title="Int">id</span><span class="delimiter">)</span> ⇒
        <span class="comment">// instanceId mismatch can happen for persistAsync and defer in case of actor restart</span>
        <span class="comment">// while message is in flight, in that case we ignore the call to the handler</span>
        if <span class="delimiter">(</span><span title="Int">id</span> <span title="(x: Int)Boolean">==</span> <a href="#akka.persistence;Eventsourced.instanceId" title="=&gt; Int">instanceId</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          try <span class="delimiter">{</span>
            <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a>.<span title="()akka.persistence.Eventsourced.PendingHandlerInvocation">peek</span><span class="delimiter">(</span><span class="delimiter">)</span>.<a href="#akka.persistence.Eventsourced;PendingHandlerInvocation.handler" title="(v1: Any)Unit">handler</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced;ProcessingState.common;$anonfun.isDefinedAt.l" title="Any">l</a><span class="delimiter">)</span>
            <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = false<span class="delimiter">)</span>
          <span class="delimiter">}</span> catch <span class="delimiter">{</span> case <a href="#akka.persistence;Eventsourced;ProcessingState.common;$anonfun.applyOrElse.<unapply-selector>" title="(t: Throwable)Option[Throwable]">NonFatal</a><span class="delimiter">(</span><span title="Throwable">e</span><span class="delimiter">)</span> ⇒ <a href="#akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete" title="(err: Boolean)Unit">onWriteMessageComplete</a><span class="delimiter">(</span>err = true<span class="delimiter">)</span>; throw <span title="Throwable">e</span> <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      case <a href="JournalProtocol.scala.html#akka.persistence.JournalProtocol.WriteMessagesSuccessful" title="akka.persistence.JournalProtocol.WriteMessagesSuccessful.type">WriteMessagesSuccessful</a> ⇒
        if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.journalBatch_=" title="=&gt; scala.collection.immutable.Vector[akka.persistence.PersistentEnvelope]">journalBatch</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.writeInProgress_=" title="(x$1: Boolean)Unit">writeInProgress</a> = false else <a href="#akka.persistence;Eventsourced.flushJournalBatch" title="()Unit">flushJournalBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>

      case WriteMessagesFailed<span class="delimiter">(</span>_<span class="delimiter">)</span> ⇒
        <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// it will be stopped by the first WriteMessageFailure message</span>
    <span class="delimiter">}</span>

    def <a title="(err: Boolean)Unit" id="akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete">onWriteMessageComplete</a><span class="delimiter">(</span><a title="Boolean" id="akka.persistence;Eventsourced;ProcessingState.onWriteMessageComplete.err">err</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a>.<span title="()akka.persistence.Eventsourced.PendingHandlerInvocation">pop</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Command processing state. If event persistence is pending after processing a
   * command, event persistence is triggered and state changes to `persistingEvents`.
   */</span>
  private val <a title="Eventsourced.this.State" id="akka.persistence;Eventsourced.processingCommands">processingCommands</a>: <a href="#akka.persistence;Eventsourced;State" title="Eventsourced.this.State">State</a> = new <a href="#akka.persistence;Eventsourced;ProcessingState" title="&lt;$anon: Eventsourced.this.ProcessingState&gt; extends Eventsourced.this.ProcessingState" id="akka.persistence;Eventsourced.processingCommands;$anon">ProcessingState</a> <span class="delimiter">{</span>
    override def <a title="()String" id="akka.persistence;Eventsourced.processingCommands;$anon.toString">toString</a>: <span title="String">String</span> = <span title="String(&quot;processing commands&quot;)" class="string">&quot;processing commands&quot;</span>
    override def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.processingCommands;$anon.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span> = false

    override def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced.processingCommands;$anon.stateReceive">stateReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span> =
      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced;ProcessingState.common" title="=&gt; Eventsourced.this.Receive">common</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.message" title="Any">message</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced;ProcessingState.common" title="(v1: Any)Unit">common</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.message" title="Any">message</a><span class="delimiter">)</span>
      else try <span class="delimiter">{</span>
        <a href="#akka.persistence;Eventsourced" title="akka.persistence.Eventsourced">Eventsourced</a>.super.<a href="../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.aroundReceive" title="(receive: akka.actor.Actor.Receive, msg: Any)Unit">aroundReceive</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.receive" title="Eventsourced.this.Receive">receive</a>, <a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.message" title="Any">message</a><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.processingCommands;$anon.aroundReceiveComplete" title="(err: Boolean)Unit">aroundReceiveComplete</a><span class="delimiter">(</span>err = false<span class="delimiter">)</span>
      <span class="delimiter">}</span> catch <span class="delimiter">{</span> case <a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.<unapply-selector>" title="(t: Throwable)Option[Throwable]">NonFatal</a><span class="delimiter">(</span><a title="Throwable" id="akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.e">e</a><span class="delimiter">)</span> ⇒ <a href="#akka.persistence;Eventsourced.processingCommands;$anon.aroundReceiveComplete" title="(err: Boolean)Unit">aroundReceiveComplete</a><span class="delimiter">(</span>err = true<span class="delimiter">)</span>; throw <a href="#akka.persistence;Eventsourced.processingCommands;$anon.stateReceive.e" title="Throwable">e</a> <span class="delimiter">}</span>

    private def <a title="(err: Boolean)Unit" id="akka.persistence;Eventsourced.processingCommands;$anon.aroundReceiveComplete">aroundReceiveComplete</a><span class="delimiter">(</span><a title="Boolean" id="akka.persistence;Eventsourced.processingCommands;$anon.aroundReceiveComplete.err">err</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.eventBatch_=" title="=&gt; List[akka.persistence.PersistentEnvelope]">eventBatch</a>.<span title="=&gt; Boolean">nonEmpty</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.flushBatch" title="()Unit">flushBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>

      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="=&gt; Long">pendingStashingPersistInvocations</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.changeState" title="(state: Eventsourced.this.State)Unit">changeState</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistingEvents" title="=&gt; Eventsourced.this.State">persistingEvents</a><span class="delimiter">)</span>
      else if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands;$anon.aroundReceiveComplete.err" title="Boolean">err</a><span class="delimiter">)</span>
        <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(aa97cb1b3d)" title="()Unit">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
      else
        <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstash" title="()Unit">unstash</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Event persisting state. Remains until pending events are persisted and then changes
   * state to `processingCommands`. Only events to be persisted are processed. All other
   * messages are stashed internally.
   */</span>
  private val <a title="Eventsourced.this.State" id="akka.persistence;Eventsourced.persistingEvents">persistingEvents</a>: <a href="#akka.persistence;Eventsourced;State" title="Eventsourced.this.State">State</a> = new <a href="#akka.persistence;Eventsourced;ProcessingState" title="&lt;$anon: Eventsourced.this.ProcessingState&gt; extends Eventsourced.this.ProcessingState" id="akka.persistence;Eventsourced.persistingEvents;$anon">ProcessingState</a> <span class="delimiter">{</span>
    override def <a title="()String" id="akka.persistence;Eventsourced.persistingEvents;$anon.toString">toString</a>: <span title="String">String</span> = <span title="String(&quot;persisting events&quot;)" class="string">&quot;persisting events&quot;</span>
    override def <a title="=&gt; Boolean" id="akka.persistence;Eventsourced.persistingEvents;$anon.recoveryRunning">recoveryRunning</a>: <span title="Boolean">Boolean</span> = false

    override def <a title="(receive: Eventsourced.this.Receive, message: Any)Unit" id="akka.persistence;Eventsourced.persistingEvents;$anon.stateReceive">stateReceive</a><span class="delimiter">(</span><a title="Eventsourced.this.Receive" id="akka.persistence;Eventsourced.persistingEvents;$anon.stateReceive.receive">receive</a>: <span title="Eventsourced.this.Receive">Receive</span>, <a title="Any" id="akka.persistence;Eventsourced.persistingEvents;$anon.stateReceive.message">message</a>: <span title="Any">Any</span><span class="delimiter">)</span> =
      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced;ProcessingState.common" title="=&gt; Eventsourced.this.Receive">common</a>.<span title="(x: Any)Boolean">isDefinedAt</span><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistingEvents;$anon.stateReceive.message" title="Any">message</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced;ProcessingState.common" title="(v1: Any)Unit">common</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistingEvents;$anon.stateReceive.message" title="Any">message</a><span class="delimiter">)</span>
      else <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.stash" title="()Unit">stash</a><span class="delimiter">(</span><span class="delimiter">)</span>

    override def <a title="(err: Boolean)Unit" id="akka.persistence;Eventsourced.persistingEvents;$anon.onWriteMessageComplete">onWriteMessageComplete</a><span class="delimiter">(</span><a title="Boolean" id="akka.persistence;Eventsourced.persistingEvents;$anon.onWriteMessageComplete.err">err</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
      <a href="#akka.persistence;Eventsourced.pendingInvocations" title="=&gt; java.util.LinkedList[akka.persistence.Eventsourced.PendingHandlerInvocation]">pendingInvocations</a>.<span title="()akka.persistence.Eventsourced.PendingHandlerInvocation">pop</span><span class="delimiter">(</span><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case _: <a href="#akka.persistence.Eventsourced.StashingHandlerInvocation.readResolve" title="akka.persistence.Eventsourced.StashingHandlerInvocation">StashingHandlerInvocation</a> ⇒
          <span class="comment">// enables an early return to `processingCommands`, because if this counter hits `0`,</span>
          <span class="comment">// we know the remaining pendingInvocations are all `persistAsync` created, which</span>
          <span class="comment">// means we can go back to processing commands also - and these callbacks will be called as soon as possible</span>
          <a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="(x$1: Long)Unit">pendingStashingPersistInvocations</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
        case _ ⇒ <span class="comment">// do nothing</span>
      <span class="delimiter">}</span>

      if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.pendingStashingPersistInvocations_=" title="=&gt; Long">pendingStashingPersistInvocations</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#akka.persistence;Eventsourced.changeState" title="(state: Eventsourced.this.State)Unit">changeState</a><span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.processingCommands" title="=&gt; Eventsourced.this.State">processingCommands</a><span class="delimiter">)</span>
        if <span class="delimiter">(</span><a href="#akka.persistence;Eventsourced.persistingEvents;$anon.onWriteMessageComplete.err" title="Boolean">err</a><span class="delimiter">)</span> <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstashAll(aa97cb1b3d)" title="()Unit">unstashAll</a><span class="delimiter">(</span><span class="delimiter">)</span>
        else <a href="#akka.persistence;Eventsourced.internalStash" title="=&gt; akka.actor.StashSupport">internalStash</a>.<a href="../../../actor/akka/actor/Stash.scala.html#akka.actor;StashSupport.unstash" title="()Unit">unstash</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
