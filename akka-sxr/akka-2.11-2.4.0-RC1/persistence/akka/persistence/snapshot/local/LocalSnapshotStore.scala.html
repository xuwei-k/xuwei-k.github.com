<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>persistence/akka/persistence/snapshot/local/LocalSnapshotStore.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2009-2015 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 * Copyright (C) 2012-2013 Eligotech BV.
 */</span>

package akka.persistence.snapshot.local

import java.io._
import java.net.<span class="delimiter">{</span> URLDecoder, URLEncoder <span class="delimiter">}</span>

import akka.actor.ActorLogging
import akka.persistence._
import akka.persistence.serialization._
import akka.persistence.snapshot._
import akka.serialization.SerializationExtension
import akka.util.<a href="../../../../../actor/akka/util/ByteString.scala.html#akka.util.ByteString" title="akka.util.ByteString.type">ByteString</a>.UTF_8

import scala.collection.immutable
import scala.concurrent.Future
import scala.util._

<span class="comment">/**
 * INTERNAL API
 *
 * Local filesystem backed snapshot store.
 */</span>
private<span class="delimiter">[</span>persistence<span class="delimiter">]</span> class <a title="class LocalSnapshotStore extends AnyRef with akka.persistence.snapshot.SnapshotStore with akka.actor.ActorLogging" id="akka.persistence.snapshot.local;LocalSnapshotStore">LocalSnapshotStore</a> extends <a href="../SnapshotStore.scala.html#akka.persistence.snapshot;SnapshotStore" title="akka.persistence.snapshot.SnapshotStore">SnapshotStore</a> with <a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;ActorLogging" title="akka.actor.ActorLogging">ActorLogging</a> <span class="delimiter">{</span>
  private val <a title="scala.util.matching.Regex" id="akka.persistence.snapshot.local;LocalSnapshotStore.FilenamePattern">FilenamePattern</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&quot;&quot;^snapshot-(.+)-(\d+)-(\d+)&quot;&quot;&quot;</span>.<span title="=&gt; scala.util.matching.Regex">r</span>

  import akka.util.<a href="../../../../../actor/akka/util/Helpers.scala.html#akka.util.Helpers" title="akka.util.Helpers.type">Helpers</a>._
  private val <a title="com.typesafe.config.Config" id="akka.persistence.snapshot.local;LocalSnapshotStore.config">config</a> = <a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.system" title="=&gt; akka.actor.ActorSystem">system</a>.<a href="../../../../../actor/akka/actor/ActorSystem.scala.html#akka.actor;ActorSystem.settings" title="=&gt; akka.actor.ActorSystem.Settings">settings</a>.<a href="../../../../../actor/akka/actor/ActorSystem.scala.html#akka.actor.ActorSystem;Settings.config" title="=&gt; com.typesafe.config.Config">config</a>.<span title="(x$1: String)com.typesafe.config.Config">getConfig</span><span class="delimiter">(</span><span title="String(&quot;akka.persistence.snapshot-store.local&quot;)" class="string">&quot;akka.persistence.snapshot-store.local&quot;</span><span class="delimiter">)</span>
  private val <a title="Int" id="akka.persistence.snapshot.local;LocalSnapshotStore.maxLoadAttempts">maxLoadAttempts</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.config" title="=&gt; com.typesafe.config.Config">config</a>.<span title="(x$1: String)Int">getInt</span><a href="../../../../../actor/akka/util/Helpers.scala.html#akka.util.Helpers.Requiring(1ee601cfa2)" title="(value: Int)akka.util.Helpers.Requiring[Int]" class="delimiter">(</a><span title="String(&quot;max-load-attempts&quot;)" class="string">&quot;max-load-attempts&quot;</span><span class="delimiter">)</span>
    .<a href="../../../../../actor/akka/util/Helpers.scala.html#akka.util.Helpers;Requiring.requiring(734662848f)" title="(cond: Int =&gt; Boolean, msg: =&gt; Any)Int">requiring</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.maxLoadAttempts.$anonfun.x$1" title="Int">_</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span>, <span title="String(&quot;max-load-attempts must be &gt;= 1&quot;)" class="string">&quot;max-load-attempts must be &gt;= 1&quot;</span><span class="delimiter">)</span>

  private val <a title="akka.dispatch.MessageDispatcher" id="akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher">streamDispatcher</a> = <a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.system" title="=&gt; akka.actor.ActorSystem">system</a>.<a href="../../../../../actor/akka/actor/ActorSystem.scala.html#akka.actor;ActorSystem.dispatchers" title="=&gt; akka.dispatch.Dispatchers">dispatchers</a>.<a href="../../../../../actor/akka/dispatch/Dispatchers.scala.html#akka.dispatch;Dispatchers.lookup" title="(id: String)akka.dispatch.MessageDispatcher">lookup</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.config" title="=&gt; com.typesafe.config.Config">config</a>.<span title="(x$1: String)String">getString</span><span class="delimiter">(</span><span title="String(&quot;stream-dispatcher&quot;)" class="string">&quot;stream-dispatcher&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  private val <a title="java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.dir">dir</a> = new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.config" title="=&gt; com.typesafe.config.Config">config</a>.<span title="(x$1: String)String">getString</span><span class="delimiter">(</span><span title="String(&quot;dir&quot;)" class="string">&quot;dir&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

  private val <a title="akka.serialization.Serialization" id="akka.persistence.snapshot.local;LocalSnapshotStore.serializationExtension">serializationExtension</a> = <a href="../../../../../actor/akka/actor/Extension.scala.html#akka.actor;ExtensionId.apply" title="(system: akka.actor.ActorSystem)akka.serialization.Serialization">SerializationExtension</a><span class="delimiter">(</span><a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.system" title="=&gt; akka.actor.ActorSystem">system</a><span class="delimiter">)</span>
  private var <a title="scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.saving_=">saving</a> = immutable.<span title="scala.collection.immutable.Set.type">Set</span>.<span title="[A]=&gt; scala.collection.immutable.Set[A]">empty</span><span title="scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]" class="delimiter">[</span><a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">]</span> <span class="comment">// saving in progress</span>

  override def <a title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria)scala.concurrent.Future[Option[akka.persistence.SelectedSnapshot]]" id="akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync">loadAsync</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.persistenceId">persistenceId</a>: <span title="String">String</span>, <a title="akka.persistence.SnapshotSelectionCriteria" id="akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.criteria">criteria</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotSelectionCriteria" title="akka.persistence.SnapshotSelectionCriteria">SnapshotSelectionCriteria</a><span class="delimiter">)</span>: <span title="scala.concurrent.Future[Option[akka.persistence.SelectedSnapshot]]">Future</span><span class="delimiter">[</span>Option<span class="delimiter">[</span>SelectedSnapshot<span class="delimiter">]</span><span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="comment">//</span>
    <span class="comment">// Heuristics:</span>
    <span class="comment">//</span>
    <span class="comment">// Select youngest `maxLoadAttempts` snapshots that match upper bound.</span>
    <span class="comment">// This may help in situations where saving of a snapshot could not be completed because of a JVM crash.</span>
    <span class="comment">// Hence, an attempt to load that snapshot will fail but loading an older snapshot may succeed.</span>
    <span class="comment">//</span>
    val <a title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.metadata">metadata</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas" title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria)scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">snapshotMetadatas</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.persistenceId" title="String">persistenceId</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.criteria" title="akka.persistence.SnapshotSelectionCriteria">criteria</a><span class="delimiter">)</span>.<a href="../../SnapshotProtocol.scala.html#akka.persistence.SnapshotMetadata.ordering" title="(implicit ord: scala.math.Ordering[akka.persistence.SnapshotMetadata])scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">sorted</a>.<span title="(n: Int)scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">takeRight</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.maxLoadAttempts" title="=&gt; Int">maxLoadAttempts</a><span class="delimiter">)</span>
    <span title="(body: =&gt; Option[akka.persistence.SelectedSnapshot])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[Option[akka.persistence.SelectedSnapshot]]">Future</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load" title="(metadata: scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata])Option[akka.persistence.SelectedSnapshot]">load</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.loadAsync.metadata" title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">metadata</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  override def <a title="(metadata: akka.persistence.SnapshotMetadata, snapshot: Any)scala.concurrent.Future[Unit]" id="akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync">saveAsync</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a>, <a title="Any" id="akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.snapshot">snapshot</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="scala.concurrent.Future[Unit]">Future</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saving_=" title="(x$1: scala.collection.immutable.Set[akka.persistence.SnapshotMetadata])Unit">saving</a> <span title="(elem: akka.persistence.SnapshotMetadata)scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]">+=</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>
    val <a title="scala.concurrent.Future[Unit]" id="akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.completion">completion</a> = <span title="(body: =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[Unit]">Future</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save" title="(metadata: akka.persistence.SnapshotMetadata, snapshot: Any)Unit">save</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.snapshot" title="Any">snapshot</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saveAsync.completion" title="scala.concurrent.Future[Unit]">completion</a>
  <span class="delimiter">}</span>

  override def <a title="(metadata: akka.persistence.SnapshotMetadata)scala.concurrent.Future[Unit]" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e)">deleteAsync</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e).metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">)</span>: <span title="scala.concurrent.Future[Unit]">Future</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saving_=" title="(x$1: scala.collection.immutable.Set[akka.persistence.SnapshotMetadata])Unit">saving</a> <span title="(elem: akka.persistence.SnapshotMetadata)scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]">-=</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e).metadata" title="akka.persistence.SnapshotMetadata">metadata</a>
    <span title="(body: =&gt; scala.collection.immutable.Seq[Boolean])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[scala.collection.immutable.Seq[Boolean]]">Future</span> <span class="delimiter">{</span>
      <span class="comment">// multiple snapshot files here mean that there were multiple snapshots for this seqNr, we delete all of them</span>
      <span class="comment">// usually snapshot-stores would keep one snapshot per sequenceNr however here in the file-based one we timestamp</span>
      <span class="comment">// snapshots and allow multiple to be kept around (for the same seqNr) if desired</span>
      <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFiles" title="(metadata: akka.persistence.SnapshotMetadata)scala.collection.immutable.Seq[java.io.File]">snapshotFiles</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e).metadata" title="akka.persistence.SnapshotMetadata">metadata</a><span class="delimiter">)</span>.<span title="(f: java.io.File =&gt; Boolean)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[java.io.File],Boolean,scala.collection.immutable.Seq[Boolean]])scala.collection.immutable.Seq[Boolean]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq.Coll,Boolean,scala.collection.immutable.Seq[Boolean]]" class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e).$anonfun.x$2" title="java.io.File">_</a>.<span title="()Boolean">delete</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>.<span title="(f: scala.collection.immutable.Seq[Boolean] =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[Unit]">map</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[Boolean]" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e).$anonfun.x$3">_</a> ⇒ <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  override def <a title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria)scala.concurrent.Future[Unit]" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1)">deleteAsync</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).persistenceId">persistenceId</a>: <span title="String">String</span>, <a title="akka.persistence.SnapshotSelectionCriteria" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).criteria">criteria</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotSelectionCriteria" title="akka.persistence.SnapshotSelectionCriteria">SnapshotSelectionCriteria</a><span class="delimiter">)</span>: <span title="scala.concurrent.Future[Unit]">Future</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).metadatas">metadatas</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas" title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria)scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">snapshotMetadatas</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).persistenceId" title="String">persistenceId</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).criteria" title="akka.persistence.SnapshotSelectionCriteria">criteria</a><span class="delimiter">)</span>
    <span title="scala.concurrent.Future.type">Future</span>.<span title="(in: scala.collection.immutable.Seq[scala.concurrent.Future[Unit]])(implicit cbf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[scala.concurrent.Future[Unit]],Unit,scala.collection.immutable.Seq[Unit]], implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[scala.collection.immutable.Seq[Unit]]">sequence</span> <span class="delimiter">{</span>
      <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).metadatas" title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">metadatas</a>.<span title="(f: akka.persistence.SnapshotMetadata =&gt; scala.concurrent.Future[Unit])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata],scala.concurrent.Future[Unit],scala.collection.immutable.Seq[scala.concurrent.Future[Unit]]])scala.collection.immutable.Seq[scala.concurrent.Future[Unit]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq.Coll,scala.concurrent.Future[Unit],scala.collection.immutable.Seq[scala.concurrent.Future[Unit]]]" class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(549211478e)" title="(metadata: akka.persistence.SnapshotMetadata)scala.concurrent.Future[Unit]">deleteAsync</a><span class="delimiter">)</span>
    <span class="delimiter">}</span><span class="delimiter">(</span>collection.<span title="(implicit b: scala.collection.generic.CanBuildFrom[Nothing,Unit,scala.collection.immutable.Seq[Unit]])scala.collection.generic.CanBuildFrom[scala.collection.immutable.Seq[scala.concurrent.Future[Unit]],Unit,scala.collection.immutable.Seq[Unit]]">breakOut</span>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>.<span title="(f: scala.collection.immutable.Seq[Unit] =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[Unit]">map</span><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[Unit]" id="akka.persistence.snapshot.local;LocalSnapshotStore.deleteAsync(306a8a4ab1).$anonfun.x$4">_</a> ⇒ <span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.streamDispatcher" title="=&gt; akka.dispatch.MessageDispatcher">streamDispatcher</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  override def <a title="=&gt; LocalSnapshotStore.this.Receive" id="akka.persistence.snapshot.local;LocalSnapshotStore.receivePluginInternal">receivePluginInternal</a>: <span title="LocalSnapshotStore.this.Receive">Receive</span> = <a title="&lt;$anon: Any =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[Any,Unit] with Serializable" id="akka.persistence.snapshot.local;LocalSnapshotStore.receivePluginInternal;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
    case SaveSnapshotSuccess<span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.receivePluginInternal;$anonfun.isDefinedAt.metadata">metadata</a><span class="delimiter">)</span> ⇒ <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saving_=" title="(x$1: scala.collection.immutable.Set[akka.persistence.SnapshotMetadata])Unit">saving</a> <span title="(elem: akka.persistence.SnapshotMetadata)scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]">-=</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.receivePluginInternal;$anonfun.isDefinedAt.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>
    case _: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SaveSnapshotFailure" title="akka.persistence.SaveSnapshotFailure">SaveSnapshotFailure</a>        ⇒ <span class="comment">// ignore</span>
    case _: <a href="../../SnapshotProtocol.scala.html#akka.persistence;DeleteSnapshotsSuccess" title="akka.persistence.DeleteSnapshotsSuccess">DeleteSnapshotsSuccess</a>     ⇒ <span class="comment">// ignore</span>
    case _: <a href="../../SnapshotProtocol.scala.html#akka.persistence;DeleteSnapshotsFailure" title="akka.persistence.DeleteSnapshotsFailure">DeleteSnapshotsFailure</a>     ⇒ <span class="comment">// ignore</span>
  <span class="delimiter">}</span>

  private def <a title="(metadata: akka.persistence.SnapshotMetadata)scala.collection.immutable.Seq[java.io.File]" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFiles">snapshotFiles</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFiles.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">)</span>: immutable.<span title="scala.collection.immutable.Seq[java.io.File]">Seq</span><span class="delimiter">[</span>File<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotDir" title="()java.io.File">snapshotDir</a>.<span title="(x$1: java.io.FilenameFilter)Array[java.io.File]">listFiles</span><span title="(xs: Array[java.io.File])scala.collection.mutable.ArrayOps[java.io.File]" class="delimiter">(</span>new <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter" title="LocalSnapshotStore.this.SnapshotSeqNrFilenameFilter">SnapshotSeqNrFilenameFilter</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFiles.metadata" title="akka.persistence.SnapshotMetadata">metadata</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Vector[java.io.File]">toVector</span>
  <span class="delimiter">}</span>

  @scala.annotation.tailrec
  private def <a title="(metadata: scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata])Option[akka.persistence.SelectedSnapshot]" id="akka.persistence.snapshot.local;LocalSnapshotStore.load">load</a><span class="delimiter">(</span><a title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.load.metadata">metadata</a>: immutable.<span title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">Seq</span><span class="delimiter">[</span>SnapshotMetadata<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Option[akka.persistence.SelectedSnapshot]">Option</span><span class="delimiter">[</span>SelectedSnapshot<span class="delimiter">]</span> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.metadata" title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">metadata</a>.<span title="=&gt; Option[akka.persistence.SnapshotMetadata]">lastOption</span> match <span class="delimiter">{</span>
    case <span title="None.type">None</span> ⇒ <span title="None.type">None</span>
    case Some<span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.load.md">md</a><span class="delimiter">)</span> ⇒
      <span title="(r: =&gt; akka.persistence.serialization.Snapshot)scala.util.Try[akka.persistence.serialization.Snapshot]">Try</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream" title="(metadata: akka.persistence.SnapshotMetadata)(p: java.io.InputStream =&gt; akka.persistence.serialization.Snapshot)akka.persistence.serialization.Snapshot">withInputStream</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.md" title="akka.persistence.SnapshotMetadata">md</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deserialize" title="(inputStream: java.io.InputStream)akka.persistence.serialization.Snapshot">deserialize</a><span class="delimiter">)</span><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case Success<span class="delimiter">(</span><a title="akka.persistence.serialization.Snapshot" id="akka.persistence.snapshot.local;LocalSnapshotStore.load.s">s</a><span class="delimiter">)</span> ⇒ <span title="(x: akka.persistence.SelectedSnapshot)Some[akka.persistence.SelectedSnapshot]">Some</span><span class="delimiter">(</span><a href="../../SnapshotProtocol.scala.html#akka.persistence;SelectedSnapshot" title="(metadata: akka.persistence.SnapshotMetadata, snapshot: Any)akka.persistence.SelectedSnapshot">SelectedSnapshot</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.md" title="akka.persistence.SnapshotMetadata">md</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.s" title="akka.persistence.serialization.Snapshot">s</a>.<a href="../../serialization/SnapshotSerializer.scala.html#akka.persistence.serialization;Snapshot.data" title="=&gt; Any">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case Failure<span class="delimiter">(</span><a title="Throwable" id="akka.persistence.snapshot.local;LocalSnapshotStore.load.e">e</a><span class="delimiter">)</span> ⇒
          <a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;ActorLogging.log" title="=&gt; akka.event.LoggingAdapter">log</a>.<a href="../../../../../actor/akka/event/Logging.scala.html#akka.event;LoggingAdapter.error(de736aeaab)" title="(cause: Throwable, message: String)Unit">error</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.e" title="Throwable">e</a>, <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Error loading snapshot [&quot;)">Error loading snapshot [$</span><span class="delimiter">{</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.md" title="akka.persistence.SnapshotMetadata">md</a><span class="delimiter">}</span><span title="String(&quot;]&quot;)" class="string">]&quot;</span><span class="delimiter">)</span>
          <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load" title="(metadata: scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata])Option[akka.persistence.SelectedSnapshot]">load</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.load.metadata" title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">metadata</a>.<span title="=&gt; scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">init</span><span class="delimiter">)</span> <span class="comment">// try older snapshot</span>
      <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  protected def <a title="(metadata: akka.persistence.SnapshotMetadata, snapshot: Any)Unit" id="akka.persistence.snapshot.local;LocalSnapshotStore.save">save</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.save.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a>, <a title="Any" id="akka.persistence.snapshot.local;LocalSnapshotStore.save.snapshot">snapshot</a>: <span title="Any">Any</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    val <a title="java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.save.tmpFile">tmpFile</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream" title="(metadata: akka.persistence.SnapshotMetadata)(p: java.io.OutputStream =&gt; Unit)java.io.File">withOutputStream</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save.metadata" title="akka.persistence.SnapshotMetadata">metadata</a><span class="delimiter">)</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serialize" title="(outputStream: java.io.OutputStream, snapshot: akka.persistence.serialization.Snapshot)Unit">serialize</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save.tmpFile.$anonfun.x$5" title="java.io.OutputStream">_</a>, <a href="../../serialization/SnapshotSerializer.scala.html#akka.persistence.serialization;Snapshot" title="(data: Any)akka.persistence.serialization.Snapshot">Snapshot</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save.snapshot" title="Any">snapshot</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save.tmpFile" title="java.io.File">tmpFile</a>.<span title="(x$1: java.io.File)Boolean">renameTo</span><span title="Unit" class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite" title="(metadata: akka.persistence.SnapshotMetadata, extension: String)java.io.File">snapshotFileForWrite</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.save.metadata" title="akka.persistence.SnapshotMetadata">metadata</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  protected def <a title="(inputStream: java.io.InputStream)akka.persistence.serialization.Snapshot" id="akka.persistence.snapshot.local;LocalSnapshotStore.deserialize">deserialize</a><span class="delimiter">(</span><a title="java.io.InputStream" id="akka.persistence.snapshot.local;LocalSnapshotStore.deserialize.inputStream">inputStream</a>: <span title="java.io.InputStream">InputStream</span><span class="delimiter">)</span>: <a href="../../serialization/SnapshotSerializer.scala.html#akka.persistence.serialization;Snapshot" title="akka.persistence.serialization.Snapshot">Snapshot</a> =
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serializationExtension" title="=&gt; akka.serialization.Serialization">serializationExtension</a>.<a href="../../../../../actor/akka/serialization/Serialization.scala.html#akka.serialization;Serialization.deserialize(2392165273)" title="(bytes: Array[Byte], clazz: Class[akka.persistence.serialization.Snapshot])scala.util.Try[akka.persistence.serialization.Snapshot]">deserialize</a><span class="delimiter">(</span><a href="../../serialization/package.scala.html#akka.persistence.serialization.package.streamToBytes" title="(inputStream: java.io.InputStream)Array[Byte]">streamToBytes</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.deserialize.inputStream" title="java.io.InputStream">inputStream</a><span class="delimiter">)</span>, classOf<span title="Class[akka.persistence.serialization.Snapshot](classOf[akka.persistence.serialization.Snapshot])" class="delimiter">[</span>Snapshot<span class="delimiter">]</span><span class="delimiter">)</span>.<span title="=&gt; akka.persistence.serialization.Snapshot">get</span>

  protected def <a title="(outputStream: java.io.OutputStream, snapshot: akka.persistence.serialization.Snapshot)Unit" id="akka.persistence.snapshot.local;LocalSnapshotStore.serialize">serialize</a><span class="delimiter">(</span><a title="java.io.OutputStream" id="akka.persistence.snapshot.local;LocalSnapshotStore.serialize.outputStream">outputStream</a>: <span title="java.io.OutputStream">OutputStream</span>, <a title="akka.persistence.serialization.Snapshot" id="akka.persistence.snapshot.local;LocalSnapshotStore.serialize.snapshot">snapshot</a>: <a href="../../serialization/SnapshotSerializer.scala.html#akka.persistence.serialization;Snapshot" title="akka.persistence.serialization.Snapshot">Snapshot</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serialize.outputStream" title="java.io.OutputStream">outputStream</a>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serializationExtension" title="=&gt; akka.serialization.Serialization">serializationExtension</a>.<a href="../../../../../actor/akka/serialization/Serialization.scala.html#akka.serialization;Serialization.findSerializerFor" title="(o: AnyRef)akka.serialization.Serializer">findSerializerFor</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serialize.snapshot" title="akka.persistence.serialization.Snapshot">snapshot</a><span class="delimiter">)</span>.<a href="../../../../../actor/akka/serialization/Serializer.scala.html#akka.serialization;Serializer.toBinary" title="(o: AnyRef)Array[Byte]">toBinary</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.serialize.snapshot" title="akka.persistence.serialization.Snapshot">snapshot</a><span class="delimiter">)</span><span class="delimiter">)</span>

  protected def <a title="(metadata: akka.persistence.SnapshotMetadata)(p: java.io.OutputStream =&gt; Unit)java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream">withOutputStream</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="java.io.OutputStream =&gt; Unit" id="akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.p">p</a>: <span class="delimiter">(</span>OutputStream<span class="delimiter">)</span> ⇒ Unit<span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
    val <a title="java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.tmpFile">tmpFile</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite" title="(metadata: akka.persistence.SnapshotMetadata, extension: String)java.io.File">snapshotFileForWrite</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>, extension = <span title="String(&quot;tmp&quot;)" class="string">&quot;tmp&quot;</span><span class="delimiter">)</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream" title="(stream: java.io.BufferedOutputStream, p: java.io.BufferedOutputStream =&gt; Unit)Unit">withStream</a><span class="delimiter">(</span>new <span title="java.io.BufferedOutputStream">BufferedOutputStream</span><span class="delimiter">(</span>new <span title="java.io.FileOutputStream">FileOutputStream</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.tmpFile" title="java.io.File">tmpFile</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.p" title="java.io.OutputStream =&gt; Unit">p</a><span class="delimiter">)</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withOutputStream.tmpFile" title="java.io.File">tmpFile</a>
  <span class="delimiter">}</span>

  private def <a title="[T](metadata: akka.persistence.SnapshotMetadata)(p: java.io.InputStream =&gt; T)T" id="akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream">withInputStream</a><span class="delimiter">[</span><a title="" id="akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">)</span><span class="delimiter">(</span><a title="java.io.InputStream =&gt; T" id="akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream.p">p</a>: <span class="delimiter">(</span>InputStream<span class="delimiter">)</span> ⇒ T<span class="delimiter">)</span>: <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream;T" title="T">T</a> =
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream" title="(stream: java.io.BufferedInputStream, p: java.io.BufferedInputStream =&gt; T)T">withStream</a><span class="delimiter">(</span>new <span title="java.io.BufferedInputStream">BufferedInputStream</span><span class="delimiter">(</span>new <span title="java.io.FileInputStream">FileInputStream</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite" title="(metadata: akka.persistence.SnapshotMetadata, extension: String)java.io.File">snapshotFileForWrite</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream.metadata" title="akka.persistence.SnapshotMetadata">metadata</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withInputStream.p" title="java.io.InputStream =&gt; T">p</a><span class="delimiter">)</span>

  private def <a title="[A &lt;: java.io.Closeable, B](stream: A, p: A =&gt; B)B" id="akka.persistence.snapshot.local;LocalSnapshotStore.withStream">withStream</a><span class="delimiter">[</span><a title=" &lt;: java.io.Closeable" id="akka.persistence.snapshot.local;LocalSnapshotStore.withStream;A">A</a> &lt;: Closeable, <a title="" id="akka.persistence.snapshot.local;LocalSnapshotStore.withStream;B">B</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="A" id="akka.persistence.snapshot.local;LocalSnapshotStore.withStream.stream">stream</a>: <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream;A" title="A">A</a>, <a title="A =&gt; B" id="akka.persistence.snapshot.local;LocalSnapshotStore.withStream.p">p</a>: A ⇒ B<span class="delimiter">)</span>: <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream;B" title="B">B</a> =
    try <span class="delimiter">{</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream.p" title="(v1: A)B">p</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream.stream" title="A">stream</a><span class="delimiter">)</span> <span class="delimiter">}</span> finally <span class="delimiter">{</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.withStream.stream" title="A">stream</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">}</span>

  <span class="comment">/** Only by persistenceId and sequenceNr, timestamp is informational - accomodates for 2.13.x series files */</span>
  private def <a title="(metadata: akka.persistence.SnapshotMetadata, extension: String)java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite">snapshotFileForWrite</a><span class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite.metadata">metadata</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite$default$2">extension</a>: <span title="String">String</span> = <span title="String(&quot;&quot;)" class="string">&quot;&quot;</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> =
    new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotDir" title="()java.io.File">snapshotDir</a>, <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;snapshot-&quot;)">snapshot-$</span><span class="delimiter">{</span><span title="java.net.URLEncoder.type">URLEncoder</span>.<span title="(x$1: String, x$2: String)String">encode</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.persistenceId" title="=&gt; String">persistenceId</a>, <a href="../../../../../actor/akka/util/ByteString.scala.html#akka.util.ByteString.UTF_8" title="=&gt; String">UTF_8</a><span class="delimiter">)</span><span class="delimiter">}</span><span title="String(&quot;-&quot;)">-$</span><span class="delimiter">{</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.sequenceNr" title="=&gt; Long">sequenceNr</a><span class="delimiter">}</span><span title="String(&quot;-&quot;)">-$</span><span class="delimiter">{</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite.metadata" title="akka.persistence.SnapshotMetadata">metadata</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.timestamp" title="=&gt; Long">timestamp</a><span class="delimiter">}</span><span title="String(&quot;&quot;)">$</span><span class="delimiter">{</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotFileForWrite$default$2" title="String">extension</a><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>

  private def <a title="(persistenceId: String, criteria: akka.persistence.SnapshotSelectionCriteria)scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas">snapshotMetadatas</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.persistenceId">persistenceId</a>: <span title="String">String</span>, <a title="akka.persistence.SnapshotSelectionCriteria" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.criteria">criteria</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotSelectionCriteria" title="akka.persistence.SnapshotSelectionCriteria">SnapshotSelectionCriteria</a><span class="delimiter">)</span>: immutable.<span title="scala.collection.immutable.Seq[akka.persistence.SnapshotMetadata]">Seq</span><span class="delimiter">[</span>SnapshotMetadata<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="Array[java.io.File]" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.files">files</a> = <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotDir" title="()java.io.File">snapshotDir</a>.<span title="(x$1: java.io.FilenameFilter)Array[java.io.File]">listFiles</span><span class="delimiter">(</span>new <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter" title="LocalSnapshotStore.this.SnapshotFilenameFilter">SnapshotFilenameFilter</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.persistenceId" title="String">persistenceId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    if <span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.files" title="Array[java.io.File]">files</a> <span title="(x$1: AnyRef)Boolean">eq</span> null<span class="delimiter">)</span> <span title="scala.collection.immutable.Nil.type">Nil</span> <span class="comment">// if the dir was removed</span>
    else <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.files" title="(xs: Array[java.io.File])scala.collection.mutable.ArrayOps[java.io.File]">files</a>.<span title="(f: java.io.File =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Array[java.io.File],String,Array[String]])Array[String]">map</span><span title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]" class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.$anonfun.x$6" title="java.io.File">_</a>.<span title="()String">getName</span><span class="delimiter">)</span>.<span title="(pf: PartialFunction[String,akka.persistence.SnapshotMetadata])(implicit bf: scala.collection.generic.CanBuildFrom[Array[String],akka.persistence.SnapshotMetadata,Array[akka.persistence.SnapshotMetadata]])Array[akka.persistence.SnapshotMetadata]">collect</span> <a title="(xs: Array[akka.persistence.SnapshotMetadata])scala.collection.mutable.ArrayOps[akka.persistence.SnapshotMetadata]" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
      case <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.FilenamePattern" title="(s: CharSequence)Option[List[String]]">FilenamePattern</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.pid">pid</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.snr">snr</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.tms">tms</a><span class="delimiter">)</span> ⇒ <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="(persistenceId: String, sequenceNr: Long, timestamp: Long)akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span title="Boolean(true)" class="delimiter">(</span><span title="java.net.URLDecoder.type">URLDecoder</span>.<span title="(x$1: String, x$2: String)String">decode</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.pid" title="String">pid</a>, <a href="../../../../../actor/akka/util/ByteString.scala.html#akka.util.ByteString.UTF_8" title="=&gt; String">UTF_8</a><span class="delimiter">)</span>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.snr" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">snr</a>.<span title="=&gt; Long">toLong</span>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas;$anonfun.isDefinedAt.tms" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">tms</a>.<span title="=&gt; Long">toLong</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(p: akka.persistence.SnapshotMetadata =&gt; Boolean)Array[akka.persistence.SnapshotMetadata]">filter</span><span title="(xs: Array[akka.persistence.SnapshotMetadata])scala.collection.mutable.ArrayOps[akka.persistence.SnapshotMetadata]" class="delimiter">(</span><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.$anonfun.md">md</a> ⇒ <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.criteria" title="akka.persistence.SnapshotSelectionCriteria">criteria</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotSelectionCriteria.matches" title="(metadata: akka.persistence.SnapshotMetadata)Boolean">matches</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.$anonfun.md" title="akka.persistence.SnapshotMetadata">md</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.saving_=" title="=&gt; scala.collection.immutable.Set[akka.persistence.SnapshotMetadata]">saving</a>.<span title="(elem: akka.persistence.SnapshotMetadata)Boolean">contains</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotMetadatas.$anonfun.md" title="akka.persistence.SnapshotMetadata">md</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; Vector[akka.persistence.SnapshotMetadata]">toVector</span>
  <span class="delimiter">}</span>

  override def <a title="()Unit" id="akka.persistence.snapshot.local;LocalSnapshotStore.preStart">preStart</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.snapshotDir" title="()java.io.File">snapshotDir</a><span class="delimiter">(</span><span class="delimiter">)</span>
    super.<a href="../../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.preStart" title="()Unit">preStart</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore.snapshotDir">snapshotDir</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.dir" title="=&gt; java.io.File">dir</a>.<span title="()Boolean">isDirectory</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// try to create the directory, on failure double check if someone else beat us to it</span>
      if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.dir" title="=&gt; java.io.File">dir</a>.<span title="()Boolean">mkdirs</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.dir" title="=&gt; java.io.File">dir</a>.<span title="()Boolean">isDirectory</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        throw new <span title="java.io.IOException">IOException</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Failed to create snapshot directory [&quot;)">Failed to create snapshot directory [$</span><span class="delimiter">{</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore.dir" title="=&gt; java.io.File">dir</a>.<span title="()String">getCanonicalPath</span><span class="delimiter">}</span><span title="String(&quot;]&quot;)" class="string">]&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.dir" title="=&gt; java.io.File">dir</a>
  <span class="delimiter">}</span>

  private final class <a title="class SnapshotFilenameFilter extends Object with java.io.FilenameFilter" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter">SnapshotFilenameFilter</a><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter" title="LocalSnapshotStore.this.SnapshotFilenameFilter" class="delimiter">(</a><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.persistenceId">persistenceId</a>: <span title="String">String</span><span class="delimiter">)</span> extends <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter" title="java.io.FilenameFilter">FilenameFilter</a> <span class="delimiter">{</span>
    def <a title="(dir: java.io.File, name: String)Boolean" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept">accept</a><span class="delimiter">(</span><a title="java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.dir">dir</a>: <span title="java.io.File">File</span>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.name">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
      <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.name" title="String">name</a> match <span class="delimiter">{</span>
        case <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.FilenamePattern" title="(s: CharSequence)Option[List[String]]">FilenamePattern</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.pid">pid</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.snr">snr</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.tms">tms</a><span class="delimiter">)</span> ⇒ <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.accept.pid" title="String">pid</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><span title="java.net.URLEncoder.type">URLEncoder</span>.<span title="(x$1: String)String">encode</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotFilenameFilter.persistenceId" title="String">persistenceId</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case _                              ⇒ false
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private final class <a title="class SnapshotSeqNrFilenameFilter extends Object with java.io.FilenameFilter" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter">SnapshotSeqNrFilenameFilter</a><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter" title="LocalSnapshotStore.this.SnapshotSeqNrFilenameFilter" class="delimiter">(</a><a title="akka.persistence.SnapshotMetadata" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.md">md</a>: <a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata" title="akka.persistence.SnapshotMetadata">SnapshotMetadata</a><span class="delimiter">)</span> extends <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter" title="java.io.FilenameFilter">FilenameFilter</a> <span class="delimiter">{</span>
    private final def <a title="(pid: String, snr: String, tms: String)Boolean" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches">matches</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.pid">pid</a>: <span title="String">String</span>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.snr">snr</a>: <span title="String">String</span>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.tms">tms</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
      <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.pid" title="String">pid</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><span title="java.net.URLEncoder.type">URLEncoder</span>.<span title="(x$1: String)String">encode</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.md" title="akka.persistence.SnapshotMetadata">md</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.persistenceId" title="=&gt; String">persistenceId</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
        <span title="(r: =&gt; Boolean)scala.util.Try[Boolean]">Try</span><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.snr" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">snr</a>.<span title="=&gt; Long">toLong</span> <span title="(x: Long)Boolean">==</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.md" title="akka.persistence.SnapshotMetadata">md</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.sequenceNr" title="=&gt; Long">sequenceNr</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.md" title="akka.persistence.SnapshotMetadata">md</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.timestamp" title="=&gt; Long">timestamp</a> <span title="(x: Long)Boolean">==</span> <span title="Long(0L)" class="long">0L</span> <span title="(x: Boolean)Boolean">||</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches.tms" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">tms</a>.<span title="=&gt; Long">toLong</span> <span title="(x: Long)Boolean">==</span> <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.md" title="akka.persistence.SnapshotMetadata">md</a>.<a href="../../SnapshotProtocol.scala.html#akka.persistence;SnapshotMetadata.timestamp" title="=&gt; Long">timestamp</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
    <span class="delimiter">}</span>

    def <a title="(dir: java.io.File, name: String)Boolean" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept">accept</a><span class="delimiter">(</span><a title="java.io.File" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.dir">dir</a>: <span title="java.io.File">File</span>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.name">name</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> =
      <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.name" title="String">name</a> match <span class="delimiter">{</span>
        case <a href="#akka.persistence.snapshot.local;LocalSnapshotStore.FilenamePattern" title="(s: CharSequence)Option[List[String]]">FilenamePattern</a><span class="delimiter">(</span><a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.pid">pid</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.snr">snr</a>, <a title="String" id="akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.tms">tms</a><span class="delimiter">)</span> ⇒ <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.matches" title="(pid: String, snr: String, tms: String)Boolean">matches</a><span class="delimiter">(</span><a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.pid" title="String">pid</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.snr" title="String">snr</a>, <a href="#akka.persistence.snapshot.local;LocalSnapshotStore;SnapshotSeqNrFilenameFilter.accept.tms" title="String">tms</a><span class="delimiter">)</span>
        case _                              ⇒ false
      <span class="delimiter">}</span>

  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
