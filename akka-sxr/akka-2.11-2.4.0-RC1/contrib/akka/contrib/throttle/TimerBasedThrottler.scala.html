<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>contrib/akka/contrib/throttle/TimerBasedThrottler.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2009-2015 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>

package akka.contrib.throttle

import scala.concurrent.duration.<span class="delimiter">{</span> Duration, FiniteDuration <span class="delimiter">}</span>
import scala.util.control.NonFatal
import scala.collection.immutable.<span class="delimiter">{</span> Queue â‡’ Q <span class="delimiter">}</span>
import akka.actor.<span class="delimiter">{</span> ActorRef, Actor, FSM <span class="delimiter">}</span>
import <a href="#akka.contrib.throttle.Throttler" title="akka.contrib.throttle.Throttler.type">Throttler</a>._
import <a href="#akka.contrib.throttle.TimerBasedThrottler" title="akka.contrib.throttle.TimerBasedThrottler.type">TimerBasedThrottler</a>._
import java.util.concurrent.TimeUnit
import akka.AkkaException

<span class="comment">/**
 * @see [[akka.contrib.throttle.TimerBasedThrottler]]
 * @see [[akka.contrib.throttle.Throttler.Rate]]
 * @see [[akka.contrib.throttle.Throttler.SetRate]]
 * @see [[akka.contrib.throttle.Throttler.SetTarget]]
 */</span>
object <a title="akka.contrib.throttle.Throttler.type" id="akka.contrib.throttle.Throttler">Throttler</a> <a href="#akka.contrib.throttle.Throttler" title="akka.contrib.throttle.Throttler.type" class="delimiter">{</a>
  <span class="comment">/**
   * A rate used for throttling.
   *
   * Scala API: There are some shorthands available to construct rates:
   * {{{
   *  import java.util.concurrent.TimeUnit._
   *  import scala.concurrent.duration.{ Duration, FiniteDuration }
   *
   *  val rate1 = 1 msgsPer (1, SECONDS)
   *  val rate2 = 1 msgsPer Duration(1, SECONDS)
   *  val rate3 = 1 msgsPer (1 seconds)
   *  val rate4 = 1 msgsPerSecond
   *  val rate5 = 1 msgsPerMinute
   *  val rate6 = 1 msgsPerHour
   * }}}
   *
   * @param numberOfCalls the number of calls that may take place in a period
   * @param duration the length of the period
   * @see [[akka.contrib.throttle.Throttler]]
   */</span>
  final case class <a title="class Rate extends AnyRef with Product with Serializable" id="akka.contrib.throttle.Throttler.Rate.readResolve">Rate</a><a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="Product" class="delimiter">(</a>val <a title="Int" id="akka.contrib.throttle.Throttler;Rate.numberOfCalls">numberOfCalls</a>: <span title="Int">Int</span>, val <a title="scala.concurrent.duration.FiniteDuration" id="akka.contrib.throttle.Throttler;Rate.duration">duration</a>: <span title="scala.concurrent.duration.FiniteDuration">FiniteDuration</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">/**
     * The duration in milliseconds.
     */</span>
    def <a title="()Long" id="akka.contrib.throttle.Throttler;Rate.durationInMillis">durationInMillis</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Long">Long</span> = <a href="#akka.contrib.throttle.Throttler;Rate.duration" title="=&gt; scala.concurrent.duration.FiniteDuration">duration</a>.<span title="=&gt; Long">toMillis</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Set the target of a throttler.
   *
   * You may change a throttler's target at any time.
   *
   * Notice that the messages sent by the throttler to the target will have the original sender (and
   * not the throttler) as the sender. (In Akka terms, the throttler `forward`s the message.)
   *
   * @param target if `target` is `None`, the throttler will stop delivering messages and the messages already received
   *  but not yet delivered, as well as any messages received in the future will be queued
   *  and eventually be delivered when a new target is set. If `target` is not `None`, the currently queued messages
   *  as well as any messages received in the future will be delivered to the new target at a rate not exceeding the current throttler's rate.
   */</span>
  final case class <a title="class SetTarget extends AnyRef with Product with Serializable" id="akka.contrib.throttle.Throttler.SetTarget.readResolve">SetTarget</a><a href="#akka.contrib.throttle.Throttler.SetTarget.readResolve" title="Product" class="delimiter">(</a><a title="Option[akka.actor.ActorRef]" id="akka.contrib.throttle.Throttler;SetTarget.target">target</a>: <span title="Option[akka.actor.ActorRef]">Option</span><span class="delimiter">[</span>ActorRef<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">/**
     * Java API:
     * @param target if `target` is `null`, the throttler will stop delivering messages and the messages already received
     *  but not yet delivered, as well as any messages received in the future will be queued
     *  and eventually be delivered when a new target is set. If `target` is not `null`, the currently queued messages
     *  as well as any messages received in the future will be delivered to the new target at a rate not exceeding
     *  the current throttler's rate.
     */</span>
    def this<span class="delimiter">(</span><a title="akka.actor.ActorRef" id="akka.contrib.throttle.Throttler;SetTarget.<init>(dc642c1f80).target">target</a>: <a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef" title="akka.actor.ActorRef">ActorRef</a><span class="delimiter">)</span> = this<span class="delimiter">(</span><span title="(x: akka.actor.ActorRef)Option[akka.actor.ActorRef]">Option</span><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler;SetTarget.<init>(dc642c1f80).target" title="akka.actor.ActorRef">target</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Set the rate of a throttler.
   *
   * You may change a throttler's rate at any time.
   *
   * @param rate the rate at which messages will be delivered to the target of the throttler
   */</span>
  final case class <a title="class SetRate extends AnyRef with Product with Serializable" id="akka.contrib.throttle.Throttler.SetRate.readResolve">SetRate</a><a href="#akka.contrib.throttle.Throttler.SetRate.readResolve" title="Product" class="delimiter">(</a><a title="akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;SetRate.rate">rate</a>: <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">)</span>

  import <span title="language.type">language</span>.implicitConversions

  <span class="comment">/**
   * Helper for some syntactic sugar.
   *
   * @see [[akka.contrib.throttle.Throttler.Rate]]
   */</span>
  implicit class <a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="class RateInt extends AnyVal" id="akka.contrib.throttle.Throttler.RateInt(600d6fb648)">RateInt</a><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648)" title="akka.contrib.throttle.Throttler.RateInt" class="delimiter">(</a>val <a title="Int" id="akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls">numberOfCalls</a>: <span title="Int">Int</span><span class="delimiter">)</span> extends <a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648)" title="AnyVal">AnyVal</a> <span class="delimiter">{</span>
    def <a title="(duration: Int, timeUnit: java.util.concurrent.TimeUnit)akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;RateInt.msgsPer(f10fe591c4)">msgsPer</a><span class="delimiter">(</span><a title="Int" id="akka.contrib.throttle.Throttler;RateInt.msgsPer(f10fe591c4).duration">duration</a>: <span title="Int">Int</span>, <a title="java.util.concurrent.TimeUnit" id="akka.contrib.throttle.Throttler;RateInt.msgsPer(f10fe591c4).timeUnit">timeUnit</a>: <span title="java.util.concurrent.TimeUnit">TimeUnit</span><span class="delimiter">)</span> = <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="(numberOfCalls: Int, duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <span title="(length: Long, unit: scala.concurrent.duration.TimeUnit)scala.concurrent.duration.FiniteDuration">Duration</span><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler;RateInt.msgsPer(f10fe591c4).duration" title="=&gt; Long">duration</a>, <a href="#akka.contrib.throttle.Throttler;RateInt.msgsPer(f10fe591c4).timeUnit" title="java.util.concurrent.TimeUnit">timeUnit</a><span class="delimiter">)</span><span class="delimiter">)</span>
    def <a title="(duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;RateInt.msgsPer(eb82e1c998)">msgsPer</a><span class="delimiter">(</span><a title="scala.concurrent.duration.FiniteDuration" id="akka.contrib.throttle.Throttler;RateInt.msgsPer(eb82e1c998).duration">duration</a>: <span title="scala.concurrent.duration.FiniteDuration">FiniteDuration</span><span class="delimiter">)</span> = <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="(numberOfCalls: Int, duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <a href="#akka.contrib.throttle.Throttler;RateInt.msgsPer(eb82e1c998).duration" title="scala.concurrent.duration.FiniteDuration">duration</a><span class="delimiter">)</span>
    def <a title="=&gt; akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;RateInt.msgsPerSecond">msgsPerSecond</a> = <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="(numberOfCalls: Int, duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <span title="(length: Long, unit: scala.concurrent.duration.TimeUnit)scala.concurrent.duration.FiniteDuration">Duration</span><span class="delimiter">(</span><span title="Long(1L)" class="int">1</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span><span class="delimiter">)</span>
    def <a title="=&gt; akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;RateInt.msgsPerMinute">msgsPerMinute</a> = <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="(numberOfCalls: Int, duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <span title="(length: Long, unit: scala.concurrent.duration.TimeUnit)scala.concurrent.duration.FiniteDuration">Duration</span><span class="delimiter">(</span><span title="Long(1L)" class="int">1</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(MINUTES)">MINUTES</span><span class="delimiter">)</span><span class="delimiter">)</span>
    def <a title="=&gt; akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle.Throttler;RateInt.msgsPerHour">msgsPerHour</a> = <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="(numberOfCalls: Int, duration: scala.concurrent.duration.FiniteDuration)akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.Throttler.RateInt(600d6fb648).numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <span title="(length: Long, unit: scala.concurrent.duration.TimeUnit)scala.concurrent.duration.FiniteDuration">Duration</span><span class="delimiter">(</span><span title="Long(1L)" class="int">1</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(HOURS)">HOURS</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>throttle<span class="delimiter">]</span> object <a title="akka.contrib.throttle.TimerBasedThrottler.type" id="akka.contrib.throttle.TimerBasedThrottler">TimerBasedThrottler</a> <a href="#akka.contrib.throttle.TimerBasedThrottler" title="akka.contrib.throttle.TimerBasedThrottler.type" class="delimiter">{</a>
  case object <a href="#akka.contrib.throttle.TimerBasedThrottler.Tick.productElement.x$1" title="akka.contrib.throttle.TimerBasedThrottler.Tick.type" id="akka.contrib.throttle.TimerBasedThrottler.Tick.readResolve">Tick</a>

  <span class="comment">// States of the FSM: A `TimerBasedThrottler` is in state `Active` iff the timer is running.</span>
  sealed trait <a title="trait State extends AnyRef" id="akka.contrib.throttle.TimerBasedThrottler;State">State</a>
  case object <a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.productElement.x$1" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type" id="akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve">Idle</a> extends <a href="#akka.contrib.throttle.TimerBasedThrottler;State" title="akka.contrib.throttle.TimerBasedThrottler.State">State</a>
  case object <a href="#akka.contrib.throttle.TimerBasedThrottler.Active.productElement.x$1" title="akka.contrib.throttle.TimerBasedThrottler.Active.type" id="akka.contrib.throttle.TimerBasedThrottler.Active.readResolve">Active</a> extends <a href="#akka.contrib.throttle.TimerBasedThrottler;State" title="akka.contrib.throttle.TimerBasedThrottler.State">State</a>

  <span class="comment">// Messages, as we queue them to be sent later</span>
  final case class <a title="class Message extends AnyRef with Product with Serializable" id="akka.contrib.throttle.TimerBasedThrottler.Message.readResolve">Message</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Message.readResolve" title="Product" class="delimiter">(</a><a title="Any" id="akka.contrib.throttle.TimerBasedThrottler;Message.message">message</a>: <span title="Any">Any</span>, <a title="akka.actor.ActorRef" id="akka.contrib.throttle.TimerBasedThrottler;Message.sender">sender</a>: <a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef" title="akka.actor.ActorRef">ActorRef</a><span class="delimiter">)</span>

  <span class="comment">// The data of the FSM</span>
  final case class <a title="class Data extends AnyRef with Product with Serializable" id="akka.contrib.throttle.TimerBasedThrottler.Data.readResolve">Data</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="Product" class="delimiter">(</a><a title="Option[akka.actor.ActorRef]" id="akka.contrib.throttle.TimerBasedThrottler;Data.target">target</a>: <span title="Option[akka.actor.ActorRef]">Option</span><span class="delimiter">[</span>ActorRef<span class="delimiter">]</span>,
                        <a title="Int" id="akka.contrib.throttle.TimerBasedThrottler;Data.callsLeftInThisPeriod">callsLeftInThisPeriod</a>: <span title="Int">Int</span>,
                        <a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]" id="akka.contrib.throttle.TimerBasedThrottler;Data.queue">queue</a>: <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">Q</span><span class="delimiter">[</span>Message<span class="delimiter">]</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * A throttler that uses a timer to control the message delivery rate.
 *
 * == Throttling ==
 * A &lt;em&gt;throttler&lt;/em&gt; is an actor that is defined through a &lt;em&gt;target actor&lt;/em&gt; and a &lt;em&gt;rate&lt;/em&gt;
 * (of type [[akka.contrib.throttle.Throttler.Rate]]). You set or change the target and rate at any time through the
 * [[akka.contrib.throttle.Throttler.SetTarget]] and [[akka.contrib.throttle.Throttler.SetRate]]
 * messages, respectively. When you send the throttler any other message `msg`, it will
 * put the message `msg` into an internal queue and eventually send all queued messages to the target, at
 * a speed that respects the given rate. If no target is currently defined then the messages will be queued
 * and will be delivered as soon as a target gets set.
 *
 * A throttler understands actor messages of type
 * [[akka.contrib.throttle.Throttler.SetTarget]], [[akka.contrib.throttle.Throttler.SetRate]], in
 * addition to any other messages, which the throttler will consider as messages to be sent to
 * the target.
 *
 * == Transparency ==
 * Notice that the throttler `forward`s messages, i.e., the target will see the original message sender
 * (and not the throttler) as the sender of the message.
 *
 * == Persistence ==
 * Throttlers usually use an internal queue to keep the messages that need to be sent to the target.
 * You therefore cannot rely on the throttler's inbox size in order to learn how much messages are
 * outstanding.
 *
 * It is left to the implementation whether the internal queue is persisted over application restarts or
 * actor failure.
 *
 * == Processing messages ==
 * The target should process messages as fast as possible. If the target requires substantial time to
 * process messages, it should distribute its work to other actors (using for example something like
 * a `BalancingDispatcher`), otherwise the resulting system will always work &lt;em&gt;below&lt;/em&gt;
 * the threshold rate.
 *
 * &lt;em&gt;Example:&lt;/em&gt; Suppose the throttler has a rate of 3msg/s and the target requires 1s to process a message.
 * This system will only process messages at a rate of 1msg/s: the target will receive messages at at most 3msg/s
 * but as it handles them synchronously and each of them takes 1s, its inbox will grow and grow. In such
 * a situation, the target should &lt;em&gt;distribute&lt;/em&gt; its messages to a set of worker actors so that individual messages
 * can be handled in parallel.
 *
 * ==Example==
 * For example, if you set a rate like &quot;3 messages in 1 second&quot;, the throttler
 * will send the first three messages immediately to the target actor but will need to impose a delay before
 * sending out further messages:
 * {{{
 *   // A simple actor that prints whatever it receives
 *   class Printer extends Actor {
 *     def receive = {
 *       case x =&gt; println(x)
 *     }
 *   }
 *
 *   val printer = system.actorOf(Props[Printer], &quot;printer&quot;)
 *
 *   // The throttler for this example, setting the rate
 *   val throttler = system.actorOf(Props(classOf[TimerBasedThrottler], 3 msgsPer 1.second))
 *
 *   // Set the target
 *   throttler ! SetTarget(Some(printer))
 *   // These three messages will be sent to the printer immediately
 *   throttler ! &quot;1&quot;
 *   throttler ! &quot;2&quot;
 *   throttler ! &quot;3&quot;
 *   // These two will wait at least until 1 second has passed
 *   throttler ! &quot;4&quot;
 *   throttler ! &quot;5&quot;
 * }}}
 *
 * ==Implementation notes==
 * This throttler implementation internally installs a timer that repeats every `rate.durationInMillis` and enables `rate.numberOfCalls`
 * additional calls to take place. A `TimerBasedThrottler` uses very few system resources, provided the rate's duration is not too
 * fine-grained (which would cause a lot of timer invocations); for example, it does not store the calling history
 * as other throttlers may need to do.
 *
 * However, a `TimerBasedThrottler` only provides ''weak guarantees'' on the rate (see also
 * &lt;a href='http://letitcrash.com/post/28901663062/throttling-messages-in-akka-2'&gt;this blog post&lt;/a&gt;):
 *
 *  - Only ''delivery'' times are taken into account: if, for example, the throttler is used to throttle
 *    requests to an external web service then only the start times of the web requests are considered.
 *    If a web request takes very long on the server then more than `rate.numberOfCalls`-many requests
 *    may be observed on the server in an interval of duration `rate.durationInMillis()`.
 *  - There may be intervals of duration `rate.durationInMillis()` that contain more than `rate.numberOfCalls`
 *    message deliveries: a `TimerBasedThrottler` only makes guarantees for the intervals
 *    of its ''own'' timer, namely that no more than `rate.numberOfCalls`-many messages are delivered within such intervals. Other intervals on the
 *    timeline may contain more calls.
 *
 * For some applications, these guarantees may not be sufficient.
 *
 * ==Known issues==
 *
 *  - If you change the rate using `SetRate(rate)`, the actual rate may in fact be higher for the
 *    overlapping period (i.e., `durationInMillis()`) of the new and old rate. Therefore,
 *    changing the rate frequently is not recommended with the current implementation.
 *  - The queue of messages to be delivered is not persisted in any way; actor or system failure will
 *    cause the queued messages to be lost.
 *
 * @see [[akka.contrib.throttle.Throttler]]
 */</span>
class <a title="class TimerBasedThrottler extends AnyRef with akka.actor.Actor with akka.actor.FSM[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]" id="akka.contrib.throttle;TimerBasedThrottler">TimerBasedThrottler</a><a href="#akka.contrib.throttle;TimerBasedThrottler" title="akka.contrib.throttle.TimerBasedThrottler" class="delimiter">(</a>var <a title="akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle;TimerBasedThrottler.rate">rate</a>: <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">)</span> extends <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor" title="akka.actor.Actor">Actor</a> with <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM" title="akka.actor.FSM[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">FSM</a><span class="delimiter">[</span>State, Data<span class="delimiter">]</span> <span class="delimiter">{</span>
  <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.startWith" title="(stateName: akka.contrib.throttle.TimerBasedThrottler.State, stateData: akka.contrib.throttle.TimerBasedThrottler.Data, timeout: TimerBasedThrottler.this.Timeout)Unit">startWith</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a>, <a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="(target: Option[akka.actor.ActorRef], callsLeftInThisPeriod: Int, queue: scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message])akka.contrib.throttle.TimerBasedThrottler.Data">Data</a><span class="delimiter">(</span><span title="None.type">None</span>, <a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="=&gt; akka.contrib.throttle.Throttler.Rate">rate</a>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="=&gt; Int">numberOfCalls</a>, <span title="(xs: Nothing*)scala.collection.immutable.Queue[Nothing]">Q</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="comment">// Idle: no messages, or target not set</span>
  <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.when" title="(stateName: akka.contrib.throttle.TimerBasedThrottler.State, stateTimeout: scala.concurrent.duration.FiniteDuration)(stateFunction: TimerBasedThrottler.this.StateFunction)Unit">when</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a><span class="delimiter">)</span> <span title="&lt;$anon: TimerBasedThrottler.this.Event =&gt; TimerBasedThrottler.this.State&gt; extends scala.runtime.AbstractPartialFunction[TimerBasedThrottler.this.Event,TimerBasedThrottler.this.State] with Serializable" class="delimiter">{</span>
    <span class="comment">// Set the rate</span>
    case Event<span class="delimiter">(</span>SetRate<span class="delimiter">(</span><span title="akka.contrib.throttle.Throttler.Rate">rate</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> â‡’
      this.<a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="(x$1: akka.contrib.throttle.Throttler.Rate)Unit">rate</a> = <span title="akka.contrib.throttle.Throttler.Rate">rate</span>
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$3">copy</a><span class="delimiter">(</span>callsLeftInThisPeriod = <span title="akka.contrib.throttle.Throttler.Rate">rate</span>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="Int" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$1">numberOfCalls</a><span class="delimiter">)</span>

    <span class="comment">// Set the target</span>
    case Event<span class="delimiter">(</span>SetTarget<span class="delimiter">(</span><span title="Some[akka.actor.ActorRef]">t</span> @ Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> if <span title="=&gt; Boolean">!</span><span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.queue" title="=&gt; scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</a>.<span title="=&gt; Boolean">isEmpty</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.goto" title="(nextStateName: akka.contrib.throttle.TimerBasedThrottler.State)TimerBasedThrottler.this.State">goto</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Active.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Active.type">Active</a><span class="delimiter">)</span> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages" title="(data: akka.contrib.throttle.TimerBasedThrottler.Data)akka.contrib.throttle.TimerBasedThrottler.Data">deliverMessages</a><span class="delimiter">(</span><span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="(target: Option[akka.actor.ActorRef], callsLeftInThisPeriod: Int, queue: scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message])akka.contrib.throttle.TimerBasedThrottler.Data">copy</a><span class="delimiter">(</span>target = <span title="Some[akka.actor.ActorRef]">t</span><span class="delimiter">)</span><span class="delimiter">)</span>
    case Event<span class="delimiter">(</span>SetTarget<span class="delimiter">(</span><span title="Option[akka.actor.ActorRef]">t</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="(target: Option[akka.actor.ActorRef], callsLeftInThisPeriod: Int, queue: scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message])akka.contrib.throttle.TimerBasedThrottler.Data">copy</a><span class="delimiter">(</span>target = <span title="Option[akka.actor.ActorRef]">t</span><span class="delimiter">)</span>

    <span class="comment">// Queuing</span>
    case Event<span class="delimiter">(</span><span title="Any">msg</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span><span title="None.type">None</span>, _, <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span><span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$6">copy</a><span class="delimiter">(</span>queue = <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span>.<span title="(elem: akka.contrib.throttle.TimerBasedThrottler.Message)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">enqueue</span><a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$4" class="delimiter">(</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Message.readResolve" title="(message: Any, sender: akka.actor.ActorRef)akka.contrib.throttle.TimerBasedThrottler.Message">Message</a><span class="delimiter">(</span><span title="Any">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.sender" title="()akka.actor.ActorRef">sender</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    case Event<span class="delimiter">(</span><span title="Any">msg</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span>Some<span class="delimiter">(</span>_<span class="delimiter">)</span>, _, <a href="#akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.<unapply-selector>" title="(x: Seq[akka.contrib.throttle.TimerBasedThrottler.Message])Some[Seq[akka.contrib.throttle.TimerBasedThrottler.Message]]">Seq</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.goto" title="(nextStateName: akka.contrib.throttle.TimerBasedThrottler.State)TimerBasedThrottler.this.State">goto</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Active.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Active.type">Active</a><span class="delimiter">)</span> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages" title="(data: akka.contrib.throttle.TimerBasedThrottler.Data)akka.contrib.throttle.TimerBasedThrottler.Data">deliverMessages</a><span class="delimiter">(</span><span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$9">copy</a><span class="delimiter">(</span>queue = <span title="(xs: akka.contrib.throttle.TimerBasedThrottler.Message*)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">Q</span><a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$7" class="delimiter">(</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Message.readResolve" title="(message: Any, sender: akka.actor.ActorRef)akka.contrib.throttle.TimerBasedThrottler.Message">Message</a><span class="delimiter">(</span><span title="Any">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.sender" title="()akka.actor.ActorRef">sender</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// Note: The case Event(msg, t @ Data(Some(_), _, _, Seq(_*))) should never happen here.</span>
  <span class="delimiter">}</span>

  <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.when" title="(stateName: akka.contrib.throttle.TimerBasedThrottler.State, stateTimeout: scala.concurrent.duration.FiniteDuration)(stateFunction: TimerBasedThrottler.this.StateFunction)Unit">when</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Active.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Active.type">Active</a><span class="delimiter">)</span> <span title="&lt;$anon: TimerBasedThrottler.this.Event =&gt; TimerBasedThrottler.this.State&gt; extends scala.runtime.AbstractPartialFunction[TimerBasedThrottler.this.Event,TimerBasedThrottler.this.State] with Serializable" class="delimiter">{</span>
    <span class="comment">// Set the rate</span>
    case Event<span class="delimiter">(</span>SetRate<span class="delimiter">(</span><span title="akka.contrib.throttle.Throttler.Rate">rate</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> â‡’
      this.<a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="(x$1: akka.contrib.throttle.Throttler.Rate)Unit">rate</a> = <span title="akka.contrib.throttle.Throttler.Rate">rate</span>
      <span class="comment">// Note: this should be improved (see &quot;Known issues&quot; in class comments)</span>
      <a href="#akka.contrib.throttle;TimerBasedThrottler.stopTimer" title="()Unit">stopTimer</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#akka.contrib.throttle;TimerBasedThrottler.startTimer" title="(rate: akka.contrib.throttle.Throttler.Rate)Unit">startTimer</a><span class="delimiter">(</span><span title="akka.contrib.throttle.Throttler.Rate">rate</span><span class="delimiter">)</span>
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$12">copy</a><span class="delimiter">(</span>callsLeftInThisPeriod = <span title="akka.contrib.throttle.Throttler.Rate">rate</span>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="Int" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$10">numberOfCalls</a><span class="delimiter">)</span>

    <span class="comment">// Set the target (when the new target is None)</span>
    case Event<span class="delimiter">(</span>SetTarget<span class="delimiter">(</span><span title="None.type">None</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> â‡’
      <span class="comment">// Note: We do not yet switch to state `Inactive` because we need the timer to tick once more before</span>
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="(target: Option[akka.actor.ActorRef], callsLeftInThisPeriod: Int, queue: scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message])akka.contrib.throttle.TimerBasedThrottler.Data">copy</a><span class="delimiter">(</span>target = <span title="None.type">None</span><span class="delimiter">)</span>

    <span class="comment">// Set the target (when the new target is not None)</span>
    case Event<span class="delimiter">(</span>SetTarget<span class="delimiter">(</span><span title="Some[akka.actor.ActorRef]">t</span> @ Some<span class="delimiter">(</span>_<span class="delimiter">)</span><span class="delimiter">)</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="(target: Option[akka.actor.ActorRef], callsLeftInThisPeriod: Int, queue: scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message])akka.contrib.throttle.TimerBasedThrottler.Data">copy</a><span class="delimiter">(</span>target = <span title="Some[akka.actor.ActorRef]">t</span><span class="delimiter">)</span>

    <span class="comment">// Tick after a `SetTarget(None)`: take the additional permits and go to `Idle`</span>
    case Event<span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Tick.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Tick.type">Tick</a>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span><span title="None.type">None</span>, _, _<span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.goto" title="(nextStateName: akka.contrib.throttle.TimerBasedThrottler.State)TimerBasedThrottler.this.State">goto</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a><span class="delimiter">)</span> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$15">copy</a><span class="delimiter">(</span>callsLeftInThisPeriod = <a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="=&gt; akka.contrib.throttle.Throttler.Rate">rate</a>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="Int" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$13">numberOfCalls</a><span class="delimiter">)</span>

    <span class="comment">// Period ends and we have no more messages: take the additional permits and go to `Idle`</span>
    case Event<span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Tick.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Tick.type">Tick</a>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span>_, _, <a href="#akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.<unapply-selector>" title="(x: Seq[akka.contrib.throttle.TimerBasedThrottler.Message])Some[Seq[akka.contrib.throttle.TimerBasedThrottler.Message]]">Seq</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.goto" title="(nextStateName: akka.contrib.throttle.TimerBasedThrottler.State)TimerBasedThrottler.this.State">goto</a><span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a><span class="delimiter">)</span> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$18">copy</a><span class="delimiter">(</span>callsLeftInThisPeriod = <a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="=&gt; akka.contrib.throttle.Throttler.Rate">rate</a>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="Int" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$16">numberOfCalls</a><span class="delimiter">)</span>

    <span class="comment">// Period ends and we get more occasions to send messages</span>
    case Event<span class="delimiter">(</span><a href="#akka.contrib.throttle.TimerBasedThrottler.Tick.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Tick.type">Tick</a>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span>_, _, _<span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages" title="(data: akka.contrib.throttle.TimerBasedThrottler.Data)akka.contrib.throttle.TimerBasedThrottler.Data">deliverMessages</a><span class="delimiter">(</span><span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$21">copy</a><span class="delimiter">(</span>callsLeftInThisPeriod = <a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="=&gt; akka.contrib.throttle.Throttler.Rate">rate</a>.<a href="#akka.contrib.throttle.Throttler;Rate.numberOfCalls" title="Int" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$19">numberOfCalls</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// Queue a message (when we cannot send messages in the current period anymore)</span>
    case Event<span class="delimiter">(</span><span title="Any">msg</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span>_, <span title="Int(0)" class="int">0</span>, <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span><span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$24">copy</a><span class="delimiter">(</span>queue = <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span>.<span title="(elem: akka.contrib.throttle.TimerBasedThrottler.Message)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">enqueue</span><a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$22" class="delimiter">(</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Message.readResolve" title="(message: Any, sender: akka.actor.ActorRef)akka.contrib.throttle.TimerBasedThrottler.Message">Message</a><span class="delimiter">(</span><span title="Any">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.sender" title="()akka.actor.ActorRef">sender</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// Queue a message (when we can send some more messages in the current period)</span>
    case Event<span class="delimiter">(</span><span title="Any">msg</span>, <span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span> @ Data<span class="delimiter">(</span>_, _, <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span><span class="delimiter">)</span><span class="delimiter">)</span> â‡’
      <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.stay" title="()TimerBasedThrottler.this.State">stay</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM;State.using" title="(nextStateData: akka.contrib.throttle.TimerBasedThrottler.Data)akka.actor.FSM.State[akka.contrib.throttle.TimerBasedThrottler.State,akka.contrib.throttle.TimerBasedThrottler.Data]">using</a> <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages" title="(data: akka.contrib.throttle.TimerBasedThrottler.Data)akka.contrib.throttle.TimerBasedThrottler.Data">deliverMessages</a><span class="delimiter">(</span><span title="akka.contrib.throttle.TimerBasedThrottler.Data">d</span>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$27">copy</a><span class="delimiter">(</span>queue = <span title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</span>.<span title="(elem: akka.contrib.throttle.TimerBasedThrottler.Message)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">enqueue</span><a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.<local TimerBasedThrottler>;$anonfun.applyOrElse.x$25" class="delimiter">(</a><a href="#akka.contrib.throttle.TimerBasedThrottler.Message.readResolve" title="(message: Any, sender: akka.actor.ActorRef)akka.contrib.throttle.TimerBasedThrottler.Message">Message</a><span class="delimiter">(</span><span title="Any">msg</span>, <a href="../../../../actor/akka/actor/Actor.scala.html#akka.actor;Actor.context" title="=&gt; akka.actor.ActorContext">context</a>.<a href="../../../../actor/akka/actor/ActorCell.scala.html#akka.actor;ActorContext.sender" title="()akka.actor.ActorRef">sender</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.onTransition" title="(transitionHandler: TimerBasedThrottler.this.TransitionHandler)Unit">onTransition</a> <span title="&lt;$anon: ((akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State)) =&gt; Unit&gt; extends scala.runtime.AbstractPartialFunction[(akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State),Unit] with Serializable" class="delimiter">{</span>
    case <a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM.->.unapply" title="(in: (akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State))Some[(akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State)]">-&gt;</a> <a href="#akka.contrib.throttle.TimerBasedThrottler.Active.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Active.type">Active</a> â‡’ <a href="#akka.contrib.throttle;TimerBasedThrottler.startTimer" title="(rate: akka.contrib.throttle.Throttler.Rate)Unit">startTimer</a><span title="Boolean(true)" class="delimiter">(</span><a href="#akka.contrib.throttle;TimerBasedThrottler.rate" title="=&gt; akka.contrib.throttle.Throttler.Rate">rate</a><span class="delimiter">)</span>
    case <a href="#akka.contrib.throttle.TimerBasedThrottler.Active.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Active.type">Active</a> <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor.FSM.->.unapply" title="(in: (akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State))Some[(akka.contrib.throttle.TimerBasedThrottler.State, akka.contrib.throttle.TimerBasedThrottler.State)]">-&gt;</a> <a href="#akka.contrib.throttle.TimerBasedThrottler.Idle.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Idle.type">Idle</a> â‡’ <a href="#akka.contrib.throttle;TimerBasedThrottler.stopTimer" title="()Unit">stopTimer</a><span title="Boolean(true)" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.initialize" title="()Unit">initialize</a><span class="delimiter">(</span><span class="delimiter">)</span>

  private def <a title="(rate: akka.contrib.throttle.Throttler.Rate)Unit" id="akka.contrib.throttle;TimerBasedThrottler.startTimer">startTimer</a><span class="delimiter">(</span><a title="akka.contrib.throttle.Throttler.Rate" id="akka.contrib.throttle;TimerBasedThrottler.startTimer.rate">rate</a>: <a href="#akka.contrib.throttle.Throttler.Rate.readResolve" title="akka.contrib.throttle.Throttler.Rate">Rate</a><span class="delimiter">)</span> = <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.setTimer" title="(name: String, msg: Any, timeout: scala.concurrent.duration.FiniteDuration, repeat: Boolean)Unit">setTimer</a><span class="delimiter">(</span><span title="String(&quot;morePermits&quot;)" class="string">&quot;morePermits&quot;</span>, <a href="#akka.contrib.throttle.TimerBasedThrottler.Tick.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Tick.type">Tick</a>, <a href="#akka.contrib.throttle;TimerBasedThrottler.startTimer.rate" title="akka.contrib.throttle.Throttler.Rate">rate</a>.<a href="#akka.contrib.throttle.Throttler;Rate.duration" title="=&gt; scala.concurrent.duration.FiniteDuration">duration</a>, true<span class="delimiter">)</span>
  private def <a title="()Unit" id="akka.contrib.throttle;TimerBasedThrottler.stopTimer">stopTimer</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="../../../../actor/akka/actor/FSM.scala.html#akka.actor;FSM.cancelTimer" title="(name: String)Unit">cancelTimer</a><span class="delimiter">(</span><span title="String(&quot;morePermits&quot;)" class="string">&quot;morePermits&quot;</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Send as many messages as we can (while respecting the rate) to the target and
   * return the state data (with the queue containing the remaining ones).
   */</span>
  private def <a title="(data: akka.contrib.throttle.TimerBasedThrottler.Data)akka.contrib.throttle.TimerBasedThrottler.Data" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages">deliverMessages</a><span class="delimiter">(</span><a title="akka.contrib.throttle.TimerBasedThrottler.Data" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data">data</a>: <a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Data">Data</a><span class="delimiter">)</span>: <a href="#akka.contrib.throttle.TimerBasedThrottler.Data.readResolve" title="akka.contrib.throttle.TimerBasedThrottler.Data">Data</a> = <span class="delimiter">{</span>
    val <a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.queue">queue</a> = <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data" title="akka.contrib.throttle.TimerBasedThrottler.Data">data</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.queue" title="=&gt; scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</a>
    val <a title="Int" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.nrOfMsgToSend">nrOfMsgToSend</a> = scala.math.<span title="(x: Int, y: Int)Int">min</span><span class="delimiter">(</span><a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.queue" title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</a>.<span title="=&gt; Int">length</span>, <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data" title="akka.contrib.throttle.TimerBasedThrottler.Data">data</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.callsLeftInThisPeriod" title="=&gt; Int">callsLeftInThisPeriod</a><span class="delimiter">)</span>

    <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.queue" title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</a>.<span title="(n: Int)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">take</span><span class="delimiter">(</span><a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.nrOfMsgToSend" title="Int">nrOfMsgToSend</a><span class="delimiter">)</span>.<span title="(f: akka.contrib.throttle.TimerBasedThrottler.Message =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="akka.contrib.throttle.TimerBasedThrottler.Message" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.$anonfun.x">x</a> â‡’ <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data" title="akka.contrib.throttle.TimerBasedThrottler.Data">data</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="=&gt; Option[akka.actor.ActorRef]">target</a>.<span title="=&gt; akka.actor.ActorRef">get</span>.<a href="../../../../actor/akka/actor/ActorRef.scala.html#akka.actor;ActorRef.tell" title="(msg: Any, sender: akka.actor.ActorRef)Unit">tell</a><span class="delimiter">(</span><a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.$anonfun.x" title="akka.contrib.throttle.TimerBasedThrottler.Message">x</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Message.message" title="=&gt; Any">message</a>, <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.$anonfun.x" title="akka.contrib.throttle.TimerBasedThrottler.Message">x</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Message.sender" title="=&gt; akka.actor.ActorRef">sender</a><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data" title="akka.contrib.throttle.TimerBasedThrottler.Data">data</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.target" title="Option[akka.actor.ActorRef] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.x$30">copy</a><span class="delimiter">(</span>queue = <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.queue" title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">queue</a>.<span title="(n: Int)scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message]">drop</span><a title="scala.collection.immutable.Queue[akka.contrib.throttle.TimerBasedThrottler.Message] @scala.reflect.internal.annotations.uncheckedBounds" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.x$28" class="delimiter">(</a><a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.nrOfMsgToSend" title="Int">nrOfMsgToSend</a><span class="delimiter">)</span>, callsLeftInThisPeriod = <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.data" title="akka.contrib.throttle.TimerBasedThrottler.Data">data</a>.<a href="#akka.contrib.throttle.TimerBasedThrottler;Data.callsLeftInThisPeriod" title="=&gt; Int">callsLeftInThisPeriod</a> <a title="Int" id="akka.contrib.throttle;TimerBasedThrottler.deliverMessages.x$29">-</a> <a href="#akka.contrib.throttle;TimerBasedThrottler.deliverMessages.nrOfMsgToSend" title="Int">nrOfMsgToSend</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
