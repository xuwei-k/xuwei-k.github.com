<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>http4s-server/org/http4s/server/middleware/GZip.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package org.http4s
package server
package middleware

import java.util.zip.Deflater

import org.http4s.<a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header" title="org.http4s.Header.type">Header</a>.<span class="delimiter">{</span>`Content-Type`, `Content-Length`, `Content-Encoding`, `Accept-Encoding`<span class="delimiter">}</span>
import org.log4s.getLogger

import scalaz.stream.<span title="scalaz.stream.Process.type">Process</span>._
import scalaz.concurrent.Task

import scodec.bits.ByteVector

object <a title="org.http4s.server.middleware.GZip.type" id="org.http4s.server.middleware.GZip">GZip</a> <a href="#org.http4s.server.middleware.GZip" title="org.http4s.server.middleware.GZip.type" class="delimiter">{</a>
  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val <a title="org.log4s.Logger" id="org.http4s.server.middleware.GZip.logger">logger</a> = <span title="org.log4s.Logger">getLogger</span>
  
  <span class="comment">// TODO: It could be possible to look for Task.now type bodies, and change the Content-Length header after</span>
  <span class="comment">// TODO      zipping and buffering all the input. Just a thought.</span>
  def <a title="(service: org.http4s.server.HttpService, buffersize: Int, level: Int)org.http4s.server.HttpService" id="org.http4s.server.middleware.GZip.apply">apply</a><span class="delimiter">(</span><a title="org.http4s.server.HttpService" id="org.http4s.server.middleware.GZip.apply.service">service</a>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a>, <a title="Int" id="org.http4s.server.middleware.GZip.apply$default$2">buffersize</a>: <span title="Int">Int</span> = <span title="Int(512)" class="int">512</span>, <a title="Int" id="org.http4s.server.middleware.GZip.apply$default$3">level</a>: <span title="Int">Int</span> = Deflater.<span title="Int(-1)">DEFAULT_COMPRESSION</span><span class="delimiter">)</span>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a> = <span class="delimiter">{</span>
    <a href="../Service.scala.html#org.http4s.server.Service" title="org.http4s.server.Service.type">Service</a>.<a href="../Service.scala.html#org.http4s.server.Service.lift" title="(f: org.http4s.Request =&gt; scalaz.concurrent.Task[Option[org.http4s.Response]])org.http4s.server.Service[org.http4s.Request,org.http4s.Response]">lift</a> <span class="delimiter">{</span> req: <a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Request" title="org.http4s.Request">Request</a> =&gt;
      <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.req" title="org.http4s.Request">req</a>.<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Request.headers" title="=&gt; org.http4s.Headers">headers</a>.<a href="../../../../../http4s-core/org/http4s/Headers.scala.html#org.http4s;Headers.get(2d275bcbb3)" title="(key: org.http4s.HeaderKey.Extractable)Option[key.HeaderT]">get</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header.Accept-Encoding" title="org.http4s.Header.Accept-Encoding.type">`Accept-Encoding`</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="org.http4s.Header.Accept-Encoding.HeaderT" id="org.http4s.server.middleware.GZip.apply.$anonfun.acceptEncoding">acceptEncoding</a><span class="delimiter">)</span> if <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.acceptEncoding" title="org.http4s.Header.Accept-Encoding.HeaderT">acceptEncoding</a>.<a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header;Accept-Encoding.satisfiedBy" title="(coding: org.http4s.ContentCoding)Boolean">satisfiedBy</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding" title="org.http4s.ContentCoding.type">ContentCoding</a>.<a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding.gzip" title="=&gt; org.http4s.ContentCoding.Value">gzip</a><span class="delimiter">)</span>
                                  <span title="(x: Boolean)Boolean">||</span> <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.acceptEncoding" title="org.http4s.Header.Accept-Encoding.HeaderT">acceptEncoding</a>.<a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header;Accept-Encoding.satisfiedBy" title="(coding: org.http4s.ContentCoding)Boolean">satisfiedBy</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding" title="org.http4s.ContentCoding.type">ContentCoding</a>.<a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding.x-gzip" title="=&gt; org.http4s.ContentCoding.gzip.type">`x-gzip`</a><span class="delimiter">)</span> =&gt;
          <a href="#org.http4s.server.middleware.GZip.apply.service" title="org.http4s.server.HttpService">service</a>.<a href="../Service.scala.html#org.http4s.server;Service.map" title="(f: org.http4s.Response =&gt; org.http4s.Response)org.http4s.server.Service[org.http4s.Request,org.http4s.Response]">map</a> <a href="../Service.scala.html#org.http4s.server;Service.apply" title="(a: org.http4s.Request)scalaz.concurrent.Task[Option[org.http4s.Response]]" class="delimiter">{</a> <a title="org.http4s.Response" id="org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.resp">resp</a> =&gt;
            if <span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.isZippable" title="(resp: org.http4s.Response)Boolean">isZippable</a><span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.resp" title="org.http4s.Response">resp</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#org.http4s.server.middleware.GZip.logger" title="org.log4s.Logger">logger</a>.trace<span title="(x$1: String)Unit" class="delimiter">(</span><span title="String(&quot;GZip middleware encoding content&quot;)" class="string">&quot;GZip middleware encoding content&quot;</span><span class="delimiter">)</span>
              <span class="comment">// Need to add the Gzip header</span>
              val b = <span title="(o: scodec.bits.ByteVector)scalaz.stream.Process0[scodec.bits.ByteVector]">emit</span><span class="delimiter">(</span><span title="scodec.bits.ByteVector.type">ByteVector</span>.<span title="(bytes: Array[Byte])scodec.bits.ByteVector">view</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.header" title="=&gt; Array[Byte]">header</a><span class="delimiter">)</span><span class="delimiter">)</span> <a title="scalaz.stream.Process[scalaz.concurrent.Task,scodec.bits.ByteVector]" id="org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.b">++</a>
                        <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.resp" title="org.http4s.Response">resp</a>.<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response.body" title="=&gt; org.http4s.EntityBody">body</a>.<span title="(p1: scalaz.stream.Process1[scodec.bits.ByteVector,scodec.bits.ByteVector])scalaz.stream.Process[scalaz.concurrent.Task,scodec.bits.ByteVector]">pipe</span><span class="delimiter">(</span>scalaz.stream.<span title="scalaz.stream.compress.type">compress</span>.<span title="(level: Int, nowrap: Boolean, bufferSize: Int)scalaz.stream.Process1[scodec.bits.ByteVector,scodec.bits.ByteVector]">deflate</span><span class="delimiter">(</span>level = <a href="#org.http4s.server.middleware.GZip.apply$default$3" title="Int">level</a>, nowrap = true<span class="delimiter">)</span><span class="delimiter">)</span>

              <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.resp" title="org.http4s.Response">resp</a>.<a href="../../../../../http4s-core/org/http4s/MessageOps.scala.html#org.http4s;MessageOps.removeHeader" title="(key: org.http4s.HeaderKey)resp.Self">removeHeader</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header.Content-Length" title="org.http4s.Header.Content-Length.type">`Content-Length`</a><span class="delimiter">)</span>
                .<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Message.putHeaders" title="(headers: org.http4s.Header*)org.http4s.Response">putHeaders</a><a title="org.http4s.Response" id="org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.qual$1" class="delimiter">(</a><a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header;Content-Encoding" title="(contentCoding: org.http4s.ContentCoding)org.http4s.Header.Content-Encoding">`Content-Encoding`</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding" title="org.http4s.ContentCoding.type">ContentCoding</a>.<a href="../../../../../http4s-core/org/http4s/ContentCoding.scala.html#org.http4s.ContentCoding.gzip" title="=&gt; org.http4s.ContentCoding.Value">gzip</a><span class="delimiter">)</span><span class="delimiter">)</span>
                .<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response.copy$default$1" title="org.http4s.Status" id="org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.x$5">copy</a><span class="delimiter">(</span>body = <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.b" title="scalaz.stream.Process[scalaz.concurrent.Task,scodec.bits.ByteVector] @scala.reflect.internal.annotations.uncheckedBounds" id="org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.x$1">b</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            else <a href="#org.http4s.server.middleware.GZip.apply.$anonfun.$anonfun.resp" title="org.http4s.Response">resp</a>  <span class="comment">// Don't touch it, Content-Encoding already set</span>
          <span class="delimiter">}</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.apply.$anonfun.req" title="org.http4s.Request">req</a><span class="delimiter">)</span>

        case <span title="None.type">None</span> =&gt;  <a href="../Service.scala.html#org.http4s.server;Service.apply" title="(a: org.http4s.Request)scalaz.concurrent.Task[Option[org.http4s.Response]]">service</a><span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.apply.$anonfun.req" title="org.http4s.Request">req</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(resp: org.http4s.Response)Boolean" id="org.http4s.server.middleware.GZip.isZippable">isZippable</a><span class="delimiter">(</span><a title="org.http4s.Response" id="org.http4s.server.middleware.GZip.isZippable.resp">resp</a>: <a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response" title="org.http4s.Response">Response</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    val <a title="Option[org.http4s.Header.Content-Type.HeaderT]" id="org.http4s.server.middleware.GZip.isZippable.contentType">contentType</a> = <a href="#org.http4s.server.middleware.GZip.isZippable.resp" title="org.http4s.Response">resp</a>.<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response.headers" title="=&gt; org.http4s.Headers">headers</a>.<a href="../../../../../http4s-core/org/http4s/Headers.scala.html#org.http4s;Headers.get(2d275bcbb3)" title="(key: org.http4s.HeaderKey.Extractable)Option[key.HeaderT]">get</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header.Content-Type" title="org.http4s.Header.Content-Type.type">`Content-Type`</a><span class="delimiter">)</span>
    <a href="#org.http4s.server.middleware.GZip.isZippable.resp" title="org.http4s.Response">resp</a>.<a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response.headers" title="=&gt; org.http4s.Headers">headers</a>.<a href="../../../../../http4s-core/org/http4s/Headers.scala.html#org.http4s;Headers.get(2d275bcbb3)" title="(key: org.http4s.HeaderKey.Extractable)Option[key.HeaderT]">get</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header.Content-Encoding" title="org.http4s.Header.Content-Encoding.type">`Content-Encoding`</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
      <span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.isZippable.contentType" title="Option[org.http4s.Header.Content-Type.HeaderT]">contentType</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">||</span> <a href="#org.http4s.server.middleware.GZip.isZippable.contentType" title="Option[org.http4s.Header.Content-Type.HeaderT]">contentType</a>.<span title="=&gt; org.http4s.Header.Content-Type.HeaderT">get</span>.<a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header;Content-Type.mediaType" title="=&gt; org.http4s.MediaType">mediaType</a>.<a href="../../../../../http4s-core/org/http4s/MediaType.scala.html#org.http4s;MediaType.compressible" title="=&gt; Boolean">compressible</a> <span title="(x: Boolean)Boolean">||</span>
      <span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.isZippable.contentType" title="Option[org.http4s.Header.Content-Type.HeaderT]">contentType</a>.<span title="=&gt; org.http4s.Header.Content-Type.HeaderT">get</span>.<a href="../../../../../http4s-core/org/http4s/Header.scala.html#org.http4s.Header;Content-Type.mediaType" title="=&gt; org.http4s.MediaType">mediaType</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="../../../../../http4s-core/org/http4s/MediaType.scala.html#org.http4s.MediaType" title="org.http4s.MediaType.type">MediaType</a>.<a href="../../../../../http4s-core/org/http4s/MediaType.scala.html#org.http4s.MediaType.application/octet-stream" title="=&gt; org.http4s.MediaType">`application/octet-stream`</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>



  private val <a title="Int" id="org.http4s.server.middleware.GZip.GZIP_MAGIC_NUMBER">GZIP_MAGIC_NUMBER</a> = <span title="Int(35615)" class="int">0x8b1f</span>
  private val <a title="Int" id="org.http4s.server.middleware.GZip.TRAILER_LENGTH">TRAILER_LENGTH</a> = <span title="Int(8)" class="int">8</span>

  private val <a title="Array[Byte]" id="org.http4s.server.middleware.GZip.header">header</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span> = <span title="(x: Byte, xs: Byte*)Array[Byte]">Array</span><span class="delimiter">(</span>
    <a href="#org.http4s.server.middleware.GZip.GZIP_MAGIC_NUMBER" title="=&gt; Int">GZIP_MAGIC_NUMBER</a>.<span title="=&gt; Byte">toByte</span>,           <span class="comment">// Magic number (int16)</span>
    <span class="delimiter">(</span><a href="#org.http4s.server.middleware.GZip.GZIP_MAGIC_NUMBER" title="=&gt; Int">GZIP_MAGIC_NUMBER</a> <span title="(x: Int)Int">&gt;&gt;</span> <span title="Int(8)" class="int">8</span><span class="delimiter">)</span>.<span title="=&gt; Byte">toByte</span>,    <span class="comment">// Magic number  c</span>
    Deflater.<span title="Int(8)">DEFLATED</span>.<span title="=&gt; Byte">toByte</span>,           <span class="comment">// Compression method</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Flags</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Modification time (int32)</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Modification time  c</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Modification time  c</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Modification time  c</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span>,                           <span class="comment">// Extra flags</span>
    <span title="Int(0)" class="int">0</span>.<span title="=&gt; Byte">toByte</span><span class="delimiter">)</span>                           <span class="comment">// Operating system</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
