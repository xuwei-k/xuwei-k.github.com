<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>http4s-server/org/http4s/server/middleware/Timeout.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package org.http4s
package server
package middleware

import scala.concurrent.duration._
import scalaz.concurrent.Task
import java.util.concurrent.<span class="delimiter">{</span>TimeUnit, ScheduledThreadPoolExecutor<span class="delimiter">}</span>
import scalaz.\/-

object <a title="org.http4s.server.middleware.Timeout.type" id="org.http4s.server.middleware.Timeout">Timeout</a> <a href="#org.http4s.server.middleware.Timeout" title="org.http4s.server.middleware.Timeout.type" class="delimiter">{</a>

  <span class="comment">// TODO: this should probably be replaced with a low res executor to save clock cycles</span>
  private val <a title="java.util.concurrent.ScheduledThreadPoolExecutor" id="org.http4s.server.middleware.Timeout.ec">ec</a> = new <span title="java.util.concurrent.ScheduledThreadPoolExecutor">ScheduledThreadPoolExecutor</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>

  private def <a title="(timeout: scala.concurrent.duration.Duration)scalaz.concurrent.Task[org.http4s.Response]" id="org.http4s.server.middleware.Timeout.timeoutResp">timeoutResp</a><span class="delimiter">(</span><a title="scala.concurrent.duration.Duration" id="org.http4s.server.middleware.Timeout.timeoutResp.timeout">timeout</a>: <span title="scala.concurrent.duration.Duration">Duration</span><span class="delimiter">)</span>: <span title="scalaz.concurrent.Task[org.http4s.Response]">Task</span><span class="delimiter">[</span>Response<span class="delimiter">]</span> = <span title="scalaz.concurrent.Task.type">Task</span>.<span title="(register: (scalaz.\/[Throwable,org.http4s.Response] =&gt; Unit) =&gt; Unit)scalaz.concurrent.Task[org.http4s.Response]">async</span> <span class="delimiter">{</span> <a title="scalaz.\/[Throwable,org.http4s.Response] =&gt; Unit" id="org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.cb">cb</a> =&gt;
    val <a title="&lt;refinement of Runnable&gt; extends Object with Runnable" id="org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.r">r</a> = new <a title="&lt;$anon: Runnable&gt; extends Object with Runnable" id="org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.r;$anon">Runnable</a> <span class="delimiter">{</span> override def <a title="()Unit" id="org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.r;$anon.run">run</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.Response])Unit">cb</a><span class="delimiter">(</span><span title="(b: org.http4s.Response)scalaz.\/-[org.http4s.Response]">\/-</span><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Response" title="(status: org.http4s.Status, httpVersion: org.http4s.HttpVersion, headers: org.http4s.Headers, body: org.http4s.EntityBody, attributes: org.http4s.AttributeMap)org.http4s.Response">Response</a><span class="delimiter">(</span><a href="../../../../../http4s-core/org/http4s/Status.scala.html#org.http4s.Status" title="org.http4s.Status.type">Status</a>.<a href="../../../../../http4s-core/org/http4s/Status.scala.html#org.http4s.Status.RequestTimeout" title="=&gt; org.http4s.Status">RequestTimeout</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
    <a href="#org.http4s.server.middleware.Timeout.ec" title="=&gt; java.util.concurrent.ScheduledThreadPoolExecutor">ec</a>.<span title="(x$1: Runnable, x$2: Long, x$3: java.util.concurrent.TimeUnit)java.util.concurrent.ScheduledFuture[_]">schedule</span><span title="Unit" class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.timeoutResp.$anonfun.r" title="&lt;refinement of Runnable&gt; extends Object with Runnable">r</a>, <a href="#org.http4s.server.middleware.Timeout.timeoutResp.timeout" title="scala.concurrent.duration.Duration">timeout</a>.<span title="=&gt; Long">toNanos</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(NANOSECONDS)">NANOSECONDS</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

    <span class="comment">/** Transform the service such to return whichever resolves first:
      * the provided Task[Response], or the result of the service
      * @param r Task[Response] to race against the result of the service. This will be run for each [[Request]]
      * @param service [[org.http4s.server.HttpService]] to transform
      */</span>
  def <a title="(r: scalaz.concurrent.Task[org.http4s.Response])(service: org.http4s.server.HttpService)org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(4594a3d2e0)">apply</a><span class="delimiter">(</span><a title="scalaz.concurrent.Task[org.http4s.Response]" id="org.http4s.server.middleware.Timeout.apply(4594a3d2e0).r">r</a>: <span title="scalaz.concurrent.Task[org.http4s.Response]">Task</span><span class="delimiter">[</span>Response<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(4594a3d2e0).service">service</a>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a><span class="delimiter">)</span>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a> = <span class="delimiter">{</span>
      val <a title="scalaz.concurrent.Task[Some[org.http4s.Response]]" id="org.http4s.server.middleware.Timeout.apply(4594a3d2e0).rr">rr</a> = <a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).r" title="scalaz.concurrent.Task[org.http4s.Response]">r</a>.<span title="(f: org.http4s.Response =&gt; Some[org.http4s.Response])scalaz.concurrent.Task[Some[org.http4s.Response]]">map</span><span class="delimiter">(</span><span title="(x: org.http4s.Response)Some[org.http4s.Response]">Some</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).rr.$anonfun.x$1" title="org.http4s.Response">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="../Service.scala.html#org.http4s.server.Service" title="org.http4s.server.Service.type">Service</a>.<a href="../Service.scala.html#org.http4s.server.Service.lift" title="(f: org.http4s.Request =&gt; scalaz.concurrent.Task[Option[org.http4s.Response]])org.http4s.server.Service[org.http4s.Request,org.http4s.Response]">lift</a><span class="delimiter">{</span> req: <a href="../../../../../http4s-core/org/http4s/Message.scala.html#org.http4s;Request" title="org.http4s.Request">Request</a> =&gt; <span title="scalaz.concurrent.Task.type">Task</span>.<span title="=&gt; scalaz.Nondeterminism[scalaz.concurrent.Task] with scalaz.Catchable[scalaz.concurrent.Task] with scalaz.MonadError[[α, β]scalaz.concurrent.Task[β],Throwable]">taskInstance</span>.<span title="(head: scalaz.concurrent.Task[Option[org.http4s.Response]], tail: Seq[scalaz.concurrent.Task[Option[org.http4s.Response]]])scalaz.concurrent.Task[(Option[org.http4s.Response], Seq[scalaz.concurrent.Task[Option[org.http4s.Response]]])]">chooseAny</span><span class="delimiter">(</span><a href="../Service.scala.html#org.http4s.server;Service.apply" title="(a: org.http4s.Request)scalaz.concurrent.Task[Option[org.http4s.Response]]">service</a><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).$anonfun.req" title="org.http4s.Request">req</a><span class="delimiter">)</span>, <a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).rr" title="scalaz.concurrent.Task[Some[org.http4s.Response]]">rr</a><a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).$anonfun.x$2" title="(x: scalaz.concurrent.Task[Some[org.http4s.Response]])List[scalaz.concurrent.Task[Some[org.http4s.Response]]]">::</a><span title="scala.collection.immutable.Nil.type">Nil</span><span class="delimiter">)</span>.<span title="(f: ((Option[org.http4s.Response], Seq[scalaz.concurrent.Task[Option[org.http4s.Response]]])) =&gt; Option[org.http4s.Response])scalaz.concurrent.Task[Option[org.http4s.Response]]">map</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0).$anonfun.$anonfun.x$3" title="(Option[org.http4s.Response], Seq[scalaz.concurrent.Task[Option[org.http4s.Response]]])">_</a>.<span title="=&gt; Option[org.http4s.Response]">_1</span><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  <span class="comment">/** Transform the service to return a RequestTimeOut [[Status]] after the supplied Duration
    * @param timeout Duration to wait before returning the RequestTimeOut
    * @param service [[HttpService]] to transform
    */</span>
  def <a title="(timeout: scala.concurrent.duration.Duration)(service: org.http4s.server.HttpService)org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(b8a6e01d3e)">apply</a><span class="delimiter">(</span><a title="scala.concurrent.duration.Duration" id="org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).timeout">timeout</a>: <span title="scala.concurrent.duration.Duration">Duration</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).service">service</a>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a><span class="delimiter">)</span>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a> = <span class="delimiter">{</span>
    if <span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).timeout" title="scala.concurrent.duration.Duration">timeout</a>.<span title="()Boolean">isFinite</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#org.http4s.server.middleware.Timeout.apply(4594a3d2e0)" title="(r: scalaz.concurrent.Task[org.http4s.Response])(service: org.http4s.server.HttpService)org.http4s.server.HttpService">apply</a><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.timeoutResp" title="(timeout: scala.concurrent.duration.Duration)scalaz.concurrent.Task[org.http4s.Response]">timeoutResp</a><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).timeout" title="scala.concurrent.duration.Duration">timeout</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).service" title="org.http4s.server.HttpService">service</a><span class="delimiter">)</span>
    else <a href="#org.http4s.server.middleware.Timeout.apply(b8a6e01d3e).service" title="org.http4s.server.HttpService">service</a>
  <span class="delimiter">}</span>

  <span class="comment">/** Transform the service to return a RequestTimeOut [[Status]] after 30 seconds
    * @param service [[HttpService]] to transform
    */</span>
  def <a title="(service: org.http4s.server.HttpService)org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(525c695074)">apply</a><span class="delimiter">(</span><a title="org.http4s.server.HttpService" id="org.http4s.server.middleware.Timeout.apply(525c695074).service">service</a>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a><span class="delimiter">)</span>: <a href="../Service.scala.html#org.http4s.server;Service" title="org.http4s.server.HttpService">HttpService</a> = <a href="#org.http4s.server.middleware.Timeout.apply(b8a6e01d3e)" title="(timeout: scala.concurrent.duration.Duration)(service: org.http4s.server.HttpService)org.http4s.server.HttpService">apply</a><span class="delimiter">(</span><span title="implicit scala.concurrent.duration.package.DurationInt : (n: Int)concurrent.duration.DurationInt" class="int">30</span>.<span title="=&gt; scala.concurrent.duration.FiniteDuration">seconds</span><span class="delimiter">)</span><span class="delimiter">(</span><a href="#org.http4s.server.middleware.Timeout.apply(525c695074).service" title="org.http4s.server.HttpService">service</a><span class="delimiter">)</span>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>
