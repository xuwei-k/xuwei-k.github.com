<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>http4s-blazecore/org/http4s/blaze/websocket/Http4sWSStage.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package org.http4s
package blaze
package websocket

import org.http4s.websocket.<span title="org.http4s.websocket.WebsocketBits.type">WebsocketBits</span>._

import scala.util.<span class="delimiter">{</span>Failure, Success<span class="delimiter">}</span>
import org.http4s.blaze.pipeline.stages.SerializingStage
import org.http4s.blaze.util.<span title="org.http4s.blaze.util.Execution.type">Execution</span>.<span class="delimiter">{</span>directec, trampoline<span class="delimiter">}</span>
import org.http4s.<span class="delimiter">{</span>websocket =&gt; ws4s<span class="delimiter">}</span>

import scalaz.stream.<span class="delimiter">{</span>Process, Sink<span class="delimiter">}</span>
import scalaz.stream.<span title="scalaz.stream.Process.type">Process</span>._
import scalaz.stream.<span title="scalaz.stream.Cause.type">Cause</span>.<span class="delimiter">{</span>Terminated, End<span class="delimiter">}</span>
import scalaz.<span class="delimiter">{</span>\/, \/-, -\/<span class="delimiter">}</span>
import scalaz.concurrent.Task

import pipeline.<span class="delimiter">{</span>TrunkBuilder, LeafBuilder, Command, TailStage<span class="delimiter">}</span>
import pipeline.<span title="org.http4s.blaze.pipeline.Command.type">Command</span>.EOF

class <a title="class Http4sWSStage extends AnyRef with org.http4s.blaze.pipeline.TailStage[org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage">Http4sWSStage</a><a href="#org.http4s.blaze.websocket;Http4sWSStage" title="org.http4s.blaze.websocket.Http4sWSStage" class="delimiter">(</a><a title="org.http4s.websocket.Websocket" id="org.http4s.blaze.websocket;Http4sWSStage.ws">ws</a>: ws4s.<a href="../../../../../http4s-core/org/http4s/websocket/Websocket.scala.html#org.http4s.websocket;Websocket" title="org.http4s.websocket.Websocket">Websocket</a><span class="delimiter">)</span> extends <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="org.http4s.blaze.pipeline.TailStage[org.http4s.websocket.WebsocketBits.WebSocketFrame]">TailStage</a><span class="delimiter">[</span>WebSocketFrame<span class="delimiter">]</span> <span class="delimiter">{</span>
  def <a title="=&gt; String" id="org.http4s.blaze.websocket;Http4sWSStage.name">name</a>: <span title="String">String</span> = <span title="String(&quot;Http4s WebSocket Stage&quot;)" class="string">&quot;Http4s WebSocket Stage&quot;</span>

  @volatile private var <a title="Boolean" id="org.http4s.blaze.websocket;Http4sWSStage.alive_=">alive</a> = true

  <span class="comment">//////////////////////// Source and Sink generators ////////////////////////</span>

  def <a title="=&gt; scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.sink">sink</a>: <span title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">Sink</span><span class="delimiter">[</span>Task, WebSocketFrame<span class="delimiter">]</span> = <span class="delimiter">{</span>
    def <a title="(frame: org.http4s.websocket.WebsocketBits.WebSocketFrame)scalaz.concurrent.Task[Unit]" id="org.http4s.blaze.websocket;Http4sWSStage.sink.go">go</a><span class="delimiter">(</span><a title="org.http4s.websocket.WebsocketBits.WebSocketFrame" id="org.http4s.blaze.websocket;Http4sWSStage.sink.go.frame">frame</a>: <span title="org.http4s.websocket.WebsocketBits.WebSocketFrame">WebSocketFrame</span><span class="delimiter">)</span>: <span title="scalaz.concurrent.Task[Unit]">Task</span><span class="delimiter">[</span>Unit<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span title="scalaz.concurrent.Task.type">Task</span>.<span title="(register: (scalaz.\/[Throwable,Unit] =&gt; Unit) =&gt; Unit)scalaz.concurrent.Task[Unit]">async</span> <span class="delimiter">{</span> <a title="scalaz.\/[Throwable,Unit] =&gt; Unit" id="org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.cb">cb</a> =&gt;
        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.alive_=" title="=&gt; Boolean">alive</a><span class="delimiter">)</span> <a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.cb" title="(v1: scalaz.\/[Throwable,Unit])Unit">cb</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        else <span class="delimiter">{</span>
          <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(data: org.http4s.websocket.WebsocketBits.WebSocketFrame)scala.concurrent.Future[Unit]">channelWrite</a><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.frame" title="org.http4s.websocket.WebsocketBits.WebSocketFrame">frame</a><span class="delimiter">)</span>.<span title="(f: scala.util.Try[Unit] =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)Unit">onComplete</span> <a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.$anonfun.x0$1" title="Unit" class="delimiter">{</a>
            case Success<span class="delimiter">(</span>_<span class="delimiter">)</span>           =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.cb" title="(v1: scalaz.\/[Throwable,Unit])Unit">cb</a><span class="delimiter">(</span><span title="(b: Unit)scalaz.\/-[Unit]">\/-</span><span class="delimiter">(</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            case Failure<span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.type">Command</span>.<span title="org.http4s.blaze.pipeline.Command.EOF.type">EOF</span><span class="delimiter">)</span> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.cb" title="(v1: scalaz.\/[Throwable,Unit])Unit">cb</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            case Failure<span class="delimiter">(</span><a title="Throwable" id="org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.$anonfun.t">t</a><span class="delimiter">)</span>           =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.cb" title="(v1: scalaz.\/[Throwable,Unit])Unit">cb</a><span class="delimiter">(</span><span title="(a: Throwable)scalaz.-\/[Throwable]">-\/</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go.$anonfun.$anonfun.t" title="Throwable">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span><span class="delimiter">(</span><span title="=&gt; scala.concurrent.ExecutionContext">directec</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span title="scalaz.stream.Process.type">Process</span>.<span title="(a: org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit], chunkSize: Int)scalaz.stream.Process0[org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]]">constant</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.sink.go" title="(frame: org.http4s.websocket.WebsocketBits.WebSocketFrame)scalaz.concurrent.Task[Unit]">go</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="=&gt; scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream">inputstream</a>: <span title="scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">Process</span><span class="delimiter">[</span>Task, WebSocketFrame<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="scalaz.concurrent.Task[org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t">t</a> = <span title="scalaz.concurrent.Task.type">Task</span>.<span title="[A](register: (scalaz.\/[Throwable,A] =&gt; Unit) =&gt; Unit)scalaz.concurrent.Task[A]">async</span><span title="(register: (scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame] =&gt; Unit) =&gt; Unit)scalaz.concurrent.Task[org.http4s.websocket.WebsocketBits.WebSocketFrame]" class="delimiter">[</span><span title="org.http4s.websocket.WebsocketBits.WebSocketFrame">WebSocketFrame</span><span class="delimiter">]</span> <span class="delimiter">{</span> <a title="scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame] =&gt; Unit" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb">cb</a> =&gt;
      def <a title="()Unit" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go">go</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(size: Int, timeout: scala.concurrent.duration.Duration)scala.concurrent.Future[org.http4s.websocket.WebsocketBits.WebSocketFrame]">channelRead</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(f: scala.util.Try[org.http4s.websocket.WebsocketBits.WebSocketFrame] =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)Unit">onComplete</span> <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.x0$2" title="Unit" class="delimiter">{</a>
        case Success<span class="delimiter">(</span><a title="org.http4s.websocket.WebsocketBits.WebSocketFrame" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.ws">ws</a><span class="delimiter">)</span> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.ws" title="org.http4s.websocket.WebsocketBits.WebSocketFrame">ws</a> match <span class="delimiter">{</span>
            case Close<span class="delimiter">(</span>_<span class="delimiter">)</span>    =&gt;
              <a href="#org.http4s.blaze.websocket;Http4sWSStage.alive_=" title="(x$1: Boolean)Unit">alive</a> = false
              <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(cmd: org.http4s.blaze.pipeline.Command.OutboundCommand)Unit">sendOutboundCommand</a><span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.type">Command</span>.<span title="org.http4s.blaze.pipeline.Command.Disconnect.type">Disconnect</span><span class="delimiter">)</span>
              <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

            <span class="comment">// TODO: do we expect ping frames here?</span>
            case Ping<span class="delimiter">(</span><a title="Array[Byte]" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.d">d</a><span class="delimiter">)</span>     =&gt;  <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(data: org.http4s.websocket.WebsocketBits.WebSocketFrame)scala.concurrent.Future[Unit]">channelWrite</a><span class="delimiter">(</span><span title="(data: Array[Byte])org.http4s.websocket.WebsocketBits.Pong">Pong</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.d" title="Array[Byte]">d</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: scala.util.Try[Unit] =&gt; Unit)(implicit executor: scala.concurrent.ExecutionContext)Unit">onComplete</span> <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.$anonfun.x0$3" title="Unit" class="delimiter">{</a>
              case Success<span class="delimiter">(</span>_<span class="delimiter">)</span>   =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go" title="()Unit">go</a><span class="delimiter">(</span><span class="delimiter">)</span>
              case Failure<span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.EOF.type">EOF</span><span class="delimiter">)</span> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              case Failure<span class="delimiter">(</span><a title="Throwable" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.$anonfun.t">t</a><span class="delimiter">)</span>   =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(a: Throwable)scalaz.-\/[Throwable]">-\/</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.$anonfun.t" title="Throwable">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span><span class="delimiter">(</span><span title="=&gt; scala.concurrent.ExecutionContext">trampoline</span><span class="delimiter">)</span>

            case Pong<span class="delimiter">(</span>_<span class="delimiter">)</span>     =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go" title="()Unit">go</a><span class="delimiter">(</span><span class="delimiter">)</span>
            case <a title="org.http4s.websocket.WebsocketBits.WebSocketFrame" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.f">f</a>           =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(b: org.http4s.websocket.WebsocketBits.WebSocketFrame)scalaz.\/-[org.http4s.websocket.WebsocketBits.WebSocketFrame]">\/-</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.f" title="org.http4s.websocket.WebsocketBits.WebSocketFrame">f</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>

        case Failure<span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.type">Command</span>.<span title="org.http4s.blaze.pipeline.Command.EOF.type">EOF</span><span class="delimiter">)</span> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        case Failure<span class="delimiter">(</span><a title="Throwable" id="org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.e">e</a><span class="delimiter">)</span>           =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.cb" title="(v1: scalaz.\/[Throwable,org.http4s.websocket.WebsocketBits.WebSocketFrame])Unit">cb</a><span class="delimiter">(</span><span title="(a: Throwable)scalaz.-\/[Throwable]">-\/</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go.$anonfun.e" title="Throwable">e</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">(</span><span title="=&gt; scala.concurrent.ExecutionContext">trampoline</span><span class="delimiter">)</span>

      <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t.$anonfun.go" title="()Unit">go</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="(f: scalaz.concurrent.Task[org.http4s.websocket.WebsocketBits.WebSocketFrame])scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">repeatEval</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream.t" title="scalaz.concurrent.Task[org.http4s.websocket.WebsocketBits.WebSocketFrame]">t</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">//////////////////////// Startup and Shutdown ////////////////////////</span>

  override protected def <a title="()Unit" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup">stageStartup</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    super.<span title="()Unit">stageStartup</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// A latch for shutting down if both streams are closed.</span>
    val <a title="java.util.concurrent.atomic.AtomicInteger" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.count">count</a> = new java.util.concurrent.atomic.<span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span><span class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>

    val <a title="scalaz.\/[Throwable,Any] =&gt; Unit" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish">onFinish</a>: \/<span class="delimiter">[</span>Throwable,Any<span class="delimiter">]</span> =&gt; Unit = <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish.$anonfun.x0$4" title="Unit" class="delimiter">{</a>
      case \/-<span class="delimiter">(</span>_<span class="delimiter">)</span> =&gt;
        <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="=&gt; org.log4s.Logger">logger</a>.trace<span title="(x$1: String)Unit" class="delimiter">(</span><span title="String(&quot;WebSocket finish signaled&quot;)" class="string">&quot;WebSocket finish signaled&quot;</span><span class="delimiter">)</span>
        if <span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.count" title="java.util.concurrent.atomic.AtomicInteger">count</a>.<span title="()Int">decrementAndGet</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="=&gt; org.log4s.Logger">logger</a>.trace<span title="(x$1: String)Unit" class="delimiter">(</span><span title="String(&quot;Closing WebSocket&quot;)" class="string">&quot;Closing WebSocket&quot;</span><span class="delimiter">)</span>
          <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(cmd: org.http4s.blaze.pipeline.Command.OutboundCommand)Unit">sendOutboundCommand</a><span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.type">Command</span>.<span title="org.http4s.blaze.pipeline.Command.Disconnect.type">Disconnect</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      case -\/<span class="delimiter">(</span><a title="Throwable" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish.$anonfun.t">t</a><span class="delimiter">)</span> =&gt;
        <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="=&gt; org.log4s.Logger">logger</a>.trace<span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish.$anonfun.t" title="Throwable">t</a><span class="delimiter">)</span><span title="(x$1: String, x$2: Throwable)Unit" class="delimiter">(</span><span title="String(&quot;WebSocket Exception&quot;)" class="string">&quot;WebSocket Exception&quot;</span><span class="delimiter">)</span>
        <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="(cmd: org.http4s.blaze.pipeline.Command.OutboundCommand)Unit">sendOutboundCommand</a><span class="delimiter">(</span><span title="org.http4s.blaze.pipeline.Command.type">Command</span>.<span title="org.http4s.blaze.pipeline.Command.Disconnect.type">Disconnect</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#org.http4s.blaze.websocket;Http4sWSStage.ws" title="org.http4s.websocket.Websocket">ws</a>.<a href="../../../../../http4s-core/org/http4s/websocket/Websocket.scala.html#org.http4s.websocket;Websocket.source" title="(self: scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame])scalaz.stream.Process.ProcessSyntax[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">source</a>.<span title="(f: scalaz.stream.Channel[[x]scalaz.concurrent.Task[x],org.http4s.websocket.WebsocketBits.WebSocketFrame,Unit])scalaz.stream.Process[[x]scalaz.concurrent.Task[x],Unit]">through</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.sink" title="=&gt; scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">sink</a><span class="delimiter">)</span>.<span title="(implicit F: scalaz.Monad[[x]scalaz.concurrent.Task[x]], implicit C: scalaz.Catchable[[x]scalaz.concurrent.Task[x]])scalaz.concurrent.Task[Unit]">run</span>.<span title="(f: scalaz.\/[Throwable,Unit] =&gt; Unit)Unit">runAsync</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish" title="scalaz.\/[Throwable,Any] =&gt; Unit">onFinish</a><span class="delimiter">)</span>

    <span class="comment">// The sink is a bit more complicated</span>
    val <a title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.discard">discard</a>: <span title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">Sink</span><span class="delimiter">[</span>Task, WebSocketFrame<span class="delimiter">]</span> = <span title="scalaz.stream.Process.type">Process</span>.<span title="(a: org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit], chunkSize: Int)scalaz.stream.Process0[org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]]">constant</span><span class="delimiter">(</span><a title="org.http4s.websocket.WebsocketBits.WebSocketFrame" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.discard.$anonfun.x$1">_</a> =&gt; <span title="scalaz.concurrent.Task.type">Task</span>.<span title="(a: Unit)scalaz.concurrent.Task[Unit]">now</span><span class="delimiter">(</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// if we never expect to get a message, we need to make sure the sink signals closed</span>
    val <a title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink">routeSink</a>: <span title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">Sink</span><span class="delimiter">[</span>Task, WebSocketFrame<span class="delimiter">]</span> = <a href="#org.http4s.blaze.websocket;Http4sWSStage.ws" title="org.http4s.websocket.Websocket">ws</a>.<a href="../../../../../http4s-core/org/http4s/websocket/Websocket.scala.html#org.http4s.websocket;Websocket.sink" title="=&gt; scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">sink</a> match <span class="delimiter">{</span>
      case Halt<span class="delimiter">(</span><span title="scalaz.stream.Cause.End.type">End</span><span class="delimiter">)</span> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish" title="(v1: scalaz.\/[Throwable,Any])Unit">onFinish</a><span class="delimiter">(</span><span title="(b: Unit)scalaz.\/-[Unit]">\/-</span><span class="delimiter">(</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.discard" title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">discard</a>
      case Halt<span class="delimiter">(</span><a title="scalaz.stream.Cause" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.e">e</a><span class="delimiter">)</span>   =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish" title="(v1: scalaz.\/[Throwable,Any])Unit">onFinish</a><span class="delimiter">(</span><span title="(a: scalaz.stream.Cause.Terminated)scalaz.-\/[scalaz.stream.Cause.Terminated]">-\/</span><span class="delimiter">(</span><span title="(cause: scalaz.stream.Cause)scalaz.stream.Cause.Terminated">Terminated</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.e" title="scalaz.stream.Cause">e</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>; <a href="#org.http4s.blaze.websocket;Http4sWSStage.ws" title="org.http4s.websocket.Websocket">ws</a>.<a href="../../../../../http4s-core/org/http4s/websocket/Websocket.scala.html#org.http4s.websocket;Websocket.sink" title="=&gt; scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">sink</a>
      case <a title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.s">s</a> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.s" title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">s</a> <span title="(p2: =&gt; scalaz.stream.Process[[x]scalaz.concurrent.Task[x],org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]])scalaz.stream.Process[[x]scalaz.concurrent.Task[x],org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]]">++</span> <span title="(req: scalaz.concurrent.Task[Unit])(rcv: Unit =&gt; scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]])scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame =&gt; scalaz.concurrent.Task[Unit]]">await</span><span class="delimiter">(</span><span title="scalaz.concurrent.Task.type">Task</span><a title="java.util.concurrent.ExecutorService" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.x$4" class="delimiter">{</a><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish" title="(v1: scalaz.\/[Throwable,Any])Unit">onFinish</a><a title="() =&gt; Unit @scala.reflect.internal.annotations.uncheckedBounds" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.x$3" class="delimiter">(</a><span title="(b: Unit)scalaz.\/-[Unit]">\/-</span><span class="delimiter">(</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="Unit" id="org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink.$anonfun.x$2">_</a> =&gt; <a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.discard" title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">discard</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#org.http4s.blaze.websocket;Http4sWSStage.inputstream" title="(self: scalaz.stream.Process[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame])scalaz.stream.Process.ProcessSyntax[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">inputstream</a>.<span title="(f: scalaz.stream.Sink[[x]scalaz.concurrent.Task[x],org.http4s.websocket.WebsocketBits.WebSocketFrame])scalaz.stream.Process[[x]scalaz.concurrent.Task[x],Unit]">to</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.routeSink" title="scalaz.stream.Sink[scalaz.concurrent.Task,org.http4s.websocket.WebsocketBits.WebSocketFrame]">routeSink</a><span class="delimiter">)</span>.<span title="(implicit F: scalaz.Monad[[x]scalaz.concurrent.Task[x]], implicit C: scalaz.Catchable[[x]scalaz.concurrent.Task[x]])scalaz.concurrent.Task[Unit]">run</span>.<span title="(f: scalaz.\/[Throwable,Unit] =&gt; Unit)Unit">runAsync</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket;Http4sWSStage.stageStartup.onFinish" title="scalaz.\/[Throwable,Any] =&gt; Unit">onFinish</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  override protected def <a title="()Unit" id="org.http4s.blaze.websocket;Http4sWSStage.stageShutdown">stageShutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#org.http4s.blaze.websocket;Http4sWSStage.alive_=" title="(x$1: Boolean)Unit">alive</a> = false
    super.<span title="()Unit">stageShutdown</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

object <a title="org.http4s.blaze.websocket.Http4sWSStage.type" id="org.http4s.blaze.websocket.Http4sWSStage">Http4sWSStage</a> <a href="#org.http4s.blaze.websocket.Http4sWSStage" title="org.http4s.blaze.websocket.Http4sWSStage.type" class="delimiter">{</a>
  def <a title="(stage: org.http4s.blaze.websocket.Http4sWSStage)org.http4s.blaze.pipeline.LeafBuilder[org.http4s.websocket.WebsocketBits.WebSocketFrame]" id="org.http4s.blaze.websocket.Http4sWSStage.bufferingSegment">bufferingSegment</a><span class="delimiter">(</span><a title="org.http4s.blaze.websocket.Http4sWSStage" id="org.http4s.blaze.websocket.Http4sWSStage.bufferingSegment.stage">stage</a>: <a href="#org.http4s.blaze.websocket;Http4sWSStage" title="org.http4s.blaze.websocket.Http4sWSStage">Http4sWSStage</a><span class="delimiter">)</span>: <span title="org.http4s.blaze.pipeline.LeafBuilder[org.http4s.websocket.WebsocketBits.WebSocketFrame]">LeafBuilder</span><span class="delimiter">[</span>WebSocketFrame<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span title="(mid: org.http4s.blaze.pipeline.MidStage[org.http4s.websocket.WebsocketBits.WebSocketFrame,org.http4s.websocket.WebsocketBits.WebSocketFrame])org.http4s.blaze.pipeline.TrunkBuilder[org.http4s.websocket.WebsocketBits.WebSocketFrame,org.http4s.websocket.WebsocketBits.WebSocketFrame]">TrunkBuilder</span><span class="delimiter">(</span>new <span title="org.http4s.blaze.pipeline.stages.SerializingStage[org.http4s.websocket.WebsocketBits.WebSocketFrame]">SerializingStage</span><span class="delimiter">[</span>WebSocketFrame<span class="delimiter">]</span><span class="delimiter">)</span>.<span title="(stage: org.http4s.blaze.pipeline.TailStage[org.http4s.websocket.WebsocketBits.WebSocketFrame])org.http4s.blaze.pipeline.LeafBuilder[org.http4s.websocket.WebsocketBits.WebSocketFrame]">cap</span><span class="delimiter">(</span><a href="#org.http4s.blaze.websocket.Http4sWSStage.bufferingSegment.stage" title="org.http4s.blaze.websocket.Http4sWSStage">stage</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
