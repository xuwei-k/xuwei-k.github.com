<?xml version="1.0" encoding="utf-8"?>
			<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>netty-server/unfiltered/netty/resources.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> unfiltered.netty

<span class="keyword">import</span> org.jboss.netty.channel._
<span class="keyword">import</span> java.nio.charset.Charset

<span class="keyword">import</span> unfiltered.netty.resources.Resolve

<span class="keyword">object</span> <a title="unfiltered.netty.Mimes.type" id="9831">Mimes</a> <a href="#9832" title="unfiltered.netty.Mimes.type" class="delimiter">{</a>
  <span class="keyword">import</span> javax.activation.MimetypesFileTypeMap

  <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="javax.activation.MimetypesFileTypeMap" id="57655">underlying</a> =
    <span title="(x$1: java.io.InputStream)javax.activation.MimetypesFileTypeMap" class="keyword">new</span> <span title="javax.activation.MimetypesFileTypeMap">MimetypesFileTypeMap</span><span class="delimiter">(</span><span title="()Class[_]">getClass</span>.<span title="(x$1: String)java.io.InputStream">getResourceAsStream</span><span class="delimiter">(</span><span title="String(&quot;/mime.types&quot;)" class="string">&quot;/mime.types&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(path: String)String" id="57657">apply</a><span class="delimiter">(</span><a title="String" id="57767">path</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="#57655" title="=&gt; javax.activation.MimetypesFileTypeMap">underlying</a>.<span title="(x$1: String)String">getContentType</span><span class="delimiter">(</span><a href="#57767" title="String">path</a><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span title="AnyRef" class="keyword">object</span> <a title="unfiltered.netty.Dates.type" id="9765">Dates</a> <a href="#9766" title="unfiltered.netty.Dates.type" class="delimiter">{</a>
  <span class="keyword">import</span> java.text.SimpleDateFormat
  <span class="keyword">import</span> java.util.<span class="delimiter">{</span> Date, Locale, TimeZone <span class="delimiter">}</span>

  <span class="keyword">val</span> <a title="String" id="57775">HttpDateFormat</a> = <span title="String(&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;)" class="string">&quot;EEE, dd MMM yyyy HH:mm:ss zzz&quot;</span>
  <span class="keyword">val</span> <a title="String" id="57777">HttpDateGMTTimezone</a> = <span title="String(&quot;GMT&quot;)" class="string">&quot;GMT&quot;</span>
  <span class="keyword">def</span> <a title="(d: Long)String" id="57779">format</a><span class="delimiter">(</span><a title="Long" id="57982">d</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="String">String</span> =
    <a href="#57983" title="java.text.SimpleDateFormat" class="keyword">new</a> <a title="anonymous class $anon extends java.text.SimpleDateFormat" id="57983">SimpleDateFormat</a><span class="delimiter">(</span><a href="#57775" title="=&gt; String">HttpDateFormat</a>, <span title="java.util.Locale.type">Locale</span>.<span title="java.util.Locale">US</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#57983" title="(x$1: java.util.TimeZone)Unit">setTimeZone</a><span class="delimiter">(</span><span title="java.util.TimeZone.type">TimeZone</span>.<span title="(x$1: String)java.util.TimeZone">getTimeZone</span><span class="delimiter">(</span><a href="#57777" title="=&gt; String">HttpDateGMTTimezone</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(x$1: Any)String">format</span><span class="delimiter">(</span><a href="#57982" title="Long">d</a><span class="delimiter">)</span>
  <span class="keyword">def</span> <a title="(d: java.util.Date)String" id="57780">format</a><span class="delimiter">(</span><a title="java.util.Date" id="58430">d</a>: <span title="java.util.Date">Date</span><span class="delimiter">)</span>: <span title="String">String</span> = <a href="#57779" title="(d: Long)String">format</a><span class="delimiter">(</span><a href="#58430" title="java.util.Date">d</a>.<span title="()Long">getTime</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

/** Extracts HttpRequest if a retrieval method */
<span title="AnyRef" class="keyword">object</span> <a title="unfiltered.netty.Retrieval.type" id="9921">Retrieval</a> <a href="#9922" title="unfiltered.netty.Retrieval.type" class="delimiter">{</a>
  <span class="keyword">import</span> unfiltered.request.<span class="delimiter">{</span>HttpRequest, GET, HEAD<span class="delimiter">}</span>
  <span class="keyword">def</span> <a title="[T](r: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]" id="58439">unapply</a><span class="delimiter">[</span><a title="" id="58441">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[T]" id="58443">r</a>: <a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#7615" title="unfiltered.request.HttpRequest[T]">HttpRequest</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span> =
    <a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#7577" title="unfiltered.request.GET.type">GET</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#34957" title="(req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">unapply</a><span class="delimiter">(</span><a href="#58443" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span>.<span title="(alternative: =&gt; Option[unfiltered.request.HttpRequest[T]])Option[unfiltered.request.HttpRequest[T]]">orElse</span> <span class="delimiter">{</span> <a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#7583" title="unfiltered.request.HEAD.type">HEAD</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#34957" title="(req: unfiltered.request.HttpRequest[T])Option[unfiltered.request.HttpRequest[T]]">unapply</a><span class="delimiter">(</span><a href="#58443" title="unfiltered.request.HttpRequest[T]">r</a><span class="delimiter">)</span> <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span title="AnyRef" class="keyword">object</span> <a title="unfiltered.netty.Resources.type" id="58600">Resources</a> <a href="#9907" title="unfiltered.netty.Resources.type" class="delimiter">{</a>
  <span class="keyword">val</span> <a title="java.nio.charset.Charset" id="58459">utf8</a> = <span title="java.nio.charset.Charset.type">Charset</span>.<span title="(x$1: String)java.nio.charset.Charset">forName</span><span class="delimiter">(</span><span title="String(&quot;UTF-8&quot;)" class="string">&quot;UTF-8&quot;</span><span class="delimiter">)</span>
  <span class="keyword">val</span> <a title="java.nio.charset.Charset" id="58461">iso88591</a> = <span title="java.nio.charset.Charset.type">Charset</span>.<span title="(x$1: String)java.nio.charset.Charset">forName</span><span class="delimiter">(</span><span title="String(&quot;ISO-8859-1&quot;)" class="string">&quot;ISO-8859-1&quot;</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

/** Serves static resources.
 *  Adapted from Netty's example HttpStaticFileServerHandler
 */
<span title="AnyRef" class="keyword">case class</span> <a title="(base: java.net.URL, cacheSeconds: Int, passOnFail: Boolean)unfiltered.netty.Resources" id="60966">Resources</a><a href="#60966" title="Product" class="delimiter">(</a><a title="java.net.URL" id="60942">base</a>: java.net.<span title="java.net.URL">URL</span>,
                     <a title="Int" id="60943">cacheSeconds</a>: <span title="Int">Int</span> = <span title="Int(60)" class="int">60</span>,
                     <a title="Boolean" id="60944">passOnFail</a>: <span title="Boolean">Boolean</span> = <span title="Boolean(true)" class="keyword">true</span><span class="delimiter">)</span>
  <span class="keyword">extends</span> unfiltered.netty.async.<a href="../../../netty/unfiltered/netty/async/plans.scala.html#10544" title="unfiltered.netty.async.Plan">Plan</a> <span class="keyword">with</span> <a href="../../../netty/unfiltered/netty/exceptions.scala.html#9938" title="unfiltered.netty.ServerErrorResponse">ServerErrorResponse</a> <span class="delimiter">{</span>
  <span class="keyword">import</span> <a href="#58600" title="unfiltered.netty.Resources.type">Resources</a>._
  <span class="keyword">import</span> resources._
  <span class="keyword">import</span> unfiltered.request._
  <span class="keyword">import</span> unfiltered.response._
  <span class="keyword">import</span> java.io.<span class="delimiter">{</span> File, FileNotFoundException, RandomAccessFile <span class="delimiter">}</span>
  <span class="keyword">import</span> java.net.<span class="delimiter">{</span> URL, URLDecoder <span class="delimiter">}</span>
  <span class="keyword">import</span> java.util.<span class="delimiter">{</span> Calendar, GregorianCalendar <span class="delimiter">}</span>
  <span class="keyword">import</span> org.jboss.netty.channel.<span class="delimiter">{</span>
    ChannelFuture, ChannelFutureListener, DefaultFileRegion <span class="delimiter">}</span>
  <span class="keyword">import</span> org.jboss.netty.handler.codec.http.<span class="delimiter">{</span>
    HttpHeaders, HttpResponse =&gt; NHttpResponse <span class="delimiter">}</span>
  <span class="keyword">import</span> org.jboss.netty.handler.stream.<span class="delimiter">{</span> ChunkedFile, ChunkedStream <span class="delimiter">}</span>
  <span class="keyword">import</span> scala.util.control.<span title="scala.util.control.Exception.type">Exception</span>.allCatch

  // Returning Pass here will send the request upstream, otherwise
  // this method handles the request itself
  <span class="keyword">def</span> <a title="[T &lt;: org.jboss.netty.handler.codec.http.HttpResponse](rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any" id="58532">passOr</a><span class="delimiter">[</span><a title=" &lt;: org.jboss.netty.handler.codec.http.HttpResponse" id="58534">T</a> &lt;: NHttpResponse<span class="delimiter">]</span><span class="delimiter">(</span><a title="=&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]" id="58633">rf</a>: =&gt; ResponseFunction<span class="delimiter">[</span>NHttpResponse<span class="delimiter">]</span><span class="delimiter">)</span>
                                <span class="delimiter">(</span><a title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" id="58634">req</a>: <a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#7615" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]">HttpRequest</a><span class="delimiter">[</span>ReceivedMessage<span class="delimiter">]</span><span class="delimiter">)</span> =
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#60944" title="=&gt; Boolean">passOnFail</a><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/pass.scala.html#9308" title="unfiltered.response.Pass.type">Pass</a> <span class="keyword">else</span> <a href="#58634" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58652" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])Unit">respond</a><span class="delimiter">(</span><a href="#58633" title="=&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse]">rf</a><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="58535">forbid</a> = <a href="#58532" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#58902" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#9053" title="unfiltered.response.Forbidden.type">Forbidden</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="58536">notFound</a> = <a href="#58532" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#58909" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#9233" title="unfiltered.response.NotFound.type">NotFound</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] =&gt; Any" id="58537">badRequest</a> = <a href="#58532" title="(rf: =&gt; unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.HttpResponse])(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">passOr</a><a href="#58928" title="unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</a><a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#8900" title="unfiltered.response.BadRequest.type">BadRequest</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/types.scala.html#9326" title="unfiltered.response.PlainTextContent.type">PlainTextContent</a><span class="delimiter">)</span>_

  <span class="keyword">def</span> <a title="=&gt; PartialFunction[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse],Any]" id="58538">intent</a> = <a title="anonymous class $anonfun extends scala.runtime.AbstractPartialFunction[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse],Any] with Serializable" id="60752" class="delimiter">{</a>
    <span class="keyword">case</span> <a href="#58439" title="(r: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]]">Retrieval</a><span title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" class="delimiter">(</span><a href="../../../unfiltered/unfiltered/unfiltered/request/paths.scala.html#23999" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Some[String]">Path</a><span title="=&gt; unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]" class="delimiter">(</span><a title="String" id="59016">path</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/request/utils.scala.html#57198" title="(a: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse])Some[(unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse], unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse])]">&amp;</a> <a title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]" id="59017">req</a> =&gt; <a href="#58539" title="(uri: String)Option[unfiltered.netty.resources.Resource]">safe</a><a href="#121969" title="(x: B1)B1" class="delimiter">(</a><a href="#59016" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">path</a>.<span title="(n: Int)String">drop</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#121986" title="(x: Boolean)Boolean" class="keyword">match</a> <span class="delimiter">{</span>
      <span class="keyword">case</span> Some<a href="#121954" title="Any" class="delimiter">(</a><a href="#121955" title="unfiltered.netty.resources.Resource" id="59044">rsrc</a><span class="delimiter">)</span> =&gt;
        <a href="../../../unfiltered/unfiltered/unfiltered/request/headers.scala.html#17611" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[java.util.Date]">IfModifiedSince</a><a href="#121957" title="(x: Any)Any" class="delimiter">(</a><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span> <span class="keyword">match</span> <span class="delimiter">{</span>
          <span class="keyword">case</span> Some<a href="#121946" title="Any" class="delimiter">(</a><a href="#121947" title="java.util.Date" id="59066">since</a><span class="delimiter">)</span> <span class="keyword">if</span> <span class="delimiter">(</span><a href="#59066" title="java.util.Date">since</a>.<span title="()Long">getTime</span> <span title="(x: Long)Boolean">==</span> <a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59072" title="=&gt; Long">lastModified</a><span class="delimiter">)</span> =&gt;
            // close immediately and do not include content-length header
            // http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html
            <a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58644" title="=&gt; org.jboss.netty.channel.MessageEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
              <a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58650" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">defaultResponse</a><span class="delimiter">(</span>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#9245" title="unfiltered.response.NotModified.type">NotModified</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">Date</a><span class="delimiter">(</span><a href="#9765" title="unfiltered.netty.Dates.type">Dates</a>.<a href="#57780" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><span title="java.util.GregorianCalendar" class="keyword">new</span> <span title="java.util.GregorianCalendar">GregorianCalendar</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><a href="#121949" title="(x: Any)Any" class="delimiter">(</a><span title="org.jboss.netty.channel.ChannelFutureListener.type">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
          <span class="keyword">case</span> _ =&gt;
            <a href="#121949" title="(x: Any)Any" class="keyword">if</a> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59077" title="=&gt; Boolean">exists</a> <span title="(x: Boolean)Boolean">||</span> <a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59074" title="=&gt; Boolean">hidden</a><span class="delimiter">)</span> <a href="#58536" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">notFound</a><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59073" title="=&gt; Boolean">directory</a><span class="delimiter">)</span> <a href="#58535" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">forbid</a><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="keyword">else</span> <span class="keyword">try</span> <span class="delimiter">{</span>
              <span class="keyword">val</span> <a title="Long" id="59581">len</a> = <a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59076" title="=&gt; Long">size</a>
              <span class="keyword">val</span> <a title="java.util.GregorianCalendar" id="59582">cal</a> = <span title="java.util.GregorianCalendar" class="keyword">new</span> <span title="java.util.GregorianCalendar">GregorianCalendar</span><span class="delimiter">(</span><span class="delimiter">)</span>
              <span class="keyword">var</span> <a title="~&gt; extends AnyRef with unfiltered.response.ResponseFunction[Any]" id="59583">heads</a> = <a href="../../../unfiltered/unfiltered/unfiltered/response/statuses.scala.html#9251" title="unfiltered.response.Ok.type">Ok</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">ContentLength</a><span class="delimiter">(</span><a href="#59581" title="Long">len</a>.<span title="()String">toString</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                // note: bin/text/charset not included
                <a href="../../../unfiltered/unfiltered/unfiltered/response/types.scala.html#59610" title="(staticContentType: String)unfiltered.response.ContentType">ContentType</a><span class="delimiter">(</span><a href="#57657" title="(path: String)String">Mimes</a><span class="delimiter">(</span><a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59075" title="=&gt; String">path</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">Date</a><span class="delimiter">(</span><a href="#9765" title="unfiltered.netty.Dates.type">Dates</a>.<a href="#57780" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><a href="#59582" title="java.util.GregorianCalendar">cal</a>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">CacheControl</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;private, max-age=%d&quot;</span> <span title="(args: Any*)String">format</span> <a href="#60943" title="=&gt; Int">cacheSeconds</a><span class="delimiter">)</span> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a>
                <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">LastModified</a><span class="delimiter">(</span><a href="#9765" title="unfiltered.netty.Dates.type">Dates</a>.<a href="#57779" title="(d: Long)String">format</a><span class="delimiter">(</span><a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59072" title="=&gt; Long">lastModified</a><span class="delimiter">)</span><span class="delimiter">)</span>

              <a href="#59582" title="java.util.GregorianCalendar">cal</a>.<span title="(x$1: Int, x$2: Int)Unit">add</span><span class="delimiter">(</span>Calendar.<span title="Int(13)">SECOND</span>, <a href="#60943" title="=&gt; Int">cacheSeconds</a><span class="delimiter">)</span>

              <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="59584">chan</a> = <a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58644" title="=&gt; org.jboss.netty.channel.MessageEvent">event</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
              <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelFuture" id="59585">writeHeaders</a> = <a href="#59584" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span>
                <a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58650" title="(v1: unfiltered.response.ResponseFunction[org.jboss.netty.handler.codec.http.DefaultHttpResponse])org.jboss.netty.handler.codec.http.DefaultHttpResponse">defaultResponse</a><span class="delimiter">(</span>
                  <a href="#59583" title="~&gt; extends AnyRef with unfiltered.response.ResponseFunction[Any]">heads</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/functions.scala.html#22177" title="(that: unfiltered.response.ResponseFunction[Any])unfiltered.response.ResponseFunction[Any]">~&gt;</a> <a href="../../../unfiltered/unfiltered/unfiltered/response/headers.scala.html#54841" title="(value: String*)unfiltered.response.ResponseHeader">Expires</a><span class="delimiter">(</span><a href="#9765" title="unfiltered.netty.Dates.type">Dates</a>.<a href="#57780" title="(d: java.util.Date)String">format</a><span class="delimiter">(</span><a href="#59582" title="java.util.GregorianCalendar">cal</a>.<span title="()java.util.Date">getTime</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

              <span class="keyword">def</span> <a title="(future: org.jboss.netty.channel.ChannelFuture)Unit" id="59586">lastly</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="59686">future</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> =
                <span title="Unit" class="keyword">if</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#10209" title="org.jboss.netty.handler.codec.http.HttpHeaders.type">HttpHeaders</a>.<a href="../../../netty-uploads/unfiltered/netty/uploads/org/jboss/netty/handler/codec/http/HttpHeaders.java.html#59694" title="(message: org.jboss.netty.handler.codec.http.HttpMessage)Boolean">isKeepAlive</a><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12727" title="=&gt; unfiltered.netty.ReceivedMessage">underlying</a>.<a href="../../../netty/unfiltered/netty/bindings.scala.html#58640" title="=&gt; org.jboss.netty.handler.codec.http.HttpRequest">request</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                   <a href="#59686" title="org.jboss.netty.channel.ChannelFuture">future</a>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><span title="org.jboss.netty.channel.ChannelFutureListener.type">ChannelFutureListener</span>.<span title="org.jboss.netty.channel.ChannelFutureListener">CLOSE</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>

              <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#7577" title="unfiltered.request.GET.type">GET</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/methods.scala.html#34957" title="(req: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Option[unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage]]">unapply</a><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#59584" title="org.jboss.netty.channel.Channel">chan</a>.<span title="()Boolean">isOpen</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a> <span class="keyword">match</span> <span class="delimiter">{</span>
                  <span class="keyword">case</span> FileSystemResource<a href="#121937" title="Any" class="delimiter">(</a>_<span class="delimiter">)</span> =&gt;
                    <span class="keyword">val</span> <a title="java.io.RandomAccessFile" id="59775">raf</a> = <span title="java.io.RandomAccessFile" class="keyword">new</span> <span title="java.io.RandomAccessFile">RandomAccessFile</span><span class="delimiter">(</span><a href="#59044" title="unfiltered.netty.resources.Resource">rsrc</a>.<a href="resources/resolvers.scala.html#59075" title="=&gt; String">path</a>, <span title="String(&quot;r&quot;)" class="string">&quot;r&quot;</span><span class="delimiter">)</span>
                  <span title="Any" class="keyword">if</span><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a>.<a href="../../../unfiltered/unfiltered/unfiltered/request/HttpRequest.scala.html#12739" title="=&gt; Boolean">isSecure</a><span class="delimiter">)</span>
                    <a href="#59584" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><span title="(x$1: java.io.RandomAccessFile, x$2: Long, x$3: Long, x$4: Int)org.jboss.netty.handler.stream.ChunkedFile" class="keyword">new</span> <span title="org.jboss.netty.handler.stream.ChunkedFile">ChunkedFile</span><span class="delimiter">(</span>
                      <a href="#59775" title="java.io.RandomAccessFile">raf</a>, <span title="Long(0L)" class="int">0</span>, <a href="#59581" title="Long">len</a>, <span title="Int(8192)" class="int">8192</span>/*ChunkedStream.DEFAULT_CHUNK_SIZE*/<span class="delimiter">)</span><span class="delimiter">)</span>
                  <span class="keyword">else</span> <span class="delimiter">{</span>
                    // using zero-copy
                    <span class="keyword">val</span> <a title="org.jboss.netty.channel.DefaultFileRegion" id="59936">region</a> =
                      <span title="org.jboss.netty.channel.DefaultFileRegion" class="keyword">new</span> <span title="org.jboss.netty.channel.DefaultFileRegion">DefaultFileRegion</span><span class="delimiter">(</span><a href="#59775" title="java.io.RandomAccessFile">raf</a>.<span title="()java.nio.channels.FileChannel">getChannel</span>, <span title="Long(0L)" class="int">0</span>, <a href="#59581" title="Long">len</a><span class="delimiter">)</span>
                    <span class="keyword">val</span> <a title="org.jboss.netty.channel.ChannelFuture" id="59937">writeFile</a> = <a href="#59584" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><span class="delimiter">(</span><a href="#59936" title="org.jboss.netty.channel.DefaultFileRegion">region</a><span class="delimiter">)</span>
                    <a href="#59937" title="org.jboss.netty.channel.ChannelFuture">writeFile</a>.<span title="(x$1: org.jboss.netty.channel.ChannelFutureListener)Unit">addListener</span><span class="delimiter">(</span><a href="#60722" title="org.jboss.netty.channel.ChannelFutureListener" class="keyword">new</a> <a title="anonymous class $anon extends Object with org.jboss.netty.channel.ChannelFutureListener" id="60722">ChannelFutureListener</a> <span class="delimiter">{</span>
                      <span class="keyword">def</span> <a title="(f: org.jboss.netty.channel.ChannelFuture)Unit" id="60724">operationComplete</a><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="60726">f</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span><span class="delimiter">)</span> =
                        <a href="#59936" title="org.jboss.netty.channel.DefaultFileRegion">region</a>.<span title="()Unit">releaseExternalResources</span>
                    <span class="delimiter">}</span><span class="delimiter">)</span>
                    <a href="#59586" title="(future: org.jboss.netty.channel.ChannelFuture)Unit">lastly</a><span class="delimiter">(</span><a href="#59937" title="org.jboss.netty.channel.ChannelFuture">writeFile</a><span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                  <span class="keyword">case</span> other =&gt;
                    <a href="#59584" title="org.jboss.netty.channel.Channel">chan</a>.<span title="(x$1: Any)org.jboss.netty.channel.ChannelFuture">write</span><a href="#121941" title="(x: Any)Any" class="delimiter">(</a><span title="org.jboss.netty.handler.stream.ChunkedStream" class="keyword">new</span> <span title="org.jboss.netty.handler.stream.ChunkedStream">ChunkedStream</span><span class="delimiter">(</span><a href="#121937" title="unfiltered.netty.resources.Resource">other</a>.<a href="resources/resolvers.scala.html#59078" title="=&gt; java.io.InputStream">in</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span> <span class="keyword">else</span> <a href="#59586" title="(future: org.jboss.netty.channel.ChannelFuture)Unit">lastly</a><span class="delimiter">(</span><a href="#59585" title="org.jboss.netty.channel.ChannelFuture">writeHeaders</a><span class="delimiter">)</span>
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
              <span class="keyword">case</span> <a title="Any" id="60747">e</a>: <span title="java.io.FileNotFoundException">FileNotFoundException</span> =&gt; <a href="#58536" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">notFound</a><span class="delimiter">(</span><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> _ =&gt; <a href="#58535" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">forbid</a><a href="#121957" title="(x: Any)Any" class="delimiter">(</a><a href="#59017" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">case</span> req =&gt; <a href="#58537" title="(v1: unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage])Any">badRequest</a><a href="#121969" title="(x: B1)B1" class="delimiter">(</a><a href="#121962" title="Async extends unfiltered.request.HttpRequest[unfiltered.netty.ReceivedMessage] with unfiltered.Async.Responder[org.jboss.netty.handler.codec.http.HttpResponse]">req</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  /** Converts a raw uri to a safe resource path. Attempts to prevent
   *  security holes where resources are accessed with .. paths
   *  potentially outside of the root of the web app
   */
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(uri: String)Option[unfiltered.netty.resources.Resource]" id="58539">safe</a><span class="delimiter">(</span><a title="String" id="59018">uri</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Option[unfiltered.netty.resources.Resource]">Option</span><span class="delimiter">[</span>Resource<span class="delimiter">]</span> =
    <a href="#58540" title="(uri: String)Option[String]">decode</a><span class="delimiter">(</span><a href="#59018" title="String">uri</a><span class="delimiter">)</span> <span title="(f: String =&gt; Option[unfiltered.netty.resources.Resource])Option[unfiltered.netty.resources.Resource]">flatMap</span> <span class="delimiter">{</span> <a title="String" id="60865">decoded</a> =&gt;
      <a href="#60865" title="String">decoded</a>.<span title="(x$1: Char, x$2: Char)String">replace</span><a href="#122000" title="Option[unfiltered.netty.resources.Resource]" class="delimiter">(</a><span title="Char('/')" class="char">'/'</span>, <span title="java.io.File.type">File</span>.<span title="Char">separatorChar</span><span class="delimiter">)</span> <span class="keyword">match</span> <span class="delimiter">{</span>
        <span class="keyword">case</span> p
          <span class="keyword">if</span><span class="delimiter">(</span><a href="#121995" title="String">p</a>.<span title="(x$1: CharSequence)Boolean">contains</span><span class="delimiter">(</span><span title="java.io.File.type">File</span>.<span title="String">separator</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
             <a href="#121995" title="String">p</a>.<span title="(x$1: CharSequence)Boolean">contains</span><span class="delimiter">(</span><span title="String(&quot;.&quot;)" class="string">&quot;.&quot;</span> <span title="(x$1: Any)String">+</span> <span title="java.io.File.type">File</span>.<span title="String">separator</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
             <a href="#121995" title="String">p</a>.<span title="(x$1: String)Boolean">startsWith</span><span class="delimiter">(</span><span title="String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span>
             <a href="#121995" title="String">p</a>.<span title="(x$1: String)Boolean">endsWith</span><span class="delimiter">(</span><span title="String(&quot;.&quot;)" class="string">&quot;.&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <a href="#121997" title="(x: Option[unfiltered.netty.resources.Resource])Option[unfiltered.netty.resources.Resource]">None</a>
        <span class="keyword">case</span> path =&gt;
          <a href="resources/resolvers.scala.html#60884" title="(url: java.net.URL, resolver: unfiltered.netty.resources.Resolve.Resolver)Option[unfiltered.netty.resources.Resource]">Resolve</a><a href="#121997" title="(x: Option[unfiltered.netty.resources.Resource])Option[unfiltered.netty.resources.Resource]" class="delimiter">(</a><span title="(x$1: java.net.URL, x$2: String)java.net.URL" class="keyword">new</span> <span title="java.net.URL">URL</span><span class="delimiter">(</span><a href="#60942" title="=&gt; java.net.URL">base</a>, <a href="#60865" title="String">decoded</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

   <span class="keyword">private</span> <span class="keyword">def</span> <a title="(uri: String)Option[String]" id="58540">decode</a><span class="delimiter">(</span><a title="String" id="60825">uri</a>: <span title="String">String</span><span class="delimiter">)</span> =
     <span class="delimiter">(</span><span title="util.control.Exception.Catch[Nothing]">allCatch</span>.<span title="(body: =&gt; String)Option[String]">opt</span> <span class="delimiter">{</span> <span title="java.net.URLDecoder.type">URLDecoder</span>.<span title="(x$1: String, x$2: String)String">decode</span><span class="delimiter">(</span><a href="#60825" title="String">uri</a>, <a href="#58459" title="=&gt; java.nio.charset.Charset">utf8</a>.<span title="()String">name</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span title="(alternative: =&gt; Option[String])Option[String]">orElse</span> <span class="delimiter">{</span>
        <span title="util.control.Exception.Catch[Nothing]">allCatch</span>.<span title="(body: =&gt; String)Option[String]">opt</span> <span class="delimiter">{</span> <span title="java.net.URLDecoder.type">URLDecoder</span>.<span title="(x$1: String, x$2: String)String">decode</span><span class="delimiter">(</span><a href="#60825" title="String">uri</a>, <a href="#58461" title="=&gt; java.nio.charset.Charset">iso88591</a>.<span title="()String">name</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>