<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>play/play/api/libs/Crypto.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright (C) 2009-2013 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>
<span class="keyword">package</span> play.api.libs

<span class="keyword">import</span> javax.crypto._
<span class="keyword">import</span> javax.crypto.spec.SecretKeySpec

<span class="keyword">import</span> play.api.<span class="delimiter">{</span> Mode, Play, PlayException <span class="delimiter">}</span>
<span class="keyword">import</span> java.security.SecureRandom
<span class="keyword">import</span> org.apache.commons.codec.binary.Hex
<span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils

<span class="comment">/**
 * Cryptographic utilities.
 *
 * These utilities are intended as a convenience, however it is important to read each methods documentation and
 * understand the concepts behind encryption to use this class properly.  Safe encryption is hard, and there is no
 * substitute for an adequate understanding of cryptography.  These methods will not be suitable for all encryption
 * needs.
 *
 * For more information about cryptography, we recommend reading the OWASP Cryptographic Storage Cheatsheet:
 *
 * https://www.owasp.org/index.php/Cryptographic_Storage_Cheat_Sheet
 */</span>
<span class="keyword">object</span> <a title="play.api.libs.Crypto.type" id="play.api.libs.Crypto">Crypto</a> <a href="#play.api.libs.Crypto" title="play.api.libs.Crypto.type" class="delimiter">{</a>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(key: String)Option[String]" id="play.api.libs.Crypto.getConfig">getConfig</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.getConfig.key">key</a>: <span title="String">String</span><span class="delimiter">)</span> = <a href="../Play.scala.html#play.api.Play" title="play.api.Play.type">Play</a>.<a href="../Play.scala.html#play.api.Play.maybeApplication" title="=&gt; Option[play.api.Application]">maybeApplication</a>.<span title="(f: play.api.Application =&gt; Option[String])Option[String]">flatMap</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.getConfig.$anonfun.x$1" title="play.api.Application">_</a>.<a href="../Application.scala.html#play.api;Application.configuration" title="play.api.Configuration" id="play.api.libs.Crypto.getConfig.$anonfun.qual$1">configuration</a>.<a href="../Configuration.scala.html#play.api;Configuration.getString$default$2" title="Option[Set[String]] @scala.reflect.internal.annotations.uncheckedBounds" id="play.api.libs.Crypto.getConfig.$anonfun.x$3">getString</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.getConfig.key" title="String" id="play.api.libs.Crypto.getConfig.$anonfun.x$2">key</a><span class="delimiter">)</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="scala.util.matching.Regex" id="play.api.libs.Crypto.Blank">Blank</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;&quot;&quot;\s*&quot;&quot;&quot;</span>.<span title="=&gt; scala.util.matching.Regex">r</span>

  <span class="keyword">private</span><span class="delimiter">[</span>play<span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; String" id="play.api.libs.Crypto.secret">secret</a>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="comment">/*
     * The Play secret.
     *
     * We want to:
     *
     * 1) Encourage the practice of *not* using the same secret in dev and prod.
     * 2) Make it obvious that the secret should be changed.
     * 3) Ensure that in dev mode, the secret stays stable across restarts.
     * 4) Ensure that in dev mode, sessions do not interfere with other applications that may be or have been running
     *   on localhost.  Eg, if I start Play app 1, and it stores a PLAY_SESSION cookie for localhost:9000, then I stop
     *   it, and start Play app 2, when it reads the PLAY_SESSION cookie for localhost:9000, it should not see the
     *   session set by Play app 1.  This can be achieved by using different secrets for the two, since if they are
     *   different, they will simply ignore the session cookie set by the other.
     *
     * To achieve 1 and 2, we will, in Activator templates, set the default secret to be &quot;changeme&quot;.  This should make
     * it obvious that the secret needs to be changed and discourage using the same secret in dev and prod.
     *
     * For safety, if the secret is not set, or if it's changeme, and we are in prod mode, then we will fail fatally.
     * This will further enforce both 1 and 2.
     *
     * To achieve 3, if in dev or test mode, if the secret is either changeme or not set, we will generate a secret
     * based on the location of application.conf.  This should be stable across restarts for a given application.
     *
     * To achieve 4, using the location of application.conf to generate the secret should ensure this.
     */</span>

    <span class="keyword">val</span> <a title="play.api.Application" id="play.api.libs.Crypto.secret.app">app</a> = <a href="../Play.scala.html#play.api.Play" title="play.api.Play.type">Play</a>.<a href="../Play.scala.html#play.api.Play.current" title="=&gt; play.api.Application">current</a>

    <a href="#play.api.libs.Crypto.secret.app" title="play.api.Application">app</a>.<a href="../Application.scala.html#play.api;Application.configuration" title="play.api.Configuration" id="play.api.libs.Crypto.secret.qual$2">configuration</a>.<a href="../Configuration.scala.html#play.api;Configuration.getString$default$2" title="Option[Set[String]] @scala.reflect.internal.annotations.uncheckedBounds" id="play.api.libs.Crypto.secret.x$5">getString</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.secret.x$4" class="string">&quot;application.secret&quot;</a><span class="delimiter">)</span> <span title="String" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span class="delimiter">(</span>Some<span class="delimiter">(</span><span title="String(&quot;changeme&quot;)" class="string">&quot;changeme&quot;</span><span class="delimiter">)</span> | Some<span class="delimiter">(</span><a href="#play.api.libs.Crypto.Blank" title="(target: Any)Option[List[String]]">Blank</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> | <span title="None.type">None</span><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#play.api.libs.Crypto.secret.app" title="play.api.Application">app</a>.<a href="../Application.scala.html#play.api;Application.mode" title="=&gt; play.api.Mode.Mode">mode</a> <span title="(x$1: AnyRef)Boolean">==</span> <a href="../Play.scala.html#play.api.Mode" title="play.api.Mode.type">Mode</a>.<a href="../Play.scala.html#play.api.Mode.Prod" title="=&gt; play.api.Mode.Value">Prod</a> =&gt;
        <a href="../Play.scala.html#play.api.Play" title="play.api.Play.type">Play</a>.<a href="../Play.scala.html#play.api.Play.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../Logger.scala.html#play.api;LoggerLike.error(83d3728a3c)" title="(message: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;The application secret has not been set, and we are in prod mode. Your application is not secure.&quot;)" class="string">&quot;The application secret has not been set, and we are in prod mode. Your application is not secure.&quot;</span><span class="delimiter">)</span>
        <a href="../Play.scala.html#play.api.Play" title="play.api.Play.type">Play</a>.<a href="../Play.scala.html#play.api.Play.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../Logger.scala.html#play.api;LoggerLike.error(83d3728a3c)" title="(message: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;To set the application secret, please read http://playframework.com/documentation/latest/ApplicationSecret&quot;)" class="string">&quot;To set the application secret, please read http://playframework.com/documentation/latest/ApplicationSecret&quot;</span><span class="delimiter">)</span>
        <span title="Nothing" class="keyword">throw</span> <a href="../../../../play-exceptions/play/api/PlayException.java.html#play.api;PlayException.<init>(50cc897f6f)" title="(title: String, description: String)play.api.PlayException" class="keyword">new</a> <a href="../../../../play-exceptions/play/api/PlayException.java.html#play.api;PlayException" title="play.api.PlayException">PlayException</a><span class="delimiter">(</span><span title="String(&quot;Configuration error&quot;)" class="string">&quot;Configuration error&quot;</span>, <span title="String(&quot;Application secret not set&quot;)" class="string">&quot;Application secret not set&quot;</span><span class="delimiter">)</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><span title="String(&quot;changeme&quot;)" class="string">&quot;changeme&quot;</span><span class="delimiter">)</span> | Some<span class="delimiter">(</span><a href="#play.api.libs.Crypto.Blank" title="(target: Any)Option[List[String]]">Blank</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> | <span title="None.type">None</span> =&gt;
        <span class="comment">// Try to generate a stable secret. Security is not the issue here, since this is just for tests and dev mode.</span>
        <span class="keyword">val</span> <a title="java.net.URL" id="play.api.libs.Crypto.secret.applicationConfLocation">applicationConfLocation</a> = <a href="#play.api.libs.Crypto.secret.app" title="play.api.Application">app</a>.<a href="../Application.scala.html#play.api;Application.classloader" title="=&gt; ClassLoader">classloader</a>.<span title="(x$1: String)java.net.URL">getResource</span><span class="delimiter">(</span><span title="String(&quot;application.conf&quot;)" class="string">&quot;application.conf&quot;</span><span class="delimiter">)</span>
        <span class="keyword">val</span> <a title="String" id="play.api.libs.Crypto.secret.secret">secret</a> = <span title="String" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.api.libs.Crypto.secret.applicationConfLocation" title="java.net.URL">applicationConfLocation</a> <span title="(x$1: AnyRef)Boolean">==</span> <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// No application.conf?  Oh well, just use something hard coded.</span>
          <span title="String(&quot;she sells sea shells on the sea shore&quot;)" class="string">&quot;she sells sea shells on the sea shore&quot;</span>
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
          <a href="#play.api.libs.Crypto.secret.applicationConfLocation" title="java.net.URL">applicationConfLocation</a>.<span title="()String">toString</span>
        <span class="delimiter">}</span>
        <span class="keyword">val</span> <a title="String" id="play.api.libs.Crypto.secret.md5Secret">md5Secret</a> = <span title="org.apache.commons.codec.digest.DigestUtils.type">DigestUtils</span>.<span title="(x$1: String)String">md5Hex</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.secret.secret" title="String">secret</a><span class="delimiter">)</span>
        <a href="../Play.scala.html#play.api.Play" title="play.api.Play.type">Play</a>.<a href="../Play.scala.html#play.api.Play.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../Logger.scala.html#play.api;LoggerLike.debug(83d3728a3c)" title="(message: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Generated dev mode secret &quot;)">Generated dev mode secret $</span><span class="delimiter">{</span><a href="#play.api.libs.Crypto.secret.md5Secret" title="String">md5Secret</a><span class="delimiter">}</span><span title="String(&quot; for app at &quot;)"> for app at $</span><span class="delimiter">{</span><span title="(x: java.net.URL)Option[java.net.URL]">Option</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.secret.applicationConfLocation" title="java.net.URL">applicationConfLocation</a><span class="delimiter">)</span>.<span title="(default: =&gt; java.io.Serializable)java.io.Serializable">getOrElse</span><span class="delimiter">(</span><span title="String(&quot;unknown location&quot;)" class="string">&quot;unknown location&quot;</span><span class="delimiter">)</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
        <a href="#play.api.libs.Crypto.secret.md5Secret" title="String">md5Secret</a>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.secret.s">s</a><span class="delimiter">)</span> =&gt; <a href="#play.api.libs.Crypto.secret.s" title="String">s</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="Option[String]" id="play.api.libs.Crypto.provider">provider</a>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <a href="#play.api.libs.Crypto.getConfig" title="(key: String)Option[String]">getConfig</a><span class="delimiter">(</span><span title="String(&quot;application.crypto.provider&quot;)" class="string">&quot;application.crypto.provider&quot;</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">lazy</span> <span class="keyword">val</span> <a title="String" id="play.api.libs.Crypto.transformation">transformation</a>: <span title="String">String</span> = <a href="#play.api.libs.Crypto.getConfig" title="(key: String)Option[String]">getConfig</a><span class="delimiter">(</span><span title="String(&quot;application.crypto.aes.transformation&quot;)" class="string">&quot;application.crypto.aes.transformation&quot;</span><span class="delimiter">)</span>.<span title="(default: =&gt; String)String">getOrElse</span><span class="delimiter">(</span><span title="String(&quot;AES&quot;)" class="string">&quot;AES&quot;</span><span class="delimiter">)</span>

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="java.security.SecureRandom" id="play.api.libs.Crypto.random">random</a> = <span title="java.security.SecureRandom" class="keyword">new</span> <span title="java.security.SecureRandom">SecureRandom</span><span class="delimiter">(</span><span class="delimiter">)</span>

  <span class="comment">/**
   * Signs the given String with HMAC-SHA1 using the given key.
   *
   * By default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * @param message The message to sign.
   * @param key The private key to sign with.
   * @return A hexadecimal encoded signature.
   */</span>
  <span class="keyword">def</span> <a title="(message: String, key: Array[Byte])String" id="play.api.libs.Crypto.sign(3269fa4337)">sign</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.sign(3269fa4337).message">message</a>: <span title="String">String</span>, <a title="Array[Byte]" id="play.api.libs.Crypto.sign(3269fa4337).key">key</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="javax.crypto.Mac" id="play.api.libs.Crypto.sign(3269fa4337).mac">mac</a> = <a href="#play.api.libs.Crypto.provider" title="=&gt; Option[String]">provider</a>.<span title="(f: String =&gt; javax.crypto.Mac)Option[javax.crypto.Mac]">map</span><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.sign(3269fa4337).mac.$anonfun.p">p</a> =&gt; <span title="javax.crypto.Mac.type">Mac</span>.<span title="(x$1: String, x$2: String)javax.crypto.Mac">getInstance</span><span class="delimiter">(</span><span title="String(&quot;HmacSHA1&quot;)" class="string">&quot;HmacSHA1&quot;</span>, <a href="#play.api.libs.Crypto.sign(3269fa4337).mac.$anonfun.p" title="String">p</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; javax.crypto.Mac)javax.crypto.Mac">getOrElse</span><span class="delimiter">(</span><span title="javax.crypto.Mac.type">Mac</span>.<span title="(x$1: String)javax.crypto.Mac">getInstance</span><span class="delimiter">(</span><span title="String(&quot;HmacSHA1&quot;)" class="string">&quot;HmacSHA1&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#play.api.libs.Crypto.sign(3269fa4337).mac" title="javax.crypto.Mac">mac</a>.<span title="(x$1: java.security.Key)Unit">init</span><span class="delimiter">(</span><span title="javax.crypto.spec.SecretKeySpec" class="keyword">new</span> <span title="javax.crypto.spec.SecretKeySpec">SecretKeySpec</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.sign(3269fa4337).key" title="Array[Byte]">key</a>, <span title="String(&quot;HmacSHA1&quot;)" class="string">&quot;HmacSHA1&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="Codecs.scala.html#play.api.libs.Codecs" title="play.api.libs.Codecs.type">Codecs</a>.<a href="Codecs.scala.html#play.api.libs.Codecs.toHexString" title="(array: Array[Byte])String">toHexString</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.sign(3269fa4337).mac" title="javax.crypto.Mac">mac</a>.<span title="(x$1: Array[Byte])Array[Byte]">doFinal</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.sign(3269fa4337).message" title="String">message</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;utf-8&quot;)" class="string">&quot;utf-8&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Signs the given String with HMAC-SHA1 using the application’s secret key.
   *
   * By default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * @param message The message to sign.
   * @return A hexadecimal encoded signature.
   */</span>
  <span class="keyword">def</span> <a title="(message: String)String" id="play.api.libs.Crypto.sign(f8bc075f91)">sign</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.sign(f8bc075f91).message">message</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <a href="#play.api.libs.Crypto.sign(3269fa4337)" title="(message: String, key: Array[Byte])String">sign</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.sign(f8bc075f91).message" title="String">message</a>, <a href="#play.api.libs.Crypto.secret" title="=&gt; String">secret</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;utf-8&quot;)" class="string">&quot;utf-8&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Sign a token.  This produces a new token, that has this token signed with a nonce.
   *
   * This primarily exists to defeat the BREACH vulnerability, as it allows the token to effectively be random per
   * request, without actually changing the value.
   *
   * @param token The token to sign
   * @return The signed token
   */</span>
  <span class="keyword">def</span> <a title="(token: String)String" id="play.api.libs.Crypto.signToken">signToken</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.signToken.token">token</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="play.api.libs.Crypto.signToken.nonce">nonce</a> = <span title="System.type">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="String" id="play.api.libs.Crypto.signToken.joined">joined</a> = <a href="#play.api.libs.Crypto.signToken.nonce" title="Long">nonce</a> <span title="(x: String)String">+</span> <span title="String(&quot;-&quot;)" class="string">&quot;-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#play.api.libs.Crypto.signToken.token" title="String">token</a>
    <a href="#play.api.libs.Crypto.sign(f8bc075f91)" title="(message: String)String">sign</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.signToken.joined" title="String">joined</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;-&quot;)" class="string">&quot;-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#play.api.libs.Crypto.signToken.joined" title="String">joined</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Extract a signed token that was signed by [[play.api.libs.Crypto.signToken]].
   *
   * @param token The signed token to extract.
   * @return The verified raw token, or None if the token isn't valid.
   */</span>
  <span class="keyword">def</span> <a title="(token: String)Option[String]" id="play.api.libs.Crypto.extractSignedToken">extractSignedToken</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.extractSignedToken.token">token</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Option[String]">Option</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#play.api.libs.Crypto.extractSignedToken.token" title="String">token</a>.<span title="(x$1: String, x$2: Int)Array[String]">split</span><span class="delimiter">(</span><span title="String(&quot;-&quot;)" class="string">&quot;-&quot;</span>, <span title="Int(3)" class="int">3</span><span class="delimiter">)</span> <span title="Option[String]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="#play.api.libs.Crypto.extractSignedToken.<unapply-selector>" title="(x: Array[String])Option[IndexedSeq[String]]">Array</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.extractSignedToken.signature">signature</a>, <a title="String" id="play.api.libs.Crypto.extractSignedToken.nonce">nonce</a>, <a title="String" id="play.api.libs.Crypto.extractSignedToken.raw">raw</a><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#play.api.libs.Crypto.constantTimeEquals" title="(a: String, b: String)Boolean">constantTimeEquals</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.extractSignedToken.signature" title="String">signature</a>, <a href="#play.api.libs.Crypto.sign(f8bc075f91)" title="(message: String)String">sign</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.extractSignedToken.nonce" title="String">nonce</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;-&quot;)" class="string">&quot;-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#play.api.libs.Crypto.extractSignedToken.raw" title="String">raw</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt; <span title="(x: String)Some[String]">Some</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.extractSignedToken.raw" title="String">raw</a><span class="delimiter">)</span>
      <span class="keyword">case</span> _ =&gt; <span title="None.type">None</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Generate a cryptographically secure token
   */</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="play.api.libs.Crypto.generateToken">generateToken</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[Byte]" id="play.api.libs.Crypto.generateToken.bytes">bytes</a> = <span title="Array[Byte]" class="keyword">new</span> <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">(</span><span title="Int(12)" class="int">12</span><span class="delimiter">)</span>
    <a href="#play.api.libs.Crypto.random" title="=&gt; java.security.SecureRandom">random</a>.<span title="(x$1: Array[Byte])Unit">nextBytes</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.generateToken.bytes" title="Array[Byte]">bytes</a><span class="delimiter">)</span>
    <span title="(x$1: Array[Char])String" class="keyword">new</span> <span title="String">String</span><span class="delimiter">(</span><span title="org.apache.commons.codec.binary.Hex.type">Hex</span>.<span title="(x$1: Array[Byte])Array[Char]">encodeHex</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.generateToken.bytes" title="Array[Byte]">bytes</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Generate a signed token
   */</span>
  <span class="keyword">def</span> <a title="=&gt; String" id="play.api.libs.Crypto.generateSignedToken">generateSignedToken</a> = <a href="#play.api.libs.Crypto.signToken" title="(token: String)String">signToken</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.generateToken" title="=&gt; String">generateToken</a><span class="delimiter">)</span>

  <span class="comment">/**
   * Compare two signed tokens
   */</span>
  <span class="keyword">def</span> <a title="(tokenA: String, tokenB: String)Boolean" id="play.api.libs.Crypto.compareSignedTokens">compareSignedTokens</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.compareSignedTokens.tokenA">tokenA</a>: <span title="String">String</span>, <a title="String" id="play.api.libs.Crypto.compareSignedTokens.tokenB">tokenB</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="delimiter">(</span><span class="keyword">for</span> <span class="delimiter">{</span>
      <a title="String" id="play.api.libs.Crypto.compareSignedTokens.$anonfun.rawA">rawA</a> &lt;- <a href="#play.api.libs.Crypto.extractSignedToken" title="(token: String)Option[String]">extractSignedToken</a><span title="(f: String =&gt; Option[Boolean])Option[Boolean]" class="delimiter">(</span><a href="#play.api.libs.Crypto.compareSignedTokens.tokenA" title="String">tokenA</a><span class="delimiter">)</span>
      <a title="String" id="play.api.libs.Crypto.compareSignedTokens.$anonfun.$anonfun.rawB">rawB</a> &lt;- <a href="#play.api.libs.Crypto.extractSignedToken" title="(token: String)Option[String]">extractSignedToken</a><span title="(f: String =&gt; Boolean)Option[Boolean]" class="delimiter">(</span><a href="#play.api.libs.Crypto.compareSignedTokens.tokenB" title="String">tokenB</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">yield</span> <a href="#play.api.libs.Crypto.constantTimeEquals" title="(a: String, b: String)Boolean">constantTimeEquals</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.compareSignedTokens.$anonfun.rawA" title="String">rawA</a>, <a href="#play.api.libs.Crypto.compareSignedTokens.$anonfun.$anonfun.rawB" title="String">rawB</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; Boolean)Boolean">getOrElse</span><span class="delimiter">(</span><span title="Boolean(false)" class="keyword">false</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Constant time equals method.
   *
   * Given a length that both Strings are equal to, this method will always run in constant time.  This prevents
   * timing attacks.
   */</span>
  <span class="keyword">def</span> <a title="(a: String, b: String)Boolean" id="play.api.libs.Crypto.constantTimeEquals">constantTimeEquals</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.constantTimeEquals.a">a</a>: <span title="String">String</span>, <a title="String" id="play.api.libs.Crypto.constantTimeEquals.b">b</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span title="Boolean" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.api.libs.Crypto.constantTimeEquals.a" title="String">a</a>.<span title="()Int">length</span> <span title="(x: Int)Boolean">!=</span> <a href="#play.api.libs.Crypto.constantTimeEquals.b" title="String">b</a>.<span title="()Int">length</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span title="Boolean(false)" class="keyword">false</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <span class="keyword">var</span> <a title="Int" id="play.api.libs.Crypto.constantTimeEquals.equal">equal</a> = <span title="Int(0)" class="int">0</span>
      <span class="keyword">for</span> <span class="delimiter">(</span><a title="Int" id="play.api.libs.Crypto.constantTimeEquals.$anonfun.i">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">0</span> <span title="(f: Int =&gt; Unit)Unit">until</span> <a href="#play.api.libs.Crypto.constantTimeEquals.a" title="String">a</a>.<span title="()Int">length</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#play.api.libs.Crypto.constantTimeEquals.equal" title="Int">equal</a> <span title="(x: Int)Int">|=</span> <a href="#play.api.libs.Crypto.constantTimeEquals.a" title="(index: Int)Char">a</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.constantTimeEquals.$anonfun.i" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Char)Int">^</span> <a href="#play.api.libs.Crypto.constantTimeEquals.b" title="(index: Int)Char">b</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.constantTimeEquals.$anonfun.i" title="Int">i</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#play.api.libs.Crypto.constantTimeEquals.equal" title="Int">equal</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Encrypt a String with the AES encryption standard using the application's secret key.
   *
   * The provider used is by default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * The transformation algorithm used is the provider specific implementation of the `AES` name.  On Oracles JDK,
   * this is `AES/ECB/PKCS5Padding`.  This algorithm is suitable for small amounts of data, typically less than 32
   * bytes, hence is useful for encrypting credit card numbers, passwords etc.  For larger blocks of data, this
   * algorithm may expose patterns and be vulnerable to repeat attacks.
   *
   * The transformation algorithm can be configured by defining `application.crypto.aes.transformation` in
   * `application.conf`.  Although any cipher transformation algorithm can be selected here, the secret key spec used
   * is always AES, so only AES transformation algorithms will work.
   *
   * @param value The String to encrypt.
   * @return An hexadecimal encrypted string.
   */</span>
  <span class="keyword">def</span> <a title="(value: String)String" id="play.api.libs.Crypto.encryptAES(f2cb52bdd4)">encryptAES</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.encryptAES(f2cb52bdd4).value">value</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <a href="#play.api.libs.Crypto.encryptAES(e458a6e733)" title="(value: String, privateKey: String)String">encryptAES</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.encryptAES(f2cb52bdd4).value" title="String">value</a>, <a href="#play.api.libs.Crypto.secret" title="=&gt; String">secret</a>.<span title="(x$1: Int, x$2: Int)String">substring</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Int(16)" class="int">16</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Encrypt a String with the AES encryption standard and the supplied private key.
   *
   * The private key must have a length of 16 bytes.
   *
   * The provider used is by default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * The transformation algorithm used is the provider specific implementation of the `AES` name.  On Oracles JDK,
   * this is `AES/ECB/PKCS5Padding`.  This algorithm is suitable for small amounts of data, typically less than 32
   * bytes, hence is useful for encrypting credit card numbers, passwords etc.  For larger blocks of data, this
   * algorithm may expose patterns and be vulnerable to repeat attacks.
   *
   * The transformation algorithm can be configured by defining `application.crypto.aes.transformation` in
   * `application.conf`.  Although any cipher transformation algorithm can be selected here, the secret key spec used
   * is always AES, so only AES transformation algorithms will work.
   *
   * @param value The String to encrypt.
   * @param privateKey The key used to encrypt.
   * @return An hexadecimal encrypted string.
   */</span>
  <span class="keyword">def</span> <a title="(value: String, privateKey: String)String" id="play.api.libs.Crypto.encryptAES(e458a6e733)">encryptAES</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.encryptAES(e458a6e733).value">value</a>: <span title="String">String</span>, <a title="String" id="play.api.libs.Crypto.encryptAES(e458a6e733).privateKey">privateKey</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[Byte]" id="play.api.libs.Crypto.encryptAES(e458a6e733).raw">raw</a> = <a href="#play.api.libs.Crypto.encryptAES(e458a6e733).privateKey" title="String">privateKey</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;utf-8&quot;)" class="string">&quot;utf-8&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="javax.crypto.spec.SecretKeySpec" id="play.api.libs.Crypto.encryptAES(e458a6e733).skeySpec">skeySpec</a> = <span title="javax.crypto.spec.SecretKeySpec" class="keyword">new</span> <span title="javax.crypto.spec.SecretKeySpec">SecretKeySpec</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.encryptAES(e458a6e733).raw" title="Array[Byte]">raw</a>, <span title="String(&quot;AES&quot;)" class="string">&quot;AES&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="javax.crypto.Cipher" id="play.api.libs.Crypto.encryptAES(e458a6e733).cipher">cipher</a> = <a href="#play.api.libs.Crypto.provider" title="=&gt; Option[String]">provider</a>.<span title="(f: String =&gt; javax.crypto.Cipher)Option[javax.crypto.Cipher]">map</span><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.encryptAES(e458a6e733).cipher.$anonfun.p">p</a> =&gt; <span title="javax.crypto.Cipher.type">Cipher</span>.<span title="(x$1: String, x$2: String)javax.crypto.Cipher">getInstance</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.transformation" title="=&gt; String">transformation</a>, <a href="#play.api.libs.Crypto.encryptAES(e458a6e733).cipher.$anonfun.p" title="String">p</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; javax.crypto.Cipher)javax.crypto.Cipher">getOrElse</span><span class="delimiter">(</span><span title="javax.crypto.Cipher.type">Cipher</span>.<span title="(x$1: String)javax.crypto.Cipher">getInstance</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.transformation" title="=&gt; String">transformation</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#play.api.libs.Crypto.encryptAES(e458a6e733).cipher" title="javax.crypto.Cipher">cipher</a>.<span title="(x$1: Int, x$2: java.security.Key)Unit">init</span><span class="delimiter">(</span>Cipher.<span title="Int(1)">ENCRYPT_MODE</span>, <a href="#play.api.libs.Crypto.encryptAES(e458a6e733).skeySpec" title="javax.crypto.spec.SecretKeySpec">skeySpec</a><span class="delimiter">)</span>
    <a href="Codecs.scala.html#play.api.libs.Codecs" title="play.api.libs.Codecs.type">Codecs</a>.<a href="Codecs.scala.html#play.api.libs.Codecs.toHexString" title="(array: Array[Byte])String">toHexString</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.encryptAES(e458a6e733).cipher" title="javax.crypto.Cipher">cipher</a>.<span title="(x$1: Array[Byte])Array[Byte]">doFinal</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.encryptAES(e458a6e733).value" title="String">value</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;utf-8&quot;)" class="string">&quot;utf-8&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Decrypt a String with the AES encryption standard using the application's secret key.
   *
   * The provider used is by default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * The transformation used is by default `AES/ECB/PKCS5Padding`.  It can be configured by defining
   * `application.crypto.aes.transformation` in `application.conf`.  Although any cipher transformation algorithm can
   * be selected here, the secret key spec used is always AES, so only AES transformation algorithms will work.
   *
   * @param value An hexadecimal encrypted string.
   * @return The decrypted String.
   */</span>
  <span class="keyword">def</span> <a title="(value: String)String" id="play.api.libs.Crypto.decryptAES(f2cb52bdd4)">decryptAES</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.decryptAES(f2cb52bdd4).value">value</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <a href="#play.api.libs.Crypto.decryptAES(e458a6e733)" title="(value: String, privateKey: String)String">decryptAES</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.decryptAES(f2cb52bdd4).value" title="String">value</a>, <a href="#play.api.libs.Crypto.secret" title="=&gt; String">secret</a>.<span title="(x$1: Int, x$2: Int)String">substring</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span>, <span title="Int(16)" class="int">16</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Decrypt a String with the AES encryption standard.
   *
   * The private key must have a length of 16 bytes.
   *
   * The provider used is by default this uses the platform default JSSE provider.  This can be overridden by defining
   * `application.crypto.provider` in `application.conf`.
   *
   * The transformation used is by default `AES/ECB/PKCS5Padding`.  It can be configured by defining
   * `application.crypto.aes.transformation` in `application.conf`.  Although any cipher transformation algorithm can
   * be selected here, the secret key spec used is always AES, so only AES transformation algorithms will work.
   *
   * @param value An hexadecimal encrypted string.
   * @param privateKey The key used to encrypt.
   * @return The decrypted String.
   */</span>
  <span class="keyword">def</span> <a title="(value: String, privateKey: String)String" id="play.api.libs.Crypto.decryptAES(e458a6e733)">decryptAES</a><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.decryptAES(e458a6e733).value">value</a>: <span title="String">String</span>, <a title="String" id="play.api.libs.Crypto.decryptAES(e458a6e733).privateKey">privateKey</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Array[Byte]" id="play.api.libs.Crypto.decryptAES(e458a6e733).raw">raw</a> = <a href="#play.api.libs.Crypto.decryptAES(e458a6e733).privateKey" title="String">privateKey</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;utf-8&quot;)" class="string">&quot;utf-8&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="javax.crypto.spec.SecretKeySpec" id="play.api.libs.Crypto.decryptAES(e458a6e733).skeySpec">skeySpec</a> = <span title="javax.crypto.spec.SecretKeySpec" class="keyword">new</span> <span title="javax.crypto.spec.SecretKeySpec">SecretKeySpec</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.decryptAES(e458a6e733).raw" title="Array[Byte]">raw</a>, <span title="String(&quot;AES&quot;)" class="string">&quot;AES&quot;</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="javax.crypto.Cipher" id="play.api.libs.Crypto.decryptAES(e458a6e733).cipher">cipher</a> = <a href="#play.api.libs.Crypto.provider" title="=&gt; Option[String]">provider</a>.<span title="(f: String =&gt; javax.crypto.Cipher)Option[javax.crypto.Cipher]">map</span><span class="delimiter">(</span><a title="String" id="play.api.libs.Crypto.decryptAES(e458a6e733).cipher.$anonfun.p">p</a> =&gt; <span title="javax.crypto.Cipher.type">Cipher</span>.<span title="(x$1: String, x$2: String)javax.crypto.Cipher">getInstance</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.transformation" title="=&gt; String">transformation</a>, <a href="#play.api.libs.Crypto.decryptAES(e458a6e733).cipher.$anonfun.p" title="String">p</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(default: =&gt; javax.crypto.Cipher)javax.crypto.Cipher">getOrElse</span><span class="delimiter">(</span><span title="javax.crypto.Cipher.type">Cipher</span>.<span title="(x$1: String)javax.crypto.Cipher">getInstance</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.transformation" title="=&gt; String">transformation</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#play.api.libs.Crypto.decryptAES(e458a6e733).cipher" title="javax.crypto.Cipher">cipher</a>.<span title="(x$1: Int, x$2: java.security.Key)Unit">init</span><span class="delimiter">(</span>Cipher.<span title="Int(2)">DECRYPT_MODE</span>, <a href="#play.api.libs.Crypto.decryptAES(e458a6e733).skeySpec" title="javax.crypto.spec.SecretKeySpec">skeySpec</a><span class="delimiter">)</span>
    <span title="(x$1: Array[Byte])String" class="keyword">new</span> <span title="String">String</span><span class="delimiter">(</span><a href="#play.api.libs.Crypto.decryptAES(e458a6e733).cipher" title="javax.crypto.Cipher">cipher</a>.<span title="(x$1: Array[Byte])Array[Byte]">doFinal</span><span class="delimiter">(</span><a href="Codecs.scala.html#play.api.libs.Codecs" title="play.api.libs.Codecs.type">Codecs</a>.<a href="Codecs.scala.html#play.api.libs.Codecs.hexStringToByte" title="(hexString: String)Array[Byte]">hexStringToByte</a><span class="delimiter">(</span><a href="#play.api.libs.Crypto.decryptAES(e458a6e733).value" title="String">value</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
