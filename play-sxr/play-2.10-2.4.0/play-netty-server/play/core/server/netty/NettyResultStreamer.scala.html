<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>play-netty-server/play/core/server/netty/NettyResultStreamer.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/*
 * Copyright (C) 2009-2015 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>
<span class="keyword">package</span> play.core.server.netty

<span class="keyword">import</span> play.api.mvc._
<span class="keyword">import</span> play.api.libs.iteratee._
<span class="keyword">import</span> play.api._
<span class="keyword">import</span> play.core.server.common.ServerResultUtils
<span class="keyword">import</span> org.jboss.netty.handler.codec.http.<span title="org.jboss.netty.handler.codec.http.HttpHeaders.type">HttpHeaders</span>.<span title="org.jboss.netty.handler.codec.http.HttpHeaders.Names.type">Names</span>._
<span class="keyword">import</span> org.jboss.netty.buffer.ChannelBuffers
<span class="keyword">import</span> org.jboss.netty.channel._
<span class="keyword">import</span> org.jboss.netty.handler.codec.http._
<span class="keyword">import</span> org.jboss.netty.handler.codec.http.<span title="org.jboss.netty.handler.codec.http.HttpHeaders.type">HttpHeaders</span>.<span title="org.jboss.netty.handler.codec.http.HttpHeaders.Values.type">Values</span>._
<span class="keyword">import</span> com.typesafe.netty.http.pipelining.<span class="delimiter">{</span> OrderedDownstreamChannelEvent, OrderedUpstreamMessageEvent <span class="delimiter">}</span>
<span class="keyword">import</span> scala.concurrent.Future
<span class="keyword">import</span> scala.util.<span class="delimiter">{</span> Failure, Success <span class="delimiter">}</span>
<span class="keyword">import</span> scala.util.control.NonFatal

<span class="comment">/**
 * Streams Play results to Netty
 */</span>
<span class="keyword">object</span> <a title="play.core.server.netty.NettyResultStreamer.type" id="play.core.server.netty.NettyResultStreamer">NettyResultStreamer</a> <a href="#play.core.server.netty.NettyResultStreamer" title="play.core.server.netty.NettyResultStreamer.type" class="delimiter">{</a>

  <span class="keyword">import</span> <a href="NettyFuture.scala.html#play.core.server.netty.NettyFuture" title="play.core.server.netty.NettyFuture.type">NettyFuture</a>._

  <span class="keyword">private</span> <span class="keyword">val</span> <a title="play.api.Logger" id="play.core.server.netty.NettyResultStreamer.logger">logger</a> = <a href="../../../../../play/play/api/Logger.scala.html#play.api.Logger.apply(1f619881c1)" title="(clazz: Class[?0])play.api.Logger">Logger</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer" title="play.core.server.netty.NettyResultStreamer.type">NettyResultStreamer</a>.<span title="()Class[_]">getClass</span><span class="delimiter">)</span>

  <span class="comment">// A channel status holds whether the connection must be closed and the last subsequence sent</span>
  <span class="keyword">class</span> <a title="class ChannelStatus extends AnyRef" id="play.core.server.netty.NettyResultStreamer;ChannelStatus">ChannelStatus</a><a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus" class="delimiter">(</a><span class="keyword">val</span> <a title="Boolean" id="play.core.server.netty.NettyResultStreamer;ChannelStatus.closeConnection">closeConnection</a>: <span title="Boolean">Boolean</span>, <span class="keyword">val</span> <a title="Int" id="play.core.server.netty.NettyResultStreamer;ChannelStatus.lastSubsequence">lastSubsequence</a>: <span title="Int">Int</span><span class="delimiter">)</span>

  <span class="comment">// cache the date header of the last response so we only need to compute it every second</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">var</span> <a title="(Long, String)" id="play.core.server.netty.NettyResultStreamer.cachedDateHeader">cachedDateHeader</a>: <span title="(Long, String)" class="delimiter">(</span>Long, String<span class="delimiter">)</span> = <span title="(_1: Long, _2: Null)(Long, Null)" class="delimiter">(</span>Long.<span title="Long(-9223372036854775808L)">MinValue</span>, <span title="Null(null)" class="keyword">null</span><span class="delimiter">)</span>
  <span class="keyword">private</span><span class="delimiter">[</span><span class="keyword">this</span><span class="delimiter">]</span> <span class="keyword">def</span> <a title="=&gt; String" id="play.core.server.netty.NettyResultStreamer.dateHeader">dateHeader</a>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="Long" id="play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeMillis">currentTimeMillis</a> = <span title="System.type">System</span>.<span title="()Long">currentTimeMillis</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="Long" id="play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeSeconds">currentTimeSeconds</a> = <a href="#play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeMillis" title="Long">currentTimeMillis</a> <span title="(x: Int)Long">/</span> <span title="Int(1000)" class="int">1000</span>
    <a href="#play.core.server.netty.NettyResultStreamer.cachedDateHeader" title="(Long, String)">cachedDateHeader</a> <span title="String" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <span class="delimiter">(</span><a title="Long" id="play.core.server.netty.NettyResultStreamer.dateHeader.cachedSeconds">cachedSeconds</a>, <span title="String">dateHeaderString</span><span class="delimiter">)</span> <span class="keyword">if</span> <a href="#play.core.server.netty.NettyResultStreamer.dateHeader.cachedSeconds" title="Long">cachedSeconds</a> <span title="(x: Long)Boolean">==</span> <a href="#play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeSeconds" title="Long">currentTimeSeconds</a> =&gt;
        <span title="String">dateHeaderString</span>
      <span class="keyword">case</span> _ =&gt;
        <span class="keyword">val</span> <span title="String">dateHeaderString</span> = <a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc.ResponseHeader" title="play.api.mvc.ResponseHeader.type">ResponseHeader</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc.ResponseHeader.httpDateFormat" title="=&gt; org.joda.time.format.DateTimeFormatter">httpDateFormat</a>.<span title="(x$1: Long)String">print</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeMillis" title="Long">currentTimeMillis</a><span class="delimiter">)</span>
        <a href="#play.core.server.netty.NettyResultStreamer.cachedDateHeader" title="(Long, String)">cachedDateHeader</a> = <a href="#play.core.server.netty.NettyResultStreamer.dateHeader.currentTimeSeconds" title="(x: Long)ArrowAssoc[Long]">currentTimeSeconds</a> <span title="(y: String)(Long, String)">-&gt;</span> <span title="String">dateHeaderString</span>
        <span title="String">dateHeaderString</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send the result to netty
   *
   * @return A Future that will be redeemed when the result is completely sent
   */</span>
  <span class="keyword">def</span> <a title="(requestHeader: play.api.mvc.RequestHeader, result: play.api.mvc.Result, httpVersion: org.jboss.netty.handler.codec.http.HttpVersion, startSequence: Int)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)scala.concurrent.Future[_]" id="play.core.server.netty.NettyResultStreamer.sendResult">sendResult</a><span class="delimiter">(</span><a title="play.api.mvc.RequestHeader" id="play.core.server.netty.NettyResultStreamer.sendResult.requestHeader">requestHeader</a>: <a href="../../../../../play/play/api/mvc/Http.scala.html#play.api.mvc;RequestHeader" title="play.api.mvc.RequestHeader">RequestHeader</a>, <a title="play.api.mvc.Result" id="play.core.server.netty.NettyResultStreamer.sendResult.result">result</a>: <a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;Result" title="play.api.mvc.Result">Result</a>, <a title="org.jboss.netty.handler.codec.http.HttpVersion" id="play.core.server.netty.NettyResultStreamer.sendResult.httpVersion">httpVersion</a>: <span title="org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span>, <a title="Int" id="play.core.server.netty.NettyResultStreamer.sendResult.startSequence">startSequence</a>: <span title="Int">Int</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="org.jboss.netty.channel.ChannelHandlerContext" id="play.core.server.netty.NettyResultStreamer.sendResult.ctx">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent" id="play.core.server.netty.NettyResultStreamer.sendResult.oue">oue</a>: <span title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">OrderedUpstreamMessageEvent</span><span class="delimiter">)</span>: <span title="scala.concurrent.Future[_]">Future</span><span class="delimiter">[</span>_<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="keyword">import</span> play.api.libs.iteratee.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution" title="play.api.libs.iteratee.Execution.type">Execution</a>.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution.Implicits" title="play.api.libs.iteratee.Execution.Implicits.type">Implicits</a>.trampoline

    <span class="comment">// Break out sending logic because when the first result is invalid we may</span>
    <span class="comment">// need to call send again with an error result.</span>
    <span class="keyword">def</span> <a title="(result: play.api.mvc.Result)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.sendResult.send">send</a><span class="delimiter">(</span><a title="play.api.mvc.Result" id="play.core.server.netty.NettyResultStreamer.sendResult.send.result">result</a>: <a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;Result" title="play.api.mvc.Result">Result</a><span class="delimiter">)</span>: <span title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">Future</span><span class="delimiter">[</span>ChannelStatus<span class="delimiter">]</span> = <span class="delimiter">{</span>
      <span class="comment">// Result of this iteratee is a completion status</span>
      <span class="keyword">val</span> <a title="scala.concurrent.Future[Either[play.core.server.common.ServerResultUtils.InvalidResult,(play.core.server.common.ServerResultUtils.ResultStreaming, play.core.server.common.ServerResultUtils.ConnectionHeader)]]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.resultStreaming">resultStreaming</a> = <a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils" title="play.core.server.common.ServerResultUtils.type">ServerResultUtils</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils.determineResultStreaming" title="(requestHeader: play.api.mvc.RequestHeader, result: play.api.mvc.Result)scala.concurrent.Future[Either[play.core.server.common.ServerResultUtils.InvalidResult,(play.core.server.common.ServerResultUtils.ResultStreaming, play.core.server.common.ServerResultUtils.ConnectionHeader)]]">determineResultStreaming</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.requestHeader" title="play.api.mvc.RequestHeader">requestHeader</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.result" title="play.api.mvc.Result">result</a><span class="delimiter">)</span>
      <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.resultStreaming" title="scala.concurrent.Future[Either[play.core.server.common.ServerResultUtils.InvalidResult,(play.core.server.common.ServerResultUtils.ResultStreaming, play.core.server.common.ServerResultUtils.ConnectionHeader)]]">resultStreaming</a>.<span title="(f: Either[play.core.server.common.ServerResultUtils.InvalidResult,(play.core.server.common.ServerResultUtils.ResultStreaming, play.core.server.common.ServerResultUtils.ConnectionHeader)] =&gt; scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">flatMap</span> <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.x0$1" title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" class="delimiter">{</a>
        <span class="keyword">case</span> Left<span class="delimiter">(</span>ServerResultUtils.InvalidResult<span class="delimiter">(</span><a title="String" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.reason">reason</a>, <a title="play.api.mvc.Result" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.alternativeResult">alternativeResult</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
          <a href="#play.core.server.netty.NettyResultStreamer.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../../../../../play/play/api/Logger.scala.html#play.api;LoggerLike.warn(83d3728a3c)" title="(message: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Cannot send result, sending error result instead: &quot;)">Cannot send result, sending error result instead: $</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.reason" title="String">reason</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span>
          <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send" title="(result: play.api.mvc.Result)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">send</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.alternativeResult" title="play.api.mvc.Result">alternativeResult</a><span class="delimiter">)</span>
        <span class="keyword">case</span> Right<span class="delimiter">(</span><span class="delimiter">(</span><a title="play.core.server.common.ServerResultUtils.ResultStreaming" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streaming">streaming</a>, <a title="play.core.server.common.ServerResultUtils.ConnectionHeader" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader">connectionHeader</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
          <span class="comment">// Create our base response. It may be modified, depending on the</span>
          <span class="comment">// streaming strategy.</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse">nettyResponse</a> = <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse" title="(header: play.api.mvc.ResponseHeader, connectionHeader: play.core.server.common.ServerResultUtils.ConnectionHeader, httpVersion: org.jboss.netty.handler.codec.http.HttpVersion)org.jboss.netty.handler.codec.http.DefaultHttpResponse">createNettyResponse</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.result" title="play.api.mvc.Result">result</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;Result.header" title="=&gt; play.api.mvc.ResponseHeader">header</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.httpVersion" title="org.jboss.netty.handler.codec.http.HttpVersion">httpVersion</a><span class="delimiter">)</span>

          <span class="comment">// Streams whatever content that has been added to the nettyResponse, or</span>
          <span class="comment">// no content if none was added</span>
          <span class="keyword">def</span> <a title="()scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent">sendContent</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
            <span class="keyword">val</span> <a title="scala.concurrent.Future[org.jboss.netty.channel.Channel]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.future">future</a> = <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream" title="(subSequence: Int, last: Boolean, message: Object)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)org.jboss.netty.channel.ChannelFuture">sendDownstream</a><a href="NettyFuture.scala.html#play.core.server.netty.NettyFuture.ToScala" title="implicit play.core.server.netty.NettyFuture.ToScala : (channelFuture: org.jboss.netty.channel.ChannelFuture)play.core.server.netty.NettyFuture.ToScala" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.sendResult.startSequence" title="Int">startSequence</a>, <span title="=&gt; Boolean">!</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader.willClose" title="=&gt; Boolean">willClose</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a><span class="delimiter">)</span>.<a href="NettyFuture.scala.html#play.core.server.netty.NettyFuture;ToScala.toScala" title="=&gt; scala.concurrent.Future[org.jboss.netty.channel.Channel]">toScala</a>
            <span class="keyword">val</span> <a title="play.core.server.netty.NettyResultStreamer.ChannelStatus" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.channelStatus">channelStatus</a> = <span title="play.core.server.netty.NettyResultStreamer.ChannelStatus" class="keyword">new</span> <a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">ChannelStatus</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader.willClose" title="=&gt; Boolean">willClose</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.startSequence" title="Int">startSequence</a><span class="delimiter">)</span>
            <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.future" title="scala.concurrent.Future[org.jboss.netty.channel.Channel]">future</a>.<span title="(f: org.jboss.netty.channel.Channel =&gt; play.core.server.netty.NettyResultStreamer.ChannelStatus)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">map</span><a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution.Implicits.trampoline" title="=&gt; scala.concurrent.ExecutionContext" class="delimiter">(</a><a title="org.jboss.netty.channel.Channel" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.$anonfun.x$1">_</a> =&gt; <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.channelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">channelStatus</a><span class="delimiter">)</span>.<span title="(pf: PartialFunction[Throwable,play.core.server.netty.NettyResultStreamer.ChannelStatus])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">recover</span> <a title="anonymous class $anonfun extends scala.runtime.AbstractPartialFunction[Throwable,play.core.server.netty.NettyResultStreamer.ChannelStatus] with Serializable" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a> <span class="keyword">case</span> _ =&gt; <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent.channelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">channelStatus</a> <span class="delimiter">}</span>
          <span class="delimiter">}</span>

          <span class="comment">// Streams the value of an enumerator into the nettyResponse</span>
          <span class="keyword">def</span> <a title="(enum: play.api.libs.iteratee.Enumerator[Array[Byte]])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum">streamEnum</a><span class="delimiter">(</span><a title="play.api.libs.iteratee.Enumerator[Array[Byte]]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum.enum">enum</a>: <a href="../../../../../play-iteratees/play/api/libs/iteratee/Enumerator.scala.html#play.api.libs.iteratee;Enumerator" title="play.api.libs.iteratee.Enumerator[Array[Byte]]">Enumerator</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
            <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum.enum" title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</a> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Enumerator.scala.html#play.api.libs.iteratee;Enumerator.|>>>" title="(i: play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">|&gt;&gt;&gt;</a> <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee" title="(nettyResponse: org.jboss.netty.handler.codec.http.HttpResponse, startSequence: Int, closeConnection: Boolean)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit e: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">nettyStreamIteratee</a><a href="#play.core.server.netty.NettyResultStreamer.sendResult.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.startSequence" title="Int">startSequence</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader.willClose" title="=&gt; Boolean">willClose</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>

          <span class="comment">// Interpret the streaming strategy for Netty</span>
          <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streaming" title="play.core.server.common.ServerResultUtils.ResultStreaming">streaming</a> <span title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" class="keyword">match</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> ServerResultUtils.StreamWithClose<span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span> =&gt;
              <span title="(assertion: Boolean)Unit">assert</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader.willClose" title="=&gt; Boolean">willClose</a><span class="delimiter">)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum" title="(enum: play.api.libs.iteratee.Enumerator[Array[Byte]])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">streamEnum</a><span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span>
            <span class="keyword">case</span> ServerResultUtils.StreamWithKnownLength<span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span> =&gt;
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum" title="(enum: play.api.libs.iteratee.Enumerator[Array[Byte]])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">streamEnum</a><span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span>
            <span class="keyword">case</span> <a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils" title="play.core.server.common.ServerResultUtils.type">ServerResultUtils</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils.StreamWithNoBody" title="play.core.server.common.ServerResultUtils.StreamWithNoBody.type">StreamWithNoBody</a> =&gt;
              <span class="comment">// `StreamWithNoBody` won't add the Content-Length entity-header to the response (if not already present)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent" title="()scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">sendContent</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="keyword">case</span> ServerResultUtils.StreamWithStrictBody<span class="delimiter">(</span><a title="Array[Byte]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.body">body</a><span class="delimiter">)</span> =&gt;
              <span class="comment">// We successfully buffered it, so set the content length and send the whole thing as one buffer</span>
              <span class="keyword">val</span> <a title="org.jboss.netty.buffer.ChannelBuffer" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.buffer">buffer</a> = <span title="org.jboss.netty.buffer.ChannelBuffer" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.body" title="implicit scala.Predef.byteArrayOps : (xs: Array[Byte])scala.collection.mutable.ArrayOps[Byte]">body</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span title="org.jboss.netty.buffer.ChannelBuffers.type">ChannelBuffers</span>.<span title="org.jboss.netty.buffer.ChannelBuffer">EMPTY_BUFFER</span> <span class="keyword">else</span> <span title="org.jboss.netty.buffer.ChannelBuffers.type">ChannelBuffers</span>.<span title="(x$1: Array[Byte])org.jboss.netty.buffer.ChannelBuffer">wrappedBuffer</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.body" title="Array[Byte]">body</a><span class="delimiter">)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>.<span title="()org.jboss.netty.handler.codec.http.HttpHeaders">headers</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: String, x$2: Any)org.jboss.netty.handler.codec.http.HttpHeaders">set</span><span class="delimiter">(</span><span title="String(&quot;Content-Length&quot;)">CONTENT_LENGTH</span>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.buffer" title="org.jboss.netty.buffer.ChannelBuffer">buffer</a>.<span title="()Int">readableBytes</span><span class="delimiter">)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>.<span title="(x$1: org.jboss.netty.buffer.ChannelBuffer)Unit">setContent</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.buffer" title="org.jboss.netty.buffer.ChannelBuffer">buffer</a><span class="delimiter">)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.sendContent" title="()scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">sendContent</a><span class="delimiter">(</span><span class="delimiter">)</span>
            <span class="keyword">case</span> ServerResultUtils.UseExistingTransferEncoding<span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span> =&gt;
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum" title="(enum: play.api.libs.iteratee.Enumerator[Array[Byte]])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">streamEnum</a><span class="delimiter">(</span><span title="play.api.libs.iteratee.Enumerator[Array[Byte]]">enum</span><span class="delimiter">)</span>
            <span class="keyword">case</span> ServerResultUtils.PerformChunkedTransferEncoding<span class="delimiter">(</span><a title="play.api.libs.iteratee.Enumerator[Array[Byte]]" id="play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.transferEncodedEnum">transferEncodedEnum</a><span class="delimiter">)</span> =&gt;
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>.<span title="()org.jboss.netty.handler.codec.http.HttpHeaders">headers</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: String, x$2: Any)org.jboss.netty.handler.codec.http.HttpHeaders">set</span><span class="delimiter">(</span><span title="String(&quot;Transfer-Encoding&quot;)">TRANSFER_ENCODING</span>, <span title="String(&quot;chunked&quot;)">CHUNKED</span><span class="delimiter">)</span>
              <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.streamEnum" title="(enum: play.api.libs.iteratee.Enumerator[Array[Byte]])scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">streamEnum</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.send.$anonfun.transferEncodedEnum" title="play.api.libs.iteratee.Enumerator[Array[Byte]]">transferEncodedEnum</a> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Enumerator.scala.html#play.api.libs.iteratee;Enumerator.&>" title="(enumeratee: play.api.libs.iteratee.Enumeratee[Array[Byte],Array[Byte]])play.api.libs.iteratee.Enumerator[Array[Byte]]">&amp;&gt;</a> <a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc.Results" title="play.api.mvc.Results.type">Results</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;Results.chunk(033c07489a)" title="=&gt; play.api.libs.iteratee.Enumeratee[Array[Byte],Array[Byte]]">chunk</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">val</span> <a title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.sendResult.sentResponse">sentResponse</a>: <span title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">Future</span><span class="delimiter">[</span>ChannelStatus<span class="delimiter">]</span> = <a href="#play.core.server.netty.NettyResultStreamer.sendResult.send" title="(result: play.api.mvc.Result)scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">send</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.result" title="play.api.mvc.Result">result</a><span class="delimiter">)</span>

    <span class="comment">// Clean up</span>
    <a href="#play.core.server.netty.NettyResultStreamer.sendResult.sentResponse" title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">sentResponse</a>.<span title="(func: scala.util.Try[play.core.server.netty.NettyResultStreamer.ChannelStatus] =&gt; Any)(implicit executor: scala.concurrent.ExecutionContext)Unit">onComplete</span> <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.x0$4" title="Any" class="delimiter">{</a>
      <span class="keyword">case</span> Success<span class="delimiter">(</span><a title="play.core.server.netty.NettyResultStreamer.ChannelStatus" id="play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.cs">cs</a>: <a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">ChannelStatus</a><span class="delimiter">)</span> =&gt;
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.cs" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">cs</a>.<a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus.closeConnection" title="=&gt; Boolean">closeConnection</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// Close in an orderely fashion.</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.Channel" id="play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.channel">channel</a> = <a href="#play.core.server.netty.NettyResultStreamer.sendResult.oue" title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">oue</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>
          <span class="keyword">val</span> <a title="org.jboss.netty.channel.DownstreamChannelStateEvent" id="play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.closeEvent">closeEvent</a> = <span title="org.jboss.netty.channel.DownstreamChannelStateEvent" class="keyword">new</span> <span title="org.jboss.netty.channel.DownstreamChannelStateEvent">DownstreamChannelStateEvent</span><span class="delimiter">(</span>
            <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.channel" title="org.jboss.netty.channel.Channel">channel</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.channel" title="org.jboss.netty.channel.Channel">channel</a>.<span title="()org.jboss.netty.channel.ChannelFuture">getCloseFuture</span>, ChannelState.<span title="org.jboss.netty.channel.ChannelState(OPEN)">OPEN</span>, java.lang.<span title="Boolean.type">Boolean</span>.<span title="Boolean">FALSE</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent" id="play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.ode">ode</a> = <span title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent" class="keyword">new</span> <span title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent">OrderedDownstreamChannelEvent</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.oue" title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">oue</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.cs" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">cs</a>.<a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus.lastSubsequence" title="=&gt; Int">lastSubsequence</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <span title="Boolean(true)" class="keyword">true</span>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.closeEvent" title="org.jboss.netty.channel.DownstreamChannelStateEvent">closeEvent</a><span class="delimiter">)</span>
          <a href="#play.core.server.netty.NettyResultStreamer.sendResult.ctx" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendDownstream</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.ode" title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent">ode</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="keyword">case</span> Failure<span class="delimiter">(</span><a title="Throwable" id="play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.ex">ex</a><span class="delimiter">)</span> =&gt;
        <a href="#play.core.server.netty.NettyResultStreamer.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../../../../../play/play/api/Logger.scala.html#play.api;LoggerLike.error(804ef4765b)" title="(message: =&gt; String, error: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while sending response.&quot;)" class="string">&quot;Error while sending response.&quot;</span>, <a href="#play.core.server.netty.NettyResultStreamer.sendResult.$anonfun.ex" title="Throwable">ex</a><span class="delimiter">)</span>
        <span title="org.jboss.netty.channel.Channels.type">Channels</span>.<span title="(x$1: org.jboss.netty.channel.Channel)org.jboss.netty.channel.ChannelFuture">close</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendResult.oue" title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">oue</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#play.core.server.netty.NettyResultStreamer.sendResult.sentResponse" title="scala.concurrent.Future[play.core.server.netty.NettyResultStreamer.ChannelStatus]">sentResponse</a>
  <span class="delimiter">}</span>

  <span class="comment">// Construct an iteratee for the purposes of streaming responses to a downstream handler.</span>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(nettyResponse: org.jboss.netty.handler.codec.http.HttpResponse, startSequence: Int, closeConnection: Boolean)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit e: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee">nettyStreamIteratee</a><span class="delimiter">(</span><a title="org.jboss.netty.handler.codec.http.HttpResponse" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.nettyResponse">nettyResponse</a>: <span title="org.jboss.netty.handler.codec.http.HttpResponse">HttpResponse</span>, <a title="Int" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.startSequence">startSequence</a>: <span title="Int">Int</span>, <a title="Boolean" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.closeConnection">closeConnection</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="org.jboss.netty.channel.ChannelHandlerContext" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.e">e</a>: <span title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">OrderedUpstreamMessageEvent</span><span class="delimiter">)</span>: <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Iteratee" title="play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">Iteratee</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, ChannelStatus<span class="delimiter">]</span> = <span class="delimiter">{</span>

    <span class="keyword">def</span> <a title="(subsequence: Int)(in: play.api.libs.iteratee.Input[Array[Byte]])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step">step</a><span class="delimiter">(</span><a title="Int" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence">subsequence</a>: <span title="Int">Int</span><span class="delimiter">)</span><span class="delimiter">(</span><a title="play.api.libs.iteratee.Input[Array[Byte]]" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.in">in</a>: <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Input" title="play.api.libs.iteratee.Input[Array[Byte]]">Input</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>: <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Iteratee" title="play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">Iteratee</a><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>, ChannelStatus<span class="delimiter">]</span> = <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.in" title="play.api.libs.iteratee.Input[Array[Byte]]">in</a> <span title="play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> Input.El<span class="delimiter">(</span><a title="Array[Byte]" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.x">x</a><span class="delimiter">)</span> =&gt;
        <span class="keyword">val</span> <a title="org.jboss.netty.buffer.ChannelBuffer" id="play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.b">b</a> = <span title="org.jboss.netty.buffer.ChannelBuffers.type">ChannelBuffers</span>.<span title="(x$1: Array[Byte])org.jboss.netty.buffer.ChannelBuffer">wrappedBuffer</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.x" title="Array[Byte]">x</a><span class="delimiter">)</span>
        <a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete" title="(future: org.jboss.netty.channel.ChannelFuture, step: play.api.libs.iteratee.Input[Array[Byte]] =&gt; play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus], done: play.core.server.netty.NettyResultStreamer.ChannelStatus)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext)play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">nextWhenComplete</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.sendDownstream" title="(subSequence: Int, last: Boolean, message: Object)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)org.jboss.netty.channel.ChannelFuture">sendDownstream</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.b" title="org.jboss.netty.buffer.ChannelBuffer">b</a><span class="delimiter">)</span>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step" title="(subsequence: Int)(in: play.api.libs.iteratee.Input[Array[Byte]])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">step</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.$anonfun.in" title="play.api.libs.iteratee.Input[Array[Byte]]" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a> <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.eta$0$1" title="(x: Int)Int">+</a> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <span title="play.core.server.netty.NettyResultStreamer.ChannelStatus" class="keyword">new</span> <a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">ChannelStatus</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.closeConnection" title="Boolean">closeConnection</a>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Input" title="play.api.libs.iteratee.Input.type">Input</a>.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Input.Empty" title="play.api.libs.iteratee.Input.Empty.type">Empty</a> =&gt;
        <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Cont.apply" title="(k: play.api.libs.iteratee.Input[Array[Byte]] =&gt; play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">Cont</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step" title="(subsequence: Int)(in: play.api.libs.iteratee.Input[Array[Byte]])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">step</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.$anonfun.in" title="play.api.libs.iteratee.Input[Array[Byte]]" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="keyword">case</span> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Input" title="play.api.libs.iteratee.Input.type">Input</a>.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Input.EOF" title="play.api.libs.iteratee.Input.EOF.type">EOF</a> =&gt;
        <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream" title="(subSequence: Int, last: Boolean, message: Object)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)org.jboss.netty.channel.ChannelFuture">sendDownstream</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a>, <span title="=&gt; Boolean">!</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.closeConnection" title="Boolean">closeConnection</a>, <span title="org.jboss.netty.buffer.ChannelBuffers.type">ChannelBuffers</span>.<span title="org.jboss.netty.buffer.ChannelBuffer">EMPTY_BUFFER</span><span class="delimiter">)</span>
        <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Done.apply" title="(a: play.core.server.netty.NettyResultStreamer.ChannelStatus, e: play.api.libs.iteratee.Input[Array[Byte]])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">Done</a><span class="delimiter">(</span><span title="play.core.server.netty.NettyResultStreamer.ChannelStatus" class="keyword">new</span> <a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">ChannelStatus</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.closeConnection" title="Boolean">closeConnection</a>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step.subsequence" title="Int">subsequence</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete" title="(future: org.jboss.netty.channel.ChannelFuture, step: play.api.libs.iteratee.Input[Array[Byte]] =&gt; play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus], done: play.core.server.netty.NettyResultStreamer.ChannelStatus)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext)play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">nextWhenComplete</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.sendDownstream" title="(subSequence: Int, last: Boolean, message: Object)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)org.jboss.netty.channel.ChannelFuture">sendDownstream</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.ctx" title="org.jboss.netty.channel.ChannelHandlerContext" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.startSequence" title="Int">startSequence</a>, <span title="Boolean(false)" class="keyword">false</span>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.nettyResponse" title="org.jboss.netty.handler.codec.http.HttpResponse">nettyResponse</a><span class="delimiter">)</span>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.step" title="(subsequence: Int)(in: play.api.libs.iteratee.Input[Array[Byte]])play.api.libs.iteratee.Iteratee[Array[Byte],play.core.server.netty.NettyResultStreamer.ChannelStatus]">step</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.$anonfun.in" title="play.api.libs.iteratee.Input[Array[Byte]]" class="delimiter">(</a><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.startSequence" title="Int">startSequence</a> <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.eta$0$2" title="(x: Int)Int">+</a> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <span title="play.core.server.netty.NettyResultStreamer.ChannelStatus" class="keyword">new</span> <a href="#play.core.server.netty.NettyResultStreamer;ChannelStatus" title="play.core.server.netty.NettyResultStreamer.ChannelStatus">ChannelStatus</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.closeConnection" title="Boolean">closeConnection</a>, <a href="#play.core.server.netty.NettyResultStreamer.nettyStreamIteratee.startSequence" title="Int">startSequence</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(header: play.api.mvc.ResponseHeader, connectionHeader: play.core.server.common.ServerResultUtils.ConnectionHeader, httpVersion: org.jboss.netty.handler.codec.http.HttpVersion)org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="play.core.server.netty.NettyResultStreamer.createNettyResponse">createNettyResponse</a><span class="delimiter">(</span><a title="play.api.mvc.ResponseHeader" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.header">header</a>: <a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;ResponseHeader" title="play.api.mvc.ResponseHeader">ResponseHeader</a>, <a title="play.core.server.common.ServerResultUtils.ConnectionHeader" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.connectionHeader">connectionHeader</a>: ServerResultUtils.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">ConnectionHeader</a>, <a title="org.jboss.netty.handler.codec.http.HttpVersion" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.httpVersion">httpVersion</a>: <span title="org.jboss.netty.handler.codec.http.HttpVersion">HttpVersion</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.HttpResponseStatus" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.responseStatus">responseStatus</a> = <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.header" title="play.api.mvc.ResponseHeader">header</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;ResponseHeader.reasonPhrase" title="=&gt; Option[String]">reasonPhrase</a> <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus" class="keyword">match</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> Some<span class="delimiter">(</span><a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.responseStatus.phrase">phrase</a><span class="delimiter">)</span> =&gt; <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">HttpResponseStatus</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.header" title="play.api.mvc.ResponseHeader">header</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;ResponseHeader.status" title="=&gt; Int">status</a>, <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.responseStatus.phrase" title="String">phrase</a><span class="delimiter">)</span>
      <span class="keyword">case</span> <span title="None.type">None</span> =&gt; <span title="org.jboss.netty.handler.codec.http.HttpResponseStatus.type">HttpResponseStatus</span>.<span title="(x$1: Int)org.jboss.netty.handler.codec.http.HttpResponseStatus">valueOf</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.header" title="play.api.mvc.ResponseHeader">header</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;ResponseHeader.status" title="=&gt; Int">status</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyResponse">nettyResponse</a> = <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse" class="keyword">new</span> <span title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">DefaultHttpResponse</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.httpVersion" title="org.jboss.netty.handler.codec.http.HttpVersion">httpVersion</a>, <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.responseStatus" title="org.jboss.netty.handler.codec.http.HttpResponseStatus">responseStatus</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="org.jboss.netty.handler.codec.http.HttpHeaders" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders">nettyHeaders</a> = <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>.<span title="()org.jboss.netty.handler.codec.http.HttpHeaders">headers</span><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// Set response headers</span>
    <span class="keyword">val</span> <a title="Iterable[(String, String)]" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.headers">headers</a> = <a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils" title="play.core.server.common.ServerResultUtils.type">ServerResultUtils</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils.splitSetCookieHeaders" title="(headers: Map[String,String])Iterable[(String, String)]">splitSetCookieHeaders</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.header" title="play.api.mvc.ResponseHeader">header</a>.<a href="../../../../../play/play/api/mvc/Results.scala.html#play.api.mvc;ResponseHeader.headers" title="=&gt; Map[String,String]">headers</a><span class="delimiter">)</span>
    <span class="keyword">try</span> <span class="delimiter">{</span>
      <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.headers" title="Iterable[(String, String)]">headers</a> <span title="(f: ((String, String)) =&gt; org.jboss.netty.handler.codec.http.HttpHeaders)Unit">foreach</span> <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.x0$2" title="org.jboss.netty.handler.codec.http.HttpHeaders" class="delimiter">{</a>
        <span class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.name">name</a>, <a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.value">value</a><span class="delimiter">)</span> =&gt; <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders" title="org.jboss.netty.handler.codec.http.HttpHeaders">nettyHeaders</a>.<span title="(x$1: String, x$2: Any)org.jboss.netty.handler.codec.http.HttpHeaders">add</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.name" title="String">name</a>, <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.value" title="String">value</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">{</span>
      <span class="keyword">case</span> <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.<unapply-selector>" title="(t: Throwable)Option[Throwable]">NonFatal</a><span class="delimiter">(</span><a title="Throwable" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.e">e</a><span class="delimiter">)</span> =&gt;
        <span title="Unit" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../../../../../play/play/api/Logger.scala.html#play.api;LoggerLike.isErrorEnabled" title="=&gt; Boolean">isErrorEnabled</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="keyword">val</span> <a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders">prettyHeaders</a> = <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.headers" title="Iterable[(String, String)]">headers</a>.<span title="(f: ((String, String)) =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[(String, String)],String,Iterable[String]])Iterable[String]">map</span> <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders.$anonfun.x0$3" title="String" class="delimiter">{</a> <span class="keyword">case</span> <span class="delimiter">(</span><a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders.$anonfun.name">name</a>, <a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders.$anonfun.value">value</a><span class="delimiter">)</span> =&gt; <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;&quot;)">$</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders.$anonfun.name" title="String">name</a><span title="String(&quot; -&gt; &quot;)"> -&gt; $</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders.$anonfun.value" title="String">value</a><span title="String(&quot;&quot;)" class="string">&quot;</span> <span class="delimiter">}</span>.<span title="(start: String, sep: String, end: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;[&quot;)" class="string">&quot;[&quot;</span>, <span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span>, <span title="String(&quot;]&quot;)" class="string">&quot;]&quot;</span><span class="delimiter">)</span>
          <span class="keyword">val</span> <a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.msg">msg</a> = <span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Exception occurred while setting response\'s headers to &quot;)">Exception occurred while setting response's headers to $</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.prettyHeaders" title="String">prettyHeaders</a><span title="String(&quot;. Action taken is to set the response\'s status to &quot;)">. Action taken is to set the response's status to $</span><span class="delimiter">{</span><span title="org.jboss.netty.handler.codec.http.HttpResponseStatus.type">HttpResponseStatus</span>.<span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">INTERNAL_SERVER_ERROR</span><span class="delimiter">}</span><span title="String(&quot; and discard all headers.&quot;)" class="string"> and discard all headers.&quot;</span>
          <a href="#play.core.server.netty.NettyResultStreamer.logger" title="=&gt; play.api.Logger">logger</a>.<a href="../../../../../play/play/api/Logger.scala.html#play.api;LoggerLike.error(804ef4765b)" title="(message: =&gt; String, error: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.msg" title="String">msg</a>, <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.e" title="Throwable">e</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>.<span title="(x$1: org.jboss.netty.handler.codec.http.HttpResponseStatus)Unit">setStatus</span><span class="delimiter">(</span><span title="org.jboss.netty.handler.codec.http.HttpResponseStatus.type">HttpResponseStatus</span>.<span title="org.jboss.netty.handler.codec.http.HttpResponseStatus">INTERNAL_SERVER_ERROR</span><span class="delimiter">)</span>
        <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders" title="org.jboss.netty.handler.codec.http.HttpHeaders">nettyHeaders</a>.<span title="()org.jboss.netty.handler.codec.http.HttpHeaders">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.connectionHeader" title="play.core.server.common.ServerResultUtils.ConnectionHeader">connectionHeader</a>.<a href="../../../../../play-server/play/core/server/common/ServerResultUtils.scala.html#play.core.server.common.ServerResultUtils;ConnectionHeader.header" title="=&gt; Option[String]">header</a> <span title="(f: String =&gt; org.jboss.netty.handler.codec.http.HttpHeaders)Unit">foreach</span> <span class="delimiter">{</span> <a title="String" id="play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.headerValue">headerValue</a> =&gt;
      <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders" title="org.jboss.netty.handler.codec.http.HttpHeaders">nettyHeaders</a>.<span title="(x$1: String, x$2: Any)org.jboss.netty.handler.codec.http.HttpHeaders">set</span><span class="delimiter">(</span><span title="String(&quot;Connection&quot;)">CONNECTION</span>, <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.$anonfun.headerValue" title="String">headerValue</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="comment">// Netty doesn't add the required Date header for us, so make sure there is one here</span>
    <span title="Any" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders" title="org.jboss.netty.handler.codec.http.HttpHeaders">nettyHeaders</a>.<span title="(x$1: String)Boolean">contains</span><span class="delimiter">(</span><span title="String(&quot;Date&quot;)">DATE</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyHeaders" title="org.jboss.netty.handler.codec.http.HttpHeaders">nettyHeaders</a>.<span title="(x$1: String, x$2: Any)org.jboss.netty.handler.codec.http.HttpHeaders">add</span><span class="delimiter">(</span><span title="String(&quot;Date&quot;)">DATE</span>, <a href="#play.core.server.netty.NettyResultStreamer.dateHeader" title="=&gt; String">dateHeader</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#play.core.server.netty.NettyResultStreamer.createNettyResponse.nettyResponse" title="org.jboss.netty.handler.codec.http.DefaultHttpResponse">nettyResponse</a>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(subSequence: Int, last: Boolean, message: Object)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext, implicit oue: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent)org.jboss.netty.channel.ChannelFuture" id="play.core.server.netty.NettyResultStreamer.sendDownstream">sendDownstream</a><span class="delimiter">(</span><a title="Int" id="play.core.server.netty.NettyResultStreamer.sendDownstream.subSequence">subSequence</a>: <span title="Int">Int</span>, <a title="Boolean" id="play.core.server.netty.NettyResultStreamer.sendDownstream.last">last</a>: <span title="Boolean">Boolean</span>, <a title="Object" id="play.core.server.netty.NettyResultStreamer.sendDownstream.message">message</a>: <span title="Object">Object</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="org.jboss.netty.channel.ChannelHandlerContext" id="play.core.server.netty.NettyResultStreamer.sendDownstream.ctx">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span>, <a title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent" id="play.core.server.netty.NettyResultStreamer.sendDownstream.oue">oue</a>: <span title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">OrderedUpstreamMessageEvent</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent" id="play.core.server.netty.NettyResultStreamer.sendDownstream.ode">ode</a> = <span title="(x$1: com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent, x$2: Int, x$3: Boolean, x$4: Any)com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent" class="keyword">new</span> <span title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent">OrderedDownstreamChannelEvent</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.oue" title="com.typesafe.netty.http.pipelining.OrderedUpstreamMessageEvent">oue</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.subSequence" title="Int">subSequence</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.last" title="Boolean">last</a>, <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.message" title="Object">message</a><span class="delimiter">)</span>
    <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.ctx" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="(x$1: org.jboss.netty.channel.ChannelEvent)Unit">sendDownstream</span><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.ode" title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent">ode</a><span class="delimiter">)</span>
    <a href="#play.core.server.netty.NettyResultStreamer.sendDownstream.ode" title="com.typesafe.netty.http.pipelining.OrderedDownstreamChannelEvent">ode</a>.<span title="()org.jboss.netty.channel.ChannelFuture">getFuture</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="[E, A](future: org.jboss.netty.channel.ChannelFuture, step: play.api.libs.iteratee.Input[E] =&gt; play.api.libs.iteratee.Iteratee[E,A], done: A)(implicit ctx: org.jboss.netty.channel.ChannelHandlerContext)play.api.libs.iteratee.Iteratee[E,A]" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete">nextWhenComplete</a><span class="delimiter">[</span><a title="" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete;E">E</a>, <a title="" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="org.jboss.netty.channel.ChannelFuture" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete.future">future</a>: <span title="org.jboss.netty.channel.ChannelFuture">ChannelFuture</span>, <a title="play.api.libs.iteratee.Input[E] =&gt; play.api.libs.iteratee.Iteratee[E,A]" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete.step">step</a>: <span class="delimiter">(</span>Input<span class="delimiter">[</span>E<span class="delimiter">]</span><span class="delimiter">)</span> =&gt; Iteratee<span class="delimiter">[</span>E, A<span class="delimiter">]</span>, <a title="A" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete.done">done</a>: <a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete;A" title="A">A</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="keyword">implicit</span> <a title="org.jboss.netty.channel.ChannelHandlerContext" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete.ctx">ctx</a>: <span title="org.jboss.netty.channel.ChannelHandlerContext">ChannelHandlerContext</span><span class="delimiter">)</span>: <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Iteratee" title="play.api.libs.iteratee.Iteratee[E,A]">Iteratee</a><span class="delimiter">[</span>E, A<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <span class="comment">// If the channel isn't currently connected, then this future will never be redeemed.  This is racey, and impossible</span>
    <span class="comment">// to 100% detect, but it's better to fail fast if possible than to sit there waiting forever</span>
    <span class="keyword">import</span> play.api.libs.iteratee.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution" title="play.api.libs.iteratee.Execution.type">Execution</a>.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution.Implicits" title="play.api.libs.iteratee.Execution.Implicits.type">Implicits</a>.trampoline
    <span title="play.api.libs.iteratee.Iteratee[E,A]" class="keyword">if</span> <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.ctx" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()Boolean">isConnected</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Done.apply" title="(a: A, e: play.api.libs.iteratee.Input[E])play.api.libs.iteratee.Iteratee[E,A]">Done</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.done" title="A">done</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
      <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Iteratee" title="play.api.libs.iteratee.Iteratee.type">Iteratee</a>.<a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Iteratee.flatten" title="(i: scala.concurrent.Future[play.api.libs.iteratee.Iteratee[E,A]])play.api.libs.iteratee.Iteratee[E,A]">flatten</a><span class="delimiter">(</span>
        <a href="NettyFuture.scala.html#play.core.server.netty.NettyFuture.ToScala" title="implicit play.core.server.netty.NettyFuture.ToScala : (channelFuture: org.jboss.netty.channel.ChannelFuture)play.core.server.netty.NettyFuture.ToScala">future</a>.<a href="NettyFuture.scala.html#play.core.server.netty.NettyFuture;ToScala.toScala" title="=&gt; scala.concurrent.Future[org.jboss.netty.channel.Channel]">toScala</a>.<span title="[S](f: org.jboss.netty.channel.Channel =&gt; S)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[S]">map</span><span title="(f: org.jboss.netty.channel.Channel =&gt; play.api.libs.iteratee.Iteratee[E,A])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[play.api.libs.iteratee.Iteratee[E,A]]" class="delimiter">[</span><a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Iteratee" title="play.api.libs.iteratee.Iteratee[E,A]">Iteratee</a><span class="delimiter">[</span>E, A<span class="delimiter">]</span><span class="delimiter">]</span> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Execution.scala.html#play.api.libs.iteratee.Execution.Implicits.trampoline" title="=&gt; scala.concurrent.ExecutionContext" class="delimiter">{</a>
          <a title="org.jboss.netty.channel.Channel" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete.$anonfun.x$2">_</a> =&gt; <span title="play.api.libs.iteratee.Iteratee[E,A]" class="keyword">if</span> <span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.ctx" title="org.jboss.netty.channel.ChannelHandlerContext">ctx</a>.<span title="()org.jboss.netty.channel.Channel">getChannel</span>.<span title="()Boolean">isConnected</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Cont.apply" title="(k: play.api.libs.iteratee.Input[E] =&gt; play.api.libs.iteratee.Iteratee[E,A])play.api.libs.iteratee.Iteratee[E,A]">Cont</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.step" title="play.api.libs.iteratee.Input[E] =&gt; play.api.libs.iteratee.Iteratee[E,A]">step</a><span class="delimiter">)</span> <span class="keyword">else</span> <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Done.apply" title="(a: A, e: play.api.libs.iteratee.Input[E])play.api.libs.iteratee.Iteratee[E,A]">Done</a><span class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.done" title="A">done</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>.<span title="[U &gt;: play.api.libs.iteratee.Iteratee[E,A]](pf: PartialFunction[Throwable,U])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[U]">recover</span><span title="(pf: PartialFunction[Throwable,play.api.libs.iteratee.Iteratee[E,A]])(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[play.api.libs.iteratee.Iteratee[E,A]]" class="delimiter">[</span><a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee;Iteratee" title="play.api.libs.iteratee.Iteratee[E,A]">Iteratee</a><span class="delimiter">[</span>E, A<span class="delimiter">]</span><span class="delimiter">]</span> <a title="anonymous class $anonfun extends scala.runtime.AbstractPartialFunction[Throwable,play.api.libs.iteratee.Iteratee[E,A]] with Serializable" id="play.core.server.netty.NettyResultStreamer.nextWhenComplete;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
          <span class="keyword">case</span> _ =&gt; <a href="../../../../../play-iteratees/play/api/libs/iteratee/Iteratee.scala.html#play.api.libs.iteratee.Done.apply" title="(a: A, e: play.api.libs.iteratee.Input[E])play.api.libs.iteratee.Iteratee[E,A]">Done</a><span title="Boolean(true)" class="delimiter">(</span><a href="#play.core.server.netty.NettyResultStreamer.nextWhenComplete.done" title="A">done</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

<span class="delimiter">}</span>

        </pre>
    </body>
</html>
