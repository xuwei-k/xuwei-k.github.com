<?xml version="1.0" encoding="utf-8"?>
      <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <meta http-equiv="Expires" content="0" />
        <title>play/play/libs/Time.java</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> play.libs;

<span class="keyword">import</span> java.io.Serializable;
<span class="keyword">import</span> java.text.ParseException;
<span class="keyword">import</span> java.util.Calendar;
<span class="keyword">import</span> java.util.Date;
<span class="keyword">import</span> java.util.HashMap;
<span class="keyword">import</span> java.util.Iterator;
<span class="keyword">import</span> java.util.Locale;
<span class="keyword">import</span> java.util.Map;
<span class="keyword">import</span> java.util.SortedSet;
<span class="keyword">import</span> java.util.StringTokenizer;
<span class="keyword">import</span> java.util.TimeZone;
<span class="keyword">import</span> java.util.TreeSet;
<span class="keyword">import</span> java.util.regex.Matcher;
<span class="keyword">import</span> java.util.regex.Pattern;

<span class="comment">/**
 * Time utilities.
 */</span>
public <span class="keyword">class</span> <a title="object play.libs.Time" id="20877">Time</a> <span class="delimiter">{</span>

    static Pattern <a title="java.util.regex.Pattern" id="385716">days</a> = Pattern.compile<span class="delimiter">(</span><span class="string">&quot;^([0-9]+)d$&quot;</span><span class="delimiter">)</span>;
    static Pattern <a title="java.util.regex.Pattern" id="385717">hours</a> = Pattern.compile<span class="delimiter">(</span><span class="string">&quot;^([0-9]+)h$&quot;</span><span class="delimiter">)</span>;
    static Pattern <a title="java.util.regex.Pattern" id="385718">minutes</a> = Pattern.compile<span class="delimiter">(</span><span class="string">&quot;^([0-9]+)mi?n$&quot;</span><span class="delimiter">)</span>;
    static Pattern <a title="java.util.regex.Pattern" id="385719">seconds</a> = Pattern.compile<span class="delimiter">(</span><span class="string">&quot;^([0-9]+)s$&quot;</span><span class="delimiter">)</span>;

    <span class="comment">/**
     * Parses a duration.
     * 
     * @param duration a quantity of time, such as 3h, 2mn, 7s
     * @return the length of the duration in seconds
     */</span>
    public static int <a title="(duration: java.lang.String)Int" id="385720">parseDuration</a><span class="delimiter">(</span>String <a title="java.lang.String" id="385730">duration</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>duration == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="int">60</span> * <span class="int">60</span> * <span class="int">24</span> * <span class="int">30</span>;
        <span class="delimiter">}</span>
        int toAdd = -<span class="int">1</span>;
        <span class="keyword">if</span> <span class="delimiter">(</span>days.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>.matches<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            Matcher matcher = days.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>;
            matcher.matches<span class="delimiter">(</span><span class="delimiter">)</span>;
            toAdd = Integer.parseInt<span class="delimiter">(</span>matcher.group<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> * <span class="delimiter">(</span><span class="int">60</span> * <span class="int">60</span><span class="delimiter">)</span> * <span class="int">24</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>hours.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>.matches<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            Matcher matcher = hours.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>;
            matcher.matches<span class="delimiter">(</span><span class="delimiter">)</span>;
            toAdd = Integer.parseInt<span class="delimiter">(</span>matcher.group<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> * <span class="delimiter">(</span><span class="int">60</span> * <span class="int">60</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>minutes.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>.matches<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            Matcher matcher = minutes.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>;
            matcher.matches<span class="delimiter">(</span><span class="delimiter">)</span>;
            toAdd = Integer.parseInt<span class="delimiter">(</span>matcher.group<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span> * <span class="delimiter">(</span><span class="int">60</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>seconds.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>.matches<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            Matcher matcher = seconds.matcher<span class="delimiter">(</span>duration<span class="delimiter">)</span>;
            matcher.matches<span class="delimiter">(</span><span class="delimiter">)</span>;
            toAdd = Integer.parseInt<span class="delimiter">(</span>matcher.group<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">if</span> <span class="delimiter">(</span>toAdd == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span><span class="string">&quot;Invalid duration pattern : &quot;</span> + duration<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">return</span> toAdd;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Parses a CRON expression.
     *
     * @param cron the CRON String
     * @return the next &lt;code&gt;Date&lt;/code&gt; that satisfies the expression
     */</span>
    public static Date <a title="(cron: java.lang.String)java.util.Date" id="385721">parseCRONExpression</a><span class="delimiter">(</span>String <a title="java.lang.String" id="385732">cron</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">new</span> CronExpression<span class="delimiter">(</span>cron<span class="delimiter">)</span>.getNextValidTimeAfter<span class="delimiter">(</span><span class="keyword">new</span> Date<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span><span class="string">&quot;Invalid CRON pattern : &quot;</span> + cron, e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Computes the number of milliseconds between the next valid date and the one after.
     * 
     * @param cron the CRON String
     * @return the number of milliseconds between the next valid date and the one after,
     * with an invalid interval between
     */</span>
    public static long <a title="(cron: java.lang.String)Long" id="385722">cronInterval</a><span class="delimiter">(</span>String <a title="java.lang.String" id="385734">cron</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">return</span> cronInterval<span class="delimiter">(</span>cron, <span class="keyword">new</span> Date<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Compute the number of milliseconds between the next valid date and the one after.
     * 
     * @param cron the CRON String
     * @param date the date to start search
     * @return the number of milliseconds between the next valid date and the one after,
     * with an invalid interval between
     */</span>
    public static long <a title="(cron: java.lang.String, date: java.util.Date)Long" id="385723">cronInterval</a><span class="delimiter">(</span>String <a title="java.lang.String" id="385736">cron</a>, Date <a title="java.util.Date" id="385737">date</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span class="keyword">try</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="keyword">new</span> CronExpression<span class="delimiter">(</span>cron<span class="delimiter">)</span>.getNextInterval<span class="delimiter">(</span>date<span class="delimiter">)</span>;
        <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception e<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span><span class="string">&quot;Invalid CRON pattern : &quot;</span> + cron, e<span class="delimiter">)</span>;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Thanks to Quartz project, https://quartz.dev.java.net
     * &lt;P&gt;
     * Provides a parser and evaluator for unix-like cron expressions. Cron 
     * expressions provide the ability to specify complex time combinations such as
     * &amp;quot;At 8:00am every Monday through Friday&amp;quot; or &amp;quot;At 1:30am every 
     * last Friday of the month&amp;quot;. 
     * &lt;P&gt;
     * Cron expressions are comprised of 6 required fields and one optional field
     * separated by white space. The fields respectively are described as follows:
     * 
     * &lt;table cellspacing=&quot;8&quot;&gt;
     * &lt;tr&gt;
     * &lt;th align=&quot;left&quot;&gt;Field Name&lt;/th&gt;
     * &lt;th align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;th align=&quot;left&quot;&gt;Allowed Values&lt;/th&gt;
     * &lt;th align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;th align=&quot;left&quot;&gt;Allowed Special Characters&lt;/th&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Seconds&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;0-59&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * /&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Minutes&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;0-59&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * /&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Hours&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;0-23&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * /&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Day-of-month&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;1-31&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * ? / L W&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Month&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;1-12 or JAN-DEC&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * /&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Day-of-Week&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;1-7 or SUN-SAT&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * ? / L #&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;tr&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;Year (Optional)&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;empty, 1970-2099&lt;/code&gt;&lt;/td&gt;
     * &lt;td align=&quot;left&quot;&gt;&amp;nbsp;&lt;/th&gt;
     * &lt;td align=&quot;left&quot;&gt;&lt;code&gt;, - * /&lt;/code&gt;&lt;/td&gt;
     * &lt;/tr&gt;
     * &lt;/table&gt;
     * &lt;P&gt;
     * The '*' character is used to specify all values. For example, &amp;quot;*&amp;quot; 
     * in the minute field means &amp;quot;every minute&amp;quot;.
     * &lt;P&gt;
     * The '?' character is allowed for the day-of-month and day-of-week fields. It
     * is used to specify 'no specific value'. This is useful when you need to
     * specify something in one of the two fileds, but not the other.
     * &lt;P&gt;
     * The '-' character is used to specify ranges For example &amp;quot;10-12&amp;quot; in
     * the hour field means &amp;quot;the hours 10, 11 and 12&amp;quot;.
     * &lt;P&gt;
     * The ',' character is used to specify additional values. For example
     * &amp;quot;MON,WED,FRI&amp;quot; in the day-of-week field means &amp;quot;the days Monday,
     * Wednesday, and Friday&amp;quot;.
     * &lt;P&gt;
     * The '/' character is used to specify increments. For example &amp;quot;0/15&amp;quot;
     * in the seconds field means &amp;quot;the seconds 0, 15, 30, and 45&amp;quot;. And 
     * &amp;quot;5/15&amp;quot; in the seconds field means &amp;quot;the seconds 5, 20, 35, and
     * 50&amp;quot;.  Specifying '*' before the  '/' is equivalent to specifying 0 is
     * the value to start with. Essentially, for each field in the expression, there
     * is a set of numbers that can be turned on or off. For seconds and minutes, 
     * the numbers range from 0 to 59. For hours 0 to 23, for days of the month 0 to
     * 31, and for months 1 to 12. The &amp;quot;/&amp;quot; character simply helps you turn
     * on every &amp;quot;nth&amp;quot; value in the given set. Thus &amp;quot;7/6&amp;quot; in the
     * month field only turns on month &amp;quot;7&amp;quot;, it does NOT mean every 6th 
     * month, please note that subtlety.  
     * &lt;P&gt;
     * The 'L' character is allowed for the day-of-month and day-of-week fields.
     * This character is short-hand for &amp;quot;last&amp;quot;, but it has different 
     * meaning in each of the two fields. For example, the value &amp;quot;L&amp;quot; in 
     * the day-of-month field means &amp;quot;the last day of the month&amp;quot; - day 31 
     * for January, day 28 for February on non-leap years. If used in the 
     * day-of-week field by itself, it simply means &amp;quot;7&amp;quot; or 
     * &amp;quot;SAT&amp;quot;. But if used in the day-of-week field after another value, it
     * means &amp;quot;the last xxx day of the month&amp;quot; - for example &amp;quot;6L&amp;quot;
     * means &amp;quot;the last friday of the month&amp;quot;. When using the 'L' option, it
     * is important not to specify lists, or ranges of values, as you'll get 
     * confusing results.
     * &lt;P&gt;
     * The 'W' character is allowed for the day-of-month field.  This character 
     * is used to specify the weekday (Monday-Friday) nearest the given day.  As an 
     * example, if you were to specify &amp;quot;15W&amp;quot; as the value for the 
     * day-of-month field, the meaning is: &amp;quot;the nearest weekday to the 15th of
     * the month&amp;quot;. So if the 15th is a Saturday, the trigger will fire on 
     * Friday the 14th. If the 15th is a Sunday, the trigger will fire on Monday the
     * 16th. If the 15th is a Tuesday, then it will fire on Tuesday the 15th. 
     * However if you specify &amp;quot;1W&amp;quot; as the value for day-of-month, and the
     * 1st is a Saturday, the trigger will fire on Monday the 3rd, as it will not 
     * 'jump' over the boundary of a month's days.  The 'W' character can only be 
     * specified when the day-of-month is a single day, not a range or list of days.
     * &lt;P&gt;
     * The 'L' and 'W' characters can also be combined for the day-of-month 
     * expression to yield 'LW', which translates to &amp;quot;last weekday of the 
     * month&amp;quot;.
     * &lt;P&gt;
     * The '#' character is allowed for the day-of-week field. This character is
     * used to specify &amp;quot;the nth&amp;quot; xxx day of the month. For example, the 
     * value of &amp;quot;6#3&amp;quot; in the day-of-week field means the third Friday of 
     * the month (day 6 = Friday and &amp;quot;#3&amp;quot; = the 3rd one in the month). 
     * Other examples: &amp;quot;2#1&amp;quot; = the first Monday of the month and 
     * &amp;quot;4#5&amp;quot; = the fifth Wednesday of the month. Note that if you specify
     * &amp;quot;#5&amp;quot; and there is not 5 of the given day-of-week in the month, then
     * no firing will occur that month.
     * &lt;P&gt;
     * &lt;!--The 'C' character is allowed for the day-of-month and day-of-week fields.
     * This character is short-hand for &quot;calendar&quot;. This means values are
     * calculated against the associated calendar, if any. If no calendar is
     * associated, then it is equivalent to having an all-inclusive calendar. A
     * value of &quot;5C&quot; in the day-of-month field means &quot;the first day included by the
     * calendar on or after the 5th&quot;. A value of &quot;1C&quot; in the day-of-week field
     * means &quot;the first day included by the calendar on or after sunday&quot;.--&gt;
     * &lt;P&gt;
     * The legal characters and the names of months and days of the week are not
     * case sensitive.
     * 
     * &lt;p&gt;
     * &lt;b&gt;NOTES:&lt;/b&gt;
     * &lt;ul&gt;
     * &lt;li&gt;Support for specifying both a day-of-week and a day-of-month value is
     * not complete (you'll need to use the '?' character in on of these fields).
     * &lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;/p&gt;
     * 
     * 
     * @author Sharada Jambula, James House
     * @author Contributions from Mads Henderson
     * @author Refactoring from CronTrigger to CronExpression by Aaron Craven
     */</span>
    public static <span class="keyword">class</span> <a title="object play.libs.Time.CronExpression" id="385726">CronExpression</a> implements Serializable, Cloneable <span class="delimiter">{</span>

        <span class="keyword">private</span> static <span class="keyword">final</span> long <a title="Long" id="385740">serialVersionUID</a> = <span class="long">12423409423L</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385741">SECOND</a> = <span class="int">0</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385742">MINUTE</a> = <span class="int">1</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385743">HOUR</a> = <span class="int">2</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385744">DAY_OF_MONTH</a> = <span class="int">3</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385745">MONTH</a> = <span class="int">4</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385746">DAY_OF_WEEK</a> = <span class="int">5</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385747">YEAR</a> = <span class="int">6</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385748">ALL_SPEC_INT</a> = <span class="int">99</span>; <span class="comment">// '*'</span>
        <span class="keyword">protected</span> static <span class="keyword">final</span> int <a title="Int" id="385749">NO_SPEC_INT</a> = <span class="int">98</span>; <span class="comment">// '?'</span>
        <span class="keyword">protected</span> static <span class="keyword">final</span> Integer <a title="java.lang.Integer" id="385750">ALL_SPEC</a> = <span class="keyword">new</span> Integer<span class="delimiter">(</span>ALL_SPEC_INT<span class="delimiter">)</span>;
        <span class="keyword">protected</span> static <span class="keyword">final</span> Integer <a title="java.lang.Integer" id="385751">NO_SPEC</a> = <span class="keyword">new</span> Integer<span class="delimiter">(</span>NO_SPEC_INT<span class="delimiter">)</span>;
        <span class="keyword">protected</span> static Map&lt;String, Integer&gt; <a title="java.util.Map[java.lang.String,java.lang.Integer]" id="385752">monthMap</a> = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;<span class="delimiter">(</span><span class="int">20</span><span class="delimiter">)</span>;
        <span class="keyword">protected</span> static Map&lt;String, Integer&gt; <a title="java.util.Map[java.lang.String,java.lang.Integer]" id="385753">dayMap</a> = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;<span class="delimiter">(</span><span class="int">60</span><span class="delimiter">)</span>;

        static <span class="delimiter">{</span>
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;JAN&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;FEB&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;MAR&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">2</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;APR&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">3</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;MAY&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">4</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;JUN&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">5</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;JUL&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">6</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;AUG&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">7</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;SEP&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">8</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;OCT&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">9</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;NOV&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">10</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            monthMap.put<span class="delimiter">(</span><span class="string">&quot;DEC&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">11</span><span class="delimiter">)</span><span class="delimiter">)</span>;

            dayMap.put<span class="delimiter">(</span><span class="string">&quot;SUN&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;MON&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">2</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;TUE&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">3</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;WED&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">4</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;THU&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">5</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;FRI&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">6</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            dayMap.put<span class="delimiter">(</span><span class="string">&quot;SAT&quot;</span>, <span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="int">7</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>
        <span class="keyword">private</span> String cronExpression = <span class="keyword">null</span>;
        <span class="keyword">private</span> TimeZone timeZone = <span class="keyword">null</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">seconds</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">minutes</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">hours</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">daysOfMonth</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">months</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">daysOfWeek</span>;
        <span class="keyword">protected</span> transient TreeSet&lt;Integer&gt; <span title="">years</span>;
        <span class="keyword">protected</span> transient boolean <span title="">lastdayOfWeek</span> = <span class="keyword">false</span>;
        <span class="keyword">protected</span> transient int <span title="">nthdayOfWeek</span> = <span class="int">0</span>;
        <span class="keyword">protected</span> transient boolean <span title="">lastdayOfMonth</span> = <span class="keyword">false</span>;
        <span class="keyword">protected</span> transient boolean <span title="">nearestWeekday</span> = <span class="keyword">false</span>;
        <span class="keyword">protected</span> transient boolean <span title="">expressionParsed</span> = <span class="keyword">false</span>;

        <span class="comment">/**
         * Constructs a new &lt;CODE&gt;CronExpression&lt;/CODE&gt; based on the specified 
         * parameter.
         * 
         * @param cronExpression String representation of the cron expression the
         *                       new object should represent
         * @throws java.text.ParseException
         *         if the string expression cannot be parsed into a valid 
         *         &lt;CODE&gt;CronExpression&lt;/CODE&gt;
         */</span>
        public CronExpression<span class="delimiter">(</span>String cronExpression<span class="delimiter">)</span> throws ParseException <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>cronExpression == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span><span class="string">&quot;cronExpression cannot be null&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            <span class="keyword">this</span>.cronExpression = cronExpression;

            buildExpression<span class="delimiter">(</span>cronExpression.toUpperCase<span class="delimiter">(</span>Locale.US<span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Indicates whether the given date satisfies the cron expression. Note that
         * milliseconds are ignored, so two Dates falling on different milliseconds
         * of the same second will always have the same result here.
         * 
         * @param date the date to evaluate
         * @return a boolean indicating whether the given date satisfies the cron
         *         expression
         */</span>
        public boolean isSatisfiedBy<span class="delimiter">(</span>Date date<span class="delimiter">)</span> <span class="delimiter">{</span>
            Calendar testDateCal = Calendar.getInstance<span class="delimiter">(</span><span class="delimiter">)</span>;
            testDateCal.setTime<span class="delimiter">(</span>date<span class="delimiter">)</span>;
            testDateCal.set<span class="delimiter">(</span>Calendar.MILLISECOND, <span class="int">0</span><span class="delimiter">)</span>;
            Date originalDate = testDateCal.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;

            testDateCal.add<span class="delimiter">(</span>Calendar.SECOND, -<span class="int">1</span><span class="delimiter">)</span>;

            Date timeAfter = getTimeAfter<span class="delimiter">(</span>testDateCal.getTime<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;

            <span class="keyword">return</span> <span class="delimiter">(</span><span class="delimiter">(</span>timeAfter != <span class="keyword">null</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>timeAfter.equals<span class="delimiter">(</span>originalDate<span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Returns the next date/time &lt;I&gt;after&lt;/I&gt; the given date/time which
         * satisfies the cron expression.
         * 
         * @param date the date/time at which to begin the search for the next valid
         *             date/time
         * @return the next valid date/time
         */</span>
        public Date getNextValidTimeAfter<span class="delimiter">(</span>Date date<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> getTimeAfter<span class="delimiter">(</span>date<span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Returns the next date/time &lt;I&gt;after&lt;/I&gt; the given date/time which does
         * &lt;I&gt;not&lt;/I&gt; satisfy the expression
         * 
         * @param date the date/time at which to begin the search for the next 
         *             invalid date/time
         * @return the next valid date/time
         */</span>
        public Date getNextInvalidTimeAfter<span class="delimiter">(</span>Date date<span class="delimiter">)</span> <span class="delimiter">{</span>
            long difference = <span class="int">1000</span>;

            <span class="comment">//move back to the nearest second so differences will be accurate</span>
            Calendar adjustCal = Calendar.getInstance<span class="delimiter">(</span><span class="delimiter">)</span>;
            adjustCal.setTime<span class="delimiter">(</span>date<span class="delimiter">)</span>;
            adjustCal.set<span class="delimiter">(</span>Calendar.MILLISECOND, <span class="int">0</span><span class="delimiter">)</span>;
            Date lastDate = adjustCal.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;

            Date newDate = <span class="keyword">null</span>;

            <span class="comment">//keep getting the next included time until it's farther than one second</span>
            <span class="comment">// apart. At that point, lastDate is the last valid fire time. We return</span>
            <span class="comment">// the second immediately following it.</span>
            <span class="keyword">while</span> <span class="delimiter">(</span>difference == <span class="int">1000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                newDate = getTimeAfter<span class="delimiter">(</span>lastDate<span class="delimiter">)</span>;

                difference = newDate.getTime<span class="delimiter">(</span><span class="delimiter">)</span> - lastDate.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;

                <span class="keyword">if</span> <span class="delimiter">(</span>difference == <span class="int">1000</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    lastDate = newDate;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">return</span> <span class="keyword">new</span> Date<span class="delimiter">(</span>lastDate.getTime<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="int">1000</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Return the interval between the next valid date and the one after
         * @param date the date/time at which to begin the search
         * @return the number of milliseconds between the next valid and the one after
         */</span>
        public long getNextInterval<span class="delimiter">(</span>Date date<span class="delimiter">)</span> <span class="delimiter">{</span>
            Date nextValid = getNextValidTimeAfter<span class="delimiter">(</span>date<span class="delimiter">)</span>;
            Date nextInvalid = getNextInvalidTimeAfter<span class="delimiter">(</span>nextValid<span class="delimiter">)</span>;
            Date nextNextValid = getNextValidTimeAfter<span class="delimiter">(</span>nextInvalid<span class="delimiter">)</span>;
            <span class="keyword">return</span> nextNextValid.getTime<span class="delimiter">(</span><span class="delimiter">)</span> - nextValid.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Returns the time zone for which this &lt;code&gt;CronExpression&lt;/code&gt; 
         * will be resolved.
         */</span>
        public TimeZone getTimeZone<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>timeZone == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                timeZone = TimeZone.getDefault<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> timeZone;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Sets the time zone for which  this &lt;code&gt;CronExpression&lt;/code&gt; 
         * will be resolved.
         */</span>
        public void setTimeZone<span class="delimiter">(</span>TimeZone timeZone<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">this</span>.timeZone = timeZone;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Returns the string representation of the &lt;CODE&gt;CronExpression&lt;/CODE&gt;
         * 
         * @return a string representation of the &lt;CODE&gt;CronExpression&lt;/CODE&gt;
         */</span>
        @Override
        public String toString<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> cronExpression;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Indicates whether the specified cron expression can be parsed into a 
         * valid cron expression
         * 
         * @param cronExpression the expression to evaluate
         * @return a boolean indicating whether the given expression is a valid cron
         *         expression
         */</span>
        public static boolean <a title="(cronExpression: java.lang.String)Boolean" id="385754">isValidExpression</a><span class="delimiter">(</span>String <a title="java.lang.String" id="385755">cronExpression</a><span class="delimiter">)</span> <span class="delimiter">{</span>

            <span class="keyword">try</span> <span class="delimiter">{</span>
                <span class="keyword">new</span> CronExpression<span class="delimiter">(</span>cronExpression<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>ParseException pe<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="keyword">false</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> <span class="keyword">true</span>;
        <span class="delimiter">}</span>
        <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
        <span class="comment">//</span>
        <span class="comment">// Expression Parsing Functions</span>
        <span class="comment">//</span>
        <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
        <span class="keyword">protected</span> void buildExpression<span class="delimiter">(</span>String expression<span class="delimiter">)</span> throws ParseException <span class="delimiter">{</span>
            expressionParsed = <span class="keyword">true</span>;

            <span class="keyword">try</span> <span class="delimiter">{</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>seconds == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    seconds = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>minutes == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    minutes = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>hours == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    hours = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>daysOfMonth == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    daysOfMonth = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>months == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    months = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>daysOfWeek == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    daysOfWeek = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>years == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    years = <span class="keyword">new</span> TreeSet&lt;Integer&gt;<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                int exprOn = SECOND;

                StringTokenizer exprsTok = <span class="keyword">new</span> StringTokenizer<span class="delimiter">(</span>expression, <span class="string">&quot; \t&quot;</span>,
                        <span class="keyword">false</span><span class="delimiter">)</span>;

                <span class="keyword">while</span> <span class="delimiter">(</span>exprsTok.hasMoreTokens<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; exprOn &lt;= YEAR<span class="delimiter">)</span> <span class="delimiter">{</span>
                    String expr = exprsTok.nextToken<span class="delimiter">(</span><span class="delimiter">)</span>.trim<span class="delimiter">(</span><span class="delimiter">)</span>;
                    StringTokenizer vTok = <span class="keyword">new</span> StringTokenizer<span class="delimiter">(</span>expr, <span class="string">&quot;,&quot;</span><span class="delimiter">)</span>;
                    <span class="keyword">while</span> <span class="delimiter">(</span>vTok.hasMoreTokens<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        String v = vTok.nextToken<span class="delimiter">(</span><span class="delimiter">)</span>;
                        storeExpressionVals<span class="delimiter">(</span><span class="int">0</span>, v, exprOn<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>

                    exprOn++;
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>exprOn &lt;= DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Unexpected end of expression.&quot;</span>,
                            expression.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>exprOn &lt;= YEAR<span class="delimiter">)</span> <span class="delimiter">{</span>
                    storeExpressionVals<span class="delimiter">(</span><span class="int">0</span>, <span class="string">&quot;*&quot;</span>, YEAR<span class="delimiter">)</span>;
                <span class="delimiter">}</span>

            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>ParseException pe<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> pe;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception e<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Illegal cron expression format (&quot;</span> + e.toString<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="string">&quot;)&quot;</span>, <span class="int">0</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int storeExpressionVals<span class="delimiter">(</span>int pos, String s, int <span class="keyword">type</span><span class="delimiter">)</span>
        throws ParseException <span class="delimiter">{</span>

            int incr = <span class="int">0</span>;
            int i = skipWhiteSpace<span class="delimiter">(</span>pos, s<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>
            char c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span>c &gt;= <span class="char">'A'</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>c &lt;= <span class="char">'Z'</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>!s.equals<span class="delimiter">(</span><span class="string">&quot;L&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>!s.equals<span class="delimiter">(</span><span class="string">&quot;LW&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                String sub = s.substring<span class="delimiter">(</span>i, i + <span class="int">3</span><span class="delimiter">)</span>;
                int sval = -<span class="int">1</span>;
                int eval = -<span class="int">1</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                    sval = getMonthNumber<span class="delimiter">(</span>sub<span class="delimiter">)</span> + <span class="int">1</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>sval &lt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Invalid Month value: '&quot;</span> + sub + <span class="string">&quot;'&quot;</span>, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>s.length<span class="delimiter">(</span><span class="delimiter">)</span> &gt; i + <span class="int">3</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        c = s.charAt<span class="delimiter">(</span>i + <span class="int">3</span><span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'-'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            i += <span class="int">4</span>;
                            sub = s.substring<span class="delimiter">(</span>i, i + <span class="int">3</span><span class="delimiter">)</span>;
                            eval = getMonthNumber<span class="delimiter">(</span>sub<span class="delimiter">)</span> + <span class="int">1</span>;
                            <span class="keyword">if</span> <span class="delimiter">(</span>eval &lt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Invalid Month value: '&quot;</span> + sub + <span class="string">&quot;'&quot;</span>, i<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                    sval = getDayOfWeekNumber<span class="delimiter">(</span>sub<span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>sval &lt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Invalid Day-of-Week value: '&quot;</span> + sub + <span class="string">&quot;'&quot;</span>, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>s.length<span class="delimiter">(</span><span class="delimiter">)</span> &gt; i + <span class="int">3</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        c = s.charAt<span class="delimiter">(</span>i + <span class="int">3</span><span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'-'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            i += <span class="int">4</span>;
                            sub = s.substring<span class="delimiter">(</span>i, i + <span class="int">3</span><span class="delimiter">)</span>;
                            eval = getDayOfWeekNumber<span class="delimiter">(</span>sub<span class="delimiter">)</span>;
                            <span class="keyword">if</span> <span class="delimiter">(</span>eval &lt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                                        <span class="string">&quot;Invalid Day-of-Week value: '&quot;</span> + sub + <span class="string">&quot;'&quot;</span>, i<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                            <span class="keyword">if</span> <span class="delimiter">(</span>sval &gt; eval<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                                        <span class="string">&quot;Invalid Day-of-Week sequence: &quot;</span> + sval + <span class="string">&quot; &gt; &quot;</span> + eval, i<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'#'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            <span class="keyword">try</span> <span class="delimiter">{</span>
                                i += <span class="int">4</span>;
                                nthdayOfWeek = Integer.parseInt<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>i<span class="delimiter">)</span><span class="delimiter">)</span>;
                                <span class="keyword">if</span> <span class="delimiter">(</span>nthdayOfWeek &lt; <span class="int">1</span> || nthdayOfWeek &gt; <span class="int">5</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                    <span class="keyword">throw</span> <span class="keyword">new</span> Exception<span class="delimiter">(</span><span class="delimiter">)</span>;
                                <span class="delimiter">}</span>
                            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception e<span class="delimiter">)</span> <span class="delimiter">{</span>
                                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                                        <span class="string">&quot;A numeric value between 1 and 5 must follow the '#' option&quot;</span>,
                                        i<span class="delimiter">)</span>;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'L'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            lastdayOfWeek = <span class="keyword">true</span>;
                            i++;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>

                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Illegal characters for this position: '&quot;</span> + sub + <span class="string">&quot;'&quot;</span>,
                            i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>eval != -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    incr = <span class="int">1</span>;
                <span class="delimiter">}</span>
                addToSet<span class="delimiter">(</span>sval, eval, incr, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="keyword">return</span> <span class="delimiter">(</span>i + <span class="int">3</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'?'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span> != <span class="char">' '</span> &amp;&amp; s.charAt<span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> != <span class="char">'\t'</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Illegal character after '?': &quot;</span> + s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> != DAY_OF_WEEK &amp;&amp; <span class="keyword">type</span> != DAY_OF_MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;'?' can only be specfied for Day-of-Month or Day-of-Week.&quot;</span>,
                            i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK &amp;&amp; !lastdayOfMonth<span class="delimiter">)</span> <span class="delimiter">{</span>
                    int <span class="keyword">val</span> = daysOfMonth.last<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">val</span> == NO_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                                <span class="string">&quot;'?' can only be specfied for Day-of-Month -OR- Day-of-Week.&quot;</span>,
                                i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>

                addToSet<span class="delimiter">(</span>NO_SPEC_INT, -<span class="int">1</span>, <span class="int">0</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'*'</span> || c == <span class="char">'/'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'*'</span> &amp;&amp; <span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span>ALL_SPEC_INT, -<span class="int">1</span>, incr, <span class="keyword">type</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> i + <span class="int">1</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'/'</span> &amp;&amp; <span class="delimiter">(</span><span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span> || s.charAt<span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> == <span class="char">' '</span> || s.charAt<span class="delimiter">(</span>i + <span class="int">1</span><span class="delimiter">)</span> == <span class="char">'\t'</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;'/' must be followed by an integer.&quot;</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'*'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    i++;
                <span class="delimiter">}</span>
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'/'</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// is an increment specified?</span>
                    i++;
                    <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Unexpected end of string.&quot;</span>, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>

                    incr = getNumericValue<span class="delimiter">(</span>s, i<span class="delimiter">)</span>;

                    i++;
                    <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">10</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        i++;
                    <span class="delimiter">}</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">59</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">type</span> == SECOND || <span class="keyword">type</span> == MINUTE<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Increment &gt; 60 : &quot;</span> + incr, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">23</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">type</span> == HOUR<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Increment &gt; 24 : &quot;</span> + incr, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">31</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Increment &gt; 31 : &quot;</span> + incr, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">7</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Increment &gt; 7 : &quot;</span> + incr, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>incr &gt; <span class="int">12</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">type</span> == MONTH<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Increment &gt; 12 : &quot;</span> + incr, i<span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    incr = <span class="int">1</span>;
                <span class="delimiter">}</span>

                addToSet<span class="delimiter">(</span>ALL_SPEC_INT, -<span class="int">1</span>, incr, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'L'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                    lastdayOfMonth = <span class="keyword">true</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span><span class="int">7</span>, <span class="int">7</span>, <span class="int">0</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH &amp;&amp; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &gt; i<span class="delimiter">)</span> <span class="delimiter">{</span>
                    c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'W'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        nearestWeekday = <span class="keyword">true</span>;
                        i++;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span>
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                int <span class="keyword">val</span> = Integer.parseInt<span class="delimiter">(</span>String.valueOf<span class="delimiter">(</span>c<span class="delimiter">)</span><span class="delimiter">)</span>;
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span><span class="keyword">val</span>, -<span class="int">1</span>, -<span class="int">1</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        ValueSet vs = getValue<span class="delimiter">(</span><span class="keyword">val</span>, s, i<span class="delimiter">)</span>;
                        <span class="keyword">val</span> = vs.value;
                        i = vs.pos;
                    <span class="delimiter">}</span>
                    i = checkNext<span class="delimiter">(</span>i, s, <span class="keyword">val</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> i;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Unexpected character: &quot;</span> + c, i<span class="delimiter">)</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> i;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int checkNext<span class="delimiter">(</span>int pos, String s, int <span class="keyword">val</span>, int <span class="keyword">type</span><span class="delimiter">)</span>
        throws ParseException <span class="delimiter">{</span>

            int end = -<span class="int">1</span>;
            int i = pos;

            <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, -<span class="int">1</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>

            char c = s.charAt<span class="delimiter">(</span>pos<span class="delimiter">)</span>;

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'L'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                    lastdayOfWeek = <span class="keyword">true</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;'L' option is not valid here. (pos=&quot;</span> + i + <span class="string">&quot;)&quot;</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                TreeSet&lt;Integer&gt; set = getSet<span class="delimiter">(</span><span class="keyword">type</span><span class="delimiter">)</span>;
                set.add<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                i++;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'W'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                    nearestWeekday = <span class="keyword">true</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;'W' option is not valid here. (pos=&quot;</span> + i + <span class="string">&quot;)&quot;</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                TreeSet&lt;Integer&gt; set = getSet<span class="delimiter">(</span><span class="keyword">type</span><span class="delimiter">)</span>;
                set.add<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                i++;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'#'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> != DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;'#' option is not valid here. (pos=&quot;</span> + i + <span class="string">&quot;)&quot;</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                i++;
                <span class="keyword">try</span> <span class="delimiter">{</span>
                    nthdayOfWeek = Integer.parseInt<span class="delimiter">(</span>s.substring<span class="delimiter">(</span>i<span class="delimiter">)</span><span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>nthdayOfWeek &lt; <span class="int">1</span> || nthdayOfWeek &gt; <span class="int">5</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception e<span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;A numeric value between 1 and 5 must follow the '#' option&quot;</span>,
                            i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                TreeSet&lt;Integer&gt; set = getSet<span class="delimiter">(</span><span class="keyword">type</span><span class="delimiter">)</span>;
                set.add<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                i++;
                <span class="keyword">return</span> i;
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'-'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                i++;
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                int v = Integer.parseInt<span class="delimiter">(</span>String.valueOf<span class="delimiter">(</span>c<span class="delimiter">)</span><span class="delimiter">)</span>;
                end = v;
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, <span class="int">1</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> i;
                <span class="delimiter">}</span>
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    ValueSet vs = getValue<span class="delimiter">(</span>v, s, i<span class="delimiter">)</span>;
                    int v1 = vs.value;
                    end = v1;
                    i = vs.pos;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>i &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="delimiter">(</span>c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span><span class="delimiter">)</span> == <span class="char">'/'</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    i++;
                    c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                    int v2 = Integer.parseInt<span class="delimiter">(</span>String.valueOf<span class="delimiter">(</span>c<span class="delimiter">)</span><span class="delimiter">)</span>;
                    i++;
                    <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, v2, <span class="keyword">type</span><span class="delimiter">)</span>;
                        <span class="keyword">return</span> i;
                    <span class="delimiter">}</span>
                    c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        ValueSet vs = getValue<span class="delimiter">(</span>v2, s, i<span class="delimiter">)</span>;
                        int v3 = vs.value;
                        addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, v3, <span class="keyword">type</span><span class="delimiter">)</span>;
                        i = vs.pos;
                        <span class="keyword">return</span> i;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, v2, <span class="keyword">type</span><span class="delimiter">)</span>;
                        <span class="keyword">return</span> i;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, <span class="int">1</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> i;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>c == <span class="char">'/'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                i++;
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                int v2 = Integer.parseInt<span class="delimiter">(</span>String.valueOf<span class="delimiter">(</span>c<span class="delimiter">)</span><span class="delimiter">)</span>;
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, v2, <span class="keyword">type</span><span class="delimiter">)</span>;
                    <span class="keyword">return</span> i;
                <span class="delimiter">}</span>
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    ValueSet vs = getValue<span class="delimiter">(</span>v2, s, i<span class="delimiter">)</span>;
                    int v3 = vs.value;
                    addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, v3, <span class="keyword">type</span><span class="delimiter">)</span>;
                    i = vs.pos;
                    <span class="keyword">return</span> i;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span><span class="string">&quot;Unexpected character '&quot;</span> + c + <span class="string">&quot;' after '/'&quot;</span>, i<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            addToSet<span class="delimiter">(</span><span class="keyword">val</span>, end, <span class="int">0</span>, <span class="keyword">type</span><span class="delimiter">)</span>;
            i++;
            <span class="keyword">return</span> i;
        <span class="delimiter">}</span>

        public String getCronExpression<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> cronExpression;
        <span class="delimiter">}</span>

        public String getExpressionSummary<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            StringBuffer buf = <span class="keyword">new</span> StringBuffer<span class="delimiter">(</span><span class="delimiter">)</span>;

            buf.append<span class="delimiter">(</span><span class="string">&quot;seconds: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>seconds<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;minutes: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>minutes<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;hours: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>hours<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;daysOfMonth: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>daysOfMonth<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;months: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>months<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;daysOfWeek: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>daysOfWeek<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;lastdayOfWeek: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>lastdayOfWeek<span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;nearestWeekday: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>nearestWeekday<span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;NthDayOfWeek: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>nthdayOfWeek<span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;lastdayOfMonth: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>lastdayOfMonth<span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;years: &quot;</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span>getExpressionSetSummary<span class="delimiter">(</span>years<span class="delimiter">)</span><span class="delimiter">)</span>;
            buf.append<span class="delimiter">(</span><span class="string">&quot;\n&quot;</span><span class="delimiter">)</span>;

            <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> String getExpressionSetSummary<span class="delimiter">(</span>java.util.Set&lt;Integer&gt; set<span class="delimiter">)</span> <span class="delimiter">{</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>set.contains<span class="delimiter">(</span>NO_SPEC<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="string">&quot;?&quot;</span>;
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>set.contains<span class="delimiter">(</span>ALL_SPEC<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="string">&quot;*&quot;</span>;
            <span class="delimiter">}</span>

            StringBuffer buf = <span class="keyword">new</span> StringBuffer<span class="delimiter">(</span><span class="delimiter">)</span>;

            Iterator&lt;Integer&gt; itr = set.iterator<span class="delimiter">(</span><span class="delimiter">)</span>;
            boolean first = <span class="keyword">true</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>itr.hasNext<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                Integer iVal = itr.next<span class="delimiter">(</span><span class="delimiter">)</span>;
                String <span class="keyword">val</span> = iVal.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>!first<span class="delimiter">)</span> <span class="delimiter">{</span>
                    buf.append<span class="delimiter">(</span><span class="string">&quot;,&quot;</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                buf.append<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span>;
                first = <span class="keyword">false</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> String getExpressionSetSummary<span class="delimiter">(</span>java.util.ArrayList&lt;Integer&gt; list<span class="delimiter">)</span> <span class="delimiter">{</span>

            <span class="keyword">if</span> <span class="delimiter">(</span>list.contains<span class="delimiter">(</span>NO_SPEC<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="string">&quot;?&quot;</span>;
            <span class="delimiter">}</span>
            <span class="keyword">if</span> <span class="delimiter">(</span>list.contains<span class="delimiter">(</span>ALL_SPEC<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> <span class="string">&quot;*&quot;</span>;
            <span class="delimiter">}</span>

            StringBuffer buf = <span class="keyword">new</span> StringBuffer<span class="delimiter">(</span><span class="delimiter">)</span>;

            Iterator&lt;Integer&gt; itr = list.iterator<span class="delimiter">(</span><span class="delimiter">)</span>;
            boolean first = <span class="keyword">true</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>itr.hasNext<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                Integer iVal = itr.next<span class="delimiter">(</span><span class="delimiter">)</span>;
                String <span class="keyword">val</span> = iVal.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>!first<span class="delimiter">)</span> <span class="delimiter">{</span>
                    buf.append<span class="delimiter">(</span><span class="string">&quot;,&quot;</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                buf.append<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span>;
                first = <span class="keyword">false</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> buf.toString<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int skipWhiteSpace<span class="delimiter">(</span>int i, String s<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span>; i &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span> == <span class="char">' '</span> || s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span> == <span class="char">'\t'</span><span class="delimiter">)</span>; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="delimiter">}</span>

            <span class="keyword">return</span> i;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int findNextWhiteSpace<span class="delimiter">(</span>int i, String s<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">for</span> <span class="delimiter">(</span>; i &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span>s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span> != <span class="char">' '</span> || s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span> != <span class="char">'\t'</span><span class="delimiter">)</span>; i++<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="delimiter">}</span>

            <span class="keyword">return</span> i;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> void addToSet<span class="delimiter">(</span>int <span class="keyword">val</span>, int end, int incr, int <span class="keyword">type</span><span class="delimiter">)</span>
        throws ParseException <span class="delimiter">{</span>

            TreeSet&lt;Integer&gt; set = getSet<span class="delimiter">(</span><span class="keyword">type</span><span class="delimiter">)</span>;

            <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == SECOND || <span class="keyword">type</span> == MINUTE<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><span class="keyword">val</span> &lt; <span class="int">0</span> || <span class="keyword">val</span> &gt; <span class="int">59</span> || end &gt; <span class="int">59</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Minute and Second values must be between 0 and 59&quot;</span>,
                            -<span class="int">1</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == HOUR<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><span class="keyword">val</span> &lt; <span class="int">0</span> || <span class="keyword">val</span> &gt; <span class="int">23</span> || end &gt; <span class="int">23</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Hour values must be between 0 and 23&quot;</span>, -<span class="int">1</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><span class="keyword">val</span> &lt; <span class="int">1</span> || <span class="keyword">val</span> &gt; <span class="int">31</span> || end &gt; <span class="int">31</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != NO_SPEC_INT<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Day of month values must be between 1 and 31&quot;</span>, -<span class="int">1</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><span class="keyword">val</span> &lt; <span class="int">1</span> || <span class="keyword">val</span> &gt; <span class="int">12</span> || end &gt; <span class="int">12</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Month values must be between 1 and 12&quot;</span>, -<span class="int">1</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span><span class="keyword">val</span> == <span class="int">0</span> || <span class="keyword">val</span> &gt; <span class="int">7</span> || end &gt; <span class="int">7</span><span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span> &amp;&amp; <span class="delimiter">(</span><span class="keyword">val</span> != NO_SPEC_INT<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> ParseException<span class="delimiter">(</span>
                            <span class="string">&quot;Day-of-Week values must be between 1 and 7&quot;</span>, -<span class="int">1</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span><span class="delimiter">(</span>incr == <span class="int">0</span> || incr == -<span class="int">1</span><span class="delimiter">)</span> &amp;&amp; <span class="keyword">val</span> != ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">val</span> != -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    set.add<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    set.add<span class="delimiter">(</span>NO_SPEC<span class="delimiter">)</span>;
                <span class="delimiter">}</span>

                <span class="keyword">return</span>;
            <span class="delimiter">}</span>

            int startAt = <span class="keyword">val</span>;
            int stopAt = end;

            <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">val</span> == ALL_SPEC_INT &amp;&amp; incr &lt;= <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                incr = <span class="int">1</span>;
                set.add<span class="delimiter">(</span>ALL_SPEC<span class="delimiter">)</span>; <span class="comment">// put in a marker, but also fill values</span>
            <span class="delimiter">}</span>

            <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == SECOND || <span class="keyword">type</span> == MINUTE<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">59</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">0</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == HOUR<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">23</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">0</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">31</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">1</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == MONTH<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">12</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">1</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == DAY_OF_WEEK<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">7</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">1</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span><span class="keyword">type</span> == YEAR<span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>stopAt == -<span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    stopAt = <span class="int">2099</span>;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>startAt == -<span class="int">1</span> || startAt == ALL_SPEC_INT<span class="delimiter">)</span> <span class="delimiter">{</span>
                    startAt = <span class="int">1970</span>;
                <span class="delimiter">}</span>
            <span class="delimiter">}</span>

            <span class="keyword">for</span> <span class="delimiter">(</span>int i = startAt; i &lt;= stopAt; i += incr<span class="delimiter">)</span> <span class="delimiter">{</span>
                set.add<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>i<span class="delimiter">)</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> TreeSet&lt;Integer&gt; getSet<span class="delimiter">(</span>int <span class="keyword">type</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            switch <span class="delimiter">(</span><span class="keyword">type</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> SECOND:
                <span class="keyword">return</span> seconds;
            <span class="keyword">case</span> MINUTE:
                <span class="keyword">return</span> minutes;
            <span class="keyword">case</span> HOUR:
                <span class="keyword">return</span> hours;
            <span class="keyword">case</span> DAY_OF_MONTH:
                <span class="keyword">return</span> daysOfMonth;
            <span class="keyword">case</span> MONTH:
                <span class="keyword">return</span> months;
            <span class="keyword">case</span> DAY_OF_WEEK:
                <span class="keyword">return</span> daysOfWeek;
            <span class="keyword">case</span> YEAR:
                <span class="keyword">return</span> years;
            default:
                <span class="keyword">return</span> <span class="keyword">null</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> ValueSet getValue<span class="delimiter">(</span>int v, String s, int i<span class="delimiter">)</span> <span class="delimiter">{</span>
            char c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            String s1 = String.valueOf<span class="delimiter">(</span>v<span class="delimiter">)</span>;
            <span class="keyword">while</span> <span class="delimiter">(</span>c &gt;= <span class="char">'0'</span> &amp;&amp; c &lt;= <span class="char">'9'</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                s1 += c;
                i++;
                <span class="keyword">if</span> <span class="delimiter">(</span>i &gt;= s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    break;
                <span class="delimiter">}</span>
                c = s.charAt<span class="delimiter">(</span>i<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            ValueSet <span class="keyword">val</span> = <span class="keyword">new</span> ValueSet<span class="delimiter">(</span><span class="delimiter">)</span>;

            <span class="keyword">val</span>.pos = <span class="delimiter">(</span>i &lt; s.length<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> ? i : i + <span class="int">1</span>;
            <span class="keyword">val</span>.value = Integer.parseInt<span class="delimiter">(</span>s1<span class="delimiter">)</span>;
            <span class="keyword">return</span> <span class="keyword">val</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int getNumericValue<span class="delimiter">(</span>String s, int i<span class="delimiter">)</span> <span class="delimiter">{</span>
            int endOfVal = findNextWhiteSpace<span class="delimiter">(</span>i, s<span class="delimiter">)</span>;
            String <span class="keyword">val</span> = s.substring<span class="delimiter">(</span>i, endOfVal<span class="delimiter">)</span>;
            <span class="keyword">return</span> Integer.parseInt<span class="delimiter">(</span><span class="keyword">val</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int getMonthNumber<span class="delimiter">(</span>String s<span class="delimiter">)</span> <span class="delimiter">{</span>
            Integer integer = monthMap.get<span class="delimiter">(</span>s<span class="delimiter">)</span>;

            <span class="keyword">if</span> <span class="delimiter">(</span>integer == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> -<span class="int">1</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> integer.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int getDayOfWeekNumber<span class="delimiter">(</span>String s<span class="delimiter">)</span> <span class="delimiter">{</span>
            Integer integer = dayMap.get<span class="delimiter">(</span>s<span class="delimiter">)</span>;

            <span class="keyword">if</span> <span class="delimiter">(</span>integer == <span class="keyword">null</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                <span class="keyword">return</span> -<span class="int">1</span>;
            <span class="delimiter">}</span>

            <span class="keyword">return</span> integer.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
        <span class="comment">//</span>
        <span class="comment">// Computation Functions</span>
        <span class="comment">//</span>
        <span class="comment">////////////////////////////////////////////////////////////////////////////</span>
        <span class="keyword">protected</span> Date getTimeAfter<span class="delimiter">(</span>Date afterTime<span class="delimiter">)</span> <span class="delimiter">{</span>

            Calendar cl = Calendar.getInstance<span class="delimiter">(</span>getTimeZone<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;

            <span class="comment">// move ahead one second, since we're computing the time *after* the</span>
            <span class="comment">// given time</span>
            afterTime = <span class="keyword">new</span> Date<span class="delimiter">(</span>afterTime.getTime<span class="delimiter">(</span><span class="delimiter">)</span> + <span class="int">1000</span><span class="delimiter">)</span>;
            <span class="comment">// CronTrigger does not deal with milliseconds</span>
            cl.setTime<span class="delimiter">(</span>afterTime<span class="delimiter">)</span>;
            cl.set<span class="delimiter">(</span>Calendar.MILLISECOND, <span class="int">0</span><span class="delimiter">)</span>;

            boolean gotOne = <span class="keyword">false</span>;
            <span class="comment">// loop until we've computed the next time, or we've past the endTime</span>
            <span class="keyword">while</span> <span class="delimiter">(</span>!gotOne<span class="delimiter">)</span> <span class="delimiter">{</span>

                <span class="comment">//if (endTime != null &amp;&amp; cl.getTime().after(endTime)) return null;</span>

                SortedSet&lt;Integer&gt; st = <span class="keyword">null</span>;
                int t = <span class="int">0</span>;

                int sec = cl.get<span class="delimiter">(</span>Calendar.SECOND<span class="delimiter">)</span>;
                int min = cl.get<span class="delimiter">(</span>Calendar.MINUTE<span class="delimiter">)</span>;

                <span class="comment">// get second.................................................</span>
                st = seconds.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>sec<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    sec = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    sec = seconds.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    min++;
                    cl.set<span class="delimiter">(</span>Calendar.MINUTE, min<span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.SECOND, sec<span class="delimiter">)</span>;

                min = cl.get<span class="delimiter">(</span>Calendar.MINUTE<span class="delimiter">)</span>;
                int hr = cl.get<span class="delimiter">(</span>Calendar.HOUR_OF_DAY<span class="delimiter">)</span>;
                t = -<span class="int">1</span>;

                <span class="comment">// get minute.................................................</span>
                st = minutes.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>min<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    t = min;
                    min = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    min = minutes.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    hr++;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>min != t<span class="delimiter">)</span> <span class="delimiter">{</span>
                    cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MINUTE, min<span class="delimiter">)</span>;
                    setCalendarHour<span class="delimiter">(</span>cl, hr<span class="delimiter">)</span>;
                    continue;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.MINUTE, min<span class="delimiter">)</span>;

                hr = cl.get<span class="delimiter">(</span>Calendar.HOUR_OF_DAY<span class="delimiter">)</span>;
                int day = cl.get<span class="delimiter">(</span>Calendar.DAY_OF_MONTH<span class="delimiter">)</span>;
                t = -<span class="int">1</span>;

                <span class="comment">// get hour...................................................</span>
                st = hours.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>hr<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    t = hr;
                    hr = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    hr = hours.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    day++;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>hr != t<span class="delimiter">)</span> <span class="delimiter">{</span>
                    cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                    setCalendarHour<span class="delimiter">(</span>cl, hr<span class="delimiter">)</span>;
                    continue;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, hr<span class="delimiter">)</span>;

                day = cl.get<span class="delimiter">(</span>Calendar.DAY_OF_MONTH<span class="delimiter">)</span>;
                int mon = cl.get<span class="delimiter">(</span>Calendar.MONTH<span class="delimiter">)</span> + <span class="int">1</span>;
                <span class="comment">// '+ 1' because calendar is 0-based for this field, and we are</span>
                <span class="comment">// 1-based</span>
                t = -<span class="int">1</span>;
                int tmon = mon;

                <span class="comment">// get day...................................................</span>
                boolean dayOfMSpec = !daysOfMonth.contains<span class="delimiter">(</span>NO_SPEC<span class="delimiter">)</span>;
                boolean dayOfWSpec = !daysOfWeek.contains<span class="delimiter">(</span>NO_SPEC<span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>dayOfMSpec &amp;&amp; !dayOfWSpec<span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// get day by day of month rule</span>
                    st = daysOfMonth.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>day<span class="delimiter">)</span><span class="delimiter">)</span>;
                    <span class="keyword">if</span> <span class="delimiter">(</span>lastdayOfMonth<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>!nearestWeekday<span class="delimiter">)</span> <span class="delimiter">{</span>
                            t = day;
                            day = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                            t = day;
                            day = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;

                            java.util.Calendar tcal = java.util.Calendar.getInstance<span class="delimiter">(</span><span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.YEAR, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;

                            int ldom = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;
                            int dow = tcal.get<span class="delimiter">(</span>Calendar.DAY_OF_WEEK<span class="delimiter">)</span>;

                            <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SATURDAY &amp;&amp; day == <span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                day += <span class="int">2</span>;
                            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SATURDAY<span class="delimiter">)</span> <span class="delimiter">{</span>
                                day -= <span class="int">1</span>;
                            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SUNDAY &amp;&amp; day == ldom<span class="delimiter">)</span> <span class="delimiter">{</span>
                                day -= <span class="int">2</span>;
                            <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SUNDAY<span class="delimiter">)</span> <span class="delimiter">{</span>
                                day += <span class="int">1</span>;
                            <span class="delimiter">}</span>

                            tcal.set<span class="delimiter">(</span>Calendar.SECOND, sec<span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.MINUTE, min<span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, hr<span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                            tcal.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                            Date nTime = tcal.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;
                            <span class="keyword">if</span> <span class="delimiter">(</span>nTime.before<span class="delimiter">(</span>afterTime<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                                day = <span class="int">1</span>;
                                mon++;
                            <span class="delimiter">}</span>
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nearestWeekday<span class="delimiter">)</span> <span class="delimiter">{</span>
                        t = day;
                        day = daysOfMonth.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;

                        java.util.Calendar tcal = java.util.Calendar.getInstance<span class="delimiter">(</span><span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.YEAR, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;

                        int ldom = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;
                        int dow = tcal.get<span class="delimiter">(</span>Calendar.DAY_OF_WEEK<span class="delimiter">)</span>;

                        <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SATURDAY &amp;&amp; day == <span class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            day += <span class="int">2</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SATURDAY<span class="delimiter">)</span> <span class="delimiter">{</span>
                            day -= <span class="int">1</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SUNDAY &amp;&amp; day == ldom<span class="delimiter">)</span> <span class="delimiter">{</span>
                            day -= <span class="int">2</span>;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dow == Calendar.SUNDAY<span class="delimiter">)</span> <span class="delimiter">{</span>
                            day += <span class="int">1</span>;
                        <span class="delimiter">}</span>


                        tcal.set<span class="delimiter">(</span>Calendar.SECOND, sec<span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.MINUTE, min<span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, hr<span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                        tcal.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                        Date nTime = tcal.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>nTime.before<span class="delimiter">(</span>afterTime<span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            day = daysOfMonth.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                            mon++;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        t = day;
                        day = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        day = daysOfMonth.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                        mon++;
                    <span class="delimiter">}</span>

                    <span class="keyword">if</span> <span class="delimiter">(</span>day != t || mon != tmon<span class="delimiter">)</span> <span class="delimiter">{</span>
                        cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                        cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                        cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                        cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                        cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                        <span class="comment">// '- 1' because calendar is 0-based for this field, and we</span>
                        <span class="comment">// are 1-based</span>
                        continue;
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>dayOfWSpec &amp;&amp; !dayOfMSpec<span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// get day by day of week rule</span>
                    <span class="keyword">if</span> <span class="delimiter">(</span>lastdayOfWeek<span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="comment">// are we looking for the last day of the month?</span>
                        int dow = daysOfWeek.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>; <span class="comment">// desired</span>
                        <span class="comment">// d-o-w</span>
                        int cDow = cl.get<span class="delimiter">(</span>Calendar.DAY_OF_WEEK<span class="delimiter">)</span>; <span class="comment">// current d-o-w</span>
                        int daysToAdd = <span class="int">0</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>cDow &lt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow - cDow;
                        <span class="delimiter">}</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>cDow &gt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow + <span class="delimiter">(</span><span class="int">7</span> - cDow<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>

                        int lDay = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;

                        <span class="keyword">if</span> <span class="delimiter">(</span>day + daysToAdd &gt; lDay<span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// did we already miss the</span>
                            <span class="comment">// last one?</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, <span class="int">1</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon<span class="delimiter">)</span>;
                            <span class="comment">// no '- 1' here because we are promoting the month</span>
                            continue;
                        <span class="delimiter">}</span>

                        <span class="comment">// find date of last occurance of this day in this month...</span>
                        <span class="keyword">while</span> <span class="delimiter">(</span><span class="delimiter">(</span>day + daysToAdd + <span class="int">7</span><span class="delimiter">)</span> &lt;= lDay<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd += <span class="int">7</span>;
                        <span class="delimiter">}</span>

                        day += daysToAdd;

                        <span class="keyword">if</span> <span class="delimiter">(</span>daysToAdd &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                            <span class="comment">// '- 1' here because we are not promoting the month</span>
                            continue;
                        <span class="delimiter">}</span>

                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>nthdayOfWeek != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                        <span class="comment">// are we looking for the Nth day in the month?</span>
                        int dow = daysOfWeek.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>; <span class="comment">// desired</span>
                        <span class="comment">// d-o-w</span>
                        int cDow = cl.get<span class="delimiter">(</span>Calendar.DAY_OF_WEEK<span class="delimiter">)</span>; <span class="comment">// current d-o-w</span>
                        int daysToAdd = <span class="int">0</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>cDow &lt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow - cDow;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>cDow &gt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow + <span class="delimiter">(</span><span class="int">7</span> - cDow<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>

                        boolean dayShifted = <span class="keyword">false</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>daysToAdd &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            dayShifted = <span class="keyword">true</span>;
                        <span class="delimiter">}</span>

                        day += daysToAdd;
                        int weekOfMonth = day / <span class="int">7</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>day % <span class="int">7</span> &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            weekOfMonth++;
                        <span class="delimiter">}</span>

                        daysToAdd = <span class="delimiter">(</span>nthdayOfWeek - weekOfMonth<span class="delimiter">)</span> * <span class="int">7</span>;
                        day += daysToAdd;
                        <span class="keyword">if</span> <span class="delimiter">(</span>daysToAdd &lt; <span class="int">0</span> || day &gt; getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, <span class="int">1</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon<span class="delimiter">)</span>;
                            <span class="comment">// no '- 1' here because we are promoting the month</span>
                            continue;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>daysToAdd &gt; <span class="int">0</span> || dayShifted<span class="delimiter">)</span> <span class="delimiter">{</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                            <span class="comment">// '- 1' here because we are NOT promoting the month</span>
                            continue;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                        int cDow = cl.get<span class="delimiter">(</span>Calendar.DAY_OF_WEEK<span class="delimiter">)</span>; <span class="comment">// current d-o-w</span>
                        int dow = daysOfWeek.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>; <span class="comment">// desired</span>
                        <span class="comment">// d-o-w</span>
                        st = daysOfWeek.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>cDow<span class="delimiter">)</span><span class="delimiter">)</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                            dow = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                        <span class="delimiter">}</span>

                        int daysToAdd = <span class="int">0</span>;
                        <span class="keyword">if</span> <span class="delimiter">(</span>cDow &lt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow - cDow;
                        <span class="delimiter">}</span>
                        <span class="keyword">if</span> <span class="delimiter">(</span>cDow &gt; dow<span class="delimiter">)</span> <span class="delimiter">{</span>
                            daysToAdd = dow + <span class="delimiter">(</span><span class="int">7</span> - cDow<span class="delimiter">)</span>;
                        <span class="delimiter">}</span>

                        int lDay = getLastDayOfMonth<span class="delimiter">(</span>mon, cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span><span class="delimiter">)</span>;

                        <span class="keyword">if</span> <span class="delimiter">(</span>day + daysToAdd &gt; lDay<span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// will we pass the end of</span>
                            <span class="comment">// the month?</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, <span class="int">1</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon<span class="delimiter">)</span>;
                            <span class="comment">// no '- 1' here because we are promoting the month</span>
                            continue;
                        <span class="delimiter">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="delimiter">(</span>daysToAdd &gt; <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// are we swithing days?</span>
                            cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day + daysToAdd<span class="delimiter">)</span>;
                            cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                            <span class="comment">// '- 1' because calendar is 0-based for this field,</span>
                            <span class="comment">// and we are 1-based</span>
                            continue;
                        <span class="delimiter">}</span>
                    <span class="delimiter">}</span>
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span> <span class="comment">// dayOfWSpec &amp;&amp; !dayOfMSpec</span>
                    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException<span class="delimiter">(</span>
                    <span class="string">&quot;Support for specifying both a day-of-week AND a day-of-month parameter is not implemented.&quot;</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, day<span class="delimiter">)</span>;

                mon = cl.get<span class="delimiter">(</span>Calendar.MONTH<span class="delimiter">)</span> + <span class="int">1</span>;
                <span class="comment">// '+ 1' because calendar is 0-based for this field, and we are</span>
                <span class="comment">// 1-based</span>
                int year = cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span>;
                t = -<span class="int">1</span>;

                <span class="comment">// test for expressions that never generate a valid fire date,</span>
                <span class="comment">// but keep looping...</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>year &gt; <span class="int">2099</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <span class="keyword">return</span> <span class="keyword">null</span>;
                <span class="delimiter">}</span>

                <span class="comment">// get month...................................................</span>
                st = months.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>mon<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    t = mon;
                    mon = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    mon = months.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                    year++;
                <span class="delimiter">}</span>
                <span class="keyword">if</span> <span class="delimiter">(</span>mon != t<span class="delimiter">)</span> <span class="delimiter">{</span>
                    cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, <span class="int">1</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                    <span class="comment">// '- 1' because calendar is 0-based for this field, and we are</span>
                    <span class="comment">// 1-based</span>
                    cl.set<span class="delimiter">(</span>Calendar.YEAR, year<span class="delimiter">)</span>;
                    continue;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.MONTH, mon - <span class="int">1</span><span class="delimiter">)</span>;
                <span class="comment">// '- 1' because calendar is 0-based for this field, and we are</span>
                <span class="comment">// 1-based</span>

                year = cl.get<span class="delimiter">(</span>Calendar.YEAR<span class="delimiter">)</span>;
                t = -<span class="int">1</span>;

                <span class="comment">// get year...................................................</span>
                st = years.tailSet<span class="delimiter">(</span><span class="keyword">new</span> Integer<span class="delimiter">(</span>year<span class="delimiter">)</span><span class="delimiter">)</span>;
                <span class="keyword">if</span> <span class="delimiter">(</span>st != <span class="keyword">null</span> &amp;&amp; st.size<span class="delimiter">(</span><span class="delimiter">)</span> != <span class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    t = year;
                    year = st.first<span class="delimiter">(</span><span class="delimiter">)</span>.intValue<span class="delimiter">(</span><span class="delimiter">)</span>;
                <span class="delimiter">}</span> <span class="keyword">else</span> <span class="delimiter">{</span>
                    <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// ran out of years...</span>
                <span class="delimiter">}</span>

                <span class="keyword">if</span> <span class="delimiter">(</span>year != t<span class="delimiter">)</span> <span class="delimiter">{</span>
                    cl.set<span class="delimiter">(</span>Calendar.SECOND, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MINUTE, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.HOUR_OF_DAY, <span class="int">0</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.DAY_OF_MONTH, <span class="int">1</span><span class="delimiter">)</span>;
                    cl.set<span class="delimiter">(</span>Calendar.MONTH, <span class="int">0</span><span class="delimiter">)</span>;
                    <span class="comment">// '- 1' because calendar is 0-based for this field, and we are</span>
                    <span class="comment">// 1-based</span>
                    cl.set<span class="delimiter">(</span>Calendar.YEAR, year<span class="delimiter">)</span>;
                    continue;
                <span class="delimiter">}</span>
                cl.set<span class="delimiter">(</span>Calendar.YEAR, year<span class="delimiter">)</span>;

                gotOne = <span class="keyword">true</span>;
            <span class="delimiter">}</span> <span class="comment">// while( !done )</span>

            <span class="keyword">return</span> cl.getTime<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * Advance the calendar to the particular hour paying particular attention
         * to daylight saving problems.
         * 
         * @param cal
         * @param hour
         */</span>
        <span class="keyword">protected</span> void setCalendarHour<span class="delimiter">(</span>Calendar cal, int hour<span class="delimiter">)</span> <span class="delimiter">{</span>
            cal.set<span class="delimiter">(</span>java.util.Calendar.HOUR_OF_DAY, hour<span class="delimiter">)</span>;
            <span class="keyword">if</span> <span class="delimiter">(</span>cal.get<span class="delimiter">(</span>java.util.Calendar.HOUR_OF_DAY<span class="delimiter">)</span> != hour &amp;&amp; hour != <span class="int">24</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                cal.set<span class="delimiter">(</span>java.util.Calendar.HOUR_OF_DAY, hour + <span class="int">1</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="comment">/**
         * NOT YET IMPLEMENTED: Returns the time before the given time
         * that the &lt;code&gt;CronExpression&lt;/code&gt; matches.
         */</span>
        <span class="keyword">protected</span> Date getTimeBefore<span class="delimiter">(</span>Date endTime<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="comment">/**
         * NOT YET IMPLEMENTED: Returns the final time that the 
         * &lt;code&gt;CronExpression&lt;/code&gt; will match.
         */</span>
        public Date getFinalFireTime<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException<span class="delimiter">(</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> boolean isLeapYear<span class="delimiter">(</span>int year<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">return</span> <span class="delimiter">(</span><span class="delimiter">(</span>year % <span class="int">4</span> == <span class="int">0</span> &amp;&amp; year % <span class="int">100</span> != <span class="int">0</span><span class="delimiter">)</span> || <span class="delimiter">(</span>year % <span class="int">400</span> == <span class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span>;
        <span class="delimiter">}</span>

        <span class="keyword">protected</span> int getLastDayOfMonth<span class="delimiter">(</span>int monthNum, int year<span class="delimiter">)</span> <span class="delimiter">{</span>

            switch <span class="delimiter">(</span>monthNum<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="keyword">case</span> <span class="int">1</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">2</span>:
                <span class="keyword">return</span> <span class="delimiter">(</span>isLeapYear<span class="delimiter">(</span>year<span class="delimiter">)</span><span class="delimiter">)</span> ? <span class="int">29</span> : <span class="int">28</span>;
            <span class="keyword">case</span> <span class="int">3</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">4</span>:
                <span class="keyword">return</span> <span class="int">30</span>;
            <span class="keyword">case</span> <span class="int">5</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">6</span>:
                <span class="keyword">return</span> <span class="int">30</span>;
            <span class="keyword">case</span> <span class="int">7</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">8</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">9</span>:
                <span class="keyword">return</span> <span class="int">30</span>;
            <span class="keyword">case</span> <span class="int">10</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            <span class="keyword">case</span> <span class="int">11</span>:
                <span class="keyword">return</span> <span class="int">30</span>;
            <span class="keyword">case</span> <span class="int">12</span>:
                <span class="keyword">return</span> <span class="int">31</span>;
            default:
                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException<span class="delimiter">(</span><span class="string">&quot;Illegal month number: &quot;</span> + monthNum<span class="delimiter">)</span>;
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        <span class="keyword">private</span> void readObject<span class="delimiter">(</span>java.io.ObjectInputStream stream<span class="delimiter">)</span>
        throws java.io.IOException, ClassNotFoundException <span class="delimiter">{</span>

            stream.defaultReadObject<span class="delimiter">(</span><span class="delimiter">)</span>;
            <span class="keyword">try</span> <span class="delimiter">{</span>
                buildExpression<span class="delimiter">(</span>cronExpression<span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>Exception ignore<span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="delimiter">}</span> <span class="comment">// never happens</span>
        <span class="delimiter">}</span>

        @Override
        public Object clone<span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            CronExpression copy = <span class="keyword">null</span>;
            <span class="keyword">try</span> <span class="delimiter">{</span>
                copy = <span class="keyword">new</span> CronExpression<span class="delimiter">(</span>getCronExpression<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
                copy.setTimeZone<span class="delimiter">(</span>getTimeZone<span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span> <span class="keyword">catch</span> <span class="delimiter">(</span>ParseException ex<span class="delimiter">)</span> <span class="delimiter">{</span> <span class="comment">// never happens since the source is valid...</span>
                <span class="keyword">throw</span> <span class="keyword">new</span> IncompatibleClassChangeError<span class="delimiter">(</span><span class="string">&quot;Not Cloneable.&quot;</span><span class="delimiter">)</span>;
            <span class="delimiter">}</span>
            <span class="keyword">return</span> copy;
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="keyword">private</span> static <span class="keyword">class</span> <a title="object play.libs.Time.ValueSet" id="385729">ValueSet</a> <span class="delimiter">{</span>

        public int value;
        public int pos;
    <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>