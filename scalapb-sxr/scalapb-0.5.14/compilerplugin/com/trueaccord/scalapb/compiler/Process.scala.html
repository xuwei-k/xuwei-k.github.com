<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>compilerplugin/com/trueaccord/scalapb/compiler/Process.scala</title>
        <script type="text/javascript" src="../../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="keyword">package</span> com.trueaccord.scalapb.compiler

<span class="keyword">import</span> java.io.<span class="delimiter">{</span>InputStream, StringWriter, PrintWriter<span class="delimiter">}</span>
<span class="keyword">import</span> java.net.ServerSocket
<span class="keyword">import</span> java.nio.file.attribute.PosixFilePermission
<span class="keyword">import</span> java.nio.file.<span class="delimiter">{</span>Files, Path<span class="delimiter">}</span>

<span class="keyword">import</span> com.google.protobuf.ExtensionRegistry
<span class="keyword">import</span> com.google.protobuf.compiler.<a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos" title="com.google.protobuf.compiler.PluginProtos.type">PluginProtos</a>.<span class="delimiter">{</span>CodeGeneratorResponse, CodeGeneratorRequest<span class="delimiter">}</span>
<span class="keyword">import</span> com.trueaccord.scalapb.Scalapb

<span class="keyword">import</span> scala.collection.<span title="scala.collection.JavaConversions.type">JavaConversions</span>._
<span class="keyword">import</span> scala.concurrent.<span title="scala.concurrent.ExecutionContext.type">ExecutionContext</span>.<span title="concurrent.ExecutionContext.Implicits.type">Implicits</span>.global
<span class="keyword">import</span> scala.concurrent.Future
<span class="keyword">import</span> scala.sys.process._
<span class="keyword">import</span> scala.util.Try

<span class="comment">/** A ProtocDriver instance provides a platform-dependent way to launch protoc and
  * and set up a two-way communication channel between protoc and this JVM.
  *
  * protoc is able to launch plugins. A plugin is expected to take a serialized
  * CodeGenerationRequest via stdin and serialize a CodeGenerationRequest to stdout.
  * The idea in ProtocDriver is to create a minimal plugin that wires its stdin/stdout
  * to this JVM.
  *
  * The two-way communication always goes as follows:
  *
  * 1. protoc writes a request to the stdin of a plugin
  * 2. plugin writes the data to the channel
  * 3. this JVM reads it, interprets it as CodeGenerationRequest and process it.
  * 4. this JVM writes a CodeGenerationResponse to the channel
  * 5. this JVM closes the channel.
  * 6. the plugin reads the data and writes it to standard out.
  * 7. protoc handles the CodeGenerationResponse (creates Scala sources)
  */</span>
<span class="keyword">trait</span> <a title="trait ProtocDriver extends AnyRef" id="com.trueaccord.scalapb.compiler;ProtocDriver">ProtocDriver</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[A](runner: Seq[String] =&gt; A)(params: Seq[String])A" id="com.trueaccord.scalapb.compiler;ProtocDriver.buildRunner">buildRunner</a><span class="delimiter">[</span><a title="" id="com.trueaccord.scalapb.compiler;ProtocDriver.buildRunner;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Seq[String] =&gt; A" id="com.trueaccord.scalapb.compiler;ProtocDriver.buildRunner.runner">runner</a>: Seq<span class="delimiter">[</span>String<span class="delimiter">]</span> =&gt; A<span class="delimiter">)</span><span class="delimiter">(</span><a title="Seq[String]" id="com.trueaccord.scalapb.compiler;ProtocDriver.buildRunner.params">params</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#com.trueaccord.scalapb.compiler;ProtocDriver.buildRunner;A" title="A">A</a>
<span class="delimiter">}</span>

<span title="AnyRef" class="keyword">object</span> <a title="com.trueaccord.scalapb.compiler.ProtocDriverFactory.type" id="com.trueaccord.scalapb.compiler.ProtocDriverFactory">ProtocDriverFactory</a> <a href="#com.trueaccord.scalapb.compiler.ProtocDriverFactory" title="com.trueaccord.scalapb.compiler.ProtocDriverFactory.type" class="delimiter">{</a>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="=&gt; Boolean" id="com.trueaccord.scalapb.compiler.ProtocDriverFactory.isWindows">isWindows</a>: <span title="Boolean">Boolean</span> = sys.<span title="(key: String)String">props</span><span class="delimiter">(</span><span title="String(&quot;os.name&quot;)" class="string">&quot;os.name&quot;</span><span class="delimiter">)</span>.<span title="(x$1: String)Boolean">startsWith</span><span class="delimiter">(</span><span title="String(&quot;Windows&quot;)" class="string">&quot;Windows&quot;</span><span class="delimiter">)</span>

  <span class="keyword">def</span> <a title="()com.trueaccord.scalapb.compiler.ProtocDriver" id="com.trueaccord.scalapb.compiler.ProtocDriverFactory.create">create</a><span class="delimiter">(</span><span class="delimiter">)</span> =
    <span title="com.trueaccord.scalapb.compiler.ProtocDriver" class="keyword">if</span> <span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.ProtocDriverFactory.isWindows" title="=&gt; Boolean">isWindows</a><span class="delimiter">)</span> <span title="com.trueaccord.scalapb.compiler.WindowsProtocDriver" class="keyword">new</span> <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver" title="com.trueaccord.scalapb.compiler.WindowsProtocDriver">WindowsProtocDriver</a><span class="delimiter">(</span><span title="String(&quot;python.exe&quot;)" class="string">&quot;python.exe&quot;</span><span class="delimiter">)</span>
    <span class="keyword">else</span> <span title="com.trueaccord.scalapb.compiler.PosixProtocDriver" class="keyword">new</span> <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver" title="com.trueaccord.scalapb.compiler.PosixProtocDriver">PosixProtocDriver</a>
<span class="delimiter">}</span>

<span class="comment">/** A driver that creates a named pipe and sets up a shell script as a protoc plugin */</span>
<span title="AnyRef" class="keyword">class</span> <a title="class PosixProtocDriver extends AnyRef with com.trueaccord.scalapb.compiler.ProtocDriver" id="com.trueaccord.scalapb.compiler;PosixProtocDriver">PosixProtocDriver</a> <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver" title="com.trueaccord.scalapb.compiler.PosixProtocDriver" class="keyword">extends</a> <a href="#com.trueaccord.scalapb.compiler;ProtocDriver" title="com.trueaccord.scalapb.compiler.ProtocDriver">ProtocDriver</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[A](runner: Seq[String] =&gt; A)(params: Seq[String])A" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner">buildRunner</a><span class="delimiter">[</span><a title="" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Seq[String] =&gt; A" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.runner">runner</a>: Seq<span class="delimiter">[</span>String<span class="delimiter">]</span> =&gt; A<span class="delimiter">)</span><span class="delimiter">(</span><a title="Seq[String]" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.params">params</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner;A" title="A">A</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.pipe">pipe</a> = <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe" title="()java.nio.file.Path">createPipe</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.sh">sh</a> = <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript" title="(tmpFile: java.nio.file.Path)java.nio.file.Path">createShellScript</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.pipe" title="java.nio.file.Path">pipe</a><span class="delimiter">)</span>
    <span title="(body: =&gt; Unit)(implicit execctx: scala.concurrent.ExecutionContext)scala.concurrent.Future[Unit]">Future</span> <span title="=&gt; scala.concurrent.ExecutionContextExecutor" class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.io.InputStream" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsin">fsin</a> = <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path, x$2: &lt;repeated...&gt;[java.nio.file.OpenOption])java.io.InputStream">newInputStream</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.pipe" title="java.nio.file.Path">pipe</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.response">response</a> = <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type">Process</a>.<a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream" title="(fsin: java.io.InputStream)com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">runWithInputStream</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsin" title="java.io.InputStream">fsin</a><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="java.io.OutputStream" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsout">fsout</a> = <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path, x$2: &lt;repeated...&gt;[java.nio.file.OpenOption])java.io.OutputStream">newOutputStream</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.pipe" title="java.nio.file.Path">pipe</a><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsout" title="java.io.OutputStream">fsout</a>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.response" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">response</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsout" title="java.io.OutputStream">fsout</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.fsin" title="java.io.InputStream">fsin</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">try</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[String]" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.args">args</a> = <span title="(elems: String*)Seq[String]">Seq</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;--plugin=protoc-gen-scala=&quot;)">--plugin=protoc-gen-scala=$</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.sh" title="java.nio.file.Path">sh</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],String,Seq[String]])Seq[String]">++</span> <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.params" title="Seq[String]">params</a>
      <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.runner" title="(v1: Seq[String])A">runner</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.args" title="Seq[String]">args</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">finally</span> <span class="delimiter">{</span>
      <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path)Unit">delete</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.pipe" title="java.nio.file.Path">pipe</a><span class="delimiter">)</span>
      <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path)Unit">delete</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.buildRunner.sh" title="java.nio.file.Path">sh</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="()java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe">createPipe</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="java.nio.file.Path">Path</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe.pipeName">pipeName</a> = <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: String, x$2: String, x$3: &lt;repeated...&gt;[java.nio.file.attribute.FileAttribute[_]])java.nio.file.Path">createTempFile</span><span class="delimiter">(</span><span title="String(&quot;protopipe-&quot;)" class="string">&quot;protopipe-&quot;</span>, <span title="String(&quot;.pipe&quot;)" class="string">&quot;.pipe&quot;</span><span class="delimiter">)</span>
    <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path)Unit">delete</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe.pipeName" title="java.nio.file.Path">pipeName</a><span class="delimiter">)</span>
    <span title="(elems: String*)Seq[String]">Seq</span><span title="implicit scala.sys.process.ProcessImplicits.stringSeqToProcess : (command: Seq[String])scala.sys.process.ProcessBuilder" class="delimiter">(</span><span title="String(&quot;mkfifo&quot;)" class="string">&quot;mkfifo&quot;</span>, <span title="String(&quot;-m&quot;)" class="string">&quot;-m&quot;</span>, <span title="String(&quot;600&quot;)" class="string">&quot;600&quot;</span>, <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe.pipeName" title="java.nio.file.Path">pipeName</a>.<span title="()java.nio.file.Path">toAbsolutePath</span>.<span title="()String">toString</span><span class="delimiter">)</span>.<span title="=&gt; String">!!</span>
    <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createPipe.pipeName" title="java.nio.file.Path">pipeName</a>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(tmpFile: java.nio.file.Path)java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript">createShellScript</a><span class="delimiter">(</span><a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.tmpFile">tmpFile</a>: <span title="java.nio.file.Path">Path</span><span class="delimiter">)</span>: <span title="java.nio.file.Path">Path</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.scriptName">scriptName</a> = <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type">Process</a>.<a href="#com.trueaccord.scalapb.compiler.Process.createTempFile" title="(extension: String, content: String)java.nio.file.Path">createTempFile</a><span class="delimiter">(</span><span title="String(&quot;&quot;)" class="string">&quot;&quot;</span>,
      <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">s</span>&quot;&quot;&quot;<span title="String(&quot;|#!/usr/bin/env sh\n          |set -e\n          |cat /dev/stdin &gt; \&quot;&quot;)">|#!/usr/bin/env sh
          |set -e
          |cat /dev/stdin &gt; &quot;$</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.tmpFile" title="java.nio.file.Path">tmpFile</a><span title="String(&quot;\&quot;\n          |cat \&quot;&quot;)">&quot;
          |cat &quot;$</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.tmpFile" title="java.nio.file.Path">tmpFile</a><span title="String(&quot;\&quot;\n      &quot;)" class="string">&quot;
      &quot;&quot;&quot;</span>.<span title="=&gt; String">stripMargin</span><span class="delimiter">)</span>
    <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path, x$2: java.util.Set[java.nio.file.attribute.PosixFilePermission])java.nio.file.Path">setPosixFilePermissions</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.scriptName" title="java.nio.file.Path">scriptName</a>, <span title="(elems: java.nio.file.attribute.PosixFilePermission*)scala.collection.immutable.Set[java.nio.file.attribute.PosixFilePermission]">Set</span><span title="(s: scala.collection.Set[java.nio.file.attribute.PosixFilePermission])java.util.Set[java.nio.file.attribute.PosixFilePermission]" class="delimiter">(</span>
      PosixFilePermission.<span title="java.nio.file.attribute.PosixFilePermission(OWNER_EXECUTE)">OWNER_EXECUTE</span>,
      PosixFilePermission.<span title="java.nio.file.attribute.PosixFilePermission(OWNER_READ)">OWNER_READ</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler;PosixProtocDriver.createShellScript.scriptName" title="java.nio.file.Path">scriptName</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

  <span class="comment">/** A driver that binds a server socket to a local interface. The plugin
    * is a batch script that invokes Python, which will communicate wire its
    * stdin and stdout to this socket.
    */</span>
<span class="keyword">class</span> <a title="class WindowsProtocDriver extends AnyRef with com.trueaccord.scalapb.compiler.ProtocDriver" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver">WindowsProtocDriver</a><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver" title="com.trueaccord.scalapb.compiler.WindowsProtocDriver" class="delimiter">(</a><a title="String" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.pythonExecutable">pythonExecutable</a>: <span title="String">String</span><span class="delimiter">)</span> <span class="keyword">extends</span> <a href="#com.trueaccord.scalapb.compiler;ProtocDriver" title="com.trueaccord.scalapb.compiler.ProtocDriver">ProtocDriver</a> <span class="delimiter">{</span>
  <span class="keyword">def</span> <a title="[A](runner: Seq[String] =&gt; A)(params: Seq[String])A" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner">buildRunner</a><span class="delimiter">[</span><a title="" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner;A">A</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="Seq[String] =&gt; A" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.runner">runner</a>: Seq<span class="delimiter">[</span>String<span class="delimiter">]</span> =&gt; A<span class="delimiter">)</span><span class="delimiter">(</span><a title="Seq[String]" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.params">params</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner;A" title="A">A</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.net.ServerSocket" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.ss">ss</a> = <span title="(x$1: Int)java.net.ServerSocket" class="keyword">new</span> <span title="java.net.ServerSocket">ServerSocket</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="keyword">val</span> <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.batFile" title="(java.nio.file.Path, java.nio.file.Path)" class="delimiter">(</a><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.x$1" title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.batFile">batFile</a>, <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.x$1" title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.pyFile">pyFile</a><span class="delimiter">)</span> = <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts" title="(port: Int)(java.nio.file.Path, java.nio.file.Path)">createWindowsScripts</a><span title="(java.nio.file.Path, java.nio.file.Path) @unchecked" class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.ss" title="java.net.ServerSocket">ss</a>.<span title="()Int">getLocalPort</span><span class="delimiter">)</span>
    <span title="(body: =&gt; Unit)(implicit execctx: scala.concurrent.ExecutionContext)scala.concurrent.Future[Unit]">Future</span> <span title="=&gt; scala.concurrent.ExecutionContextExecutor" class="delimiter">{</span>
      <span class="keyword">val</span> <a title="java.net.Socket" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.client">client</a> = <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.ss" title="java.net.ServerSocket">ss</a>.<span title="()java.net.Socket">accept</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="keyword">val</span> <a title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.response">response</a> = <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type">Process</a>.<a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream" title="(fsin: java.io.InputStream)com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">runWithInputStream</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.client" title="java.net.Socket">client</a>.<span title="()java.io.InputStream">getInputStream</span><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.client" title="java.net.Socket">client</a>.<span title="()java.io.OutputStream">getOutputStream</span>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.response" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">response</a>.<span title="()Array[Byte]">toByteArray</span><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.client" title="java.net.Socket">client</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.ss" title="java.net.ServerSocket">ss</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <span class="keyword">try</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="Seq[String]" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.args">args</a> = <span title="(elems: String*)Seq[String]">Seq</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;--plugin=protoc-gen-scala=&quot;)">--plugin=protoc-gen-scala=$</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.batFile" title="java.nio.file.Path">batFile</a><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span> <span title="(that: scala.collection.GenTraversableOnce[String])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],String,Seq[String]])Seq[String]">++</span> <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.params" title="Seq[String]">params</a>
      <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.runner" title="(v1: Seq[String])A">runner</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.args" title="Seq[String]">args</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="keyword">finally</span> <span class="delimiter">{</span>
      <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path)Unit">delete</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.batFile" title="java.nio.file.Path">batFile</a><span class="delimiter">)</span>
      <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path)Unit">delete</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.buildRunner.pyFile" title="java.nio.file.Path">pyFile</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(port: Int)(java.nio.file.Path, java.nio.file.Path)" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts">createWindowsScripts</a><span class="delimiter">(</span><a title="Int" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.port">port</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="(java.nio.file.Path, java.nio.file.Path)" class="delimiter">(</span>Path, Path<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.pythonScript">pythonScript</a> = <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type">Process</a>.<a href="#com.trueaccord.scalapb.compiler.Process.createTempFile" title="(extension: String, content: String)java.nio.file.Path">createTempFile</a><span class="delimiter">(</span><span title="String(&quot;.py&quot;)" class="string">&quot;.py&quot;</span>,
      <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">s</span>&quot;&quot;&quot;<span title="String(&quot;|import sys, socket\n         |\n         |content = sys.stdin.read()\n         |s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n         |s.connect((\'127.0.0.1\', int(sys.argv[1])))\n         |s.sendall(content)\n         |s.shutdown(socket.SHUT_WR)\n         |while 1:\n         |    data = s.recv(1024)\n         |    if data == \'\':\n         |        break\n         |    sys.stdout.write(data)\n         |s.close()\n      &quot;)" class="string">|import sys, socket
         |
         |content = sys.stdin.read()
         |s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
         |s.connect(('127.0.0.1', int(sys.argv[1])))
         |s.sendall(content)
         |s.shutdown(socket.SHUT_WR)
         |while 1:
         |    data = s.recv(1024)
         |    if data == '':
         |        break
         |    sys.stdout.write(data)
         |s.close()
      &quot;&quot;&quot;</span>.<span title="=&gt; String">stripMargin</span><span class="delimiter">)</span>

    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.batchFile">batchFile</a> = <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type">Process</a>.<a href="#com.trueaccord.scalapb.compiler.Process.createTempFile" title="(extension: String, content: String)java.nio.file.Path">createTempFile</a><span class="delimiter">(</span><span title="String(&quot;.bat&quot;)" class="string">&quot;.bat&quot;</span>,
      <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">s</span>&quot;&quot;&quot;<span title="String(&quot;@echo off\n         |&quot;)">@echo off
         |$</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.pythonExecutable" title="String">pythonExecutable</a><span title="String(&quot; -u &quot;)"> -u $</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.pythonScript" title="java.nio.file.Path">pythonScript</a><span title="String(&quot; &quot;)"> $</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.port" title="Int">port</a><span title="String(&quot;\n         &quot;)" class="string">
         &quot;&quot;&quot;</span>.<span title="=&gt; String">stripMargin</span><span class="delimiter">)</span>
    <span title="(_1: java.nio.file.Path, _2: java.nio.file.Path)(java.nio.file.Path, java.nio.file.Path)" class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.batchFile" title="java.nio.file.Path">batchFile</a>, <a href="#com.trueaccord.scalapb.compiler;WindowsProtocDriver.createWindowsScripts.pythonScript" title="java.nio.file.Path">pythonScript</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="keyword">object</span> <a title="com.trueaccord.scalapb.compiler.Process.type" id="com.trueaccord.scalapb.compiler.Process">Process</a> <a href="#com.trueaccord.scalapb.compiler.Process" title="com.trueaccord.scalapb.compiler.Process.type" class="delimiter">{</a>
  <span class="keyword">private</span> <span class="keyword">def</span> <a title="(e: Throwable)String" id="com.trueaccord.scalapb.compiler.Process.getStackTrace">getStackTrace</a><span class="delimiter">(</span><a title="Throwable" id="com.trueaccord.scalapb.compiler.Process.getStackTrace.e">e</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.io.StringWriter" id="com.trueaccord.scalapb.compiler.Process.getStackTrace.stringWriter">stringWriter</a> = <span title="java.io.StringWriter" class="keyword">new</span> <span title="java.io.StringWriter">StringWriter</span>
    <span class="keyword">val</span> <a title="java.io.PrintWriter" id="com.trueaccord.scalapb.compiler.Process.getStackTrace.printWriter">printWriter</a> = <span title="java.io.PrintWriter" class="keyword">new</span> <span title="java.io.PrintWriter">PrintWriter</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.getStackTrace.stringWriter" title="java.io.StringWriter">stringWriter</a><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler.Process.getStackTrace.e" title="Throwable">e</a>.<span title="(x$1: java.io.PrintWriter)Unit">printStackTrace</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.getStackTrace.printWriter" title="java.io.PrintWriter">printWriter</a><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler.Process.getStackTrace.stringWriter" title="java.io.StringWriter">stringWriter</a>.<span title="()String">toString</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(fsin: java.io.InputStream)com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream">runWithInputStream</a><span class="delimiter">(</span><a title="java.io.InputStream" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream.fsin">fsin</a>: <span title="java.io.InputStream">InputStream</span><span class="delimiter">)</span>: <a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos;CodeGeneratorResponse" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">CodeGeneratorResponse</a> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="com.google.protobuf.ExtensionRegistry" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream.registry">registry</a> = <span title="com.google.protobuf.ExtensionRegistry.type">ExtensionRegistry</span>.<span title="()com.google.protobuf.ExtensionRegistry">newInstance</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../../../../../scalapb-runtime/com/trueaccord/scalapb/Scalapb.java.html#com.trueaccord.scalapb.Scalapb" title="com.trueaccord.scalapb.Scalapb.type">Scalapb</a>.<a href="../../../../../scalapb-runtime/com/trueaccord/scalapb/Scalapb.java.html#com.trueaccord.scalapb.Scalapb.registerAllExtensions" title="(registry: com.google.protobuf.ExtensionRegistry)Unit">registerAllExtensions</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream.registry" title="com.google.protobuf.ExtensionRegistry">registry</a><span class="delimiter">)</span>

    <span title="(r: =&gt; com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse)scala.util.Try[com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse]">Try</span> <span class="delimiter">{</span>
      <span class="keyword">val</span> <a title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream.request">request</a> = <a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest.type">CodeGeneratorRequest</a>.<a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest.parseFrom(d81813dcf2)" title="(input: java.io.InputStream, extensionRegistry: com.google.protobuf.ExtensionRegistryLite)com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest">parseFrom</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream.fsin" title="java.io.InputStream">fsin</a>, <a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream.registry" title="com.google.protobuf.ExtensionRegistry">registry</a><span class="delimiter">)</span>
      <a href="ProtobufGenerator.scala.html#com.trueaccord.scalapb.compiler.ProtobufGenerator" title="com.trueaccord.scalapb.compiler.ProtobufGenerator.type">ProtobufGenerator</a>.<a href="ProtobufGenerator.scala.html#com.trueaccord.scalapb.compiler.ProtobufGenerator.handleCodeGeneratorRequest" title="(request: com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest)com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">handleCodeGeneratorRequest</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream.request" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest">request</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(f: PartialFunction[Throwable,com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse])scala.util.Try[com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse]">recover</span> <a title="anonymous class $anonfun extends scala.runtime.AbstractPartialFunction[Throwable,com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse] with Serializable" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>
      <span class="keyword">case</span> <a title="Throwable" id="com.trueaccord.scalapb.compiler.Process.runWithInputStream;$anonfun.isDefinedAt.throwable">throwable</a> =&gt;
        <a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse" title="com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse.type">CodeGeneratorResponse</a>.<a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse.newBuilder(1b11a09675)" title="()com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse.Builder">newBuilder</a><span class="delimiter">(</span><span class="delimiter">)</span>
          .<a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse;Builder.setError" title="(value: String)com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse.Builder">setError</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream;$anonfun.isDefinedAt.throwable" title="Throwable">throwable</a>.<span title="()String">toString</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;\n&quot;)" class="string">&quot;\n&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#com.trueaccord.scalapb.compiler.Process.getStackTrace" title="(e: Throwable)String">getStackTrace</a><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.runWithInputStream;$anonfun.isDefinedAt.throwable" title="Throwable">throwable</a><span class="delimiter">)</span><span class="delimiter">)</span>
          .<a href="../../../google/protobuf/compiler/PluginProtos.java.html#com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse;Builder.build" title="()com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">build</a>
    <span class="delimiter">}</span>.<span title="=&gt; com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse">get</span>
  <span class="delimiter">}</span>

  <span class="keyword">def</span> <a title="(extension: String, content: String)java.nio.file.Path" id="com.trueaccord.scalapb.compiler.Process.createTempFile">createTempFile</a><span class="delimiter">(</span><a title="String" id="com.trueaccord.scalapb.compiler.Process.createTempFile.extension">extension</a>: <span title="String">String</span>, <a title="String" id="com.trueaccord.scalapb.compiler.Process.createTempFile.content">content</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="java.nio.file.Path">Path</span> = <span class="delimiter">{</span>
    <span class="keyword">val</span> <a title="java.nio.file.Path" id="com.trueaccord.scalapb.compiler.Process.createTempFile.fileName">fileName</a> = <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: String, x$2: String, x$3: &lt;repeated...&gt;[java.nio.file.attribute.FileAttribute[_]])java.nio.file.Path">createTempFile</span><span class="delimiter">(</span><span title="String(&quot;scalapbgen&quot;)" class="string">&quot;scalapbgen&quot;</span>, <a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.extension" title="String">extension</a><span class="delimiter">)</span>
    <span class="keyword">val</span> <a title="java.io.OutputStream" id="com.trueaccord.scalapb.compiler.Process.createTempFile.os">os</a> = <span title="java.nio.file.Files.type">Files</span>.<span title="(x$1: java.nio.file.Path, x$2: &lt;repeated...&gt;[java.nio.file.OpenOption])java.io.OutputStream">newOutputStream</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.fileName" title="java.nio.file.Path">fileName</a><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.os" title="java.io.OutputStream">os</a>.<span title="(x$1: Array[Byte])Unit">write</span><span class="delimiter">(</span><a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.content" title="String">content</a>.<span title="(x$1: String)Array[Byte]">getBytes</span><span class="delimiter">(</span><span title="String(&quot;UTF-8&quot;)" class="string">&quot;UTF-8&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.os" title="java.io.OutputStream">os</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#com.trueaccord.scalapb.compiler.Process.createTempFile.fileName" title="java.nio.file.Path">fileName</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
