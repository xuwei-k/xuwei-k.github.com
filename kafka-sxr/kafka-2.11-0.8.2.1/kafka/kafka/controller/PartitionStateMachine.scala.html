<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/controller/PartitionStateMachine.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/</span>
package kafka.controller

import collection._
import collection.JavaConversions
import collection.mutable.Buffer
import java.util.concurrent.atomic.AtomicBoolean
import kafka.api.LeaderAndIsr
import kafka.common.<span class="delimiter">{</span>LeaderElectionNotNeededException, TopicAndPartition, StateChangeFailedException, NoReplicaOnlineException<span class="delimiter">}</span>
import kafka.utils.<span class="delimiter">{</span>Logging, ZkUtils, ReplicationUtils<span class="delimiter">}</span>
import org.I0Itec.zkclient.<span class="delimiter">{</span>IZkDataListener, IZkChildListener<span class="delimiter">}</span>
import org.I0Itec.zkclient.exception.ZkNodeExistsException
import org.apache.log4j.Logger
import kafka.controller.<a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks" title="kafka.controller.Callbacks.type">Callbacks</a>.CallbackBuilder
import kafka.utils.<a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>._

<span class="comment">/**
 * This class represents the state machine for partitions. It defines the states that a partition can be in, and
 * transitions to move the partition to another legal state. The different states that a partition can be in are -
 * 1. NonExistentPartition: This state indicates that the partition was either never created or was created and then
 *                          deleted. Valid previous state, if one exists, is OfflinePartition
 * 2. NewPartition        : After creation, the partition is in the NewPartition state. In this state, the partition should have
 *                          replicas assigned to it, but no leader/isr yet. Valid previous states are NonExistentPartition
 * 3. OnlinePartition     : Once a leader is elected for a partition, it is in the OnlinePartition state.
 *                          Valid previous states are NewPartition/OfflinePartition
 * 4. OfflinePartition    : If, after successful leader election, the leader for partition dies, then the partition
 *                          moves to the OfflinePartition state. Valid previous states are NewPartition/OnlinePartition
 */</span>
class <a title="class PartitionStateMachine extends AnyRef with kafka.utils.Logging" id="kafka.controller;PartitionStateMachine">PartitionStateMachine</a><a href="#kafka.controller;PartitionStateMachine" title="kafka.controller.PartitionStateMachine" class="delimiter">(</a><a title="kafka.controller.KafkaController" id="kafka.controller;PartitionStateMachine.controller">controller</a>: <a href="KafkaController.scala.html#kafka.controller;KafkaController" title="kafka.controller.KafkaController">KafkaController</a><span class="delimiter">)</span> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  private val <a title="kafka.controller.ControllerContext" id="kafka.controller;PartitionStateMachine.controllerContext">controllerContext</a> = <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>
  private val <a title="Int" id="kafka.controller;PartitionStateMachine.controllerId">controllerId</a> = <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>
  private val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;PartitionStateMachine.zkClient">zkClient</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>
  private val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]" id="kafka.controller;PartitionStateMachine.partitionState">partitionState</a>: mutable.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">Map</span><span class="delimiter">[</span>TopicAndPartition, PartitionState<span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Map.type">Map</span>.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">empty</span>
  private val <a title="kafka.controller.ControllerBrokerRequestBatch" id="kafka.controller;PartitionStateMachine.brokerRequestBatch">brokerRequestBatch</a> = new <a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch" title="kafka.controller.ControllerBrokerRequestBatch">ControllerBrokerRequestBatch</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a><span class="delimiter">)</span>
  private val <a title="java.util.concurrent.atomic.AtomicBoolean" id="kafka.controller;PartitionStateMachine.hasStarted">hasStarted</a> = new <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
  private val <a title="kafka.controller.NoOpLeaderSelector" id="kafka.controller;PartitionStateMachine.noOpPartitionLeaderSelector">noOpPartitionLeaderSelector</a> = new <a href="PartitionLeaderSelector.scala.html#kafka.controller;NoOpLeaderSelector" title="kafka.controller.NoOpLeaderSelector">NoOpLeaderSelector</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a><span class="delimiter">)</span>
  private val <a title="PartitionStateMachine.this.TopicChangeListener" id="kafka.controller;PartitionStateMachine.topicChangeListener">topicChangeListener</a> = new <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener" title="PartitionStateMachine.this.TopicChangeListener">TopicChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
  private val <a title="PartitionStateMachine.this.DeleteTopicsListener" id="kafka.controller;PartitionStateMachine.deleteTopicsListener">deleteTopicsListener</a> = new <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener" title="PartitionStateMachine.this.DeleteTopicsListener">DeleteTopicsListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
  private val <a title="scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]" id="kafka.controller;PartitionStateMachine.addPartitionsListener">addPartitionsListener</a>: mutable.<span title="scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">Map</span><span class="delimiter">[</span>String, AddPartitionsListener<span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Map.type">Map</span>.<span title="scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">empty</span>
  private val <a title="kafka.controller.KafkaController.StateChangeLogger" id="kafka.controller;PartitionStateMachine.stateChangeLogger">stateChangeLogger</a> = <a href="KafkaController.scala.html#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="KafkaController.scala.html#kafka.controller.KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>

  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[Partition state machine on Controller &quot;)" class="string">&quot;[Partition state machine on Controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>

  <span class="comment">/**
   * Invoked on successful controller election. First registers a topic change listener since that triggers all
   * state transitions for partitions. Initializes the state of partitions by reading from zookeeper. Then triggers
   * the OnlinePartition state change for all new or offline partitions.
   */</span>
  def <a title="()Unit" id="kafka.controller;PartitionStateMachine.startup">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// initialize partition state</span>
    <a href="#kafka.controller;PartitionStateMachine.initializePartitionState" title="()Unit">initializePartitionState</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// set started flag</span>
    <a href="#kafka.controller;PartitionStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="(x$1: Boolean)Unit">set</span><span class="delimiter">(</span>true<span class="delimiter">)</span>
    <span class="comment">// try to move partitions to online state</span>
    <a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange" title="()Unit">triggerOnlinePartitionStateChange</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Started partition state machine with initial state -&gt; &quot;)" class="string">&quot;Started partition state machine with initial state -&gt; &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// register topic and partition change listeners</span>
  def <a title="()Unit" id="kafka.controller;PartitionStateMachine.registerListeners">registerListeners</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.registerTopicChangeListener" title="()java.util.List[String]">registerTopicChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.deleteTopicEnable" title="=&gt; Boolean">deleteTopicEnable</a><span class="delimiter">)</span>
      <a href="#kafka.controller;PartitionStateMachine.registerDeleteTopicListener" title="()java.util.List[String]">registerDeleteTopicListener</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// de-register topic and partition change listeners</span>
  def <a title="()Unit" id="kafka.controller;PartitionStateMachine.deregisterListeners">deregisterListeners</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.deregisterTopicChangeListener" title="()Unit">deregisterTopicChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="=&gt; scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">addPartitionsListener</a>.<span title="(f: ((String, PartitionStateMachine.this.AddPartitionsListener)) =&gt; Unit)Unit">foreach</span> <a href="#kafka.controller;PartitionStateMachine.deregisterListeners.$anonfun.x0$1" title="Unit" class="delimiter">{</a>
      case <span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.deregisterListeners.$anonfun.topic">topic</a>, <a title="PartitionStateMachine.this.AddPartitionsListener" id="kafka.controller;PartitionStateMachine.deregisterListeners.$anonfun.listener">listener</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPath" title="(topic: String)String">getTopicPath</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.deregisterListeners.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.deregisterListeners.$anonfun.listener" title="PartitionStateMachine.this.AddPartitionsListener">listener</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="=&gt; scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">addPartitionsListener</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.deleteTopicEnable" title="=&gt; Boolean">deleteTopicEnable</a><span class="delimiter">)</span>
      <a href="#kafka.controller;PartitionStateMachine.deregisterDeleteTopicListener" title="()Unit">deregisterDeleteTopicListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on controller shutdown.
   */</span>
  def <a title="()Unit" id="kafka.controller;PartitionStateMachine.shutdown">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// reset started flag</span>
    <a href="#kafka.controller;PartitionStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="(x$1: Boolean)Unit">set</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
    <span class="comment">// clear partition state</span>
    <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// de-register all ZK listeners</span>
    <a href="#kafka.controller;PartitionStateMachine.deregisterListeners" title="()Unit">deregisterListeners</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Stopped partition state machine&quot;)" class="string">&quot;Stopped partition state machine&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This API invokes the OnlinePartition state change on all partitions in either the NewPartition or OfflinePartition
   * state. This is called on a successful controller election and on broker changes
   */</span>
  def <a title="()Unit" id="kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange">triggerOnlinePartitionStateChange</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// try to move all partitions in NewPartition or OfflinePartition state to OnlinePartition state except partitions</span>
      <span class="comment">// that belong to topics to be deleted</span>
      for<span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.partitionState">partitionState</a><span class="delimiter">)</span> &lt;- <a href="#kafka.controller;PartitionStateMachine.partitionState" title="(f: ((kafka.common.TopicAndPartition, kafka.controller.PartitionState)) =&gt; Unit)Unit">partitionState</a>
          if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.deleteTopicManager" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.partitionState" title="kafka.controller.PartitionState">partitionState</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.partitionState" title="kafka.controller.PartitionState">partitionState</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.handleStateChange" title="(topic: String, partition: Int, targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChange</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.offlinePartitionSelector" title="=&gt; kafka.controller.OfflinePartitionLeaderSelector">offlinePartitionSelector</a>,
                            <span class="delimiter">(</span>new <a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder" title="kafka.controller.Callbacks.CallbackBuilder">CallbackBuilder</a><span class="delimiter">)</span>.<a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder.build" title="=&gt; kafka.controller.Callbacks">build</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while moving some partitions to the online state&quot;)" class="string">&quot;Error while moving some partitions to the online state&quot;</span>, <a href="#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange.e" title="Throwable">e</a><span class="delimiter">)</span>
      <span class="comment">// TODO: It is not enough to bail out and log an error, it is important to trigger leader election for those partitions</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(state: kafka.controller.PartitionState)scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;PartitionStateMachine.partitionsInState">partitionsInState</a><span class="delimiter">(</span><a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.partitionsInState.state">state</a>: <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.PartitionState)) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">filter</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, kafka.controller.PartitionState)" id="kafka.controller;PartitionStateMachine.partitionsInState.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;PartitionStateMachine.partitionsInState.$anonfun.p" title="(kafka.common.TopicAndPartition, kafka.controller.PartitionState)">p</a>.<span title="=&gt; kafka.controller.PartitionState">_2</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;PartitionStateMachine.partitionsInState.state" title="kafka.controller.PartitionState">state</a><span class="delimiter">)</span>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This API is invoked by the partition change zookeeper listener
   * @param partitions   The list of partitions that need to be transitioned to the target state
   * @param targetState  The state that the partitions should be moved to
   */</span>
  def <a title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit" id="kafka.controller;PartitionStateMachine.handleStateChanges">handleStateChanges</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;PartitionStateMachine.handleStateChanges.partitions">partitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span>, <a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.handleStateChanges.targetState">targetState</a>: <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a>,
                         <a title="kafka.controller.PartitionLeaderSelector" id="kafka.controller;PartitionStateMachine.handleStateChanges$default$3">leaderSelector</a>: <a href="PartitionLeaderSelector.scala.html#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a> = <a href="#kafka.controller;PartitionStateMachine.noOpPartitionLeaderSelector" title="=&gt; kafka.controller.NoOpLeaderSelector">noOpPartitionLeaderSelector</a>,
                         <a title="kafka.controller.Callbacks" id="kafka.controller;PartitionStateMachine.handleStateChanges$default$4">callbacks</a>: <a href="ControllerChannelManager.scala.html#kafka.controller;Callbacks" title="kafka.controller.Callbacks">Callbacks</a> = <span class="delimiter">(</span>new <a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder" title="kafka.controller.Callbacks.CallbackBuilder">CallbackBuilder</a><span class="delimiter">)</span>.<a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder.build" title="=&gt; kafka.controller.Callbacks">build</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invoking state change to %s for partitions %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChanges.targetState" title="kafka.controller.PartitionState">targetState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;PartitionStateMachine.handleStateChanges.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.handleStateChanges.$anonfun.topicAndPartition">topicAndPartition</a> =&gt;
        <a href="#kafka.controller;PartitionStateMachine.handleStateChange" title="(topic: String, partition: Int, targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChange</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChanges.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges.targetState" title="kafka.controller.PartitionState">targetState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges$default$3" title="kafka.controller.PartitionLeaderSelector">leaderSelector</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges$default$4" title="kafka.controller.Callbacks">callbacks</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;PartitionStateMachine.handleStateChanges.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error while moving some partitions to %s state&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChanges.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.handleStateChanges.e" title="Throwable">e</a><span class="delimiter">)</span>
      <span class="comment">// TODO: It is not enough to bail out and log an error, it is important to trigger state changes for those partitions</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This API exercises the partition's state machine. It ensures that every state transition happens from a legal
   * previous state to the target state. Valid state transitions are:
   * NonExistentPartition -&gt; NewPartition:
   * --load assigned replicas from ZK to controller cache
   *
   * NewPartition -&gt; OnlinePartition
   * --assign first live replica as the leader and all live replicas as the isr; write leader and isr to ZK for this partition
   * --send LeaderAndIsr request to every live replica and UpdateMetadata request to every live broker
   *
   * OnlinePartition,OfflinePartition -&gt; OnlinePartition
   * --select new leader and isr for this partition and a set of replicas to receive the LeaderAndIsr request, and write leader and isr to ZK
   * --for this partition, send LeaderAndIsr request to every receiving replica and UpdateMetadata request to every live broker
   *
   * NewPartition,OnlinePartition,OfflinePartition -&gt; OfflinePartition
   * --nothing other than marking partition state as Offline
   *
   * OfflinePartition -&gt; NonExistentPartition
   * --nothing other than marking the partition state as NonExistentPartition
   * @param topic       The topic of the partition for which the state transition is invoked
   * @param partition   The partition for which the state transition is invoked
   * @param targetState The end state that the partition should be moved to
   */</span>
  private def <a title="(topic: String, partition: Int, targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit" id="kafka.controller;PartitionStateMachine.handleStateChange">handleStateChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.handleStateChange.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;PartitionStateMachine.handleStateChange.partition">partition</a>: <span title="Int">Int</span>, <a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.handleStateChange.targetState">targetState</a>: <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a>,
                                <a title="kafka.controller.PartitionLeaderSelector" id="kafka.controller;PartitionStateMachine.handleStateChange.leaderSelector">leaderSelector</a>: <a href="PartitionLeaderSelector.scala.html#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a>,
                                <a title="kafka.controller.Callbacks" id="kafka.controller;PartitionStateMachine.handleStateChange.callbacks">callbacks</a>: <a href="ControllerChannelManager.scala.html#kafka.controller;Callbacks" title="kafka.controller.Callbacks">Callbacks</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.partition" title="Int">partition</a><span class="delimiter">)</span>
    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="()Boolean">get</span><span class="delimiter">)</span>
      throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Controller %d epoch %d initiated state change for partition %s to %s failed because &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                                            <span class="string">&quot;the partition state machine has not started&quot;</span><span class="delimiter">)</span>
                                              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.handleStateChange.currState">currState</a> = <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, op: =&gt; kafka.controller.PartitionState)kafka.controller.PartitionState">getOrElseUpdate</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller.NonExistentPartition.readResolve" title="kafka.controller.NonExistentPartition.type">NonExistentPartition</a><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a> match <span class="delimiter">{</span>
        case <a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a> =&gt;
          <span class="comment">// pre: partition did not exist before this</span>
          <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates" title="(topicAndPartition: kafka.common.TopicAndPartition, fromStates: Seq[kafka.controller.PartitionState], targetState: kafka.controller.PartitionState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="(xs: kafka.controller.NonExistentPartition.type*)List[kafka.controller.NonExistentPartition.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NonExistentPartition.readResolve" title="kafka.controller.NonExistentPartition.type">NonExistentPartition</a><span class="delimiter">)</span>, <a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions" title="(topic: String, partition: Int)Unit">assignReplicasToPartitions</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.partition" title="Int">partition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a><span class="delimiter">)</span>
          val <a title="String" id="kafka.controller;PartitionStateMachine.handleStateChange.assignedReplicas">assignedReplicas</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed partition %s state from %s to %s with assigned replicas %s&quot;</span>
                                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.currState" title="kafka.controller.PartitionState">currState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a>,
                                            <a href="#kafka.controller;PartitionStateMachine.handleStateChange.assignedReplicas" title="String">assignedReplicas</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">// post: partition has been assigned replicas</span>
        case <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a> =&gt;
          <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates" title="(topicAndPartition: kafka.common.TopicAndPartition, fromStates: Seq[kafka.controller.PartitionState], targetState: kafka.controller.PartitionState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="(xs: Product with Serializable with kafka.controller.PartitionState*)List[Product with Serializable with kafka.controller.PartitionState]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="(key: kafka.common.TopicAndPartition)kafka.controller.PartitionState">partitionState</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
            case <a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a> =&gt;
              <span class="comment">// initialize leader and isr path for new partition</span>
              <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">initializeLeaderAndIsrForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
            case <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a> =&gt;
              <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition" title="(topic: String, partition: Int, leaderSelector: kafka.controller.PartitionLeaderSelector)Unit">electLeaderForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.partition" title="Int">partition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.leaderSelector" title="kafka.controller.PartitionLeaderSelector">leaderSelector</a><span class="delimiter">)</span>
            case <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a> =&gt; <span class="comment">// invoked when the leader needs to be re-elected</span>
              <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition" title="(topic: String, partition: Int, leaderSelector: kafka.controller.PartitionLeaderSelector)Unit">electLeaderForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.partition" title="Int">partition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.leaderSelector" title="kafka.controller.PartitionLeaderSelector">leaderSelector</a><span class="delimiter">)</span>
            case _ =&gt; <span class="comment">// should never come here since illegal previous states are checked above</span>
          <span class="delimiter">}</span>
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a><span class="delimiter">)</span>
          val <a title="Int" id="kafka.controller;PartitionStateMachine.handleStateChange.leader">leader</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
          <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed partition %s from %s to %s with leader %d&quot;</span>
                                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.currState" title="kafka.controller.PartitionState">currState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.leader" title="Int">leader</a><span class="delimiter">)</span><span class="delimiter">)</span>
           <span class="comment">// post: partition has a leader</span>
        case <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a> =&gt;
          <span class="comment">// pre: partition should be in New or Online state</span>
          <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates" title="(topicAndPartition: kafka.common.TopicAndPartition, fromStates: Seq[kafka.controller.PartitionState], targetState: kafka.controller.PartitionState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="(xs: Product with Serializable with kafka.controller.PartitionState*)List[Product with Serializable with kafka.controller.PartitionState]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>, <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>
          <span class="comment">// should be called when the leader for a partition is no longer alive</span>
          <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed partition %s state from %s to %s&quot;</span>
                                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.currState" title="kafka.controller.PartitionState">currState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span title="Unit" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>
          <span class="comment">// post: partition has no alive leader</span>
        case <a href="#kafka.controller.NonExistentPartition.readResolve" title="kafka.controller.NonExistentPartition.type">NonExistentPartition</a> =&gt;
          <span class="comment">// pre: partition should be in Offline state</span>
          <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates" title="(topicAndPartition: kafka.common.TopicAndPartition, fromStates: Seq[kafka.controller.PartitionState], targetState: kafka.controller.PartitionState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="(xs: kafka.controller.OfflinePartition.type*)List[kafka.controller.OfflinePartition.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>, <a href="#kafka.controller.NonExistentPartition.readResolve" title="kafka.controller.NonExistentPartition.type">NonExistentPartition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed partition %s state from %s to %s&quot;</span>
                                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.currState" title="kafka.controller.PartitionState">currState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span title="Unit" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller.NonExistentPartition.readResolve" title="kafka.controller.NonExistentPartition.type">NonExistentPartition</a><span class="delimiter">)</span>
          <span class="comment">// post: partition state is deleted from all brokers and zookeeper</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;PartitionStateMachine.handleStateChange.t">t</a>: <span title="Throwable">Throwable</span> =&gt;
        <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d initiated state change for partition %s from %s to %s failed&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.currState" title="kafka.controller.PartitionState">currState</a>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.handleStateChange.t" title="Throwable">t</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on startup of the partition's state machine to set the initial state for all existing partitions in
   * zookeeper
   */</span>
  private def <a title="()Unit" id="kafka.controller;PartitionStateMachine.initializePartitionState">initializePartitionState</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    for<span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.topicPartition">topicPartition</a>, <a title="Seq[Int]" id="kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.replicaAssignment">replicaAssignment</a><span class="delimiter">)</span> &lt;- <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Option[kafka.controller.PartitionState])Unit">partitionReplicaAssignment</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// check if leader and isr path exists for partition. If not, then it is in NEW state</span>
      <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.LeaderIsrAndControllerEpoch]">get</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.currentLeaderIsrAndEpoch">currentLeaderIsrAndEpoch</a><span class="delimiter">)</span> =&gt;
          <span class="comment">// else, check if the leader for partition is alive. If yes, it is in Online state, else it is in Offline state</span>
          <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.currentLeaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">currentLeaderIsrAndEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
            case true =&gt; <span class="comment">// leader is alive</span>
              <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>, <a href="#kafka.controller.OnlinePartition.readResolve" title="kafka.controller.OnlinePartition.type">OnlinePartition</a><span class="delimiter">)</span>
            case false =&gt;
              <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>, <a href="#kafka.controller.OfflinePartition.readResolve" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        case <span title="None.type">None</span> =&gt;
          <a href="#kafka.controller;PartitionStateMachine.partitionState" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.PartitionState]">partitionState</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.PartitionState)Option[kafka.controller.PartitionState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializePartitionState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>, <a href="#kafka.controller.NewPartition.readResolve" title="kafka.controller.NewPartition.type">NewPartition</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, fromStates: Seq[kafka.controller.PartitionState], targetState: kafka.controller.PartitionState)Unit" id="kafka.controller;PartitionStateMachine.assertValidPreviousStates">assertValidPreviousStates</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.assertValidPreviousStates.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="Seq[kafka.controller.PartitionState]" id="kafka.controller;PartitionStateMachine.assertValidPreviousStates.fromStates">fromStates</a>: <span title="Seq[kafka.controller.PartitionState]">Seq</span><span class="delimiter">[</span>PartitionState<span class="delimiter">]</span>,
                                        <a title="kafka.controller.PartitionState" id="kafka.controller;PartitionStateMachine.assertValidPreviousStates.targetState">targetState</a>: <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.fromStates" title="Seq[kafka.controller.PartitionState]">fromStates</a>.<span title="(elem: kafka.controller.PartitionState)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.partitionState" title="(key: kafka.common.TopicAndPartition)kafka.controller.PartitionState">partitionState</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s should be in the %s states before moving to %s state&quot;</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.fromStates" title="Seq[kafka.controller.PartitionState]">fromStates</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.targetState" title="kafka.controller.PartitionState">targetState</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;. Instead it is in %s state&quot;</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.partitionState" title="(key: kafka.common.TopicAndPartition)kafka.controller.PartitionState">partitionState</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.assertValidPreviousStates.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on the NonExistentPartition-&gt;NewPartition state transition to update the controller's cache with the
   * partition's replica assignment.
   * @param topic     The topic of the partition whose replica assignment is to be cached
   * @param partition The partition whose replica assignment is to be cached
   */</span>
  private def <a title="(topic: String, partition: Int)Unit" id="kafka.controller;PartitionStateMachine.assignReplicasToPartitions">assignReplicasToPartitions</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.assignReplicasToPartitions.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;PartitionStateMachine.assignReplicasToPartitions.partition">partition</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;PartitionStateMachine.assignReplicasToPartitions.assignedReplicas">assignedReplicas</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getReplicasForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Seq[Int]">getReplicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions.partition" title="Int">partition</a><span class="delimiter">)</span>
    <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a> <span title="(kv: (kafka.common.TopicAndPartition, Seq[Int]))scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">+=</span> <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span title="(self: kafka.common.TopicAndPartition)ArrowAssoc[kafka.common.TopicAndPartition]" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions.partition" title="Int">partition</a><span class="delimiter">)</span> <span title="(y: Seq[Int])(kafka.common.TopicAndPartition, Seq[Int])">-&gt;</span> <a href="#kafka.controller;PartitionStateMachine.assignReplicasToPartitions.assignedReplicas" title="Seq[Int]">assignedReplicas</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on the NewPartition-&gt;OnlinePartition state change. When a partition is in the New state, it does not have
   * a leader and isr path in zookeeper. Once the partition moves to the OnlinePartition state, it's leader and isr
   * path gets initialized and it never goes back to the NewPartition state. From here, it can only go to the
   * OfflinePartition state.
   * @param topicAndPartition   The topic/partition whose leader and isr path is to be initialized
   */</span>
  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition)Unit" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition">initializeLeaderAndIsrForPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.replicaAssignment">replicaAssignment</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
    val <a title="Seq[Int]" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas">liveAssignedReplicas</a> = <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.replicaAssignment" title="Seq[Int]">replicaAssignment</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="=&gt; Int">size</span> match <span class="delimiter">{</span>
      case <span title="Int(0)" class="int">0</span> =&gt;
        val <span title="String">failMsg</span> = <span class="delimiter">(</span><span class="string">&quot;encountered error during state change of partition %s from New to Online, assigned replicas are [%s], &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                       <span class="string">&quot;live brokers are [%s]. No assigned replica is alive.&quot;</span><span class="delimiter">)</span>
                         .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.replicaAssignment" title="Seq[Int]">replicaAssignment</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a><span class="delimiter">)</span>
        <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String">failMsg</span><span class="delimiter">)</span>
        throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String">failMsg</span><span class="delimiter">)</span>
      case _ =&gt;
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Live assigned replicas for partition %s are: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="comment">// make the first replica in the list of assigned replicas, the leader</span>
        val <a title="Int" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leader">leader</a> = <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="=&gt; Int">head</span>
        val <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a> = new <a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a><span class="delimiter">(</span>new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leader" title="Int">leader</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="=&gt; List[Int]">toList</span><span class="delimiter">)</span>,
          <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Initializing leader and isr for partition %s to %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
        try <span class="delimiter">{</span>
          <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.createPersistentPath" title="(client: org.I0Itec.zkclient.ZkClient, path: String, data: String)Unit">createPersistentPath</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>,
            <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPartitionLeaderAndIsrPath" title="(topic: String, partitionId: Int)String">getTopicPartitionLeaderAndIsrPath</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span>,
            <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.leaderAndIsrZkData" title="(leaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int)String">leaderAndIsrZkData</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">// NOTE: the above write can fail only if the current controller lost its zk session and the new controller</span>
          <span class="comment">// took over and initialized this partition. This can happen if the current controller went into a long</span>
          <span class="comment">// GC pause</span>
          <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.LeaderIsrAndControllerEpoch)Option[kafka.controller.LeaderIsrAndControllerEpoch]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>,
            <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.replicaAssignment" title="Seq[Int]">replicaAssignment</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <a title="org.I0Itec.zkclient.exception.ZkNodeExistsException" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.e">e</a>: <span title="org.I0Itec.zkclient.exception.ZkNodeExistsException">ZkNodeExistsException</span> =&gt;
            <span class="comment">// read the controller epoch</span>
            val <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndEpoch">leaderIsrAndEpoch</a> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.getLeaderIsrAndEpochForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">getLeaderIsrAndEpochForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>,
              <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">get</span>
            val <span title="String">failMsg</span> = <span class="delimiter">(</span><span class="string">&quot;encountered error while changing partition %s's state from New to Online since LeaderAndIsr path already &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                           <span class="string">&quot;exists with value %s and controller epoch %d&quot;</span><span class="delimiter">)</span>
                             .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.toString" title="()String">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.initializeLeaderAndIsrForPartition.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span>
            <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String">failMsg</span><span class="delimiter">)</span>
            throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String">failMsg</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on the OfflinePartition,OnlinePartition-&gt;OnlinePartition state change.
   * It invokes the leader election API to elect a leader for the input offline partition
   * @param topic               The topic of the offline partition
   * @param partition           The offline partition
   * @param leaderSelector      Specific leader selector (e.g., offline/reassigned/etc.)
   */</span>
  def <a title="(topic: String, partition: Int, leaderSelector: kafka.controller.PartitionLeaderSelector)Unit" id="kafka.controller;PartitionStateMachine.electLeaderForPartition">electLeaderForPartition</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.partition">partition</a>: <span title="Int">Int</span>, <a title="kafka.controller.PartitionLeaderSelector" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderSelector">leaderSelector</a>: <a href="PartitionLeaderSelector.scala.html#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a><span class="delimiter">)</span>
    <span class="comment">// handle leader election for the partitions whose leader is no longer alive</span>
    <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d started leader election for partition %s&quot;</span>
                              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      var <a title="Boolean" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.zookeeperPathUpdateSucceeded">zookeeperPathUpdateSucceeded</a>: <span title="Boolean">Boolean</span> = false
      var <a title="kafka.api.LeaderAndIsr" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderAndIsr">newLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a> = null
      var <a title="Seq[Int]" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.replicasForThisPartition">replicasForThisPartition</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="scala.collection.Seq.type">Seq</span>.<span title="[A]=&gt; Seq[A]">empty</span><span title="Seq[Int]" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
      while<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.zookeeperPathUpdateSucceeded" title="Boolean">zookeeperPathUpdateSucceeded</a><span class="delimiter">)</span> <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.while$1" title="()Unit" class="delimiter">{</a>
        val <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderIsrAndEpoch">currentLeaderIsrAndEpoch</a> = <a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException" title="(topic: String, partition: Int)kafka.controller.LeaderIsrAndControllerEpoch">getLeaderIsrAndEpochOrThrowException</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a><span class="delimiter">)</span>
        val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderAndIsr">currentLeaderAndIsr</a> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">currentLeaderIsrAndEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>
        val <a title="Int" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.controllerEpoch">controllerEpoch</a> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">currentLeaderIsrAndEpoch</a>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a>
        if <span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.controllerEpoch" title="Int">controllerEpoch</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          val <span title="String">failMsg</span> = <span class="delimiter">(</span><span class="string">&quot;aborted leader election for partition [%s,%d] since the LeaderAndIsr path was &quot;</span> +
                         <span class="string">&quot;already written by another controller. This probably means that the current controller %d went through &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                         <span class="string">&quot;a soft failure and another controller was elected with epoch %d.&quot;</span><span class="delimiter">)</span>
                           .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a>, <a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.controllerEpoch" title="Int">controllerEpoch</a><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String">failMsg</span><span class="delimiter">)</span>
          throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String">failMsg</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="comment">// elect new leader or throw exception</span>
        val <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderAndIsr" title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</a><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.x$4" title="kafka.api.LeaderAndIsr" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderAndIsr">leaderAndIsr</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.x$4" title="Seq[Int]" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.x$4.replicas">replicas</a><span class="delimiter">)</span> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderSelector" title="kafka.controller.PartitionLeaderSelector">leaderSelector</a>.<a href="PartitionLeaderSelector.scala.html#kafka.controller;PartitionLeaderSelector.selectLeader" title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])">selectLeader</a><span title="(kafka.api.LeaderAndIsr, Seq[Int]) @unchecked" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a><span class="delimiter">)</span>
        val <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.updateSucceeded" title="(Boolean, Int)" class="delimiter">(</a><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.x$5" title="Boolean" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.updateSucceeded">updateSucceeded</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.x$5" title="Int" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.newVersion">newVersion</a><span class="delimiter">)</span> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.updateLeaderAndIsr" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partitionId: Int, newLeaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int, zkVersion: Int)(Boolean, Int)">updateLeaderAndIsr</a><span title="(Boolean, Int) @unchecked" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a>,
          <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a><span class="delimiter">)</span>
        <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>
        <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion_=" title="(x$1: Int)Unit">zkVersion</a> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newVersion" title="Int">newVersion</a>
        <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.zookeeperPathUpdateSucceeded" title="Boolean">zookeeperPathUpdateSucceeded</a> = <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.updateSucceeded" title="Boolean">updateSucceeded</a>
        <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.replicasForThisPartition" title="Seq[Int]">replicasForThisPartition</a> = <span title="Seq[Int]">replicas</span>
      <span class="delimiter">}</span>
      val <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderIsrAndControllerEpoch">newLeaderIsrAndControllerEpoch</a> = new <a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span>
      <span class="comment">// update the leader cache</span>
      <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.LeaderIsrAndControllerEpoch)Option[kafka.controller.LeaderIsrAndControllerEpoch]">put</span><span class="delimiter">(</span><a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">newLeaderIsrAndControllerEpoch</a><span class="delimiter">)</span>
      <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d elected leader %d for Offline partition %s&quot;</span>
                                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
      val <span title="Seq[Int]">replicas</span> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">// store new leader and isr info in cache</span>
      <a href="#kafka.controller;PartitionStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.replicasForThisPartition" title="Seq[Int]">replicasForThisPartition</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.partition" title="Int">partition</a>,
        <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.newLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">newLeaderIsrAndControllerEpoch</a>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="kafka.common.LeaderElectionNotNeededException" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.lenne">lenne</a>: <a href="../common/LeaderElectionNotNeededException.scala.html#kafka.common;LeaderElectionNotNeededException" title="kafka.common.LeaderElectionNotNeededException">LeaderElectionNotNeededException</a> =&gt; <span class="comment">// swallow</span>
      case <a title="kafka.common.NoReplicaOnlineException" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.nroe">nroe</a>: <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a> =&gt; throw <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.nroe" title="kafka.common.NoReplicaOnlineException">nroe</a>
      case <a title="Throwable" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.sce">sce</a>: <span title="Throwable">Throwable</span> =&gt;
        val <span title="String">failMsg</span> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;encountered error while electing leader for partition %s due to: %s.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.sce" title="Throwable">sce</a>.<span title="()String">getMessage</span><span class="delimiter">)</span>
        <a href="#kafka.controller;PartitionStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String">failMsg</span><span class="delimiter">)</span>
        throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String">failMsg</span>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.sce" title="Throwable">sce</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;After leader election, leader cache is updated to %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; (kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch],(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch),Any])Any">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map.Coll,(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch),scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]]" class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)" id="kafka.controller;PartitionStateMachine.electLeaderForPartition.$anonfun.l">l</a> =&gt; <span title="(_1: kafka.common.TopicAndPartition, _2: kafka.controller.LeaderIsrAndControllerEpoch)(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.$anonfun.l" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">l</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>, <a href="#kafka.controller;PartitionStateMachine.electLeaderForPartition.$anonfun.l" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">l</a>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">_2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()java.util.List[String]" id="kafka.controller;PartitionStateMachine.registerTopicChangeListener">registerTopicChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)java.util.List[String]">subscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.BrokerTopicsPath" title="=&gt; String">BrokerTopicsPath</a>, <a href="#kafka.controller;PartitionStateMachine.topicChangeListener" title="=&gt; PartitionStateMachine.this.TopicChangeListener">topicChangeListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;PartitionStateMachine.deregisterTopicChangeListener">deregisterTopicChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)Unit">unsubscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.BrokerTopicsPath" title="=&gt; String">BrokerTopicsPath</a>, <a href="#kafka.controller;PartitionStateMachine.topicChangeListener" title="=&gt; PartitionStateMachine.this.TopicChangeListener">topicChangeListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)Unit" id="kafka.controller;PartitionStateMachine.registerPartitionChangeListener">registerPartitionChangeListener</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.registerPartitionChangeListener.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="=&gt; scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">addPartitionsListener</a>.<span title="(key: String, value: PartitionStateMachine.this.AddPartitionsListener)Option[PartitionStateMachine.this.AddPartitionsListener]">put</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.registerPartitionChangeListener.topic" title="String">topic</a>, new <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener" title="PartitionStateMachine.this.AddPartitionsListener">AddPartitionsListener</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.registerPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">subscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPath" title="(topic: String)String">getTopicPath</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.registerPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="(key: String)PartitionStateMachine.this.AddPartitionsListener">addPartitionsListener</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.registerPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)Option[PartitionStateMachine.this.AddPartitionsListener]" id="kafka.controller;PartitionStateMachine.deregisterPartitionChangeListener">deregisterPartitionChangeListener</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.deregisterPartitionChangeListener.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPath" title="(topic: String)String">getTopicPath</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.deregisterPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="(key: String)PartitionStateMachine.this.AddPartitionsListener">addPartitionsListener</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.deregisterPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;PartitionStateMachine.addPartitionsListener" title="=&gt; scala.collection.mutable.Map[String,PartitionStateMachine.this.AddPartitionsListener]">addPartitionsListener</a>.<span title="(key: String)Option[PartitionStateMachine.this.AddPartitionsListener]">remove</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.deregisterPartitionChangeListener.topic" title="String">topic</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()java.util.List[String]" id="kafka.controller;PartitionStateMachine.registerDeleteTopicListener">registerDeleteTopicListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)java.util.List[String]">subscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.DeleteTopicsPath" title="=&gt; String">DeleteTopicsPath</a>, <a href="#kafka.controller;PartitionStateMachine.deleteTopicsListener" title="=&gt; PartitionStateMachine.this.DeleteTopicsListener">deleteTopicsListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;PartitionStateMachine.deregisterDeleteTopicListener">deregisterDeleteTopicListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)Unit">unsubscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.DeleteTopicsPath" title="=&gt; String">DeleteTopicsPath</a>, <a href="#kafka.controller;PartitionStateMachine.deleteTopicsListener" title="=&gt; PartitionStateMachine.this.DeleteTopicsListener">deleteTopicsListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="(topic: String, partition: Int)kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException">getLeaderIsrAndEpochOrThrowException</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.partition">partition</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a> = <span class="delimiter">{</span>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.partition" title="Int">partition</a><span class="delimiter">)</span>
    <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.getLeaderIsrAndEpochForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">getLeaderIsrAndEpochForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topic" title="String">topic</a>, <a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.partition" title="Int">partition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.currentLeaderIsrAndEpoch">currentLeaderIsrAndEpoch</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.currentLeaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">currentLeaderIsrAndEpoch</a>
      case <span title="None.type">None</span> =&gt;
        val <a title="String" id="kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.failMsg">failMsg</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;LeaderAndIsr information doesn't exist for partition %s in %s state&quot;</span>
                        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PartitionStateMachine.partitionState" title="(key: kafka.common.TopicAndPartition)kafka.controller.PartitionState">partitionState</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
        throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.getLeaderIsrAndEpochOrThrowException.failMsg" title="String">failMsg</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This is the zookeeper listener that triggers all the state transitions for a partition
   */</span>
  class <a title="class TopicChangeListener extends Object with org.I0Itec.zkclient.IZkChildListener with kafka.utils.Logging" id="kafka.controller;PartitionStateMachine;TopicChangeListener">TopicChangeListener</a> extends <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener" title="org.I0Itec.zkclient.IZkChildListener">IZkChildListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
    this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[TopicChangeListener on Controller &quot;)" class="string">&quot;[TopicChangeListener on Controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>

    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(parentPath: String, children: java.util.List[String])Unit" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange">handleChildChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.parentPath">parentPath</a> : <span title="String">String</span>, <a title="java.util.List[String]" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.children">children</a> : java.util.<span title="java.util.List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          try <span class="delimiter">{</span>
            val <a title="scala.collection.immutable.Set[String]" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.currentChildren">currentChildren</a> = <span class="delimiter">{</span>
              import <span title="scala.collection.JavaConversions.type">JavaConversions</span>._
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Topic change listener fired for path %s with children %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.parentPath" title="String">parentPath</a>, <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.children" title="(l: java.util.List[String])scala.collection.mutable.Buffer[String]">children</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.children" title="(l: java.util.List[String])scala.collection.mutable.Buffer[String]">children</a>: <span title="scala.collection.mutable.Buffer[String]">Buffer</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
            <span class="delimiter">}</span>
            val newTopics = <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.currentChildren" title="scala.collection.immutable.Set[String]">currentChildren</a> <a title="scala.collection.immutable.Set[String]" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.newTopics">--</a> <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.allTopics" title="=&gt; scala.collection.Set[String]">allTopics</a>
            val deletedTopics = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.allTopics" title="=&gt; scala.collection.Set[String]">allTopics</a> <a title="scala.collection.Set[String]" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.deletedTopics">--</a> <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.currentChildren" title="scala.collection.immutable.Set[String]">currentChildren</a>
            <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.allTopics_=" title="(x$1: scala.collection.Set[String])Unit">allTopics</a> = <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.currentChildren" title="scala.collection.immutable.Set[String]">currentChildren</a>

            val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.addedPartitionReplicaAssignment">addedPartitionReplicaAssignment</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getReplicaAssignmentForTopics" title="(zkClient: org.I0Itec.zkclient.ZkClient, topics: Seq[String])scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">getReplicaAssignmentForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.newTopics" title="scala.collection.immutable.Set[String]">newTopics</a>.<span title="=&gt; Seq[String]">toSeq</span><span class="delimiter">)</span>
            <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(x$1: scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit">partitionReplicaAssignment</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.$anonfun.p">p</a> =&gt;
              <span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.deletedTopics" title="scala.collection.Set[String]">deletedTopics</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.$anonfun.p" title="(kafka.common.TopicAndPartition, Seq[Int])">p</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(xs: scala.collection.TraversableOnce[(kafka.common.TopicAndPartition, Seq[Int])])scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">++=</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.addedPartitionReplicaAssignment" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">addedPartitionReplicaAssignment</a><span class="delimiter">)</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New topics: [%s], deleted topics: [%s], new partition replica assignment [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.newTopics" title="scala.collection.immutable.Set[String]">newTopics</a>,
              <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.deletedTopics" title="scala.collection.Set[String]">deletedTopics</a>, <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.addedPartitionReplicaAssignment" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">addedPartitionReplicaAssignment</a><span class="delimiter">)</span><span class="delimiter">)</span>
            if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.newTopics" title="scala.collection.immutable.Set[String]">newTopics</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
              <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.onNewTopicCreation" title="(topics: scala.collection.Set[String], newPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">onNewTopicCreation</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.newTopics" title="scala.collection.immutable.Set[String]">newTopics</a>, <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.addedPartitionReplicaAssignment" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">addedPartitionReplicaAssignment</a>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">toSet</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> catch <span class="delimiter">{</span>
            case <a title="Throwable" id="kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while handling new topic&quot;)" class="string">&quot;Error while handling new topic&quot;</span>, <a href="#kafka.controller;PartitionStateMachine;TopicChangeListener.handleChildChange.e" title="Throwable">e</a> <span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Delete topics includes the following operations -
   * 1. Add the topic to be deleted to the delete topics cache, only if the topic exists
   * 2. If there are topics to be deleted, it signals the delete topic thread
   */</span>
  class <a title="class DeleteTopicsListener extends Object with org.I0Itec.zkclient.IZkChildListener with kafka.utils.Logging" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener">DeleteTopicsListener</a><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener" title="PartitionStateMachine.this.DeleteTopicsListener" class="delimiter">(</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener" title="org.I0Itec.zkclient.IZkChildListener">IZkChildListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
    this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[DeleteTopicsListener on &quot;)" class="string">&quot;[DeleteTopicsListener on &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
    val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.zkClient">zkClient</a> = <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>

    <span class="comment">/**
     * Invoked when a topic is being deleted
     * @throws Exception On any error.
     */</span>
    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(parentPath: String, children: java.util.List[String])Unit" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange">handleChildChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.parentPath">parentPath</a> : <span title="String">String</span>, <a title="java.util.List[String]" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.children">children</a> : java.util.<span title="java.util.List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        var <a title="scala.collection.immutable.Set[String]" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted">topicsToBeDeleted</a> = <span class="delimiter">{</span>
          import <span title="scala.collection.JavaConversions.type">JavaConversions</span>._
          <span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.children" title="(l: java.util.List[String])scala.collection.mutable.Buffer[String]">children</a>: <span title="scala.collection.mutable.Buffer[String]">Buffer</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
        <span class="delimiter">}</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Delete topics listener fired for topics %s to be deleted&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        val <a title="scala.collection.immutable.Set[String]" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics">nonExistentTopics</a> = <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a>.<span title="(p: String =&gt; Boolean)scala.collection.immutable.Set[String]">filter</span><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics.$anonfun.t">t</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.allTopics" title="=&gt; scala.collection.Set[String]">allTopics</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics.$anonfun.t" title="String">t</a><span class="delimiter">)</span><span class="delimiter">)</span>
        if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics" title="scala.collection.immutable.Set[String]">nonExistentTopics</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="String(&quot;Ignoring request to delete non-existing topics &quot;)" class="string">&quot;Ignoring request to delete non-existing topics &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics" title="scala.collection.immutable.Set[String]">nonExistentTopics</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics" title="scala.collection.immutable.Set[String]">nonExistentTopics</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><span title="String">topic</span> =&gt; <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.deletePathRecursive" title="(client: org.I0Itec.zkclient.ZkClient, path: String)Unit">deletePathRecursive</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getDeleteTopicPath" title="(topic: String)String">getDeleteTopicPath</a><span class="delimiter">(</span><span title="String">topic</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a> <span title="(xs: scala.collection.GenTraversableOnce[String])scala.collection.immutable.Set[String]">--=</span> <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.nonExistentTopics" title="scala.collection.immutable.Set[String]">nonExistentTopics</a>
        if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Starting topic deletion for topics &quot;)" class="string">&quot;Starting topic deletion for topics &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">// mark topic ineligible for deletion if other state changes are in progress</span>
          <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="String">topic</span> =&gt;
            val <a title="Boolean" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.preferredReplicaElectionInProgress">preferredReplicaElectionInProgress</a> =
              <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Set[kafka.common.TopicAndPartition],String,scala.collection.mutable.Set[String]])scala.collection.mutable.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Set.Coll,String,scala.collection.mutable.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.preferredReplicaElectionInProgress.$anonfun.x$6" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><span title="String">topic</span><span class="delimiter">)</span>
            val <a title="Boolean" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.partitionReassignmentInProgress">partitionReassignmentInProgress</a> =
              <a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionsBeingReassigned" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.partitionReassignmentInProgress.$anonfun.x$7" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><span title="String">topic</span><span class="delimiter">)</span>
            if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.preferredReplicaElectionInProgress" title="Boolean">preferredReplicaElectionInProgress</a> <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.$anonfun.partitionReassignmentInProgress" title="Boolean">partitionReassignmentInProgress</a><span class="delimiter">)</span>
              <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.deleteTopicManager" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.markTopicIneligibleForDeletion" title="(topics: scala.collection.Set[String])Unit">markTopicIneligibleForDeletion</a><span class="delimiter">(</span><span title="(elems: String*)scala.collection.Set[String]">Set</span><span class="delimiter">(</span><span title="String">topic</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <span class="comment">// add topic to deletion list</span>
          <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.deleteTopicManager" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.enqueueTopicsForDeletion" title="(topics: scala.collection.Set[String])Unit">enqueueTopicsForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleChildChange.topicsToBeDeleted" title="scala.collection.immutable.Set[String]">topicsToBeDeleted</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     *
     * @throws Exception
   *             On any error.
     */</span>
    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(dataPath: String)Unit" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleDataDeleted">handleDataDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;DeleteTopicsListener.handleDataDeleted.dataPath">dataPath</a>: <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  class <a title="class AddPartitionsListener extends Object with org.I0Itec.zkclient.IZkDataListener with kafka.utils.Logging" id="kafka.controller;PartitionStateMachine;AddPartitionsListener">AddPartitionsListener</a><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener" title="PartitionStateMachine.this.AddPartitionsListener" class="delimiter">(</a><a title="String" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener" title="org.I0Itec.zkclient.IZkDataListener">IZkDataListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>

    this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[AddPartitionsListener on &quot;)" class="string">&quot;[AddPartitionsListener on &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>

    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(dataPath: String, data: Object)Unit" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange">handleDataChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.dataPath">dataPath</a> : <span title="String">String</span>, <a title="Object" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.data">data</a>: <span title="Object">Object</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        try <span class="delimiter">{</span>
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Add Partition triggered &quot;)" class="string">&quot;Add Partition triggered &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.data" title="Object">data</a>.<span title="()String">toString</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot; for path &quot;)" class="string">&quot; for path &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.dataPath" title="String">dataPath</a><span class="delimiter">)</span>
          val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionReplicaAssignment">partitionReplicaAssignment</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getReplicaAssignmentForTopics" title="(zkClient: org.I0Itec.zkclient.ZkClient, topics: Seq[String])scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">getReplicaAssignmentForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <span title="(xs: String*)List[String]">List</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
          val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded">partitionsToBeAdded</a> = <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionReplicaAssignment" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded.$anonfun.p">p</a> =&gt;
            <span title="=&gt; Boolean">!</span><a href="#kafka.controller;PartitionStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded.$anonfun.p" title="(kafka.common.TopicAndPartition, Seq[Int])">p</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span><span class="delimiter">)</span>
          if<span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.deleteTopicManager" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Skipping adding partitions %s for topic %s since it is currently being deleted&quot;</span>
                  .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsToBeAdded</a>.<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]],Int,scala.collection.mutable.Iterable[Int]])scala.collection.mutable.Iterable[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Iterable.Coll,Int,scala.collection.mutable.Iterable[Int]]" class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.$anonfun.x$8" title="(kafka.common.TopicAndPartition, Seq[Int])">_</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
          else <span class="delimiter">{</span>
            if <span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsToBeAdded</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New partitions to be added %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsToBeAdded</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.controller;PartitionStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.onNewPartitionCreation" title="(newPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">onNewPartitionCreation</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.partitionsToBeAdded" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsToBeAdded</a>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">toSet</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <a title="Throwable" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while handling add partitions for data path &quot;)" class="string">&quot;Error while handling add partitions for data path &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.dataPath" title="String">dataPath</a>, <a href="#kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataChange.e" title="Throwable">e</a> <span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(parentPath: String)Unit" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataDeleted">handleDataDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionStateMachine;AddPartitionsListener.handleDataDeleted.parentPath">parentPath</a> : <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
      <span class="comment">// this is not implemented for partition change</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

sealed trait <a title="trait PartitionState extends AnyRef" id="kafka.controller;PartitionState">PartitionState</a> <span class="delimiter">{</span> def <a title="=&gt; Byte" id="kafka.controller;PartitionState.state">state</a>: <span title="Byte">Byte</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.NewPartition.productElement.x$1" title="kafka.controller.NewPartition.type" id="kafka.controller.NewPartition.readResolve">NewPartition</a> extends <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.NewPartition.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(0)" class="int">0</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.OnlinePartition.productElement.x$1" title="kafka.controller.OnlinePartition.type" id="kafka.controller.OnlinePartition.readResolve">OnlinePartition</a> extends <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.OnlinePartition.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(1)" class="int">1</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.OfflinePartition.productElement.x$1" title="kafka.controller.OfflinePartition.type" id="kafka.controller.OfflinePartition.readResolve">OfflinePartition</a> extends <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.OfflinePartition.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(2)" class="int">2</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.NonExistentPartition.productElement.x$1" title="kafka.controller.NonExistentPartition.type" id="kafka.controller.NonExistentPartition.readResolve">NonExistentPartition</a> extends <a href="#kafka.controller;PartitionState" title="kafka.controller.PartitionState">PartitionState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.NonExistentPartition.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(3)" class="int">3</span> <span class="delimiter">}</span>

        </pre>
    </body>
</html>
