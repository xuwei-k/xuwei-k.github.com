<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/controller/KafkaController.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
package kafka.controller

import collection._
import collection.Set
import com.yammer.metrics.core.Gauge
import java.lang.<span class="delimiter">{</span>IllegalStateException, Object<span class="delimiter">}</span>
import java.util.concurrent.TimeUnit
import kafka.admin.AdminUtils
import kafka.admin.PreferredReplicaLeaderElectionCommand
import kafka.api._
import kafka.cluster.Broker
import kafka.common._
import kafka.log.LogConfig
import kafka.metrics.<span class="delimiter">{</span>KafkaTimer, KafkaMetricsGroup<span class="delimiter">}</span>
import kafka.utils.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>._
import kafka.utils._
import kafka.utils.<a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>._
import org.apache.zookeeper.<span title="org.apache.zookeeper.Watcher.type">Watcher</span>.<span title="org.apache.zookeeper.Watcher.Event.type">Event</span>.KeeperState
import org.I0Itec.zkclient.<span class="delimiter">{</span>IZkDataListener, IZkStateListener, ZkClient<span class="delimiter">}</span>
import org.I0Itec.zkclient.exception.<span class="delimiter">{</span>ZkNodeExistsException, ZkNoNodeException<span class="delimiter">}</span>
import java.util.concurrent.atomic.AtomicInteger
import java.util.concurrent.locks.ReentrantLock
import scala.None
import kafka.server._
import scala.Some
import kafka.common.TopicAndPartition

class <a title="class ControllerContext extends AnyRef" id="kafka.controller;ControllerContext">ControllerContext</a><a href="#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext" class="delimiter">(</a>val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;ControllerContext.zkClient">zkClient</a>: <span title="org.I0Itec.zkclient.ZkClient">ZkClient</span>,
                        val <a title="Int" id="kafka.controller;ControllerContext.zkSessionTimeout">zkSessionTimeout</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  var <a title="kafka.controller.ControllerChannelManager" id="kafka.controller;ControllerContext.controllerChannelManager_=">controllerChannelManager</a>: <a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager" title="kafka.controller.ControllerChannelManager">ControllerChannelManager</a> = null
  val <a title="java.util.concurrent.locks.ReentrantLock" id="kafka.controller;ControllerContext.controllerLock">controllerLock</a>: <span title="java.util.concurrent.locks.ReentrantLock">ReentrantLock</span> = new <span title="java.util.concurrent.locks.ReentrantLock">ReentrantLock</span><span class="delimiter">(</span><span class="delimiter">)</span>
  var <a title="scala.collection.mutable.Set[Int]" id="kafka.controller;ControllerContext.shuttingDownBrokerIds_=">shuttingDownBrokerIds</a>: mutable.<span title="scala.collection.mutable.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Set.type">Set</span>.<span title="scala.collection.mutable.Set[Int]">empty</span>
  val <a title="Object" id="kafka.controller;ControllerContext.brokerShutdownLock">brokerShutdownLock</a>: <span title="Object">Object</span> = new <span title="Object">Object</span>
  var epoch: <span title="Int">Int</span> = <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.InitialControllerEpoch" title="=&gt; Int">InitialControllerEpoch</a> <a title="Int" id="kafka.controller;ControllerContext.epoch_=">-</a> <span title="Int(1)" class="int">1</span>
  var epochZkVersion: <span title="Int">Int</span> = <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.InitialControllerEpochZkVersion" title="=&gt; Int">InitialControllerEpochZkVersion</a> <a title="Int" id="kafka.controller;ControllerContext.epochZkVersion_=">-</a> <span title="Int(1)" class="int">1</span>
  val <a title="java.util.concurrent.atomic.AtomicInteger" id="kafka.controller;ControllerContext.correlationId">correlationId</a>: <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span> = new <span title="java.util.concurrent.atomic.AtomicInteger">AtomicInteger</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
  var <a title="scala.collection.Set[String]" id="kafka.controller;ControllerContext.allTopics_=">allTopics</a>: <span title="scala.collection.Set[String]">Set</span><span class="delimiter">[</span>String<span class="delimiter">]</span> = <span title="scala.collection.Set.type">Set</span>.<span title="scala.collection.Set[String]">empty</span>
  var <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;ControllerContext.partitionReplicaAssignment_=">partitionReplicaAssignment</a>: mutable.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">Map</span><span class="delimiter">[</span>TopicAndPartition, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Map.type">Map</span>.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">empty</span>
  var <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;ControllerContext.partitionLeadershipInfo_=">partitionLeadershipInfo</a>: mutable.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">Map</span><span class="delimiter">[</span>TopicAndPartition, LeaderIsrAndControllerEpoch<span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Map.type">Map</span>.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">empty</span>
  var <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;ControllerContext.partitionsBeingReassigned_=">partitionsBeingReassigned</a>: mutable.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">Map</span><span class="delimiter">[</span>TopicAndPartition, ReassignedPartitionsContext<span class="delimiter">]</span> = new mutable.<span title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">HashMap</span>
  var <a title="scala.collection.mutable.Set[kafka.common.TopicAndPartition]" id="kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=">partitionsUndergoingPreferredReplicaElection</a>: mutable.<span title="scala.collection.mutable.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = new mutable.<span title="scala.collection.mutable.HashSet[kafka.common.TopicAndPartition]">HashSet</span>

  private var <a title="scala.collection.Set[kafka.cluster.Broker]" id="kafka.controller;ControllerContext.liveBrokersUnderlying_=">liveBrokersUnderlying</a>: <span title="scala.collection.Set[kafka.cluster.Broker]">Set</span><span class="delimiter">[</span>Broker<span class="delimiter">]</span> = <span title="scala.collection.Set.type">Set</span>.<span title="scala.collection.Set[kafka.cluster.Broker]">empty</span>
  private var <a title="scala.collection.Set[Int]" id="kafka.controller;ControllerContext.liveBrokerIdsUnderlying_=">liveBrokerIdsUnderlying</a>: <span title="scala.collection.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="scala.collection.Set.type">Set</span>.<span title="scala.collection.Set[Int]">empty</span>

  <span class="comment">// setter</span>
  def <a title="(brokers: scala.collection.Set[kafka.cluster.Broker])Unit" id="kafka.controller;ControllerContext.liveBrokers_=">liveBrokers_=</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.cluster.Broker]" id="kafka.controller;ControllerContext.liveBrokers_=.brokers">brokers</a>: <span title="scala.collection.Set[kafka.cluster.Broker]">Set</span><span class="delimiter">[</span>Broker<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.liveBrokersUnderlying_=" title="(x$1: scala.collection.Set[kafka.cluster.Broker])Unit">liveBrokersUnderlying</a> = <a href="#kafka.controller;ControllerContext.liveBrokers_=.brokers" title="scala.collection.Set[kafka.cluster.Broker]">brokers</a>
    <a href="#kafka.controller;ControllerContext.liveBrokerIdsUnderlying_=" title="(x$1: scala.collection.Set[Int])Unit">liveBrokerIdsUnderlying</a> = <a href="#kafka.controller;ControllerContext.liveBrokersUnderlying_=" title="=&gt; scala.collection.Set[kafka.cluster.Broker]">liveBrokersUnderlying</a>.<span title="(f: kafka.cluster.Broker =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.cluster.Broker],Int,scala.collection.Set[Int]])scala.collection.Set[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,Int,scala.collection.Set[Int]]" class="delimiter">(</span><a href="#kafka.controller;ControllerContext.liveBrokers_=.$anonfun.x$1" title="kafka.cluster.Broker">_</a>.<a href="../cluster/Broker.scala.html#kafka.cluster;Broker.id" title="=&gt; Int">id</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// getter</span>
  def <a title="=&gt; scala.collection.Set[kafka.cluster.Broker]" id="kafka.controller;ControllerContext.liveBrokers">liveBrokers</a> = <a href="#kafka.controller;ControllerContext.liveBrokersUnderlying_=" title="=&gt; scala.collection.Set[kafka.cluster.Broker]">liveBrokersUnderlying</a>.<span title="(p: kafka.cluster.Broker =&gt; Boolean)scala.collection.Set[kafka.cluster.Broker]">filter</span><span class="delimiter">(</span><a title="kafka.cluster.Broker" id="kafka.controller;ControllerContext.liveBrokers.$anonfun.broker">broker</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.liveBrokers.$anonfun.broker" title="kafka.cluster.Broker">broker</a>.<a href="../cluster/Broker.scala.html#kafka.cluster;Broker.id" title="=&gt; Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
  def <a title="=&gt; scala.collection.Set[Int]" id="kafka.controller;ControllerContext.liveBrokerIds">liveBrokerIds</a> = <a href="#kafka.controller;ControllerContext.liveBrokerIdsUnderlying_=" title="=&gt; scala.collection.Set[Int]">liveBrokerIdsUnderlying</a>.<span title="(p: Int =&gt; Boolean)scala.collection.Set[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;ControllerContext.liveBrokerIds.$anonfun.brokerId">brokerId</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.liveBrokerIds.$anonfun.brokerId" title="Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>

  def <a title="=&gt; scala.collection.Set[Int]" id="kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds">liveOrShuttingDownBrokerIds</a> = <a href="#kafka.controller;ControllerContext.liveBrokerIdsUnderlying_=" title="=&gt; scala.collection.Set[Int]">liveBrokerIdsUnderlying</a>
  def <a title="=&gt; scala.collection.Set[kafka.cluster.Broker]" id="kafka.controller;ControllerContext.liveOrShuttingDownBrokers">liveOrShuttingDownBrokers</a> = <a href="#kafka.controller;ControllerContext.liveBrokersUnderlying_=" title="=&gt; scala.collection.Set[kafka.cluster.Broker]">liveBrokersUnderlying</a>

  def <a title="(brokerId: Int)scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;ControllerContext.partitionsOnBroker">partitionsOnBroker</a><span class="delimiter">(</span><a title="Int" id="kafka.controller;ControllerContext.partitionsOnBroker.brokerId">brokerId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>
      .<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;ControllerContext.partitionsOnBroker.$anonfun.x0$1" title="Boolean" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span title="Seq[Int]">replicas</span>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.partitionsOnBroker.brokerId" title="Int">brokerId</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      .<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]],kafka.common.TopicAndPartition,scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]])scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]">map</span> <a href="#kafka.controller;ControllerContext.partitionsOnBroker.$anonfun.x0$2" title="kafka.common.TopicAndPartition" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span title="kafka.common.TopicAndPartition">topicAndPartition</span> <span class="delimiter">}</span>
      .<span title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">toSet</span>
  <span class="delimiter">}</span>

  def <a title="(brokerIds: scala.collection.Set[Int])scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ControllerContext.replicasOnBrokers">replicasOnBrokers</a><span class="delimiter">(</span><a title="scala.collection.Set[Int]" id="kafka.controller;ControllerContext.replicasOnBrokers.brokerIds">brokerIds</a>: <span title="scala.collection.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.replicasOnBrokers.brokerIds" title="scala.collection.Set[Int]">brokerIds</a>.<span title="(f: Int =&gt; scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[Int],scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica],scala.collection.Set[scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]]])scala.collection.Set[scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica],scala.collection.Set[scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]]]" class="delimiter">{</span> <a title="Int" id="kafka.controller;ControllerContext.replicasOnBrokers.$anonfun.brokerId">brokerId</a> =&gt;
      <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>
        .<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;ControllerContext.replicasOnBrokers.$anonfun.$anonfun.x0$3" title="Boolean" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span title="Seq[Int]">replicas</span>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.replicasOnBrokers.$anonfun.brokerId" title="Int">brokerId</a><span class="delimiter">)</span> <span class="delimiter">}</span>
        .<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; kafka.controller.PartitionAndReplica)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]],kafka.controller.PartitionAndReplica,scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]])scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]">map</span> <a href="#kafka.controller;ControllerContext.replicasOnBrokers.$anonfun.$anonfun.x0$4" title="kafka.controller.PartitionAndReplica" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt;
                 new <a href="#kafka.controller.PartitionAndReplica.readResolve" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;ControllerContext.replicasOnBrokers.$anonfun.brokerId" title="Int">brokerId</a><span class="delimiter">)</span> <span class="delimiter">}</span>
    <span class="delimiter">}</span>.<span title="(implicit asTraversable: scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica] =&gt; scala.collection.GenTraversableOnce[kafka.controller.PartitionAndReplica])scala.collection.Set[kafka.controller.PartitionAndReplica]">flatten</span>.<span title="scala.collection.immutable.Set[kafka.controller.PartitionAndReplica]">toSet</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ControllerContext.replicasForTopic">replicasForTopic</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ControllerContext.replicasForTopic.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>
      .<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;ControllerContext.replicasForTopic.$anonfun.x0$5" title="Boolean" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.replicasForTopic.topic" title="String">topic</a><span class="delimiter">)</span> <span class="delimiter">}</span>
      .<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Seq[kafka.controller.PartitionAndReplica])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]],Seq[kafka.controller.PartitionAndReplica],scala.collection.mutable.Iterable[Seq[kafka.controller.PartitionAndReplica]]])scala.collection.mutable.Iterable[Seq[kafka.controller.PartitionAndReplica]]">map</span> <a href="#kafka.controller;ControllerContext.replicasForTopic.$anonfun.x0$6" title="Seq[kafka.controller.PartitionAndReplica]" class="delimiter">{</a> case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt;
        <span title="Seq[Int]">replicas</span>.<span title="(f: Int =&gt; kafka.controller.PartitionAndReplica)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],kafka.controller.PartitionAndReplica,Seq[kafka.controller.PartitionAndReplica]])Seq[kafka.controller.PartitionAndReplica]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,kafka.controller.PartitionAndReplica,Seq[kafka.controller.PartitionAndReplica]]" class="delimiter">{</span> <a title="Int" id="kafka.controller;ControllerContext.replicasForTopic.$anonfun.$anonfun.r">r</a> =&gt;
          new <a href="#kafka.controller.PartitionAndReplica.readResolve" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;ControllerContext.replicasForTopic.$anonfun.$anonfun.r" title="Int">r</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>.<span title="(implicit asTraversable: Seq[kafka.controller.PartitionAndReplica] =&gt; scala.collection.GenTraversableOnce[kafka.controller.PartitionAndReplica])scala.collection.mutable.Iterable[kafka.controller.PartitionAndReplica]">flatten</span>.<span title="scala.collection.immutable.Set[kafka.controller.PartitionAndReplica]">toSet</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;ControllerContext.partitionsForTopic">partitionsForTopic</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ControllerContext.partitionsForTopic.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span>: collection.<span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>
      .<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;ControllerContext.partitionsForTopic.$anonfun.x0$7" title="Boolean" class="delimiter">{</a> case<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;ControllerContext.partitionsForTopic.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="Seq[Int]" id="kafka.controller;ControllerContext.partitionsForTopic.$anonfun.replicas">replicas</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;ControllerContext.partitionsForTopic.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.partitionsForTopic.topic" title="String">topic</a><span class="delimiter">)</span> <span class="delimiter">}</span>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>
  <span class="delimiter">}</span>

  def <a title="()scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ControllerContext.allLiveReplicas">allLiveReplicas</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.replicasOnBrokers" title="(brokerIds: scala.collection.Set[Int])scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasOnBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ControllerContext.replicasForPartition">replicasForPartition</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;ControllerContext.replicasForPartition.partitions">partitions</a>: collection.<span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span><span class="delimiter">)</span>: collection.<span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.replicasForPartition.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; Seq[kafka.controller.PartitionAndReplica])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],Seq[kafka.controller.PartitionAndReplica],scala.collection.Set[Seq[kafka.controller.PartitionAndReplica]]])scala.collection.Set[Seq[kafka.controller.PartitionAndReplica]]">map</span> <span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,Seq[kafka.controller.PartitionAndReplica],scala.collection.Set[Seq[kafka.controller.PartitionAndReplica]]]" class="delimiter">{</span> <a title="kafka.common.TopicAndPartition" id="kafka.controller;ControllerContext.replicasForPartition.$anonfun.p">p</a> =&gt;
      val <a title="Seq[Int]" id="kafka.controller;ControllerContext.replicasForPartition.$anonfun.replicas">replicas</a> = <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.replicasForPartition.$anonfun.p" title="kafka.common.TopicAndPartition">p</a><span class="delimiter">)</span>
      <a href="#kafka.controller;ControllerContext.replicasForPartition.$anonfun.replicas" title="Seq[Int]">replicas</a>.<span title="(f: Int =&gt; kafka.controller.PartitionAndReplica)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],kafka.controller.PartitionAndReplica,Seq[kafka.controller.PartitionAndReplica]])Seq[kafka.controller.PartitionAndReplica]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,kafka.controller.PartitionAndReplica,Seq[kafka.controller.PartitionAndReplica]]" class="delimiter">(</span><a title="Int" id="kafka.controller;ControllerContext.replicasForPartition.$anonfun.$anonfun.r">r</a> =&gt; new <a href="#kafka.controller.PartitionAndReplica.readResolve" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;ControllerContext.replicasForPartition.$anonfun.p" title="kafka.common.TopicAndPartition">p</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;ControllerContext.replicasForPartition.$anonfun.p" title="kafka.common.TopicAndPartition">p</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;ControllerContext.replicasForPartition.$anonfun.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>.<span title="(implicit asTraversable: Seq[kafka.controller.PartitionAndReplica] =&gt; scala.collection.GenTraversableOnce[kafka.controller.PartitionAndReplica])scala.collection.Set[kafka.controller.PartitionAndReplica]">flatten</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)Unit" id="kafka.controller;ControllerContext.removeTopic">removeTopic</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ControllerContext.removeTopic.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(x$1: scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch])Unit">partitionLeadershipInfo</a> = <a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">filter</span><a href="#kafka.controller;ControllerContext.removeTopic.$anonfun.x0$8" title="Boolean" class="delimiter">{</a> case <span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, _<span class="delimiter">)</span> =&gt; <span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#kafka.controller;ControllerContext.removeTopic.topic" title="String">topic</a> <span class="delimiter">}</span>
    <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(x$1: scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit">partitionReplicaAssignment</a> = <a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span><a href="#kafka.controller;ControllerContext.removeTopic.$anonfun.x0$9" title="Boolean" class="delimiter">{</a> case <span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicAndPartition</span>, _<span class="delimiter">)</span> =&gt; <span title="kafka.common.TopicAndPartition">topicAndPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#kafka.controller;ControllerContext.removeTopic.topic" title="String">topic</a> <span class="delimiter">}</span>
    <a href="#kafka.controller;ControllerContext.allTopics_=" title="(x$1: scala.collection.Set[String])Unit">allTopics</a> <span title="(elem: String)scala.collection.Set[String]">-=</span> <a href="#kafka.controller;ControllerContext.removeTopic.topic" title="String">topic</a>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


object <a title="kafka.controller.KafkaController.type" id="kafka.controller.KafkaController">KafkaController</a> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  val <a title="kafka.controller.KafkaController.StateChangeLogger" id="kafka.controller.KafkaController.stateChangeLogger">stateChangeLogger</a> = new <a href="#kafka.controller.KafkaController.StateChangeLogger.readResolve" title="kafka.controller.KafkaController.StateChangeLogger">StateChangeLogger</a><span class="delimiter">(</span><span title="String(&quot;state.change.logger&quot;)" class="string">&quot;state.change.logger&quot;</span><span class="delimiter">)</span>
  val <a title="Int" id="kafka.controller.KafkaController.InitialControllerEpoch">InitialControllerEpoch</a> = <span title="Int(1)" class="int">1</span>
  val <a title="Int" id="kafka.controller.KafkaController.InitialControllerEpochZkVersion">InitialControllerEpochZkVersion</a> = <span title="Int(1)" class="int">1</span>

  case class <a title="class StateChangeLogger extends AnyRef with kafka.utils.Logging with Product with Serializable" id="kafka.controller.KafkaController.StateChangeLogger.readResolve">StateChangeLogger</a><span title="Product" class="delimiter">(</span>override val <a title="String" id="kafka.controller.KafkaController;StateChangeLogger.loggerName">loggerName</a>: <span title="String">String</span><span class="delimiter">)</span> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a>

  def <a title="(controllerInfoString: String)Int" id="kafka.controller.KafkaController.parseControllerId">parseControllerId</a><span class="delimiter">(</span><a title="String" id="kafka.controller.KafkaController.parseControllerId.controllerInfoString">controllerInfoString</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      <a href="../utils/Json.scala.html#kafka.utils.Json" title="kafka.utils.Json.type">Json</a>.<a href="../utils/Json.scala.html#kafka.utils.Json.parseFull" title="(input: String)Option[Any]">parseFull</a><span class="delimiter">(</span><a href="#kafka.controller.KafkaController.parseControllerId.controllerInfoString" title="String">controllerInfoString</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="Any" id="kafka.controller.KafkaController.parseControllerId.m">m</a><span class="delimiter">)</span> =&gt;
          val <a title="scala.collection.Map[String,Any]" id="kafka.controller.KafkaController.parseControllerId.controllerInfo">controllerInfo</a> = <a href="#kafka.controller.KafkaController.parseControllerId.m" title="Any">m</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="scala.collection.Map[String,Any]" class="delimiter">[</span><span title="scala.collection.Map[String,Any]">Map</span><span class="delimiter">[</span>String, Any<span class="delimiter">]</span><span class="delimiter">]</span>
          return <a href="#kafka.controller.KafkaController.parseControllerId.controllerInfo" title="scala.collection.Map[String,Any]">controllerInfo</a>.<span title="(key: String)Option[Any]">get</span><span class="delimiter">(</span><span title="String(&quot;brokerid&quot;)" class="string">&quot;brokerid&quot;</span><span class="delimiter">)</span>.<span title="=&gt; Any">get</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Int" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
        case <span title="None.type">None</span> =&gt; throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Failed to parse the controller info json [%s].&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller.KafkaController.parseControllerId.controllerInfoString" title="String">controllerInfoString</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <span title="Throwable">t</span>: <span title="Throwable">Throwable</span> =&gt;
        <span class="comment">// It may be due to an incompatible controller register version</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="String(&quot;Failed to parse the controller info as json. &quot;)" class="string">&quot;Failed to parse the controller info as json. &quot;</span>
          <span title="(x$1: Any)String">+</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Probably this controller is still using the old format [%s] to store the broker id in zookeeper&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller.KafkaController.parseControllerId.controllerInfoString" title="String">controllerInfoString</a><span class="delimiter">)</span><span class="delimiter">)</span>
        try <span class="delimiter">{</span>
          return <a href="#kafka.controller.KafkaController.parseControllerId.controllerInfoString" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">controllerInfoString</a>.<span title="=&gt; Int">toInt</span>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <span title="Throwable">t</span>: <span title="Throwable">Throwable</span> =&gt; throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><span title="String(&quot;Failed to parse the controller info: &quot;)" class="string">&quot;Failed to parse the controller info: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller.KafkaController.parseControllerId.controllerInfoString" title="String">controllerInfoString</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;. This is neither the new or the old format.&quot;)" class="string">&quot;. This is neither the new or the old format.&quot;</span>, <span title="Throwable">t</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

class <a title="class KafkaController extends AnyRef with kafka.utils.Logging with kafka.metrics.KafkaMetricsGroup" id="kafka.controller;KafkaController">KafkaController</a><a href="#kafka.controller;KafkaController" title="kafka.controller.KafkaController" class="delimiter">(</a>val <a title="kafka.server.KafkaConfig" id="kafka.controller;KafkaController.config">config</a> : <a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig" title="kafka.server.KafkaConfig">KafkaConfig</a>, <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;KafkaController.zkClient">zkClient</a>: <span title="org.I0Itec.zkclient.ZkClient">ZkClient</span>, val <a title="kafka.server.BrokerState" id="kafka.controller;KafkaController.brokerState">brokerState</a>: <a href="../server/BrokerStates.scala.html#kafka.server;BrokerState" title="kafka.server.BrokerState">BrokerState</a><span class="delimiter">)</span> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> with <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup" title="kafka.metrics.KafkaMetricsGroup">KafkaMetricsGroup</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[Controller &quot;)" class="string">&quot;[Controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
  private var <a title="Boolean" id="kafka.controller;KafkaController.isRunning_=">isRunning</a> = true
  private val <a title="kafka.controller.KafkaController.StateChangeLogger" id="kafka.controller;KafkaController.stateChangeLogger">stateChangeLogger</a> = <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>
  val <a title="kafka.controller.ControllerContext" id="kafka.controller;KafkaController.controllerContext">controllerContext</a> = new <a href="#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils;ZKConfig.zkSessionTimeoutMs" title="=&gt; Int">zkSessionTimeoutMs</a><span class="delimiter">)</span>
  val <a title="kafka.controller.PartitionStateMachine" id="kafka.controller;KafkaController.partitionStateMachine">partitionStateMachine</a> = new <a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine" title="kafka.controller.PartitionStateMachine">PartitionStateMachine</a><span class="delimiter">(</span>this<span class="delimiter">)</span>
  val <a title="kafka.controller.ReplicaStateMachine" id="kafka.controller;KafkaController.replicaStateMachine">replicaStateMachine</a> = new <a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine" title="kafka.controller.ReplicaStateMachine">ReplicaStateMachine</a><span class="delimiter">(</span>this<span class="delimiter">)</span>
  private val <a title="kafka.server.ZookeeperLeaderElector" id="kafka.controller;KafkaController.controllerElector">controllerElector</a> = new <a href="../server/ZookeeperLeaderElector.scala.html#kafka.server;ZookeeperLeaderElector" title="kafka.server.ZookeeperLeaderElector">ZookeeperLeaderElector</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ControllerPath" title="=&gt; String">ControllerPath</a>, <a href="#kafka.controller;KafkaController.onControllerFailover" title="()Unit">onControllerFailover</a>,
    <a href="#kafka.controller;KafkaController.onControllerResignation" title="()Unit">onControllerResignation</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span>
  <span class="comment">// have a separate scheduler for the controller to be able to start and stop independently of the</span>
  <span class="comment">// kafka server</span>
  private val <a title="kafka.utils.KafkaScheduler" id="kafka.controller;KafkaController.autoRebalanceScheduler">autoRebalanceScheduler</a> = new <a href="../utils/KafkaScheduler.scala.html#kafka.utils;KafkaScheduler" title="kafka.utils.KafkaScheduler">KafkaScheduler</a><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
  var <a title="kafka.controller.TopicDeletionManager" id="kafka.controller;KafkaController.deleteTopicManager_=">deleteTopicManager</a>: <a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager" title="kafka.controller.TopicDeletionManager">TopicDeletionManager</a> = null
  val <a title="kafka.controller.OfflinePartitionLeaderSelector" id="kafka.controller;KafkaController.offlinePartitionSelector">offlinePartitionSelector</a> = new <a href="PartitionLeaderSelector.scala.html#kafka.controller;OfflinePartitionLeaderSelector" title="kafka.controller.OfflinePartitionLeaderSelector">OfflinePartitionLeaderSelector</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a><span class="delimiter">)</span>
  private val <a title="kafka.controller.ReassignedPartitionLeaderSelector" id="kafka.controller;KafkaController.reassignedPartitionLeaderSelector">reassignedPartitionLeaderSelector</a> = new <a href="PartitionLeaderSelector.scala.html#kafka.controller;ReassignedPartitionLeaderSelector" title="kafka.controller.ReassignedPartitionLeaderSelector">ReassignedPartitionLeaderSelector</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a><span class="delimiter">)</span>
  private val <a title="kafka.controller.PreferredReplicaPartitionLeaderSelector" id="kafka.controller;KafkaController.preferredReplicaPartitionLeaderSelector">preferredReplicaPartitionLeaderSelector</a> = new <a href="PartitionLeaderSelector.scala.html#kafka.controller;PreferredReplicaPartitionLeaderSelector" title="kafka.controller.PreferredReplicaPartitionLeaderSelector">PreferredReplicaPartitionLeaderSelector</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a><span class="delimiter">)</span>
  private val <a title="kafka.controller.ControlledShutdownLeaderSelector" id="kafka.controller;KafkaController.controlledShutdownPartitionLeaderSelector">controlledShutdownPartitionLeaderSelector</a> = new <a href="PartitionLeaderSelector.scala.html#kafka.controller;ControlledShutdownLeaderSelector" title="kafka.controller.ControlledShutdownLeaderSelector">ControlledShutdownLeaderSelector</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a><span class="delimiter">)</span>
  private val <a title="kafka.controller.ControllerBrokerRequestBatch" id="kafka.controller;KafkaController.brokerRequestBatch">brokerRequestBatch</a> = new <a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch" title="kafka.controller.ControllerBrokerRequestBatch">ControllerBrokerRequestBatch</a><span class="delimiter">(</span>this<span class="delimiter">)</span>

  private val <a title="kafka.controller.PartitionsReassignedListener" id="kafka.controller;KafkaController.partitionReassignedListener">partitionReassignedListener</a> = new <a href="#kafka.controller;PartitionsReassignedListener" title="kafka.controller.PartitionsReassignedListener">PartitionsReassignedListener</a><span class="delimiter">(</span>this<span class="delimiter">)</span>
  private val <a title="kafka.controller.PreferredReplicaElectionListener" id="kafka.controller;KafkaController.preferredReplicaElectionListener">preferredReplicaElectionListener</a> = new <a href="#kafka.controller;PreferredReplicaElectionListener" title="kafka.controller.PreferredReplicaElectionListener">PreferredReplicaElectionListener</a><span class="delimiter">(</span>this<span class="delimiter">)</span>

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;ActiveControllerCount&quot;)" class="string">&quot;ActiveControllerCount&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span><span class="delimiter">(</span><span class="delimiter">)</span> = if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.isActive" title="()Boolean">isActive</a><span class="delimiter">)</span> <span title="Int(1)" class="int">1</span> else <span title="Int(0)" class="int">0</span>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;OfflinePartitionsCount&quot;)" class="string">&quot;OfflinePartitionsCount&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
        <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Int)Int">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.isActive" title="()Boolean">isActive</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="Int(0)" class="int">0</span>
          else
            <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; Boolean)Int">count</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)" id="kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.p">p</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.p" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">p</a>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">_2</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;PreferredReplicaImbalanceCount&quot;)" class="string">&quot;PreferredReplicaImbalanceCount&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
        <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Int)Int">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.isActive" title="()Boolean">isActive</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span title="Int(0)" class="int">0</span>
          else
            <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)Int">count</span> <a href="#kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.x0$10" title="Boolean" class="delimiter">{</a>
              case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.topicPartition">topicPartition</a>, <a title="Seq[Int]" id="kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.replicas">replicas</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">!=</span> <a href="#kafka.controller;KafkaController.<local KafkaController>;$anon.value.$anonfun.replicas" title="Seq[Int]">replicas</a>.<span title="=&gt; Int">head</span>
            <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>

  def <a title="=&gt; Int" id="kafka.controller;KafkaController.epoch">epoch</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a>

  def <a title="=&gt; String" id="kafka.controller;KafkaController.clientId">clientId</a> = <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;id_%d-host_%s-port_%d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.hostName" title="=&gt; String">hostName</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.port" title="=&gt; Int">port</a><span class="delimiter">)</span>

  <span class="comment">/**
   * On clean shutdown, the controller first determines the partitions that the
   * shutting down broker leads, and moves leadership of those partitions to another broker
   * that is in that partition's ISR.
   *
   * @param id Id of the broker to shutdown.
   * @return The number of partitions that the broker still leads.
   */</span>
  def <a title="(id: Int)scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.shutdownBroker">shutdownBroker</a><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.shutdownBroker.id">id</a>: <span title="Int">Int</span><span class="delimiter">)</span> : <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span class="delimiter">{</span>

    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.isActive" title="()Boolean">isActive</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      throw new <a href="../common/ControllerMovedException.scala.html#kafka.common;ControllerMovedException" title="kafka.common.ControllerMovedException">ControllerMovedException</a><span class="delimiter">(</span><span title="String(&quot;Controller moved to another broker. Aborting controlled shutdown&quot;)" class="string">&quot;Controller moved to another broker. Aborting controlled shutdown&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.brokerShutdownLock" title="=&gt; Object">brokerShutdownLock</a> <span title="(x$1: scala.collection.immutable.Set[kafka.common.TopicAndPartition])scala.collection.immutable.Set[kafka.common.TopicAndPartition]">synchronized</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Shutting down broker &quot;)" class="string">&quot;Shutting down broker &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span>

      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
          throw new <a href="../common/BrokerNotAvailableException.scala.html#kafka.common;BrokerNotAvailableException" title="kafka.common.BrokerNotAvailableException">BrokerNotAvailableException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker id %d does not exist.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">add</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;All shutting down brokers: &quot;)" class="string">&quot;All shutting down brokers: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;Live brokers: &quot;)" class="string">&quot;Live brokers: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      val <a title="scala.collection.Set[(kafka.common.TopicAndPartition, Int)]" id="kafka.controller;KafkaController.shutdownBroker.allPartitionsAndReplicationFactorOnBroker">allPartitionsAndReplicationFactorOnBroker</a>: <span title="scala.collection.Set[(kafka.common.TopicAndPartition, Int)]">Set</span><span class="delimiter">[</span><span class="delimiter">(</span>TopicAndPartition, Int<span class="delimiter">)</span><span class="delimiter">]</span> =
        <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; scala.collection.Set[(kafka.common.TopicAndPartition, Int)])scala.collection.Set[(kafka.common.TopicAndPartition, Int)]">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsOnBroker" title="(brokerId: Int)scala.collection.Set[kafka.common.TopicAndPartition]">partitionsOnBroker</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span>
            .<span title="(f: kafka.common.TopicAndPartition =&gt; (kafka.common.TopicAndPartition, Int))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],(kafka.common.TopicAndPartition, Int),scala.collection.Set[(kafka.common.TopicAndPartition, Int)]])scala.collection.Set[(kafka.common.TopicAndPartition, Int)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,(kafka.common.TopicAndPartition, Int),scala.collection.Set[(kafka.common.TopicAndPartition, Int)]]" class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.shutdownBroker.allPartitionsAndReplicationFactorOnBroker.$anonfun.topicAndPartition">topicAndPartition</a> =&gt; <span title="(_1: kafka.common.TopicAndPartition, _2: Int)(kafka.common.TopicAndPartition, Int)" class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.allPartitionsAndReplicationFactorOnBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.allPartitionsAndReplicationFactorOnBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>

      <a href="#kafka.controller;KafkaController.shutdownBroker.allPartitionsAndReplicationFactorOnBroker" title="scala.collection.Set[(kafka.common.TopicAndPartition, Int)]">allPartitionsAndReplicationFactorOnBroker</a>.<span title="(f: ((kafka.common.TopicAndPartition, Int)) =&gt; Unit)Unit">foreach</span> <a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.x0$11" title="Unit" class="delimiter">{</a>
        case<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="Int" id="kafka.controller;KafkaController.shutdownBroker.$anonfun.replicationFactor">replicationFactor</a><span class="delimiter">)</span> =&gt;
          <span class="comment">// Move leadership serially to relinquish lock.</span>
          <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.LeaderIsrAndControllerEpoch]">get</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="(f: kafka.controller.LeaderIsrAndControllerEpoch =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.shutdownBroker.$anonfun.$anonfun.currLeaderIsrAndControllerEpoch">currLeaderIsrAndControllerEpoch</a> =&gt;
              if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.replicationFactor" title="Int">replicationFactor</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.$anonfun.currLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">currLeaderIsrAndControllerEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <span class="comment">// If the broker leads the topic partition, transition the leader and update isr. Updates zk and</span>
                  <span class="comment">// notifies all affected brokers</span>
                  <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.common.TopicAndPartition*)scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>, <a href="PartitionStateMachine.scala.html#kafka.controller.OnlinePartition" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>,
                    <a href="#kafka.controller;KafkaController.controlledShutdownPartitionLeaderSelector" title="=&gt; kafka.controller.ControlledShutdownLeaderSelector">controlledShutdownPartitionLeaderSelector</a><span class="delimiter">)</span>
                <span class="delimiter">}</span> else <span class="delimiter">{</span>
                  <span class="comment">// Stop the replica first. The state change below initiates ZK changes which should take some time</span>
                  <span class="comment">// before which the stop replica request should be completed (in most cases)</span>
                  <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
                  <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addStopReplicaRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, deletePartition: Boolean, callback: (kafka.api.RequestOrResponse, Int) =&gt; Unit)Unit">addStopReplicaRequestForBrokers</a><span class="delimiter">(</span><span title="(elems: Int*)Seq[Int]">Seq</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>,
                    <a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, deletePartition = false<span class="delimiter">)</span>
                  <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>

                  <span class="comment">// If the broker is a follower, updates the isr in ZK and notifies the current leader</span>
                  <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.controller.PartitionAndReplica*)scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">(</span><a href="#kafka.controller.PartitionAndReplica.readResolve" title="(topic: String, partition: Int, replica: Int)kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>,
                    <a href="#kafka.controller;KafkaController.shutdownBroker.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OfflineReplica" title="kafka.controller.OfflineReplica.type">OfflineReplica</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      def <a title="()scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads">replicatedPartitionsBrokerLeads</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; scala.collection.mutable.Iterable[kafka.common.TopicAndPartition])scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="String(&quot;All leaders = &quot;)" class="string">&quot;All leaders = &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">filter</span> <a href="#kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.x0$12" title="Boolean" class="delimiter">{</a>
          case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.leaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a><span class="delimiter">)</span> =&gt;
            <a href="#kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;KafkaController.shutdownBroker.id" title="Int">id</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(1)" class="int">1</span>
        <span class="delimiter">}</span>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch],kafka.common.TopicAndPartition,scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]])scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Iterable.Coll,kafka.common.TopicAndPartition,scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads.$anonfun.x$2" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">_</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.controller;KafkaController.shutdownBroker.replicatedPartitionsBrokerLeads" title="()scala.collection.mutable.Iterable[kafka.common.TopicAndPartition]">replicatedPartitionsBrokerLeads</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">toSet</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the zookeeper leader elector on electing the current broker as the new controller.
   * It does the following things on the become-controller state change -
   * 1. Register controller epoch changed listener
   * 2. Increments the controller epoch
   * 3. Initializes the controller's context object that holds cache objects for current topics, live brokers and
   *    leaders for all existing partitions.
   * 4. Starts the controller's channel manager
   * 5. Starts the replica state machine
   * 6. Starts the partition state machine
   * If it encounters any unexpected exception/error while becoming controller, it resigns as the current controller.
   * This ensures another controller election will be triggered and there will always be an actively serving controller
   */</span>
  def <a title="()Unit" id="kafka.controller;KafkaController.onControllerFailover">onControllerFailover</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.isRunning_=" title="=&gt; Boolean">isRunning</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d starting become controller state transition&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">//read controller epoch from zk</span>
      <a href="#kafka.controller;KafkaController.readControllerEpochFromZookeeper" title="()Unit">readControllerEpochFromZookeeper</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// increment the controller epoch</span>
      <a href="#kafka.controller;KafkaController.incrementControllerEpoch" title="(zkClient: org.I0Itec.zkclient.ZkClient)Unit">incrementControllerEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>
      <span class="comment">// before reading source of truth from zookeeper, register the listeners to get broker/topic callbacks</span>
      <a href="#kafka.controller;KafkaController.registerReassignedPartitionsListener" title="()Unit">registerReassignedPartitionsListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.registerPreferredReplicaElectionListener" title="()Unit">registerPreferredReplicaElectionListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.registerListeners" title="()Unit">registerListeners</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.registerListeners" title="()Unit">registerListeners</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.initializeControllerContext" title="()Unit">initializeControllerContext</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.startup" title="()Unit">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.startup" title="()Unit">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// register the partition change listeners for all existing topics on failover</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.allTopics_=" title="=&gt; scala.collection.Set[String]">allTopics</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.onControllerFailover.$anonfun.topic">topic</a> =&gt; <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.registerPartitionChangeListener" title="(topic: String)Unit">registerPartitionChangeListener</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onControllerFailover.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d is ready to serve as the new controller with epoch %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.brokerState" title="=&gt; kafka.server.BrokerState">brokerState</a>.<a href="../server/BrokerStates.scala.html#kafka.server;BrokerState.newState(ab9c491e36)" title="(newState: kafka.server.BrokerStates)Unit">newState</a><span class="delimiter">(</span><a href="../server/BrokerStates.scala.html#kafka.server.RunningAsController" title="kafka.server.RunningAsController.type">RunningAsController</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.maybeTriggerPartitionReassignment" title="()Unit">maybeTriggerPartitionReassignment</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.maybeTriggerPreferredReplicaElection" title="()Unit">maybeTriggerPreferredReplicaElection</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">/* send partition leadership info to all live brokers */</span>
      <a href="#kafka.controller;KafkaController.sendUpdateMetadataRequest" title="(brokers: Seq[Int], partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">sendUpdateMetadataRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>.<span title="=&gt; Seq[Int]">toSeq</span><span class="delimiter">)</span>
      if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.autoLeaderRebalanceEnable" title="=&gt; Boolean">autoLeaderRebalanceEnable</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;starting the partition rebalance scheduler&quot;)" class="string">&quot;starting the partition rebalance scheduler&quot;</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.autoRebalanceScheduler" title="=&gt; kafka.utils.KafkaScheduler">autoRebalanceScheduler</a>.<a href="../utils/KafkaScheduler.scala.html#kafka.utils;KafkaScheduler.startup" title="()Unit">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.autoRebalanceScheduler" title="=&gt; kafka.utils.KafkaScheduler">autoRebalanceScheduler</a>.<a href="../utils/KafkaScheduler.scala.html#kafka.utils;KafkaScheduler.schedule" title="(name: String, fun: () =&gt; Unit, delay: Long, period: Long, unit: java.util.concurrent.TimeUnit)Unit">schedule</a><span class="delimiter">(</span><span title="String(&quot;partition-rebalance-thread&quot;)" class="string">&quot;partition-rebalance-thread&quot;</span>, <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance" title="()Unit">checkAndTriggerPartitionRebalance</a>,
          <span title="Long(5L)" class="int">5</span>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.leaderImbalanceCheckIntervalSeconds" title="=&gt; Long">leaderImbalanceCheckIntervalSeconds</a>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.start" title="()Unit">start</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    else
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Controller has been shut down, aborting startup/failover&quot;)" class="string">&quot;Controller has been shut down, aborting startup/failover&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the zookeeper leader elector when the current broker resigns as the controller. This is
   * required to clean up internal controller data structures
   */</span>
  def <a title="()Unit" id="kafka.controller;KafkaController.onControllerResignation">onControllerResignation</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// de-register listeners</span>
    <a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsListener" title="()Unit">deregisterReassignedPartitionsListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.deregisterPreferredReplicaElectionListener" title="()Unit">deregisterPreferredReplicaElectionListener</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// shutdown delete topic manager</span>
    if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a> <span title="(x$1: Any)Boolean">!=</span> null<span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <span class="comment">// shutdown leader rebalance scheduler</span>
    if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.autoLeaderRebalanceEnable" title="=&gt; Boolean">autoLeaderRebalanceEnable</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.autoRebalanceScheduler" title="=&gt; kafka.utils.KafkaScheduler">autoRebalanceScheduler</a>.<a href="../utils/KafkaScheduler.scala.html#kafka.utils;KafkaScheduler.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// de-register partition ISR listener for on-going partition reassignment task</span>
      <a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners" title="()Unit">deregisterReassignedPartitionsIsrChangeListeners</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// shutdown partition state machine</span>
      <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// shutdown replica state machine</span>
      <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="comment">// shutdown controller channel manager</span>
      if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a> <span title="(x$1: Any)Boolean">!=</span> null<span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="(x$1: kafka.controller.ControllerChannelManager)Unit">controllerChannelManager</a> = null
      <span class="delimiter">}</span>
      <span class="comment">// reset controller context</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="(x$1: Int)Unit">epoch</a>=<span title="Int(0)" class="int">0</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="(x$1: Int)Unit">epochZkVersion</a>=<span title="Int(0)" class="int">0</span>
      <a href="#kafka.controller;KafkaController.brokerState" title="=&gt; kafka.server.BrokerState">brokerState</a>.<a href="../server/BrokerStates.scala.html#kafka.server;BrokerState.newState(ab9c491e36)" title="(newState: kafka.server.BrokerStates)Unit">newState</a><span class="delimiter">(</span><a href="../server/BrokerStates.scala.html#kafka.server.RunningAsBroker" title="kafka.server.RunningAsBroker.type">RunningAsBroker</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns true if this broker is the current controller.
   */</span>
  def <a title="()Boolean" id="kafka.controller;KafkaController.isActive">isActive</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Boolean)Boolean">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a> <span title="(x$1: Any)Boolean">!=</span> null
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the replica state machine's broker change listener, with the list of newly started
   * brokers as input. It does the following -
   * 1. Triggers the OnlinePartition state change for all new/offline partitions
   * 2. It checks whether there are reassigned replicas assigned to any newly started brokers.  If
   *    so, it performs the reassignment logic for each topic/partition.
   *
   * Note that we don't need to refresh the leader/isr cache for all topic/partitions at this point for two reasons:
   * 1. The partition state machine, when triggering online state change, will refresh leader and ISR for only those
   *    partitions currently new or offline (rather than every partition this controller is aware of)
   * 2. Even if we do refresh the cache, there is no guarantee that by the time the leader and ISR request reaches
   *    every broker that it is still valid.  Brokers check the leader epoch to determine validity of the request.
   */</span>
  def <a title="(newBrokers: Seq[Int])Unit" id="kafka.controller;KafkaController.onBrokerStartup">onBrokerStartup</a><span class="delimiter">(</span><a title="Seq[Int]" id="kafka.controller;KafkaController.onBrokerStartup.newBrokers">newBrokers</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New broker startup callback for %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokers" title="Seq[Int]">newBrokers</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;KafkaController.onBrokerStartup.newBrokersSet">newBrokersSet</a> = <a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokers" title="Seq[Int]">newBrokers</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
    <span class="comment">// send update metadata request for all partitions to the newly restarted brokers. In cases of controlled shutdown</span>
    <span class="comment">// leaders will not be elected when a new broker comes up. So at least in the common controlled shutdown case, the</span>
    <span class="comment">// metadata will reach the new brokers faster</span>
    <a href="#kafka.controller;KafkaController.sendUpdateMetadataRequest" title="(brokers: Seq[Int], partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">sendUpdateMetadataRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokers" title="Seq[Int]">newBrokers</a><span class="delimiter">)</span>
    <span class="comment">// the very first thing to do when a new broker comes up is send it the entire list of partitions that it is</span>
    <span class="comment">// supposed to host. Based on that the broker starts the high watermark threads for the input list of partitions</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.onBrokerStartup.allReplicasOnNewBrokers">allReplicasOnNewBrokers</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.replicasOnBrokers" title="(brokerIds: scala.collection.Set[Int])scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasOnBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokersSet" title="scala.collection.immutable.Set[Int]">newBrokersSet</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.allReplicasOnNewBrokers" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">allReplicasOnNewBrokers</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OnlineReplica" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
    <span class="comment">// when a new broker comes up, the controller needs to trigger leader election for all new and offline partitions</span>
    <span class="comment">// to see if these brokers can become leaders for some/all of those</span>
    <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange" title="()Unit">triggerOnlinePartitionStateChange</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// check if reassignment of some partitions need to be restarted</span>
    val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers">partitionsWithReplicasOnNewBrokers</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">filter</span> <a href="#kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers.$anonfun.x0$13" title="Boolean" class="delimiter">{</a>
      case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers.$anonfun.reassignmentContext">reassignmentContext</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers.$anonfun.reassignmentContext" title="kafka.controller.ReassignedPartitionsContext">reassignmentContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>.<span title="(p: Int =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokersSet" title="scala.collection.immutable.Set[Int]">newBrokersSet</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers.$anonfun.$anonfun.x$3" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;KafkaController.onBrokerStartup.partitionsWithReplicasOnNewBrokers" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsWithReplicasOnNewBrokers</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)" id="kafka.controller;KafkaController.onBrokerStartup.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.onPartitionReassignment" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">onPartitionReassignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.$anonfun.p" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">p</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>, <a href="#kafka.controller;KafkaController.onBrokerStartup.$anonfun.p" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">p</a>.<span title="=&gt; kafka.controller.ReassignedPartitionsContext">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// check if topic deletion needs to be resumed. If at least one replica that belongs to the topic being deleted exists</span>
    <span class="comment">// on the newly restarted brokers, there is a chance that topic deletion can resume</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted">replicasForTopicsToBeDeleted</a> = <a href="#kafka.controller;KafkaController.onBrokerStartup.allReplicasOnNewBrokers" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">allReplicasOnNewBrokers</a>.<span title="(p: kafka.controller.PartitionAndReplica =&gt; Boolean)scala.collection.Set[kafka.controller.PartitionAndReplica]">filter</span><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted.$anonfun.p" title="kafka.controller.PartitionAndReplica">p</a>.<a href="#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopicsToBeDeleted</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Some replicas %s for topics scheduled for deletion %s are on the newly restarted brokers %s. &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
        <span class="string">&quot;Signaling restart of topic deletion for these topics&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopicsToBeDeleted</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>,
        <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.topicsToBeDeleted" title="=&gt; scala.collection.mutable.Set[String]">topicsToBeDeleted</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.onBrokerStartup.newBrokers" title="Seq[Int]">newBrokers</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.resumeDeletionForTopics" title="(topics: scala.collection.Set[String])Unit">resumeDeletionForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.replicasForTopicsToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopicsToBeDeleted</a>.<span title="(f: kafka.controller.PartitionAndReplica =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.controller.PartitionAndReplica],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerStartup.$anonfun.x$4" title="kafka.controller.PartitionAndReplica">_</a>.<a href="#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the replica state machine's broker change listener with the list of failed brokers
   * as input. It does the following -
   * 1. Mark partitions with dead leaders as offline
   * 2. Triggers the OnlinePartition state change for all new/offline partitions
   * 3. Invokes the OfflineReplica state change on the input list of newly started brokers
   *
   * Note that we don't need to refresh the leader/isr cache for all topic/partitions at this point.  This is because
   * the partition state machine will refresh our cache for us when performing leader election for all new/offline
   * partitions coming online.
   */</span>
  def <a title="(deadBrokers: Seq[Int])Unit" id="kafka.controller;KafkaController.onBrokerFailure">onBrokerFailure</a><span class="delimiter">(</span><a title="Seq[Int]" id="kafka.controller;KafkaController.onBrokerFailure.deadBrokers">deadBrokers</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker failure callback for %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokers" title="Seq[Int]">deadBrokers</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.onBrokerFailure.deadBrokersThatWereShuttingDown">deadBrokersThatWereShuttingDown</a> =
      <a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokers" title="Seq[Int]">deadBrokers</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.onBrokerFailure.deadBrokersThatWereShuttingDown.$anonfun.id">id</a> =&gt; <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">remove</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokersThatWereShuttingDown.$anonfun.id" title="Int">id</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removed %s from list of shutting down brokers.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokersThatWereShuttingDown" title="Seq[Int]">deadBrokersThatWereShuttingDown</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;KafkaController.onBrokerFailure.deadBrokersSet">deadBrokersSet</a> = <a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokers" title="Seq[Int]">deadBrokers</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
    <span class="comment">// trigger OfflinePartition state for all partitions whose current leader is one amongst the dead brokers</span>
    val <a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.onBrokerFailure.partitionsWithoutLeader">partitionsWithoutLeader</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">filter</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)" id="kafka.controller;KafkaController.onBrokerFailure.partitionsWithoutLeader.$anonfun.partitionAndLeader">partitionAndLeader</a> =&gt;
      <a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokersSet" title="scala.collection.immutable.Set[Int]">deadBrokersSet</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.partitionsWithoutLeader.$anonfun.partitionAndLeader" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">partitionAndLeader</a>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">_2</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
        <span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.partitionsWithoutLeader.$anonfun.partitionAndLeader" title="(kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)">partitionAndLeader</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>
    <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.partitionsWithoutLeader" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsWithoutLeader</a>, <a href="PartitionStateMachine.scala.html#kafka.controller.OfflinePartition" title="kafka.controller.OfflinePartition.type">OfflinePartition</a><span class="delimiter">)</span>
    <span class="comment">// trigger OnlinePartition state changes for offline or new partitions</span>
    <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.triggerOnlinePartitionStateChange" title="()Unit">triggerOnlinePartitionStateChange</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// filter out the replicas that belong to topics that are being deleted</span>
    var <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.onBrokerFailure.allReplicasOnDeadBrokers">allReplicasOnDeadBrokers</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.replicasOnBrokers" title="(brokerIds: scala.collection.Set[Int])scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasOnBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.deadBrokersSet" title="scala.collection.immutable.Set[Int]">deadBrokersSet</a><span class="delimiter">)</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.onBrokerFailure.activeReplicasOnDeadBrokers">activeReplicasOnDeadBrokers</a> = <a href="#kafka.controller;KafkaController.onBrokerFailure.allReplicasOnDeadBrokers" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">allReplicasOnDeadBrokers</a>.<span title="(p: kafka.controller.PartitionAndReplica =&gt; Boolean)scala.collection.Set[kafka.controller.PartitionAndReplica]">filterNot</span><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;KafkaController.onBrokerFailure.activeReplicasOnDeadBrokers.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.activeReplicasOnDeadBrokers.$anonfun.p" title="kafka.controller.PartitionAndReplica">p</a>.<a href="#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// handle dead replicas</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.activeReplicasOnDeadBrokers" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">activeReplicasOnDeadBrokers</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OfflineReplica" title="kafka.controller.OfflineReplica.type">OfflineReplica</a><span class="delimiter">)</span>
    <span class="comment">// check if topic deletion state for the dead replicas needs to be updated</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.onBrokerFailure.replicasForTopicsToBeDeleted">replicasForTopicsToBeDeleted</a> = <a href="#kafka.controller;KafkaController.onBrokerFailure.allReplicasOnDeadBrokers" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">allReplicasOnDeadBrokers</a>.<span title="(p: kafka.controller.PartitionAndReplica =&gt; Boolean)scala.collection.Set[kafka.controller.PartitionAndReplica]">filter</span><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;KafkaController.onBrokerFailure.replicasForTopicsToBeDeleted.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.replicasForTopicsToBeDeleted.$anonfun.p" title="kafka.controller.PartitionAndReplica">p</a>.<a href="#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.replicasForTopicsToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopicsToBeDeleted</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// it is required to mark the respective replicas in TopicDeletionFailed state since the replica cannot be</span>
      <span class="comment">// deleted when the broker is down. This will prevent the replica from being in TopicDeletionStarted state indefinitely</span>
      <span class="comment">// since topic deletion cannot be retried until at least one replica is in TopicDeletionStarted state</span>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.failReplicaDeletion" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica])Unit">failReplicaDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onBrokerFailure.replicasForTopicsToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopicsToBeDeleted</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the partition state machine's topic change listener with the list of new topics
   * and partitions as input. It does the following -
   * 1. Registers partition change listener. This is not required until KAFKA-347
   * 2. Invokes the new partition callback
   * 3. Send metadata request with the new topic to all brokers so they allow requests for that topic to be served
   */</span>
  def <a title="(topics: scala.collection.Set[String], newPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit" id="kafka.controller;KafkaController.onNewTopicCreation">onNewTopicCreation</a><span class="delimiter">(</span><a title="scala.collection.Set[String]" id="kafka.controller;KafkaController.onNewTopicCreation.topics">topics</a>: <span title="scala.collection.Set[String]">Set</span><span class="delimiter">[</span>String<span class="delimiter">]</span>, <a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.onNewTopicCreation.newPartitions">newPartitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New topic creation callback for %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewTopicCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// subscribe to partition changes</span>
    <a href="#kafka.controller;KafkaController.onNewTopicCreation.topics" title="scala.collection.Set[String]">topics</a>.<span title="(f: String =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.onNewTopicCreation.$anonfun.topic">topic</a> =&gt; <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.registerPartitionChangeListener" title="(topic: String)Unit">registerPartitionChangeListener</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewTopicCreation.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.onNewPartitionCreation" title="(newPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">onNewPartitionCreation</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewTopicCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the topic change callback with the list of failed brokers as input.
   * It does the following -
   * 1. Move the newly created partitions to the NewPartition state
   * 2. Move the newly created partitions from NewPartition-&gt;OnlinePartition state
   */</span>
  def <a title="(newPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit" id="kafka.controller;KafkaController.onNewPartitionCreation">onNewPartitionCreation</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.onNewPartitionCreation.newPartitions">newPartitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New partition creation callback for %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewPartitionCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewPartitionCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a>, <a href="PartitionStateMachine.scala.html#kafka.controller.NewPartition" title="kafka.controller.NewPartition.type">NewPartition</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.replicasForPartition" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewPartitionCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a><span class="delimiter">)</span>, <a href="ReplicaStateMachine.scala.html#kafka.controller.NewReplica" title="kafka.controller.NewReplica.type">NewReplica</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewPartitionCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a>, <a href="PartitionStateMachine.scala.html#kafka.controller.OnlinePartition" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller;KafkaController.offlinePartitionSelector" title="=&gt; kafka.controller.OfflinePartitionLeaderSelector">offlinePartitionSelector</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.replicasForPartition" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onNewPartitionCreation.newPartitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">newPartitions</a><span class="delimiter">)</span>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OnlineReplica" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This callback is invoked by the reassigned partitions listener. When an admin command initiates a partition
   * reassignment, it creates the /admin/reassign_partitions path that triggers the zookeeper listener.
   * Reassigning replicas for a partition goes through a few steps listed in the code.
   * RAR = Reassigned replicas
   * OAR = Original list of replicas for partition
   * AR = current assigned replicas
   *
   * 1. Update AR in ZK with OAR + RAR.
   * 2. Send LeaderAndIsr request to every replica in OAR + RAR (with AR as OAR + RAR). We do this by forcing an update
   *    of the leader epoch in zookeeper.
   * 3. Start new replicas RAR - OAR by moving replicas in RAR - OAR to NewReplica state.
   * 4. Wait until all replicas in RAR are in sync with the leader.
   * 5  Move all replicas in RAR to OnlineReplica state.
   * 6. Set AR to RAR in memory.
   * 7. If the leader is not in RAR, elect a new leader from RAR. If new leader needs to be elected from RAR, a LeaderAndIsr
   *    will be sent. If not, then leader epoch will be incremented in zookeeper and a LeaderAndIsr request will be sent.
   *    In any case, the LeaderAndIsr request will have AR = RAR. This will prevent the leader from adding any replica in
   *    RAR - OAR back in the isr.
   * 8. Move all replicas in OAR - RAR to OfflineReplica state. As part of OfflineReplica state change, we shrink the
   *    isr to remove OAR - RAR in zookeeper and sent a LeaderAndIsr ONLY to the Leader to notify it of the shrunk isr.
   *    After that, we send a StopReplica (delete = false) to the replicas in OAR - RAR.
   * 9. Move all replicas in OAR - RAR to NonExistentReplica state. This will send a StopReplica (delete = false) to
   *    the replicas in OAR - RAR to physically delete the replicas on disk.
   * 10. Update AR in ZK with RAR.
   * 11. Update the /admin/reassign_partitions path in ZK to remove this partition.
   * 12. After electing leader, the replicas and isr information changes. So resend the update metadata request to every broker.
   *
   * For example, if OAR = {1, 2, 3} and RAR = {4,5,6}, the values in the assigned replica (AR) and leader/isr path in ZK
   * may go through the following transition.
   * AR                 leader/isr
   * {1,2,3}            1/{1,2,3}           (initial state)
   * {1,2,3,4,5,6}      1/{1,2,3}           (step 2)
   * {1,2,3,4,5,6}      1/{1,2,3,4,5,6}     (step 4)
   * {1,2,3,4,5,6}      4/{1,2,3,4,5,6}     (step 7)
   * {1,2,3,4,5,6}      4/{4,5,6}           (step 8)
   * {4,5,6}            4/{4,5,6}           (step 10)
   *
   * Note that we have to update AR in ZK with RAR last since it's the only place where we store OAR persistently.
   * This way, if the controller crashes before that step, we can still recover.
   */</span>
  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit" id="kafka.controller;KafkaController.onPartitionReassignment">onPartitionReassignment</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas">reassignedReplicas</a> = <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>
    <a href="#kafka.controller;KafkaController.areReplicasInIsr" title="(topic: String, partition: Int, replicas: Seq[Int])Boolean">areReplicasInIsr</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case false =&gt;
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New replicas %s for partition %s being &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
          <span title="String(&quot;reassigned not yet caught up with the leader&quot;)" class="string">&quot;reassigned not yet caught up with the leader&quot;</span><span class="delimiter">)</span>
        val newReplicasNotInOldReplicaList = <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span> <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;KafkaController.onPartitionReassignment.newReplicasNotInOldReplicaList">--</a> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
        val <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;KafkaController.onPartitionReassignment.newAndOldReplicas">newAndOldReplicas</a> = <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a> <span title="(that: scala.collection.GenTraversableOnce[Int])(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],Int,Seq[Int]])Seq[Int]">++</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
        <span class="comment">//1. Update AR in ZK with OAR + RAR.</span>
        <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202)" title="(topicAndPartition: kafka.common.TopicAndPartition, replicas: Seq[Int])Unit">updateAssignedReplicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.newAndOldReplicas" title="scala.collection.immutable.Set[Int]">newAndOldReplicas</a>.<span title="=&gt; Seq[Int]">toSeq</span><span class="delimiter">)</span>
        <span class="comment">//2. Send LeaderAndIsr request to every replica in OAR + RAR (with AR as OAR + RAR).</span>
        <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest" title="(topicAndPartition: kafka.common.TopicAndPartition, replicasToReceiveRequest: Seq[Int], newAssignedReplicas: Seq[Int])Unit">updateLeaderEpochAndSendRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>,
          <a href="#kafka.controller;KafkaController.onPartitionReassignment.newAndOldReplicas" title="scala.collection.immutable.Set[Int]">newAndOldReplicas</a>.<span title="=&gt; Seq[Int]">toSeq</span><span class="delimiter">)</span>
        <span class="comment">//3. replicas in RAR - OAR -&gt; NewReplica</span>
        <a href="#kafka.controller;KafkaController.startNewReplicasForReassignedPartition" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext, newReplicas: scala.collection.Set[Int])Unit">startNewReplicasForReassignedPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.newReplicasNotInOldReplicaList" title="scala.collection.immutable.Set[Int]">newReplicasNotInOldReplicaList</a><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Waiting for new replicas %s for partition %s being &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
          <span title="String(&quot;reassigned to catch up with the leader&quot;)" class="string">&quot;reassigned to catch up with the leader&quot;</span><span class="delimiter">)</span>
      case true =&gt;
        <span class="comment">//4. Wait until all replicas in RAR are in sync with the leader.</span>
        val oldReplicas = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[Int]">toSet</span> <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;KafkaController.onPartitionReassignment.oldReplicas">--</a> <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
        <span class="comment">//5. replicas in RAR -&gt; OnlineReplica</span>
        <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(f: Int =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="Int" id="kafka.controller;KafkaController.onPartitionReassignment.$anonfun.replica">replica</a> =&gt;
          <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.controller.PartitionAndReplica*)scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">(</span>new <a href="#kafka.controller.PartitionAndReplica.readResolve" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>,
            <a href="#kafka.controller;KafkaController.onPartitionReassignment.$anonfun.replica" title="Int">replica</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OnlineReplica" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="comment">//6. Set AR to RAR in memory.</span>
        <span class="comment">//7. Send LeaderAndIsr request with a potential new leader (if current leader not in RAR) and</span>
        <span class="comment">//   a new AR (using RAR) and same isr to every broker in RAR</span>
        <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">moveReassignedPartitionLeaderIfRequired</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a><span class="delimiter">)</span>
        <span class="comment">//8. replicas in OAR - RAR -&gt; Offline (force those replicas out of isr)</span>
        <span class="comment">//9. replicas in OAR - RAR -&gt; NonExistentReplica (force those replicas to be deleted)</span>
        <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext, oldReplicas: scala.collection.Set[Int])Unit">stopOldReplicasOfReassignedPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.oldReplicas" title="scala.collection.immutable.Set[Int]">oldReplicas</a><span class="delimiter">)</span>
        <span class="comment">//10. Update AR in ZK with RAR.</span>
        <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202)" title="(topicAndPartition: kafka.common.TopicAndPartition, replicas: Seq[Int])Unit">updateAssignedReplicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.onPartitionReassignment.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a><span class="delimiter">)</span>
        <span class="comment">//11. Update the /admin/reassign_partitions path in ZK to remove this partition.</span>
        <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">removePartitionFromReassignedPartitions</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removed partition %s from the list of reassigned partitions in zookeeper&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.ReassignedPartitionsContext]">remove</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
        <span class="comment">//12. After electing leader, the replicas and isr information changes, so resend the update metadata request to every broker</span>
        <a href="#kafka.controller;KafkaController.sendUpdateMetadataRequest" title="(brokers: Seq[Int], partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">sendUpdateMetadataRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>.<span title="=&gt; Seq[Int]">toSeq</span>, <span title="(elems: kafka.common.TopicAndPartition*)scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="comment">// signal delete topic thread if reassignment for some partitions belonging to topics being deleted just completed</span>
        <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.resumeDeletionForTopics" title="(topics: scala.collection.Set[String])Unit">resumeDeletionForTopics</a><span class="delimiter">(</span><span title="(elems: String*)scala.collection.Set[String]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPartitionReassignment.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(topic: String, partition: Int, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition">watchIsrChangesForReassignedPartition</a><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.topic">topic</a>: <span title="String">String</span>,
                                                    <a title="Int" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.partition">partition</a>: <span title="Int">Int</span>,
                                                    <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.reassignedReplicas">reassignedReplicas</a> = <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>
    val <a title="kafka.controller.ReassignedPartitionsIsrChangeListener" id="kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.isrChangeListener">isrChangeListener</a> = new <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener" title="kafka.controller.ReassignedPartitionsIsrChangeListener">ReassignedPartitionsIsrChangeListener</a><span class="delimiter">(</span>this, <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.partition" title="Int">partition</a>,
      <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$2" title="(x$1: kafka.controller.ReassignedPartitionsIsrChangeListener)Unit">isrChangeListener</a> = <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.isrChangeListener" title="kafka.controller.ReassignedPartitionsIsrChangeListener">isrChangeListener</a>
    <span class="comment">// register listener on the leader and isr path to wait until they catch up with the current leader</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">subscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPartitionLeaderAndIsrPath" title="(topic: String, partitionId: Int)String">getTopicPartitionLeaderAndIsrPath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.partition" title="Int">partition</a><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition.isrChangeListener" title="kafka.controller.ReassignedPartitionsIsrChangeListener">isrChangeListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition">initiateReassignReplicasForTopicPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                        <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas">newReplicas</a> = <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>
    val <a title="String" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topic">topic</a> = <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>
    val <a title="Int" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.partition">partition</a> = <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.aliveNewReplicas">aliveNewReplicas</a> = <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.aliveNewReplicas.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.aliveNewReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      val <a title="Option[Seq[Int]]" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.assignedReplicasOpt">assignedReplicasOpt</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition)Option[Seq[Int]]">get</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.assignedReplicasOpt" title="Option[Seq[Int]]">assignedReplicasOpt</a> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="Seq[Int]" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.assignedReplicas">assignedReplicas</a><span class="delimiter">)</span> =&gt;
          if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.assignedReplicas" title="Seq[Int]">assignedReplicas</a> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s to be reassigned is already assigned to replicas&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; %s. Ignoring request for partition reassignment&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span> else <span class="delimiter">{</span>
            if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.aliveNewReplicas" title="Seq[Int]">aliveNewReplicas</a> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Handling reassignment of partition %s to new replicas %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <span class="comment">// first register ISR change listener</span>
              <a href="#kafka.controller;KafkaController.watchIsrChangesForReassignedPartition" title="(topic: String, partition: Int, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">watchIsrChangesForReassignedPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.partition" title="Int">partition</a>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a><span class="delimiter">)</span>
              <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.ReassignedPartitionsContext)Option[kafka.controller.ReassignedPartitionsContext]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a><span class="delimiter">)</span>
              <span class="comment">// mark topic ineligible for deletion for the partitions being reassigned</span>
              <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.markTopicIneligibleForDeletion" title="(topics: scala.collection.Set[String])Unit">markTopicIneligibleForDeletion</a><span class="delimiter">(</span><span title="(elems: String*)scala.collection.Set[String]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topic" title="String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.controller;KafkaController.onPartitionReassignment" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">onPartitionReassignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a><span class="delimiter">)</span>
            <span class="delimiter">}</span> else <span class="delimiter">{</span>
              <span class="comment">// some replica in RAR is not alive. Fail partition reassignment</span>
              throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Only %s replicas out of the new set of replicas&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.aliveNewReplicas" title="Seq[Int]">aliveNewReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; %s for partition %s to be reassigned are alive. &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.newReplicas" title="Seq[Int]">newReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                <span title="String(&quot;Failing partition reassignment&quot;)" class="string">&quot;Failing partition reassignment&quot;</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        case <span title="None.type">None</span> =&gt; throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Attempt to reassign partition %s that doesn't exist&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error completing reassignment of partition %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.e" title="Throwable">e</a><span class="delimiter">)</span>
      <span class="comment">// remove the partition from the admin path to unblock the admin client</span>
      <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">removePartitionFromReassignedPartitions</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit" id="kafka.controller;KafkaController.onPreferredReplicaElection">onPreferredReplicaElection</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.onPreferredReplicaElection.partitions">partitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span>, <a title="Boolean" id="kafka.controller;KafkaController.onPreferredReplicaElection$default$2">isTriggeredByAutoRebalance</a>: <span title="Boolean">Boolean</span> = false<span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Starting preferred replica leader election for partitions %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a> <span title="(xs: scala.collection.TraversableOnce[kafka.common.TopicAndPartition])scala.collection.mutable.Set[kafka.common.TopicAndPartition]">++=</span> <a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.markTopicIneligibleForDeletion" title="(topics: scala.collection.Set[String])Unit">markTopicIneligibleForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.$anonfun.x$5" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>, <a href="PartitionStateMachine.scala.html#kafka.controller.OnlinePartition" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller;KafkaController.preferredReplicaPartitionLeaderSelector" title="=&gt; kafka.controller.PreferredReplicaPartitionLeaderSelector">preferredReplicaPartitionLeaderSelector</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;KafkaController.onPreferredReplicaElection.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error completing preferred replica leader election for partitions %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.onPreferredReplicaElection.e" title="Throwable">e</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> finally <span class="delimiter">{</span>
      <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection" title="(partitionsToBeRemoved: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit">removePartitionsFromPreferredReplicaElection</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>, <a href="#kafka.controller;KafkaController.onPreferredReplicaElection$default$2" title="Boolean">isTriggeredByAutoRebalance</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.resumeDeletionForTopics" title="(topics: scala.collection.Set[String])Unit">resumeDeletionForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.onPreferredReplicaElection.$anonfun.x$6" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked when the controller module of a Kafka server is started up. This does not assume that the current broker
   * is the controller. It merely registers the session expiration listener and starts the controller leader
   * elector
   */</span>
  def <a title="()Unit" id="kafka.controller;KafkaController.startup">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Controller starting up&quot;)" class="string">&quot;Controller starting up&quot;</span><span class="delimiter">)</span>;
      <a href="#kafka.controller;KafkaController.registerSessionExpirationListener" title="()Unit">registerSessionExpirationListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.isRunning_=" title="(x$1: Boolean)Unit">isRunning</a> = true
      <a href="#kafka.controller;KafkaController.controllerElector" title="=&gt; kafka.server.ZookeeperLeaderElector">controllerElector</a>.<a href="../server/ZookeeperLeaderElector.scala.html#kafka.server;ZookeeperLeaderElector.startup" title="=&gt; Unit">startup</a>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Controller startup complete&quot;)" class="string">&quot;Controller startup complete&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked when the controller module of a Kafka server is shutting down. If the broker was the current controller,
   * it shuts down the partition and replica state machines. If not, those are a no-op. In addition to that, it also
   * shuts down the controller channel manager, if one exists (i.e. if it was the current controller)
   */</span>
  def <a title="()Unit" id="kafka.controller;KafkaController.shutdown">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#kafka.controller;KafkaController.isRunning_=" title="(x$1: Boolean)Unit">isRunning</a> = false
    <span class="delimiter">}</span>
    <a href="#kafka.controller;KafkaController.onControllerResignation" title="()Unit">onControllerResignation</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(brokerId: Int, request: kafka.api.RequestOrResponse, callback: kafka.api.RequestOrResponse =&gt; Unit)Unit" id="kafka.controller;KafkaController.sendRequest">sendRequest</a><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.sendRequest.brokerId">brokerId</a> : <span title="Int">Int</span>, <a title="kafka.api.RequestOrResponse" id="kafka.controller;KafkaController.sendRequest.request">request</a> : <a href="../api/RequestOrResponse.scala.html#kafka.api;RequestOrResponse" title="kafka.api.RequestOrResponse">RequestOrResponse</a>, <a title="kafka.api.RequestOrResponse =&gt; Unit" id="kafka.controller;KafkaController.sendRequest$default$3">callback</a>: <span class="delimiter">(</span>RequestOrResponse<span class="delimiter">)</span> =&gt; Unit = null<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager.sendRequest" title="(brokerId: Int, request: kafka.api.RequestOrResponse, callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">sendRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.sendRequest.brokerId" title="Int">brokerId</a>, <a href="#kafka.controller;KafkaController.sendRequest.request" title="kafka.api.RequestOrResponse">request</a>, <a href="#kafka.controller;KafkaController.sendRequest$default$3" title="kafka.api.RequestOrResponse =&gt; Unit">callback</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(zkClient: org.I0Itec.zkclient.ZkClient)Unit" id="kafka.controller;KafkaController.incrementControllerEpoch">incrementControllerEpoch</a><span class="delimiter">(</span><a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;KafkaController.incrementControllerEpoch.zkClient">zkClient</a>: <span title="org.I0Itec.zkclient.ZkClient">ZkClient</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      var newControllerEpoch = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a> <a title="Int" id="kafka.controller;KafkaController.incrementControllerEpoch.newControllerEpoch">+</a> <span title="Int(1)" class="int">1</span>
      val <a href="#kafka.controller;KafkaController.incrementControllerEpoch.updateSucceeded" title="(Boolean, Int)" class="delimiter">(</a><a href="#kafka.controller;KafkaController.incrementControllerEpoch.x$7" title="Boolean" id="kafka.controller;KafkaController.incrementControllerEpoch.updateSucceeded">updateSucceeded</a>, <a href="#kafka.controller;KafkaController.incrementControllerEpoch.x$7" title="Int" id="kafka.controller;KafkaController.incrementControllerEpoch.newVersion">newVersion</a><span class="delimiter">)</span> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.conditionalUpdatePersistentPathIfExists" title="(client: org.I0Itec.zkclient.ZkClient, path: String, data: String, expectVersion: Int)(Boolean, Int)">conditionalUpdatePersistentPathIfExists</a><span title="(Boolean, Int) @unchecked" class="delimiter">(</span><a href="#kafka.controller;KafkaController.incrementControllerEpoch.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>,
        <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ControllerEpochPath" title="=&gt; String">ControllerEpochPath</a>, <a href="#kafka.controller;KafkaController.incrementControllerEpoch.newControllerEpoch" title="Int">newControllerEpoch</a>.<span title="()String">toString</span>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="=&gt; Int">epochZkVersion</a><span class="delimiter">)</span>
      if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.incrementControllerEpoch.updateSucceeded" title="Boolean">updateSucceeded</a><span class="delimiter">)</span>
        throw new <a href="../common/ControllerMovedException.scala.html#kafka.common;ControllerMovedException" title="kafka.common.ControllerMovedException">ControllerMovedException</a><span class="delimiter">(</span><span title="String(&quot;Controller moved to another broker. Aborting controller startup procedure&quot;)" class="string">&quot;Controller moved to another broker. Aborting controller startup procedure&quot;</span><span class="delimiter">)</span>
      else <span class="delimiter">{</span>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="(x$1: Int)Unit">epochZkVersion</a> = <a href="#kafka.controller;KafkaController.incrementControllerEpoch.newVersion" title="Int">newVersion</a>
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="(x$1: Int)Unit">epoch</a> = <a href="#kafka.controller;KafkaController.incrementControllerEpoch.newControllerEpoch" title="Int">newControllerEpoch</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="org.I0Itec.zkclient.exception.ZkNoNodeException" id="kafka.controller;KafkaController.incrementControllerEpoch.nne">nne</a>: <span title="org.I0Itec.zkclient.exception.ZkNoNodeException">ZkNoNodeException</span> =&gt;
        <span class="comment">// if path doesn't exist, this is the first controller whose epoch should be 1</span>
        <span class="comment">// the following call can still fail if another controller gets elected between checking if the path exists and</span>
        <span class="comment">// trying to create the controller epoch path</span>
        try <span class="delimiter">{</span>
          <a href="#kafka.controller;KafkaController.incrementControllerEpoch.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: Any)Unit">createPersistent</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ControllerEpochPath" title="=&gt; String">ControllerEpochPath</a>, <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.InitialControllerEpoch" title="=&gt; Int">InitialControllerEpoch</a>.<span title="()String">toString</span><span class="delimiter">)</span>
          <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="(x$1: Int)Unit">epoch</a> = <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.InitialControllerEpoch" title="=&gt; Int">InitialControllerEpoch</a>
          <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="(x$1: Int)Unit">epochZkVersion</a> = <a href="#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="#kafka.controller.KafkaController.InitialControllerEpochZkVersion" title="=&gt; Int">InitialControllerEpochZkVersion</a>
        <span class="delimiter">}</span> catch <span class="delimiter">{</span>
          case <a title="org.I0Itec.zkclient.exception.ZkNodeExistsException" id="kafka.controller;KafkaController.incrementControllerEpoch.e">e</a>: <span title="org.I0Itec.zkclient.exception.ZkNodeExistsException">ZkNodeExistsException</span> =&gt; throw new <a href="../common/ControllerMovedException.scala.html#kafka.common;ControllerMovedException" title="kafka.common.ControllerMovedException">ControllerMovedException</a><span class="delimiter">(</span><span class="string">&quot;Controller moved to another broker. &quot;</span> <span title="String(&quot;Controller moved to another broker. Aborting controller startup procedure&quot;)">+</span>
            <span class="string">&quot;Aborting controller startup procedure&quot;</span><span class="delimiter">)</span>
          case <span title="Throwable">oe</span>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while incrementing controller epoch&quot;)" class="string">&quot;Error while incrementing controller epoch&quot;</span>, <span title="Throwable">oe</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      case <span title="Throwable">oe</span>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while incrementing controller epoch&quot;)" class="string">&quot;Error while incrementing controller epoch&quot;</span>, <span title="Throwable">oe</span><span class="delimiter">)</span>

    <span class="delimiter">}</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d incremented epoch to %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.registerSessionExpirationListener">registerSessionExpirationListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: org.I0Itec.zkclient.IZkStateListener)Unit">subscribeStateChanges</span><span class="delimiter">(</span>new <a href="#kafka.controller;KafkaController;SessionExpirationListener" title="KafkaController.this.SessionExpirationListener">SessionExpirationListener</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.initializeControllerContext">initializeControllerContext</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// update controller cache with delete topic information</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokers_=" title="(brokers: scala.collection.Set[kafka.cluster.Broker])Unit">liveBrokers</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getAllBrokersInCluster" title="(zkClient: org.I0Itec.zkclient.ZkClient)Seq[kafka.cluster.Broker]">getAllBrokersInCluster</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[kafka.cluster.Broker]">toSet</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.allTopics_=" title="(x$1: scala.collection.Set[String])Unit">allTopics</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getAllTopics" title="(zkClient: org.I0Itec.zkclient.ZkClient)Seq[String]">getAllTopics</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(x$1: scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit">partitionReplicaAssignment</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getReplicaAssignmentForTopics" title="(zkClient: org.I0Itec.zkclient.ZkClient, topics: Seq[String])scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">getReplicaAssignmentForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.allTopics_=" title="=&gt; scala.collection.Set[String]">allTopics</a>.<span title="=&gt; Seq[String]">toSeq</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(x$1: scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch])Unit">partitionLeadershipInfo</a> = new mutable.<span title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">HashMap</span><span class="delimiter">[</span>TopicAndPartition, LeaderIsrAndControllerEpoch<span class="delimiter">]</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="(x$1: scala.collection.mutable.Set[Int])Unit">shuttingDownBrokerIds</a> = mutable.<span title="scala.collection.mutable.Set.type">Set</span>.<span title="[A]=&gt; scala.collection.mutable.Set[A]">empty</span><span title="scala.collection.mutable.Set[Int]" class="delimiter">[</span><span title="Int">Int</span><span class="delimiter">]</span>
    <span class="comment">// update the leader and isr cache for all existing partitions from Zookeeper</span>
    <a href="#kafka.controller;KafkaController.updateLeaderAndIsrCache" title="()Unit">updateLeaderAndIsrCache</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// start the channel manager</span>
    <a href="#kafka.controller;KafkaController.startChannelManager" title="()Unit">startChannelManager</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection" title="()Unit">initializePreferredReplicaElection</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.initializePartitionReassignment" title="()Unit">initializePartitionReassignment</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.initializeTopicDeletion" title="()Unit">initializeTopicDeletion</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Currently active brokers in the cluster: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Currently shutting brokers in the cluster: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.shuttingDownBrokerIds_=" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Current list of topics in the cluster: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.allTopics_=" title="=&gt; scala.collection.Set[String]">allTopics</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.initializePreferredReplicaElection">initializePreferredReplicaElection</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// initialize preferred replica election state</span>
    val <a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsUndergoingPreferredReplicaElection">partitionsUndergoingPreferredReplicaElection</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getPartitionsUndergoingPreferredReplicaElection" title="(zkClient: org.I0Itec.zkclient.ZkClient)scala.collection.Set[kafka.common.TopicAndPartition]">getPartitionsUndergoingPreferredReplicaElection</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>
    <span class="comment">// check if they are already completed or topic was deleted</span>
    val <a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection">partitionsThatCompletedPreferredReplicaElection</a> = <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsUndergoingPreferredReplicaElection" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(p: kafka.common.TopicAndPartition =&gt; Boolean)scala.collection.Set[kafka.common.TopicAndPartition]">filter</span> <span class="delimiter">{</span> <a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.partition">partition</a> =&gt;
      val <a title="Option[Seq[Int]]" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.replicasOpt">replicasOpt</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition)Option[Seq[Int]]">get</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a><span class="delimiter">)</span>
      val <a title="Boolean" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.topicDeleted">topicDeleted</a> = <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.replicasOpt" title="Option[Seq[Int]]">replicasOpt</a>.<span title="=&gt; Boolean">isEmpty</span>
      val <a title="Boolean" id="kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.successful">successful</a> =
        if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.topicDeleted" title="Boolean">topicDeleted</a><span class="delimiter">)</span> <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.replicasOpt" title="Option[Seq[Int]]">replicasOpt</a>.<span title="=&gt; Seq[Int]">get</span>.<span title="=&gt; Int">head</span> else false
      <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.successful" title="Boolean">successful</a> <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection.$anonfun.topicDeleted" title="Boolean">topicDeleted</a>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a> <span title="(xs: scala.collection.TraversableOnce[kafka.common.TopicAndPartition])scala.collection.mutable.Set[kafka.common.TopicAndPartition]">++=</span> <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsUndergoingPreferredReplicaElection" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a> <span title="(xs: scala.collection.TraversableOnce[kafka.common.TopicAndPartition])scala.collection.mutable.Set[kafka.common.TopicAndPartition]">--=</span> <a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsThatCompletedPreferredReplicaElection</a>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partitions undergoing preferred replica election: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsUndergoingPreferredReplicaElection" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partitions that completed preferred replica election: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePreferredReplicaElection.partitionsThatCompletedPreferredReplicaElection" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsThatCompletedPreferredReplicaElection</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Resuming preferred replica election for partitions: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.initializePartitionReassignment">initializePartitionReassignment</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// read the partitions being reassigned from zookeeper path /admin/reassign_partitions</span>
    val <a title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;KafkaController.initializePartitionReassignment.partitionsBeingReassigned">partitionsBeingReassigned</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getPartitionsBeingReassigned" title="(zkClient: org.I0Itec.zkclient.ZkClient)scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">getPartitionsBeingReassigned</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>
    <span class="comment">// check if they are already completed or topic was deleted</span>
    val <a title="Iterable[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions">reassignedPartitions</a> = <a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsBeingReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(p: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; Boolean)scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">filter</span> <span class="delimiter">{</span> <a title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)" id="kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.partition">partition</a> =&gt;
      val <a title="Option[Seq[Int]]" id="kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.replicasOpt">replicasOpt</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition)Option[Seq[Int]]">get</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.partition" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">partition</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span>
      val <a title="Boolean" id="kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.topicDeleted">topicDeleted</a> = <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.replicasOpt" title="Option[Seq[Int]]">replicasOpt</a>.<span title="=&gt; Boolean">isEmpty</span>
      val <a title="Boolean" id="kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.successful">successful</a> = if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.topicDeleted" title="Boolean">topicDeleted</a><span class="delimiter">)</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.replicasOpt" title="Option[Seq[Int]]">replicasOpt</a>.<span title="=&gt; Seq[Int]">get</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.partition" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">partition</a>.<span title="=&gt; kafka.controller.ReassignedPartitionsContext">_2</span>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a> else false
      <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.topicDeleted" title="Boolean">topicDeleted</a> <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.successful" title="Boolean">successful</a>
    <span class="delimiter">}</span>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext],kafka.common.TopicAndPartition,Iterable[kafka.common.TopicAndPartition]])Iterable[kafka.common.TopicAndPartition]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,kafka.common.TopicAndPartition,Iterable[kafka.common.TopicAndPartition]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions.$anonfun.x$8" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">_</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions" title="Iterable[kafka.common.TopicAndPartition]">reassignedPartitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.initializePartitionReassignment.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">removePartitionFromReassignedPartitions</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.$anonfun.p" title="kafka.common.TopicAndPartition">p</a><span class="delimiter">)</span><span class="delimiter">)</span>
    var <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;KafkaController.initializePartitionReassignment.partitionsToReassign">partitionsToReassign</a>: mutable.<span title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">Map</span><span class="delimiter">[</span>TopicAndPartition, ReassignedPartitionsContext<span class="delimiter">]</span> = new mutable.<span title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">HashMap</span>
    <a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsToReassign" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsToReassign</a> <span title="(xs: scala.collection.TraversableOnce[(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)])scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">++=</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsBeingReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>
    <a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsToReassign" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsToReassign</a> <span title="(xs: scala.collection.TraversableOnce[kafka.common.TopicAndPartition])scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">--=</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions" title="Iterable[kafka.common.TopicAndPartition]">reassignedPartitions</a>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a> <span title="(xs: scala.collection.TraversableOnce[(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)])scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">++=</span> <a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsToReassign" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsToReassign</a>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partitions being reassigned: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsBeingReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partitions already reassigned: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.reassignedPartitions" title="Iterable[kafka.common.TopicAndPartition]">reassignedPartitions</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Resuming reassignment of partitions: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializePartitionReassignment.partitionsToReassign" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsToReassign</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.initializeTopicDeletion">initializeTopicDeletion</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="scala.collection.immutable.Set[String]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsQueuedForDeletion">topicsQueuedForDeletion</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getChildrenParentMayNotExist" title="(client: org.I0Itec.zkclient.ZkClient, path: String)Seq[String]">getChildrenParentMayNotExist</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.DeleteTopicsPath" title="=&gt; String">DeleteTopicsPath</a><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[String]">toSet</span>
    val <a title="scala.collection.Set[String]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers">topicsWithReplicasOnDeadBrokers</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.x0$14" title="Boolean" class="delimiter">{</a> case<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.partition">partition</a>, <a title="Seq[Int]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.replicas">replicas</a><span class="delimiter">)</span> =&gt;
      <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.replicas" title="Seq[Int]">replicas</a>.<span title="(p: Int =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.$anonfun.r">r</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">}</span>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers.$anonfun.x$9" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>
    val <a title="scala.collection.mutable.Set[String]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPartitionReassignmentIsInProgress">topicsForWhichPartitionReassignmentIsInProgress</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Set[kafka.common.TopicAndPartition],String,scala.collection.mutable.Set[String]])scala.collection.mutable.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Set.Coll,String,scala.collection.mutable.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPartitionReassignmentIsInProgress.$anonfun.x$10" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>
    val <a title="scala.collection.Set[String]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPreferredReplicaElectionIsInProgress">topicsForWhichPreferredReplicaElectionIsInProgress</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="(f: kafka.common.TopicAndPartition =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],String,scala.collection.Set[String]])scala.collection.Set[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,String,scala.collection.Set[String]]" class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPreferredReplicaElectionIsInProgress.$anonfun.x$11" title="kafka.common.TopicAndPartition">_</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>
    val topicsIneligibleForDeletion = <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsWithReplicasOnDeadBrokers" title="scala.collection.Set[String]">topicsWithReplicasOnDeadBrokers</a> <span title="(that: scala.collection.GenSet[String])scala.collection.Set[String]">|</span> <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPartitionReassignmentIsInProgress" title="scala.collection.mutable.Set[String]">topicsForWhichPartitionReassignmentIsInProgress</a> <a title="scala.collection.Set[String]" id="kafka.controller;KafkaController.initializeTopicDeletion.topicsIneligibleForDeletion">|</a>
                                  <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsForWhichPreferredReplicaElectionIsInProgress" title="scala.collection.Set[String]">topicsForWhichPreferredReplicaElectionIsInProgress</a>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;List of topics to be deleted: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsQueuedForDeletion" title="scala.collection.immutable.Set[String]">topicsQueuedForDeletion</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;List of topics ineligible for deletion: %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsIneligibleForDeletion" title="scala.collection.Set[String]">topicsIneligibleForDeletion</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// initialize the topic deletion manager</span>
    <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="(x$1: kafka.controller.TopicDeletionManager)Unit">deleteTopicManager</a> = new <a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager" title="kafka.controller.TopicDeletionManager">TopicDeletionManager</a><span class="delimiter">(</span>this, <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsQueuedForDeletion" title="scala.collection.immutable.Set[String]">topicsQueuedForDeletion</a>, <a href="#kafka.controller;KafkaController.initializeTopicDeletion.topicsIneligibleForDeletion" title="scala.collection.Set[String]">topicsIneligibleForDeletion</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.maybeTriggerPartitionReassignment">maybeTriggerPartitionReassignment</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)" id="kafka.controller;KafkaController.maybeTriggerPartitionReassignment.$anonfun.topicPartitionToReassign">topicPartitionToReassign</a> =&gt;
      <a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">initiateReassignReplicasForTopicPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.maybeTriggerPartitionReassignment.$anonfun.topicPartitionToReassign" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">topicPartitionToReassign</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>, <a href="#kafka.controller;KafkaController.maybeTriggerPartitionReassignment.$anonfun.topicPartitionToReassign" title="(kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)">topicPartitionToReassign</a>.<span title="=&gt; kafka.controller.ReassignedPartitionsContext">_2</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.maybeTriggerPreferredReplicaElection">maybeTriggerPreferredReplicaElection</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.onPreferredReplicaElection" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit">onPreferredReplicaElection</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">toSet</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.startChannelManager">startChannelManager</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="(x$1: kafka.controller.ControllerChannelManager)Unit">controllerChannelManager</a> = new <a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager" title="kafka.controller.ControllerChannelManager">ControllerChannelManager</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>, <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerChannelManager_=" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager.startup" title="()Unit">startup</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.updateLeaderAndIsrCache">updateLeaderAndIsrCache</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.updateLeaderAndIsrCache.leaderAndIsrInfo">leaderAndIsrInfo</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getPartitionLeaderAndIsrForTopics" title="(zkClient: org.I0Itec.zkclient.ZkClient, topicAndPartitions: scala.collection.Set[kafka.common.TopicAndPartition])scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">getPartitionLeaderAndIsrForTopics</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span><span class="delimiter">)</span>
    for<span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.updateLeaderAndIsrCache.$anonfun.topicPartition">topicPartition</a>, <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.updateLeaderAndIsrCache.$anonfun.leaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a><span class="delimiter">)</span> &lt;- <a href="#kafka.controller;KafkaController.updateLeaderAndIsrCache.leaderAndIsrInfo" title="(f: ((kafka.common.TopicAndPartition, kafka.controller.LeaderIsrAndControllerEpoch)) =&gt; Option[kafka.controller.LeaderIsrAndControllerEpoch])Unit">leaderAndIsrInfo</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.LeaderIsrAndControllerEpoch)Option[kafka.controller.LeaderIsrAndControllerEpoch]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderAndIsrCache.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>, <a href="#kafka.controller;KafkaController.updateLeaderAndIsrCache.$anonfun.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="(topic: String, partition: Int, replicas: Seq[Int])Boolean" id="kafka.controller;KafkaController.areReplicasInIsr">areReplicasInIsr</a><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.areReplicasInIsr.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;KafkaController.areReplicasInIsr.partition">partition</a>: <span title="Int">Int</span>, <a title="Seq[Int]" id="kafka.controller;KafkaController.areReplicasInIsr.replicas">replicas</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getLeaderAndIsrForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.api.LeaderAndIsr]">getLeaderAndIsrForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.areReplicasInIsr.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.areReplicasInIsr.partition" title="Int">partition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.api.LeaderAndIsr" id="kafka.controller;KafkaController.areReplicasInIsr.leaderAndIsr">leaderAndIsr</a><span class="delimiter">)</span> =&gt;
        val <a title="Seq[Int]" id="kafka.controller;KafkaController.areReplicasInIsr.replicasNotInIsr">replicasNotInIsr</a> = <a href="#kafka.controller;KafkaController.areReplicasInIsr.replicas" title="Seq[Int]">replicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filterNot</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.areReplicasInIsr.replicasNotInIsr.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;KafkaController.areReplicasInIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.areReplicasInIsr.replicasNotInIsr.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.areReplicasInIsr.replicasNotInIsr" title="Seq[Int]">replicasNotInIsr</a>.<span title="=&gt; Boolean">isEmpty</span>
      case <span title="None.type">None</span> =&gt; false
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired">moveReassignedPartitionLeaderIfRequired</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                                      <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas">reassignedReplicas</a> = <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>
    val <a title="Int" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader">currentLeader</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
    <span class="comment">// change the assigned replica list to just the reassigned replicas in the cache so it gets sent out on the LeaderAndIsr</span>
    <span class="comment">// request to the current or new leader. This will prevent it from adding the old replicas to the ISR</span>
    val <a title="Seq[Int]" id="kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.oldAndNewReplicas">oldAndNewReplicas</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition, value: Seq[Int])Option[Seq[Int]]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a><span class="delimiter">)</span>
    if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader" title="Int">currentLeader</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Leader %s for partition %s being reassigned, &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader" title="Int">currentLeader</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
        <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;is not in the new list of replicas %s. Re-electing leader&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="comment">// move the leader to one of the alive and caught up new replicas</span>
      <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.common.TopicAndPartition*)scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>, <a href="PartitionStateMachine.scala.html#kafka.controller.OnlinePartition" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller;KafkaController.reassignedPartitionLeaderSelector" title="=&gt; kafka.controller.ReassignedPartitionLeaderSelector">reassignedPartitionLeaderSelector</a><span class="delimiter">)</span>
    <span class="delimiter">}</span> else <span class="delimiter">{</span>
      <span class="comment">// check if the leader is alive or not</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader" title="Int">currentLeader</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
        case true =&gt;
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Leader %s for partition %s being reassigned, &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader" title="Int">currentLeader</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
            <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;is already in the new list of replicas %s and is alive&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">// shrink replication factor and update the leader epoch in zookeeper to use on the next LeaderAndIsrRequest</span>
          <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest" title="(topicAndPartition: kafka.common.TopicAndPartition, replicasToReceiveRequest: Seq[Int], newAssignedReplicas: Seq[Int])Unit">updateLeaderEpochAndSendRequest</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.oldAndNewReplicas" title="Seq[Int]">oldAndNewReplicas</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a><span class="delimiter">)</span>
        case false =&gt;
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Leader %s for partition %s being reassigned, &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.currentLeader" title="Int">currentLeader</a>, <a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
            <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;is already in the new list of replicas %s but is dead&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.reassignedReplicas" title="Seq[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;KafkaController.partitionStateMachine" title="=&gt; kafka.controller.PartitionStateMachine">partitionStateMachine</a>.<a href="PartitionStateMachine.scala.html#kafka.controller;PartitionStateMachine.handleStateChanges" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], targetState: kafka.controller.PartitionState, leaderSelector: kafka.controller.PartitionLeaderSelector, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.common.TopicAndPartition*)scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.moveReassignedPartitionLeaderIfRequired.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>, <a href="PartitionStateMachine.scala.html#kafka.controller.OnlinePartition" title="kafka.controller.OnlinePartition.type">OnlinePartition</a>, <a href="#kafka.controller;KafkaController.reassignedPartitionLeaderSelector" title="=&gt; kafka.controller.ReassignedPartitionLeaderSelector">reassignedPartitionLeaderSelector</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext, oldReplicas: scala.collection.Set[Int])Unit" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition">stopOldReplicasOfReassignedPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                                   <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a>,
                                                   <a title="scala.collection.Set[Int]" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.oldReplicas">oldReplicas</a>: <span title="scala.collection.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="String" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.topic">topic</a> = <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>
    val <a title="Int" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.partition">partition</a> = <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>
    <span class="comment">// first move the replica to offline state (the controller removes it from the ISR)</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted">replicasToBeDeleted</a> = <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.oldReplicas" title="scala.collection.Set[Int]">oldReplicas</a>.<span title="(f: Int =&gt; kafka.controller.PartitionAndReplica)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[Int],kafka.controller.PartitionAndReplica,scala.collection.Set[kafka.controller.PartitionAndReplica]])scala.collection.Set[kafka.controller.PartitionAndReplica]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,kafka.controller.PartitionAndReplica,scala.collection.Set[kafka.controller.PartitionAndReplica]]" class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted.$anonfun.r">r</a> =&gt; <a href="#kafka.controller.PartitionAndReplica.readResolve" title="(topic: String, partition: Int, replica: Int)kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.partition" title="Int">partition</a>, <a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasToBeDeleted</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.OfflineReplica" title="kafka.controller.OfflineReplica.type">OfflineReplica</a><span class="delimiter">)</span>
    <span class="comment">// send stop replica command to the old replicas</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasToBeDeleted</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.ReplicaDeletionStarted" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a><span class="delimiter">)</span>
    <span class="comment">// TODO: Eventually partition reassignment could use a callback that does retries if deletion failed</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasToBeDeleted</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.ReplicaDeletionSuccessful" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.stopOldReplicasOfReassignedPartition.replicasToBeDeleted" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasToBeDeleted</a>, <a href="ReplicaStateMachine.scala.html#kafka.controller.NonExistentReplica" title="kafka.controller.NonExistentReplica.type">NonExistentReplica</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, replicas: Seq[Int])Unit" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202)">updateAssignedReplicasForPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                                 <a title="Seq[Int]" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).replicas">replicas</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).partitionsAndReplicasForThisTopic">partitionsAndReplicasForThisTopic</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).partitionsAndReplicasForThisTopic.$anonfun.x$13" title="(kafka.common.TopicAndPartition, Seq[Int])">_</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).partitionsAndReplicasForThisTopic" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsAndReplicasForThisTopic</a>.<span title="(key: kafka.common.TopicAndPartition, value: Seq[Int])Option[Seq[Int]]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).replicas" title="Seq[Int]">replicas</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20)" title="(topicAndPartition: kafka.common.TopicAndPartition, newReplicaAssignmentForTopic: scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit">updateAssignedReplicasForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).partitionsAndReplicasForThisTopic" title="scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsAndReplicasForThisTopic</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Updated assigned replicas for partition %s being reassigned to %s &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).replicas" title="Seq[Int]">replicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// update the assigned replica list after a successful zookeeper write</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition, value: Seq[Int])Option[Seq[Int]]">put</span><span title="Unit" class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(ae1c005202).replicas" title="Seq[Int]">replicas</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext, newReplicas: scala.collection.Set[Int])Unit" id="kafka.controller;KafkaController.startNewReplicasForReassignedPartition">startNewReplicasForReassignedPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.startNewReplicasForReassignedPartition.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                                     <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.startNewReplicasForReassignedPartition.reassignedPartitionContext">reassignedPartitionContext</a>: <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a>,
                                                     <a title="scala.collection.Set[Int]" id="kafka.controller;KafkaController.startNewReplicasForReassignedPartition.newReplicas">newReplicas</a>: <span title="scala.collection.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// send the start replica request to the brokers in the reassigned replicas list that are not in the assigned</span>
    <span class="comment">// replicas list</span>
    <a href="#kafka.controller;KafkaController.startNewReplicasForReassignedPartition.newReplicas" title="scala.collection.Set[Int]">newReplicas</a>.<span title="(f: Int =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="Int" id="kafka.controller;KafkaController.startNewReplicasForReassignedPartition.$anonfun.replica">replica</a> =&gt;
      <a href="#kafka.controller;KafkaController.replicaStateMachine" title="=&gt; kafka.controller.ReplicaStateMachine">replicaStateMachine</a>.<a href="ReplicaStateMachine.scala.html#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><span title="(elems: kafka.controller.PartitionAndReplica*)scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">(</span>new <a href="#kafka.controller.PartitionAndReplica.readResolve" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.startNewReplicasForReassignedPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.startNewReplicasForReassignedPartition.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;KafkaController.startNewReplicasForReassignedPartition.$anonfun.replica" title="Int">replica</a><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="ReplicaStateMachine.scala.html#kafka.controller.NewReplica" title="kafka.controller.NewReplica.type">NewReplica</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="(topicAndPartition: kafka.common.TopicAndPartition, replicasToReceiveRequest: Seq[Int], newAssignedReplicas: Seq[Int])Unit" id="kafka.controller;KafkaController.updateLeaderEpochAndSendRequest">updateLeaderEpochAndSendRequest</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="Seq[Int]" id="kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.replicasToReceiveRequest">replicasToReceiveRequest</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="Seq[Int]" id="kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.newAssignedReplicas">newAssignedReplicas</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.updateLeaderEpoch" title="(topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">updateLeaderEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.updatedLeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.replicasToReceiveRequest" title="Seq[Int]">replicasToReceiveRequest</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>,
          <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.updatedLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.newAssignedReplicas" title="Seq[Int]">newAssignedReplicas</a><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Controller %d epoch %d sent LeaderAndIsr request %s with new assigned replica list %s &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;to leader %d for partition being reassigned %s&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.updatedLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a>,
          <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.newAssignedReplicas" title="Seq[Int]">newAssignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.updatedLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
      case <span title="None.type">None</span> =&gt; <span class="comment">// fail the reassignment</span>
        <a href="#kafka.controller;KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Controller %d epoch %d failed to send LeaderAndIsr request with new assigned replica list %s &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;to leader for partition being reassigned %s&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a>,
          <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.newAssignedReplicas" title="Seq[Int]">newAssignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.updateLeaderEpochAndSendRequest.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.registerReassignedPartitionsListener">registerReassignedPartitionsListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">subscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ReassignPartitionsPath" title="=&gt; String">ReassignPartitionsPath</a>, <a href="#kafka.controller;KafkaController.partitionReassignedListener" title="=&gt; kafka.controller.PartitionsReassignedListener">partitionReassignedListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.deregisterReassignedPartitionsListener">deregisterReassignedPartitionsListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ReassignPartitionsPath" title="=&gt; String">ReassignPartitionsPath</a>, <a href="#kafka.controller;KafkaController.partitionReassignedListener" title="=&gt; kafka.controller.PartitionsReassignedListener">partitionReassignedListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.registerPreferredReplicaElectionListener">registerPreferredReplicaElectionListener</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">subscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.PreferredReplicaLeaderElectionPath" title="=&gt; String">PreferredReplicaLeaderElectionPath</a>, <a href="#kafka.controller;KafkaController.preferredReplicaElectionListener" title="=&gt; kafka.controller.PreferredReplicaElectionListener">preferredReplicaElectionListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.deregisterPreferredReplicaElectionListener">deregisterPreferredReplicaElectionListener</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.PreferredReplicaLeaderElectionPath" title="=&gt; String">PreferredReplicaLeaderElectionPath</a>, <a href="#kafka.controller;KafkaController.preferredReplicaElectionListener" title="=&gt; kafka.controller.PreferredReplicaElectionListener">preferredReplicaElectionListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners">deregisterReassignedPartitionsIsrChangeListeners</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.controller.ReassignedPartitionsContext)) =&gt; Unit)Unit">foreach</span> <a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.x0$15" title="Unit" class="delimiter">{</a>
      case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.reassignedPartitionsContext">reassignedPartitionsContext</a><span class="delimiter">)</span> =&gt;
        val <a title="String" id="kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.zkPartitionPath">zkPartitionPath</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPartitionLeaderAndIsrPath" title="(topic: String, partitionId: Int)String">getTopicPartitionLeaderAndIsrPath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.zkPartitionPath" title="String">zkPartitionPath</a>, <a href="#kafka.controller;KafkaController.deregisterReassignedPartitionsIsrChangeListeners.$anonfun.reassignedPartitionsContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionsContext</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$2" title="=&gt; kafka.controller.ReassignedPartitionsIsrChangeListener">isrChangeListener</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.readControllerEpochFromZookeeper">readControllerEpochFromZookeeper</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// initialize the controller epoch and zk version by reading from zookeeper</span>
    if<span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.pathExists" title="(client: org.I0Itec.zkclient.ZkClient, path: String)Boolean">pathExists</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ControllerEpochPath" title="=&gt; String">ControllerEpochPath</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="(String, org.apache.zookeeper.data.Stat)" id="kafka.controller;KafkaController.readControllerEpochFromZookeeper.epochData">epochData</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.readData" title="(client: org.I0Itec.zkclient.ZkClient, path: String)(String, org.apache.zookeeper.data.Stat)">readData</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.ControllerEpochPath" title="=&gt; String">ControllerEpochPath</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="(x$1: Int)Unit">epoch</a> = <a href="#kafka.controller;KafkaController.readControllerEpochFromZookeeper.epochData" title="(String, org.apache.zookeeper.data.Stat)">epochData</a>.<span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_1</span>.<span title="=&gt; Int">toInt</span>
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="(x$1: Int)Unit">epochZkVersion</a> = <a href="#kafka.controller;KafkaController.readControllerEpochFromZookeeper.epochData" title="(String, org.apache.zookeeper.data.Stat)">epochData</a>.<span title="=&gt; org.apache.zookeeper.data.Stat">_2</span>.<span title="()Int">getVersion</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Initialized controller epoch to %d and zk version %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epoch_=" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.epochZkVersion_=" title="=&gt; Int">epochZkVersion</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition)Unit" id="kafka.controller;KafkaController.removePartitionFromReassignedPartitions">removePartitionFromReassignedPartitions</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.ReassignedPartitionsContext]">get</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// stop watching the ISR changes for this partition</span>
      <a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkDataListener)Unit">unsubscribeDataChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPartitionLeaderAndIsrPath" title="(topic: String, partitionId: Int)String">getTopicPartitionLeaderAndIsrPath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span>,
        <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.ReassignedPartitionsContext">partitionsBeingReassigned</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$2" title="=&gt; kafka.controller.ReassignedPartitionsIsrChangeListener">isrChangeListener</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span class="comment">// read the current list of reassigned partitions from zookeeper</span>
    val <a title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;KafkaController.removePartitionFromReassignedPartitions.partitionsBeingReassigned">partitionsBeingReassigned</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getPartitionsBeingReassigned" title="(zkClient: org.I0Itec.zkclient.ZkClient)scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">getPartitionsBeingReassigned</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a><span class="delimiter">)</span>
    <span class="comment">// remove this partition from that list</span>
    val updatedPartitionsBeingReassigned = <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.partitionsBeingReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a> <a title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]" id="kafka.controller;KafkaController.removePartitionFromReassignedPartitions.updatedPartitionsBeingReassigned">-</a> <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>
    <span class="comment">// write the new list to zookeeper</span>
    <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.updatePartitionReassignmentData" title="(zkClient: org.I0Itec.zkclient.ZkClient, partitionsToBeReassigned: scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit">updatePartitionReassignmentData</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.updatedPartitionsBeingReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">updatedPartitionsBeingReassigned</a>.<span title="(f: kafka.controller.ReassignedPartitionsContext =&gt; Seq[Int])scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">mapValues</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.$anonfun.x$14" title="kafka.controller.ReassignedPartitionsContext">_</a>.<a href="#kafka.controller.ReassignedPartitionsContext.apply$default$1" title="=&gt; Seq[Int]">newReplicas</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// update the cache. NO-OP if the partition's reassignment was never started</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.ReassignedPartitionsContext]">remove</span><span title="Unit" class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, newReplicaAssignmentForTopic: scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]])Unit" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20)">updateAssignedReplicasForPartition</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>,
                                         <a title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).newReplicaAssignmentForTopic">newReplicaAssignmentForTopic</a>: <span title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">Map</span><span class="delimiter">[</span>TopicAndPartition, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      val <a title="String" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).zkPath">zkPath</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getTopicPath" title="(topic: String)String">getTopicPath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span>
      val <a title="String" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap">jsonPartitionMap</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.replicaAssignmentZkData" title="(map: scala.collection.Map[String,Seq[Int]])String">replicaAssignmentZkData</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).newReplicaAssignmentForTopic" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">newReplicaAssignmentForTopic</a>.<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; (String, Seq[Int]))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]],(String, Seq[Int]),scala.collection.Map[String,Seq[Int]]])scala.collection.Map[String,Seq[Int]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Map.Coll,(String, Seq[Int]),scala.collection.Map[String,Seq[Int]]]" class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap.$anonfun.e">e</a> =&gt; <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap.$anonfun.e" title="(kafka.common.TopicAndPartition, Seq[Int])">e</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>.<span title="(self: String)ArrowAssoc[String]">toString</span> <span title="(y: Seq[Int])(String, Seq[Int])">-&gt;</span> <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap.$anonfun.e" title="(kafka.common.TopicAndPartition, Seq[Int])">e</a>.<span title="=&gt; Seq[Int]">_2</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.updatePersistentPath" title="(client: org.I0Itec.zkclient.ZkClient, path: String, data: String)Unit">updatePersistentPath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).zkPath" title="String">zkPath</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap" title="String">jsonPartitionMap</a><span class="delimiter">)</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Updated path %s with %s for replica assignment&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).zkPath" title="String">zkPath</a>, <a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).jsonPartitionMap" title="String">jsonPartitionMap</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="org.I0Itec.zkclient.exception.ZkNoNodeException" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).e">e</a>: <span title="org.I0Itec.zkclient.exception.ZkNoNodeException">ZkNoNodeException</span> =&gt; throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Topic %s doesn't exist&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
      case <a title="Throwable" id="kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).e2">e2</a>: <span title="Throwable">Throwable</span> =&gt; throw new <a href="../common/KafkaException.scala.html#kafka.common;KafkaException" title="kafka.common.KafkaException">KafkaException</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateAssignedReplicasForPartition(29d8c43b20).e2" title="Throwable">e2</a>.<span title="()String">toString</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(partitionsToBeRemoved: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection">removePartitionsFromPreferredReplicaElection</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.partitionsToBeRemoved">partitionsToBeRemoved</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span>,
                                                   <a title="Boolean" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.isTriggeredByAutoRebalance">isTriggeredByAutoRebalance</a> : <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    for<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.partition">partition</a> &lt;- <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.partitionsToBeRemoved" title="(f: kafka.common.TopicAndPartition =&gt; Unit)Unit">partitionsToBeRemoved</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// check the status</span>
      val <a title="Int" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.currentLeader">currentLeader</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
      val <a title="Int" id="kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.preferredReplica">preferredReplica</a> = <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a><span class="delimiter">)</span>.<span title="=&gt; Int">head</span>
      if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.currentLeader" title="Int">currentLeader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s completed preferred replica leader election. New leader is %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a>, <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s failed to complete preferred replica leader election. Leader is %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.partition" title="kafka.common.TopicAndPartition">partition</a>, <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.$anonfun.currentLeader" title="Int">currentLeader</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.isTriggeredByAutoRebalance" title="Boolean">isTriggeredByAutoRebalance</a><span class="delimiter">)</span>
      <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.deletePath" title="(client: org.I0Itec.zkclient.ZkClient, path: String)Boolean">deletePath</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.PreferredReplicaLeaderElectionPath" title="=&gt; String">PreferredReplicaLeaderElectionPath</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a> <span title="(xs: scala.collection.TraversableOnce[kafka.common.TopicAndPartition])scala.collection.mutable.Set[kafka.common.TopicAndPartition]">--=</span> <a href="#kafka.controller;KafkaController.removePartitionsFromPreferredReplicaElection.partitionsToBeRemoved" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitionsToBeRemoved</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Send the leader information for selected partitions to selected brokers so that they can correctly respond to
   * metadata requests
   * @param brokers The brokers that the update metadata request should be sent to
   */</span>
  def <a title="(brokers: Seq[Int], partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit" id="kafka.controller;KafkaController.sendUpdateMetadataRequest">sendUpdateMetadataRequest</a><span class="delimiter">(</span><a title="Seq[Int]" id="kafka.controller;KafkaController.sendUpdateMetadataRequest.brokers">brokers</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span>, <a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.controller;KafkaController.sendUpdateMetadataRequest$default$2">partitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span title="scala.collection.Set.type">Set</span>.<span title="[A]=&gt; scala.collection.Set[A]">empty</span><span title="scala.collection.Set[kafka.common.TopicAndPartition]" class="delimiter">[</span><a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addUpdateMetadataRequestForBrokers" title="(brokerIds: Seq[Int], partitions: scala.collection.Set[kafka.common.TopicAndPartition], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addUpdateMetadataRequestForBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.sendUpdateMetadataRequest.brokers" title="Seq[Int]">brokers</a>, <a href="#kafka.controller;KafkaController.sendUpdateMetadataRequest$default$2" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a><span class="delimiter">)</span>
    <a href="#kafka.controller;KafkaController.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Removes a given partition replica from the ISR; if it is not the current
   * leader and there are sufficient remaining replicas in ISR.
   * @param topic topic
   * @param partition partition
   * @param replicaId replica Id
   * @return the new leaderAndIsr (with the replica removed if it was present),
   *         or None if leaderAndIsr is empty.
   */</span>
  def <a title="(topic: String, partition: Int, replicaId: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.removeReplicaFromIsr">removeReplicaFromIsr</a><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.removeReplicaFromIsr.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.partition">partition</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.replicaId">replicaId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">Option</span><span class="delimiter">[</span>LeaderIsrAndControllerEpoch<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.partition" title="Int">partition</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removing replica %d from ISR %s for partition %s.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a>,
      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    var <a title="Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch">finalLeaderIsrAndControllerEpoch</a>: <span title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">Option</span><span class="delimiter">[</span>LeaderIsrAndControllerEpoch<span class="delimiter">]</span> = <span title="None.type">None</span>
    var <a title="Boolean" id="kafka.controller;KafkaController.removeReplicaFromIsr.zkWriteCompleteOrUnnecessary">zkWriteCompleteOrUnnecessary</a> = false
    while <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.zkWriteCompleteOrUnnecessary" title="Boolean">zkWriteCompleteOrUnnecessary</a><span class="delimiter">)</span> <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.while$1" title="()Unit" class="delimiter">{</a>
      <span class="comment">// refresh leader and isr from zookeeper again</span>
      val <a title="Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.removeReplicaFromIsr.leaderIsrAndEpochOpt">leaderIsrAndEpochOpt</a> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.getLeaderIsrAndEpochForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">getLeaderIsrAndEpochForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.partition" title="Int">partition</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.zkWriteCompleteOrUnnecessary" title="Boolean">zkWriteCompleteOrUnnecessary</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderIsrAndEpochOpt" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">leaderIsrAndEpochOpt</a> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.removeReplicaFromIsr.leaderIsrAndEpoch">leaderIsrAndEpoch</a><span class="delimiter">)</span> =&gt; <span class="comment">// increment the leader epoch even if the ISR changes</span>
          val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr">leaderAndIsr</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>
          val <a title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.controllerEpoch">controllerEpoch</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a>
          if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.controllerEpoch" title="Int">controllerEpoch</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span>
            throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String(&quot;Leader and isr path written by another controller. This probably&quot;)" class="string">&quot;Leader and isr path written by another controller. This probably&quot;</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;means the current controller with epoch %d went through a soft failure and another &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;controller was elected with epoch %d. Aborting state change by this controller&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.controllerEpoch" title="Int">controllerEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span class="comment">// if the replica to be removed from the ISR is also the leader, set the new leader value to -1</span>
            val <a title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.newLeader">newLeader</a> = if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a><span class="delimiter">)</span> <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api.LeaderAndIsr" title="kafka.api.LeaderAndIsr.type">LeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api.LeaderAndIsr.NoLeader" title="=&gt; Int">NoLeader</a> else <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
            var <a title="List[Int]" id="kafka.controller;KafkaController.removeReplicaFromIsr.newIsr">newIsr</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(p: Int =&gt; Boolean)List[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.newIsr.$anonfun.b">b</a> =&gt; <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newIsr.$anonfun.b" title="Int">b</a> <span title="(x: Int)Boolean">!=</span> <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>

            <span class="comment">// if the replica to be removed from the ISR is the last surviving member of the ISR and unclean leader election</span>
            <span class="comment">// is disallowed for the corresponding topic, then we must preserve the ISR membership so that the replica can</span>
            <span class="comment">// eventually be restored as the leader.</span>
            if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newIsr" title="List[Int]">newIsr</a>.<span title="=&gt; Boolean">isEmpty</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <span title="=&gt; Boolean">!</span><a href="../log/LogConfig.scala.html#kafka.log.LogConfig" title="kafka.log.LogConfig.type">LogConfig</a>.<a href="../log/LogConfig.scala.html#kafka.log.LogConfig.fromProps(9d0df464c6)" title="(defaults: java.util.Properties, overrides: java.util.Properties)kafka.log.LogConfig">fromProps</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.props" title="=&gt; kafka.utils.VerifiableProperties">props</a>.<a href="../utils/VerifiableProperties.scala.html#kafka.utils;VerifiableProperties.props" title="=&gt; java.util.Properties">props</a>, <a href="../admin/AdminUtils.scala.html#kafka.admin.AdminUtils" title="kafka.admin.AdminUtils.type">AdminUtils</a>.<a href="../admin/AdminUtils.scala.html#kafka.admin.AdminUtils.fetchTopicConfig" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String)java.util.Properties">fetchTopicConfig</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>,
              <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="../log/LogConfig.scala.html#kafka.log;LogConfig.uncleanLeaderElectionEnable" title="=&gt; Boolean">uncleanLeaderElectionEnable</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Retaining last ISR %d of partition %s since unclean leader election is disabled&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newIsr" title="List[Int]">newIsr</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>
            <span class="delimiter">}</span>

            val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;KafkaController.removeReplicaFromIsr.newLeaderAndIsr">newLeaderAndIsr</a> = new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newLeader" title="Int">newLeader</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>,
              <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newIsr" title="List[Int]">newIsr</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <span class="comment">// update the new leadership decision in zookeeper or retry</span>
            val <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.updateSucceeded" title="(Boolean, Int)" class="delimiter">(</a><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.x$15" title="Boolean" id="kafka.controller;KafkaController.removeReplicaFromIsr.updateSucceeded">updateSucceeded</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.x$15" title="Int" id="kafka.controller;KafkaController.removeReplicaFromIsr.newVersion">newVersion</a><span class="delimiter">)</span> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.updateLeaderAndIsr" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partitionId: Int, newLeaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int, zkVersion: Int)(Boolean, Int)">updateLeaderAndIsr</a><span title="(Boolean, Int) @unchecked" class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.partition" title="Int">partition</a>,
              <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a><span class="delimiter">)</span>

            <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion_=" title="(x$1: Int)Unit">zkVersion</a> = <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newVersion" title="Int">newVersion</a>
            <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a> = <span title="(x: kafka.controller.LeaderIsrAndControllerEpoch)Some[kafka.controller.LeaderIsrAndControllerEpoch]">Some</span><span class="delimiter">(</span><a href="#kafka.controller.LeaderIsrAndControllerEpoch.readResolve" title="(leaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int)kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.LeaderIsrAndControllerEpoch)Option[kafka.controller.LeaderIsrAndControllerEpoch]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">get</span><span class="delimiter">)</span>
            if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.updateSucceeded" title="Boolean">updateSucceeded</a><span class="delimiter">)</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;New leader and ISR for partition %s is %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.toString" title="()String">toString</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.updateSucceeded" title="Boolean">updateSucceeded</a>
          <span class="delimiter">}</span> else <span class="delimiter">{</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Cannot remove replica %d from ISR of partition %s since it is not in the ISR. Leader = %d ; ISR = %s&quot;</span>
                 .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a> = <span title="(x: kafka.controller.LeaderIsrAndControllerEpoch)Some[kafka.controller.LeaderIsrAndControllerEpoch]">Some</span><span class="delimiter">(</span><a href="#kafka.controller.LeaderIsrAndControllerEpoch.readResolve" title="(leaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int)kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition, value: kafka.controller.LeaderIsrAndControllerEpoch)Option[kafka.controller.LeaderIsrAndControllerEpoch]">put</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a>.<span title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">get</span><span class="delimiter">)</span>
            true
          <span class="delimiter">}</span>
        case <span title="None.type">None</span> =&gt;
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Cannot remove replica %d from ISR of %s - leaderAndIsr is empty.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.removeReplicaFromIsr.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
          true
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;KafkaController.removeReplicaFromIsr.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Does not change leader or isr, but just increments the leader epoch
   * @param topic topic
   * @param partition partition
   * @return the new leaderAndIsr with an incremented leader epoch, or None if leaderAndIsr is empty.
   */</span>
  private def <a title="(topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.updateLeaderEpoch">updateLeaderEpoch</a><span class="delimiter">(</span><a title="String" id="kafka.controller;KafkaController.updateLeaderEpoch.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;KafkaController.updateLeaderEpoch.partition">partition</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">Option</span><span class="delimiter">[</span>LeaderIsrAndControllerEpoch<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.updateLeaderEpoch.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.partition" title="Int">partition</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Updating leader epoch for partition %s.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    var <a title="Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.updateLeaderEpoch.finalLeaderIsrAndControllerEpoch">finalLeaderIsrAndControllerEpoch</a>: <span title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">Option</span><span class="delimiter">[</span>LeaderIsrAndControllerEpoch<span class="delimiter">]</span> = <span title="None.type">None</span>
    var <a title="Boolean" id="kafka.controller;KafkaController.updateLeaderEpoch.zkWriteCompleteOrUnnecessary">zkWriteCompleteOrUnnecessary</a> = false
    while <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.zkWriteCompleteOrUnnecessary" title="Boolean">zkWriteCompleteOrUnnecessary</a><span class="delimiter">)</span> <a href="#kafka.controller;KafkaController.updateLeaderEpoch.while$2" title="()Unit" class="delimiter">{</a>
      <span class="comment">// refresh leader and isr from zookeeper again</span>
      val <a title="Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;KafkaController.updateLeaderEpoch.leaderIsrAndEpochOpt">leaderIsrAndEpochOpt</a> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.getLeaderIsrAndEpochForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">getLeaderIsrAndEpochForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.topic" title="String">topic</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.partition" title="Int">partition</a><span class="delimiter">)</span>
      <a href="#kafka.controller;KafkaController.updateLeaderEpoch.zkWriteCompleteOrUnnecessary" title="Boolean">zkWriteCompleteOrUnnecessary</a> = <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderIsrAndEpochOpt" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">leaderIsrAndEpochOpt</a> match <span class="delimiter">{</span>
        case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;KafkaController.updateLeaderEpoch.leaderIsrAndEpoch">leaderIsrAndEpoch</a><span class="delimiter">)</span> =&gt;
          val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr">leaderAndIsr</a> = <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>
          val <a title="Int" id="kafka.controller;KafkaController.updateLeaderEpoch.controllerEpoch">controllerEpoch</a> = <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderIsrAndEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndEpoch</a>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a>
          if<span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.controllerEpoch" title="Int">controllerEpoch</a> <span title="(x: Int)Boolean">&gt;</span> <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span>
            throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="String(&quot;Leader and isr path written by another controller. This probably&quot;)" class="string">&quot;Leader and isr path written by another controller. This probably&quot;</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;means the current controller with epoch %d went through a soft failure and another &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;controller was elected with epoch %d. Aborting state change by this controller&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.controllerEpoch" title="Int">controllerEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="comment">// increment the leader epoch even if there are no leader or isr changes to allow the leader to cache the expanded</span>
          <span class="comment">// assigned replica list</span>
          val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;KafkaController.updateLeaderEpoch.newLeaderAndIsr">newLeaderAndIsr</a> = new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>,
                                                 <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
          <span class="comment">// update the new leadership decision in zookeeper or retry</span>
          val <a href="#kafka.controller;KafkaController.updateLeaderEpoch.updateSucceeded" title="(Boolean, Int)" class="delimiter">(</a><a href="#kafka.controller;KafkaController.updateLeaderEpoch.x$16" title="Boolean" id="kafka.controller;KafkaController.updateLeaderEpoch.updateSucceeded">updateSucceeded</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.x$16" title="Int" id="kafka.controller;KafkaController.updateLeaderEpoch.newVersion">newVersion</a><span class="delimiter">)</span> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.updateLeaderAndIsr" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partitionId: Int, newLeaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int, zkVersion: Int)(Boolean, Int)">updateLeaderAndIsr</a><span title="(Boolean, Int) @unchecked" class="delimiter">(</span><a href="#kafka.controller;KafkaController.zkClient" title="org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.topic" title="String">topic</a>,
            <a href="#kafka.controller;KafkaController.updateLeaderEpoch.partition" title="Int">partition</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a><span class="delimiter">)</span>

          <a href="#kafka.controller;KafkaController.updateLeaderEpoch.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion_=" title="(x$1: Int)Unit">zkVersion</a> = <a href="#kafka.controller;KafkaController.updateLeaderEpoch.newVersion" title="Int">newVersion</a>
          <a href="#kafka.controller;KafkaController.updateLeaderEpoch.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a> = <span title="(x: kafka.controller.LeaderIsrAndControllerEpoch)Some[kafka.controller.LeaderIsrAndControllerEpoch]">Some</span><span class="delimiter">(</span><a href="#kafka.controller.LeaderIsrAndControllerEpoch.readResolve" title="(leaderAndIsr: kafka.api.LeaderAndIsr, controllerEpoch: Int)kafka.controller.LeaderIsrAndControllerEpoch">LeaderIsrAndControllerEpoch</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.updateSucceeded" title="Boolean">updateSucceeded</a><span class="delimiter">)</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Updated leader epoch for partition %s to %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;KafkaController.updateLeaderEpoch.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;KafkaController.updateLeaderEpoch.updateSucceeded" title="Boolean">updateSucceeded</a>
        case <span title="None.type">None</span> =&gt;
          throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Cannot update leader epoch for partition %s as leaderAndIsr path is empty. &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
            <span class="string">&quot;This could mean we somehow tried to reassign a partition that doesn't exist&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.updateLeaderEpoch.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
          true
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;KafkaController.updateLeaderEpoch.finalLeaderIsrAndControllerEpoch" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">finalLeaderIsrAndControllerEpoch</a>
  <span class="delimiter">}</span>

  class <a title="class SessionExpirationListener extends Object with org.I0Itec.zkclient.IZkStateListener with kafka.utils.Logging" id="kafka.controller;KafkaController;SessionExpirationListener">SessionExpirationListener</a><a href="#kafka.controller;KafkaController;SessionExpirationListener" title="KafkaController.this.SessionExpirationListener" class="delimiter">(</a><span class="delimiter">)</span> extends <a href="#kafka.controller;KafkaController;SessionExpirationListener" title="org.I0Itec.zkclient.IZkStateListener">IZkStateListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
    this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[SessionExpirationListener on &quot;)" class="string">&quot;[SessionExpirationListener on &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;], &quot;)" class="string">&quot;], &quot;</span>
    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="(state: org.apache.zookeeper.Watcher.Event.KeeperState)Unit" id="kafka.controller;KafkaController;SessionExpirationListener.handleStateChanged">handleStateChanged</a><span class="delimiter">(</span><a title="org.apache.zookeeper.Watcher.Event.KeeperState" id="kafka.controller;KafkaController;SessionExpirationListener.handleStateChanged.state">state</a>: <span title="org.apache.zookeeper.Watcher.Event.KeeperState">KeeperState</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
      <span class="comment">// do nothing, since zkclient will do reconnect for us.</span>
    <span class="delimiter">}</span>

    <span class="comment">/**
     * Called after the zookeeper session has expired and a new session has been created. You would have to re-create
     * any ephemeral nodes here.
     *
     * @throws Exception
     *             On any error.
     */</span>
    @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
    def <a title="()Unit" id="kafka.controller;KafkaController;SessionExpirationListener.handleNewSession">handleNewSession</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;ZK expired; shut down all controller components and try to re-elect&quot;)" class="string">&quot;ZK expired; shut down all controller components and try to re-elect&quot;</span><span class="delimiter">)</span>
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Boolean)Boolean">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
        <a href="#kafka.controller;KafkaController.onControllerResignation" title="()Unit">onControllerResignation</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#kafka.controller;KafkaController.controllerElector" title="=&gt; kafka.server.ZookeeperLeaderElector">controllerElector</a>.<a href="../server/ZookeeperLeaderElector.scala.html#kafka.server;ZookeeperLeaderElector.elect" title="=&gt; Boolean">elect</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance">checkAndTriggerPartitionRebalance</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.isActive" title="()Boolean">isActive</a><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="String(&quot;checking need to trigger partition rebalance&quot;)" class="string">&quot;checking need to trigger partition rebalance&quot;</span><span class="delimiter">)</span>
      <span class="comment">// get all the active brokers</span>
      var <a title="scala.collection.Map[Int,scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]]" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.preferredReplicasForTopicsByBrokers">preferredReplicasForTopicsByBrokers</a>: <span title="scala.collection.Map[Int,scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]]">Map</span><span class="delimiter">[</span>Int, Map<span class="delimiter">[</span>TopicAndPartition, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">]</span> = null
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.preferredReplicasForTopicsByBrokers" title="scala.collection.Map[Int,scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]]">preferredReplicasForTopicsByBrokers</a> =
          <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionReplicaAssignment_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filterNot</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.p" title="(kafka.common.TopicAndPartition, Seq[Int])">p</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Int)scala.collection.immutable.Map[Int,scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]]">groupBy</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.x0$16" title="Int" class="delimiter">{</a>
            case<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="Seq[Int]" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.assignedReplicas">assignedReplicas</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.assignedReplicas" title="Seq[Int]">assignedReplicas</a>.<span title="=&gt; Int">head</span>
          <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;preferred replicas by broker &quot;)" class="string">&quot;preferred replicas by broker &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.preferredReplicasForTopicsByBrokers" title="scala.collection.Map[Int,scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]]">preferredReplicasForTopicsByBrokers</a><span class="delimiter">)</span>
      <span class="comment">// for each broker, check if a preferred replica election needs to be triggered</span>
      <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.preferredReplicasForTopicsByBrokers" title="scala.collection.Map[Int,scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]]">preferredReplicasForTopicsByBrokers</a>.<span title="(f: ((Int, scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]])) =&gt; Unit)Unit">foreach</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.x0$17" title="Unit" class="delimiter">{</a>
        case<span class="delimiter">(</span><a title="Int" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.leaderBroker">leaderBroker</a>, <a title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicAndPartitionsForBroker">topicAndPartitionsForBroker</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          var <a title="Double" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.imbalanceRatio">imbalanceRatio</a>: <span title="Double">Double</span> = <span title="Double(0.0)" class="int">0</span>
          var <a title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicsNotInPreferredReplica">topicsNotInPreferredReplica</a>: <span title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">Map</span><span class="delimiter">[</span>TopicAndPartition, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">]</span> = null
          <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicsNotInPreferredReplica" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicsNotInPreferredReplica</a> =
              <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicAndPartitionsForBroker" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicAndPartitionsForBroker</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.$anonfun.x0$18" title="Boolean" class="delimiter">{</a>
                case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                  <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition)Boolean">contains</span><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                  <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionLeadershipInfo_=" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span><span class="delimiter">)</span>.<a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">!=</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.leaderBroker" title="Int">leaderBroker</a>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="String(&quot;topics not in preferred replica &quot;)" class="string">&quot;topics not in preferred replica &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicsNotInPreferredReplica" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicsNotInPreferredReplica</a><span class="delimiter">)</span>
            val <a title="Int" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.totalTopicPartitionsForBroker">totalTopicPartitionsForBroker</a> = <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicAndPartitionsForBroker" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicAndPartitionsForBroker</a>.<span title="=&gt; Int">size</span>
            val <a title="Int" id="kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.totalTopicPartitionsNotLedByBroker">totalTopicPartitionsNotLedByBroker</a> = <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicsNotInPreferredReplica" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicsNotInPreferredReplica</a>.<span title="=&gt; Int">size</span>
            <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.imbalanceRatio" title="Double">imbalanceRatio</a> = <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.totalTopicPartitionsNotLedByBroker" title="Int">totalTopicPartitionsNotLedByBroker</a>.<span title="=&gt; Double">toDouble</span> <span title="(x: Int)Double">/</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.totalTopicPartitionsForBroker" title="Int">totalTopicPartitionsForBroker</a>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;leader imbalance ratio for broker %d is %f&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.leaderBroker" title="Int">leaderBroker</a>, <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.imbalanceRatio" title="Double">imbalanceRatio</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
          <span class="comment">// check ratio and if greater than desired ratio, trigger a rebalance for the topic partitions</span>
          <span class="comment">// that need to be on this broker</span>
          if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.imbalanceRatio" title="Double">imbalanceRatio</a> <span title="(x: Double)Boolean">&gt;</span> <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.leaderImbalancePerBrokerPercentage" title="=&gt; Int">leaderImbalancePerBrokerPercentage</a>.<span title="=&gt; Double">toDouble</span> <span title="(x: Int)Double">/</span> <span title="Int(100)" class="int">100</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.topicsNotInPreferredReplica" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">topicsNotInPreferredReplica</a>.<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Unit)Unit">foreach</span> <a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.$anonfun.x0$19" title="Unit" class="delimiter">{</a>
              case<span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span>, <span title="Seq[Int]">replicas</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
                <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <span class="comment">// do this check only if the broker is live and there are no partitions being reassigned currently</span>
                  <span class="comment">// and preferred replica election is not in progress</span>
                  if <span class="delimiter">(</span><a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;KafkaController.checkAndTriggerPartitionRebalance.$anonfun.leaderBroker" title="Int">leaderBroker</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                      <span title="=&gt; Boolean">!</span><a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                      <a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.allTopics_=" title="=&gt; scala.collection.Set[String]">allTopics</a>.<span title="(elem: String)Boolean">contains</span><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                    <a href="#kafka.controller;KafkaController.onPreferredReplicaElection" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit">onPreferredReplicaElection</a><span class="delimiter">(</span><span title="(elems: kafka.common.TopicAndPartition*)scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">(</span><span title="kafka.common.TopicAndPartition">topicPartition</span><span class="delimiter">)</span>, true<span class="delimiter">)</span>
                  <span class="delimiter">}</span>
                <span class="delimiter">}</span>
              <span class="delimiter">}</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Starts the partition reassignment process unless -
 * 1. Partition previously existed
 * 2. New replicas are the same as existing replicas
 * 3. Any replica in the new set of replicas are dead
 * If any of the above conditions are satisfied, it logs an error and removes the partition from list of reassigned
 * partitions.
 */</span>
class <a title="class PartitionsReassignedListener extends Object with org.I0Itec.zkclient.IZkDataListener with kafka.utils.Logging" id="kafka.controller;PartitionsReassignedListener">PartitionsReassignedListener</a><a href="#kafka.controller;PartitionsReassignedListener" title="kafka.controller.PartitionsReassignedListener" class="delimiter">(</a><a title="kafka.controller.KafkaController" id="kafka.controller;PartitionsReassignedListener.controller">controller</a>: <a href="#kafka.controller;KafkaController" title="kafka.controller.KafkaController">KafkaController</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionsReassignedListener" title="org.I0Itec.zkclient.IZkDataListener">IZkDataListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[PartitionsReassignedListener on &quot;)" class="string">&quot;[PartitionsReassignedListener on &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
  val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;PartitionsReassignedListener.zkClient">zkClient</a> = <a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>
  val <a title="kafka.controller.ControllerContext" id="kafka.controller;PartitionsReassignedListener.controllerContext">controllerContext</a> = <a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>

  <span class="comment">/**
   * Invoked when some partitions are reassigned by the admin command
   * @throws Exception On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String, data: Object)Unit" id="kafka.controller;PartitionsReassignedListener.handleDataChange">handleDataChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionsReassignedListener.handleDataChange.dataPath">dataPath</a>: <span title="String">String</span>, <a title="Object" id="kafka.controller;PartitionsReassignedListener.handleDataChange.data">data</a>: <span title="Object">Object</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partitions reassigned listener fired for path %s. Record partitions to be reassigned %s&quot;</span>
      .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.dataPath" title="String">dataPath</a>, <a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.data" title="Object">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsReassignmentData">partitionsReassignmentData</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.parsePartitionReassignmentData" title="(jsonData: String)scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">parsePartitionReassignmentData</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.data" title="Object">data</a>.<span title="()String">toString</span><span class="delimiter">)</span>
    val <a title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]" id="kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsToBeReassigned">partitionsToBeReassigned</a> = <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]])scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsReassignmentData" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsReassignmentData</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">filterNot</span><span class="delimiter">(</span><a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsToBeReassigned.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;PartitionsReassignedListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsToBeReassigned.$anonfun.p" title="(kafka.common.TopicAndPartition, Seq[Int])">p</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.partitionsToBeReassigned" title="scala.collection.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionsToBeReassigned</a>.<span title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <a title="(kafka.common.TopicAndPartition, Seq[Int])" id="kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned">partitionToBeReassigned</a> =&gt;
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if<span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Skipping reassignment of partition %s for topic %s since it is currently being deleted&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>, <a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.removePartitionFromReassignedPartitions" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">removePartitionFromReassignedPartitions</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span><span class="delimiter">)</span>
        <span class="delimiter">}</span> else <span class="delimiter">{</span>
          val <a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.context">context</a> = new <a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="kafka.controller.ReassignedPartitionsContext">ReassignedPartitionsContext</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; Seq[Int]">_2</span><span class="delimiter">)</span>
          <a href="#kafka.controller;PartitionsReassignedListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.initiateReassignReplicasForTopicPartition" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">initiateReassignReplicasForTopicPartition</a><span class="delimiter">(</span><a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.partitionToBeReassigned" title="(kafka.common.TopicAndPartition, Seq[Int])">partitionToBeReassigned</a>.<span title="=&gt; kafka.common.TopicAndPartition">_1</span>, <a href="#kafka.controller;PartitionsReassignedListener.handleDataChange.$anonfun.context" title="kafka.controller.ReassignedPartitionsContext">context</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Called when the leader information stored in zookeeper has been delete. Try to elect as the leader
   * @throws Exception
   *             On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String)Unit" id="kafka.controller;PartitionsReassignedListener.handleDataDeleted">handleDataDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PartitionsReassignedListener.handleDataDeleted.dataPath">dataPath</a>: <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

class <a title="class ReassignedPartitionsIsrChangeListener extends Object with org.I0Itec.zkclient.IZkDataListener with kafka.utils.Logging" id="kafka.controller;ReassignedPartitionsIsrChangeListener">ReassignedPartitionsIsrChangeListener</a><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener" title="kafka.controller.ReassignedPartitionsIsrChangeListener" class="delimiter">(</a><a title="kafka.controller.KafkaController" id="kafka.controller;ReassignedPartitionsIsrChangeListener.controller">controller</a>: <a href="#kafka.controller;KafkaController" title="kafka.controller.KafkaController">KafkaController</a>, <a title="String" id="kafka.controller;ReassignedPartitionsIsrChangeListener.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;ReassignedPartitionsIsrChangeListener.partition">partition</a>: <span title="Int">Int</span>,
                                            <a title="scala.collection.Set[Int]" id="kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas">reassignedReplicas</a>: <span title="scala.collection.Set[Int]">Set</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span>
  extends <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener" title="org.I0Itec.zkclient.IZkDataListener">IZkDataListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[ReassignedPartitionsIsrChangeListener on controller &quot;)" class="string">&quot;[ReassignedPartitionsIsrChangeListener on controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
  val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;ReassignedPartitionsIsrChangeListener.zkClient">zkClient</a> = <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>
  val <a title="kafka.controller.ControllerContext" id="kafka.controller;ReassignedPartitionsIsrChangeListener.controllerContext">controllerContext</a> = <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>

  <span class="comment">/**
   * Invoked when some partitions need to move leader to preferred replica
   * @throws Exception On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String, data: Object)Unit" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange">handleDataChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.dataPath">dataPath</a>: <span title="String">String</span>, <a title="Object" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.data">data</a>: <span title="Object">Object</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Reassigned partitions isr change listener fired for path %s with children %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.dataPath" title="String">dataPath</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.data" title="Object">data</a><span class="delimiter">)</span><span class="delimiter">)</span>
      val <a title="kafka.common.TopicAndPartition" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.topic" title="String">topic</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.partition" title="Int">partition</a><span class="delimiter">)</span>
      try <span class="delimiter">{</span>
        <span class="comment">// check if this partition is still being reassigned or not</span>
        <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsBeingReassigned_=" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.ReassignedPartitionsContext]">partitionsBeingReassigned</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.ReassignedPartitionsContext]">get</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
          case Some<span class="delimiter">(</span><a title="kafka.controller.ReassignedPartitionsContext" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.reassignedPartitionContext">reassignedPartitionContext</a><span class="delimiter">)</span> =&gt;
            <span class="comment">// need to re-read leader and isr from zookeeper since the zkclient callback doesn't return the Stat object</span>
            val <a title="Option[kafka.api.LeaderAndIsr]" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.newLeaderAndIsrOpt">newLeaderAndIsrOpt</a> = <a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getLeaderAndIsrForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.api.LeaderAndIsr]">getLeaderAndIsrForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.topic" title="String">topic</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.partition" title="Int">partition</a><span class="delimiter">)</span>
            <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.newLeaderAndIsrOpt" title="Option[kafka.api.LeaderAndIsr]">newLeaderAndIsrOpt</a> match <span class="delimiter">{</span>
              case Some<span class="delimiter">(</span><a title="kafka.api.LeaderAndIsr" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.leaderAndIsr">leaderAndIsr</a><span class="delimiter">)</span> =&gt; <span class="comment">// check if new replicas have joined ISR</span>
                val caughtUpReplicas = <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a> <a title="scala.collection.Set[Int]" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.caughtUpReplicas">&amp;</a> <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
                if<span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.caughtUpReplicas" title="scala.collection.Set[Int]">caughtUpReplicas</a> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a><span class="delimiter">)</span> <span class="delimiter">{</span>
                  <span class="comment">// resume the partition reassignment process</span>
                  <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d/%d replicas have caught up with the leader for partition %s being reassigned.&quot;</span>
                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.caughtUpReplicas" title="scala.collection.Set[Int]">caughtUpReplicas</a>.<span title="=&gt; Int">size</span>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a>.<span title="=&gt; Int">size</span>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                    <span title="String(&quot;Resuming partition reassignment&quot;)" class="string">&quot;Resuming partition reassignment&quot;</span><span class="delimiter">)</span>
                  <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.onPartitionReassignment" title="(topicAndPartition: kafka.common.TopicAndPartition, reassignedPartitionContext: kafka.controller.ReassignedPartitionsContext)Unit">onPartitionReassignment</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.reassignedPartitionContext" title="kafka.controller.ReassignedPartitionsContext">reassignedPartitionContext</a><span class="delimiter">)</span>
                <span class="delimiter">}</span>
                else <span class="delimiter">{</span>
                  <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d/%d replicas have caught up with the leader for partition %s being reassigned.&quot;</span>
                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.caughtUpReplicas" title="scala.collection.Set[Int]">caughtUpReplicas</a>.<span title="=&gt; Int">size</span>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a>.<span title="=&gt; Int">size</span>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Replica(s) %s still need to catch up&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a> <span title="(xs: scala.collection.GenTraversableOnce[Int])scala.collection.Set[Int]">--</span> <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.leaderAndIsr" title="kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="scala.collection.immutable.Set[Int]">toSet</span><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
                <span class="delimiter">}</span>
              case <span title="None.type">None</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error handling reassignment of partition %s to replicas %s as it was never created&quot;</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.reassignedReplicas" title="scala.collection.Set[Int]">reassignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          case <span title="None.type">None</span> =&gt;
        <span class="delimiter">}</span>
      <span class="delimiter">}</span> catch <span class="delimiter">{</span>
        case <a title="Throwable" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while handling partition reassignment&quot;)" class="string">&quot;Error while handling partition reassignment&quot;</span>, <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataChange.e" title="Throwable">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @throws Exception
   *             On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String)Unit" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataDeleted">handleDataDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReassignedPartitionsIsrChangeListener.handleDataDeleted.dataPath">dataPath</a>: <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Starts the preferred replica leader election for the list of partitions specified under
 * /admin/preferred_replica_election -
 */</span>
class <a title="class PreferredReplicaElectionListener extends Object with org.I0Itec.zkclient.IZkDataListener with kafka.utils.Logging" id="kafka.controller;PreferredReplicaElectionListener">PreferredReplicaElectionListener</a><a href="#kafka.controller;PreferredReplicaElectionListener" title="kafka.controller.PreferredReplicaElectionListener" class="delimiter">(</a><a title="kafka.controller.KafkaController" id="kafka.controller;PreferredReplicaElectionListener.controller">controller</a>: <a href="#kafka.controller;KafkaController" title="kafka.controller.KafkaController">KafkaController</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PreferredReplicaElectionListener" title="org.I0Itec.zkclient.IZkDataListener">IZkDataListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[PreferredReplicaElectionListener on &quot;)" class="string">&quot;[PreferredReplicaElectionListener on &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;PreferredReplicaElectionListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
  val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;PreferredReplicaElectionListener.zkClient">zkClient</a> = <a href="#kafka.controller;PreferredReplicaElectionListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>
  val <a title="kafka.controller.ControllerContext" id="kafka.controller;PreferredReplicaElectionListener.controllerContext">controllerContext</a> = <a href="#kafka.controller;PreferredReplicaElectionListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>

  <span class="comment">/**
   * Invoked when some partitions are reassigned by the admin command
   * @throws Exception On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String, data: Object)Unit" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange">handleDataChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.dataPath">dataPath</a>: <span title="String">String</span>, <a title="Object" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.data">data</a>: <span title="Object">Object</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Preferred replica election listener fired for path %s. Record partitions to undergo preferred replica election %s&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.dataPath" title="String">dataPath</a>, <a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.data" title="Object">data</a>.<span title="()String">toString</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForPreferredReplicaElection">partitionsForPreferredReplicaElection</a> = <a href="../admin/PreferredReplicaLeaderElectionCommand.scala.html#kafka.admin.PreferredReplicaLeaderElectionCommand" title="kafka.admin.PreferredReplicaLeaderElectionCommand.type">PreferredReplicaLeaderElectionCommand</a>.<a href="../admin/PreferredReplicaLeaderElectionCommand.scala.html#kafka.admin.PreferredReplicaLeaderElectionCommand.parsePreferredReplicaElectionData" title="(jsonString: String)scala.collection.immutable.Set[kafka.common.TopicAndPartition]">parsePreferredReplicaElectionData</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.data" title="Object">data</a>.<span title="()String">toString</span><span class="delimiter">)</span>
      if<span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;These partitions are already undergoing preferred replica election: %s&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      val partitions = <a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForPreferredReplicaElection" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitionsForPreferredReplicaElection</a> <a title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitions">--</a> <a href="#kafka.controller;PreferredReplicaElectionListener.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="#kafka.controller;ControllerContext.partitionsUndergoingPreferredReplicaElection_=" title="=&gt; scala.collection.mutable.Set[kafka.common.TopicAndPartition]">partitionsUndergoingPreferredReplicaElection</a>
      val <a title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted">partitionsForTopicsToBeDeleted</a> = <a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitions" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(p: kafka.common.TopicAndPartition =&gt; Boolean)scala.collection.immutable.Set[kafka.common.TopicAndPartition]">filter</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted.$anonfun.p">p</a> =&gt; <a href="#kafka.controller;PreferredReplicaElectionListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.deleteTopicManager_=" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isTopicQueuedUpForDeletion" title="(topic: String)Boolean">isTopicQueuedUpForDeletion</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted.$anonfun.p" title="kafka.common.TopicAndPartition">p</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>
      if<span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitionsForTopicsToBeDeleted</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Skipping preferred replica election for partitions %s since the respective topics are being deleted&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitionsForTopicsToBeDeleted</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.controller;PreferredReplicaElectionListener.controller" title="kafka.controller.KafkaController">controller</a>.<a href="#kafka.controller;KafkaController.onPreferredReplicaElection" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition], isTriggeredByAutoRebalance: Boolean)Unit">onPreferredReplicaElection</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitions" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitions</a> <span title="(xs: scala.collection.GenTraversableOnce[kafka.common.TopicAndPartition])scala.collection.immutable.Set[kafka.common.TopicAndPartition]">--</span> <a href="#kafka.controller;PreferredReplicaElectionListener.handleDataChange.partitionsForTopicsToBeDeleted" title="scala.collection.immutable.Set[kafka.common.TopicAndPartition]">partitionsForTopicsToBeDeleted</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * @throws Exception
   *             On any error.
   */</span>
  @throws<span class="delimiter">(</span>classOf<span class="delimiter">[</span>Exception<span class="delimiter">]</span><span class="delimiter">)</span>
  def <a title="(dataPath: String)Unit" id="kafka.controller;PreferredReplicaElectionListener.handleDataDeleted">handleDataDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;PreferredReplicaElectionListener.handleDataDeleted.dataPath">dataPath</a>: <span title="String">String</span><span class="delimiter">)</span> <span title="Unit" class="delimiter">{</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

case class <a title="class ReassignedPartitionsContext extends AnyRef with Product with Serializable" id="kafka.controller.ReassignedPartitionsContext.readResolve">ReassignedPartitionsContext</a><a href="#kafka.controller.ReassignedPartitionsContext.readResolve" title="Product" class="delimiter">(</a>var <a title="Seq[Int]" id="kafka.controller.ReassignedPartitionsContext.apply$default$1">newReplicas</a>: <span title="Seq[Int]">Seq</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span title="scala.collection.Seq.type">Seq</span>.<span title="Seq[Nothing]">empty</span>,
                                       var <a title="kafka.controller.ReassignedPartitionsIsrChangeListener" id="kafka.controller.ReassignedPartitionsContext.apply$default$2">isrChangeListener</a>: <a href="#kafka.controller;ReassignedPartitionsIsrChangeListener" title="kafka.controller.ReassignedPartitionsIsrChangeListener">ReassignedPartitionsIsrChangeListener</a> = null<span class="delimiter">)</span>

case class <a title="class PartitionAndReplica extends AnyRef with Product with Serializable" id="kafka.controller.PartitionAndReplica.readResolve">PartitionAndReplica</a><a href="#kafka.controller.PartitionAndReplica.readResolve" title="Product" class="delimiter">(</a><a title="String" id="kafka.controller;PartitionAndReplica.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.controller;PartitionAndReplica.partition">partition</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.controller;PartitionAndReplica.replica">replica</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  override def <a title="()String" id="kafka.controller;PartitionAndReplica.toString">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;[Topic=%s,Partition=%d,Replica=%d]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a>, <a href="#kafka.controller;PartitionAndReplica.partition" title="=&gt; Int">partition</a>, <a href="#kafka.controller;PartitionAndReplica.replica" title="=&gt; Int">replica</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

case class <a title="class LeaderIsrAndControllerEpoch extends AnyRef with Product with Serializable" id="kafka.controller.LeaderIsrAndControllerEpoch.readResolve">LeaderIsrAndControllerEpoch</a><a href="#kafka.controller.LeaderIsrAndControllerEpoch.readResolve" title="Product" class="delimiter">(</a>val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr">leaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a>, <a title="Int" id="kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch">controllerEpoch</a>: <span title="Int">Int</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  override def <a title="()String" id="kafka.controller;LeaderIsrAndControllerEpoch.toString">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="String">String</span> = <span class="delimiter">{</span>
    val <a title="StringBuilder" id="kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo">leaderAndIsrInfo</a> = new <span title="StringBuilder">StringBuilder</span>
    <a href="#kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo" title="StringBuilder">leaderAndIsrInfo</a>.<span title="(s: String)StringBuilder">append</span><span class="delimiter">(</span><span title="String(&quot;(Leader:&quot;)" class="string">&quot;(Leader:&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a><span class="delimiter">)</span>
    <a href="#kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo" title="StringBuilder">leaderAndIsrInfo</a>.<span title="(s: String)StringBuilder">append</span><span class="delimiter">(</span><span title="String(&quot;,ISR:&quot;)" class="string">&quot;,ISR:&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo" title="StringBuilder">leaderAndIsrInfo</a>.<span title="(s: String)StringBuilder">append</span><span class="delimiter">(</span><span title="String(&quot;,LeaderEpoch:&quot;)" class="string">&quot;,LeaderEpoch:&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a><span class="delimiter">)</span>
    <a href="#kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo" title="StringBuilder">leaderAndIsrInfo</a>.<span title="(s: String)StringBuilder">append</span><span class="delimiter">(</span><span title="String(&quot;,ControllerEpoch:&quot;)" class="string">&quot;,ControllerEpoch:&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;)&quot;)" class="string">&quot;)&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.controller;LeaderIsrAndControllerEpoch.toString.leaderAndIsrInfo" title="StringBuilder">leaderAndIsrInfo</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

object <a title="kafka.controller.ControllerStats.type" id="kafka.controller.ControllerStats">ControllerStats</a> extends <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup" title="kafka.metrics.KafkaMetricsGroup">KafkaMetricsGroup</a> <span class="delimiter">{</span>
  val <a title="com.yammer.metrics.core.Meter" id="kafka.controller.ControllerStats.uncleanLeaderElectionRate">uncleanLeaderElectionRate</a> = <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newMeter" title="(name: String, eventType: String, timeUnit: java.util.concurrent.TimeUnit, tags: scala.collection.Map[String,String])com.yammer.metrics.core.Meter">newMeter</a><span class="delimiter">(</span><span title="String(&quot;UncleanLeaderElectionsPerSec&quot;)" class="string">&quot;UncleanLeaderElectionsPerSec&quot;</span>, <span title="String(&quot;elections&quot;)" class="string">&quot;elections&quot;</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span>
  val <a title="kafka.metrics.KafkaTimer" id="kafka.controller.ControllerStats.leaderElectionTimer">leaderElectionTimer</a> = new <a href="../metrics/KafkaTimer.scala.html#kafka.metrics;KafkaTimer" title="kafka.metrics.KafkaTimer">KafkaTimer</a><span class="delimiter">(</span><a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newTimer" title="(name: String, durationUnit: java.util.concurrent.TimeUnit, rateUnit: java.util.concurrent.TimeUnit, tags: scala.collection.Map[String,String])com.yammer.metrics.core.Timer">newTimer</a><span class="delimiter">(</span><span title="String(&quot;LeaderElectionRateAndTimeMs&quot;)" class="string">&quot;LeaderElectionRateAndTimeMs&quot;</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(MILLISECONDS)">MILLISECONDS</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
