<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/controller/PartitionLeaderSelector.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
package kafka.controller

import kafka.admin.AdminUtils
import kafka.api.LeaderAndIsr
import kafka.log.LogConfig
import kafka.utils.Logging
import kafka.common.<span class="delimiter">{</span>LeaderElectionNotNeededException, TopicAndPartition, StateChangeFailedException, NoReplicaOnlineException<span class="delimiter">}</span>
import kafka.server.KafkaConfig

trait <a title="trait PartitionLeaderSelector extends AnyRef" id="kafka.controller;PartitionLeaderSelector">PartitionLeaderSelector</a> <span class="delimiter">{</span>

  <span class="comment">/**
   * @param topicAndPartition          The topic and partition whose leader needs to be elected
   * @param currentLeaderAndIsr        The current leader and isr of input partition read from zookeeper
   * @throws NoReplicaOnlineException If no replica in the assigned replicas list is alive
   * @return The leader and isr request, with the newly selected leader and isr, and the set of replicas to receive
   * the LeaderAndIsrRequest.
   */</span>
  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;PartitionLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PartitionLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;PartitionLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span>

<span class="delimiter">}</span>

<span class="comment">/**
 * Select the new leader, new isr and receiving replicas (for the LeaderAndIsrRequest):
 * 1. If at least one broker from the isr is alive, it picks a broker from the live isr as the new leader and the live
 *    isr as the new isr.
 * 2. Else, if unclean leader election for the topic is disabled, it throws a NoReplicaOnlineException.
 * 3. Else, it picks some alive broker from the assigned replica list as the new leader and the new isr.
 * 4. If no broker in the assigned replica list is alive, it throws a NoReplicaOnlineException
 * Replicas to receive LeaderAndIsr request = live assigned replicas
 * Once the leader is successfully registered in zookeeper, it updates the allLeaders cache
 */</span>
class <a title="class OfflinePartitionLeaderSelector extends AnyRef with kafka.controller.PartitionLeaderSelector with kafka.utils.Logging" id="kafka.controller;OfflinePartitionLeaderSelector">OfflinePartitionLeaderSelector</a><a href="#kafka.controller;OfflinePartitionLeaderSelector" title="kafka.controller.OfflinePartitionLeaderSelector" class="delimiter">(</a><a title="kafka.controller.ControllerContext" id="kafka.controller;OfflinePartitionLeaderSelector.controllerContext">controllerContext</a>: <a href="KafkaController.scala.html#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a>, <a title="kafka.server.KafkaConfig" id="kafka.controller;OfflinePartitionLeaderSelector.config">config</a>: <a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig" title="kafka.server.KafkaConfig">KafkaConfig</a><span class="delimiter">)</span>
  extends <a href="#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[OfflinePartitionLeaderSelector]: &quot;)" class="string">&quot;[OfflinePartitionLeaderSelector]: &quot;</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition)Option[Seq[Int]]">get</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="Seq[Int]" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.assignedReplicas">assignedReplicas</a><span class="delimiter">)</span> =&gt;
        val <a title="Seq[Int]" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas">liveAssignedReplicas</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.assignedReplicas" title="Seq[Int]">assignedReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
        val <a title="List[Int]" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr">liveBrokersInIsr</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(p: Int =&gt; Boolean)List[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
        val <a title="Int" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderEpoch">currentLeaderEpoch</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a>
        val <a title="Int" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion">currentLeaderIsrZkPathVersion</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a>
        val <a title="kafka.api.LeaderAndIsr" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr">newLeaderAndIsr</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr" title="List[Int]">liveBrokersInIsr</a>.<span title="=&gt; Boolean">isEmpty</span> match <span class="delimiter">{</span>
          case true =&gt;
            <span class="comment">// Prior to electing an unclean (i.e. non-ISR) leader, ensure that doing so is not disallowed by the configuration</span>
            <span class="comment">// for unclean leader election.</span>
            if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="../log/LogConfig.scala.html#kafka.log.LogConfig" title="kafka.log.LogConfig.type">LogConfig</a>.<a href="../log/LogConfig.scala.html#kafka.log.LogConfig.fromProps(9d0df464c6)" title="(defaults: java.util.Properties, overrides: java.util.Properties)kafka.log.LogConfig">fromProps</a><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.config" title="kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.props" title="=&gt; kafka.utils.VerifiableProperties">props</a>.<a href="../utils/VerifiableProperties.scala.html#kafka.utils;VerifiableProperties.props" title="=&gt; java.util.Properties">props</a>, <a href="../admin/AdminUtils.scala.html#kafka.admin.AdminUtils" title="kafka.admin.AdminUtils.type">AdminUtils</a>.<a href="../admin/AdminUtils.scala.html#kafka.admin.AdminUtils.fetchTopicConfig" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String)java.util.Properties">fetchTopicConfig</a><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>,
              <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a><span class="delimiter">)</span><span class="delimiter">)</span>.<a href="../log/LogConfig.scala.html#kafka.log;LogConfig.uncleanLeaderElectionEnable" title="=&gt; Boolean">uncleanLeaderElectionEnable</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              throw new <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a><span class="delimiter">(</span><span class="delimiter">(</span><span title="String(&quot;No broker in ISR for partition &quot;)" class="string">&quot;No broker in ISR for partition &quot;</span> <span title="(x$1: Any)String">+</span>
                <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s is alive. Live brokers are: [%s],&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; ISR brokers are: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>

            <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;No broker in ISR is alive for %s. Pick the leader from the alive assigned replicas: %s&quot;</span>
              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="=&gt; Boolean">isEmpty</span> match <span class="delimiter">{</span>
              case true =&gt;
                throw new <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a><span class="delimiter">(</span><span class="delimiter">(</span><span title="String(&quot;No replica for partition &quot;)" class="string">&quot;No replica for partition &quot;</span> <span title="(x$1: Any)String">+</span>
                  <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s is alive. Live brokers are: [%s],&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a><span class="delimiter">)</span><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
                  <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; Assigned replicas are: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.assignedReplicas" title="Seq[Int]">assignedReplicas</a><span class="delimiter">)</span><span class="delimiter">)</span>
              case false =&gt;
                <a href="KafkaController.scala.html#kafka.controller.ControllerStats" title="kafka.controller.ControllerStats.type">ControllerStats</a>.<a href="KafkaController.scala.html#kafka.controller.ControllerStats.uncleanLeaderElectionRate" title="=&gt; com.yammer.metrics.core.Meter">uncleanLeaderElectionRate</a>.<span title="()Unit">mark</span><span class="delimiter">(</span><span class="delimiter">)</span>
                val <span title="Int">newLeader</span> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="=&gt; Int">head</span>
                <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;No broker in ISR is alive for %s. Elect leader %d from live brokers %s. There's potential data loss.&quot;</span>
                     .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="Int">newLeader</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
                new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><span title="Int">newLeader</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderEpoch" title="Int">currentLeaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><span title="Int">newLeader</span><span class="delimiter">)</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion" title="Int">currentLeaderIsrZkPathVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          case false =&gt;
            val <a title="Seq[Int]" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr.liveReplicasInIsr">liveReplicasInIsr</a> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr.liveReplicasInIsr.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr" title="List[Int]">liveBrokersInIsr</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr.liveReplicasInIsr.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
            val <span title="Int">newLeader</span> = <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr.liveReplicasInIsr" title="Seq[Int]">liveReplicasInIsr</a>.<span title="=&gt; Int">head</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Some broker in ISR is alive for %s. Select %d from ISR %s to be the leader.&quot;</span>
                  .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="Int">newLeader</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr" title="List[Int]">liveBrokersInIsr</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><span title="Int">newLeader</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderEpoch" title="Int">currentLeaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveBrokersInIsr" title="List[Int]">liveBrokersInIsr</a>.<span title="=&gt; List[Int]">toList</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion" title="Int">currentLeaderIsrZkPathVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Selected new leader and ISR %s for offline partition %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.toString" title="()String">toString</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="(_1: kafka.api.LeaderAndIsr, _2: Seq[Int])(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.newLeaderAndIsr" title="kafka.api.LeaderAndIsr">newLeaderAndIsr</a>, <a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a><span class="delimiter">)</span>
      case <span title="None.type">None</span> =&gt;
        throw new <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s doesn't have replicas assigned to it&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;OfflinePartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * New leader = a live in-sync reassigned replica
 * New isr = current isr
 * Replicas to receive LeaderAndIsr request = reassigned replicas
 */</span>
class <a title="class ReassignedPartitionLeaderSelector extends AnyRef with kafka.controller.PartitionLeaderSelector with kafka.utils.Logging" id="kafka.controller;ReassignedPartitionLeaderSelector">ReassignedPartitionLeaderSelector</a><a href="#kafka.controller;ReassignedPartitionLeaderSelector" title="kafka.controller.ReassignedPartitionLeaderSelector" class="delimiter">(</a><a title="kafka.controller.ControllerContext" id="kafka.controller;ReassignedPartitionLeaderSelector.controllerContext">controllerContext</a>: <a href="KafkaController.scala.html#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[ReassignedPartitionLeaderSelector]: &quot;)" class="string">&quot;[ReassignedPartitionLeaderSelector]: &quot;</span>

  <span class="comment">/**
   * The reassigned replicas are already in the ISR when selectLeader is called.
   */</span>
  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.reassignedInSyncReplicas">reassignedInSyncReplicas</a> = <a href="#kafka.controller;ReassignedPartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionsBeingReassigned" title="(key: kafka.common.TopicAndPartition)kafka.controller.ReassignedPartitionsContext">partitionsBeingReassigned</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="KafkaController.scala.html#kafka.controller;ReassignedPartitionsContext.newReplicas" title="=&gt; Seq[Int]">newReplicas</a>
    val <a title="Int" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderEpoch">currentLeaderEpoch</a> = <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a>
    val <a title="Int" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion">currentLeaderIsrZkPathVersion</a> = <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a>
    val <a title="Seq[Int]" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.aliveReassignedInSyncReplicas">aliveReassignedInSyncReplicas</a> = <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.reassignedInSyncReplicas" title="Seq[Int]">reassignedInSyncReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.aliveReassignedInSyncReplicas.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ReassignedPartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.aliveReassignedInSyncReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span>
                                                                             <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.aliveReassignedInSyncReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="Option[Int]" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.newLeaderOpt">newLeaderOpt</a> = <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.aliveReassignedInSyncReplicas" title="Seq[Int]">aliveReassignedInSyncReplicas</a>.<span title="=&gt; Option[Int]">headOption</span>
    <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.newLeaderOpt" title="Option[Int]">newLeaderOpt</a> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="Int" id="kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.newLeader">newLeader</a><span class="delimiter">)</span> =&gt; <span title="(_1: kafka.api.LeaderAndIsr, _2: Seq[Int])(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.newLeader" title="Int">newLeader</a>, <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderEpoch" title="Int">currentLeaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>,
        <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion" title="Int">currentLeaderIsrZkPathVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.reassignedInSyncReplicas" title="Seq[Int]">reassignedInSyncReplicas</a><span class="delimiter">)</span>
      case <span title="None.type">None</span> =&gt;
        <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.reassignedInSyncReplicas" title="Seq[Int]">reassignedInSyncReplicas</a>.<span title="=&gt; Int">size</span> match <span class="delimiter">{</span>
          case <span title="Int(0)" class="int">0</span> =&gt;
            throw new <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a><span class="delimiter">(</span><span title="String(&quot;List of reassigned replicas for partition &quot;)" class="string">&quot;List of reassigned replicas for partition &quot;</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot; %s is empty. Current leader and ISR: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a><span class="delimiter">)</span><span class="delimiter">)</span>
          case _ =&gt;
            throw new <a href="../common/NoReplicaOnlineException.scala.html#kafka.common;NoReplicaOnlineException" title="kafka.common.NoReplicaOnlineException">NoReplicaOnlineException</a><span class="delimiter">(</span><span title="String(&quot;None of the reassigned replicas for partition &quot;)" class="string">&quot;None of the reassigned replicas for partition &quot;</span> <span title="(x$1: Any)String">+</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s are in-sync with the leader. Current leader and ISR: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReassignedPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * New leader = preferred (first assigned) replica (if in isr and alive);
 * New isr = current isr;
 * Replicas to receive LeaderAndIsr request = assigned replicas
 */</span>
class <a title="class PreferredReplicaPartitionLeaderSelector extends AnyRef with kafka.controller.PartitionLeaderSelector with kafka.utils.Logging" id="kafka.controller;PreferredReplicaPartitionLeaderSelector">PreferredReplicaPartitionLeaderSelector</a><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector" title="kafka.controller.PreferredReplicaPartitionLeaderSelector" class="delimiter">(</a><a title="kafka.controller.ControllerContext" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.controllerContext">controllerContext</a>: <a href="KafkaController.scala.html#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a>
with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[PreferredReplicaPartitionLeaderSelector]: &quot;)" class="string">&quot;[PreferredReplicaPartitionLeaderSelector]: &quot;</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    val <a title="Seq[Int]" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.assignedReplicas">assignedReplicas</a> = <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
    val <a title="Int" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica">preferredReplica</a> = <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.assignedReplicas" title="Seq[Int]">assignedReplicas</a>.<span title="=&gt; Int">head</span>
    <span class="comment">// check if preferred replica is the current leader</span>
    val <a title="Int" id="kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeader">currentLeader</a> = <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="(key: kafka.common.TopicAndPartition)kafka.controller.LeaderIsrAndControllerEpoch">partitionLeadershipInfo</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
    if <span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeader" title="Int">currentLeader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      throw new <a href="../common/LeaderElectionNotNeededException.scala.html#kafka.common;LeaderElectionNotNeededException" title="kafka.common.LeaderElectionNotNeededException">LeaderElectionNotNeededException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Preferred replica %d is already the current leader for partition %s&quot;</span>
                                                   .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span> else <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Current leader %d for partition %s is not the preferred replica.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeader" title="Int">currentLeader</a>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
        <span title="String(&quot; Trigerring preferred replica leader election&quot;)" class="string">&quot; Trigerring preferred replica leader election&quot;</span><span class="delimiter">)</span>
      <span class="comment">// check if preferred replica is not the current leader and is alive and in the isr</span>
      if <span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <span title="(_1: kafka.api.LeaderAndIsr, _2: Seq[Int])(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>new <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>,
          <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.assignedReplicas" title="Seq[Int]">assignedReplicas</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Preferred replica %d for partition &quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.preferredReplica" title="Int">preferredReplica</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
          <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%s is either not alive or not in the isr. Current leader and ISR: [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;PreferredReplicaPartitionLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * New leader = replica in isr that's not being shutdown;
 * New isr = current isr - shutdown replica;
 * Replicas to receive LeaderAndIsr request = live assigned replicas
 */</span>
class <a title="class ControlledShutdownLeaderSelector extends AnyRef with kafka.controller.PartitionLeaderSelector with kafka.utils.Logging" id="kafka.controller;ControlledShutdownLeaderSelector">ControlledShutdownLeaderSelector</a><a href="#kafka.controller;ControlledShutdownLeaderSelector" title="kafka.controller.ControlledShutdownLeaderSelector" class="delimiter">(</a><a title="kafka.controller.ControllerContext" id="kafka.controller;ControlledShutdownLeaderSelector.controllerContext">controllerContext</a>: <a href="KafkaController.scala.html#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a><span class="delimiter">)</span>
        extends <a href="#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a>
        with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>

  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[ControlledShutdownLeaderSelector]: &quot;)" class="string">&quot;[ControlledShutdownLeaderSelector]: &quot;</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    val <a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderEpoch">currentLeaderEpoch</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a>
    val <a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion">currentLeaderIsrZkPathVersion</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.zkVersion" title="=&gt; Int">zkVersion</a>

    val <a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeader">currentLeader</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>

    val <a title="Seq[Int]" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.assignedReplicas">assignedReplicas</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
    val <a title="scala.collection.Set[Int]" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveOrShuttingDownBrokerIds">liveOrShuttingDownBrokerIds</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>
    val <a title="Seq[Int]" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveAssignedReplicas">liveAssignedReplicas</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.assignedReplicas" title="Seq[Int]">assignedReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveAssignedReplicas.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveOrShuttingDownBrokerIds" title="scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveAssignedReplicas.$anonfun.r" title="Int">r</a><span class="delimiter">)</span><span class="delimiter">)</span>

    val <a title="List[Int]" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newIsr">newIsr</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(p: Int =&gt; Boolean)List[Int]">filter</span><span class="delimiter">(</span><a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newIsr.$anonfun.brokerId">brokerId</a> =&gt; <span title="=&gt; Boolean">!</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.shuttingDownBrokerIds" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newIsr.$anonfun.brokerId" title="Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="Option[Int]" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newLeaderOpt">newLeaderOpt</a> = <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newIsr" title="List[Int]">newIsr</a>.<span title="=&gt; Option[Int]">headOption</span>
    <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newLeaderOpt" title="Option[Int]">newLeaderOpt</a> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="Int" id="kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newLeader">newLeader</a><span class="delimiter">)</span> =&gt;
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition %s : current leader = %d, new leader = %d&quot;</span>
              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeader" title="Int">currentLeader</a>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newLeader" title="Int">newLeader</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="(_1: kafka.api.LeaderAndIsr, _2: Seq[Int])(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span><a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="(leader: Int, leaderEpoch: Int, isr: List[Int], zkVersion: Int)kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newLeader" title="Int">newLeader</a>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderEpoch" title="Int">currentLeaderEpoch</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.newIsr" title="List[Int]">newIsr</a>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderIsrZkPathVersion" title="Int">currentLeaderIsrZkPathVersion</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>,
         <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.liveAssignedReplicas" title="Seq[Int]">liveAssignedReplicas</a><span class="delimiter">)</span>
      case <span title="None.type">None</span> =&gt;
        throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;No other replicas in ISR %s for %s besides&quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot; shutting down brokers %s&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.isr" title="=&gt; List[Int]">isr</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ControlledShutdownLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.shuttingDownBrokerIds" title="=&gt; scala.collection.mutable.Set[Int]">shuttingDownBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * Essentially does nothing. Returns the current leader and ISR, and the current
 * set of replicas assigned to a given topic/partition.
 */</span>
class <a title="class NoOpLeaderSelector extends AnyRef with kafka.controller.PartitionLeaderSelector with kafka.utils.Logging" id="kafka.controller;NoOpLeaderSelector">NoOpLeaderSelector</a><a href="#kafka.controller;NoOpLeaderSelector" title="kafka.controller.NoOpLeaderSelector" class="delimiter">(</a><a title="kafka.controller.ControllerContext" id="kafka.controller;NoOpLeaderSelector.controllerContext">controllerContext</a>: <a href="KafkaController.scala.html#kafka.controller;ControllerContext" title="kafka.controller.ControllerContext">ControllerContext</a><span class="delimiter">)</span> extends <a href="#kafka.controller;PartitionLeaderSelector" title="kafka.controller.PartitionLeaderSelector">PartitionLeaderSelector</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>

  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[NoOpLeaderSelector]: &quot;)" class="string">&quot;[NoOpLeaderSelector]: &quot;</span>

  def <a title="(topicAndPartition: kafka.common.TopicAndPartition, currentLeaderAndIsr: kafka.api.LeaderAndIsr)(kafka.api.LeaderAndIsr, Seq[Int])" id="kafka.controller;NoOpLeaderSelector.selectLeader">selectLeader</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;NoOpLeaderSelector.selectLeader.topicAndPartition">topicAndPartition</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a>, <a title="kafka.api.LeaderAndIsr" id="kafka.controller;NoOpLeaderSelector.selectLeader.currentLeaderAndIsr">currentLeaderAndIsr</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr" title="kafka.api.LeaderAndIsr">LeaderAndIsr</a><span class="delimiter">)</span>: <span title="(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span>LeaderAndIsr, Seq<span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="String(&quot;I should never have been asked to perform leader election, returning the current LeaderAndIsr and replica assignment.&quot;)" class="string">&quot;I should never have been asked to perform leader election, returning the current LeaderAndIsr and replica assignment.&quot;</span><span class="delimiter">)</span>
    <span title="(_1: kafka.api.LeaderAndIsr, _2: Seq[Int])(kafka.api.LeaderAndIsr, Seq[Int])" class="delimiter">(</span><a href="#kafka.controller;NoOpLeaderSelector.selectLeader.currentLeaderAndIsr" title="kafka.api.LeaderAndIsr">currentLeaderAndIsr</a>, <a href="#kafka.controller;NoOpLeaderSelector.controllerContext" title="kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;NoOpLeaderSelector.selectLeader.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
