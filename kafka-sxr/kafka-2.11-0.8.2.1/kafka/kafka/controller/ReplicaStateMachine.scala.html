<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/controller/ReplicaStateMachine.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
*/</span>
package kafka.controller

import collection._
import collection.<span title="scala.collection.JavaConversions.type">JavaConversions</span>._
import java.util.concurrent.atomic.AtomicBoolean
import kafka.common.<span class="delimiter">{</span>TopicAndPartition, StateChangeFailedException<span class="delimiter">}</span>
import kafka.utils.<span class="delimiter">{</span>ZkUtils, ReplicationUtils, Logging<span class="delimiter">}</span>
import org.I0Itec.zkclient.IZkChildListener
import org.apache.log4j.Logger
import kafka.controller.<a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks" title="kafka.controller.Callbacks.type">Callbacks</a>._
import kafka.utils.<a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>._

<span class="comment">/**
 * This class represents the state machine for replicas. It defines the states that a replica can be in, and
 * transitions to move the replica to another legal state. The different states that a replica can be in are -
 * 1. NewReplica        : The controller can create new replicas during partition reassignment. In this state, a
 *                        replica can only get become follower state change request.  Valid previous
 *                        state is NonExistentReplica
 * 2. OnlineReplica     : Once a replica is started and part of the assigned replicas for its partition, it is in this
 *                        state. In this state, it can get either become leader or become follower state change requests.
 *                        Valid previous state are NewReplica, OnlineReplica or OfflineReplica
 * 3. OfflineReplica    : If a replica dies, it moves to this state. This happens when the broker hosting the replica
 *                        is down. Valid previous state are NewReplica, OnlineReplica
 * 4. ReplicaDeletionStarted: If replica deletion starts, it is moved to this state. Valid previous state is OfflineReplica
 * 5. ReplicaDeletionSuccessful: If replica responds with no error code in response to a delete replica request, it is
 *                        moved to this state. Valid previous state is ReplicaDeletionStarted
 * 6. ReplicaDeletionIneligible: If replica deletion fails, it is moved to this state. Valid previous state is ReplicaDeletionStarted
 * 7. NonExistentReplica: If a replica is deleted successfully, it is moved to this state. Valid previous state is
 *                        ReplicaDeletionSuccessful
 */</span>
class <a title="class ReplicaStateMachine extends AnyRef with kafka.utils.Logging" id="kafka.controller;ReplicaStateMachine">ReplicaStateMachine</a><a href="#kafka.controller;ReplicaStateMachine" title="kafka.controller.ReplicaStateMachine" class="delimiter">(</a><a title="kafka.controller.KafkaController" id="kafka.controller;ReplicaStateMachine.controller">controller</a>: <a href="KafkaController.scala.html#kafka.controller;KafkaController" title="kafka.controller.KafkaController">KafkaController</a><span class="delimiter">)</span> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
  private val <a title="kafka.controller.ControllerContext" id="kafka.controller;ReplicaStateMachine.controllerContext">controllerContext</a> = <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>
  private val <a title="Int" id="kafka.controller;ReplicaStateMachine.controllerId">controllerId</a> = <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>
  private val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.controller;ReplicaStateMachine.zkClient">zkClient</a> = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>
  private val <a title="scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]" id="kafka.controller;ReplicaStateMachine.replicaState">replicaState</a>: mutable.<span title="scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">Map</span><span class="delimiter">[</span>PartitionAndReplica, ReplicaState<span class="delimiter">]</span> = mutable.<span title="scala.collection.mutable.Map.type">Map</span>.<span title="scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">empty</span>
  private val <a title="ReplicaStateMachine.this.BrokerChangeListener" id="kafka.controller;ReplicaStateMachine.brokerChangeListener">brokerChangeListener</a> = new <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener" title="ReplicaStateMachine.this.BrokerChangeListener">BrokerChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
  private val <a title="kafka.controller.ControllerBrokerRequestBatch" id="kafka.controller;ReplicaStateMachine.brokerRequestBatch">brokerRequestBatch</a> = new <a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch" title="kafka.controller.ControllerBrokerRequestBatch">ControllerBrokerRequestBatch</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a><span class="delimiter">)</span>
  private val <a title="java.util.concurrent.atomic.AtomicBoolean" id="kafka.controller;ReplicaStateMachine.hasStarted">hasStarted</a> = new <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
  private val <a title="kafka.controller.KafkaController.StateChangeLogger" id="kafka.controller;ReplicaStateMachine.stateChangeLogger">stateChangeLogger</a> = <a href="KafkaController.scala.html#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="KafkaController.scala.html#kafka.controller.KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>

  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[Replica state machine on controller &quot;)" class="string">&quot;[Replica state machine on controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>


  <span class="comment">/**
   * Invoked on successful controller election. First registers a broker change listener since that triggers all
   * state transitions for replicas. Initializes the state of replicas for all partitions by reading from zookeeper.
   * Then triggers the OnlineReplica state change for all replicas.
   */</span>
  def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.startup">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// initialize replica state</span>
    <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState" title="()Unit">initializeReplicaState</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// set started flag</span>
    <a href="#kafka.controller;ReplicaStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="(x$1: Boolean)Unit">set</span><span class="delimiter">(</span>true<span class="delimiter">)</span>
    <span class="comment">// move all Online replicas to Online</span>
    <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges" title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChanges</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.allLiveReplicas" title="()scala.collection.Set[kafka.controller.PartitionAndReplica]">allLiveReplicas</a><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>

    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Started replica state machine with initial state -&gt; &quot;)" class="string">&quot;Started replica state machine with initial state -&gt; &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="()String">toString</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// register ZK listeners of the replica state machine</span>
  def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.registerListeners">registerListeners</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// register broker change listener</span>
    <a href="#kafka.controller;ReplicaStateMachine.registerBrokerChangeListener" title="()java.util.List[String]">registerBrokerChangeListener</a><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">// de-register ZK listeners of the replica state machine</span>
  def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.deregisterListeners">deregisterListeners</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// de-register broker change listener</span>
    <a href="#kafka.controller;ReplicaStateMachine.deregisterBrokerChangeListener" title="()Unit">deregisterBrokerChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on controller shutdown.
   */</span>
  def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.shutdown">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// reset started flag</span>
    <a href="#kafka.controller;ReplicaStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="(x$1: Boolean)Unit">set</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
    <span class="comment">// reset replica state</span>
    <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="comment">// de-register all ZK listeners</span>
    <a href="#kafka.controller;ReplicaStateMachine.deregisterListeners" title="()Unit">deregisterListeners</a><span class="delimiter">(</span><span class="delimiter">)</span>

    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Stopped replica state machine&quot;)" class="string">&quot;Stopped replica state machine&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This API is invoked by the broker change controller callbacks and the startup API of the state machine
   * @param replicas     The list of replicas (brokers) that need to be transitioned to the target state
   * @param targetState  The state that the replicas should be moved to
   * The controller's allLeaders cache should have been updated before this
   */</span>
  def <a title="(replicas: scala.collection.Set[kafka.controller.PartitionAndReplica], targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit" id="kafka.controller;ReplicaStateMachine.handleStateChanges">handleStateChanges</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ReplicaStateMachine.handleStateChanges.replicas">replicas</a>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span>, <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.handleStateChanges.targetState">targetState</a>: <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a>,
                         <a title="kafka.controller.Callbacks" id="kafka.controller;ReplicaStateMachine.handleStateChanges$default$3">callbacks</a>: <a href="ControllerChannelManager.scala.html#kafka.controller;Callbacks" title="kafka.controller.Callbacks">Callbacks</a> = <span class="delimiter">(</span>new <a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder" title="kafka.controller.Callbacks.CallbackBuilder">CallbackBuilder</a><span class="delimiter">)</span>.<a href="ControllerChannelManager.scala.html#kafka.controller.Callbacks;CallbackBuilder.build" title="=&gt; kafka.controller.Callbacks">build</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    if<span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.replicas" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicas</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Invoking state change to %s for replicas %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.targetState" title="kafka.controller.ReplicaState">targetState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.replicas" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      try <span class="delimiter">{</span>
        <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.newBatch" title="()Unit">newBatch</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.replicas" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicas</a>.<span title="(f: kafka.controller.PartitionAndReplica =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.handleStateChanges.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ReplicaStateMachine.handleStateChange" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit">handleStateChange</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.$anonfun.r" title="kafka.controller.PartitionAndReplica">r</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.targetState" title="kafka.controller.ReplicaState">targetState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges$default$3" title="kafka.controller.Callbacks">callbacks</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.sendRequestsToBrokers" title="(controllerEpoch: Int, correlationId: Int)Unit">sendRequestsToBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.correlationId" title="=&gt; java.util.concurrent.atomic.AtomicInteger">correlationId</a>.<span title="()Int">getAndIncrement</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>catch <span class="delimiter">{</span>
        case <a title="Throwable" id="kafka.controller;ReplicaStateMachine.handleStateChanges.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error while moving some replicas to %s state&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChanges.e" title="Throwable">e</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This API exercises the replica's state machine. It ensures that every state transition happens from a legal
   * previous state to the target state. Valid state transitions are:
   * NonExistentReplica --&gt; NewReplica
   * --send LeaderAndIsr request with current leader and isr to the new replica and UpdateMetadata request for the
   *   partition to every live broker
   *
   * NewReplica -&gt; OnlineReplica
   * --add the new replica to the assigned replica list if needed
   *
   * OnlineReplica,OfflineReplica -&gt; OnlineReplica
   * --send LeaderAndIsr request with current leader and isr to the new replica and UpdateMetadata request for the
   *   partition to every live broker
   *
   * NewReplica,OnlineReplica,OfflineReplica,ReplicaDeletionIneligible -&gt; OfflineReplica
   * --send StopReplicaRequest to the replica (w/o deletion)
   * --remove this replica from the isr and send LeaderAndIsr request (with new isr) to the leader replica and
   *   UpdateMetadata request for the partition to every live broker.
   *
   * OfflineReplica -&gt; ReplicaDeletionStarted
   * --send StopReplicaRequest to the replica (with deletion)
   *
   * ReplicaDeletionStarted -&gt; ReplicaDeletionSuccessful
   * -- mark the state of the replica in the state machine
   *
   * ReplicaDeletionStarted -&gt; ReplicaDeletionIneligible
   * -- mark the state of the replica in the state machine
   *
   * ReplicaDeletionSuccessful -&gt; NonExistentReplica
   * -- remove the replica from the in memory partition replica assignment cache


   * @param partitionAndReplica The replica for which the state transition is invoked
   * @param targetState The end state that the replica should be moved to
   */</span>
  def <a title="(partitionAndReplica: kafka.controller.PartitionAndReplica, targetState: kafka.controller.ReplicaState, callbacks: kafka.controller.Callbacks)Unit" id="kafka.controller;ReplicaStateMachine.handleStateChange">handleStateChange</a><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica">partitionAndReplica</a>: <a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a>, <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.handleStateChange.targetState">targetState</a>: <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a>,
                        <a title="kafka.controller.Callbacks" id="kafka.controller;ReplicaStateMachine.handleStateChange.callbacks">callbacks</a>: <a href="ControllerChannelManager.scala.html#kafka.controller;Callbacks" title="kafka.controller.Callbacks">Callbacks</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="String" id="kafka.controller;ReplicaStateMachine.handleStateChange.topic">topic</a> = <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a>
    val <a title="Int" id="kafka.controller;ReplicaStateMachine.handleStateChange.partition">partition</a> = <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.partition" title="=&gt; Int">partition</a>
    val <a title="Int" id="kafka.controller;ReplicaStateMachine.handleStateChange.replicaId">replicaId</a> = <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.replica" title="=&gt; Int">replica</a>
    val <a title="kafka.common.TopicAndPartition" id="kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a><span class="delimiter">)</span>
    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;ReplicaStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="()Boolean">get</span><span class="delimiter">)</span>
      throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Controller %d epoch %d initiated state change of replica %d for partition %s &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                                            <span class="string">&quot;to %s failed because replica state machine has not started&quot;</span><span class="delimiter">)</span>
                                              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.handleStateChange.currState">currState</a> = <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, op: =&gt; kafka.controller.ReplicaState)kafka.controller.ReplicaState">getOrElseUpdate</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.NonExistentReplica.readResolve" title="kafka.controller.NonExistentReplica.type">NonExistentReplica</a><span class="delimiter">)</span>
    try <span class="delimiter">{</span>
      val <a title="Seq[Int]" id="kafka.controller;ReplicaStateMachine.handleStateChange.replicaAssignment">replicaAssignment</a> = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
      <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a> match <span class="delimiter">{</span>
        case <a href="#kafka.controller.NewReplica.readResolve" title="kafka.controller.NewReplica.type">NewReplica</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <span title="(xs: kafka.controller.NonExistentReplica.type*)List[kafka.controller.NonExistentReplica.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NonExistentReplica.readResolve" title="kafka.controller.NonExistentReplica.type">NonExistentReplica</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <span class="comment">// start replica as a follower to the current leader for its partition</span>
          val <a title="Option[kafka.controller.LeaderIsrAndControllerEpoch]" id="kafka.controller;ReplicaStateMachine.handleStateChange.leaderIsrAndControllerEpochOpt">leaderIsrAndControllerEpochOpt</a> = <a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils" title="kafka.utils.ReplicationUtils.type">ReplicationUtils</a>.<a href="../utils/ReplicationUtils.scala.html#kafka.utils.ReplicationUtils.getLeaderIsrAndEpochForPartition" title="(zkClient: org.I0Itec.zkclient.ZkClient, topic: String, partition: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">getLeaderIsrAndEpochForPartition</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.leaderIsrAndControllerEpochOpt" title="Option[kafka.controller.LeaderIsrAndControllerEpoch]">leaderIsrAndControllerEpochOpt</a> match <span class="delimiter">{</span>
            case Some<span class="delimiter">(</span><span title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</span><span class="delimiter">)</span> =&gt;
              if<span class="delimiter">(</span><span title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</span>.<a href="KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>
                throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Replica %d for partition %s cannot be moved to NewReplica&quot;</span>
                  .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;state as it is being requested to become leader&quot;)" class="string">&quot;state as it is being requested to become leader&quot;</span><span class="delimiter">)</span>
              <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>,
                                                                  <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, <span title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</span>,
                                                                  <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaAssignment" title="Seq[Int]">replicaAssignment</a><span class="delimiter">)</span>
            case <span title="None.type">None</span> =&gt; <span class="comment">// new leader request will be sent to this replica when one gets elected</span>
          <span class="delimiter">}</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.NewReplica.readResolve" title="kafka.controller.NewReplica.type">NewReplica</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
                                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>,
                                            <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <span title="(xs: kafka.controller.OfflineReplica.type*)List[kafka.controller.OfflineReplica.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.OfflineReplica.readResolve" title="kafka.controller.OfflineReplica.type">OfflineReplica</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a><span class="delimiter">)</span>
          <span class="comment">// send stop replica command</span>
          <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addStopReplicaRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, deletePartition: Boolean, callback: (kafka.api.RequestOrResponse, Int) =&gt; Unit)Unit">addStopReplicaRequestForBrokers</a><span class="delimiter">(</span><span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, deletePartition = true,
            <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.callbacks" title="kafka.controller.Callbacks">callbacks</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;Callbacks.stopReplicaResponseCallback" title="=&gt; (kafka.api.RequestOrResponse, Int) =&gt; Unit">stopReplicaResponseCallback</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <span title="(xs: kafka.controller.ReplicaDeletionStarted.type*)List[kafka.controller.ReplicaDeletionStarted.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a href="#kafka.controller.ReplicaDeletionSuccessful.readResolve" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <span title="(xs: kafka.controller.ReplicaDeletionStarted.type*)List[kafka.controller.ReplicaDeletionStarted.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.ReplicaDeletionSuccessful.readResolve" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a href="#kafka.controller.NonExistentReplica.readResolve" title="kafka.controller.NonExistentReplica.type">NonExistentReplica</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <span title="(xs: kafka.controller.ReplicaDeletionSuccessful.type*)List[kafka.controller.ReplicaDeletionSuccessful.type]">List</span><span class="delimiter">(</span><a href="#kafka.controller.ReplicaDeletionSuccessful.readResolve" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <span class="comment">// remove this replica from the assigned replicas list for its partition</span>
          val <span title="Seq[Int]">currentAssignedReplicas</span> = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition, value: Seq[Int])Option[Seq[Int]]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="Seq[Int]">currentAssignedReplicas</span>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filterNot</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.$anonfun.x$1" title="Int">_</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica)Option[kafka.controller.ReplicaState]">remove</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>,
            <span title="(xs: Product with Serializable with kafka.controller.ReplicaState*)List[Product with Serializable with kafka.controller.ReplicaState]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NewReplica.readResolve" title="kafka.controller.NewReplica.type">NewReplica</a>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a>, <a href="#kafka.controller.OfflineReplica.readResolve" title="kafka.controller.OfflineReplica.type">OfflineReplica</a>, <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="(key: kafka.controller.PartitionAndReplica)kafka.controller.ReplicaState">replicaState</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
            case <a href="#kafka.controller.NewReplica.readResolve" title="kafka.controller.NewReplica.type">NewReplica</a> =&gt;
              <span class="comment">// add this replica to the assigned replicas list for its partition</span>
              val <span title="Seq[Int]">currentAssignedReplicas</span> = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
              if<span class="delimiter">(</span><span title="=&gt; Boolean">!</span><span title="Seq[Int]">currentAssignedReplicas</span>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span><span class="delimiter">)</span>
                <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(key: kafka.common.TopicAndPartition, value: Seq[Int])Option[Seq[Int]]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <span title="Seq[Int]">currentAssignedReplicas</span> <span title="(elem: Int)(implicit bf: scala.collection.generic.CanBuildFrom[Seq[Int],Int,Seq[Int]])Seq[Int]">:+</span> <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>
              <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
                                        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>,
                                                <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
            case _ =&gt;
              <span class="comment">// check if the leader for this partition ever existed</span>
              <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.LeaderIsrAndControllerEpoch]">get</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
                case Some<span class="delimiter">(</span><span title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</span><span class="delimiter">)</span> =&gt;
                  <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, <span title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</span>,
                    <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaAssignment" title="Seq[Int]">replicaAssignment</a><span class="delimiter">)</span>
                  <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
                  <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
                    .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
                case <span title="None.type">None</span> =&gt; <span class="comment">// that means the partition was never in OnlinePartition state, this means the broker never</span>
                  <span class="comment">// started a log for that partition and does not have a high watermark value for this partition</span>
              <span class="delimiter">}</span>
          <span class="delimiter">}</span>
          <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span title="Unit" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
        case <a href="#kafka.controller.OfflineReplica.readResolve" title="kafka.controller.OfflineReplica.type">OfflineReplica</a> =&gt;
          <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates" title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit">assertValidPreviousStates</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>,
            <span title="(xs: Product with Serializable with kafka.controller.ReplicaState*)List[Product with Serializable with kafka.controller.ReplicaState]">List</span><span class="delimiter">(</span><a href="#kafka.controller.NewReplica.readResolve" title="kafka.controller.NewReplica.type">NewReplica</a>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a>, <a href="#kafka.controller.OfflineReplica.readResolve" title="kafka.controller.OfflineReplica.type">OfflineReplica</a>, <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>
          <span class="comment">// send stop replica command to the replica so that it stops fetching from the leader</span>
          <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addStopReplicaRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, deletePartition: Boolean, callback: (kafka.api.RequestOrResponse, Int) =&gt; Unit)Unit">addStopReplicaRequestForBrokers</a><span class="delimiter">(</span><span title="(xs: Int*)List[Int]">List</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, deletePartition = false<span class="delimiter">)</span>
          <span class="comment">// As an optimization, the controller removes dead replicas from the ISR</span>
          val <a title="Boolean" id="kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty">leaderAndIsrIsEmpty</a>: <span title="Boolean">Boolean</span> =
            <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionLeadershipInfo" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,kafka.controller.LeaderIsrAndControllerEpoch]">partitionLeadershipInfo</a>.<span title="(key: kafka.common.TopicAndPartition)Option[kafka.controller.LeaderIsrAndControllerEpoch]">get</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
              case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.currLeaderIsrAndControllerEpoch">currLeaderIsrAndControllerEpoch</a><span class="delimiter">)</span> =&gt;
                <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.removeReplicaFromIsr" title="(topic: String, partition: Int, replicaId: Int)Option[kafka.controller.LeaderIsrAndControllerEpoch]">removeReplicaFromIsr</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
                  case Some<span class="delimiter">(</span><a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.updatedLeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a><span class="delimiter">)</span> =&gt;
                    <span class="comment">// send the shrunk ISR state change request to all the remaining alive replicas of the partition.</span>
                    val <a title="Seq[Int]" id="kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.currentAssignedReplicas">currentAssignedReplicas</a> = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(key: kafka.common.TopicAndPartition)Seq[Int]">partitionReplicaAssignment</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
                    if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.deleteTopicManager" title="=&gt; kafka.controller.TopicDeletionManager">deleteTopicManager</a>.<a href="TopicDeletionManager.scala.html#kafka.controller;TopicDeletionManager.isPartitionToBeDeleted" title="(topicAndPartition: kafka.common.TopicAndPartition)Boolean">isPartitionToBeDeleted</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
                      <a href="#kafka.controller;ReplicaStateMachine.brokerRequestBatch" title="=&gt; kafka.controller.ControllerBrokerRequestBatch">brokerRequestBatch</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerBrokerRequestBatch.addLeaderAndIsrRequestForBrokers" title="(brokerIds: Seq[Int], topic: String, partition: Int, leaderIsrAndControllerEpoch: kafka.controller.LeaderIsrAndControllerEpoch, replicas: Seq[Int], callback: kafka.api.RequestOrResponse =&gt; Unit)Unit">addLeaderAndIsrRequestForBrokers</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.currentAssignedReplicas" title="Seq[Int]">currentAssignedReplicas</a>.<span title="(p: Int =&gt; Boolean)Seq[Int]">filterNot</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.$anonfun.x$2" title="Int">_</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>,
                        <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty.updatedLeaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">updatedLeaderIsrAndControllerEpoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaAssignment" title="Seq[Int]">replicaAssignment</a><span class="delimiter">)</span>
                    <span class="delimiter">}</span>
                    <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.OfflineReplica.readResolve" title="kafka.controller.OfflineReplica.type">OfflineReplica</a><span class="delimiter">)</span>
                    <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d changed state of replica %d for partition %s from %s to %s&quot;</span>
                      .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span><span class="delimiter">)</span>
                    false
                  case <span title="None.type">None</span> =&gt;
                    true
                <span class="delimiter">}</span>
              case <span title="None.type">None</span> =&gt;
                true
            <span class="delimiter">}</span>
          if <span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.leaderAndIsrIsEmpty" title="Boolean">leaderAndIsrIsEmpty</a><span class="delimiter">)</span>
            throw new <a href="../common/StateChangeFailedException.scala.html#kafka.common;StateChangeFailedException" title="kafka.common.StateChangeFailedException">StateChangeFailedException</a><span class="delimiter">(</span>
              <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Failed to change state of replica %d for partition %s since the leader and isr path in zookeeper is empty&quot;</span>
              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.controller;ReplicaStateMachine.handleStateChange.t">t</a>: <span title="Throwable">Throwable</span> =&gt;
        <a href="#kafka.controller;ReplicaStateMachine.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Controller %d epoch %d initiated state change of replica %d for partition [%s,%d] from %s to %s failed&quot;</span>
                                  .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.epoch" title="=&gt; Int">epoch</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.replicaId" title="Int">replicaId</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.partition" title="Int">partition</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.currState" title="kafka.controller.ReplicaState">currState</a>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.handleStateChange.t" title="Throwable">t</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)Boolean" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted">areAllReplicasForTopicDeleted</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicasForTopic">replicasForTopic</a> = <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.replicasForTopic" title="(topic: String)scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopic</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.topic" title="String">topic</a><span class="delimiter">)</span>
    val <a title="scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic">replicaStatesForTopic</a> = <a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicasForTopic" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopic</a>.<span title="(f: kafka.controller.PartitionAndReplica =&gt; (kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.controller.PartitionAndReplica],(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]])scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]]" class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic.$anonfun.r">r</a> =&gt; <span title="(_1: kafka.controller.PartitionAndReplica, _2: kafka.controller.ReplicaState)(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic.$anonfun.r" title="kafka.controller.PartitionAndReplica">r</a>, <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="(key: kafka.controller.PartitionAndReplica)kafka.controller.ReplicaState">replicaState</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic.$anonfun.r" title="kafka.controller.PartitionAndReplica">r</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)])scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">toMap</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Are all replicas for topic %s deleted %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic" title="scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaStatesForTopic</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.replicaStatesForTopic" title="scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaStatesForTopic</a>.<span title="(z: Boolean)(op: (Boolean, (kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)) =&gt; Boolean)Boolean">foldLeft</span><span class="delimiter">(</span>true<span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Boolean" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.$anonfun.deletionState">deletionState</a>, <a title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" id="kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.$anonfun.r">r</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.$anonfun.deletionState" title="Boolean">deletionState</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;ReplicaStateMachine.areAllReplicasForTopicDeleted.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.ReplicaState">_2</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller.ReplicaDeletionSuccessful.readResolve" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)Boolean" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState">isAtLeastOneReplicaInDeletionStartedState</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    val <a title="scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicasForTopic">replicasForTopic</a> = <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.replicasForTopic" title="(topic: String)scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopic</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.topic" title="String">topic</a><span class="delimiter">)</span>
    val <a title="scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicaStatesForTopic">replicaStatesForTopic</a> = <a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicasForTopic" title="scala.collection.Set[kafka.controller.PartitionAndReplica]">replicasForTopic</a>.<span title="(f: kafka.controller.PartitionAndReplica =&gt; (kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.controller.PartitionAndReplica],(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]])scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),scala.collection.Set[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)]]" class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicaStatesForTopic.$anonfun.r">r</a> =&gt; <span title="(_1: kafka.controller.PartitionAndReplica, _2: kafka.controller.ReplicaState)(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicaStatesForTopic.$anonfun.r" title="kafka.controller.PartitionAndReplica">r</a>, <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="(key: kafka.controller.PartitionAndReplica)kafka.controller.ReplicaState">replicaState</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicaStatesForTopic.$anonfun.r" title="kafka.controller.PartitionAndReplica">r</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState),(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)])scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">toMap</span>
    <a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.replicaStatesForTopic" title="scala.collection.immutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaStatesForTopic</a>.<span title="(z: Boolean)(op: (Boolean, (kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)) =&gt; Boolean)Boolean">foldLeft</span><span class="delimiter">(</span>false<span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Boolean" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.$anonfun.deletionState">deletionState</a>, <a title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" id="kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.$anonfun.r">r</a><span class="delimiter">)</span> =&gt; <a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.$anonfun.deletionState" title="Boolean">deletionState</a> <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.controller;ReplicaStateMachine.isAtLeastOneReplicaInDeletionStartedState.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.ReplicaState">_2</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, state: kafka.controller.ReplicaState)scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ReplicaStateMachine.replicasInState">replicasInState</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine.replicasInState.topic">topic</a>: <span title="String">String</span>, <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.replicasInState.state">state</a>: <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(p: ((kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)) =&gt; Boolean)scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">filter</span><span class="delimiter">(</span><a title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" id="kafka.controller;ReplicaStateMachine.replicasInState.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ReplicaStateMachine.replicasInState.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.PartitionAndReplica">_1</span>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.replicasInState.topic" title="String">topic</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;ReplicaStateMachine.replicasInState.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.ReplicaState">_2</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;ReplicaStateMachine.replicasInState.state" title="kafka.controller.ReplicaState">state</a><span class="delimiter">)</span>.<span title="=&gt; scala.collection.Set[kafka.controller.PartitionAndReplica]">keySet</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, state: kafka.controller.ReplicaState)Boolean" id="kafka.controller;ReplicaStateMachine.isAnyReplicaInState">isAnyReplicaInState</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine.isAnyReplicaInState.topic">topic</a>: <span title="String">String</span>, <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.isAnyReplicaInState.state">state</a>: <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(p: ((kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)) =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" id="kafka.controller;ReplicaStateMachine.isAnyReplicaInState.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ReplicaStateMachine.isAnyReplicaInState.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.PartitionAndReplica">_1</span>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.isAnyReplicaInState.topic" title="String">topic</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;ReplicaStateMachine.isAnyReplicaInState.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.ReplicaState">_2</span> <span title="(x$1: Any)Boolean">==</span> <a href="#kafka.controller;ReplicaStateMachine.isAnyReplicaInState.state" title="kafka.controller.ReplicaState">state</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String)scala.collection.Set[kafka.controller.PartitionAndReplica]" id="kafka.controller;ReplicaStateMachine.replicasInDeletionStates">replicasInDeletionStates</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine.replicasInDeletionStates.topic">topic</a>: <span title="String">String</span><span class="delimiter">)</span>: <span title="scala.collection.Set[kafka.controller.PartitionAndReplica]">Set</span><span class="delimiter">[</span>PartitionAndReplica<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="scala.collection.Set[Product with Serializable with kafka.controller.ReplicaState]" id="kafka.controller;ReplicaStateMachine.replicasInDeletionStates.deletionStates">deletionStates</a> = <span title="(elems: Product with Serializable with kafka.controller.ReplicaState*)scala.collection.Set[Product with Serializable with kafka.controller.ReplicaState]">Set</span><span class="delimiter">(</span><a href="#kafka.controller.ReplicaDeletionStarted.readResolve" title="kafka.controller.ReplicaDeletionStarted.type">ReplicaDeletionStarted</a>, <a href="#kafka.controller.ReplicaDeletionSuccessful.readResolve" title="kafka.controller.ReplicaDeletionSuccessful.type">ReplicaDeletionSuccessful</a>, <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a><span class="delimiter">)</span>
    <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(p: ((kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)) =&gt; Boolean)scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">filter</span><span class="delimiter">(</span><a title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)" id="kafka.controller;ReplicaStateMachine.replicasInDeletionStates.$anonfun.r">r</a> =&gt; <a href="#kafka.controller;ReplicaStateMachine.replicasInDeletionStates.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.PartitionAndReplica">_1</span>.<a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica.topic" title="=&gt; String">topic</a>.<span title="(x$1: Any)Boolean">equals</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.replicasInDeletionStates.topic" title="String">topic</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.controller;ReplicaStateMachine.replicasInDeletionStates.deletionStates" title="(s: scala.collection.Set[Product with Serializable with kafka.controller.ReplicaState])java.util.Set[Product with Serializable with kafka.controller.ReplicaState]">deletionStates</a>.<span title="(x$1: Any)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.replicasInDeletionStates.$anonfun.r" title="(kafka.controller.PartitionAndReplica, kafka.controller.ReplicaState)">r</a>.<span title="=&gt; kafka.controller.ReplicaState">_2</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; scala.collection.Set[kafka.controller.PartitionAndReplica]">keySet</span>
  <span class="delimiter">}</span>

  private def <a title="(partitionAndReplica: kafka.controller.PartitionAndReplica, fromStates: Seq[kafka.controller.ReplicaState], targetState: kafka.controller.ReplicaState)Unit" id="kafka.controller;ReplicaStateMachine.assertValidPreviousStates">assertValidPreviousStates</a><span class="delimiter">(</span><a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.assertValidPreviousStates.partitionAndReplica">partitionAndReplica</a>: <a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica" title="kafka.controller.PartitionAndReplica">PartitionAndReplica</a>, <a title="Seq[kafka.controller.ReplicaState]" id="kafka.controller;ReplicaStateMachine.assertValidPreviousStates.fromStates">fromStates</a>: <span title="Seq[kafka.controller.ReplicaState]">Seq</span><span class="delimiter">[</span>ReplicaState<span class="delimiter">]</span>,
                                        <a title="kafka.controller.ReplicaState" id="kafka.controller;ReplicaStateMachine.assertValidPreviousStates.targetState">targetState</a>: <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(assertion: Boolean, message: =&gt; Any)Unit">assert</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.fromStates" title="Seq[kafka.controller.ReplicaState]">fromStates</a>.<span title="(elem: kafka.controller.ReplicaState)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.replicaState" title="(key: kafka.controller.PartitionAndReplica)kafka.controller.ReplicaState">replicaState</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a><span class="delimiter">)</span><span class="delimiter">)</span>,
      <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Replica %s should be in the %s states before moving to %s state&quot;</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.fromStates" title="Seq[kafka.controller.ReplicaState]">fromStates</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.targetState" title="kafka.controller.ReplicaState">targetState</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
        <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;. Instead it is in %s state&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.replicaState" title="(key: kafka.controller.PartitionAndReplica)kafka.controller.ReplicaState">replicaState</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.assertValidPreviousStates.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()java.util.List[String]" id="kafka.controller;ReplicaStateMachine.registerBrokerChangeListener">registerBrokerChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ReplicaStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)java.util.List[String]">subscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.BrokerIdsPath" title="=&gt; String">BrokerIdsPath</a>, <a href="#kafka.controller;ReplicaStateMachine.brokerChangeListener" title="=&gt; ReplicaStateMachine.this.BrokerChangeListener">brokerChangeListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.deregisterBrokerChangeListener">deregisterBrokerChangeListener</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ReplicaStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>.<span title="(x$1: String, x$2: org.I0Itec.zkclient.IZkChildListener)Unit">unsubscribeChildChanges</span><span class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.BrokerIdsPath" title="=&gt; String">BrokerIdsPath</a>, <a href="#kafka.controller;ReplicaStateMachine.brokerChangeListener" title="=&gt; ReplicaStateMachine.this.BrokerChangeListener">brokerChangeListener</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Invoked on startup of the replica's state machine to set the initial state for replicas of all existing partitions
   * in zookeeper
   */</span>
  private def <a title="()Unit" id="kafka.controller;ReplicaStateMachine.initializeReplicaState">initializeReplicaState</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    for<span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.topicPartition">topicPartition</a>, <a title="Seq[Int]" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.assignedReplicas">assignedReplicas</a><span class="delimiter">)</span> &lt;- <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="(f: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Unit)Unit">partitionReplicaAssignment</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="String" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.topic">topic</a> = <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>
      val <a title="Int" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.partition">partition</a> = <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.topicPartition" title="kafka.common.TopicAndPartition">topicPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>
      <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.assignedReplicas" title="Seq[Int]">assignedReplicas</a>.<span title="(f: Int =&gt; Option[kafka.controller.ReplicaState])Unit">foreach</span> <span class="delimiter">{</span> <a title="Int" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.replicaId">replicaId</a> =&gt;
        val <a title="kafka.controller.PartitionAndReplica" id="kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.partitionAndReplica">partitionAndReplica</a> = <a href="KafkaController.scala.html#kafka.controller;PartitionAndReplica" title="(topic: String, partition: Int, replica: Int)kafka.controller.PartitionAndReplica">PartitionAndReplica</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.topic" title="String">topic</a>, <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>
        <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.replicaId" title="Int">replicaId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
          case true =&gt; <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.OnlineReplica.readResolve" title="kafka.controller.OnlineReplica.type">OnlineReplica</a><span class="delimiter">)</span>
          case false =&gt;
            <span class="comment">// mark replicas on dead brokers as failed for topic deletion, if they belong to a topic to be deleted.</span>
            <span class="comment">// This is required during controller failover since during controller failover a broker can go down,</span>
            <span class="comment">// so the replicas on that broker should be moved to ReplicaDeletionIneligible to be on the safer side.</span>
            <a href="#kafka.controller;ReplicaStateMachine.replicaState" title="=&gt; scala.collection.mutable.Map[kafka.controller.PartitionAndReplica,kafka.controller.ReplicaState]">replicaState</a>.<span title="(key: kafka.controller.PartitionAndReplica, value: kafka.controller.ReplicaState)Option[kafka.controller.ReplicaState]">put</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.initializeReplicaState.$anonfun.$anonfun.partitionAndReplica" title="kafka.controller.PartitionAndReplica">partitionAndReplica</a>, <a href="#kafka.controller.ReplicaDeletionIneligible.readResolve" title="kafka.controller.ReplicaDeletionIneligible.type">ReplicaDeletionIneligible</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(topics: Seq[String], brokerId: Int)Seq[kafka.common.TopicAndPartition]" id="kafka.controller;ReplicaStateMachine.partitionsAssignedToBroker">partitionsAssignedToBroker</a><span class="delimiter">(</span><a title="Seq[String]" id="kafka.controller;ReplicaStateMachine.partitionsAssignedToBroker.topics">topics</a>: <span title="Seq[String]">Seq</span><span class="delimiter">[</span>String<span class="delimiter">]</span>, <a title="Int" id="kafka.controller;ReplicaStateMachine.partitionsAssignedToBroker.brokerId">brokerId</a>: <span title="Int">Int</span><span class="delimiter">)</span>:<span title="Seq[kafka.common.TopicAndPartition]">Seq</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.partitionReplicaAssignment" title="=&gt; scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">partitionReplicaAssignment</a>.<span title="(p: ((kafka.common.TopicAndPartition, Seq[Int])) =&gt; Boolean)scala.collection.mutable.Map[kafka.common.TopicAndPartition,Seq[Int]]">filter</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.partitionsAssignedToBroker.$anonfun.x$4" title="(kafka.common.TopicAndPartition, Seq[Int])">_</a>.<span title="=&gt; Seq[Int]">_2</span>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.partitionsAssignedToBroker.brokerId" title="Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">keySet</span>.<span title="=&gt; Seq[kafka.common.TopicAndPartition]">toSeq</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * This is the zookeeper listener that triggers all the state transitions for a replica
   */</span>
  class <a title="class BrokerChangeListener extends Object with org.I0Itec.zkclient.IZkChildListener with kafka.utils.Logging" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener">BrokerChangeListener</a><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener" title="ReplicaStateMachine.this.BrokerChangeListener" class="delimiter">(</a><span class="delimiter">)</span> extends <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener" title="org.I0Itec.zkclient.IZkChildListener">IZkChildListener</a> with <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> <span class="delimiter">{</span>
    this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[BrokerChangeListener on Controller &quot;)" class="string">&quot;[BrokerChangeListener on Controller &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="../server/KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
    def <a title="(parentPath: String, currentBrokerList: java.util.List[String])Unit" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange">handleChildChange</a><span class="delimiter">(</span><a title="String" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.parentPath">parentPath</a> : <span title="String">String</span>, <a title="java.util.List[String]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.currentBrokerList">currentBrokerList</a> : java.util.<span title="java.util.List[String]">List</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker change listener fired for path %s with children %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.parentPath" title="String">parentPath</a>, <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.currentBrokerList" title="(l: java.util.List[String])scala.collection.mutable.Buffer[String]">currentBrokerList</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="../utils/Utils.scala.html#kafka.utils.Utils.inLock" title="(lock: java.util.concurrent.locks.Lock)(fun: =&gt; Unit)Unit">inLock</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerLock" title="=&gt; java.util.concurrent.locks.ReentrantLock">controllerLock</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.hasStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">hasStarted</a>.<span title="()Boolean">get</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="KafkaController.scala.html#kafka.controller.ControllerStats" title="kafka.controller.ControllerStats.type">ControllerStats</a>.<a href="KafkaController.scala.html#kafka.controller.ControllerStats.leaderElectionTimer" title="=&gt; kafka.metrics.KafkaTimer">leaderElectionTimer</a>.<a href="../metrics/KafkaTimer.scala.html#kafka.metrics;KafkaTimer.time" title="(f: =&gt; Unit)Unit">time</a> <span class="delimiter">{</span>
            try <span class="delimiter">{</span>
              val <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.curBrokerIds">curBrokerIds</a> = <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.currentBrokerList" title="(l: java.util.List[String])scala.collection.mutable.Buffer[String]">currentBrokerList</a>.<span title="(f: String =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer[String],Int,scala.collection.mutable.Buffer[Int]])scala.collection.mutable.Buffer[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.mutable.Buffer.Coll,Int,scala.collection.mutable.Buffer[Int]]" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.curBrokerIds.$anonfun.x$5" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">_</a>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>.<span title="scala.collection.immutable.Set[Int]">toSet</span>
              val newBrokerIds = <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.curBrokerIds" title="scala.collection.immutable.Set[Int]">curBrokerIds</a> <a title="scala.collection.immutable.Set[Int]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerIds">--</a> <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a>
              val <a title="scala.collection.immutable.Set[Option[kafka.cluster.Broker]]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerInfo">newBrokerInfo</a> = <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerIds" title="scala.collection.immutable.Set[Int]">newBrokerIds</a>.<span title="(f: Int =&gt; Option[kafka.cluster.Broker])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set[Int],Option[kafka.cluster.Broker],scala.collection.immutable.Set[Option[kafka.cluster.Broker]]])scala.collection.immutable.Set[Option[kafka.cluster.Broker]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set.Coll,Option[kafka.cluster.Broker],scala.collection.immutable.Set[Option[kafka.cluster.Broker]]]" class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getBrokerInfo" title="(zkClient: org.I0Itec.zkclient.ZkClient, brokerId: Int)Option[kafka.cluster.Broker]">getBrokerInfo</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerInfo.$anonfun.x$6" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
              val <a title="scala.collection.immutable.Set[kafka.cluster.Broker]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokers">newBrokers</a> = <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerInfo" title="scala.collection.immutable.Set[Option[kafka.cluster.Broker]]">newBrokerInfo</a>.<span title="(p: Option[kafka.cluster.Broker] =&gt; Boolean)scala.collection.immutable.Set[Option[kafka.cluster.Broker]]">filter</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokers.$anonfun.x$7" title="Option[kafka.cluster.Broker]">_</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>.<span title="(f: Option[kafka.cluster.Broker] =&gt; kafka.cluster.Broker)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set[Option[kafka.cluster.Broker]],kafka.cluster.Broker,scala.collection.immutable.Set[kafka.cluster.Broker]])scala.collection.immutable.Set[kafka.cluster.Broker]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set.Coll,kafka.cluster.Broker,scala.collection.immutable.Set[kafka.cluster.Broker]]" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokers.$anonfun.x$8" title="Option[kafka.cluster.Broker]">_</a>.<span title="=&gt; kafka.cluster.Broker">get</span><span class="delimiter">)</span>
              val deadBrokerIds = <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveOrShuttingDownBrokerIds" title="=&gt; scala.collection.Set[Int]">liveOrShuttingDownBrokerIds</a> <a title="scala.collection.Set[Int]" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.deadBrokerIds">--</a> <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.curBrokerIds" title="scala.collection.immutable.Set[Int]">curBrokerIds</a>
              <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokers_=" title="(brokers: scala.collection.Set[kafka.cluster.Broker])Unit">liveBrokers</a> = <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.curBrokerIds" title="scala.collection.immutable.Set[Int]">curBrokerIds</a>.<span title="(f: Int =&gt; Option[kafka.cluster.Broker])(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set[Int],Option[kafka.cluster.Broker],scala.collection.immutable.Set[Option[kafka.cluster.Broker]]])scala.collection.immutable.Set[Option[kafka.cluster.Broker]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set.Coll,Option[kafka.cluster.Broker],scala.collection.immutable.Set[Option[kafka.cluster.Broker]]]" class="delimiter">(</span><a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils" title="kafka.utils.ZkUtils.type">ZkUtils</a>.<a href="../utils/ZkUtils.scala.html#kafka.utils.ZkUtils.getBrokerInfo" title="(zkClient: org.I0Itec.zkclient.ZkClient, brokerId: Int)Option[kafka.cluster.Broker]">getBrokerInfo</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.zkClient" title="=&gt; org.I0Itec.zkclient.ZkClient">zkClient</a>, <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.$anonfun.x$9" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(p: Option[kafka.cluster.Broker] =&gt; Boolean)scala.collection.immutable.Set[Option[kafka.cluster.Broker]]">filter</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.$anonfun.x$10" title="Option[kafka.cluster.Broker]">_</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>.<span title="(f: Option[kafka.cluster.Broker] =&gt; kafka.cluster.Broker)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set[Option[kafka.cluster.Broker]],kafka.cluster.Broker,scala.collection.Set[kafka.cluster.Broker]])scala.collection.Set[kafka.cluster.Broker]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set.Coll,kafka.cluster.Broker,scala.collection.immutable.Set[kafka.cluster.Broker]]" class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.$anonfun.x$11" title="Option[kafka.cluster.Broker]">_</a>.<span title="=&gt; kafka.cluster.Broker">get</span><span class="delimiter">)</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Newly added brokers: %s, deleted brokers: %s, all live brokers: %s&quot;</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerIds" title="scala.collection.immutable.Set[Int]">newBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.deadBrokerIds" title="scala.collection.Set[Int]">deadBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.liveBrokerIds" title="=&gt; scala.collection.Set[Int]">liveBrokerIds</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokers" title="scala.collection.immutable.Set[kafka.cluster.Broker]">newBrokers</a>.<span title="(f: kafka.cluster.Broker =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerChannelManager" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager.addBroker" title="(broker: kafka.cluster.Broker)Unit">addBroker</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.$anonfun.x$12" title="kafka.cluster.Broker">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.deadBrokerIds" title="scala.collection.Set[Int]">deadBrokerIds</a>.<span title="(f: Int =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine.controllerContext" title="=&gt; kafka.controller.ControllerContext">controllerContext</a>.<a href="KafkaController.scala.html#kafka.controller;ControllerContext.controllerChannelManager" title="=&gt; kafka.controller.ControllerChannelManager">controllerChannelManager</a>.<a href="ControllerChannelManager.scala.html#kafka.controller;ControllerChannelManager.removeBroker" title="(brokerId: Int)Unit">removeBroker</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.$anonfun.x$13" title="Int">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
              if<span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerIds" title="scala.collection.immutable.Set[Int]">newBrokerIds</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
                <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.onBrokerStartup" title="(newBrokers: Seq[Int])Unit">onBrokerStartup</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.newBrokerIds" title="scala.collection.immutable.Set[Int]">newBrokerIds</a>.<span title="=&gt; Seq[Int]">toSeq</span><span class="delimiter">)</span>
              if<span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.deadBrokerIds" title="scala.collection.Set[Int]">deadBrokerIds</a>.<span title="=&gt; Int">size</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
                <a href="#kafka.controller;ReplicaStateMachine.controller" title="kafka.controller.KafkaController">controller</a>.<a href="KafkaController.scala.html#kafka.controller;KafkaController.onBrokerFailure" title="(deadBrokers: Seq[Int])Unit">onBrokerFailure</a><span class="delimiter">(</span><a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.deadBrokerIds" title="scala.collection.Set[Int]">deadBrokerIds</a>.<span title="=&gt; Seq[Int]">toSeq</span><span class="delimiter">)</span>
            <span class="delimiter">}</span> catch <span class="delimiter">{</span>
              case <a title="Throwable" id="kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.e">e</a>: <span title="Throwable">Throwable</span> =&gt; <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><span title="String(&quot;Error while handling broker changes&quot;)" class="string">&quot;Error while handling broker changes&quot;</span>, <a href="#kafka.controller;ReplicaStateMachine;BrokerChangeListener.handleChildChange.e" title="Throwable">e</a><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

sealed trait <a title="trait ReplicaState extends AnyRef" id="kafka.controller;ReplicaState">ReplicaState</a> <span class="delimiter">{</span> def <a title="=&gt; Byte" id="kafka.controller;ReplicaState.state">state</a>: <span title="Byte">Byte</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.NewReplica.productElement.x$1" title="kafka.controller.NewReplica.type" id="kafka.controller.NewReplica.readResolve">NewReplica</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.NewReplica.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(1)" class="int">1</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.OnlineReplica.productElement.x$1" title="kafka.controller.OnlineReplica.type" id="kafka.controller.OnlineReplica.readResolve">OnlineReplica</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.OnlineReplica.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(2)" class="int">2</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.OfflineReplica.productElement.x$1" title="kafka.controller.OfflineReplica.type" id="kafka.controller.OfflineReplica.readResolve">OfflineReplica</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.OfflineReplica.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(3)" class="int">3</span> <span class="delimiter">}</span>
case object <a href="#kafka.controller.ReplicaDeletionStarted.productElement.x$1" title="kafka.controller.ReplicaDeletionStarted.type" id="kafka.controller.ReplicaDeletionStarted.readResolve">ReplicaDeletionStarted</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.ReplicaDeletionStarted.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(4)" class="int">4</span><span class="delimiter">}</span>
case object <a href="#kafka.controller.ReplicaDeletionSuccessful.productElement.x$1" title="kafka.controller.ReplicaDeletionSuccessful.type" id="kafka.controller.ReplicaDeletionSuccessful.readResolve">ReplicaDeletionSuccessful</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.ReplicaDeletionSuccessful.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(5)" class="int">5</span><span class="delimiter">}</span>
case object <a href="#kafka.controller.ReplicaDeletionIneligible.productElement.x$1" title="kafka.controller.ReplicaDeletionIneligible.type" id="kafka.controller.ReplicaDeletionIneligible.readResolve">ReplicaDeletionIneligible</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.ReplicaDeletionIneligible.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(6)" class="int">6</span><span class="delimiter">}</span>
case object <a href="#kafka.controller.NonExistentReplica.productElement.x$1" title="kafka.controller.NonExistentReplica.type" id="kafka.controller.NonExistentReplica.readResolve">NonExistentReplica</a> extends <a href="#kafka.controller;ReplicaState" title="kafka.controller.ReplicaState">ReplicaState</a> <span class="delimiter">{</span> val <a title="Byte" id="kafka.controller.NonExistentReplica.state">state</a>: <span title="Byte">Byte</span> = <span title="Byte(7)" class="int">7</span> <span class="delimiter">}</span>

        </pre>
    </body>
</html>
