<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/tools/TestLogCleaning.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

package kafka.tools

import joptsimple.OptionParser
import java.util.Properties
import java.util.Random
import java.io._
import kafka.consumer._
import kafka.serializer._
import kafka.utils._
import kafka.log.FileMessageSet
import kafka.log.Log
import org.apache.kafka.clients.producer.<span class="delimiter">{</span>ProducerRecord, KafkaProducer, ProducerConfig<span class="delimiter">}</span>

<span class="comment">/**
 * This is a torture test that runs against an existing broker. Here is how it works:
 * 
 * It produces a series of specially formatted messages to one or more partitions. Each message it produces
 * it logs out to a text file. The messages have a limited set of keys, so there is duplication in the key space.
 * 
 * The broker will clean its log as the test runs.
 * 
 * When the specified number of messages have been produced we create a consumer and consume all the messages in the topic
 * and write that out to another text file.
 * 
 * Using a stable unix sort we sort both the producer log of what was sent and the consumer log of what was retrieved by the message key. 
 * Then we compare the final message in both logs for each key. If this final message is not the same for all keys we
 * print an error and exit with exit code 1, otherwise we print the size reduction and exit with exit code 0.
 */</span>
object <a title="kafka.tools.TestLogCleaning.type" id="kafka.tools.TestLogCleaning">TestLogCleaning</a> <a href="#kafka.tools.TestLogCleaning" title="kafka.tools.TestLogCleaning.type" class="delimiter">{</a>

  def <a title="(args: Array[String])Unit" id="kafka.tools.TestLogCleaning.main">main</a><span class="delimiter">(</span><a title="Array[String]" id="kafka.tools.TestLogCleaning.main.args">args</a>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="joptsimple.OptionParser" id="kafka.tools.TestLogCleaning.main.parser">parser</a> = new <span title="joptsimple.OptionParser">OptionParser</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[Long]" id="kafka.tools.TestLogCleaning.main.numMessagesOpt">numMessagesOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;messages&quot;)" class="string">&quot;messages&quot;</span>, <span title="String(&quot;The number of messages to send or consume.&quot;)" class="string">&quot;The number of messages to send or consume.&quot;</span><span class="delimiter">)</span>
                               .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                               .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;count&quot;)" class="string">&quot;count&quot;</span><span class="delimiter">)</span>
                               .<span title="(x$1: Class[Long])joptsimple.ArgumentAcceptingOptionSpec[Long]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[Long](classOf[java.lang.Long])" class="delimiter">[</span>java.lang.Long<span class="delimiter">]</span><span class="delimiter">)</span>
                               .<span title="(x$1: Long, x$2: Long*)joptsimple.ArgumentAcceptingOptionSpec[Long]">defaultsTo</span><span class="delimiter">(</span>Long.<span title="implicit scala.Predef.long2Long : (x: Long)Long">MaxValue</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[Integer]" id="kafka.tools.TestLogCleaning.main.numDupsOpt">numDupsOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;duplicates&quot;)" class="string">&quot;duplicates&quot;</span>, <span title="String(&quot;The number of duplicates for each key.&quot;)" class="string">&quot;The number of duplicates for each key.&quot;</span><span class="delimiter">)</span>
                           .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                           .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;count&quot;)" class="string">&quot;count&quot;</span><span class="delimiter">)</span>
                           .<span title="(x$1: Class[Integer])joptsimple.ArgumentAcceptingOptionSpec[Integer]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[Integer](classOf[java.lang.Integer])" class="delimiter">[</span>java.lang.Integer<span class="delimiter">]</span><span class="delimiter">)</span>
                           .<span title="(x$1: Integer, x$2: Integer*)joptsimple.ArgumentAcceptingOptionSpec[Integer]">defaultsTo</span><span class="delimiter">(</span><span title="implicit scala.Predef.int2Integer : (x: Int)Integer" class="int">5</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[String]" id="kafka.tools.TestLogCleaning.main.brokerOpt">brokerOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;broker&quot;)" class="string">&quot;broker&quot;</span>, <span title="String(&quot;Url to connect to.&quot;)" class="string">&quot;Url to connect to.&quot;</span><span class="delimiter">)</span>
                          .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                          .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;url&quot;)" class="string">&quot;url&quot;</span><span class="delimiter">)</span>
                          .<span title="(x$1: Class[String])joptsimple.ArgumentAcceptingOptionSpec[String]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[String](classOf[java.lang.String])" class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[Integer]" id="kafka.tools.TestLogCleaning.main.topicsOpt">topicsOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;topics&quot;)" class="string">&quot;topics&quot;</span>, <span title="String(&quot;The number of topics to test.&quot;)" class="string">&quot;The number of topics to test.&quot;</span><span class="delimiter">)</span>
                          .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                          .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;count&quot;)" class="string">&quot;count&quot;</span><span class="delimiter">)</span>
                          .<span title="(x$1: Class[Integer])joptsimple.ArgumentAcceptingOptionSpec[Integer]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[Integer](classOf[java.lang.Integer])" class="delimiter">[</span>java.lang.Integer<span class="delimiter">]</span><span class="delimiter">)</span>
                          .<span title="(x$1: Integer, x$2: Integer*)joptsimple.ArgumentAcceptingOptionSpec[Integer]">defaultsTo</span><span class="delimiter">(</span><span title="implicit scala.Predef.int2Integer : (x: Int)Integer" class="int">1</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[Integer]" id="kafka.tools.TestLogCleaning.main.percentDeletesOpt">percentDeletesOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;percent-deletes&quot;)" class="string">&quot;percent-deletes&quot;</span>, <span title="String(&quot;The percentage of updates that are deletes.&quot;)" class="string">&quot;The percentage of updates that are deletes.&quot;</span><span class="delimiter">)</span>
    		                      .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
    		                      .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;percent&quot;)" class="string">&quot;percent&quot;</span><span class="delimiter">)</span>
    		                      .<span title="(x$1: Class[Integer])joptsimple.ArgumentAcceptingOptionSpec[Integer]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[Integer](classOf[java.lang.Integer])" class="delimiter">[</span>java.lang.Integer<span class="delimiter">]</span><span class="delimiter">)</span>
    		                      .<span title="(x$1: Integer, x$2: Integer*)joptsimple.ArgumentAcceptingOptionSpec[Integer]">defaultsTo</span><span class="delimiter">(</span><span title="implicit scala.Predef.int2Integer : (x: Int)Integer" class="int">0</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[String]" id="kafka.tools.TestLogCleaning.main.zkConnectOpt">zkConnectOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;zk&quot;)" class="string">&quot;zk&quot;</span>, <span title="String(&quot;Zk url.&quot;)" class="string">&quot;Zk url.&quot;</span><span class="delimiter">)</span>
                             .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                             .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;url&quot;)" class="string">&quot;url&quot;</span><span class="delimiter">)</span>
                             .<span title="(x$1: Class[String])joptsimple.ArgumentAcceptingOptionSpec[String]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[String](classOf[java.lang.String])" class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[Integer]" id="kafka.tools.TestLogCleaning.main.sleepSecsOpt">sleepSecsOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;sleep&quot;)" class="string">&quot;sleep&quot;</span>, <span title="String(&quot;Time to sleep between production and consumption.&quot;)" class="string">&quot;Time to sleep between production and consumption.&quot;</span><span class="delimiter">)</span>
                             .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                             .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;ms&quot;)" class="string">&quot;ms&quot;</span><span class="delimiter">)</span>
                             .<span title="(x$1: Class[Integer])joptsimple.ArgumentAcceptingOptionSpec[Integer]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[Integer](classOf[java.lang.Integer])" class="delimiter">[</span>java.lang.Integer<span class="delimiter">]</span><span class="delimiter">)</span>
                             .<span title="(x$1: Integer, x$2: Integer*)joptsimple.ArgumentAcceptingOptionSpec[Integer]">defaultsTo</span><span class="delimiter">(</span><span title="implicit scala.Predef.int2Integer : (x: Int)Integer" class="int">0</span><span class="delimiter">)</span>
    val <a title="joptsimple.ArgumentAcceptingOptionSpec[String]" id="kafka.tools.TestLogCleaning.main.dumpOpt">dumpOpt</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String, x$2: String)joptsimple.OptionSpecBuilder">accepts</span><span class="delimiter">(</span><span title="String(&quot;dump&quot;)" class="string">&quot;dump&quot;</span>, <span title="String(&quot;Dump the message contents of a topic partition that contains test data from this test to standard out.&quot;)" class="string">&quot;Dump the message contents of a topic partition that contains test data from this test to standard out.&quot;</span><span class="delimiter">)</span>
                        .<span title="()joptsimple.ArgumentAcceptingOptionSpec[String]">withRequiredArg</span>
                        .<span title="(x$1: String)joptsimple.ArgumentAcceptingOptionSpec[String]">describedAs</span><span class="delimiter">(</span><span title="String(&quot;directory&quot;)" class="string">&quot;directory&quot;</span><span class="delimiter">)</span>
                        .<span title="(x$1: Class[String])joptsimple.ArgumentAcceptingOptionSpec[String]">ofType</span><span class="delimiter">(</span>classOf<span title="Class[String](classOf[java.lang.String])" class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>
    
    val <a title="joptsimple.OptionSet" id="kafka.tools.TestLogCleaning.main.options">options</a> = <a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>.<span title="(x$1: String*)joptsimple.OptionSet">parse</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.args" title="Array[String]">args</a>:_*<span class="delimiter">)</span>
    
    if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.args" title="Array[String]">args</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
      <a href="../utils/CommandLineUtils.scala.html#kafka.utils.CommandLineUtils" title="kafka.utils.CommandLineUtils.type">CommandLineUtils</a>.<a href="../utils/CommandLineUtils.scala.html#kafka.utils.CommandLineUtils.printUsageAndDie" title="(parser: joptsimple.OptionParser, message: String)Unit">printUsageAndDie</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>, <span title="String(&quot;An integration test for log cleaning.&quot;)" class="string">&quot;An integration test for log cleaning.&quot;</span><span class="delimiter">)</span>
    
    if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[_])Boolean">has</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.dumpOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">dumpOpt</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#kafka.tools.TestLogCleaning.dumpLog" title="(dir: java.io.File)Unit">dumpLog</a><span class="delimiter">(</span>new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[String])String">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.dumpOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">dumpOpt</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span title="System.type">System</span>.<span title="(x$1: Int)Unit">exit</span><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    
    <a href="../utils/CommandLineUtils.scala.html#kafka.utils.CommandLineUtils" title="kafka.utils.CommandLineUtils.type">CommandLineUtils</a>.<a href="../utils/CommandLineUtils.scala.html#kafka.utils.CommandLineUtils.checkRequiredArgs" title="(parser: joptsimple.OptionParser, options: joptsimple.OptionSet, required: joptsimple.OptionSpec[_]*)Unit">checkRequiredArgs</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.parser" title="joptsimple.OptionParser">parser</a>, <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>, <a href="#kafka.tools.TestLogCleaning.main.brokerOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">brokerOpt</a>, <a href="#kafka.tools.TestLogCleaning.main.zkConnectOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">zkConnectOpt</a>, <a href="#kafka.tools.TestLogCleaning.main.numMessagesOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Long]">numMessagesOpt</a><span class="delimiter">)</span>
    
    <span class="comment">// parse options</span>
    val <a title="Long" id="kafka.tools.TestLogCleaning.main.messages">messages</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[Long])Long">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.numMessagesOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Long]">numMessagesOpt</a><span class="delimiter">)</span>.<span title="()Long">longValue</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.percentDeletes">percentDeletes</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[Integer])Integer">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.percentDeletesOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Integer]">percentDeletesOpt</a><span class="delimiter">)</span>.<span title="()Int">intValue</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.dups">dups</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[Integer])Integer">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.numDupsOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Integer]">numDupsOpt</a><span class="delimiter">)</span>.<span title="()Int">intValue</span>
    val <a title="String" id="kafka.tools.TestLogCleaning.main.brokerUrl">brokerUrl</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[String])String">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.brokerOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">brokerOpt</a><span class="delimiter">)</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.topicCount">topicCount</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[Integer])Integer">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.topicsOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Integer]">topicsOpt</a><span class="delimiter">)</span>.<span title="()Int">intValue</span>
    val <a title="String" id="kafka.tools.TestLogCleaning.main.zkUrl">zkUrl</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[String])String">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.zkConnectOpt" title="joptsimple.ArgumentAcceptingOptionSpec[String]">zkConnectOpt</a><span class="delimiter">)</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.sleepSecs">sleepSecs</a> = <a href="#kafka.tools.TestLogCleaning.main.options" title="joptsimple.OptionSet">options</a>.<span title="(x$1: joptsimple.OptionSpec[Integer])Integer">valueOf</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.sleepSecsOpt" title="joptsimple.ArgumentAcceptingOptionSpec[Integer]">sleepSecsOpt</a><span class="delimiter">)</span>.<span title="()Int">intValue</span>
    
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.testId">testId</a> = new <span title="java.util.Random">Random</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: Int)Int">nextInt</span><span class="delimiter">(</span>Int.<span title="Int(2147483647)">MaxValue</span><span class="delimiter">)</span>
    val <a title="Array[String]" id="kafka.tools.TestLogCleaning.main.topics">topics</a> = <span class="delimiter">(</span><span title="implicit scala.LowPriorityImplicits.intWrapper : (x: Int)scala.runtime.RichInt" class="int">0</span> <span title="(end: Int)scala.collection.immutable.Range">until</span> <a href="#kafka.tools.TestLogCleaning.main.topicCount" title="Int">topicCount</a><span class="delimiter">)</span>.<span title="(f: Int =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq[Int],String,scala.collection.immutable.IndexedSeq[String]])scala.collection.immutable.IndexedSeq[String]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.IndexedSeq.Coll,String,scala.collection.immutable.IndexedSeq[String]]" class="delimiter">(</span><span title="String(&quot;log-cleaner-test-&quot;)" class="string">&quot;log-cleaner-test-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.main.testId" title="Int">testId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;-&quot;)" class="string">&quot;-&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.main.topics.$anonfun.x$1" title="Int">_</a><span class="delimiter">)</span>.<span title="(implicit evidence$1: scala.reflect.ClassTag[String])Array[String]">toArray</span>
    
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Producing %d messages...&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.messages" title="Long">messages</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.main.producedDataFile">producedDataFile</a> = <a href="#kafka.tools.TestLogCleaning.produceMessages" title="(brokerUrl: String, topics: Array[String], messages: Long, dups: Int, percentDeletes: Int)java.io.File">produceMessages</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.brokerUrl" title="String">brokerUrl</a>, <a href="#kafka.tools.TestLogCleaning.main.topics" title="Array[String]">topics</a>, <a href="#kafka.tools.TestLogCleaning.main.messages" title="Long">messages</a>, <a href="#kafka.tools.TestLogCleaning.main.dups" title="Int">dups</a>, <a href="#kafka.tools.TestLogCleaning.main.percentDeletes" title="Int">percentDeletes</a><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Sleeping for %d seconds...&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.sleepSecs" title="Int">sleepSecs</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span title="Thread.type">Thread</span>.<span title="(x$1: Long)Unit">sleep</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.sleepSecs" title="Int">sleepSecs</a> <span title="=&gt; Long">*</span> <span title="Int(1000)" class="int">1000</span><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;Consuming messages...&quot;)" class="string">&quot;Consuming messages...&quot;</span><span class="delimiter">)</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.main.consumedDataFile">consumedDataFile</a> = <a href="#kafka.tools.TestLogCleaning.consumeMessages" title="(zkUrl: String, topics: Array[String])java.io.File">consumeMessages</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.zkUrl" title="String">zkUrl</a>, <a href="#kafka.tools.TestLogCleaning.main.topics" title="Array[String]">topics</a><span class="delimiter">)</span>
    
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.producedLines">producedLines</a> = <a href="#kafka.tools.TestLogCleaning.lineCount" title="(file: java.io.File)Int">lineCount</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.producedDataFile" title="java.io.File">producedDataFile</a><span class="delimiter">)</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.main.consumedLines">consumedLines</a> = <a href="#kafka.tools.TestLogCleaning.lineCount" title="(file: java.io.File)Int">lineCount</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.consumedDataFile" title="java.io.File">consumedDataFile</a><span class="delimiter">)</span>
    val reduction = <span title="Double(1.0)" class="double">1.0</span> <a title="Double" id="kafka.tools.TestLogCleaning.main.reduction">-</a> <a href="#kafka.tools.TestLogCleaning.main.consumedLines" title="Int">consumedLines</a>.<span title="=&gt; Double">toDouble</span><span title="(x: Double)Double">/</span><a href="#kafka.tools.TestLogCleaning.main.producedLines" title="Int">producedLines</a>.<span title="=&gt; Double">toDouble</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;%d rows of data produced, %d rows of data consumed (%.1f%% reduction).&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.producedLines" title="Int">producedLines</a>, <a href="#kafka.tools.TestLogCleaning.main.consumedLines" title="Int">consumedLines</a>, <span title="Int(100)" class="int">100</span> <span title="(x: Double)Double">*</span> <a href="#kafka.tools.TestLogCleaning.main.reduction" title="Double">reduction</a><span class="delimiter">)</span><span class="delimiter">)</span>
    
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;De-duplicating and validating output files...&quot;)" class="string">&quot;De-duplicating and validating output files...&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.validateOutput" title="(producedDataFile: java.io.File, consumedDataFile: java.io.File)Unit">validateOutput</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.main.producedDataFile" title="java.io.File">producedDataFile</a>, <a href="#kafka.tools.TestLogCleaning.main.consumedDataFile" title="java.io.File">consumedDataFile</a><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.main.producedDataFile" title="java.io.File">producedDataFile</a>.<span title="()Boolean">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.main.consumedDataFile" title="java.io.File">consumedDataFile</a>.<span title="()Boolean">delete</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  def <a title="(dir: java.io.File)Unit" id="kafka.tools.TestLogCleaning.dumpLog">dumpLog</a><span class="delimiter">(</span><a title="java.io.File" id="kafka.tools.TestLogCleaning.dumpLog.dir">dir</a>: <span title="java.io.File">File</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.dir" title="java.io.File">dir</a>.<span title="()Boolean">exists</span>, <span title="String(&quot;Non-existent directory: &quot;)" class="string">&quot;Non-existent directory: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.dumpLog.dir" title="java.io.File">dir</a>.<span title="()String">getAbsolutePath</span><span class="delimiter">)</span>
    for<span class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.dumpLog.$anonfun.file">file</a> &lt;- <a href="#kafka.tools.TestLogCleaning.dumpLog.dir" title="java.io.File">dir</a>.<span title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]">list</span>.<span title="(f: String =&gt; Unit)Unit">sorted</span>; if <a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.file" title="String">file</a>.<span title="(x$1: String)Boolean">endsWith</span><span class="delimiter">(</span><a href="../log/Log.scala.html#kafka.log.Log" title="kafka.log.Log.type">Log</a>.<a href="../log/Log.scala.html#kafka.log.Log.LogFileSuffix" title="=&gt; String">LogFileSuffix</a><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="kafka.log.FileMessageSet" id="kafka.tools.TestLogCleaning.dumpLog.$anonfun.ms">ms</a> = new <a href="../log/FileMessageSet.scala.html#kafka.log;FileMessageSet" title="kafka.log.FileMessageSet">FileMessageSet</a><span class="delimiter">(</span>new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.dir" title="java.io.File">dir</a>, <a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.file" title="String">file</a><span class="delimiter">)</span><span class="delimiter">)</span>
      for<span class="delimiter">(</span><a title="kafka.message.MessageAndOffset" id="kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.entry">entry</a> &lt;- <a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.ms" title="(f: kafka.message.MessageAndOffset =&gt; Unit)Unit">ms</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        val <a title="String" id="kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.key">key</a> = <a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>.<a href="../utils/Utils.scala.html#kafka.utils.Utils.readString" title="(buffer: java.nio.ByteBuffer, encoding: String)String">readString</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.entry" title="kafka.message.MessageAndOffset">entry</a>.<a href="../message/MessageAndOffset.scala.html#kafka.message;MessageAndOffset.message" title="=&gt; kafka.message.Message">message</a>.<a href="../message/Message.scala.html#kafka.message;Message.key" title="=&gt; java.nio.ByteBuffer">key</a><span class="delimiter">)</span>
        val <a title="String" id="kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.content">content</a> = 
          if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.entry" title="kafka.message.MessageAndOffset">entry</a>.<a href="../message/MessageAndOffset.scala.html#kafka.message;MessageAndOffset.message" title="=&gt; kafka.message.Message">message</a>.<a href="../message/Message.scala.html#kafka.message;Message.isNull" title="()Boolean">isNull</a><span class="delimiter">)</span>
            null
          else
            <a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>.<a href="../utils/Utils.scala.html#kafka.utils.Utils.readString" title="(buffer: java.nio.ByteBuffer, encoding: String)String">readString</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.entry" title="kafka.message.MessageAndOffset">entry</a>.<a href="../message/MessageAndOffset.scala.html#kafka.message;MessageAndOffset.message" title="=&gt; kafka.message.Message">message</a>.<a href="../message/Message.scala.html#kafka.message;Message.payload" title="=&gt; java.nio.ByteBuffer">payload</a><span class="delimiter">)</span>
        <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;offset = %s, key = %s, content = %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.entry" title="kafka.message.MessageAndOffset">entry</a>.<a href="../message/MessageAndOffset.scala.html#kafka.message;MessageAndOffset.offset" title="=&gt; Long">offset</a>, <a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.key" title="String">key</a>, <a href="#kafka.tools.TestLogCleaning.dumpLog.$anonfun.$anonfun.content" title="String">content</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  
  def <a title="(file: java.io.File)Int" id="kafka.tools.TestLogCleaning.lineCount">lineCount</a><span class="delimiter">(</span><a title="java.io.File" id="kafka.tools.TestLogCleaning.lineCount.file">file</a>: <span title="java.io.File">File</span><span class="delimiter">)</span>: <span title="Int">Int</span> = io.<span title="scala.io.Source.type">Source</span>.<span title="(file: java.io.File)(implicit codec: scala.io.Codec)scala.io.BufferedSource">fromFile</span><span title="=&gt; scala.io.Codec" class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.lineCount.file" title="java.io.File">file</a><span class="delimiter">)</span>.<span title="()Iterator[String]">getLines</span>.<span title="=&gt; Int">size</span>
  
  def <a title="(producedDataFile: java.io.File, consumedDataFile: java.io.File)Unit" id="kafka.tools.TestLogCleaning.validateOutput">validateOutput</a><span class="delimiter">(</span><a title="java.io.File" id="kafka.tools.TestLogCleaning.validateOutput.producedDataFile">producedDataFile</a>: <span title="java.io.File">File</span>, <a title="java.io.File" id="kafka.tools.TestLogCleaning.validateOutput.consumedDataFile">consumedDataFile</a>: <span title="java.io.File">File</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="java.io.BufferedReader" id="kafka.tools.TestLogCleaning.validateOutput.producedReader">producedReader</a> = <a href="#kafka.tools.TestLogCleaning.externalSort" title="(file: java.io.File)java.io.BufferedReader">externalSort</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.producedDataFile" title="java.io.File">producedDataFile</a><span class="delimiter">)</span>
    val <a title="java.io.BufferedReader" id="kafka.tools.TestLogCleaning.validateOutput.consumedReader">consumedReader</a> = <a href="#kafka.tools.TestLogCleaning.externalSort" title="(file: java.io.File)java.io.BufferedReader">externalSort</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDataFile" title="java.io.File">consumedDataFile</a><span class="delimiter">)</span>
    val <a title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]" id="kafka.tools.TestLogCleaning.validateOutput.produced">produced</a> = <a href="#kafka.tools.TestLogCleaning.valuesIterator" title="(reader: java.io.BufferedReader)kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">valuesIterator</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.producedReader" title="java.io.BufferedReader">producedReader</a><span class="delimiter">)</span>
    val <a title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]" id="kafka.tools.TestLogCleaning.validateOutput.consumed">consumed</a> = <a href="#kafka.tools.TestLogCleaning.valuesIterator" title="(reader: java.io.BufferedReader)kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">valuesIterator</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.consumedReader" title="java.io.BufferedReader">consumedReader</a><span class="delimiter">)</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.validateOutput.producedDedupedFile">producedDedupedFile</a> = new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.producedDataFile" title="java.io.File">producedDataFile</a>.<span title="()String">getAbsolutePath</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;.deduped&quot;)" class="string">&quot;.deduped&quot;</span><span class="delimiter">)</span>
    val <a title="java.io.BufferedWriter" id="kafka.tools.TestLogCleaning.validateOutput.producedDeduped">producedDeduped</a> = new <span title="java.io.BufferedWriter">BufferedWriter</span><span class="delimiter">(</span>new <span title="java.io.FileWriter">FileWriter</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.producedDedupedFile" title="java.io.File">producedDedupedFile</a><span class="delimiter">)</span>, <span class="int">1024</span><span title="Int(1048576)">*</span><span class="int">1024</span><span class="delimiter">)</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.validateOutput.consumedDedupedFile">consumedDedupedFile</a> = new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDataFile" title="java.io.File">consumedDataFile</a>.<span title="()String">getAbsolutePath</span> <span title="(x$1: Any)String">+</span> <span title="String(&quot;.deduped&quot;)" class="string">&quot;.deduped&quot;</span><span class="delimiter">)</span>
    val <a title="java.io.BufferedWriter" id="kafka.tools.TestLogCleaning.validateOutput.consumedDeduped">consumedDeduped</a> = new <span title="java.io.BufferedWriter">BufferedWriter</span><span class="delimiter">(</span>new <span title="java.io.FileWriter">FileWriter</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDedupedFile" title="java.io.File">consumedDedupedFile</a><span class="delimiter">)</span>, <span class="int">1024</span><span title="Int(1048576)">*</span><span class="int">1024</span><span class="delimiter">)</span>
    var <a title="Int" id="kafka.tools.TestLogCleaning.validateOutput.total">total</a> = <span title="Int(0)" class="int">0</span>
    var <a title="Int" id="kafka.tools.TestLogCleaning.validateOutput.mismatched">mismatched</a> = <span title="Int(0)" class="int">0</span>
    while<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.produced" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">produced</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.hasNext" title="()Boolean">hasNext</a> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.tools.TestLogCleaning.validateOutput.consumed" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">consumed</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.hasNext" title="()Boolean">hasNext</a><span class="delimiter">)</span> <a href="#kafka.tools.TestLogCleaning.validateOutput.while$1" title="()Unit" class="delimiter">{</a>
      val <a title="kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.validateOutput.p">p</a> = <a href="#kafka.tools.TestLogCleaning.validateOutput.produced" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">produced</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.next" title="()kafka.tools.TestRecord">next</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.validateOutput.producedDeduped" title="java.io.BufferedWriter">producedDeduped</a>.<span title="(x$1: String)Unit">write</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.p" title="kafka.tools.TestRecord">p</a>.<a href="#kafka.tools;TestRecord.toString" title="()String">toString</a><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.validateOutput.producedDeduped" title="java.io.BufferedWriter">producedDeduped</a>.<span title="()Unit">newLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
      val <a title="kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.validateOutput.c">c</a> = <a href="#kafka.tools.TestLogCleaning.validateOutput.consumed" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">consumed</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.next" title="()kafka.tools.TestRecord">next</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDeduped" title="java.io.BufferedWriter">consumedDeduped</a>.<span title="(x$1: String)Unit">write</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.c" title="kafka.tools.TestRecord">c</a>.<a href="#kafka.tools;TestRecord.toString" title="()String">toString</a><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDeduped" title="java.io.BufferedWriter">consumedDeduped</a>.<span title="()Unit">newLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
      if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.p" title="kafka.tools.TestRecord">p</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#kafka.tools.TestLogCleaning.validateOutput.c" title="kafka.tools.TestRecord">c</a><span class="delimiter">)</span>
        <a href="#kafka.tools.TestLogCleaning.validateOutput.mismatched" title="Int">mismatched</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
      <a href="#kafka.tools.TestLogCleaning.validateOutput.total" title="Int">total</a> <span title="(x: Int)Int">+=</span> <span title="Int(1)" class="int">1</span>
    <span class="delimiter">}</span>
    <a href="#kafka.tools.TestLogCleaning.validateOutput.producedDeduped" title="java.io.BufferedWriter">producedDeduped</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDeduped" title="java.io.BufferedWriter">consumedDeduped</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.tools.TestLogCleaning.validateOutput.produced" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">produced</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.hasNext" title="()Boolean">hasNext</a>, <span title="String(&quot;Additional values produced not found in consumer log.&quot;)" class="string">&quot;Additional values produced not found in consumer log.&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.tools.TestLogCleaning.validateOutput.consumed" title="kafka.utils.IteratorTemplate[kafka.tools.TestRecord]">consumed</a>.<a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.hasNext" title="()Boolean">hasNext</a>, <span title="String(&quot;Additional values consumed not found in producer log.&quot;)" class="string">&quot;Additional values consumed not found in producer log.&quot;</span><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;Validated &quot;)" class="string">&quot;Validated &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.validateOutput.total" title="Int">total</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; values, &quot;)" class="string">&quot; values, &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.validateOutput.mismatched" title="Int">mismatched</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; mismatches.&quot;)" class="string">&quot; mismatches.&quot;</span><span class="delimiter">)</span>
    <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.validateOutput.mismatched" title="Int">mismatched</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span>, <span title="String(&quot;Non-zero number of row mismatches.&quot;)" class="string">&quot;Non-zero number of row mismatches.&quot;</span><span class="delimiter">)</span>
    <span class="comment">// if all the checks worked out we can delete the deduped files</span>
    <a href="#kafka.tools.TestLogCleaning.validateOutput.producedDedupedFile" title="java.io.File">producedDedupedFile</a>.<span title="()Boolean">delete</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.validateOutput.consumedDedupedFile" title="java.io.File">consumedDedupedFile</a>.<span title="()Boolean">delete</span><span title="Unit" class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  def <a title="(reader: java.io.BufferedReader)kafka.utils.IteratorTemplate[kafka.tools.TestRecord]" id="kafka.tools.TestLogCleaning.valuesIterator">valuesIterator</a><span class="delimiter">(</span><a title="java.io.BufferedReader" id="kafka.tools.TestLogCleaning.valuesIterator.reader">reader</a>: <span title="java.io.BufferedReader">BufferedReader</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    new <a title="&lt;$anon: kafka.utils.IteratorTemplate[kafka.tools.TestRecord]&gt; extends kafka.utils.IteratorTemplate[kafka.tools.TestRecord]" id="kafka.tools.TestLogCleaning.valuesIterator;$anon">IteratorTemplate</a><span class="delimiter">[</span>TestRecord<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <a title="()kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext">makeNext</a><span class="delimiter">(</span><span class="delimiter">)</span>: <a href="#kafka.tools.TestRecord.readResolve" title="kafka.tools.TestRecord">TestRecord</a> = <span class="delimiter">{</span>
        var <a title="kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next">next</a> = <a href="#kafka.tools.TestLogCleaning.readNext" title="(reader: java.io.BufferedReader)kafka.tools.TestRecord">readNext</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.valuesIterator.reader" title="java.io.BufferedReader">reader</a><span class="delimiter">)</span>
        while<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next" title="kafka.tools.TestRecord">next</a> <span title="(x$1: Any)Boolean">!=</span> null <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next" title="kafka.tools.TestRecord">next</a>.<a href="#kafka.tools;TestRecord.delete" title="=&gt; Boolean">delete</a><span class="delimiter">)</span>
          <a href="#kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next" title="kafka.tools.TestRecord">next</a> = <a href="#kafka.tools.TestLogCleaning.readNext" title="(reader: java.io.BufferedReader)kafka.tools.TestRecord">readNext</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.valuesIterator.reader" title="java.io.BufferedReader">reader</a><span class="delimiter">)</span>
        if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next" title="kafka.tools.TestRecord">next</a> <span title="(x$1: Any)Boolean">==</span> null<span class="delimiter">)</span>
          <a href="../utils/IteratorTemplate.scala.html#kafka.utils;IteratorTemplate.allDone" title="()kafka.tools.TestRecord">allDone</a><span class="delimiter">(</span><span class="delimiter">)</span>
        else
          <a href="#kafka.tools.TestLogCleaning.valuesIterator;$anon.makeNext.next" title="kafka.tools.TestRecord">next</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
  
  def <a title="(reader: java.io.BufferedReader)kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.readNext">readNext</a><span class="delimiter">(</span><a title="java.io.BufferedReader" id="kafka.tools.TestLogCleaning.readNext.reader">reader</a>: <span title="java.io.BufferedReader">BufferedReader</span><span class="delimiter">)</span>: <a href="#kafka.tools.TestRecord.readResolve" title="kafka.tools.TestRecord">TestRecord</a> = <span class="delimiter">{</span>
    var <a title="String" id="kafka.tools.TestLogCleaning.readNext.line">line</a> = <a href="#kafka.tools.TestLogCleaning.readNext.reader" title="java.io.BufferedReader">reader</a>.<span title="()String">readLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.line" title="String">line</a> <span title="(x$1: Any)Boolean">==</span> null<span class="delimiter">)</span>
      return null
    var <a title="kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.readNext.curr">curr</a> = new <a href="#kafka.tools.TestRecord.readResolve" title="kafka.tools.TestRecord">TestRecord</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.line" title="String">line</a><span class="delimiter">)</span>
    while<span class="delimiter">(</span>true<span class="delimiter">)</span> <a href="#kafka.tools.TestLogCleaning.readNext.while$3" title="()Unit" class="delimiter">{</a>
      <a href="#kafka.tools.TestLogCleaning.readNext.line" title="String">line</a> = <a href="#kafka.tools.TestLogCleaning.peekLine" title="(reader: java.io.BufferedReader)String">peekLine</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.reader" title="java.io.BufferedReader">reader</a><span class="delimiter">)</span>
      if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.line" title="String">line</a> <span title="(x$1: Any)Boolean">==</span> null<span class="delimiter">)</span>
        return <a href="#kafka.tools.TestLogCleaning.readNext.curr" title="kafka.tools.TestRecord">curr</a>
      val <a title="kafka.tools.TestRecord" id="kafka.tools.TestLogCleaning.readNext.next">next</a> = new <a href="#kafka.tools.TestRecord.readResolve" title="kafka.tools.TestRecord">TestRecord</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.line" title="String">line</a><span class="delimiter">)</span>
      if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.readNext.next" title="kafka.tools.TestRecord">next</a> <span title="(x$1: Any)Boolean">==</span> null <span title="(x: Boolean)Boolean">||</span> <a href="#kafka.tools.TestLogCleaning.readNext.next" title="kafka.tools.TestRecord">next</a>.<a href="#kafka.tools;TestRecord.topicAndKey" title="=&gt; String">topicAndKey</a> <span title="(x$1: Any)Boolean">!=</span> <a href="#kafka.tools.TestLogCleaning.readNext.curr" title="kafka.tools.TestRecord">curr</a>.<a href="#kafka.tools;TestRecord.topicAndKey" title="=&gt; String">topicAndKey</a><span class="delimiter">)</span>
        return <a href="#kafka.tools.TestLogCleaning.readNext.curr" title="kafka.tools.TestRecord">curr</a>
      <a href="#kafka.tools.TestLogCleaning.readNext.curr" title="kafka.tools.TestRecord">curr</a> = <a href="#kafka.tools.TestLogCleaning.readNext.next" title="kafka.tools.TestRecord">next</a>
      <a href="#kafka.tools.TestLogCleaning.readNext.reader" title="java.io.BufferedReader">reader</a>.<span title="()String">readLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    null
  <span class="delimiter">}</span>
  
  def <a title="(reader: java.io.BufferedReader)String" id="kafka.tools.TestLogCleaning.peekLine">peekLine</a><span class="delimiter">(</span><a title="java.io.BufferedReader" id="kafka.tools.TestLogCleaning.peekLine.reader">reader</a>: <span title="java.io.BufferedReader">BufferedReader</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.tools.TestLogCleaning.peekLine.reader" title="java.io.BufferedReader">reader</a>.<span title="(x$1: Int)Unit">mark</span><span class="delimiter">(</span><span title="Int(4096)" class="int">4096</span><span class="delimiter">)</span>
    val <a title="String" id="kafka.tools.TestLogCleaning.peekLine.line">line</a> = <a href="#kafka.tools.TestLogCleaning.peekLine.reader" title="java.io.BufferedReader">reader</a>.<span title="()String">readLine</span>
    <a href="#kafka.tools.TestLogCleaning.peekLine.reader" title="java.io.BufferedReader">reader</a>.<span title="()Unit">reset</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.peekLine.line" title="String">line</a>
  <span class="delimiter">}</span>
  
  def <a title="(file: java.io.File)java.io.BufferedReader" id="kafka.tools.TestLogCleaning.externalSort">externalSort</a><span class="delimiter">(</span><a title="java.io.File" id="kafka.tools.TestLogCleaning.externalSort.file">file</a>: <span title="java.io.File">File</span><span class="delimiter">)</span>: <span title="java.io.BufferedReader">BufferedReader</span> = <span class="delimiter">{</span>
    val <a title="ProcessBuilder" id="kafka.tools.TestLogCleaning.externalSort.builder">builder</a> = new <span title="ProcessBuilder">ProcessBuilder</span><span class="delimiter">(</span><span title="String(&quot;sort&quot;)" class="string">&quot;sort&quot;</span>, <span title="String(&quot;--key=1,2&quot;)" class="string">&quot;--key=1,2&quot;</span>, <span title="String(&quot;--stable&quot;)" class="string">&quot;--stable&quot;</span>, <span title="String(&quot;--buffer-size=20%&quot;)" class="string">&quot;--buffer-size=20%&quot;</span>, <span title="String(&quot;--temporary-directory=&quot;)" class="string">&quot;--temporary-directory=&quot;</span> <span title="(x$1: Any)String">+</span> <span title="System.type">System</span>.<span title="(x$1: String)String">getProperty</span><span class="delimiter">(</span><span title="String(&quot;java.io.tmpdir&quot;)" class="string">&quot;java.io.tmpdir&quot;</span><span class="delimiter">)</span>, <a href="#kafka.tools.TestLogCleaning.externalSort.file" title="java.io.File">file</a>.<span title="()String">getAbsolutePath</span><span class="delimiter">)</span>
    val <a title="Process" id="kafka.tools.TestLogCleaning.externalSort.process">process</a> = <a href="#kafka.tools.TestLogCleaning.externalSort.builder" title="ProcessBuilder">builder</a>.<span title="()Process">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
    new <a title="&lt;$anon: Thread&gt; extends Thread" id="kafka.tools.TestLogCleaning.externalSort;$anon">Thread</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      override def <a title="()Unit" id="kafka.tools.TestLogCleaning.externalSort;$anon.run">run</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        val <a title="Int" id="kafka.tools.TestLogCleaning.externalSort;$anon.run.exitCode">exitCode</a> = <a href="#kafka.tools.TestLogCleaning.externalSort.process" title="Process">process</a>.<span title="()Int">waitFor</span><span class="delimiter">(</span><span class="delimiter">)</span>
        if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.externalSort;$anon.run.exitCode" title="Int">exitCode</a> <span title="(x: Int)Boolean">!=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span title="System.type">System</span>.<span title="java.io.PrintStream">err</span>.<span title="(x$1: String)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;Process exited abnormally.&quot;)" class="string">&quot;Process exited abnormally.&quot;</span><span class="delimiter">)</span>
          while<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.externalSort.process" title="Process">process</a>.<span title="()java.io.InputStream">getErrorStream</span>.<span title="()Int">available</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            <span title="System.type">System</span>.<span title="java.io.PrintStream">err</span>.<span title="(x$1: Int)Unit">write</span><a href="#kafka.tools.TestLogCleaning.externalSort;$anon.run.while$4" title="()Unit" class="delimiter">(</a><a href="#kafka.tools.TestLogCleaning.externalSort.process" title="Process">process</a>.<span title="()java.io.InputStream">getErrorStream</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="()Int">read</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>.<span title="()Unit">start</span><span class="delimiter">(</span><span class="delimiter">)</span>
    new <span title="java.io.BufferedReader">BufferedReader</span><span class="delimiter">(</span>new <span title="java.io.InputStreamReader">InputStreamReader</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.externalSort.process" title="Process">process</a>.<span title="()java.io.InputStream">getInputStream</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>, <span class="int">10</span>*<span class="int">1024</span><span title="Int(10485760)">*</span><span class="int">1024</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  def <a title="(brokerUrl: String, topics: Array[String], messages: Long, dups: Int, percentDeletes: Int)java.io.File" id="kafka.tools.TestLogCleaning.produceMessages">produceMessages</a><span class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.produceMessages.brokerUrl">brokerUrl</a>: <span title="String">String</span>, 
                      <a title="Array[String]" id="kafka.tools.TestLogCleaning.produceMessages.topics">topics</a>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span>, 
                      <a title="Long" id="kafka.tools.TestLogCleaning.produceMessages.messages">messages</a>: <span title="Long">Long</span>, 
                      <a title="Int" id="kafka.tools.TestLogCleaning.produceMessages.dups">dups</a>: <span title="Int">Int</span>,
                      <a title="Int" id="kafka.tools.TestLogCleaning.produceMessages.percentDeletes">percentDeletes</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
    val <a title="java.util.Properties" id="kafka.tools.TestLogCleaning.produceMessages.producerProps">producerProps</a> = new <span title="java.util.Properties">Properties</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producerProps" title="java.util.Properties">producerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span>ProducerConfig.<span title="String(&quot;block.on.buffer.full&quot;)">BLOCK_ON_BUFFER_FULL_CONFIG</span>, <span title="String(&quot;true&quot;)" class="string">&quot;true&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producerProps" title="java.util.Properties">producerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span>ProducerConfig.<span title="String(&quot;bootstrap.servers&quot;)">BOOTSTRAP_SERVERS_CONFIG</span>, <a href="#kafka.tools.TestLogCleaning.produceMessages.brokerUrl" title="String">brokerUrl</a><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producerProps" title="java.util.Properties">producerProps</a>.<span title="(x$1: Object, x$2: Object)Object">put</span><span class="delimiter">(</span>ProducerConfig.<span title="String(&quot;key.serializer&quot;)">KEY_SERIALIZER_CLASS_CONFIG</span>, <span title="String(&quot;org.apache.kafka.common.serialization.ByteArraySerializer&quot;)" class="string">&quot;org.apache.kafka.common.serialization.ByteArraySerializer&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producerProps" title="java.util.Properties">producerProps</a>.<span title="(x$1: Object, x$2: Object)Object">put</span><span class="delimiter">(</span>ProducerConfig.<span title="String(&quot;value.serializer&quot;)">VALUE_SERIALIZER_CLASS_CONFIG</span>, <span title="String(&quot;org.apache.kafka.common.serialization.ByteArraySerializer&quot;)" class="string">&quot;org.apache.kafka.common.serialization.ByteArraySerializer&quot;</span><span class="delimiter">)</span>
    val <a title="org.apache.kafka.clients.producer.KafkaProducer[Array[Byte],Array[Byte]]" id="kafka.tools.TestLogCleaning.produceMessages.producer">producer</a> = new <span title="org.apache.kafka.clients.producer.KafkaProducer[Array[Byte],Array[Byte]]">KafkaProducer</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.producerProps" title="java.util.Properties">producerProps</a><span class="delimiter">)</span>
    val <a title="java.util.Random" id="kafka.tools.TestLogCleaning.produceMessages.rand">rand</a> = new <span title="java.util.Random">Random</span><span class="delimiter">(</span><span title="Long(1L)" class="int">1</span><span class="delimiter">)</span>
    val <a title="Int" id="kafka.tools.TestLogCleaning.produceMessages.keyCount">keyCount</a> = <span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.messages" title="Long">messages</a> <span title="(x: Int)Long">/</span> <a href="#kafka.tools.TestLogCleaning.produceMessages.dups" title="Int">dups</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.produceMessages.producedFile">producedFile</a> = <span title="java.io.File.type">File</span>.<span title="(x$1: String, x$2: String)java.io.File">createTempFile</span><span class="delimiter">(</span><span title="String(&quot;kafka-log-cleaner-produced-&quot;)" class="string">&quot;kafka-log-cleaner-produced-&quot;</span>, <span title="String(&quot;.txt&quot;)" class="string">&quot;.txt&quot;</span><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;Logging produce requests to &quot;)" class="string">&quot;Logging produce requests to &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.produceMessages.producedFile" title="java.io.File">producedFile</a>.<span title="()String">getAbsolutePath</span><span class="delimiter">)</span>
    val <a title="java.io.BufferedWriter" id="kafka.tools.TestLogCleaning.produceMessages.producedWriter">producedWriter</a> = new <span title="java.io.BufferedWriter">BufferedWriter</span><span class="delimiter">(</span>new <span title="java.io.FileWriter">FileWriter</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.producedFile" title="java.io.File">producedFile</a><span class="delimiter">)</span>, <span class="int">1024</span><span title="Int(1048576)">*</span><span class="int">1024</span><span class="delimiter">)</span>
    for<span class="delimiter">(</span><a title="Long" id="kafka.tools.TestLogCleaning.produceMessages.$anonfun.i">i</a> &lt;- <span title="implicit scala.LowPriorityImplicits.longWrapper : (x: Long)scala.runtime.RichLong" class="long">0L</span> <span title="(f: Long =&gt; Unit)Unit">until</span> <span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.messages" title="Long">messages</a> <span title="(x: Int)Long">*</span> <a href="#kafka.tools.TestLogCleaning.produceMessages.topics" title="Array[String]">topics</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="String" id="kafka.tools.TestLogCleaning.produceMessages.$anonfun.topic">topic</a> = <a href="#kafka.tools.TestLogCleaning.produceMessages.topics" title="(i: Int)String">topics</a><span class="delimiter">(</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.i" title="Long">i</a> <span title="(x: Int)Long">%</span> <a href="#kafka.tools.TestLogCleaning.produceMessages.topics" title="Array[String]">topics</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span><span class="delimiter">)</span>
      val <a title="Int" id="kafka.tools.TestLogCleaning.produceMessages.$anonfun.key">key</a> = <a href="#kafka.tools.TestLogCleaning.produceMessages.rand" title="java.util.Random">rand</a>.<span title="(x$1: Int)Int">nextInt</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.keyCount" title="Int">keyCount</a><span class="delimiter">)</span>
      val delete = <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.i" title="Long">i</a> <span title="(x: Int)Long">%</span> <span title="Int(100)" class="int">100</span> <a title="Boolean" id="kafka.tools.TestLogCleaning.produceMessages.$anonfun.delete">&lt;</a> <a href="#kafka.tools.TestLogCleaning.produceMessages.percentDeletes" title="Int">percentDeletes</a>
      val <a title="org.apache.kafka.clients.producer.ProducerRecord[Array[Byte],Array[Byte]]" id="kafka.tools.TestLogCleaning.produceMessages.$anonfun.msg">msg</a> = 
        if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.delete" title="Boolean">delete</a><span class="delimiter">)</span>
          new <span title="org.apache.kafka.clients.producer.ProducerRecord[Array[Byte],Array[Byte]]">ProducerRecord</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.topic" title="String">topic</a>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.key" title="Int">key</a>.<span title="()String">toString</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">(</span><span class="delimiter">)</span>, null<span class="delimiter">)</span>
        else
          new <span title="org.apache.kafka.clients.producer.ProducerRecord[Array[Byte],Array[Byte]]">ProducerRecord</span><span class="delimiter">[</span>Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span>,Array<span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.topic" title="String">topic</a>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.key" title="Int">key</a>.<span title="()String">toString</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">(</span><span class="delimiter">)</span>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.i" title="Long">i</a>.<span title="()String">toString</span>.<span title="()Array[Byte]">getBytes</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.produceMessages.producer" title="org.apache.kafka.clients.producer.KafkaProducer[Array[Byte],Array[Byte]]">producer</a>.<span title="(x$1: org.apache.kafka.clients.producer.ProducerRecord[Array[Byte],Array[Byte]])java.util.concurrent.Future[org.apache.kafka.clients.producer.RecordMetadata]">send</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.msg" title="org.apache.kafka.clients.producer.ProducerRecord[Array[Byte],Array[Byte]]">msg</a><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.produceMessages.producedWriter" title="java.io.BufferedWriter">producedWriter</a>.<span title="(x$1: String)Unit">write</span><span class="delimiter">(</span><a href="#kafka.tools.TestRecord.readResolve" title="(topic: String, key: Int, value: Long, delete: Boolean)kafka.tools.TestRecord">TestRecord</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.topic" title="String">topic</a>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.key" title="Int">key</a>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.i" title="Long">i</a>, <a href="#kafka.tools.TestLogCleaning.produceMessages.$anonfun.delete" title="Boolean">delete</a><span class="delimiter">)</span>.<a href="#kafka.tools;TestRecord.toString" title="()String">toString</a><span class="delimiter">)</span>
      <a href="#kafka.tools.TestLogCleaning.produceMessages.producedWriter" title="java.io.BufferedWriter">producedWriter</a>.<span title="()Unit">newLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producedWriter" title="java.io.BufferedWriter">producedWriter</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producer" title="org.apache.kafka.clients.producer.KafkaProducer[Array[Byte],Array[Byte]]">producer</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.produceMessages.producedFile" title="java.io.File">producedFile</a>
  <span class="delimiter">}</span>
  
  def <a title="(zkUrl: String, topics: Array[String])kafka.consumer.ZookeeperConsumerConnector" id="kafka.tools.TestLogCleaning.makeConsumer">makeConsumer</a><span class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.makeConsumer.zkUrl">zkUrl</a>: <span title="String">String</span>, <a title="Array[String]" id="kafka.tools.TestLogCleaning.makeConsumer.topics">topics</a>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="../consumer/ZookeeperConsumerConnector.scala.html#kafka.consumer;ZookeeperConsumerConnector" title="kafka.consumer.ZookeeperConsumerConnector">ZookeeperConsumerConnector</a> = <span class="delimiter">{</span>
    val <a title="java.util.Properties" id="kafka.tools.TestLogCleaning.makeConsumer.consumerProps">consumerProps</a> = new <span title="java.util.Properties">Properties</span>
    <a href="#kafka.tools.TestLogCleaning.makeConsumer.consumerProps" title="java.util.Properties">consumerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span><span title="String(&quot;group.id&quot;)" class="string">&quot;group.id&quot;</span>, <span title="String(&quot;log-cleaner-test-&quot;)" class="string">&quot;log-cleaner-test-&quot;</span> <span title="(x$1: Any)String">+</span> new <span title="java.util.Random">Random</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: Int)Int">nextInt</span><span class="delimiter">(</span>Int.<span title="Int(2147483647)">MaxValue</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.makeConsumer.consumerProps" title="java.util.Properties">consumerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span><span title="String(&quot;zookeeper.connect&quot;)" class="string">&quot;zookeeper.connect&quot;</span>, <a href="#kafka.tools.TestLogCleaning.makeConsumer.zkUrl" title="String">zkUrl</a><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.makeConsumer.consumerProps" title="java.util.Properties">consumerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span><span title="String(&quot;consumer.timeout.ms&quot;)" class="string">&quot;consumer.timeout.ms&quot;</span>, <span class="delimiter">(</span><span class="int">20</span><span title="Int(20000)">*</span><span class="int">1000</span><span class="delimiter">)</span>.<span title="()String">toString</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.makeConsumer.consumerProps" title="java.util.Properties">consumerProps</a>.<span title="(x$1: String, x$2: String)Object">setProperty</span><span class="delimiter">(</span><span title="String(&quot;auto.offset.reset&quot;)" class="string">&quot;auto.offset.reset&quot;</span>, <span title="String(&quot;smallest&quot;)" class="string">&quot;smallest&quot;</span><span class="delimiter">)</span>
    new <a href="../consumer/ZookeeperConsumerConnector.scala.html#kafka.consumer;ZookeeperConsumerConnector" title="kafka.consumer.ZookeeperConsumerConnector">ZookeeperConsumerConnector</a><span class="delimiter">(</span>new <a href="../consumer/ConsumerConfig.scala.html#kafka.consumer;ConsumerConfig" title="kafka.consumer.ConsumerConfig">ConsumerConfig</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.makeConsumer.consumerProps" title="java.util.Properties">consumerProps</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
  
  def <a title="(zkUrl: String, topics: Array[String])java.io.File" id="kafka.tools.TestLogCleaning.consumeMessages">consumeMessages</a><span class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.consumeMessages.zkUrl">zkUrl</a>: <span title="String">String</span>, <a title="Array[String]" id="kafka.tools.TestLogCleaning.consumeMessages.topics">topics</a>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="java.io.File">File</span> = <span class="delimiter">{</span>
    val <a title="kafka.consumer.ZookeeperConsumerConnector" id="kafka.tools.TestLogCleaning.consumeMessages.connector">connector</a> = <a href="#kafka.tools.TestLogCleaning.makeConsumer" title="(zkUrl: String, topics: Array[String])kafka.consumer.ZookeeperConsumerConnector">makeConsumer</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.zkUrl" title="String">zkUrl</a>, <a href="#kafka.tools.TestLogCleaning.consumeMessages.topics" title="Array[String]">topics</a><span class="delimiter">)</span>
    val <a title="scala.collection.Map[String,List[kafka.consumer.KafkaStream[String,String]]]" id="kafka.tools.TestLogCleaning.consumeMessages.streams">streams</a> = <a href="#kafka.tools.TestLogCleaning.consumeMessages.connector" title="kafka.consumer.ZookeeperConsumerConnector">connector</a>.<a href="../consumer/ZookeeperConsumerConnector.scala.html#kafka.consumer;ZookeeperConsumerConnector.createMessageStreams(f5ab801b11)" title="(topicCountMap: scala.collection.Map[String,Int], keyDecoder: kafka.serializer.Decoder[String], valueDecoder: kafka.serializer.Decoder[String])scala.collection.Map[String,List[kafka.consumer.KafkaStream[String,String]]]">createMessageStreams</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.topics" title="(xs: Array[String])scala.collection.mutable.ArrayOps[String]">topics</a>.<span title="(f: String =&gt; (String, Int))(implicit bf: scala.collection.generic.CanBuildFrom[Array[String],(String, Int),Array[(String, Int)]])Array[(String, Int)]">map</span><span title="(xs: Array[(String, Int)])scala.collection.mutable.ArrayOps[(String, Int)]" class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.consumeMessages.streams.$anonfun.topic">topic</a> =&gt; <span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.streams.$anonfun.topic" title="String">topic</a>, <span title="Int(1)" class="int">1</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(String, Int),(String, Int)])scala.collection.immutable.Map[String,Int]">toMap</span>, new <a href="../serializer/Decoder.scala.html#kafka.serializer;StringDecoder" title="kafka.serializer.StringDecoder">StringDecoder</a>, new <a href="../serializer/Decoder.scala.html#kafka.serializer;StringDecoder" title="kafka.serializer.StringDecoder">StringDecoder</a><span class="delimiter">)</span>
    val <a title="java.io.File" id="kafka.tools.TestLogCleaning.consumeMessages.consumedFile">consumedFile</a> = <span title="java.io.File.type">File</span>.<span title="(x$1: String, x$2: String)java.io.File">createTempFile</span><span class="delimiter">(</span><span title="String(&quot;kafka-log-cleaner-consumed-&quot;)" class="string">&quot;kafka-log-cleaner-consumed-&quot;</span>, <span title="String(&quot;.txt&quot;)" class="string">&quot;.txt&quot;</span><span class="delimiter">)</span>
    <span title="(x: Any)Unit">println</span><span class="delimiter">(</span><span title="String(&quot;Logging consumed messages to &quot;)" class="string">&quot;Logging consumed messages to &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedFile" title="java.io.File">consumedFile</a>.<span title="()String">getAbsolutePath</span><span class="delimiter">)</span>
    val <a title="java.io.BufferedWriter" id="kafka.tools.TestLogCleaning.consumeMessages.consumedWriter">consumedWriter</a> = new <span title="java.io.BufferedWriter">BufferedWriter</span><span class="delimiter">(</span>new <span title="java.io.FileWriter">FileWriter</span><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedFile" title="java.io.File">consumedFile</a><span class="delimiter">)</span><span class="delimiter">)</span>
    for<span class="delimiter">(</span><a title="String" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.topic">topic</a> &lt;- <a href="#kafka.tools.TestLogCleaning.consumeMessages.topics" title="(f: String =&gt; Unit)Unit">topics</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="kafka.consumer.KafkaStream[String,String]" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.stream">stream</a> = <a href="#kafka.tools.TestLogCleaning.consumeMessages.streams" title="(key: String)List[kafka.consumer.KafkaStream[String,String]]">streams</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span>.<span title="=&gt; kafka.consumer.KafkaStream[String,String]">head</span>
      try <span class="delimiter">{</span>
        for<span class="delimiter">(</span><a title="kafka.message.MessageAndMetadata[String,String]" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.item">item</a> &lt;- <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.stream" title="(f: kafka.message.MessageAndMetadata[String,String] =&gt; Unit)Unit">stream</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          val delete = <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.item" title="kafka.message.MessageAndMetadata[String,String]">item</a>.<a href="../message/MessageAndMetadata.scala.html#kafka.message;MessageAndMetadata.message" title="()String">message</a> <a title="Boolean" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.delete">==</a> null
          val <a title="Long" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.value">value</a> = if<span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.delete" title="Boolean">delete</a><span class="delimiter">)</span> -<span title="Long(-1L)" class="long">1L</span> else <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.item" title="kafka.message.MessageAndMetadata[String,String]">item</a>.<a href="../message/MessageAndMetadata.scala.html#kafka.message;MessageAndMetadata.message" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">message</a>.<span title="=&gt; Long">toLong</span>
          <a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedWriter" title="java.io.BufferedWriter">consumedWriter</a>.<span title="(x$1: String)Unit">write</span><span class="delimiter">(</span><a href="#kafka.tools.TestRecord.readResolve" title="(topic: String, key: Int, value: Long, delete: Boolean)kafka.tools.TestRecord">TestRecord</a><span class="delimiter">(</span><a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.topic" title="String">topic</a>, <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.item" title="kafka.message.MessageAndMetadata[String,String]">item</a>.<a href="../message/MessageAndMetadata.scala.html#kafka.message;MessageAndMetadata.key" title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">key</a>.<span title="=&gt; Int">toInt</span>, <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.value" title="Long">value</a>, <a href="#kafka.tools.TestLogCleaning.consumeMessages.$anonfun.$anonfun.delete" title="Boolean">delete</a><span class="delimiter">)</span>.<a href="#kafka.tools;TestRecord.toString" title="()String">toString</a><span class="delimiter">)</span>
          <a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedWriter" title="java.io.BufferedWriter">consumedWriter</a>.<span title="()Unit">newLine</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span> catch <span class="delimiter">{</span>
        case <a title="kafka.consumer.ConsumerTimeoutException" id="kafka.tools.TestLogCleaning.consumeMessages.$anonfun.e">e</a>: <a href="../consumer/ConsumerIterator.scala.html#kafka.consumer;ConsumerTimeoutException" title="kafka.consumer.ConsumerTimeoutException">ConsumerTimeoutException</a> =&gt; 
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedWriter" title="java.io.BufferedWriter">consumedWriter</a>.<span title="()Unit">close</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.consumeMessages.connector" title="kafka.consumer.ZookeeperConsumerConnector">connector</a>.<a href="../consumer/ZookeeperConsumerConnector.scala.html#kafka.consumer;ZookeeperConsumerConnector.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.tools.TestLogCleaning.consumeMessages.consumedFile" title="java.io.File">consumedFile</a>
  <span class="delimiter">}</span>
  
<span class="delimiter">}</span>

case class <a title="class TestRecord extends AnyRef with Product with Serializable" id="kafka.tools.TestRecord.readResolve">TestRecord</a><a href="#kafka.tools.TestRecord.readResolve" title="Product" class="delimiter">(</a>val <a title="String" id="kafka.tools;TestRecord.topic">topic</a>: <span title="String">String</span>, val <a title="Int" id="kafka.tools;TestRecord.key">key</a>: <span title="Int">Int</span>, val <a title="Long" id="kafka.tools;TestRecord.value">value</a>: <span title="Long">Long</span>, val <a title="Boolean" id="kafka.tools;TestRecord.delete">delete</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  def this<span class="delimiter">(</span><a title="Array[String]" id="kafka.tools;TestRecord.<init>(253cc92a63).pieces">pieces</a>: <span title="Array[String]">Array</span><span class="delimiter">[</span>String<span class="delimiter">]</span><span class="delimiter">)</span> = this<span class="delimiter">(</span><a href="#kafka.tools;TestRecord.<init>(253cc92a63).pieces" title="(i: Int)String">pieces</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>, <a href="#kafka.tools;TestRecord.<init>(253cc92a63).pieces" title="(i: Int)String">pieces</a><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>, <a href="#kafka.tools;TestRecord.<init>(253cc92a63).pieces" title="(i: Int)String">pieces</a><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="delimiter">(</span><span title="Int(2)" class="int">2</span><span class="delimiter">)</span>.<span title="=&gt; Long">toLong</span>, <a href="#kafka.tools;TestRecord.<init>(253cc92a63).pieces" title="(i: Int)String">pieces</a><span class="delimiter">(</span><span title="Int(3)" class="int">3</span><span class="delimiter">)</span> <span title="(x$1: Any)Boolean">==</span> <span title="String(&quot;d&quot;)" class="string">&quot;d&quot;</span><span class="delimiter">)</span>
  def this<span class="delimiter">(</span><a title="String" id="kafka.tools;TestRecord.<init>(69fba992ac).line">line</a>: <span title="String">String</span><span class="delimiter">)</span> = this<span class="delimiter">(</span><a href="#kafka.tools;TestRecord.<init>(69fba992ac).line" title="String">line</a>.<span title="(x$1: String)Array[String]">split</span><span class="delimiter">(</span><span title="String(&quot;\t&quot;)" class="string">&quot;\t&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
  override def <a title="()String" id="kafka.tools;TestRecord.toString">toString</a><span class="delimiter">(</span><span class="delimiter">)</span> = <a href="#kafka.tools;TestRecord.topic" title="=&gt; String">topic</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;\t&quot;)" class="string">&quot;\t&quot;</span> <span title="(x$1: Any)String">+</span>  <a href="#kafka.tools;TestRecord.key" title="=&gt; Int">key</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;\t&quot;)" class="string">&quot;\t&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools;TestRecord.value" title="=&gt; Long">value</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;\t&quot;)" class="string">&quot;\t&quot;</span> <span title="(x$1: Any)String">+</span> <span class="delimiter">(</span>if<span class="delimiter">(</span><a href="#kafka.tools;TestRecord.delete" title="=&gt; Boolean">delete</a><span class="delimiter">)</span> <span title="String(&quot;d&quot;)" class="string">&quot;d&quot;</span> else <span title="String(&quot;u&quot;)" class="string">&quot;u&quot;</span><span class="delimiter">)</span>
  def <a title="=&gt; String" id="kafka.tools;TestRecord.topicAndKey">topicAndKey</a> = <a href="#kafka.tools;TestRecord.topic" title="=&gt; String">topic</a> <span title="(x$1: Any)String">+</span> <a href="#kafka.tools;TestRecord.key" title="=&gt; Int">key</a>
<span class="delimiter">}</span>
        </pre>
    </body>
</html>
