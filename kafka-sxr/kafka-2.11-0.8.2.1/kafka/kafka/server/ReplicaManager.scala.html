<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/server/ReplicaManager.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>
package kafka.server

import kafka.api._
import kafka.common._
import kafka.utils._
import kafka.cluster.<span class="delimiter">{</span>Broker, Partition, Replica<span class="delimiter">}</span>
import kafka.log.LogManager
import kafka.metrics.KafkaMetricsGroup
import kafka.controller.KafkaController
import kafka.common.TopicAndPartition
import kafka.message.MessageSet

import java.util.concurrent.atomic.AtomicBoolean
import java.io.<span class="delimiter">{</span>IOException, File<span class="delimiter">}</span>
import java.util.concurrent.TimeUnit
import scala.<span title="type">Predef</span>._
import scala.collection._
import scala.collection.mutable.HashMap
import scala.collection.Map
import scala.collection.Set
import scala.Some

import org.I0Itec.zkclient.ZkClient
import com.yammer.metrics.core.Gauge

object <a title="kafka.server.ReplicaManager.type" id="kafka.server.ReplicaManager">ReplicaManager</a> <a href="#kafka.server.ReplicaManager" title="kafka.server.ReplicaManager.type" class="delimiter">{</a>
  val <a title="String" id="kafka.server.ReplicaManager.HighWatermarkFilename">HighWatermarkFilename</a> = <span title="String(&quot;replication-offset-checkpoint&quot;)" class="string">&quot;replication-offset-checkpoint&quot;</span>
<span class="delimiter">}</span>

case class <a title="class PartitionDataAndOffset extends AnyRef with Product with Serializable" id="kafka.server.PartitionDataAndOffset.readResolve">PartitionDataAndOffset</a><a href="#kafka.server.PartitionDataAndOffset.readResolve" title="Product" class="delimiter">(</a><a title="kafka.api.FetchResponsePartitionData" id="kafka.server;PartitionDataAndOffset.data">data</a>: <a href="../api/FetchResponse.scala.html#kafka.api;FetchResponsePartitionData" title="kafka.api.FetchResponsePartitionData">FetchResponsePartitionData</a>, <a title="kafka.server.LogOffsetMetadata" id="kafka.server;PartitionDataAndOffset.offset">offset</a>: <a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata" title="kafka.server.LogOffsetMetadata">LogOffsetMetadata</a><span class="delimiter">)</span>


class <a title="class ReplicaManager extends AnyRef with kafka.utils.Logging with kafka.metrics.KafkaMetricsGroup" id="kafka.server;ReplicaManager">ReplicaManager</a><a href="#kafka.server;ReplicaManager" title="kafka.server.ReplicaManager" class="delimiter">(</a>val <a title="kafka.server.KafkaConfig" id="kafka.server;ReplicaManager.config">config</a>: <a href="KafkaConfig.scala.html#kafka.server;KafkaConfig" title="kafka.server.KafkaConfig">KafkaConfig</a>, 
                     <a title="kafka.utils.Time" id="kafka.server;ReplicaManager.time">time</a>: <a href="../utils/Time.scala.html#kafka.utils;Time" title="kafka.utils.Time">Time</a>,
                     val <a title="org.I0Itec.zkclient.ZkClient" id="kafka.server;ReplicaManager.zkClient">zkClient</a>: <span title="org.I0Itec.zkclient.ZkClient">ZkClient</span>,
                     <a title="kafka.utils.Scheduler" id="kafka.server;ReplicaManager.scheduler">scheduler</a>: <a href="../utils/KafkaScheduler.scala.html#kafka.utils;Scheduler" title="kafka.utils.Scheduler">Scheduler</a>,
                     val <a title="kafka.log.LogManager" id="kafka.server;ReplicaManager.logManager">logManager</a>: <a href="../log/LogManager.scala.html#kafka.log;LogManager" title="kafka.log.LogManager">LogManager</a>,
                     val <a title="java.util.concurrent.atomic.AtomicBoolean" id="kafka.server;ReplicaManager.isShuttingDown">isShuttingDown</a>: <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span> <span class="delimiter">)</span> extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> with <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup" title="kafka.metrics.KafkaMetricsGroup">KafkaMetricsGroup</a> <span class="delimiter">{</span>
  <span class="comment">/* epoch of the controller that last changed the leader */</span>
  @volatile var controllerEpoch: <span title="Int">Int</span> = <a href="../controller/KafkaController.scala.html#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="../controller/KafkaController.scala.html#kafka.controller.KafkaController.InitialControllerEpoch" title="=&gt; Int">InitialControllerEpoch</a> <a title="Int" id="kafka.server;ReplicaManager.controllerEpoch_=">-</a> <span title="Int(1)" class="int">1</span>
  private val <a title="Int" id="kafka.server;ReplicaManager.localBrokerId">localBrokerId</a> = <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>
  private val <a title="kafka.utils.Pool[(String, Int),kafka.cluster.Partition]" id="kafka.server;ReplicaManager.allPartitions">allPartitions</a> = new <a href="../utils/Pool.scala.html#kafka.utils;Pool" title="kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">Pool</a><span class="delimiter">[</span><span class="delimiter">(</span>String, Int<span class="delimiter">)</span>, Partition<span class="delimiter">]</span>
  private val <a title="Object" id="kafka.server;ReplicaManager.replicaStateChangeLock">replicaStateChangeLock</a> = new <span title="Object">Object</span>
  val <a title="kafka.server.ReplicaFetcherManager" id="kafka.server;ReplicaManager.replicaFetcherManager">replicaFetcherManager</a> = new <a href="ReplicaFetcherManager.scala.html#kafka.server;ReplicaFetcherManager" title="kafka.server.ReplicaFetcherManager">ReplicaFetcherManager</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>, this<span class="delimiter">)</span>
  private val <a title="java.util.concurrent.atomic.AtomicBoolean" id="kafka.server;ReplicaManager.highWatermarkCheckPointThreadStarted">highWatermarkCheckPointThreadStarted</a> = new <span title="java.util.concurrent.atomic.AtomicBoolean">AtomicBoolean</span><span class="delimiter">(</span>false<span class="delimiter">)</span>
  val <a title="scala.collection.immutable.Map[String,kafka.server.OffsetCheckpoint]" id="kafka.server;ReplicaManager.highWatermarkCheckpoints">highWatermarkCheckpoints</a> = <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.logDirs" title="=&gt; Seq[String]">logDirs</a>.<span title="(f: String =&gt; (String, kafka.server.OffsetCheckpoint))(implicit bf: scala.collection.generic.CanBuildFrom[Seq[String],(String, kafka.server.OffsetCheckpoint),Seq[(String, kafka.server.OffsetCheckpoint)]])Seq[(String, kafka.server.OffsetCheckpoint)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Seq.Coll,(String, kafka.server.OffsetCheckpoint),Seq[(String, kafka.server.OffsetCheckpoint)]]" class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.highWatermarkCheckpoints.$anonfun.dir">dir</a> =&gt; <span title="(_1: String, _2: kafka.server.OffsetCheckpoint)(String, kafka.server.OffsetCheckpoint)" class="delimiter">(</span>new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.highWatermarkCheckpoints.$anonfun.dir" title="String">dir</a><span class="delimiter">)</span>.<span title="()String">getAbsolutePath</span>, new <a href="OffsetCheckpoint.scala.html#kafka.server;OffsetCheckpoint" title="kafka.server.OffsetCheckpoint">OffsetCheckpoint</a><span class="delimiter">(</span>new <span title="java.io.File">File</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.highWatermarkCheckpoints.$anonfun.dir" title="String">dir</a>, <a href="#kafka.server.ReplicaManager" title="kafka.server.ReplicaManager.type">ReplicaManager</a>.<a href="#kafka.server.ReplicaManager.HighWatermarkFilename" title="=&gt; String">HighWatermarkFilename</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(String, kafka.server.OffsetCheckpoint),(String, kafka.server.OffsetCheckpoint)])scala.collection.immutable.Map[String,kafka.server.OffsetCheckpoint]">toMap</span>
  private var <a title="Boolean" id="kafka.server;ReplicaManager.hwThreadInitialized_=">hwThreadInitialized</a> = false
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[Replica Manager on Broker &quot;)" class="string">&quot;[Replica Manager on Broker &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;]: &quot;)" class="string">&quot;]: &quot;</span>
  val <a title="kafka.controller.KafkaController.StateChangeLogger" id="kafka.server;ReplicaManager.stateChangeLogger">stateChangeLogger</a> = <a href="../controller/KafkaController.scala.html#kafka.controller.KafkaController" title="kafka.controller.KafkaController.type">KafkaController</a>.<a href="../controller/KafkaController.scala.html#kafka.controller.KafkaController.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>

  var <a title="kafka.server.ProducerRequestPurgatory" id="kafka.server;ReplicaManager.producerRequestPurgatory_=">producerRequestPurgatory</a>: <a href="ProducerRequestPurgatory.scala.html#kafka.server;ProducerRequestPurgatory" title="kafka.server.ProducerRequestPurgatory">ProducerRequestPurgatory</a> = null
  var <a title="kafka.server.FetchRequestPurgatory" id="kafka.server;ReplicaManager.fetchRequestPurgatory_=">fetchRequestPurgatory</a>: <a href="FetchRequestPurgatory.scala.html#kafka.server;FetchRequestPurgatory" title="kafka.server.FetchRequestPurgatory">FetchRequestPurgatory</a> = null

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;LeaderCount&quot;)" class="string">&quot;LeaderCount&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span> = <span class="delimiter">{</span>
          <a href="#kafka.server;ReplicaManager.getLeaderPartitions" title="()List[kafka.cluster.Partition]">getLeaderPartitions</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="=&gt; Int">size</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>
  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;PartitionCount&quot;)" class="string">&quot;PartitionCount&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.size" title="=&gt; Int">size</a>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>
  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Int], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Int]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;UnderReplicatedPartitions&quot;)" class="string">&quot;UnderReplicatedPartitions&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Int]&gt; extends com.yammer.metrics.core.Gauge[Int]">Gauge</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> <span class="delimiter">{</span>
      def <span title="()Int">value</span> = <a href="#kafka.server;ReplicaManager.underReplicatedPartitionCount" title="()Int">underReplicatedPartitionCount</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">)</span>
  val <a title="com.yammer.metrics.core.Meter" id="kafka.server;ReplicaManager.isrExpandRate">isrExpandRate</a> = <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newMeter" title="(name: String, eventType: String, timeUnit: java.util.concurrent.TimeUnit, tags: scala.collection.Map[String,String])com.yammer.metrics.core.Meter">newMeter</a><span class="delimiter">(</span><span title="String(&quot;IsrExpandsPerSec&quot;)" class="string">&quot;IsrExpandsPerSec&quot;</span>,  <span title="String(&quot;expands&quot;)" class="string">&quot;expands&quot;</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span>
  val <a title="com.yammer.metrics.core.Meter" id="kafka.server;ReplicaManager.isrShrinkRate">isrShrinkRate</a> = <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newMeter" title="(name: String, eventType: String, timeUnit: java.util.concurrent.TimeUnit, tags: scala.collection.Map[String,String])com.yammer.metrics.core.Meter">newMeter</a><span class="delimiter">(</span><span title="String(&quot;IsrShrinksPerSec&quot;)" class="string">&quot;IsrShrinksPerSec&quot;</span>,  <span title="String(&quot;shrinks&quot;)" class="string">&quot;shrinks&quot;</span>, TimeUnit.<span title="java.util.concurrent.TimeUnit(SECONDS)">SECONDS</span><span class="delimiter">)</span>

  def <a title="()Int" id="kafka.server;ReplicaManager.underReplicatedPartitionCount">underReplicatedPartitionCount</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
      <a href="#kafka.server;ReplicaManager.getLeaderPartitions" title="()List[kafka.cluster.Partition]">getLeaderPartitions</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(p: kafka.cluster.Partition =&gt; Boolean)Int">count</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.underReplicatedPartitionCount.$anonfun.x$1" title="kafka.cluster.Partition">_</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.isUnderReplicated" title="()Boolean">isUnderReplicated</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread">startHighWaterMarksCheckPointThread</a><span class="delimiter">(</span><span class="delimiter">)</span> = <span class="delimiter">{</span>
    if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.highWatermarkCheckPointThreadStarted" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">highWatermarkCheckPointThreadStarted</a>.<span title="(x$1: Boolean, x$2: Boolean)Boolean">compareAndSet</span><span class="delimiter">(</span>false, true<span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.scheduler" title="kafka.utils.Scheduler">scheduler</a>.<a href="../utils/KafkaScheduler.scala.html#kafka.utils;Scheduler.schedule$default$3" title="Long" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread.x$19">schedule</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread.x$15" class="string">&quot;highwatermark-checkpoint&quot;</a>, <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks" title="() =&gt; Unit" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread.x$16">checkpointHighWatermarks</a>, period = <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.replicaHighWatermarkCheckpointIntervalMs" title="Long" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread.x$17">replicaHighWatermarkCheckpointIntervalMs</a>, unit = TimeUnit.<a title="java.util.concurrent.TimeUnit" id="kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread.x$18">MILLISECONDS</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Initialize the replica manager with the request purgatory
   *
   * TODO: will be removed in 0.9 where we refactor server structure
   */</span>

  def <a title="(producerRequestPurgatory: kafka.server.ProducerRequestPurgatory, fetchRequestPurgatory: kafka.server.FetchRequestPurgatory)Unit" id="kafka.server;ReplicaManager.initWithRequestPurgatory">initWithRequestPurgatory</a><span class="delimiter">(</span><a title="kafka.server.ProducerRequestPurgatory" id="kafka.server;ReplicaManager.initWithRequestPurgatory.producerRequestPurgatory">producerRequestPurgatory</a>: <a href="ProducerRequestPurgatory.scala.html#kafka.server;ProducerRequestPurgatory" title="kafka.server.ProducerRequestPurgatory">ProducerRequestPurgatory</a>, <a title="kafka.server.FetchRequestPurgatory" id="kafka.server;ReplicaManager.initWithRequestPurgatory.fetchRequestPurgatory">fetchRequestPurgatory</a>: <a href="FetchRequestPurgatory.scala.html#kafka.server;FetchRequestPurgatory" title="kafka.server.FetchRequestPurgatory">FetchRequestPurgatory</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    this.<a href="#kafka.server;ReplicaManager.producerRequestPurgatory_=" title="(x$1: kafka.server.ProducerRequestPurgatory)Unit">producerRequestPurgatory</a> = <a href="#kafka.server;ReplicaManager.initWithRequestPurgatory.producerRequestPurgatory" title="kafka.server.ProducerRequestPurgatory">producerRequestPurgatory</a>
    this.<a href="#kafka.server;ReplicaManager.fetchRequestPurgatory_=" title="(x$1: kafka.server.FetchRequestPurgatory)Unit">fetchRequestPurgatory</a> = <a href="#kafka.server;ReplicaManager.initWithRequestPurgatory.fetchRequestPurgatory" title="kafka.server.FetchRequestPurgatory">fetchRequestPurgatory</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Unblock some delayed produce requests with the request key
   */</span>
  def <a title="(key: kafka.common.TopicAndPartition)Unit" id="kafka.server;ReplicaManager.unblockDelayedProduceRequests">unblockDelayedProduceRequests</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;ReplicaManager.unblockDelayedProduceRequests.key">key</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[kafka.server.DelayedProduce]" id="kafka.server;ReplicaManager.unblockDelayedProduceRequests.satisfied">satisfied</a> = <a href="#kafka.server;ReplicaManager.producerRequestPurgatory_=" title="=&gt; kafka.server.ProducerRequestPurgatory">producerRequestPurgatory</a>.<a href="RequestPurgatory.scala.html#kafka.server;RequestPurgatory.update" title="(key: Any)Seq[kafka.server.DelayedProduce]">update</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedProduceRequests.key" title="kafka.common.TopicAndPartition">key</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Request key %s unblocked %d producer requests.&quot;</span>
      .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedProduceRequests.key" title="kafka.common.TopicAndPartition">key</a>, <a href="#kafka.server;ReplicaManager.unblockDelayedProduceRequests.satisfied" title="Seq[kafka.server.DelayedProduce]">satisfied</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// send any newly unblocked responses</span>
    <a href="#kafka.server;ReplicaManager.unblockDelayedProduceRequests.satisfied" title="Seq[kafka.server.DelayedProduce]">satisfied</a>.<span title="(f: kafka.server.DelayedProduce =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.producerRequestPurgatory_=" title="=&gt; kafka.server.ProducerRequestPurgatory">producerRequestPurgatory</a>.<a href="ProducerRequestPurgatory.scala.html#kafka.server;ProducerRequestPurgatory.respond" title="(delayedProduce: kafka.server.DelayedProduce)Unit">respond</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedProduceRequests.$anonfun.x$2" title="kafka.server.DelayedProduce">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Unblock some delayed fetch requests with the request key
   */</span>
  def <a title="(key: kafka.common.TopicAndPartition)Unit" id="kafka.server;ReplicaManager.unblockDelayedFetchRequests">unblockDelayedFetchRequests</a><span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;ReplicaManager.unblockDelayedFetchRequests.key">key</a>: <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Seq[kafka.server.DelayedFetch]" id="kafka.server;ReplicaManager.unblockDelayedFetchRequests.satisfied">satisfied</a> = <a href="#kafka.server;ReplicaManager.fetchRequestPurgatory_=" title="=&gt; kafka.server.FetchRequestPurgatory">fetchRequestPurgatory</a>.<a href="RequestPurgatory.scala.html#kafka.server;RequestPurgatory.update" title="(key: Any)Seq[kafka.server.DelayedFetch]">update</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedFetchRequests.key" title="kafka.common.TopicAndPartition">key</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Request key %s unblocked %d fetch requests.&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedFetchRequests.key" title="kafka.common.TopicAndPartition">key</a>, <a href="#kafka.server;ReplicaManager.unblockDelayedFetchRequests.satisfied" title="Seq[kafka.server.DelayedFetch]">satisfied</a>.<span title="=&gt; Int">size</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <span class="comment">// send any newly unblocked responses</span>
    <a href="#kafka.server;ReplicaManager.unblockDelayedFetchRequests.satisfied" title="Seq[kafka.server.DelayedFetch]">satisfied</a>.<span title="(f: kafka.server.DelayedFetch =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.fetchRequestPurgatory_=" title="=&gt; kafka.server.FetchRequestPurgatory">fetchRequestPurgatory</a>.<a href="FetchRequestPurgatory.scala.html#kafka.server;FetchRequestPurgatory.respond" title="(delayedFetch: kafka.server.DelayedFetch)Unit">respond</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.unblockDelayedFetchRequests.$anonfun.x$3" title="kafka.server.DelayedFetch">_</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="kafka.server;ReplicaManager.startup">startup</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <span class="comment">// start ISR expiration thread</span>
    <a href="#kafka.server;ReplicaManager.scheduler" title="kafka.utils.Scheduler">scheduler</a>.<a href="../utils/KafkaScheduler.scala.html#kafka.utils;Scheduler.schedule$default$3" title="Long" id="kafka.server;ReplicaManager.startup.x$24">schedule</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.startup.x$20" class="string">&quot;isr-expiration&quot;</a>, <a href="#kafka.server;ReplicaManager.maybeShrinkIsr" title="() =&gt; Unit" id="kafka.server;ReplicaManager.startup.x$21">maybeShrinkIsr</a>, period = <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.replicaLagTimeMaxMs" title="Long" id="kafka.server;ReplicaManager.startup.x$22">replicaLagTimeMaxMs</a>, unit = TimeUnit.<a title="java.util.concurrent.TimeUnit" id="kafka.server;ReplicaManager.startup.x$23">MILLISECONDS</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int, deletePartition: Boolean)Short" id="kafka.server;ReplicaManager.stopReplica">stopReplica</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.stopReplica.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.stopReplica.partitionId">partitionId</a>: <span title="Int">Int</span>, <a title="Boolean" id="kafka.server;ReplicaManager.stopReplica.deletePartition">deletePartition</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Short">Short</span>  = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d handling stop replica (delete=%s) for partition [%s,%d]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>,
      <a href="#kafka.server;ReplicaManager.stopReplica.deletePartition" title="Boolean">deletePartition</a>.<span title="()String">toString</span>, <a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="Short" id="kafka.server;ReplicaManager.stopReplica.errorCode">errorCode</a> = <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a>
    <a href="#kafka.server;ReplicaManager.getPartition" title="(topic: String, partitionId: Int)Option[kafka.cluster.Partition]">getPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.stopReplica.partition">partition</a><span class="delimiter">)</span> =&gt;
        if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.deletePartition" title="Boolean">deletePartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          val <a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.stopReplica.removedPartition">removedPartition</a> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.remove" title="(key: (String, Int))kafka.cluster.Partition">remove</a><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.removedPartition" title="kafka.cluster.Partition">removedPartition</a> <span title="(x$1: Any)Boolean">!=</span> null<span class="delimiter">)</span>
            <a href="#kafka.server;ReplicaManager.stopReplica.removedPartition" title="kafka.cluster.Partition">removedPartition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.delete" title="()Unit">delete</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// this will delete the local log</span>
        <span class="delimiter">}</span>
      case <span title="None.type">None</span> =&gt;
        <span class="comment">// Delete log and corresponding folders in case replica manager doesn't hold them anymore.</span>
        <span class="comment">// This could happen when topic is being deleted while broker is down and recovers.</span>
        if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.deletePartition" title="Boolean">deletePartition</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          val <a title="kafka.common.TopicAndPartition" id="kafka.server;ReplicaManager.stopReplica.topicAndPartition">topicAndPartition</a> = <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>

          if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.logManager" title="=&gt; kafka.log.LogManager">logManager</a>.<a href="../log/LogManager.scala.html#kafka.log;LogManager.getLog" title="(topicAndPartition: kafka.common.TopicAndPartition)Option[kafka.log.Log]">getLog</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#kafka.server;ReplicaManager.logManager" title="=&gt; kafka.log.LogManager">logManager</a>.<a href="../log/LogManager.scala.html#kafka.log;LogManager.deleteLog" title="(topicAndPartition: kafka.common.TopicAndPartition)Unit">deleteLog</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplica.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d ignoring stop replica (delete=%s) for partition [%s,%d] as replica doesn't exist on broker&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.stopReplica.deletePartition" title="Boolean">deletePartition</a>, <a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d finished handling stop replica (delete=%s) for partition [%s,%d]&quot;</span>
      .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.stopReplica.deletePartition" title="Boolean">deletePartition</a>, <a href="#kafka.server;ReplicaManager.stopReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.stopReplica.errorCode" title="Short">errorCode</a>
  <span class="delimiter">}</span>

  def <a title="(stopReplicaRequest: kafka.api.StopReplicaRequest)(scala.collection.mutable.Map[kafka.common.TopicAndPartition,Short], Short)" id="kafka.server;ReplicaManager.stopReplicas">stopReplicas</a><span class="delimiter">(</span><a title="kafka.api.StopReplicaRequest" id="kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest">stopReplicaRequest</a>: <a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest" title="kafka.api.StopReplicaRequest">StopReplicaRequest</a><span class="delimiter">)</span>: <span title="(scala.collection.mutable.Map[kafka.common.TopicAndPartition,Short], Short)" class="delimiter">(</span>mutable.Map<span class="delimiter">[</span>TopicAndPartition, Short<span class="delimiter">]</span>, Short<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.replicaStateChangeLock" title="=&gt; Object">replicaStateChangeLock</a> <span title="(x$1: (scala.collection.mutable.Map[kafka.common.TopicAndPartition,Short], Short))(scala.collection.mutable.Map[kafka.common.TopicAndPartition,Short], Short)">synchronized</span> <span class="delimiter">{</span>
      val <a title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short]" id="kafka.server;ReplicaManager.stopReplicas.responseMap">responseMap</a> = new collection.mutable.<span title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short]">HashMap</span><span class="delimiter">[</span>TopicAndPartition, Short<span class="delimiter">]</span>
      if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d received stop replica request from an old controller epoch %d.&quot;</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span> <span title="(x$1: Any)String">+</span>
          <span title="String(&quot; Latest known controller epoch is %d &quot;)" class="string">&quot; Latest known controller epoch is %d &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span>
        <span title="(_1: scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short], _2: Short)(scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short], Short)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.responseMap" title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short]">responseMap</a>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.StaleControllerEpochCode" title="=&gt; Short">StaleControllerEpochCode</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="(x$1: Int)Unit">controllerEpoch</a> = <a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>
        <span class="comment">// First stop fetchers for all partitions, then stop the corresponding replicas</span>
        <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="AbstractFetcherManager.scala.html#kafka.server;AbstractFetcherManager.removeFetcherForPartitions" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">removeFetcherForPartitions</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.partitions" title="=&gt; scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(f: kafka.common.TopicAndPartition =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.common.TopicAndPartition],kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]])scala.collection.Set[kafka.common.TopicAndPartition]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]]" class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;ReplicaManager.stopReplicas.$anonfun.r">r</a> =&gt; <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.r" title="kafka.common.TopicAndPartition">r</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.r" title="kafka.common.TopicAndPartition">r</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
        for<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;ReplicaManager.stopReplicas.$anonfun.topicAndPartition">topicAndPartition</a> &lt;- <a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.partitions" title="(f: kafka.common.TopicAndPartition =&gt; Option[Short])Unit">partitions</a><span class="delimiter">)</span><span class="delimiter">{</span>
          val <a title="Short" id="kafka.server;ReplicaManager.stopReplicas.$anonfun.errorCode">errorCode</a> = <a href="#kafka.server;ReplicaManager.stopReplica" title="(topic: String, partitionId: Int, deletePartition: Boolean)Short">stopReplica</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a>, <a href="#kafka.server;ReplicaManager.stopReplicas.stopReplicaRequest" title="kafka.api.StopReplicaRequest">stopReplicaRequest</a>.<a href="../api/StopReplicaRequest.scala.html#kafka.api;StopReplicaRequest.deletePartitions" title="=&gt; Boolean">deletePartitions</a><span class="delimiter">)</span>
          <a href="#kafka.server;ReplicaManager.stopReplicas.responseMap" title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short]">responseMap</a>.<span title="(key: kafka.common.TopicAndPartition, value: Short)Option[Short]">put</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>, <a href="#kafka.server;ReplicaManager.stopReplicas.$anonfun.errorCode" title="Short">errorCode</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span title="(_1: scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short], _2: Short)(scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short], Short)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.stopReplicas.responseMap" title="scala.collection.mutable.HashMap[kafka.common.TopicAndPartition,Short]">responseMap</a>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int)kafka.cluster.Partition" id="kafka.server;ReplicaManager.getOrCreatePartition">getOrCreatePartition</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.getOrCreatePartition.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.getOrCreatePartition.partitionId">partitionId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="../cluster/Partition.scala.html#kafka.cluster;Partition" title="kafka.cluster.Partition">Partition</a> = <span class="delimiter">{</span>
    var <a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.getOrCreatePartition.partition">partition</a> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.get" title="(key: (String, Int))kafka.cluster.Partition">get</a><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getOrCreatePartition.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getOrCreatePartition.partition" title="kafka.cluster.Partition">partition</a> <span title="(x$1: Any)Boolean">==</span> null<span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.putIfNotExists" title="(k: (String, Int), v: kafka.cluster.Partition)kafka.cluster.Partition">putIfNotExists</a><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getOrCreatePartition.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>, new <a href="../cluster/Partition.scala.html#kafka.cluster;Partition" title="kafka.cluster.Partition">Partition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getOrCreatePartition.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partitionId" title="Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.time" title="kafka.utils.Time">time</a>, this<span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partition" title="kafka.cluster.Partition">partition</a> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.get" title="(key: (String, Int))kafka.cluster.Partition">get</a><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getOrCreatePartition.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.server;ReplicaManager.getOrCreatePartition.partition" title="kafka.cluster.Partition">partition</a>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int)Option[kafka.cluster.Partition]" id="kafka.server;ReplicaManager.getPartition">getPartition</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.getPartition.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.getPartition.partitionId">partitionId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Option[kafka.cluster.Partition]">Option</span><span class="delimiter">[</span>Partition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.getPartition.partition">partition</a> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.get" title="(key: (String, Int))kafka.cluster.Partition">get</a><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getPartition.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getPartition.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getPartition.partition" title="kafka.cluster.Partition">partition</a> <span title="(x$1: Any)Boolean">==</span> null<span class="delimiter">)</span>
      <span title="None.type">None</span>
    else
      <span title="(x: kafka.cluster.Partition)Some[kafka.cluster.Partition]">Some</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getPartition.partition" title="kafka.cluster.Partition">partition</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partition: Int)kafka.cluster.Replica" id="kafka.server;ReplicaManager.getReplicaOrException">getReplicaOrException</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.getReplicaOrException.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.getReplicaOrException.partition">partition</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="../cluster/Replica.scala.html#kafka.cluster;Replica" title="kafka.cluster.Replica">Replica</a> = <span class="delimiter">{</span>
    val <a title="Option[kafka.cluster.Replica]" id="kafka.server;ReplicaManager.getReplicaOrException.replicaOpt">replicaOpt</a> = <a href="#kafka.server;ReplicaManager.getReplica" title="(topic: String, partitionId: Int, replicaId: Int)Option[kafka.cluster.Replica]">getReplica</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getReplicaOrException.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getReplicaOrException.partition" title="Int">partition</a><span class="delimiter">)</span>
    if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getReplicaOrException.replicaOpt" title="Option[kafka.cluster.Replica]">replicaOpt</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>
      return <a href="#kafka.server;ReplicaManager.getReplicaOrException.replicaOpt" title="Option[kafka.cluster.Replica]">replicaOpt</a>.<span title="=&gt; kafka.cluster.Replica">get</span>
    else
      throw new <a href="../common/ReplicaNotAvailableException.scala.html#kafka.common;ReplicaNotAvailableException" title="kafka.common.ReplicaNotAvailableException">ReplicaNotAvailableException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Replica %d is not available for partition [%s,%d]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a>, <a href="#kafka.server;ReplicaManager.getReplicaOrException.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getReplicaOrException.partition" title="Int">partition</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int)kafka.cluster.Replica" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal">getLeaderReplicaIfLocal</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionId">partitionId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <a href="../cluster/Replica.scala.html#kafka.cluster;Replica" title="kafka.cluster.Replica">Replica</a> =  <span class="delimiter">{</span>
    val <a title="Option[kafka.cluster.Partition]" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionOpt">partitionOpt</a> = <a href="#kafka.server;ReplicaManager.getPartition" title="(topic: String, partitionId: Int)Option[kafka.cluster.Partition]">getPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionOpt" title="Option[kafka.cluster.Partition]">partitionOpt</a> match <span class="delimiter">{</span>
      case <span title="None.type">None</span> =&gt;
        throw new <a href="../common/UnknownTopicOrPartitionException.scala.html#kafka.common;UnknownTopicOrPartitionException" title="kafka.common.UnknownTopicOrPartitionException">UnknownTopicOrPartitionException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition [%s,%d] doesn't exist on %d&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionId" title="Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
      case Some<span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partition">partition</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.leaderReplicaIfLocal" title="()Option[kafka.cluster.Replica]">leaderReplicaIfLocal</a> match <span class="delimiter">{</span>
          case Some<span class="delimiter">(</span><a title="kafka.cluster.Replica" id="kafka.server;ReplicaManager.getLeaderReplicaIfLocal.leaderReplica">leaderReplica</a><span class="delimiter">)</span> =&gt; <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.leaderReplica" title="kafka.cluster.Replica">leaderReplica</a>
          case <span title="None.type">None</span> =&gt;
            throw new <a href="../common/NotLeaderForPartitionException.scala.html#kafka.common;NotLeaderForPartitionException" title="kafka.common.NotLeaderForPartitionException">NotLeaderForPartitionException</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Leader not local for partition [%s,%d] on broker %d&quot;</span>
                                                     .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal.partitionId" title="Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int, replicaId: Int)Option[kafka.cluster.Replica]" id="kafka.server;ReplicaManager.getReplica">getReplica</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.getReplica.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.getReplica.partitionId">partitionId</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.server;ReplicaManager.getReplica$default$3">replicaId</a>: <span title="Int">Int</span> = <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span>: <span title="Option[kafka.cluster.Replica]">Option</span><span class="delimiter">[</span>Replica<span class="delimiter">]</span> =  <span class="delimiter">{</span>
    val <a title="Option[kafka.cluster.Partition]" id="kafka.server;ReplicaManager.getReplica.partitionOpt">partitionOpt</a> = <a href="#kafka.server;ReplicaManager.getPartition" title="(topic: String, partitionId: Int)Option[kafka.cluster.Partition]">getPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getReplica.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.getReplica.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.getReplica.partitionOpt" title="Option[kafka.cluster.Partition]">partitionOpt</a> match <span class="delimiter">{</span>
      case <span title="None.type">None</span> =&gt; <span title="None.type">None</span>
      case Some<span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.getReplica.partition">partition</a><span class="delimiter">)</span> =&gt; <a href="#kafka.server;ReplicaManager.getReplica.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getReplica" title="(replicaId: Int)Option[kafka.cluster.Replica]">getReplica</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getReplica$default$3" title="Int">replicaId</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Read from all the offset details given and return a map of
   * (topic, partition) -&gt; PartitionData
   */</span>
  def <a title="(fetchRequest: kafka.api.FetchRequest)scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.PartitionDataAndOffset]" id="kafka.server;ReplicaManager.readMessageSets">readMessageSets</a><span class="delimiter">(</span><a title="kafka.api.FetchRequest" id="kafka.server;ReplicaManager.readMessageSets.fetchRequest">fetchRequest</a>: <a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest" title="kafka.api.FetchRequest">FetchRequest</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    val <a title="Boolean" id="kafka.server;ReplicaManager.readMessageSets.isFetchFromFollower">isFetchFromFollower</a> = <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.isFromFollower" title="=&gt; Boolean">isFromFollower</a>
    <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.requestInfo" title="=&gt; scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.api.PartitionFetchInfo]">requestInfo</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.api.PartitionFetchInfo)) =&gt; (kafka.common.TopicAndPartition, kafka.server.PartitionDataAndOffset))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.api.PartitionFetchInfo],(kafka.common.TopicAndPartition, kafka.server.PartitionDataAndOffset),scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.PartitionDataAndOffset]])scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.PartitionDataAndOffset]">map</span>
    <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.x0$1" title="(kafka.common.TopicAndPartition, kafka.server.PartitionDataAndOffset)" class="delimiter">{</a>
      case <span class="delimiter">(</span>TopicAndPartition<span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.topic">topic</a>, <a title="Int" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partition">partition</a><span class="delimiter">)</span>, PartitionFetchInfo<span class="delimiter">(</span><a title="Long" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.offset">offset</a>, <a title="Int" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.fetchSize">fetchSize</a><span class="delimiter">)</span><span class="delimiter">)</span> =&gt;
        val <a title="kafka.server.PartitionDataAndOffset" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo">partitionDataAndOffsetInfo</a> =
          try <span class="delimiter">{</span>
            val <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo" title="(kafka.server.FetchDataInfo, Long)" class="delimiter">(</a><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.x$4" title="kafka.server.FetchDataInfo" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo">fetchInfo</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.x$4" title="Long" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.highWatermark">highWatermark</a><span class="delimiter">)</span> = <a href="#kafka.server;ReplicaManager.readMessageSet" title="(topic: String, partition: Int, offset: Long, maxSize: Int, fromReplicaId: Int)(kafka.server.FetchDataInfo, Long)">readMessageSet</a><span title="(kafka.server.FetchDataInfo, Long) @unchecked" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.offset" title="Long">offset</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.fetchSize" title="Int">fetchSize</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.replicaId" title="=&gt; Int">replicaId</a><span class="delimiter">)</span>
            <a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats" title="kafka.server.BrokerTopicStats.type">BrokerTopicStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats.getBrokerTopicStats" title="(topic: String)kafka.server.BrokerTopicMetrics">getBrokerTopicStats</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span>.<a href="KafkaRequestHandler.scala.html#kafka.server;BrokerTopicMetrics.bytesOutRate" title="=&gt; com.yammer.metrics.core.Meter">bytesOutRate</a>.<span title="(x$1: Long)Unit">mark</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo" title="kafka.server.FetchDataInfo">fetchInfo</a>.<a href="FetchDataInfo.scala.html#kafka.server;FetchDataInfo.messageSet" title="=&gt; kafka.message.MessageSet">messageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message;MessageSet.sizeInBytes" title="=&gt; Long">sizeInBytes</a><span class="delimiter">)</span>
            <a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats" title="kafka.server.BrokerTopicStats.type">BrokerTopicStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats.getBrokerAllTopicsStats" title="()kafka.server.BrokerTopicMetrics">getBrokerAllTopicsStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server;BrokerTopicMetrics.bytesOutRate" title="=&gt; com.yammer.metrics.core.Meter">bytesOutRate</a>.<span title="(x$1: Long)Unit">mark</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo" title="kafka.server.FetchDataInfo">fetchInfo</a>.<a href="FetchDataInfo.scala.html#kafka.server;FetchDataInfo.messageSet" title="=&gt; kafka.message.MessageSet">messageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message;MessageSet.sizeInBytes" title="=&gt; Long">sizeInBytes</a><span class="delimiter">)</span>
            if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.isFetchFromFollower" title="Boolean">isFetchFromFollower</a><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Partition [%s,%d] received fetch request from follower %d&quot;</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.replicaId" title="=&gt; Int">replicaId</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
            new <a href="#kafka.server.PartitionDataAndOffset.readResolve" title="kafka.server.PartitionDataAndOffset">PartitionDataAndOffset</a><span class="delimiter">(</span>new <a href="../api/FetchResponse.scala.html#kafka.api;FetchResponsePartitionData" title="kafka.api.FetchResponsePartitionData">FetchResponsePartitionData</a><span class="delimiter">(</span><a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.highWatermark" title="Long">highWatermark</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo" title="kafka.server.FetchDataInfo">fetchInfo</a>.<a href="FetchDataInfo.scala.html#kafka.server;FetchDataInfo.messageSet" title="=&gt; kafka.message.MessageSet">messageSet</a><span class="delimiter">)</span>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.fetchInfo" title="kafka.server.FetchDataInfo">fetchInfo</a>.<a href="FetchDataInfo.scala.html#kafka.server;FetchDataInfo.fetchOffset" title="=&gt; kafka.server.LogOffsetMetadata">fetchOffset</a><span class="delimiter">)</span>
          <span class="delimiter">}</span> catch <span class="delimiter">{</span>
            <span class="comment">// NOTE: Failed fetch requests is not incremented for UnknownTopicOrPartitionException and NotLeaderForPartitionException</span>
            <span class="comment">// since failed fetch requests metric is supposed to indicate failure of a broker in handling a fetch request</span>
            <span class="comment">// for a partition it is the leader for</span>
            case <a title="kafka.common.UnknownTopicOrPartitionException" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.utpe">utpe</a>: <a href="../common/UnknownTopicOrPartitionException.scala.html#kafka.common;UnknownTopicOrPartitionException" title="kafka.common.UnknownTopicOrPartitionException">UnknownTopicOrPartitionException</a> =&gt;
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Fetch request with correlation id %d from client %s on partition [%s,%d] failed due to %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
                <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.clientId" title="=&gt; String">clientId</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.utpe" title="kafka.common.UnknownTopicOrPartitionException">utpe</a>.<span title="()String">getMessage</span><span class="delimiter">)</span><span class="delimiter">)</span>
              new <a href="#kafka.server.PartitionDataAndOffset.readResolve" title="kafka.server.PartitionDataAndOffset">PartitionDataAndOffset</a><span class="delimiter">(</span>new <a href="../api/FetchResponse.scala.html#kafka.api;FetchResponsePartitionData" title="kafka.api.FetchResponsePartitionData">FetchResponsePartitionData</a><span class="delimiter">(</span><a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.codeFor" title="(exception: Class[Throwable])Short">codeFor</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.utpe" title="kafka.common.UnknownTopicOrPartitionException">utpe</a>.<span title="()Class[_]">getClass</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[Throwable]" class="delimiter">[</span><span title="Class[Throwable]">Class</span><span class="delimiter">[</span>Throwable<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, -<span title="Long(-1L)" class="long">1L</span>, <a href="../message/MessageSet.scala.html#kafka.message.MessageSet" title="kafka.message.MessageSet.type">MessageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message.MessageSet.Empty" title="=&gt; kafka.message.ByteBufferMessageSet">Empty</a><span class="delimiter">)</span>, <a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata" title="kafka.server.LogOffsetMetadata.type">LogOffsetMetadata</a>.<a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata.UnknownOffsetMetadata" title="=&gt; kafka.server.LogOffsetMetadata">UnknownOffsetMetadata</a><span class="delimiter">)</span>
            case <a title="kafka.common.NotLeaderForPartitionException" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.nle">nle</a>: <a href="../common/NotLeaderForPartitionException.scala.html#kafka.common;NotLeaderForPartitionException" title="kafka.common.NotLeaderForPartitionException">NotLeaderForPartitionException</a> =&gt;
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Fetch request with correlation id %d from client %s on partition [%s,%d] failed due to %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span>
                <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.clientId" title="=&gt; String">clientId</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.nle" title="kafka.common.NotLeaderForPartitionException">nle</a>.<span title="()String">getMessage</span><span class="delimiter">)</span><span class="delimiter">)</span>
              new <a href="#kafka.server.PartitionDataAndOffset.readResolve" title="kafka.server.PartitionDataAndOffset">PartitionDataAndOffset</a><span class="delimiter">(</span>new <a href="../api/FetchResponse.scala.html#kafka.api;FetchResponsePartitionData" title="kafka.api.FetchResponsePartitionData">FetchResponsePartitionData</a><span class="delimiter">(</span><a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.codeFor" title="(exception: Class[Throwable])Short">codeFor</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.nle" title="kafka.common.NotLeaderForPartitionException">nle</a>.<span title="()Class[_]">getClass</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[Throwable]" class="delimiter">[</span><span title="Class[Throwable]">Class</span><span class="delimiter">[</span>Throwable<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, -<span title="Long(-1L)" class="long">1L</span>, <a href="../message/MessageSet.scala.html#kafka.message.MessageSet" title="kafka.message.MessageSet.type">MessageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message.MessageSet.Empty" title="=&gt; kafka.message.ByteBufferMessageSet">Empty</a><span class="delimiter">)</span>, <a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata" title="kafka.server.LogOffsetMetadata.type">LogOffsetMetadata</a>.<a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata.UnknownOffsetMetadata" title="=&gt; kafka.server.LogOffsetMetadata">UnknownOffsetMetadata</a><span class="delimiter">)</span>
            case <a title="Throwable" id="kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.t">t</a>: <span title="Throwable">Throwable</span> =&gt;
              <a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats" title="kafka.server.BrokerTopicStats.type">BrokerTopicStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats.getBrokerTopicStats" title="(topic: String)kafka.server.BrokerTopicMetrics">getBrokerTopicStats</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a><span class="delimiter">)</span>.<a href="KafkaRequestHandler.scala.html#kafka.server;BrokerTopicMetrics.failedFetchRequestRate" title="=&gt; com.yammer.metrics.core.Meter">failedFetchRequestRate</a>.<span title="()Unit">mark</span><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats" title="kafka.server.BrokerTopicStats.type">BrokerTopicStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server.BrokerTopicStats.getBrokerAllTopicsStats" title="()kafka.server.BrokerTopicMetrics">getBrokerAllTopicsStats</a>.<a href="KafkaRequestHandler.scala.html#kafka.server;BrokerTopicMetrics.failedFetchRequestRate" title="=&gt; com.yammer.metrics.core.Meter">failedFetchRequestRate</a>.<span title="()Unit">mark</span><span class="delimiter">(</span><span class="delimiter">)</span>
              <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Error when processing fetch request for partition [%s,%d] offset %d from %s with correlation id %d. Possible cause: %s&quot;</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.offset" title="Long">offset</a>, if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.isFetchFromFollower" title="Boolean">isFetchFromFollower</a><span class="delimiter">)</span> <span title="String(&quot;follower&quot;)" class="string">&quot;follower&quot;</span> else <span title="String(&quot;consumer&quot;)" class="string">&quot;consumer&quot;</span>, <a href="#kafka.server;ReplicaManager.readMessageSets.fetchRequest" title="kafka.api.FetchRequest">fetchRequest</a>.<a href="../api/FetchRequest.scala.html#kafka.api;FetchRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.t" title="Throwable">t</a>.<span title="()String">getMessage</span><span class="delimiter">)</span><span class="delimiter">)</span>
              new <a href="#kafka.server.PartitionDataAndOffset.readResolve" title="kafka.server.PartitionDataAndOffset">PartitionDataAndOffset</a><span class="delimiter">(</span>new <a href="../api/FetchResponse.scala.html#kafka.api;FetchResponsePartitionData" title="kafka.api.FetchResponsePartitionData">FetchResponsePartitionData</a><span class="delimiter">(</span><a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.codeFor" title="(exception: Class[Throwable])Short">codeFor</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo.t" title="Throwable">t</a>.<span title="()Class[_]">getClass</span>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="Class[Throwable]" class="delimiter">[</span><span title="Class[Throwable]">Class</span><span class="delimiter">[</span>Throwable<span class="delimiter">]</span><span class="delimiter">]</span><span class="delimiter">)</span>, -<span title="Long(-1L)" class="long">1L</span>, <a href="../message/MessageSet.scala.html#kafka.message.MessageSet" title="kafka.message.MessageSet.type">MessageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message.MessageSet.Empty" title="=&gt; kafka.message.ByteBufferMessageSet">Empty</a><span class="delimiter">)</span>, <a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata" title="kafka.server.LogOffsetMetadata.type">LogOffsetMetadata</a>.<a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata.UnknownOffsetMetadata" title="=&gt; kafka.server.LogOffsetMetadata">UnknownOffsetMetadata</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span title="(_1: kafka.common.TopicAndPartition, _2: kafka.server.PartitionDataAndOffset)(kafka.common.TopicAndPartition, kafka.server.PartitionDataAndOffset)" class="delimiter">(</span><a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partition" title="Int">partition</a><span class="delimiter">)</span>, <a href="#kafka.server;ReplicaManager.readMessageSets.$anonfun.partitionDataAndOffsetInfo" title="kafka.server.PartitionDataAndOffset">partitionDataAndOffsetInfo</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Read from a single topic/partition at the given offset upto maxSize bytes
   */</span>
  private def <a title="(topic: String, partition: Int, offset: Long, maxSize: Int, fromReplicaId: Int)(kafka.server.FetchDataInfo, Long)" id="kafka.server;ReplicaManager.readMessageSet">readMessageSet</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.readMessageSet.topic">topic</a>: <span title="String">String</span>,
                             <a title="Int" id="kafka.server;ReplicaManager.readMessageSet.partition">partition</a>: <span title="Int">Int</span>,
                             <a title="Long" id="kafka.server;ReplicaManager.readMessageSet.offset">offset</a>: <span title="Long">Long</span>,
                             <a title="Int" id="kafka.server;ReplicaManager.readMessageSet.maxSize">maxSize</a>: <span title="Int">Int</span>,
                             <a title="Int" id="kafka.server;ReplicaManager.readMessageSet.fromReplicaId">fromReplicaId</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="(kafka.server.FetchDataInfo, Long)" class="delimiter">(</span>FetchDataInfo, Long<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <span class="comment">// check if the current broker is the leader for the partitions</span>
    val <a title="kafka.cluster.Replica" id="kafka.server;ReplicaManager.readMessageSet.localReplica">localReplica</a> = if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.fromReplicaId" title="Int">fromReplicaId</a> <span title="(x: Int)Boolean">==</span> <a href="../api/RequestOrResponse.scala.html#kafka.api.Request" title="kafka.api.Request.type">Request</a>.<a href="../api/RequestOrResponse.scala.html#kafka.api.Request.DebuggingConsumerId" title="=&gt; Int">DebuggingConsumerId</a><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.getReplicaOrException" title="(topic: String, partition: Int)kafka.cluster.Replica">getReplicaOrException</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.partition" title="Int">partition</a><span class="delimiter">)</span>
    else
      <a href="#kafka.server;ReplicaManager.getLeaderReplicaIfLocal" title="(topic: String, partitionId: Int)kafka.cluster.Replica">getLeaderReplicaIfLocal</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.partition" title="Int">partition</a><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="String(&quot;Fetching log segment for topic, partition, offset, size = &quot;)" class="string">&quot;Fetching log segment for topic, partition, offset, size = &quot;</span> <span title="(x$1: Any)String">+</span> <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.partition" title="Int">partition</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.offset" title="Long">offset</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.maxSize" title="Int">maxSize</a><span class="delimiter">)</span><span class="delimiter">)</span>
    val <a title="Option[Long]" id="kafka.server;ReplicaManager.readMessageSet.maxOffsetOpt">maxOffsetOpt</a> =
      if <span class="delimiter">(</span><a href="../api/RequestOrResponse.scala.html#kafka.api.Request" title="kafka.api.Request.type">Request</a>.<a href="../api/RequestOrResponse.scala.html#kafka.api.Request.isValidBrokerId" title="(brokerId: Int)Boolean">isValidBrokerId</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.fromReplicaId" title="Int">fromReplicaId</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span title="None.type">None</span>
      else
        <span title="(x: Long)Some[Long]">Some</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.localReplica" title="kafka.cluster.Replica">localReplica</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.highWatermark" title="=&gt; kafka.server.LogOffsetMetadata">highWatermark</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a><span class="delimiter">)</span>
    val <a title="kafka.server.FetchDataInfo" id="kafka.server;ReplicaManager.readMessageSet.fetchInfo">fetchInfo</a> = <a href="#kafka.server;ReplicaManager.readMessageSet.localReplica" title="kafka.cluster.Replica">localReplica</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.log" title="=&gt; Option[kafka.log.Log]">log</a> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.log.Log" id="kafka.server;ReplicaManager.readMessageSet.fetchInfo.log">log</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.server;ReplicaManager.readMessageSet.fetchInfo.log" title="kafka.log.Log">log</a>.<a href="../log/Log.scala.html#kafka.log;Log.read" title="(startOffset: Long, maxLength: Int, maxOffset: Option[Long])kafka.server.FetchDataInfo">read</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.offset" title="Long">offset</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.maxSize" title="Int">maxSize</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.maxOffsetOpt" title="Option[Long]">maxOffsetOpt</a><span class="delimiter">)</span>
      case <span title="None.type">None</span> =&gt;
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Leader for partition [%s,%d] does not have a local log&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.partition" title="Int">partition</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <a href="FetchDataInfo.scala.html#kafka.server;FetchDataInfo" title="(fetchOffset: kafka.server.LogOffsetMetadata, messageSet: kafka.message.MessageSet)kafka.server.FetchDataInfo">FetchDataInfo</a><span class="delimiter">(</span><a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata" title="kafka.server.LogOffsetMetadata.type">LogOffsetMetadata</a>.<a href="LogOffsetMetadata.scala.html#kafka.server.LogOffsetMetadata.UnknownOffsetMetadata" title="=&gt; kafka.server.LogOffsetMetadata">UnknownOffsetMetadata</a>, <a href="../message/MessageSet.scala.html#kafka.message.MessageSet" title="kafka.message.MessageSet.type">MessageSet</a>.<a href="../message/MessageSet.scala.html#kafka.message.MessageSet.Empty" title="=&gt; kafka.message.ByteBufferMessageSet">Empty</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <span title="(_1: kafka.server.FetchDataInfo, _2: Long)(kafka.server.FetchDataInfo, Long)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.readMessageSet.fetchInfo" title="kafka.server.FetchDataInfo">fetchInfo</a>, <a href="#kafka.server;ReplicaManager.readMessageSet.localReplica" title="kafka.cluster.Replica">localReplica</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.highWatermark" title="=&gt; kafka.server.LogOffsetMetadata">highWatermark</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(updateMetadataRequest: kafka.api.UpdateMetadataRequest, metadataCache: kafka.server.MetadataCache)Unit" id="kafka.server;ReplicaManager.maybeUpdateMetadataCache">maybeUpdateMetadataCache</a><span class="delimiter">(</span><a title="kafka.api.UpdateMetadataRequest" id="kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest">updateMetadataRequest</a>: <a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest" title="kafka.api.UpdateMetadataRequest">UpdateMetadataRequest</a>, <a title="kafka.server.MetadataCache" id="kafka.server;ReplicaManager.maybeUpdateMetadataCache.metadataCache">metadataCache</a>: <a href="MetadataCache.scala.html#kafka.server;MetadataCache" title="kafka.server.MetadataCache">MetadataCache</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.replicaStateChangeLock" title="=&gt; Object">replicaStateChangeLock</a> <span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>.<a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        val <a title="String" id="kafka.server;ReplicaManager.maybeUpdateMetadataCache.stateControllerEpochErrorMessage">stateControllerEpochErrorMessage</a> = <span class="delimiter">(</span><span class="string">&quot;Broker %d received update metadata request with correlation id %d from an &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;old controller %d with epoch %d. Latest known controller epoch is %d&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>,
          <a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>.<a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>.<a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>.<a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>,
          <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span>
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.stateControllerEpochErrorMessage" title="String">stateControllerEpochErrorMessage</a><span class="delimiter">)</span>
        throw new <a href="../common/ControllerMovedException.scala.html#kafka.common;ControllerMovedException" title="kafka.common.ControllerMovedException">ControllerMovedException</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.stateControllerEpochErrorMessage" title="String">stateControllerEpochErrorMessage</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.metadataCache" title="kafka.server.MetadataCache">metadataCache</a>.<a href="MetadataCache.scala.html#kafka.server;MetadataCache.updateCache" title="(updateMetadataRequest: kafka.api.UpdateMetadataRequest, brokerId: Int, stateChangeLogger: kafka.controller.KafkaController.StateChangeLogger)Unit">updateCache</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>, <a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a><span class="delimiter">)</span>
        <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="(x$1: Int)Unit">controllerEpoch</a> = <a href="#kafka.server;ReplicaManager.maybeUpdateMetadataCache.updateMetadataRequest" title="kafka.api.UpdateMetadataRequest">updateMetadataRequest</a>.<a href="../api/UpdateMetadataRequest.scala.html#kafka.api;UpdateMetadataRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="(leaderAndISRRequest: kafka.api.LeaderAndIsrRequest, offsetManager: kafka.server.OffsetManager)(scala.collection.Map[(String, Int),Short], Short)" id="kafka.server;ReplicaManager.becomeLeaderOrFollower">becomeLeaderOrFollower</a><span class="delimiter">(</span><a title="kafka.api.LeaderAndIsrRequest" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest">leaderAndISRRequest</a>: <a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest" title="kafka.api.LeaderAndIsrRequest">LeaderAndIsrRequest</a>,
                             <a title="kafka.server.OffsetManager" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.offsetManager">offsetManager</a>: <a href="OffsetManager.scala.html#kafka.server;OffsetManager" title="kafka.server.OffsetManager">OffsetManager</a><span class="delimiter">)</span>: <span title="(scala.collection.Map[(String, Int),Short], Short)" class="delimiter">(</span>collection.Map<span class="delimiter">[</span><span class="delimiter">(</span>String, Int<span class="delimiter">)</span>, Short<span class="delimiter">]</span>, Short<span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.partitionStateInfos" title="=&gt; Map[(String, Int),kafka.api.PartitionStateInfo]">partitionStateInfos</a>.<span title="(f: (((String, Int), kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.x0$2" title="Unit" class="delimiter">{</a> case <span class="delimiter">(</span><span class="delimiter">(</span><span title="String">topic</span>, <span title="Int">partition</span><span class="delimiter">)</span>, <span title="kafka.api.PartitionStateInfo">stateInfo</span><span class="delimiter">)</span> =&gt;
      <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Broker %d received LeaderAndIsr request %s correlation id %d from controller %d epoch %d for partition [%s,%d]&quot;</span>
                                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <span title="kafka.api.PartitionStateInfo">stateInfo</span>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.correlationId" title="=&gt; Int">correlationId</a>,
                                        <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerId" title="=&gt; Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>, <span title="String">topic</span>, <span title="Int">partition</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#kafka.server;ReplicaManager.replicaStateChangeLock" title="=&gt; Object">replicaStateChangeLock</a> <span title="(x$1: (scala.collection.Map[(String, Int),Short], Short))(scala.collection.Map[(String, Int),Short], Short)">synchronized</span> <span class="delimiter">{</span>
      val <a title="scala.collection.mutable.HashMap[(String, Int),Short]" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap">responseMap</a> = new collection.mutable.<span title="scala.collection.mutable.HashMap[(String, Int),Short]">HashMap</span><span class="delimiter">[</span><span class="delimiter">(</span>String, Int<span class="delimiter">)</span>, Short<span class="delimiter">]</span>
      if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.partitionStateInfos" title="=&gt; Map[(String, Int),kafka.api.PartitionStateInfo]">partitionStateInfos</a>.<span title="(f: (((String, Int), kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.x0$3" title="Unit" class="delimiter">{</a> case <span class="delimiter">(</span><span class="delimiter">(</span><span title="String">topic</span>, <span title="Int">partition</span><span class="delimiter">)</span>, <span title="kafka.api.PartitionStateInfo">stateInfo</span><span class="delimiter">)</span> =&gt;
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d since &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;its controller epoch %d is old. Latest known controller epoch is %d&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerId" title="=&gt; Int">controllerId</a>,
          <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>, <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span title="(_1: scala.collection.mutable.HashMap[(String, Int),Short], _2: Short)(scala.collection.mutable.HashMap[(String, Int),Short], Short)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap" title="scala.collection.mutable.HashMap[(String, Int),Short]">responseMap</a>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.StaleControllerEpochCode" title="=&gt; Short">StaleControllerEpochCode</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <span class="delimiter">{</span>
        val <a title="Int" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.controllerId">controllerId</a> = <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerId" title="=&gt; Int">controllerId</a>
        val <a title="Int" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.correlationId">correlationId</a> = <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.correlationId" title="=&gt; Int">correlationId</a>
        <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="(x$1: Int)Unit">controllerEpoch</a> = <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>

        <span class="comment">// First check partition's leader epoch</span>
        val <a title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionState">partitionState</a> = new <span title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">HashMap</span><span class="delimiter">[</span>Partition, PartitionStateInfo<span class="delimiter">]</span><span class="delimiter">(</span><span class="delimiter">)</span>
        <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.partitionStateInfos" title="=&gt; Map[(String, Int),kafka.api.PartitionStateInfo]">partitionStateInfos</a>.<span title="(f: (((String, Int), kafka.api.PartitionStateInfo)) =&gt; Any)Unit">foreach</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.x0$4" title="Any" class="delimiter">{</a> case <span class="delimiter">(</span><span class="delimiter">(</span><span title="String">topic</span>, <a title="Int" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionId">partitionId</a><span class="delimiter">)</span>, <a title="kafka.api.PartitionStateInfo" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo">partitionStateInfo</a><span class="delimiter">)</span> =&gt;
          val <span title="kafka.cluster.Partition">partition</span> = <a href="#kafka.server;ReplicaManager.getOrCreatePartition" title="(topic: String, partitionId: Int)kafka.cluster.Partition">getOrCreatePartition</a><span class="delimiter">(</span><span title="String">topic</span>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>
          val <a title="Int" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionLeaderEpoch">partitionLeaderEpoch</a> = <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getLeaderEpoch" title="()Int">getLeaderEpoch</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="comment">// If the leader epoch is valid record the epoch of the controller that made the leadership decision.</span>
          <span class="comment">// This is useful while updating the isr to maintain the decision maker controller's epoch in the zookeeper path</span>
          if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionLeaderEpoch" title="Int">partitionLeaderEpoch</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.leaderIsrAndControllerEpoch" title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a><span class="delimiter">)</span> <span class="delimiter">{</span>
            if<span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.allReplicas" title="=&gt; scala.collection.Set[Int]">allReplicas</a>.<span title="(elem: Int)Boolean">contains</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionState" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(key: kafka.cluster.Partition, value: kafka.api.PartitionStateInfo)Option[kafka.api.PartitionStateInfo]">put</span><span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a><span class="delimiter">)</span>
            else <span class="delimiter">{</span>
              <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                <span class="string">&quot;epoch %d for partition [%s,%d] as itself is not in assigned replica list %s&quot;</span><span class="delimiter">)</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>,
                <span title="String">topic</span>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.allReplicas" title="=&gt; scala.collection.Set[Int]">allReplicas</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="delimiter">}</span>
          <span class="delimiter">}</span> else <span class="delimiter">{</span>
            <span class="comment">// Otherwise record the error code in response</span>
            <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d ignoring LeaderAndIsr request from controller %d with correlation id %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
              <span class="string">&quot;epoch %d for partition [%s,%d] since its associated leader epoch %d is old. Current leader epoch is %d&quot;</span><span class="delimiter">)</span>
              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.controllerEpoch" title="=&gt; Int">controllerEpoch</a>,
              <span title="String">topic</span>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.leaderIsrAndControllerEpoch" title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leaderEpoch" title="=&gt; Int">leaderEpoch</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionLeaderEpoch" title="Int">partitionLeaderEpoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap" title="scala.collection.mutable.HashMap[(String, Int),Short]">responseMap</a>.<span title="(key: (String, Int), value: Short)Option[Short]">put</span><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><span title="String">topic</span>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.$anonfun.partitionId" title="Int">partitionId</a><span class="delimiter">)</span>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.StaleLeaderEpochCode" title="=&gt; Short">StaleLeaderEpochCode</a><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        <span class="delimiter">}</span>

        val <a title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader">partitionsTobeLeader</a> = <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionState" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>
          .<span title="(p: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Boolean)scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">filter</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader.$anonfun.x0$5" title="Boolean" class="delimiter">{</a> case <span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader.$anonfun.partition">partition</a>, <a title="kafka.api.PartitionStateInfo" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader.$anonfun.partitionStateInfo">partitionStateInfo</a><span class="delimiter">)</span> =&gt; <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.leaderIsrAndControllerEpoch" title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">}</span>
        val partitionsToBeFollower = <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionState" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a> <a title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]" id="kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsToBeFollower">--</a> <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionsTobeLeader</a>.<span title="=&gt; Iterable[kafka.cluster.Partition]">keys</span><span class="delimiter">)</span>

        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionsTobeLeader</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span>
          <a href="#kafka.server;ReplicaManager.makeLeaders" title="(controllerId: Int, epoch: Int, partitionState: scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo], correlationId: Int, responseMap: scala.collection.mutable.Map[(String, Int),Short], offsetManager: kafka.server.OffsetManager)Unit">makeLeaders</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsTobeLeader" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionsTobeLeader</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap" title="scala.collection.mutable.HashMap[(String, Int),Short]">responseMap</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.offsetManager" title="kafka.server.OffsetManager">offsetManager</a><span class="delimiter">)</span>
        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsToBeFollower" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionsToBeFollower</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span>
          <a href="#kafka.server;ReplicaManager.makeFollowers" title="(controllerId: Int, epoch: Int, partitionState: scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo], leaders: scala.collection.Set[kafka.cluster.Broker], correlationId: Int, responseMap: scala.collection.mutable.Map[(String, Int),Short], offsetManager: kafka.server.OffsetManager)Unit">makeFollowers</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.controllerEpoch_=" title="=&gt; Int">controllerEpoch</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.partitionsToBeFollower" title="scala.collection.mutable.HashMap[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionsToBeFollower</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.leaders" title="=&gt; scala.collection.Set[kafka.cluster.Broker]">leaders</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.leaderAndISRRequest" title="kafka.api.LeaderAndIsrRequest">leaderAndISRRequest</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsrRequest.correlationId" title="=&gt; Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap" title="scala.collection.mutable.HashMap[(String, Int),Short]">responseMap</a>, <a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.offsetManager" title="kafka.server.OffsetManager">offsetManager</a><span class="delimiter">)</span>

        <span class="comment">// we initialize highwatermark thread after the first leaderisrrequest. This ensures that all the partitions</span>
        <span class="comment">// have been completely populated before starting the checkpointing there by avoiding weird race conditions</span>
        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#kafka.server;ReplicaManager.hwThreadInitialized_=" title="=&gt; Boolean">hwThreadInitialized</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#kafka.server;ReplicaManager.startHighWaterMarksCheckPointThread" title="()Unit">startHighWaterMarksCheckPointThread</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#kafka.server;ReplicaManager.hwThreadInitialized_=" title="(x$1: Boolean)Unit">hwThreadInitialized</a> = true
        <span class="delimiter">}</span>
        <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="AbstractFetcherManager.scala.html#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads" title="()Unit">shutdownIdleFetcherThreads</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span title="(_1: scala.collection.mutable.HashMap[(String, Int),Short], _2: Short)(scala.collection.mutable.HashMap[(String, Int),Short], Short)" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.becomeLeaderOrFollower.responseMap" title="scala.collection.mutable.HashMap[(String, Int),Short]">responseMap</a>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/*
   * Make the current broker to become leader for a given set of partitions by:
   *
   * 1. Stop fetchers for these partitions
   * 2. Update the partition metadata in cache
   * 3. Add these partitions to the leader partitions set
   *
   * If an unexpected error is thrown in this function, it will be propagated to KafkaApis where
   * the error message will be set on each partition since we do not know which partition caused it
   *  TODO: the above may need to be fixed later
   */</span>
  private def <a title="(controllerId: Int, epoch: Int, partitionState: scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo], correlationId: Int, responseMap: scala.collection.mutable.Map[(String, Int),Short], offsetManager: kafka.server.OffsetManager)Unit" id="kafka.server;ReplicaManager.makeLeaders">makeLeaders</a><span class="delimiter">(</span><a title="Int" id="kafka.server;ReplicaManager.makeLeaders.controllerId">controllerId</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.server;ReplicaManager.makeLeaders.epoch">epoch</a>: <span title="Int">Int</span>,
                          <a title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]" id="kafka.server;ReplicaManager.makeLeaders.partitionState">partitionState</a>: <span title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">Map</span><span class="delimiter">[</span>Partition, PartitionStateInfo<span class="delimiter">]</span>,
                          <a title="Int" id="kafka.server;ReplicaManager.makeLeaders.correlationId">correlationId</a>: <span title="Int">Int</span>, <a title="scala.collection.mutable.Map[(String, Int),Short]" id="kafka.server;ReplicaManager.makeLeaders.responseMap">responseMap</a>: mutable.<span title="scala.collection.mutable.Map[(String, Int),Short]">Map</span><span class="delimiter">[</span><span class="delimiter">(</span>String, Int<span class="delimiter">)</span>, Short<span class="delimiter">]</span>,
                          <a title="kafka.server.OffsetManager" id="kafka.server;ReplicaManager.makeLeaders.offsetManager">offsetManager</a>: <a href="OffsetManager.scala.html#kafka.server;OffsetManager" title="kafka.server.OffsetManager">OffsetManager</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
      <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d handling LeaderAndIsr request correlationId %d from controller %d epoch %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
        <span class="string">&quot;starting the become-leader transition for partition %s&quot;</span><span class="delimiter">)</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.epoch" title="Int">epoch</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

    for <span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span> &lt;- <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: kafka.cluster.Partition =&gt; Option[Short])Unit">keys</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.makeLeaders.responseMap" title="scala.collection.mutable.Map[(String, Int),Short]">responseMap</a>.<span title="(key: (String, Int), value: Short)Option[Short]">put</span><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a><span class="delimiter">)</span>

    try <span class="delimiter">{</span>
      <span class="comment">// First stop fetchers for all the partitions</span>
      <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="AbstractFetcherManager.scala.html#kafka.server;AbstractFetcherManager.removeFetcherForPartitions" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">removeFetcherForPartitions</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="=&gt; scala.collection.Set[kafka.cluster.Partition]">keySet</span>.<span title="(f: kafka.cluster.Partition =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.cluster.Partition],kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]])scala.collection.Set[kafka.common.TopicAndPartition]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]]" class="delimiter">(</span>new <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeLeaders.$anonfun.x$5" title="kafka.cluster.Partition">_</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d stopped fetchers as part of become-leader request from controller &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;%d epoch %d with correlation id %d for partition %s&quot;</span><span class="delimiter">)</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.epoch" title="Int">epoch</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.correlationId" title="Int">correlationId</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <span class="comment">// Update the partition information to be the leader</span>
      <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Boolean)Unit">foreach</span><a href="#kafka.server;ReplicaManager.makeLeaders.$anonfun.x0$6" title="Boolean" class="delimiter">{</a> case <span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>, <a title="kafka.api.PartitionStateInfo" id="kafka.server;ReplicaManager.makeLeaders.$anonfun.partitionStateInfo">partitionStateInfo</a><span class="delimiter">)</span> =&gt;
        <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.makeLeader" title="(controllerId: Int, partitionStateInfo: kafka.api.PartitionStateInfo, correlationId: Int, offsetManager: kafka.server.OffsetManager)Boolean">makeLeader</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeLeaders.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.offsetManager" title="kafka.server.OffsetManager">offsetManager</a><span class="delimiter">)</span><span class="delimiter">}</span>

    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.server;ReplicaManager.makeLeaders.e">e</a>: <span title="Throwable">Throwable</span> =&gt;
        <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
          val <a title="String" id="kafka.server;ReplicaManager.makeLeaders.$anonfun.errorMsg">errorMsg</a> = <span class="delimiter">(</span><span class="string">&quot;Error on broker %d while processing LeaderAndIsr request correlationId %d received from controller %d&quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
            <span class="string">&quot; epoch %d for partition %s&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.epoch" title="Int">epoch</a>,
                                                <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeLeaders.$anonfun.errorMsg" title="String">errorMsg</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.e" title="Throwable">e</a><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <span class="comment">// Re-throw the exception for it to be caught in KafkaApis</span>
        throw <a href="#kafka.server;ReplicaManager.makeLeaders.e" title="Throwable">e</a>
    <span class="delimiter">}</span>

    <a href="#kafka.server;ReplicaManager.makeLeaders.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
      <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d completed LeaderAndIsr request correlationId %d from controller %d epoch %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
        <span class="string">&quot;for the become-leader transition for partition %s&quot;</span><span class="delimiter">)</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeLeaders.epoch" title="Int">epoch</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/*
   * Make the current broker to become follower for a given set of partitions by:
   *
   * 1. Remove these partitions from the leader partitions set.
   * 2. Mark the replicas as followers so that no more data can be added from the producer clients.
   * 3. Stop fetchers for these partitions so that no more data can be added by the replica fetcher threads.
   * 4. Truncate the log and checkpoint offsets for these partitions.
   * 5. If the broker is not shutting down, add the fetcher to the new leaders.
   *
   * The ordering of doing these steps make sure that the replicas in transition will not
   * take any more messages before checkpointing offsets so that all messages before the checkpoint
   * are guaranteed to be flushed to disks
   *
   * If an unexpected error is thrown in this function, it will be propagated to KafkaApis where
   * the error message will be set on each partition since we do not know which partition caused it
   */</span>
  private def <a title="(controllerId: Int, epoch: Int, partitionState: scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo], leaders: scala.collection.Set[kafka.cluster.Broker], correlationId: Int, responseMap: scala.collection.mutable.Map[(String, Int),Short], offsetManager: kafka.server.OffsetManager)Unit" id="kafka.server;ReplicaManager.makeFollowers">makeFollowers</a><span class="delimiter">(</span><a title="Int" id="kafka.server;ReplicaManager.makeFollowers.controllerId">controllerId</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.server;ReplicaManager.makeFollowers.epoch">epoch</a>: <span title="Int">Int</span>, <a title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]" id="kafka.server;ReplicaManager.makeFollowers.partitionState">partitionState</a>: <span title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">Map</span><span class="delimiter">[</span>Partition, PartitionStateInfo<span class="delimiter">]</span>,
                            <a title="scala.collection.Set[kafka.cluster.Broker]" id="kafka.server;ReplicaManager.makeFollowers.leaders">leaders</a>: <span title="scala.collection.Set[kafka.cluster.Broker]">Set</span><span class="delimiter">[</span>Broker<span class="delimiter">]</span>, <a title="Int" id="kafka.server;ReplicaManager.makeFollowers.correlationId">correlationId</a>: <span title="Int">Int</span>, <a title="scala.collection.mutable.Map[(String, Int),Short]" id="kafka.server;ReplicaManager.makeFollowers.responseMap">responseMap</a>: mutable.<span title="scala.collection.mutable.Map[(String, Int),Short]">Map</span><span class="delimiter">[</span><span class="delimiter">(</span>String, Int<span class="delimiter">)</span>, Short<span class="delimiter">]</span>,
                            <a title="kafka.server.OffsetManager" id="kafka.server;ReplicaManager.makeFollowers.offsetManager">offsetManager</a>: <a href="OffsetManager.scala.html#kafka.server;OffsetManager" title="kafka.server.OffsetManager">OffsetManager</a><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.makeFollowers.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
      <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d handling LeaderAndIsr request correlationId %d from controller %d epoch %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
        <span class="string">&quot;starting the become-follower transition for partition %s&quot;</span><span class="delimiter">)</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>

    for <span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span> &lt;- <a href="#kafka.server;ReplicaManager.makeFollowers.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: kafka.cluster.Partition =&gt; Option[Short])Unit">keys</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.makeFollowers.responseMap" title="scala.collection.mutable.Map[(String, Int),Short]">responseMap</a>.<span title="(key: (String, Int), value: Short)Option[Short]">put</span><span class="delimiter">(</span><span title="(_1: String, _2: Int)(String, Int)" class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span>, <a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping" title="kafka.common.ErrorMapping.type">ErrorMapping</a>.<a href="../common/ErrorMapping.scala.html#kafka.common.ErrorMapping.NoError" title="=&gt; Short">NoError</a><span class="delimiter">)</span>

    try <span class="delimiter">{</span>

      var <a title="scala.collection.Set[kafka.cluster.Partition]" id="kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower">partitionsToMakeFollower</a>: <span title="scala.collection.Set[kafka.cluster.Partition]">Set</span><span class="delimiter">[</span>Partition<span class="delimiter">]</span> = <span title="(elems: kafka.cluster.Partition*)scala.collection.Set[kafka.cluster.Partition]">Set</span><span class="delimiter">(</span><span class="delimiter">)</span>

      <span class="comment">// TODO: Delete leaders from LeaderAndIsrRequest in 0.8.1</span>
      <a href="#kafka.server;ReplicaManager.makeFollowers.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Any)Unit">foreach</span><a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.x0$7" title="Any" class="delimiter">{</a> case <span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>, <a title="kafka.api.PartitionStateInfo" id="kafka.server;ReplicaManager.makeFollowers.$anonfun.partitionStateInfo">partitionStateInfo</a><span class="delimiter">)</span> =&gt;
        val <a title="kafka.controller.LeaderIsrAndControllerEpoch" id="kafka.server;ReplicaManager.makeFollowers.$anonfun.leaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a> = <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;PartitionStateInfo.leaderIsrAndControllerEpoch" title="=&gt; kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>
        val <a title="Int" id="kafka.server;ReplicaManager.makeFollowers.$anonfun.newLeaderBrokerId">newLeaderBrokerId</a> = <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.leaderAndIsr" title="=&gt; kafka.api.LeaderAndIsr">leaderAndIsr</a>.<a href="../api/LeaderAndIsrRequest.scala.html#kafka.api;LeaderAndIsr.leader" title="=&gt; Int">leader</a>
        <a href="#kafka.server;ReplicaManager.makeFollowers.leaders" title="scala.collection.Set[kafka.cluster.Broker]">leaders</a>.<span title="(p: kafka.cluster.Broker =&gt; Boolean)Option[kafka.cluster.Broker]">find</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.$anonfun.x$6" title="kafka.cluster.Broker">_</a>.<a href="../cluster/Broker.scala.html#kafka.cluster;Broker.id" title="=&gt; Int">id</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.newLeaderBrokerId" title="Int">newLeaderBrokerId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
          <span class="comment">// Only change partition state when the leader is available</span>
          case Some<span class="delimiter">(</span><a title="kafka.cluster.Broker" id="kafka.server;ReplicaManager.makeFollowers.$anonfun.leaderBroker">leaderBroker</a><span class="delimiter">)</span> =&gt;
            if <span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.makeFollower" title="(controllerId: Int, partitionStateInfo: kafka.api.PartitionStateInfo, correlationId: Int, offsetManager: kafka.server.OffsetManager)Boolean">makeFollower</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.partitionStateInfo" title="kafka.api.PartitionStateInfo">partitionStateInfo</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.offsetManager" title="kafka.server.OffsetManager">offsetManager</a><span class="delimiter">)</span><span class="delimiter">)</span>
              <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a> <span title="(elem: kafka.cluster.Partition)scala.collection.Set[kafka.cluster.Partition]">+=</span> <span title="kafka.cluster.Partition">partition</span>
            else
              <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d skipped the become-follower state change after marking its partition as follower with correlation id %d from &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
                <span class="string">&quot;controller %d epoch %d for partition [%s,%d] since the new leader %d is the same as the old leader&quot;</span><span class="delimiter">)</span>
                .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a>,
                <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.newLeaderBrokerId" title="Int">newLeaderBrokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          case <span title="None.type">None</span> =&gt;
            <span class="comment">// The leader broker should always be present in the leaderAndIsrRequest.</span>
            <span class="comment">// If not, we should record the error message and abort the transition process for this partition</span>
            <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(1729dbc42f)" title="(msg: =&gt; String)Unit">error</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d received LeaderAndIsrRequest with correlation id %d from controller&quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
              <span class="string">&quot; %d epoch %d for partition [%s,%d] but cannot become follower since the new leader %d is unavailable.&quot;</span><span class="delimiter">)</span>
              .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.leaderIsrAndControllerEpoch" title="kafka.controller.LeaderIsrAndControllerEpoch">leaderIsrAndControllerEpoch</a>.<a href="../controller/KafkaController.scala.html#kafka.controller;LeaderIsrAndControllerEpoch.controllerEpoch" title="=&gt; Int">controllerEpoch</a>,
              <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.newLeaderBrokerId" title="Int">newLeaderBrokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>
            <span class="comment">// Create the local replica even if the leader is unavailable. This is required to ensure that we include</span>
            <span class="comment">// the partition's high watermark in the checkpoint file (see KAFKA-1647)</span>
            <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getOrCreateReplica" title="(replicaId: Int)kafka.cluster.Replica">getOrCreateReplica</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>

      <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="AbstractFetcherManager.scala.html#kafka.server;AbstractFetcherManager.removeFetcherForPartitions" title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">removeFetcherForPartitions</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; kafka.common.TopicAndPartition)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.cluster.Partition],kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]])scala.collection.Set[kafka.common.TopicAndPartition]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,kafka.common.TopicAndPartition,scala.collection.Set[kafka.common.TopicAndPartition]]" class="delimiter">(</span>new <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.$anonfun.x$7" title="kafka.cluster.Partition">_</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="kafka.cluster.Partition">partition</span> =&gt;
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d stopped fetchers as part of become-follower request from controller &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;%d epoch %d with correlation id %d for partition %s&quot;</span><span class="delimiter">)</span>
          .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      <a href="#kafka.server;ReplicaManager.logManager" title="=&gt; kafka.log.LogManager">logManager</a>.<a href="../log/LogManager.scala.html#kafka.log;LogManager.truncateTo" title="(partitionAndOffsets: scala.collection.Map[kafka.common.TopicAndPartition,Long])Unit">truncateTo</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; (kafka.common.TopicAndPartition, Long))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.cluster.Partition],(kafka.common.TopicAndPartition, Long),scala.collection.Set[(kafka.common.TopicAndPartition, Long)]])scala.collection.Set[(kafka.common.TopicAndPartition, Long)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,(kafka.common.TopicAndPartition, Long),scala.collection.Set[(kafka.common.TopicAndPartition, Long)]]" class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span> =&gt; <span title="(_1: kafka.common.TopicAndPartition, _2: Long)(kafka.common.TopicAndPartition, Long)" class="delimiter">(</span>new <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="kafka.cluster.Partition">partition</span><span class="delimiter">)</span>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getOrCreateReplica" title="(replicaId: Int)kafka.cluster.Replica">getOrCreateReplica</a><span class="delimiter">(</span><span class="delimiter">)</span>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.highWatermark" title="=&gt; kafka.server.LogOffsetMetadata">highWatermark</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(kafka.common.TopicAndPartition, Long),(kafka.common.TopicAndPartition, Long)])scala.collection.immutable.Map[kafka.common.TopicAndPartition,Long]">toMap</span><span class="delimiter">)</span>

      <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="kafka.cluster.Partition">partition</span> =&gt;
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d truncated logs and checkpointed recovery boundaries for partition [%s,%d] as part of &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;become-follower request with correlation id %d from controller %d epoch %d&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>,
          <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>

      if <span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.isShuttingDown" title="=&gt; java.util.concurrent.atomic.AtomicBoolean">isShuttingDown</a>.<span title="()Boolean">get</span><span class="delimiter">(</span><span class="delimiter">)</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="kafka.cluster.Partition">partition</span> =&gt;
          <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d skipped the adding-fetcher step of the become-follower state change with correlation id %d from &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
            <span class="string">&quot;controller %d epoch %d for partition [%s,%d] since it is shutting down&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>,
            <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      else <span class="delimiter">{</span>
        <span class="comment">// we do not need to check if the leader exists again since this has been done at the beginning of this process</span>
        val <a title="scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]" id="kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset">partitionsToMakeFollowerWithLeaderAndOffset</a> = <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; (kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Set[kafka.cluster.Partition],(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset),scala.collection.Set[(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)]])scala.collection.Set[(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Set.Coll,(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset),scala.collection.Set[(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)]]" class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset.$anonfun.partition">partition</a> =&gt;
          new <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset.$anonfun.partition" title="kafka.cluster.Partition">partition</a><span class="delimiter">)</span> <span title="(y: kafka.server.BrokerAndInitialOffset)(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)">-&gt;</span> <a href="AbstractFetcherManager.scala.html#kafka.server;BrokerAndInitialOffset" title="(broker: kafka.cluster.Broker, initOffset: Long)kafka.server.BrokerAndInitialOffset">BrokerAndInitialOffset</a><span class="delimiter">(</span>
            <a href="#kafka.server;ReplicaManager.makeFollowers.leaders" title="scala.collection.Set[kafka.cluster.Broker]">leaders</a>.<span title="(p: kafka.cluster.Broker =&gt; Boolean)Option[kafka.cluster.Broker]">find</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset.$anonfun.$anonfun.x$8" title="kafka.cluster.Broker">_</a>.<a href="../cluster/Broker.scala.html#kafka.cluster;Broker.id" title="=&gt; Int">id</a> <span title="(x: Int)Boolean">==</span> <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset.$anonfun.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.leaderReplicaIdOpt" title="=&gt; Option[Int]">leaderReplicaIdOpt</a>.<span title="=&gt; Int">get</span><span class="delimiter">)</span>.<span title="=&gt; kafka.cluster.Broker">get</span>,
            <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset.$anonfun.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getReplica" title="(replicaId: Int)Option[kafka.cluster.Replica]">getReplica</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="=&gt; kafka.cluster.Replica">get</span>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.logEndOffset" title="=&gt; kafka.server.LogOffsetMetadata">logEndOffset</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset),(kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)])scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">toMap</span>
        <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="AbstractFetcherManager.scala.html#kafka.server;AbstractFetcherManager.addFetcherForPartitions" title="(partitionAndOffsets: scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset])Unit">addFetcherForPartitions</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollowerWithLeaderAndOffset" title="scala.collection.immutable.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">partitionsToMakeFollowerWithLeaderAndOffset</a><span class="delimiter">)</span>

        <a href="#kafka.server;ReplicaManager.makeFollowers.partitionsToMakeFollower" title="scala.collection.Set[kafka.cluster.Partition]">partitionsToMakeFollower</a>.<span title="(f: kafka.cluster.Partition =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="kafka.cluster.Partition">partition</span> =&gt;
          <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d started fetcher to new leader as part of become-follower request from controller &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
            <span class="string">&quot;%d epoch %d with correlation id %d for partition [%s,%d]&quot;</span><span class="delimiter">)</span>
            .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="kafka.cluster.Partition">partition</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="kafka.server;ReplicaManager.makeFollowers.e">e</a>: <span title="Throwable">Throwable</span> =&gt;
        val <a title="String" id="kafka.server;ReplicaManager.makeFollowers.errorMsg">errorMsg</a> = <span class="delimiter">(</span><span class="string">&quot;Error on broker %d while processing LeaderAndIsr request with correlationId %d received from controller %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
          <span class="string">&quot;epoch %d&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a><span class="delimiter">)</span>
        <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.error(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">error</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.makeFollowers.errorMsg" title="String">errorMsg</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.e" title="Throwable">e</a><span class="delimiter">)</span>
        <span class="comment">// Re-throw the exception for it to be caught in KafkaApis</span>
        throw <a href="#kafka.server;ReplicaManager.makeFollowers.e" title="Throwable">e</a>
    <span class="delimiter">}</span>

    <a href="#kafka.server;ReplicaManager.makeFollowers.partitionState" title="scala.collection.Map[kafka.cluster.Partition,kafka.api.PartitionStateInfo]">partitionState</a>.<span title="(f: ((kafka.cluster.Partition, kafka.api.PartitionStateInfo)) =&gt; Unit)Unit">foreach</span> <span class="delimiter">{</span> <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span> =&gt;
      <a href="#kafka.server;ReplicaManager.stateChangeLogger" title="=&gt; kafka.controller.KafkaController.StateChangeLogger">stateChangeLogger</a>.<a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Broker %d completed LeaderAndIsr request correlationId %d from controller %d epoch %d &quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
        <span class="string">&quot;for the become-follower transition for partition %s&quot;</span><span class="delimiter">)</span>
        .<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.correlationId" title="Int">correlationId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.controllerId" title="Int">controllerId</a>, <a href="#kafka.server;ReplicaManager.makeFollowers.epoch" title="Int">epoch</a>, <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="(topic: String, partition: Int)kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.topic" title="=&gt; String">topic</a>, <span title="(kafka.cluster.Partition, kafka.api.PartitionStateInfo)">state</span>.<span title="=&gt; kafka.cluster.Partition">_1</span>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.partitionId" title="=&gt; Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()Unit" id="kafka.server;ReplicaManager.maybeShrinkIsr">maybeShrinkIsr</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.trace(1729dbc42f)" title="(msg: =&gt; String)Unit">trace</a><span class="delimiter">(</span><span title="String(&quot;Evaluating ISR list of partitions to see which replicas can be removed from the ISR&quot;)" class="string">&quot;Evaluating ISR list of partitions to see which replicas can be removed from the ISR&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.values" title="=&gt; Iterable[kafka.cluster.Partition]">values</a>.<span title="(f: kafka.cluster.Partition =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.maybeShrinkIsr.$anonfun.partition">partition</a> =&gt; <a href="#kafka.server;ReplicaManager.maybeShrinkIsr.$anonfun.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.maybeShrinkIsr" title="(replicaMaxLagTimeMs: Long, replicaMaxLagMessages: Long)Unit">maybeShrinkIsr</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.replicaLagTimeMaxMs" title="=&gt; Long">replicaLagTimeMaxMs</a>, <a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.replicaLagMaxMessages" title="=&gt; Long">replicaLagMaxMessages</a><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(topic: String, partitionId: Int, replicaId: Int, offset: kafka.server.LogOffsetMetadata)Unit" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW">updateReplicaLEOAndPartitionHW</a><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partitionId">partitionId</a>: <span title="Int">Int</span>, <a title="Int" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replicaId">replicaId</a>: <span title="Int">Int</span>, <a title="kafka.server.LogOffsetMetadata" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.offset">offset</a>: <a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata" title="kafka.server.LogOffsetMetadata">LogOffsetMetadata</a><span class="delimiter">)</span> = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.getPartition" title="(topic: String, partitionId: Int)Option[kafka.cluster.Partition]">getPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partitionId" title="Int">partitionId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
      case Some<span class="delimiter">(</span><a title="kafka.cluster.Partition" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partition">partition</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getReplica" title="(replicaId: Int)Option[kafka.cluster.Replica]">getReplica</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replicaId" title="Int">replicaId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
          case Some<span class="delimiter">(</span><a title="kafka.cluster.Replica" id="kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replica">replica</a><span class="delimiter">)</span> =&gt;
            <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replica" title="kafka.cluster.Replica">replica</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.logEndOffset_=" title="(newLogEndOffset: kafka.server.LogOffsetMetadata)Unit">logEndOffset</a> = <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.offset" title="kafka.server.LogOffsetMetadata">offset</a>
            <span class="comment">// check if we need to update HW and expand Isr</span>
            <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.updateLeaderHWAndMaybeExpandIsr" title="(replicaId: Int)Unit">updateLeaderHWAndMaybeExpandIsr</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replicaId" title="Int">replicaId</a><span class="delimiter">)</span>
            <a href="../utils/Logging.scala.html#kafka.utils;Logging.debug(1729dbc42f)" title="(msg: =&gt; String)Unit">debug</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Recorded follower %d position %d for partition [%s,%d].&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replicaId" title="Int">replicaId</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.offset" title="kafka.server.LogOffsetMetadata">offset</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
          case <span title="None.type">None</span> =&gt;
            throw new <a href="../common/NotAssignedReplicaException.scala.html#kafka.common;NotAssignedReplicaException" title="kafka.common.NotAssignedReplicaException">NotAssignedReplicaException</a><span class="delimiter">(</span><span class="delimiter">(</span><span class="string">&quot;Leader %d failed to record follower %d's position %d since the replica&quot;</span> <span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps">+</span>
              <span class="string">&quot; is not recognized to be one of the assigned replicas %s for partition [%s,%d]&quot;</span><span class="delimiter">)</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.localBrokerId" title="=&gt; Int">localBrokerId</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.replicaId" title="Int">replicaId</a>,
              <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.offset" title="kafka.server.LogOffsetMetadata">offset</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partition" title="kafka.cluster.Partition">partition</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.assignedReplicas" title="()scala.collection.immutable.Set[kafka.cluster.Replica]">assignedReplicas</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(f: kafka.cluster.Replica =&gt; Int)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set[kafka.cluster.Replica],Int,scala.collection.immutable.Set[Int]])scala.collection.immutable.Set[Int]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.immutable.Set.Coll,Int,scala.collection.immutable.Set[Int]]" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.$anonfun.x$9" title="kafka.cluster.Replica">_</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>

        <span class="delimiter">}</span>
      case <span title="None.type">None</span> =&gt;
        <a href="../utils/Logging.scala.html#kafka.utils;Logging.warn(1729dbc42f)" title="(msg: =&gt; String)Unit">warn</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;While recording the follower position, the partition [%s,%d] hasn't been created, skip updating leader HW&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.topic" title="String">topic</a>, <a href="#kafka.server;ReplicaManager.updateReplicaLEOAndPartitionHW.partitionId" title="Int">partitionId</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  private def <a title="()List[kafka.cluster.Partition]" id="kafka.server;ReplicaManager.getLeaderPartitions">getLeaderPartitions</a><span class="delimiter">(</span><span class="delimiter">)</span> : <span title="List[kafka.cluster.Partition]">List</span><span class="delimiter">[</span>Partition<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.values" title="=&gt; Iterable[kafka.cluster.Partition]">values</a>.<span title="(p: kafka.cluster.Partition =&gt; Boolean)Iterable[kafka.cluster.Partition]">filter</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.getLeaderPartitions.$anonfun.x$10" title="kafka.cluster.Partition">_</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.leaderReplicaIfLocal" title="()Option[kafka.cluster.Replica]">leaderReplicaIfLocal</a><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>.<span title="=&gt; List[kafka.cluster.Partition]">toList</span>
  <span class="delimiter">}</span>
  <span class="comment">/**
   * Flushes the highwatermark value for all partitions to the highwatermark file
   */</span>
  def <a title="()Unit" id="kafka.server;ReplicaManager.checkpointHighWatermarks">checkpointHighWatermarks</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    val <a title="Iterable[kafka.cluster.Replica]" id="kafka.server;ReplicaManager.checkpointHighWatermarks.replicas">replicas</a> = <a href="#kafka.server;ReplicaManager.allPartitions" title="=&gt; kafka.utils.Pool[(String, Int),kafka.cluster.Partition]">allPartitions</a>.<a href="../utils/Pool.scala.html#kafka.utils;Pool.values" title="=&gt; Iterable[kafka.cluster.Partition]">values</a>.<span title="(f: kafka.cluster.Partition =&gt; Option[kafka.cluster.Replica])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[kafka.cluster.Partition],Option[kafka.cluster.Replica],Iterable[Option[kafka.cluster.Replica]]])Iterable[Option[kafka.cluster.Replica]]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,Option[kafka.cluster.Replica],Iterable[Option[kafka.cluster.Replica]]]" class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicas.$anonfun.x$11" title="kafka.cluster.Partition">_</a>.<a href="../cluster/Partition.scala.html#kafka.cluster;Partition.getReplica" title="(replicaId: Int)Option[kafka.cluster.Replica]">getReplica</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.config" title="=&gt; kafka.server.KafkaConfig">config</a>.<a href="KafkaConfig.scala.html#kafka.server;KafkaConfig.brokerId" title="=&gt; Int">brokerId</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(pf: PartialFunction[Option[kafka.cluster.Replica],kafka.cluster.Replica])(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[Option[kafka.cluster.Replica]],kafka.cluster.Replica,Iterable[kafka.cluster.Replica]])Iterable[kafka.cluster.Replica]">collect</span><a title="&lt;$anon: Option[kafka.cluster.Replica] =&gt; kafka.cluster.Replica&gt; extends scala.runtime.AbstractPartialFunction[Option[kafka.cluster.Replica],kafka.cluster.Replica] with Serializable" id="kafka.server;ReplicaManager.checkpointHighWatermarks.replicas;$anonfun.isDefinedAt.defaultCase$" class="delimiter">{</a>case Some<span class="delimiter">(</span><a title="kafka.cluster.Replica" id="kafka.server;ReplicaManager.checkpointHighWatermarks.replicas;$anonfun.isDefinedAt.replica">replica</a><span class="delimiter">)</span> =&gt; <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicas;$anonfun.isDefinedAt.replica" title="kafka.cluster.Replica">replica</a><span class="delimiter">}</span>
    val <a title="scala.collection.immutable.Map[String,Iterable[kafka.cluster.Replica]]" id="kafka.server;ReplicaManager.checkpointHighWatermarks.replicasByDir">replicasByDir</a> = <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicas" title="Iterable[kafka.cluster.Replica]">replicas</a>.<span title="(p: kafka.cluster.Replica =&gt; Boolean)Iterable[kafka.cluster.Replica]">filter</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicasByDir.$anonfun.x$12" title="kafka.cluster.Replica">_</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.log" title="=&gt; Option[kafka.log.Log]">log</a>.<span title="=&gt; Boolean">isDefined</span><span class="delimiter">)</span>.<span title="(f: kafka.cluster.Replica =&gt; String)scala.collection.immutable.Map[String,Iterable[kafka.cluster.Replica]]">groupBy</span><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicasByDir.$anonfun.x$13" title="kafka.cluster.Replica">_</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.log" title="=&gt; Option[kafka.log.Log]">log</a>.<span title="=&gt; kafka.log.Log">get</span>.<a href="../log/Log.scala.html#kafka.log;Log.dir" title="=&gt; java.io.File">dir</a>.<span title="()java.io.File">getParentFile</span>.<span title="()String">getAbsolutePath</span><span class="delimiter">)</span>
    for<span class="delimiter">(</span><span class="delimiter">(</span><a title="String" id="kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.dir">dir</a>, <a title="Iterable[kafka.cluster.Replica]" id="kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.reps">reps</a><span class="delimiter">)</span> &lt;- <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.replicasByDir" title="(f: ((String, Iterable[kafka.cluster.Replica])) =&gt; Unit)Unit">replicasByDir</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      val <a title="scala.collection.immutable.Map[kafka.common.TopicAndPartition,Long]" id="kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.hwms">hwms</a> = <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.reps" title="Iterable[kafka.cluster.Replica]">reps</a>.<span title="(f: kafka.cluster.Replica =&gt; (kafka.common.TopicAndPartition, Long))(implicit bf: scala.collection.generic.CanBuildFrom[Iterable[kafka.cluster.Replica],(kafka.common.TopicAndPartition, Long),Iterable[(kafka.common.TopicAndPartition, Long)]])Iterable[(kafka.common.TopicAndPartition, Long)]">map</span><span title="scala.collection.generic.CanBuildFrom[scala.collection.Iterable.Coll,(kafka.common.TopicAndPartition, Long),Iterable[(kafka.common.TopicAndPartition, Long)]]" class="delimiter">(</span><a title="kafka.cluster.Replica" id="kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.hwms.$anonfun.r">r</a> =&gt; <span class="delimiter">(</span>new <a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition" title="kafka.common.TopicAndPartition">TopicAndPartition</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.hwms.$anonfun.r" title="kafka.cluster.Replica">r</a><span class="delimiter">)</span> <span title="(y: Long)(kafka.common.TopicAndPartition, Long)">-&gt;</span> <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.hwms.$anonfun.r" title="kafka.cluster.Replica">r</a>.<a href="../cluster/Replica.scala.html#kafka.cluster;Replica.highWatermark" title="=&gt; kafka.server.LogOffsetMetadata">highWatermark</a>.<a href="LogOffsetMetadata.scala.html#kafka.server;LogOffsetMetadata.messageOffset" title="=&gt; Long">messageOffset</a><span class="delimiter">)</span><span class="delimiter">)</span>.<span title="(implicit ev: &lt;:&lt;[(kafka.common.TopicAndPartition, Long),(kafka.common.TopicAndPartition, Long)])scala.collection.immutable.Map[kafka.common.TopicAndPartition,Long]">toMap</span>
      try <span class="delimiter">{</span>
        <a href="#kafka.server;ReplicaManager.highWatermarkCheckpoints" title="(key: String)kafka.server.OffsetCheckpoint">highWatermarkCheckpoints</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.dir" title="String">dir</a><span class="delimiter">)</span>.<a href="OffsetCheckpoint.scala.html#kafka.server;OffsetCheckpoint.write" title="(offsets: scala.collection.Map[kafka.common.TopicAndPartition,Long])Unit">write</a><span class="delimiter">(</span><a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.hwms" title="scala.collection.immutable.Map[kafka.common.TopicAndPartition,Long]">hwms</a><span class="delimiter">)</span>
      <span class="delimiter">}</span> catch <span class="delimiter">{</span>
        case <a title="java.io.IOException" id="kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.e">e</a>: <span title="java.io.IOException">IOException</span> =&gt;
          <a href="../utils/Logging.scala.html#kafka.utils;Logging.fatal(cfd112d89b)" title="(msg: =&gt; String, e: =&gt; Throwable)Unit">fatal</a><span class="delimiter">(</span><span title="String(&quot;Error writing to highwatermark file: &quot;)" class="string">&quot;Error writing to highwatermark file: &quot;</span>, <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks.$anonfun.e" title="java.io.IOException">e</a><span class="delimiter">)</span>
          <span title="Runtime.type">Runtime</span>.<span title="()Runtime">getRuntime</span><span class="delimiter">(</span><span class="delimiter">)</span>.<span title="(x$1: Int)Unit">halt</span><span class="delimiter">(</span><span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="kafka.server;ReplicaManager.shutdown">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Shut down&quot;)" class="string">&quot;Shut down&quot;</span><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.replicaFetcherManager" title="=&gt; kafka.server.ReplicaFetcherManager">replicaFetcherManager</a>.<a href="ReplicaFetcherManager.scala.html#kafka.server;ReplicaFetcherManager.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="#kafka.server;ReplicaManager.checkpointHighWatermarks" title="()Unit">checkpointHighWatermarks</a><span class="delimiter">(</span><span class="delimiter">)</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="String(&quot;Shut down completely&quot;)" class="string">&quot;Shut down completely&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
