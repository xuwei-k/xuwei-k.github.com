<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>kafka/kafka/server/AbstractFetcherManager.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */</span>

package kafka.server

import scala.collection.mutable
import scala.collection.Set
import scala.collection.Map
import kafka.utils.<span class="delimiter">{</span>Utils, Logging<span class="delimiter">}</span>
import kafka.cluster.Broker
import kafka.metrics.KafkaMetricsGroup
import kafka.common.TopicAndPartition
import com.yammer.metrics.core.Gauge

abstract class <a title="class AbstractFetcherManager extends AnyRef with kafka.utils.Logging with kafka.metrics.KafkaMetricsGroup" id="kafka.server.AbstractFetcherManager">AbstractFetcherManager</a><a href="#kafka.server.AbstractFetcherManager" title="kafka.server.AbstractFetcherManager" class="delimiter">(</a>protected val <a title="String" id="kafka.server;AbstractFetcherManager.name">name</a>: <span title="String">String</span>, <a title="String" id="kafka.server;AbstractFetcherManager.clientId">clientId</a>: <span title="String">String</span>, <a title="Int" id="kafka.server.AbstractFetcherManager.<init>$default$3">numFetchers</a>: <span title="Int">Int</span> = <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
  extends <a href="../utils/Logging.scala.html#kafka.utils;Logging" title="kafka.utils.Logging">Logging</a> with <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup" title="kafka.metrics.KafkaMetricsGroup">KafkaMetricsGroup</a> <span class="delimiter">{</span>
  <span class="comment">// map of (source broker_id, fetcher_id per source broker) =&gt; fetcher</span>
  private val <a title="scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]" id="kafka.server;AbstractFetcherManager.fetcherThreadMap">fetcherThreadMap</a> = new mutable.<span title="scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">HashMap</span><span class="delimiter">[</span>BrokerAndFetcherId, AbstractFetcherThread<span class="delimiter">]</span>
  private val <a title="Object" id="kafka.server;AbstractFetcherManager.mapLock">mapLock</a> = new <span title="Object">Object</span>
  this.<a href="../utils/Logging.scala.html#kafka.utils;Logging.logIdent_=" title="(x$1: String)Unit">logIdent</a> = <span title="String(&quot;[&quot;)" class="string">&quot;[&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;AbstractFetcherManager.name" title="=&gt; String">name</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;] &quot;)" class="string">&quot;] &quot;</span>

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Long], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Long]">newGauge</a><span class="delimiter">(</span>
    <span title="String(&quot;MaxLag&quot;)" class="string">&quot;MaxLag&quot;</span>,
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Long]&gt; extends com.yammer.metrics.core.Gauge[Long]">Gauge</span><span class="delimiter">[</span>Long<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="comment">// current max lag across all fetchers/topics/partitions</span>
      def <span title="()Long">value</span> = <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="(z: Long)(op: (Long, (kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Long)Long">foldLeft</span><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Long" id="kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.curMaxAll">curMaxAll</a>, <span title="(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)">fetcherThreadMapEntry</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
        <span title="(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)">fetcherThreadMapEntry</span>.<span title="=&gt; kafka.server.AbstractFetcherThread">_2</span>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.fetcherLagStats" title="=&gt; kafka.server.FetcherLagStats">fetcherLagStats</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;FetcherLagStats.stats" title="=&gt; kafka.utils.Pool[kafka.server.ClientIdTopicPartition,kafka.server.FetcherLagMetrics]">stats</a>.<span title="(z: Long)(op: (Long, (kafka.server.ClientIdTopicPartition, kafka.server.FetcherLagMetrics)) =&gt; Long)Long">foldLeft</span><span class="delimiter">(</span><span title="Long(0L)" class="long">0L</span><span class="delimiter">)</span><span title="implicit scala.LowPriorityImplicits.longWrapper : (x: Long)scala.runtime.RichLong" class="delimiter">(</span><span class="delimiter">(</span><a title="Long" id="kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.$anonfun.curMaxThread">curMaxThread</a>, <a title="(kafka.server.ClientIdTopicPartition, kafka.server.FetcherLagMetrics)" id="kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.$anonfun.fetcherLagStatsEntry">fetcherLagStatsEntry</a><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.$anonfun.curMaxThread" title="implicit scala.LowPriorityImplicits.longWrapper : (x: Long)scala.runtime.RichLong">curMaxThread</a>.<span title="(that: Long)Long">max</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.$anonfun.fetcherLagStatsEntry" title="(kafka.server.ClientIdTopicPartition, kafka.server.FetcherLagMetrics)">fetcherLagStatsEntry</a>.<span title="=&gt; kafka.server.FetcherLagMetrics">_2</span>.<a href="AbstractFetcherThread.scala.html#kafka.server;FetcherLagMetrics.lag" title="=&gt; Long">lag</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>.<span title="(that: Long)Long">max</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.curMaxAll" title="Long">curMaxAll</a><span class="delimiter">)</span>
      <span class="delimiter">}</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>,
    <span title="(elems: (String, String)*)scala.collection.Map[String,String]">Map</span><span class="delimiter">(</span><span title="(self: String)ArrowAssoc[String]" class="string">&quot;clientId&quot;</span> <span title="(y: String)(String, String)">-&gt;</span> <a href="#kafka.server;AbstractFetcherManager.clientId" title="String">clientId</a><span class="delimiter">)</span>
  <span class="delimiter">)</span>

  <a href="../metrics/KafkaMetricsGroup.scala.html#kafka.metrics;KafkaMetricsGroup.newGauge" title="(name: String, metric: com.yammer.metrics.core.Gauge[Double], tags: scala.collection.Map[String,String])com.yammer.metrics.core.Gauge[Double]">newGauge</a><span class="delimiter">(</span>
  <span title="String(&quot;MinFetchRate&quot;)" class="string">&quot;MinFetchRate&quot;</span>, <span class="delimiter">{</span>
    new <span title="&lt;$anon: com.yammer.metrics.core.Gauge[Double]&gt; extends com.yammer.metrics.core.Gauge[Double]">Gauge</span><span class="delimiter">[</span>Double<span class="delimiter">]</span> <span class="delimiter">{</span>
      <span class="comment">// current min fetch rate across all fetchers/topics/partitions</span>
      def <span title="()Double">value</span> = <span class="delimiter">{</span>
        val <a title="Double" id="kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.headRate">headRate</a>: <span title="Double">Double</span> =
          <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="=&gt; Option[(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)]">headOption</span>.<span title="(f: ((kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Double)Option[Double]">map</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.headRate.$anonfun.x$1" title="(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)">_</a>.<span title="=&gt; kafka.server.AbstractFetcherThread">_2</span>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.fetcherStats" title="=&gt; kafka.server.FetcherStats">fetcherStats</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;FetcherStats.requestRate" title="=&gt; com.yammer.metrics.core.Meter">requestRate</a>.<span title="()Double">oneMinuteRate</span><span class="delimiter">)</span>.<span title="(default: =&gt; Double)Double">getOrElse</span><span class="delimiter">(</span><span title="Double(0.0)" class="int">0</span><span class="delimiter">)</span>

        <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="(z: Double)(op: (Double, (kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Double)Double">foldLeft</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.headRate" title="Double">headRate</a><span class="delimiter">)</span><span class="delimiter">(</span><span class="delimiter">(</span><a title="Double" id="kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.curMinAll">curMinAll</a>, <span title="(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)">fetcherThreadMapEntry</span><span class="delimiter">)</span> =&gt; <span class="delimiter">{</span>
          <span title="(kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)">fetcherThreadMapEntry</span>.<span title="=&gt; kafka.server.AbstractFetcherThread">_2</span>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.fetcherStats" title="=&gt; kafka.server.FetcherStats">fetcherStats</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;FetcherStats.requestRate" title="=&gt; com.yammer.metrics.core.Meter">requestRate</a>.<span title="implicit scala.LowPriorityImplicits.doubleWrapper : (x: Double)scala.runtime.RichDouble">oneMinuteRate</span>.<span title="(that: Double)Double">min</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.<local AbstractFetcherManager>;$anon.value.$anonfun.curMinAll" title="Double">curMinAll</a><span class="delimiter">)</span>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>,
  <span title="(elems: (String, String)*)scala.collection.Map[String,String]">Map</span><span class="delimiter">(</span><span title="(self: String)ArrowAssoc[String]" class="string">&quot;clientId&quot;</span> <span title="(y: String)(String, String)">-&gt;</span> <a href="#kafka.server;AbstractFetcherManager.clientId" title="String">clientId</a><span class="delimiter">)</span>
  <span class="delimiter">)</span>

  private def <a title="(topic: String, partitionId: Int)Int" id="kafka.server;AbstractFetcherManager.getFetcherId">getFetcherId</a><span class="delimiter">(</span><a title="String" id="kafka.server;AbstractFetcherManager.getFetcherId.topic">topic</a>: <span title="String">String</span>, <a title="Int" id="kafka.server;AbstractFetcherManager.getFetcherId.partitionId">partitionId</a>: <span title="Int">Int</span><span class="delimiter">)</span> : <span title="Int">Int</span> = <span class="delimiter">{</span>
    <a href="../utils/Utils.scala.html#kafka.utils.Utils" title="kafka.utils.Utils.type">Utils</a>.<a href="../utils/Utils.scala.html#kafka.utils.Utils.abs" title="(n: Int)Int">abs</a><span class="delimiter">(</span><span title="Int(31)" class="int">31</span> <span title="(x: Int)Int">*</span> <a href="#kafka.server;AbstractFetcherManager.getFetcherId.topic" title="String">topic</a>.<span title="()Int">hashCode</span><span class="delimiter">(</span><span class="delimiter">)</span> <span title="(x: Int)Int">+</span> <a href="#kafka.server;AbstractFetcherManager.getFetcherId.partitionId" title="Int">partitionId</a><span class="delimiter">)</span> <span title="(x: Int)Int">%</span> <a href="#kafka.server.AbstractFetcherManager.<init>$default$3" title="Int">numFetchers</a>
  <span class="delimiter">}</span>

  <span class="comment">// to be defined in subclass to create a specific fetcher</span>
  def <a title="(fetcherId: Int, sourceBroker: kafka.cluster.Broker)kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.createFetcherThread">createFetcherThread</a><span class="delimiter">(</span><a title="Int" id="kafka.server;AbstractFetcherManager.createFetcherThread.fetcherId">fetcherId</a>: <span title="Int">Int</span>, <a title="kafka.cluster.Broker" id="kafka.server;AbstractFetcherManager.createFetcherThread.sourceBroker">sourceBroker</a>: <a href="../cluster/Broker.scala.html#kafka.cluster;Broker" title="kafka.cluster.Broker">Broker</a><span class="delimiter">)</span>: <a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread" title="kafka.server.AbstractFetcherThread">AbstractFetcherThread</a>

  def <a title="(partitionAndOffsets: scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset])Unit" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions">addFetcherForPartitions</a><span class="delimiter">(</span><a title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionAndOffsets">partitionAndOffsets</a>: <span title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">Map</span><span class="delimiter">[</span>TopicAndPartition, BrokerAndInitialOffset<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;AbstractFetcherManager.mapLock" title="=&gt; Object">mapLock</a> <span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      val <a title="scala.collection.immutable.Map[kafka.server.BrokerAndFetcherId,scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]]" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher">partitionsPerFetcher</a> = <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionAndOffsets" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">partitionAndOffsets</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)) =&gt; kafka.server.BrokerAndFetcherId)scala.collection.immutable.Map[kafka.server.BrokerAndFetcherId,scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]]">groupBy</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.x0$1" title="kafka.server.BrokerAndFetcherId" class="delimiter">{</a> case<span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.server.BrokerAndInitialOffset" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.brokerAndInitialOffset">brokerAndInitialOffset</a><span class="delimiter">)</span> =&gt;
        <a href="#kafka.server.BrokerAndFetcherId.readResolve" title="(broker: kafka.cluster.Broker, fetcherId: Int)kafka.server.BrokerAndFetcherId">BrokerAndFetcherId</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.brokerAndInitialOffset" title="kafka.server.BrokerAndInitialOffset">brokerAndInitialOffset</a>.<a href="#kafka.server;BrokerAndInitialOffset.broker" title="=&gt; kafka.cluster.Broker">broker</a>, <a href="#kafka.server;AbstractFetcherManager.getFetcherId" title="(topic: String, partitionId: Int)Int">getFetcherId</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.topic" title="=&gt; String">topic</a>, <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a>.<a href="../common/TopicAndPartition.scala.html#kafka.common;TopicAndPartition.partition" title="=&gt; Int">partition</a><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">}</span>
      for <span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.server.BrokerAndFetcherId" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId">brokerAndFetcherId</a>, <a title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.partitionAndOffsets">partitionAndOffsets</a><span class="delimiter">)</span> &lt;- <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionsPerFetcher" title="(f: ((kafka.server.BrokerAndFetcherId, scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset])) =&gt; Unit)Unit">partitionsPerFetcher</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        var <a title="kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.fetcherThread">fetcherThread</a>: <a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread" title="kafka.server.AbstractFetcherThread">AbstractFetcherThread</a> = null
        <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="(key: kafka.server.BrokerAndFetcherId)Option[kafka.server.AbstractFetcherThread]">get</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId" title="kafka.server.BrokerAndFetcherId">brokerAndFetcherId</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
          case Some<span class="delimiter">(</span><a title="kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.f">f</a><span class="delimiter">)</span> =&gt; <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.fetcherThread" title="kafka.server.AbstractFetcherThread">fetcherThread</a> = <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.f" title="kafka.server.AbstractFetcherThread">f</a>
          case <span title="None.type">None</span> =&gt;
            <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.fetcherThread" title="kafka.server.AbstractFetcherThread">fetcherThread</a> = <a href="#kafka.server;AbstractFetcherManager.createFetcherThread" title="(fetcherId: Int, sourceBroker: kafka.cluster.Broker)kafka.server.AbstractFetcherThread">createFetcherThread</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId" title="kafka.server.BrokerAndFetcherId">brokerAndFetcherId</a>.<a href="#kafka.server;BrokerAndFetcherId.fetcherId" title="=&gt; Int">fetcherId</a>, <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId" title="kafka.server.BrokerAndFetcherId">brokerAndFetcherId</a>.<a href="#kafka.server;BrokerAndFetcherId.broker" title="=&gt; kafka.cluster.Broker">broker</a><span class="delimiter">)</span>
            <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="(key: kafka.server.BrokerAndFetcherId, value: kafka.server.AbstractFetcherThread)Option[kafka.server.AbstractFetcherThread]">put</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId" title="kafka.server.BrokerAndFetcherId">brokerAndFetcherId</a>, <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.fetcherThread" title="kafka.server.AbstractFetcherThread">fetcherThread</a><span class="delimiter">)</span>
            <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.fetcherThread" title="kafka.server.AbstractFetcherThread">fetcherThread</a>.<span title="()Unit">start</span>
        <span class="delimiter">}</span>

        <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="(key: kafka.server.BrokerAndFetcherId)kafka.server.AbstractFetcherThread">fetcherThreadMap</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndFetcherId" title="kafka.server.BrokerAndFetcherId">brokerAndFetcherId</a><span class="delimiter">)</span>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.addPartitions" title="(partitionAndOffsets: scala.collection.Map[kafka.common.TopicAndPartition,Long])Unit">addPartitions</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.partitionAndOffsets" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">partitionAndOffsets</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)) =&gt; (kafka.common.TopicAndPartition, Long))(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset],(kafka.common.TopicAndPartition, Long),scala.collection.Map[kafka.common.TopicAndPartition,Long]])scala.collection.Map[kafka.common.TopicAndPartition,Long]">map</span> <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.$anonfun.x0$2" title="(kafka.common.TopicAndPartition, Long)" class="delimiter">{</a> case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.server.BrokerAndInitialOffset" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.$anonfun.brokerAndInitOffset">brokerAndInitOffset</a><span class="delimiter">)</span> =&gt;
          <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.$anonfun.topicAndPartition" title="(self: kafka.common.TopicAndPartition)ArrowAssoc[kafka.common.TopicAndPartition]">topicAndPartition</a> <span title="(y: Long)(kafka.common.TopicAndPartition, Long)">-&gt;</span> <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.$anonfun.brokerAndInitOffset" title="kafka.server.BrokerAndInitialOffset">brokerAndInitOffset</a>.<a href="#kafka.server;BrokerAndInitialOffset.initOffset" title="=&gt; Long">initOffset</a>
        <span class="delimiter">}</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Added fetcher for partitions %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.partitionAndOffsets" title="scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset]">partitionAndOffsets</a>.<span title="(f: ((kafka.common.TopicAndPartition, kafka.server.BrokerAndInitialOffset)) =&gt; String)(implicit bf: scala.collection.generic.CanBuildFrom[scala.collection.Map[kafka.common.TopicAndPartition,kafka.server.BrokerAndInitialOffset],String,Any])Any">map</span><a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.x0$3" title="String" class="delimiter">{</a> case <span class="delimiter">(</span><a title="kafka.common.TopicAndPartition" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.topicAndPartition">topicAndPartition</a>, <a title="kafka.server.BrokerAndInitialOffset" id="kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndInitialOffset">brokerAndInitialOffset</a><span class="delimiter">)</span> =&gt;
      <span title="String(&quot;[&quot;)" class="string">&quot;[&quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.topicAndPartition" title="kafka.common.TopicAndPartition">topicAndPartition</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;, initOffset &quot;)" class="string">&quot;, initOffset &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndInitialOffset" title="kafka.server.BrokerAndInitialOffset">brokerAndInitialOffset</a>.<a href="#kafka.server;BrokerAndInitialOffset.initOffset" title="=&gt; Long">initOffset</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot; to broker &quot;)" class="string">&quot; to broker &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#kafka.server;AbstractFetcherManager.addFetcherForPartitions.$anonfun.brokerAndInitialOffset" title="kafka.server.BrokerAndInitialOffset">brokerAndInitialOffset</a>.<a href="#kafka.server;BrokerAndInitialOffset.broker" title="=&gt; kafka.cluster.Broker">broker</a> <span title="(x$1: Any)String">+</span> <span title="String(&quot;] &quot;)" class="string">&quot;] &quot;</span><span class="delimiter">}</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="(partitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit" id="kafka.server;AbstractFetcherManager.removeFetcherForPartitions">removeFetcherForPartitions</a><span class="delimiter">(</span><a title="scala.collection.Set[kafka.common.TopicAndPartition]" id="kafka.server;AbstractFetcherManager.removeFetcherForPartitions.partitions">partitions</a>: <span title="scala.collection.Set[kafka.common.TopicAndPartition]">Set</span><span class="delimiter">[</span>TopicAndPartition<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;AbstractFetcherManager.mapLock" title="=&gt; Object">mapLock</a> <span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      for <span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.server.BrokerAndFetcherId" id="kafka.server;AbstractFetcherManager.removeFetcherForPartitions.$anonfun.key">key</a>, <a title="kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.removeFetcherForPartitions.$anonfun.fetcher">fetcher</a><span class="delimiter">)</span> &lt;- <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="(f: ((kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Unit)Unit">fetcherThreadMap</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.server;AbstractFetcherManager.removeFetcherForPartitions.$anonfun.fetcher" title="kafka.server.AbstractFetcherThread">fetcher</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.removePartitions" title="(topicAndPartitions: scala.collection.Set[kafka.common.TopicAndPartition])Unit">removePartitions</a><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.removeFetcherForPartitions.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>
    <a href="../utils/Logging.scala.html#kafka.utils;Logging.info(1729dbc42f)" title="(msg: =&gt; String)Unit">info</a><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Removed fetcher for partitions %s&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.removeFetcherForPartitions.partitions" title="scala.collection.Set[kafka.common.TopicAndPartition]">partitions</a>.<span title="(sep: String)String">mkString</span><span class="delimiter">(</span><span title="String(&quot;,&quot;)" class="string">&quot;,&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads">shutdownIdleFetcherThreads</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;AbstractFetcherManager.mapLock" title="=&gt; Object">mapLock</a> <span title="(x$1: scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread])scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">synchronized</span> <span class="delimiter">{</span>
      val <a title="scala.collection.mutable.HashSet[kafka.server.BrokerAndFetcherId]" id="kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.keysToBeRemoved">keysToBeRemoved</a> = new mutable.<span title="scala.collection.mutable.HashSet[kafka.server.BrokerAndFetcherId]">HashSet</span><span class="delimiter">[</span>BrokerAndFetcherId<span class="delimiter">]</span>
      for <span class="delimiter">(</span><span class="delimiter">(</span><a title="kafka.server.BrokerAndFetcherId" id="kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.$anonfun.key">key</a>, <a title="kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.$anonfun.fetcher">fetcher</a><span class="delimiter">)</span> &lt;- <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="(f: ((kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Any)Unit">fetcherThreadMap</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.$anonfun.fetcher" title="kafka.server.AbstractFetcherThread">fetcher</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.partitionCount" title="()Int">partitionCount</a> <span title="(x: Int)Boolean">&lt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.$anonfun.fetcher" title="kafka.server.AbstractFetcherThread">fetcher</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <a href="#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.keysToBeRemoved" title="scala.collection.mutable.HashSet[kafka.server.BrokerAndFetcherId]">keysToBeRemoved</a> <span title="(elem: kafka.server.BrokerAndFetcherId)keysToBeRemoved.type">+=</span> <a href="#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.$anonfun.key" title="kafka.server.BrokerAndFetcherId">key</a>
        <span class="delimiter">}</span>
      <span class="delimiter">}</span>
      <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a> <span title="(xs: scala.collection.TraversableOnce[kafka.server.BrokerAndFetcherId])AbstractFetcherManager.this.fetcherThreadMap.type">--=</span> <a href="#kafka.server;AbstractFetcherManager.shutdownIdleFetcherThreads.keysToBeRemoved" title="scala.collection.mutable.HashSet[kafka.server.BrokerAndFetcherId]">keysToBeRemoved</a>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  def <a title="()Unit" id="kafka.server;AbstractFetcherManager.closeAllFetchers">closeAllFetchers</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    <a href="#kafka.server;AbstractFetcherManager.mapLock" title="=&gt; Object">mapLock</a> <span title="(x$1: Unit)Unit">synchronized</span> <span class="delimiter">{</span>
      for <span class="delimiter">(</span> <span class="delimiter">(</span>_, <a title="kafka.server.AbstractFetcherThread" id="kafka.server;AbstractFetcherManager.closeAllFetchers.$anonfun.fetcher">fetcher</a><span class="delimiter">)</span> &lt;- <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="(f: ((kafka.server.BrokerAndFetcherId, kafka.server.AbstractFetcherThread)) =&gt; Unit)Unit">fetcherThreadMap</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#kafka.server;AbstractFetcherManager.closeAllFetchers.$anonfun.fetcher" title="kafka.server.AbstractFetcherThread">fetcher</a>.<a href="AbstractFetcherThread.scala.html#kafka.server;AbstractFetcherThread.shutdown" title="()Unit">shutdown</a><span class="delimiter">(</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
      <a href="#kafka.server;AbstractFetcherManager.fetcherThreadMap" title="=&gt; scala.collection.mutable.HashMap[kafka.server.BrokerAndFetcherId,kafka.server.AbstractFetcherThread]">fetcherThreadMap</a>.<span title="()Unit">clear</span><span class="delimiter">(</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

case class <a title="class BrokerAndFetcherId extends AnyRef with Product with Serializable" id="kafka.server.BrokerAndFetcherId.readResolve">BrokerAndFetcherId</a><a href="#kafka.server.BrokerAndFetcherId.readResolve" title="Product" class="delimiter">(</a><a title="kafka.cluster.Broker" id="kafka.server;BrokerAndFetcherId.broker">broker</a>: <a href="../cluster/Broker.scala.html#kafka.cluster;Broker" title="kafka.cluster.Broker">Broker</a>, <a title="Int" id="kafka.server;BrokerAndFetcherId.fetcherId">fetcherId</a>: <span title="Int">Int</span><span class="delimiter">)</span>

case class <a title="class BrokerAndInitialOffset extends AnyRef with Product with Serializable" id="kafka.server.BrokerAndInitialOffset.readResolve">BrokerAndInitialOffset</a><a href="#kafka.server.BrokerAndInitialOffset.readResolve" title="Product" class="delimiter">(</a><a title="kafka.cluster.Broker" id="kafka.server;BrokerAndInitialOffset.broker">broker</a>: <a href="../cluster/Broker.scala.html#kafka.cluster;Broker" title="kafka.cluster.Broker">Broker</a>, <a title="Long" id="kafka.server;BrokerAndInitialOffset.initOffset">initOffset</a>: <span title="Long">Long</span><span class="delimiter">)</span>
        </pre>
    </body>
</html>
