<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>org/scalatra/atmosphere/RedisScalatraBroadcaster.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
package org.scalatra.atmosphere

import _root_.akka.actor._
import org.atmosphere.cpr._
import java.util.concurrent.ConcurrentLinkedQueue
import org.atmosphere.plugin.redis.RedisBroadcaster

import scala.concurrent.<span class="delimiter">{</span>Future, ExecutionContext<span class="delimiter">}</span>
import collection.<span title="scala.collection.JavaConverters.type">JavaConverters</span>._
import grizzled.slf4j.Logger

import org.json4s.ShortTypeHints
import org.json4s.jackson.Serialization
import org.json4s.jackson.<span title="org.json4s.jackson.Serialization.type">Serialization</span>.<span class="delimiter">{</span>read, write<span class="delimiter">}</span>


final class <a title="class RedisScalatraBroadcaster extends org.atmosphere.plugin.redis.RedisBroadcaster with org.scalatra.atmosphere.ScalatraBroadcaster" id="org.scalatra.atmosphere;RedisScalatraBroadcaster">RedisScalatraBroadcaster</a><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="org.scalatra.atmosphere.RedisScalatraBroadcaster" class="delimiter">(</a><span class="delimiter">)</span><span class="delimiter">(</span>implicit <a title="org.scalatra.atmosphere.WireFormat" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.wireFormat">wireFormat</a>: <a href="wire_format.scala.html#org.scalatra.atmosphere;WireFormat" title="org.scalatra.atmosphere.WireFormat">WireFormat</a>, protected var <a title="akka.actor.ActorSystem" id="org.scalatra.atmosphere;RedisScalatraBroadcaster._actorSystem">_actorSystem</a>: <span title="akka.actor.ActorSystem">ActorSystem</span><span class="delimiter">)</span>
  extends <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="org.atmosphere.plugin.redis.RedisBroadcaster">RedisBroadcaster</a> with <a href="ScalatraBroadcaster.scala.html#org.scalatra.atmosphere;ScalatraBroadcaster" title="org.scalatra.atmosphere.ScalatraBroadcaster">ScalatraBroadcaster</a> <span class="delimiter">{</span>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val <a title="grizzled.slf4j.Logger" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.logger">logger</a>: <span title="grizzled.slf4j.Logger">Logger</span> = <span title="[C]()(implicit evidence$1: scala.reflect.ClassTag[C])grizzled.slf4j.Logger">Logger</span><span title="()(implicit evidence$1: scala.reflect.ClassTag[org.scalatra.atmosphere.RedisScalatraBroadcaster])grizzled.slf4j.Logger" class="delimiter">[</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="org.scalatra.atmosphere.RedisScalatraBroadcaster">RedisScalatraBroadcaster</a><span class="delimiter">]</span>
  protected var <a title="java.util.concurrent.ConcurrentLinkedQueue[org.atmosphere.cpr.AtmosphereResource]" id="org.scalatra.atmosphere;RedisScalatraBroadcaster._resources_=">_resources</a>: <span title="java.util.concurrent.ConcurrentLinkedQueue[org.atmosphere.cpr.AtmosphereResource]">ConcurrentLinkedQueue</span><span class="delimiter">[</span>AtmosphereResource<span class="delimiter">]</span> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="java.util.concurrent.ConcurrentLinkedQueue[org.atmosphere.cpr.AtmosphereResource]">resources</a>
  protected var <a title="org.scalatra.atmosphere.WireFormat" id="org.scalatra.atmosphere;RedisScalatraBroadcaster._wireFormat_=">_wireFormat</a>: <a href="wire_format.scala.html#org.scalatra.atmosphere;WireFormat" title="org.scalatra.atmosphere.WireFormat">WireFormat</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.wireFormat" title="org.scalatra.atmosphere.WireFormat">wireFormat</a>
  implicit val <a title="&lt;refinement&gt; extends AnyRef with org.json4s.Formats" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.formats">formats</a> = <span title="org.json4s.jackson.Serialization.type">Serialization</span>.<span title="(hints: org.json4s.TypeHints)org.json4s.Formats{val dateFormat: org.json4s.DateFormat; val typeHints: org.json4s.TypeHints}">formats</span><span class="delimiter">(</span><span title="(hints: List[Class[_]])org.json4s.ShortTypeHints">ShortTypeHints</span><span class="delimiter">(</span><span title="(xs: Class[_ &gt;: org.scalatra.atmosphere.SkipSelf with org.scalatra.atmosphere.OnlySelf with org.scalatra.atmosphere.Everyone &lt;: org.scalatra.atmosphere.ClientFilter]*)List[Class[_ &gt;: org.scalatra.atmosphere.SkipSelf with org.scalatra.atmosphere.OnlySelf with org.scalatra.atmosphere.Everyone &lt;: org.scalatra.atmosphere.ClientFilter]]">List</span><span class="delimiter">(</span>classOf<span title="Class[org.scalatra.atmosphere.Everyone](classOf[org.scalatra.atmosphere.package$$Everyone])" class="delimiter">[</span>Everyone<span class="delimiter">]</span>, classOf<span title="Class[org.scalatra.atmosphere.OnlySelf](classOf[org.scalatra.atmosphere.package$$OnlySelf])" class="delimiter">[</span>OnlySelf<span class="delimiter">]</span>, classOf<span title="Class[org.scalatra.atmosphere.SkipSelf](classOf[org.scalatra.atmosphere.package$$SkipSelf])" class="delimiter">[</span>SkipSelf<span class="delimiter">]</span><span class="delimiter">)</span><span class="delimiter">)</span><span class="delimiter">)</span>

  override def <a title="[T &lt;: org.scalatra.atmosphere.OutboundMessage](msg: T, clientFilter: org.scalatra.atmosphere.ClientFilter)(implicit executionContext: scala.concurrent.ExecutionContext)scala.concurrent.Future[T]" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84)">broadcast</a><span class="delimiter">[</span><a title=" &lt;: org.scalatra.atmosphere.OutboundMessage" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84);T">T</a> &lt;: OutboundMessage<span class="delimiter">]</span><span class="delimiter">(</span><a title="T" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).msg">msg</a>: <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84);T" title="T">T</a>, <a title="org.scalatra.atmosphere.ClientFilter" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).clientFilter">clientFilter</a>: <a href="package.scala.html#org.scalatra.atmosphere.package;ClientFilter" title="org.scalatra.atmosphere.ClientFilter">ClientFilter</a><span class="delimiter">)</span>
                                              <span class="delimiter">(</span>implicit <a title="scala.concurrent.ExecutionContext" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).executionContext">executionContext</a>: <span title="scala.concurrent.ExecutionContext">ExecutionContext</span><span class="delimiter">)</span>: <span title="scala.concurrent.Future[T]">Future</span><span class="delimiter">[</span>T<span class="delimiter">]</span> = <span class="delimiter">{</span>
    <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.logger" title="grizzled.slf4j.Logger">logger</a>.<span title="(msg: =&gt; Any)Unit">info</span><span class="delimiter">(</span><span title="implicit scala.Predef.augmentString : (x: String)scala.collection.immutable.StringOps" class="string">&quot;Resource [%s] sending message to [%s] with contents:  [%s]&quot;</span>.<span title="(args: Any*)String">format</span><span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).clientFilter" title="org.scalatra.atmosphere.ClientFilter">clientFilter</a>.<a href="package.scala.html#org.scalatra.atmosphere.package;ClientFilter.uuid" title="=&gt; String">uuid</a>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).clientFilter" title="org.scalatra.atmosphere.ClientFilter">clientFilter</a>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).msg" title="T">msg</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <span class="comment">// Casting to ProtocolMessage because when writing the message everything gets wrapped by a 'content' element.</span>
    <span class="comment">// This seems to be because the actual message is a ProtocolMessage which defines a 'content' method.</span>
    val <a title="org.scalatra.atmosphere.ProtocolMessage[Object]" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).protocolMsg">protocolMsg</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).msg" title="T">msg</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="org.scalatra.atmosphere.ProtocolMessage[Object]" class="delimiter">[</span><a href="messages.scala.html#org.scalatra.atmosphere;ProtocolMessage" title="org.scalatra.atmosphere.ProtocolMessage[Object]">ProtocolMessage</a><span class="delimiter">[</span>Object<span class="delimiter">]</span><span class="delimiter">]</span>
    val <a title="Object" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).content">content</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).protocolMsg" title="org.scalatra.atmosphere.ProtocolMessage[Object]">protocolMsg</a>.<a href="messages.scala.html#org.scalatra.atmosphere;ProtocolMessage.content" title="=&gt; Object">content</a>
    val <a title="String" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).actualMessage">actualMessage</a> = <span title="(a: Object)(implicit formats: org.json4s.Formats)String">write</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.formats" title="=&gt; org.json4s.Formats{val dateFormat: org.json4s.DateFormat; val typeHints: org.json4s.TypeHints}" class="delimiter">(</a><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).content" title="Object">content</a><span class="delimiter">)</span>
    val <a title="org.scalatra.atmosphere.Message" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).wrappedMessage">wrappedMessage</a> = new <a href="#org.scalatra.atmosphere;Message" title="org.scalatra.atmosphere.Message">Message</a><span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).actualMessage" title="String">actualMessage</a>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).clientFilter" title="org.scalatra.atmosphere.ClientFilter">clientFilter</a><span class="delimiter">)</span>
    val <a title="String" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).wrappedMessageString">wrappedMessageString</a> = <span title="(a: org.scalatra.atmosphere.Message)(implicit formats: org.json4s.Formats)String">write</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.formats" title="=&gt; org.json4s.Formats{val dateFormat: org.json4s.DateFormat; val typeHints: org.json4s.TypeHints}" class="delimiter">(</a><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).wrappedMessage" title="org.scalatra.atmosphere.Message">wrappedMessage</a><span class="delimiter">)</span>

    <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="(x$1: Any)java.util.concurrent.Future[Object]">broadcast</a><a href="package.scala.html#org.scalatra.atmosphere.package.jucFuture2akkaFuture" title="(javaFuture: java.util.concurrent.Future[Object])(implicit system: akka.actor.ActorSystem)scala.concurrent.Future[Object]" class="delimiter">(</a><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).wrappedMessageString" title="String">wrappedMessageString</a><span class="delimiter">)</span>.<span title="(f: Object =&gt; T)(implicit executor: scala.concurrent.ExecutionContext)scala.concurrent.Future[T]">map</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).executionContext" title="scala.concurrent.ExecutionContext" class="delimiter">(</a><a title="Object" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).$anonfun.x$1">_</a> =&gt; <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcast(2bc3b7de84).msg" title="T">msg</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  override protected def <a title="(message: AnyRef)Unit" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage">broadcastReceivedMessage</a><span class="delimiter">(</span><a title="AnyRef" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.message">message</a>: <span title="AnyRef">AnyRef</span><span class="delimiter">)</span> <span class="delimiter">{</span>
    try <span class="delimiter">{</span>
      val <a title="String" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.messageString">messageString</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.message" title="AnyRef">message</a>.<span title="[T0]=&gt; T0">asInstanceOf</span><span title="String" class="delimiter">[</span><span title="String">String</span><span class="delimiter">]</span>
      val <a title="org.scalatra.atmosphere.Message" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.redisMessage">redisMessage</a> = <span title="[A](json: String)(implicit formats: org.json4s.Formats, implicit mf: scala.reflect.Manifest[A])A">read</span><span title="(json: String)(implicit formats: org.json4s.Formats, implicit mf: scala.reflect.Manifest[org.scalatra.atmosphere.Message])org.scalatra.atmosphere.Message" class="delimiter">[</span><a href="#org.scalatra.atmosphere;Message" title="org.scalatra.atmosphere.Message">Message</a><span class="delimiter">]</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.formats" title="=&gt; org.json4s.Formats{val dateFormat: org.json4s.DateFormat; val typeHints: org.json4s.TypeHints}" class="delimiter">(</a><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.messageString" title="String">messageString</a><span class="delimiter">)</span>
      val <a title="String" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.embeddedMsg">embeddedMsg</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.redisMessage" title="org.scalatra.atmosphere.Message">redisMessage</a>.<a href="#org.scalatra.atmosphere;Message.msg" title="=&gt; String">msg</a>
      val <a title="org.scalatra.atmosphere.ClientFilter" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.clientFilter">clientFilter</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.redisMessage" title="org.scalatra.atmosphere.Message">redisMessage</a>.<a href="#org.scalatra.atmosphere;Message.clientFilter" title="=&gt; org.scalatra.atmosphere.ClientFilter">clientFilter</a>
      val <a title="Object" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.newMsg">newMsg</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="(x$1: Any)Object">filter</a><span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.embeddedMsg" title="String">embeddedMsg</a><span class="delimiter">)</span>

      if <span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.newMsg" title="Object">newMsg</a> <span title="(x$1: Any)Boolean">!=</span> null<span class="delimiter">)</span> <span class="delimiter">{</span>
        val selectedResources = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster._resources_=" title="(i: java.util.Collection[org.atmosphere.cpr.AtmosphereResource])scala.collection.convert.Decorators.AsScala[Iterable[org.atmosphere.cpr.AtmosphereResource]]">_resources</a>.<span title="=&gt; Iterable[org.atmosphere.cpr.AtmosphereResource]">asScala</span> <a title="Iterable[org.atmosphere.cpr.AtmosphereResource]" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.selectedResources">filter</a> <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.clientFilter" title="org.scalatra.atmosphere.ClientFilter">clientFilter</a>
        val <a title="java.util.Set[org.atmosphere.cpr.AtmosphereResource]" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.selectedSet">selectedSet</a> = <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.selectedResources" title="Iterable[org.atmosphere.cpr.AtmosphereResource]">selectedResources</a>.<span title="(s: scala.collection.Set[org.atmosphere.cpr.AtmosphereResource])scala.collection.convert.Decorators.AsJava[java.util.Set[org.atmosphere.cpr.AtmosphereResource]]">toSet</span>.<span title="=&gt; java.util.Set[org.atmosphere.cpr.AtmosphereResource]">asJava</span>
        <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster" title="(x$1: org.atmosphere.cpr.Entry)Unit">push</a><span class="delimiter">(</span>new <span title="org.atmosphere.cpr.Entry">Entry</span><span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.newMsg" title="Object">newMsg</a>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.selectedSet" title="java.util.Set[org.atmosphere.cpr.AtmosphereResource]">selectedSet</a>, new <span title="org.atmosphere.cpr.BroadcasterFuture[Any]">BroadcasterFuture</span><span class="delimiter">[</span>Any<span class="delimiter">]</span><span class="delimiter">(</span><a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.newMsg" title="Object">newMsg</a><span class="delimiter">)</span>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.embeddedMsg" title="String">embeddedMsg</a><span class="delimiter">)</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span> catch <span class="delimiter">{</span>
      case <a title="Throwable" id="org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.t">t</a>: <span title="Throwable">Throwable</span> =&gt; <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.logger" title="grizzled.slf4j.Logger">logger</a>.<span title="(msg: =&gt; Any, t: =&gt; Throwable)Unit">error</span><span class="delimiter">(</span><span title="String(&quot;failed to push message: &quot;)" class="string">&quot;failed to push message: &quot;</span> <span title="(x$1: Any)String">+</span> <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.message" title="AnyRef">message</a>, <a href="#org.scalatra.atmosphere;RedisScalatraBroadcaster.broadcastReceivedMessage.t" title="Throwable">t</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

class <a title="class Message extends AnyRef" id="org.scalatra.atmosphere;Message">Message</a><a href="#org.scalatra.atmosphere;Message" title="org.scalatra.atmosphere.Message" class="delimiter">(</a>val <a title="String" id="org.scalatra.atmosphere;Message.msg">msg</a>: <span title="String">String</span>, val <a title="org.scalatra.atmosphere.ClientFilter" id="org.scalatra.atmosphere;Message.clientFilter">clientFilter</a>: <a href="package.scala.html#org.scalatra.atmosphere.package;ClientFilter" title="org.scalatra.atmosphere.ClientFilter">ClientFilter</a><span class="delimiter">)</span>

        </pre>
    </body>
</html>
