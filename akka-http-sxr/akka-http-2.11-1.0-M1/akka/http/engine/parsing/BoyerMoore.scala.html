<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>akka/http/engine/parsing/BoyerMoore.scala</title>
        <script type="text/javascript" src="../../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2009-2014 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>

package akka.http.engine.parsing

import scala.annotation.tailrec
import akka.util.ByteString

<span class="comment">/**
 * Straight-forward Boyer-Moore string search implementation.
 */</span>
private class <a title="class BoyerMoore extends AnyRef" id="akka.http.engine.parsing;BoyerMoore">BoyerMoore</a><a href="#akka.http.engine.parsing;BoyerMoore" title="akka.http.engine.parsing.BoyerMoore" class="delimiter">(</a><a title="Array[Byte]" id="akka.http.engine.parsing;BoyerMoore.needle">needle</a>: <span title="Array[Byte]">Array</span><span class="delimiter">[</span>Byte<span class="delimiter">]</span><span class="delimiter">)</span> <span class="delimiter">{</span>
  <span title="(requirement: Boolean, message: =&gt; Any)Unit">require</span><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span>, <span title="String(&quot;needle must be non-empty&quot;)" class="string">&quot;needle must be non-empty&quot;</span><span class="delimiter">)</span>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val nl1 = <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span> <a title="Int" id="akka.http.engine.parsing;BoyerMoore.nl1">-</a> <span title="Int(1)" class="int">1</span>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val <a title="Array[Int]" id="akka.http.engine.parsing;BoyerMoore.charTable">charTable</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="Array[Int]" id="akka.http.engine.parsing;BoyerMoore.charTable.table">table</a> = <span title="Array.type">Array</span>.<span title="(n: Int)(elem: =&gt; Int)(implicit evidence$9: scala.reflect.ClassTag[Int])Array[Int]">fill</span><span class="delimiter">(</span><span title="Int(256)" class="int">256</span><span class="delimiter">)</span><span title="=&gt; scala.reflect.ClassTag[Int]" class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>
    @tailrec def <a title="(i: Int)Unit" id="akka.http.engine.parsing;BoyerMoore.charTable.rec">rec</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.charTable.rec.i">i</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec.i" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        <a href="#akka.http.engine.parsing;BoyerMoore.charTable.table" title="(i: Int, x: Int)Unit">table</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec.i" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span> = <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a> <span title="(x: Int)Int">-</span> <a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec.i" title="Int">i</a>
        <a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec" title="(i: Int)Unit">rec</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.charTable.rec" title="(i: Int)Unit">rec</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.charTable.table" title="Array[Int]">table</a>
  <span class="delimiter">}</span>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val <a title="Array[Int]" id="akka.http.engine.parsing;BoyerMoore.offsetTable">offsetTable</a>: <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span> = <span class="delimiter">{</span>
    val <a title="Array[Int]" id="akka.http.engine.parsing;BoyerMoore.offsetTable.table">table</a> = new <span title="Array[Int]">Array</span><span class="delimiter">[</span>Int<span class="delimiter">]</span><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>

    @tailrec def <a title="(i: Int, j: Int)Boolean" id="akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix">isPrefix</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.i">i</a>: <span title="Int">Int</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.j">j</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Boolean">Boolean</span> =
      <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.i" title="Int">i</a> <span title="(x: Int)Boolean">==</span> <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span> <span title="(x: Boolean)Boolean">||</span> <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.i" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Byte)Boolean">==</span> <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.j" title="Int">j</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix" title="(i: Int, j: Int)Boolean">isPrefix</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix.j" title="Int">j</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
    @tailrec def <a title="(i: Int, lastPrefixPosition: Int)Unit" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop1">loop1</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i">i</a>: <span title="Int">Int</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.lastPrefixPosition">lastPrefixPosition</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        val <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.nextLastPrefixPosition">nextLastPrefixPosition</a> = if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.isPrefix" title="(i: Int, j: Int)Boolean">isPrefix</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span> else <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.lastPrefixPosition" title="Int">lastPrefixPosition</a>
        <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.table" title="(i: Int, x: Int)Unit">table</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a> <span title="(x: Int)Int">-</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a><span class="delimiter">)</span> = <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.nextLastPrefixPosition" title="Int">nextLastPrefixPosition</a> <span title="(x: Int)Int">-</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a>
        <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1" title="(i: Int, lastPrefixPosition: Int)Unit">loop1</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.i" title="Int">i</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1.nextLastPrefixPosition" title="Int">nextLastPrefixPosition</a><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop1" title="(i: Int, lastPrefixPosition: Int)Unit">loop1</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a>, <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="Array[Byte]">needle</a>.<span title="=&gt; Int">length</span><span class="delimiter">)</span>

    @tailrec def <a title="(i: Int, j: Int, result: Int)Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength">suffixLength</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.i">i</a>: <span title="Int">Int</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.j">j</a>: <span title="Int">Int</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.result">result</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> =
      if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.i" title="Int">i</a> <span title="(x: Int)Boolean">&gt;=</span> <span title="Int(0)" class="int">0</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.i" title="Int">i</a><span class="delimiter">)</span> <span title="(x: Byte)Boolean">==</span> <a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.j" title="Int">j</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength" title="(i: Int, j: Int, result: Int)Int">suffixLength</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.i" title="Int">i</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.j" title="Int">j</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.result" title="Int">result</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span> else <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength.result" title="Int">result</a>
    @tailrec def <a title="(i: Int)Unit" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop2">loop2</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.i">i</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
      if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.i" title="Int">i</a> <span title="(x: Int)Boolean">&lt;</span> <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        val <a title="Int" id="akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.sl">sl</a> = <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.suffixLength" title="(i: Int, j: Int, result: Int)Int">suffixLength</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.i" title="Int">i</a>, <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a>, <span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
        <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.table" title="(i: Int, x: Int)Unit">table</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.sl" title="Int">sl</a><span class="delimiter">)</span> = <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a> <span title="(x: Int)Int">-</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.sl" title="Int">sl</a>
        <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2" title="(i: Int)Unit">loop2</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2.i" title="Int">i</a> <span title="(x: Int)Int">+</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.loop2" title="(i: Int)Unit">loop2</a><span class="delimiter">(</span><span title="Int(0)" class="int">0</span><span class="delimiter">)</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.offsetTable.table" title="Array[Int]">table</a>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Returns the index of the next occurrence of `needle` in `haystack` that is &gt;= `offset`.
   * If none is found a `NotEnoughDataException` is thrown.
   */</span>
  def <a title="(haystack: akka.util.ByteString, offset: Int)Int" id="akka.http.engine.parsing;BoyerMoore.nextIndex">nextIndex</a><span class="delimiter">(</span><a title="akka.util.ByteString" id="akka.http.engine.parsing;BoyerMoore.nextIndex.haystack">haystack</a>: <span title="akka.util.ByteString">ByteString</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.nextIndex.offset">offset</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
    @tailrec def <a title="(i: Int, j: Int)Int" id="akka.http.engine.parsing;BoyerMoore.nextIndex.rec">rec</a><span class="delimiter">(</span><a title="Int" id="akka.http.engine.parsing;BoyerMoore.nextIndex.rec.i">i</a>: <span title="Int">Int</span>, <a title="Int" id="akka.http.engine.parsing;BoyerMoore.nextIndex.rec.j">j</a>: <span title="Int">Int</span><span class="delimiter">)</span>: <span title="Int">Int</span> = <span class="delimiter">{</span>
      val <a title="Byte" id="akka.http.engine.parsing;BoyerMoore.nextIndex.rec.byte">byte</a> = <a href="package.scala.html#akka.http.engine.parsing.package.byteAt" title="(input: akka.util.ByteString, ix: Int)Byte">byteAt</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.haystack" title="akka.util.ByteString">haystack</a>, <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.i" title="Int">i</a><span class="delimiter">)</span>
      if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.needle" title="(i: Int)Byte">needle</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.j" title="Int">j</a><span class="delimiter">)</span> <span title="(x: Byte)Boolean">==</span> <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.byte" title="Byte">byte</a><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.j" title="Int">j</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.i" title="Int">i</a> <span class="comment">// found</span>
        else <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec" title="(i: Int, j: Int)Int">rec</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.i" title="Int">i</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.j" title="Int">j</a> <span title="(x: Int)Int">-</span> <span title="Int(1)" class="int">1</span><span class="delimiter">)</span>
      <span class="delimiter">}</span> else <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec" title="(i: Int, j: Int)Int">rec</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.i" title="Int">i</a> <span title="(x: Int)Int">+</span> math.<span title="(x: Int, y: Int)Int">max</span><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.offsetTable" title="(i: Int)Int">offsetTable</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a> <span title="(x: Int)Int">-</span> <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.j" title="Int">j</a><span class="delimiter">)</span>, <a href="#akka.http.engine.parsing;BoyerMoore.charTable" title="(i: Int)Int">charTable</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec.byte" title="Byte">byte</a> <span title="(x: Int)Int">&amp;</span> <span title="Int(255)" class="int">0xff</span><span class="delimiter">)</span><span class="delimiter">)</span>, <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
    <a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.rec" title="(i: Int, j: Int)Int">rec</a><span class="delimiter">(</span><a href="#akka.http.engine.parsing;BoyerMoore.nextIndex.offset" title="Int">offset</a> <span title="(x: Int)Int">+</span> <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a>, <a href="#akka.http.engine.parsing;BoyerMoore.nl1" title="Int">nl1</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>

        </pre>
    </body>
</html>
