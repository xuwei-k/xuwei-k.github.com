<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" ></meta>
        <title>akka/stream/impl/SubscriberManagement.scala</title>
        <script type="text/javascript" src="../../../jquery-all.js"></script>
        <script type="text/javascript" src="../../../linked.js"></script>
        <link rel="stylesheet" type="text/css" href="../../../style.css" title="Style"></link>
    </head>
    <body>
        <pre>
<span class="comment">/**
 * Copyright (C) 2014 Typesafe Inc. &lt;http://www.typesafe.com&gt;
 */</span>
package akka.stream.impl

import scala.annotation.switch
import scala.annotation.tailrec
import org.reactivestreams.<span class="delimiter">{</span> Subscriber, Subscription <span class="delimiter">}</span>
import <a href="#akka.stream.impl.SubscriberManagement" title="akka.stream.impl.SubscriberManagement.type">SubscriberManagement</a>.ShutDown
import <a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl.ResizableMultiReaderRingBuffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer.type">ResizableMultiReaderRingBuffer</a>.NothingToReadException

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>akka<span class="delimiter">]</span> object <a title="akka.stream.impl.SubscriberManagement.type" id="akka.stream.impl.SubscriberManagement">SubscriberManagement</a> <a href="#akka.stream.impl.SubscriberManagement" title="akka.stream.impl.SubscriberManagement.type" class="delimiter">{</a>

  sealed trait <a title="trait EndOfStream extends AnyRef" id="akka.stream.impl.SubscriberManagement;EndOfStream">EndOfStream</a> <span class="delimiter">{</span>
    def <a title="[T](subscriber: org.reactivestreams.Subscriber[T])Unit" id="akka.stream.impl.SubscriberManagement;EndOfStream.apply">apply</a><span class="delimiter">[</span><a title="" id="akka.stream.impl.SubscriberManagement;EndOfStream.apply;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[T]" id="akka.stream.impl.SubscriberManagement;EndOfStream.apply.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[T]">Subscriber</span><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>
  <span class="delimiter">}</span>

  object <a title="akka.stream.impl.SubscriberManagement.NotReached.type" id="akka.stream.impl.SubscriberManagement.NotReached">NotReached</a> extends <a href="#akka.stream.impl.SubscriberManagement;EndOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">EndOfStream</a> <span class="delimiter">{</span>
    def <a title="[T](subscriber: org.reactivestreams.Subscriber[T])Unit" id="akka.stream.impl.SubscriberManagement.NotReached.apply">apply</a><span class="delimiter">[</span><a title="" id="akka.stream.impl.SubscriberManagement.NotReached.apply;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[T]" id="akka.stream.impl.SubscriberManagement.NotReached.apply.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[T]">Subscriber</span><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String(&quot;Called apply on NotReached&quot;)" class="string">&quot;Called apply on NotReached&quot;</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  object <a title="akka.stream.impl.SubscriberManagement.Completed.type" id="akka.stream.impl.SubscriberManagement.Completed">Completed</a> extends <a href="#akka.stream.impl.SubscriberManagement;EndOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">EndOfStream</a> <span class="delimiter">{</span>
    def <a title="[T](subscriber: org.reactivestreams.Subscriber[T])Unit" id="akka.stream.impl.SubscriberManagement.Completed.apply">apply</a><span class="delimiter">[</span><a title="" id="akka.stream.impl.SubscriberManagement.Completed.apply;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[T]" id="akka.stream.impl.SubscriberManagement.Completed.apply.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[T]">Subscriber</span><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.stream.impl.SubscriberManagement.Completed.apply.subscriber" title="org.reactivestreams.Subscriber[T]">subscriber</a>.<span title="()Unit">onComplete</span><span class="delimiter">(</span><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  case class <a title="class ErrorCompleted extends AnyRef with akka.stream.impl.SubscriberManagement.EndOfStream with Product with Serializable" id="akka.stream.impl.SubscriberManagement.ErrorCompleted.readResolve">ErrorCompleted</a><span title="Product" class="delimiter">(</span><a title="Throwable" id="akka.stream.impl.SubscriberManagement;ErrorCompleted.cause">cause</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span> extends <a href="#akka.stream.impl.SubscriberManagement;EndOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">EndOfStream</a> <span class="delimiter">{</span>
    def <a title="[T](subscriber: org.reactivestreams.Subscriber[T])Unit" id="akka.stream.impl.SubscriberManagement;ErrorCompleted.apply">apply</a><span class="delimiter">[</span><a title="" id="akka.stream.impl.SubscriberManagement;ErrorCompleted.apply;T">T</a><span class="delimiter">]</span><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[T]" id="akka.stream.impl.SubscriberManagement;ErrorCompleted.apply.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[T]">Subscriber</span><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.stream.impl.SubscriberManagement;ErrorCompleted.apply.subscriber" title="org.reactivestreams.Subscriber[T]">subscriber</a>.<span title="(x$1: Throwable)Unit">onError</span><span class="delimiter">(</span><a href="#akka.stream.impl.SubscriberManagement;ErrorCompleted.cause" title="=&gt; Throwable">cause</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  val <a title="akka.stream.impl.SubscriberManagement.ErrorCompleted" id="akka.stream.impl.SubscriberManagement.ShutDown">ShutDown</a> = new <a href="#akka.stream.impl.SubscriberManagement.ErrorCompleted.readResolve" title="akka.stream.impl.SubscriberManagement.ErrorCompleted">ErrorCompleted</a><span class="delimiter">(</span>new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String(&quot;Cannot subscribe to shut-down Publisher&quot;)" class="string">&quot;Cannot subscribe to shut-down Publisher&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>akka<span class="delimiter">]</span> trait <a title="trait SubscriptionWithCursor[T] extends Object with org.reactivestreams.Subscription with akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor" id="akka.stream.impl;SubscriptionWithCursor">SubscriptionWithCursor</a><span class="delimiter">[</span><a title="" id="akka.stream.impl;SubscriptionWithCursor;T">T</a><span class="delimiter">]</span> extends <span title="org.reactivestreams.Subscription">Subscription</span> with ResizableMultiReaderRingBuffer.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl.ResizableMultiReaderRingBuffer;Cursor" title="akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor">Cursor</a> <span class="delimiter">{</span>
  def <a title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]" id="akka.stream.impl;SubscriptionWithCursor.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[_ &gt;: T]">Subscriber</span><span class="delimiter">[</span>_ &gt;: T<span class="delimiter">]</span>

  def <a title="(element: T)Unit" id="akka.stream.impl;SubscriptionWithCursor.dispatch">dispatch</a><span class="delimiter">(</span><a title="T" id="akka.stream.impl;SubscriptionWithCursor.dispatch.element">element</a>: <a href="#akka.stream.impl;SubscriptionWithCursor;T" title="T">T</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a>.<span title="(x$1: _$1)Unit">onNext</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriptionWithCursor.dispatch.element" title="T">element</a><span class="delimiter">)</span>

  <span class="comment">/** Increases the `requested` counter, additionally providing overflow protection */</span>
  def <a title="(demand: Long)Long" id="akka.stream.impl;SubscriptionWithCursor.moreRequested">moreRequested</a><span class="delimiter">(</span><a title="Long" id="akka.stream.impl;SubscriptionWithCursor.moreRequested.demand">demand</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Long">Long</span> = <span class="delimiter">{</span>
    val sum = <a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="=&gt; Long">totalDemand</a> <a title="Long" id="akka.stream.impl;SubscriptionWithCursor.moreRequested.sum">+</a> <a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.demand" title="Long">demand</a>
    val noOverflow = <a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.sum" title="Long">sum</a> <a title="Boolean" id="akka.stream.impl;SubscriptionWithCursor.moreRequested.noOverflow">&gt;</a> <span title="Int(0)" class="int">0</span>

    if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.noOverflow" title="Boolean">noOverflow</a><span class="delimiter">)</span> <a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="(x$1: Long)Unit">totalDemand</a> = <a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.sum" title="Long">sum</a>
    else <a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a>.<span title="(x$1: Throwable)Unit">onError</span><span class="delimiter">(</span>new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;Total pending demand (&quot;)">Total pending demand ($</span><a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="=&gt; Long">totalDemand</a><span title="String(&quot; + &quot;)"> + $</span><a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.demand" title="Long">demand</a><span title="String(&quot;) would overflow `Long`, for Subscriber &quot;)">) would overflow `Long`, for Subscriber $</span><a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span title="String(&quot;! &quot;)">! $</span><span class="delimiter">{</span>ReactiveStreamsCompliance.<span title="String(&quot;Total pending demand MUST NOT be &gt; `java.lang.Long.MAX_VALUE` (see reactive-streams specification, rule 3.17)&quot;)">TotalPendingDemandMustNotExceedLongMaxValue</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>

    <a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested.sum" title="Long">sum</a>
  <span class="delimiter">}</span>

  var <a title="Boolean" id="akka.stream.impl;SubscriptionWithCursor.active_=">active</a> = true

  <span class="comment">/** Do not increment directly, use `moreRequested(Long)` instead (it provides overflow protection)! */</span>
  var <a title="Long" id="akka.stream.impl;SubscriptionWithCursor.totalDemand_=">totalDemand</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="int">0</span> <span class="comment">// number of requested but not yet dispatched elements</span>
  var <a title="Int" id="akka.stream.impl;SubscriptionWithCursor.cursor_=">cursor</a>: <span title="Int">Int</span> = <span title="Int(0)" class="int">0</span> <span class="comment">// buffer cursor, managed by buffer</span>
<span class="delimiter">}</span>

<span class="comment">/**
 * INTERNAL API
 */</span>
private<span class="delimiter">[</span>akka<span class="delimiter">]</span> trait <a title="trait SubscriberManagement[T] extends AnyRef with akka.stream.impl.ResizableMultiReaderRingBuffer.Cursors" id="akka.stream.impl;SubscriberManagement">SubscriberManagement</a><span class="delimiter">[</span><a title="" id="akka.stream.impl;SubscriberManagement;T">T</a><span class="delimiter">]</span> extends ResizableMultiReaderRingBuffer.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl.ResizableMultiReaderRingBuffer;Cursors" title="akka.stream.impl.ResizableMultiReaderRingBuffer.Cursors">Cursors</a> <span class="delimiter">{</span>
  import <a href="#akka.stream.impl.SubscriberManagement" title="akka.stream.impl.SubscriberManagement.type">SubscriberManagement</a>._
  type <a title=" &lt;: akka.stream.impl.SubscriptionWithCursor[T]" id="akka.stream.impl;SubscriberManagement;S">S</a> &lt;: SubscriptionWithCursor<span class="delimiter">[</span>T<span class="delimiter">]</span>
  type <a title="List[SubscriberManagement.this.S]" id="akka.stream.impl;SubscriberManagement;Subscriptions">Subscriptions</a> = <span title="List[SubscriberManagement.this.S]">List</span><span class="delimiter">[</span>S<span class="delimiter">]</span>

  def <a title="=&gt; Int" id="akka.stream.impl;SubscriberManagement.initialBufferSize">initialBufferSize</a>: <span title="Int">Int</span>
  def <a title="=&gt; Int" id="akka.stream.impl;SubscriberManagement.maxBufferSize">maxBufferSize</a>: <span title="Int">Int</span>

  <span class="comment">/**
   * called when we are ready to consume more elements from our upstream
   * MUST NOT call pushToDownstream
   */</span>
  protected def <a title="(elements: Long)Unit" id="akka.stream.impl;SubscriberManagement.requestFromUpstream">requestFromUpstream</a><span class="delimiter">(</span><a title="Long" id="akka.stream.impl;SubscriberManagement.requestFromUpstream.elements">elements</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>

  <span class="comment">/**
   * called before `shutdown()` if the stream is *not* being regularly completed
   * but shut-down due to the last subscriber having cancelled its subscription
   */</span>
  protected def <a title="()Unit" id="akka.stream.impl;SubscriberManagement.cancelUpstream">cancelUpstream</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>

  <span class="comment">/**
   * called when the spi.Publisher/Processor is ready to be shut down
   */</span>
  protected def <a title="(completed: Boolean)Unit" id="akka.stream.impl;SubscriberManagement.shutdown">shutdown</a><span class="delimiter">(</span><a title="Boolean" id="akka.stream.impl;SubscriberManagement.shutdown.completed">completed</a>: <span title="Boolean">Boolean</span><span class="delimiter">)</span>: <span title="Unit">Unit</span>

  <span class="comment">/**
   * Use to register a subscriber
   */</span>
  protected def <a title="(subscriber: org.reactivestreams.Subscriber[_ &gt;: T])SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.createSubscription">createSubscription</a><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[_ &gt;: T]" id="akka.stream.impl;SubscriberManagement.createSubscription.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[_ &gt;: T]">Subscriber</span><span class="delimiter">[</span>_ &gt;: T<span class="delimiter">]</span><span class="delimiter">)</span>: <a href="#akka.stream.impl;SubscriberManagement;S" title="SubscriberManagement.this.S">S</a>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> val <a title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]" id="akka.stream.impl;SubscriberManagement.buffer">buffer</a> = new <a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">ResizableMultiReaderRingBuffer</a><span class="delimiter">[</span>T<span class="delimiter">]</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.initialBufferSize" title="=&gt; Int">initialBufferSize</a>, <a href="#akka.stream.impl;SubscriberManagement.maxBufferSize" title="=&gt; Int">maxBufferSize</a>, this<span class="delimiter">)</span>

  protected def <a title="=&gt; String" id="akka.stream.impl;SubscriberManagement.bufferDebug">bufferDebug</a>: <span title="String">String</span> = <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.toString" title="()String">toString</a>

  <span class="comment">// optimize for small numbers of subscribers by keeping subscribers in a plain list</span>
  private<span class="delimiter">[</span>this<span class="delimiter">]</span> var <a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.subscriptions">subscriptions</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span> = <span title="scala.collection.immutable.Nil.type">Nil</span>

  <span class="comment">// number of elements already requested but not yet received from upstream</span>
  private<span class="delimiter">[</span>this<span class="delimiter">]</span> var <a title="Long" id="akka.stream.impl;SubscriberManagement.pendingFromUpstream">pendingFromUpstream</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="int">0</span>

  <span class="comment">// if non-null, holds the end-of-stream state</span>
  private<span class="delimiter">[</span>this<span class="delimiter">]</span> var <a title="akka.stream.impl.SubscriberManagement.EndOfStream" id="akka.stream.impl;SubscriberManagement.endOfStream">endOfStream</a>: <a href="#akka.stream.impl.SubscriberManagement;EndOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">EndOfStream</a> = <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a>

  def <a title="=&gt; SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.cursors">cursors</a> = <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a>

  <span class="comment">/**
   * more demand was signaled from a given subscriber
   */</span>
  protected def <a title="(subscription: SubscriberManagement.this.S, elements: Long)Unit" id="akka.stream.impl;SubscriberManagement.moreRequested">moreRequested</a><span class="delimiter">(</span><a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.moreRequested.subscription">subscription</a>: <a href="#akka.stream.impl;SubscriberManagement;S" title="SubscriberManagement.this.S">S</a>, <a title="Long" id="akka.stream.impl;SubscriberManagement.moreRequested.elements">elements</a>: <span title="Long">Long</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.active_=" title="=&gt; Boolean">active</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <span class="comment">// returns Long.MinValue if the subscription is to be terminated</span>
      @tailrec def <a title="(requested: Long, eos: akka.stream.impl.SubscriberManagement.EndOfStream)Long" id="akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested">dispatchFromBufferAndReturnRemainingRequested</a><span class="delimiter">(</span><a title="Long" id="akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.requested">requested</a>: <span title="Long">Long</span>, <a title="akka.stream.impl.SubscriberManagement.EndOfStream" id="akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.eos">eos</a>: <a href="#akka.stream.impl.SubscriberManagement;EndOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">EndOfStream</a><span class="delimiter">)</span>: <span title="Long">Long</span> =
        if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.requested" title="Long">requested</a> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <span class="comment">// if we are at end-of-stream and have nothing more to read we complete now rather than after the next `requestMore`</span>
          if <span class="delimiter">(</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.eos" title="akka.stream.impl.SubscriberManagement.EndOfStream">eos</a> <span title="(x$1: AnyRef)Boolean">ne</span> <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a><span class="delimiter">)</span> <span title="(x: Boolean)Boolean">&amp;&amp;</span> <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.count" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Int">count</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> Long.<span title="Long(-9223372036854775808L)">MinValue</span> else <span title="Long(0L)" class="int">0</span>
        <span class="delimiter">}</span> else if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.count" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Int">count</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.dispatch" title="(element: T)Unit">dispatch</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.read" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)T">read</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span><span class="delimiter">)</span>
          <a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested" title="(requested: Long, eos: akka.stream.impl.SubscriberManagement.EndOfStream)Long">dispatchFromBufferAndReturnRemainingRequested</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.requested" title="Long">requested</a> <span title="(x: Int)Long">-</span> <span title="Int(1)" class="int">1</span>, <a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.eos" title="akka.stream.impl.SubscriberManagement.EndOfStream">eos</a><span class="delimiter">)</span>
        <span class="delimiter">}</span> else if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.eos" title="akka.stream.impl.SubscriberManagement.EndOfStream">eos</a> <span title="(x$1: AnyRef)Boolean">ne</span> <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a><span class="delimiter">)</span> Long.<span title="Long(-9223372036854775808L)">MinValue</span>
        else <a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested.requested" title="Long">requested</a>

      <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> match <span class="delimiter">{</span>
        case <a title="akka.stream.impl.SubscriberManagement.EndOfStream" id="akka.stream.impl;SubscriberManagement.moreRequested.eos">eos</a> @ <span class="delimiter">(</span><a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a> | <a href="#akka.stream.impl.SubscriberManagement.Completed" title="akka.stream.impl.SubscriberManagement.Completed.type">Completed</a><span class="delimiter">)</span> ⇒
          val <a title="Long" id="akka.stream.impl;SubscriberManagement.moreRequested.demand">demand</a> = <a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.moreRequested" title="(demand: Long)Long">moreRequested</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.elements" title="Long">elements</a><span class="delimiter">)</span>
          <a href="#akka.stream.impl;SubscriberManagement.moreRequested.dispatchFromBufferAndReturnRemainingRequested" title="(requested: Long, eos: akka.stream.impl.SubscriberManagement.EndOfStream)Long">dispatchFromBufferAndReturnRemainingRequested</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.demand" title="Long">demand</a>, <a href="#akka.stream.impl;SubscriberManagement.moreRequested.eos" title="akka.stream.impl.SubscriberManagement.EndOfStream">eos</a><span class="delimiter">)</span> match <span class="delimiter">{</span>
            case Long.<span title="Long(-9223372036854775808L)">MinValue</span> ⇒
              <a href="#akka.stream.impl.SubscriberManagement;EndOfStream.apply" title="(subscriber: org.reactivestreams.Subscriber[_$1])Unit">eos</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span>
              <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal" title="(subscription: SubscriberManagement.this.S)Unit">unregisterSubscriptionInternal</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span>
            case <a title="Long" id="akka.stream.impl;SubscriberManagement.moreRequested.x">x</a> ⇒
              <a href="#akka.stream.impl;SubscriberManagement.moreRequested.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="(x$1: Long)Unit">totalDemand</a> = <a href="#akka.stream.impl;SubscriberManagement.moreRequested.x" title="Long">x</a>
              <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired" title="()Unit">requestFromUpstreamIfRequired</a><span class="delimiter">(</span><span class="delimiter">)</span>
          <span class="delimiter">}</span>
        case ErrorCompleted<span class="delimiter">(</span>_<span class="delimiter">)</span> ⇒ <span class="comment">// ignore, the Subscriber might not have seen our error event yet</span>
      <span class="delimiter">}</span>
    <span class="delimiter">}</span>

  private<span class="delimiter">[</span>this<span class="delimiter">]</span> final def <a title="()Unit" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired">requestFromUpstreamIfRequired</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    @tailrec def <a title="(remaining: SubscriberManagement.this.Subscriptions, result: Long)Long" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested">maxRequested</a><span class="delimiter">(</span><a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.remaining">remaining</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span>, <a title="Long" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested$default$2">result</a>: <span title="Long">Long</span> = <span title="Long(0L)" class="int">0</span><span class="delimiter">)</span>: <span title="Long">Long</span> =
      <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.remaining" title="SubscriberManagement.this.Subscriptions">remaining</a> match <span class="delimiter">{</span>
        case <a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.head">head</a> :: <a title="List[SubscriberManagement.this.S]" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.tail">tail</a> ⇒ <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested" title="(remaining: SubscriberManagement.this.Subscriptions, result: Long)Long">maxRequested</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.tail" title="List[SubscriberManagement.this.S]">tail</a>, math.<span title="(x: Long, y: Long)Long">max</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="=&gt; Long">totalDemand</a>, <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested$default$2" title="Long">result</a><span class="delimiter">)</span><span class="delimiter">)</span>
        case _            ⇒ <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested$default$2" title="Long">result</a>
      <span class="delimiter">}</span>
    val <a title="Int" id="akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.desired">desired</a> = <span title="Math.type">Math</span>.<span title="(x$1: Long, x$2: Long)Long">min</span><span class="delimiter">(</span>Int.<span title="Long(2147483647L)">MaxValue</span>, <span title="Math.type">Math</span>.<span title="(x$1: Long, x$2: Long)Long">min</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.maxRequested" title="(remaining: SubscriberManagement.this.Subscriptions, result: Long)Long">maxRequested</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a><span class="delimiter">)</span>, <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.maxAvailable" title="=&gt; Long">maxAvailable</a><span class="delimiter">)</span> <span title="(x: Long)Long">-</span> <a href="#akka.stream.impl;SubscriberManagement.pendingFromUpstream" title="Long">pendingFromUpstream</a><span class="delimiter">)</span>.<span title="=&gt; Int">toInt</span>
    if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.desired" title="Int">desired</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#akka.stream.impl;SubscriberManagement.pendingFromUpstream" title="Long">pendingFromUpstream</a> <span title="(x: Int)Long">+=</span> <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.desired" title="Int">desired</a>
      <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstream" title="(elements: Long)Unit">requestFromUpstream</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired.desired" title="=&gt; Long">desired</a><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * this method must be called by the implementing class whenever a new value is available to be pushed downstream
   */</span>
  protected def <a title="(value: T)Unit" id="akka.stream.impl;SubscriberManagement.pushToDownstream">pushToDownstream</a><span class="delimiter">(</span><a title="T" id="akka.stream.impl;SubscriberManagement.pushToDownstream.value">value</a>: <a href="#akka.stream.impl;SubscriberManagement;T" title="T">T</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    @tailrec def <a title="(remaining: SubscriberManagement.this.Subscriptions, sent: Boolean)Boolean" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch">dispatch</a><span class="delimiter">(</span><a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.remaining">remaining</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span>, <a title="Boolean" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch$default$2">sent</a>: <span title="Boolean">Boolean</span> = false<span class="delimiter">)</span>: <span title="Boolean">Boolean</span> =
      <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.remaining" title="SubscriberManagement.this.Subscriptions">remaining</a> match <span class="delimiter">{</span>
        case <a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.head">head</a> :: <a title="List[SubscriberManagement.this.S]" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.tail">tail</a> ⇒
          if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="=&gt; Long">totalDemand</a> <span title="(x: Int)Boolean">&gt;</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
            val <a title="T" id="akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.element">element</a> = <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.read" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)T">read</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.head" title="SubscriberManagement.this.S">head</a><span class="delimiter">)</span>
            <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.dispatch" title="(element: T)Unit">dispatch</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.element" title="T">element</a><span class="delimiter">)</span>
            <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.totalDemand_=" title="(x$1: Long)Unit">totalDemand</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
            <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch" title="(remaining: SubscriberManagement.this.Subscriptions, sent: Boolean)Boolean">dispatch</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.tail" title="List[SubscriberManagement.this.S]">tail</a>, true<span class="delimiter">)</span>
          <span class="delimiter">}</span> else <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch" title="(remaining: SubscriberManagement.this.Subscriptions, sent: Boolean)Boolean">dispatch</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch.tail" title="List[SubscriberManagement.this.S]">tail</a>, <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch$default$2" title="Boolean">sent</a><span class="delimiter">)</span>
        case _ ⇒ <a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch$default$2" title="Boolean">sent</a>
      <span class="delimiter">}</span>

    <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> match <span class="delimiter">{</span>
      case <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a> ⇒
        <a href="#akka.stream.impl;SubscriberManagement.pendingFromUpstream" title="Long">pendingFromUpstream</a> <span title="(x: Int)Long">-=</span> <span title="Int(1)" class="int">1</span>
        if <span class="delimiter">(</span><span title="=&gt; Boolean">!</span><a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.write" title="(value: T)Boolean">write</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.value" title="T">value</a><span class="delimiter">)</span><span class="delimiter">)</span> throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String(&quot;Output buffer overflow&quot;)" class="string">&quot;Output buffer overflow&quot;</span><span class="delimiter">)</span>
        if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.pushToDownstream.dispatch" title="(remaining: SubscriberManagement.this.Subscriptions, sent: Boolean)Boolean">dispatch</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a><span class="delimiter">)</span><span class="delimiter">)</span> <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired" title="()Unit">requestFromUpstreamIfRequired</a><span class="delimiter">(</span><span class="delimiter">)</span>
      case _ ⇒
        throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String(&quot;pushToDownStream(...) after completeDownstream() or abortDownstream(...)&quot;)" class="string">&quot;pushToDownStream(...) after completeDownstream() or abortDownstream(...)&quot;</span><span class="delimiter">)</span>
    <span class="delimiter">}</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * this method must be called by the implementing class whenever
   * it has been determined that no more elements will be produced
   */</span>
  protected def <a title="()Unit" id="akka.stream.impl;SubscriberManagement.completeDownstream">completeDownstream</a><span class="delimiter">(</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      @tailrec def <a title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions">completeDoneSubscriptions</a><span class="delimiter">(</span><a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.remaining">remaining</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span>, <a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions$default$2">result</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span> = <span title="scala.collection.immutable.Nil.type">Nil</span><span class="delimiter">)</span>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span> =
        <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.remaining" title="SubscriberManagement.this.Subscriptions">remaining</a> match <span class="delimiter">{</span>
          case <a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.head">head</a> :: <a title="List[SubscriberManagement.this.S]" id="akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.tail">tail</a> ⇒
            if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.count" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Int">count</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.head" title="SubscriberManagement.this.S">head</a><span class="delimiter">)</span> <span title="(x: Int)Boolean">==</span> <span title="Int(0)" class="int">0</span><span class="delimiter">)</span> <span class="delimiter">{</span>
              <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.active_=" title="(x$1: Boolean)Unit">active</a> = false
              <a href="#akka.stream.impl.SubscriberManagement.Completed.apply" title="(subscriber: org.reactivestreams.Subscriber[_$1])Unit">Completed</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.head" title="SubscriberManagement.this.S">head</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span>
              <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions" title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions">completeDoneSubscriptions</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.tail" title="List[SubscriberManagement.this.S]">tail</a>, <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions$default$2" title="SubscriberManagement.this.Subscriptions">result</a><span class="delimiter">)</span>
            <span class="delimiter">}</span> else <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions" title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions">completeDoneSubscriptions</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.tail" title="List[SubscriberManagement.this.S]">tail</a>, <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.head" title="SubscriberManagement.this.S">head</a> <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions.x$1" title="(x: SubscriberManagement.this.S)List[SubscriberManagement.this.S]">::</a> <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions$default$2" title="SubscriberManagement.this.Subscriptions">result</a><span class="delimiter">)</span>
          case _ ⇒ <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions$default$2" title="SubscriberManagement.this.Subscriptions">result</a>
        <span class="delimiter">}</span>
      <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> = <a href="#akka.stream.impl.SubscriberManagement.Completed" title="akka.stream.impl.SubscriberManagement.Completed.type">Completed</a>
      <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a> = <a href="#akka.stream.impl;SubscriberManagement.completeDownstream.completeDoneSubscriptions" title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions">completeDoneSubscriptions</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a><span class="delimiter">)</span>
      if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <a href="#akka.stream.impl;SubscriberManagement.shutdown" title="(completed: Boolean)Unit">shutdown</a><span class="delimiter">(</span>completed = true<span class="delimiter">)</span>
    <span class="delimiter">}</span> <span class="comment">// else ignore, we need to be idempotent</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * this method must be called by the implementing class to push an error downstream
   */</span>
  protected def <a title="(cause: Throwable)Unit" id="akka.stream.impl;SubscriberManagement.abortDownstream">abortDownstream</a><span class="delimiter">(</span><a title="Throwable" id="akka.stream.impl;SubscriberManagement.abortDownstream.cause">cause</a>: <span title="Throwable">Throwable</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> = <a href="#akka.stream.impl.SubscriberManagement.ErrorCompleted.readResolve" title="(cause: Throwable)akka.stream.impl.SubscriberManagement.ErrorCompleted">ErrorCompleted</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.abortDownstream.cause" title="Throwable">cause</a><span class="delimiter">)</span>
    <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a>.<span title="(f: SubscriberManagement.this.S =&gt; Unit)Unit">foreach</span><span class="delimiter">(</span><a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.abortDownstream.$anonfun.s">s</a> ⇒ <a href="#akka.stream.impl.SubscriberManagement;EndOfStream.apply" title="(subscriber: org.reactivestreams.Subscriber[_$1])Unit">endOfStream</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.abortDownstream.$anonfun.s" title="SubscriberManagement.this.S">s</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span><span class="delimiter">)</span>
    <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a> = <span title="scala.collection.immutable.Nil.type">Nil</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * Register a new subscriber.
   */</span>
  protected def <a title="(subscriber: org.reactivestreams.Subscriber[_ &gt;: T])Unit" id="akka.stream.impl;SubscriberManagement.registerSubscriber">registerSubscriber</a><span class="delimiter">(</span><a title="org.reactivestreams.Subscriber[_ &gt;: T]" id="akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber">subscriber</a>: <span title="org.reactivestreams.Subscriber[_ &gt;: T]">Subscriber</span><span class="delimiter">[</span>_ &gt;: T<span class="delimiter">]</span><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> match <span class="delimiter">{</span>
    case <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a> if <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a>.<span title="(p: SubscriberManagement.this.S =&gt; Boolean)Boolean">exists</span><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.$anonfun.x$2" title="SubscriberManagement.this.S">_</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.subscriber" title="=&gt; org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span> ⇒
      <a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a>.<span title="(x$1: Throwable)Unit">onError</span><span class="delimiter">(</span>new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="(args: Any*)String">s</span>&quot;<span title="String(&quot;&quot;)">$</span><span class="delimiter">{</span><a href="#akka.stream.impl;SubscriberManagement" title="()Class[_]">getClass</a>.<span title="()String">getSimpleName</span><span class="delimiter">}</span><span title="String(&quot; [&quot;)"> [$</span><span class="delimiter">{</span>this<span class="delimiter">}</span><span title="String(&quot;, sub: &quot;)">, sub: $</span><a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span title="String(&quot;] &quot;)">] $</span><span class="delimiter">{</span>ReactiveStreamsCompliance.<span title="String(&quot;can not subscribe the same subscriber multiple times (see reactive-streams specification, rules 1.10 and 2.12)&quot;)">CanNotSubscribeTheSameSubscriberMultipleTimes</span><span class="delimiter">}</span><span title="String(&quot;&quot;)" class="string">&quot;</span><span class="delimiter">)</span><span class="delimiter">)</span>
    case <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a> ⇒
      val <span title="SubscriberManagement.this.S">newSubscription</span> = <a href="#akka.stream.impl;SubscriberManagement.createSubscription" title="(subscriber: org.reactivestreams.Subscriber[_ &gt;: T])SubscriberManagement.this.S">createSubscription</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a> <span title="(x: SubscriberManagement.this.S)List[SubscriberManagement.this.S]">::=</span> <span title="SubscriberManagement.this.S">newSubscription</span>
      <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.initCursor" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Unit">initCursor</a><span class="delimiter">(</span><span title="SubscriberManagement.this.S">newSubscription</span><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a>.<span title="(x$1: org.reactivestreams.Subscription)Unit">onSubscribe</span><span class="delimiter">(</span><span title="SubscriberManagement.this.S">newSubscription</span><span class="delimiter">)</span>
    case <a href="#akka.stream.impl.SubscriberManagement.Completed" title="akka.stream.impl.SubscriberManagement.Completed.type">Completed</a> if <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.nonEmpty" title="=&gt; Boolean">nonEmpty</a> ⇒
      val <span title="SubscriberManagement.this.S">newSubscription</span> = <a href="#akka.stream.impl;SubscriberManagement.createSubscription" title="(subscriber: org.reactivestreams.Subscriber[_ &gt;: T])SubscriberManagement.this.S">createSubscription</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a> <span title="(x: SubscriberManagement.this.S)List[SubscriberManagement.this.S]">::=</span> <span title="SubscriberManagement.this.S">newSubscription</span>
      <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.initCursor" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Unit">initCursor</a><span class="delimiter">(</span><span title="SubscriberManagement.this.S">newSubscription</span><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a>.<span title="(x$1: org.reactivestreams.Subscription)Unit">onSubscribe</span><span class="delimiter">(</span><span title="SubscriberManagement.this.S">newSubscription</span><span class="delimiter">)</span>
    case <a title="akka.stream.impl.SubscriberManagement.EndOfStream" id="akka.stream.impl;SubscriberManagement.registerSubscriber.eos">eos</a> ⇒
      <a href="#akka.stream.impl.SubscriberManagement;EndOfStream.apply" title="(subscriber: org.reactivestreams.Subscriber[_$3])Unit">eos</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.registerSubscriber.subscriber" title="org.reactivestreams.Subscriber[_ &gt;: T]">subscriber</a><span class="delimiter">)</span>
  <span class="delimiter">}</span>

  <span class="comment">/**
   * called from `Subscription::cancel`, i.e. from another thread,
   * override to add synchronization with itself, `subscribe` and `moreRequested`
   */</span>
  protected def <a title="(subscription: SubscriberManagement.this.S)Unit" id="akka.stream.impl;SubscriberManagement.unregisterSubscription">unregisterSubscription</a><span class="delimiter">(</span><a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.unregisterSubscription.subscription">subscription</a>: <a href="#akka.stream.impl;SubscriberManagement;S" title="SubscriberManagement.this.S">S</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> =
    <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal" title="(subscription: SubscriberManagement.this.S)Unit">unregisterSubscriptionInternal</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.unregisterSubscription.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span>

  <span class="comment">// must be idempotent</span>
  private def <a title="(subscription: SubscriberManagement.this.S)Unit" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal">unregisterSubscriptionInternal</a><span class="delimiter">(</span><a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.subscription">subscription</a>: <a href="#akka.stream.impl;SubscriberManagement;S" title="SubscriberManagement.this.S">S</a><span class="delimiter">)</span>: <span title="Unit">Unit</span> = <span class="delimiter">{</span>
    @tailrec def <a title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom">removeFrom</a><span class="delimiter">(</span><a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.remaining">remaining</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span>, <a title="SubscriberManagement.this.Subscriptions" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom$default$2">result</a>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span> = <span title="scala.collection.immutable.Nil.type">Nil</span><span class="delimiter">)</span>: <span title="SubscriberManagement.this.Subscriptions">Subscriptions</span> =
      <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.remaining" title="SubscriberManagement.this.Subscriptions">remaining</a> match <span class="delimiter">{</span>
        case <a title="SubscriberManagement.this.S" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.head">head</a> :: <a title="List[SubscriberManagement.this.S]" id="akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.tail">tail</a> ⇒ if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.head" title="SubscriberManagement.this.S">head</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.tail" title="List[SubscriberManagement.this.S]">tail</a> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.x$3" title="(prefix: List[SubscriberManagement.this.S])List[SubscriberManagement.this.S]">reverse_:::</a> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom$default$2" title="SubscriberManagement.this.Subscriptions">result</a> else <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom" title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions">removeFrom</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.tail" title="List[SubscriberManagement.this.S]">tail</a>, <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.head" title="SubscriberManagement.this.S">head</a> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom.x$4" title="(x: SubscriberManagement.this.S)List[SubscriberManagement.this.S]">::</a> <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom$default$2" title="SubscriberManagement.this.Subscriptions">result</a><span class="delimiter">)</span>
        case _            ⇒ throw new <span title="IllegalStateException">IllegalStateException</span><span class="delimiter">(</span><span title="String(&quot;Subscription to unregister not found&quot;)" class="string">&quot;Subscription to unregister not found&quot;</span><span class="delimiter">)</span>
      <span class="delimiter">}</span>
    if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.active_=" title="=&gt; Boolean">active</a><span class="delimiter">)</span> <span class="delimiter">{</span>
      <a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a> = <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.removeFrom" title="(remaining: SubscriberManagement.this.Subscriptions, result: SubscriberManagement.this.Subscriptions)SubscriberManagement.this.Subscriptions">removeFrom</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.buffer" title="akka.stream.impl.ResizableMultiReaderRingBuffer[T]">buffer</a>.<a href="ResizableMultiReaderRingBuffer.scala.html#akka.stream.impl;ResizableMultiReaderRingBuffer.onCursorRemoved" title="(cursor: akka.stream.impl.ResizableMultiReaderRingBuffer.Cursor)Unit">onCursorRemoved</a><span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.subscription" title="SubscriberManagement.this.S">subscription</a><span class="delimiter">)</span>
      <a href="#akka.stream.impl;SubscriberManagement.unregisterSubscriptionInternal.subscription" title="SubscriberManagement.this.S">subscription</a>.<a href="#akka.stream.impl;SubscriptionWithCursor.active_=" title="(x$1: Boolean)Unit">active</a> = false
      if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.subscriptions" title="SubscriberManagement.this.Subscriptions">subscriptions</a>.<span title="=&gt; Boolean">isEmpty</span><span class="delimiter">)</span> <span class="delimiter">{</span>
        if <span class="delimiter">(</span><a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> <span title="(x$1: AnyRef)Boolean">eq</span> <a href="#akka.stream.impl.SubscriberManagement.NotReached" title="akka.stream.impl.SubscriberManagement.NotReached.type">NotReached</a><span class="delimiter">)</span> <span class="delimiter">{</span>
          <a href="#akka.stream.impl;SubscriberManagement.endOfStream" title="akka.stream.impl.SubscriberManagement.EndOfStream">endOfStream</a> = <a href="#akka.stream.impl.SubscriberManagement.ShutDown" title="=&gt; akka.stream.impl.SubscriberManagement.ErrorCompleted">ShutDown</a>
          <a href="#akka.stream.impl;SubscriberManagement.cancelUpstream" title="()Unit">cancelUpstream</a><span class="delimiter">(</span><span class="delimiter">)</span>
        <span class="delimiter">}</span>
        <a href="#akka.stream.impl;SubscriberManagement.shutdown" title="(completed: Boolean)Unit">shutdown</a><span class="delimiter">(</span>completed = false<span class="delimiter">)</span>
      <span class="delimiter">}</span> else <a href="#akka.stream.impl;SubscriberManagement.requestFromUpstreamIfRequired" title="()Unit">requestFromUpstreamIfRequired</a><span class="delimiter">(</span><span class="delimiter">)</span> <span class="comment">// we might have removed a &quot;blocking&quot; subscriber and can continue now</span>
    <span class="delimiter">}</span> <span class="comment">// else ignore, we need to be idempotent</span>
  <span class="delimiter">}</span>
<span class="delimiter">}</span>


        </pre>
    </body>
</html>
